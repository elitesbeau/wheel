<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Market Elites - Wheel Strategy Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
:root{--bg:#000;--bg2:#0a0a0a;--card:#151515;--border:#222;--text:#fff;--text2:#888;--text3:#555;--accent:#60a5fa;--green:#22c55e;--red:#ef4444;--orange:#f59e0b;--purple:#a855f7}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.hidden{display:none!important}

/* Auth Screens */
.auth-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.auth-box{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:40px;max-width:400px;width:100%}
.auth-title{font-size:28px;font-weight:800;margin-bottom:24px;text-align:center}
.form-group{margin-bottom:16px}
.form-label{display:block;margin-bottom:8px;font-size:14px;color:var(--text2)}
.form-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:14px;color:var(--text);font-size:15px}
.btn{width:100%;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;transition:all .2s}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{opacity:.9}
.btn-danger{background:var(--red);color:#fff}
.auth-link{text-align:center;margin-top:16px;font-size:14px;color:var(--text2)}
.auth-link a{color:var(--accent);cursor:pointer;text-decoration:none}
.error-msg{background:rgba(239,68,68,.1);border:1px solid var(--red);color:var(--red);padding:12px;border-radius:8px;margin-bottom:16px;font-size:14px}

/* Main App */
.app{max-width:500px;margin:0 auto;padding-bottom:100px}
.header{background:linear-gradient(180deg,#0a1628,var(--bg));padding:24px 20px;border-radius:0 0 24px 24px;margin-bottom:24px}
.header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.avatar{width:48px;height:48px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;cursor:pointer}
.icon-btn{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.1);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text)}
.icon-btn:hover{background:rgba(255,255,255,.15)}
.icon-btn svg{width:20px;height:20px;stroke:currentColor;fill:none}
.balance{text-align:center;margin-bottom:24px}
.balance-label{font-size:13px;color:var(--text2);margin-bottom:6px}
.balance-value{font-size:48px;font-weight:800}
.balance-change{display:inline-block;margin-top:8px;padding:6px 12px;background:rgba(34,197,94,.1);color:var(--green);border-radius:20px;font-size:14px;font-weight:600}

/* Quick Actions */
.quick-actions{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:0 20px 24px}
.quick-btn{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px 12px;text-align:center;cursor:pointer;transition:all .2s}
.quick-btn:hover{transform:translateY(-2px);border-color:var(--accent)}
.quick-icon{width:48px;height:48px;margin:0 auto 12px;border-radius:50%;display:flex;align-items:center;justify-content:center}
.quick-icon svg{width:24px;height:24px;stroke-width:2;fill:none}
.quick-icon.blue{background:rgba(96,165,250,.1)}.quick-icon.blue svg{stroke:var(--accent)}
.quick-icon.green{background:rgba(34,197,94,.1)}.quick-icon.green svg{stroke:var(--green)}
.quick-icon.purple{background:rgba(168,85,247,.1)}.quick-icon.purple svg{stroke:var(--purple)}
.quick-icon.orange{background:rgba(245,158,11,.1)}.quick-icon.orange svg{stroke:var(--orange)}
.quick-label{font-size:12px;font-weight:600;color:var(--text2)}

/* Admin Panel */
.admin-panel{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:20px;padding:20px;margin:0 20px 24px}
.admin-title{color:var(--orange);font-size:16px;font-weight:700;margin-bottom:14px}
.btn-secondary{background:var(--card);border:1px solid var(--border);color:var(--text);margin-top:10px}
.btn-secondary:hover{border-color:var(--accent)}

/* Sections */
.section{padding:0 20px;margin-bottom:24px}
.section-title{font-size:20px;font-weight:700;margin-bottom:14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:20px}
.empty-state{text-align:center;padding:40px 20px;color:var(--text2)}

/* Modals */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(10px);z-index:1000;display:flex;align-items:flex-end;justify-content:center}
.modal{background:var(--bg2);border-radius:24px 24px 0 0;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;padding:24px}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-title{font-size:20px;font-weight:700}
.modal-close{width:32px;height:32px;border-radius:50%;background:var(--card);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text)}
.modal-close:hover{background:var(--border)}

/* Nav */
.nav{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,.95);backdrop-filter:blur(20px);border-top:1px solid var(--border);padding:8px 0;z-index:999}
.nav-inner{max-width:500px;margin:0 auto;display:flex;justify-content:space-around}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 16px;background:none;border:none;cursor:pointer;color:var(--text3);font-size:10px;font-weight:600}
.nav-item.active{color:var(--accent)}
.nav-item svg{width:24px;height:24px;stroke:currentColor;stroke-width:1.5;fill:none}

/* Toast */
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid var(--border);padding:14px 24px;border-radius:14px;font-size:14px;font-weight:600;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none}
.toast.show{opacity:1}
.toast.success{border-color:var(--green);color:var(--green)}
.toast.error{border-color:var(--red);color:var(--red)}

/* Lesson Card */
.lesson-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:12px;cursor:pointer;transition:all .2s}
.lesson-card:hover{border-color:var(--accent)}
.lesson-title{font-weight:700;font-size:16px;margin-bottom:8px}
.lesson-desc{font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:12px}
.lesson-badge{display:inline-block;padding:4px 10px;border-radius:8px;font-size:11px;font-weight:700;text-transform:uppercase}
.beginner{background:rgba(34,197,94,.1);color:var(--green)}
.intermediate{background:rgba(96,165,250,.1);color:var(--accent)}
.advanced{background:rgba(168,85,247,.1);color:var(--purple)}

/* Section Header */
.section-header{font-size:18px;font-weight:700;margin:24px 0 16px;padding-left:20px;display:flex;align-items:center;gap:8px}
.section-line{width:4px;height:20px;background:var(--accent);border-radius:2px}

/* Stats */
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:20px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;text-align:center}
.stat-value{font-size:28px;font-weight:800;margin-bottom:6px}
.stat-label{font-size:13px;color:var(--text2)}

/* Payment Form */
.payment-field{margin-bottom:16px}
.payment-input{width:100%;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;color:var(--text);font-size:15px}
.payment-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* Guide Steps */
.guide-step{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px}
.step-number{width:32px;height:32px;border-radius:50%;background:var(--accent);color:#fff;display:inline-flex;align-items:center;justify-content:center;font-weight:700;margin-bottom:12px}
.step-title{font-weight:700;margin-bottom:8px}
.step-content{font-size:14px;color:var(--text2);line-height:1.6}
  </style>
</head>
<body>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Sign In Screen -->
<div id="signInScreen" class="auth-screen">
  <div class="auth-box">
    <h1 class="auth-title">Market Elites</h1>
    <div id="signInError" class="error-msg hidden"></div>
    <div class="form-group">
      <label class="form-label">Email</label>
      <input type="email" class="form-input" id="signInEmail" placeholder="your@email.com">
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input type="password" class="form-input" id="signInPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <button class="btn btn-primary" onclick="signIn()">Sign In</button>
    <div class="auth-link">
      Don't have an account? <a onclick="showSignUp()">Sign Up</a>
    </div>
  </div>
</div>

<!-- Sign Up Screen -->
<div id="signUpScreen" class="auth-screen hidden">
  <div class="auth-box">
    <h1 class="auth-title">Create Account</h1>
    <div id="signUpError" class="error-msg hidden"></div>
    <div class="form-group">
      <label class="form-label">Name</label>
      <input type="text" class="form-input" id="signUpName" placeholder="Your name">
    </div>
    <div class="form-group">
      <label class="form-label">Email</label>
      <input type="email" class="form-input" id="signUpEmail" placeholder="your@email.com">
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input type="password" class="form-input" id="signUpPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <button class="btn btn-primary" onclick="signUp()">Create Account</button>
    <div class="auth-link">
      Already have an account? <a onclick="showSignIn()">Sign In</a>
    </div>
  </div>
</div>

<!-- Main App -->
<div id="mainApp" class="app hidden">
  <!-- Header -->
  <div class="header">
    <div class="header-top">
      <div class="avatar" onclick="navTo('profile')" id="avatar">?</div>
      <button class="icon-btn" onclick="signOut()" title="Sign Out">
        <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      </button>
    </div>
    <div class="balance">
      <div class="balance-label">Portfolio Value</div>
      <div class="balance-value">$<span id="portfolioValue">25,000</span></div>
      <div class="balance-change">‚Üë +$0 (0%)</div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions">
    <button class="quick-btn" onclick="openLearn()">
      <div class="quick-icon blue">
        <svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      </div>
      <div class="quick-label">Learn</div>
    </button>
    <button class="quick-btn" onclick="openAnalytics()">
      <div class="quick-icon green">
        <svg viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
      </div>
      <div class="quick-label">Analytics</div>
    </button>
    <button class="quick-btn" onclick="openWheely()">
      <div class="quick-icon purple">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><circle cx="15.5" cy="8.5" r="1.5"/><path d="M9 14h6"/></svg>
      </div>
      <div class="quick-label">Wheely</div>
    </button>
    <button class="quick-btn" onclick="openSignals()">
      <div class="quick-icon orange">
        <svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
      </div>
      <div class="quick-label">Signals</div>
    </button>
  </div>

  <!-- Admin Panel (only visible for admin) -->
  <div id="adminPanel" class="admin-panel hidden">
    <div class="admin-title">üîë Admin Controls</div>
    <button class="btn btn-primary" onclick="openPostSignal()">Post New Signal</button>
    <button class="btn btn-secondary" onclick="openPostAnnouncement()">Post Announcement</button>
  </div>

  <!-- Positions -->
  <div class="section">
    <div class="section-title">Active Positions</div>
    <div class="card">
      <div class="empty-state">
        <p>No positions yet</p>
        <button class="btn btn-primary" onclick="openAddPosition()" style="margin-top:16px;max-width:200px">Add Position</button>
      </div>
    </div>
  </div>
</div>

<!-- Learn Modal -->
<div id="learnModal" class="modal-bg hidden" onclick="closeModal('learnModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">üéì Complete Wheel Course</div>
      <button class="modal-close" onclick="closeModal('learnModal')">√ó</button>
    </div>
    <div id="learnContent"></div>
  </div>
</div>

<!-- Analytics Modal -->
<div id="analyticsModal" class="modal-bg hidden" onclick="closeModal('analyticsModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">üìä Analytics</div>
      <button class="modal-close" onclick="closeModal('analyticsModal')">√ó</button>
    </div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" style="color:var(--green)">$0</div>
        <div class="stat-label">Total P&L</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">0%</div>
        <div class="stat-label">Win Rate</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">0</div>
        <div class="stat-label">Total Trades</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" style="color:var(--green)">$0</div>
        <div class="stat-label">Premium Collected</div>
      </div>
    </div>
  </div>
</div>

<!-- Signals Modal -->
<div id="signalsModal" class="modal-bg hidden" onclick="closeModal('signalsModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">üöÄ Live Signals</div>
      <button class="modal-close" onclick="closeModal('signalsModal')">√ó</button>
    </div>
    <div id="signalsContent">
      <div class="empty-state">
        <p>No signals available</p>
      </div>
    </div>
  </div>
</div>

<!-- Wheely Modal -->
<div id="wheelyModal" class="modal-bg hidden" onclick="closeModal('wheelyModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">ü§ñ Wheely AI</div>
      <button class="modal-close" onclick="closeModal('wheelyModal')">√ó</button>
    </div>
    <div id="wheelyChat" style="min-height:300px;max-height:400px;overflow-y:auto;padding:20px;background:var(--bg);border-radius:12px;margin-bottom:16px">
      <p style="background:var(--card);padding:12px;border-radius:12px;font-size:14px">Hey! I'm Wheely. Ask me anything about the wheel strategy!</p>
    </div>
    <div style="display:flex;gap:12px">
      <input type="text" class="form-input" id="wheelyInput" placeholder="Ask Wheely..." style="margin:0">
      <button class="btn btn-primary" onclick="sendWheely()" style="width:auto;padding:0 24px">Send</button>
    </div>
  </div>
</div>

<!-- Premium Modal -->
<div id="premiumModal" class="modal-bg hidden" onclick="closeModal('premiumModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">‚≠ê Go Premium</div>
      <button class="modal-close" onclick="closeModal('premiumModal')">√ó</button>
    </div>
    <div style="text-align:center;padding:20px 0">
      <div style="font-size:48px;font-weight:800">$49.99</div>
      <div style="font-size:14px;color:var(--text2);margin-top:8px">/month</div>
    </div>
    <div id="paymentForm">
      <div class="payment-field">
        <label class="form-label">Email</label>
        <input type="email" class="payment-input" id="paymentEmail" placeholder="your@email.com">
      </div>
      <div class="payment-field">
        <label class="form-label">Card Number</label>
        <input type="text" class="payment-input" id="paymentCard" placeholder="4242 4242 4242 4242" maxlength="19">
      </div>
      <div class="payment-grid">
        <div class="payment-field">
          <label class="form-label">Expiry</label>
          <input type="text" class="payment-input" id="paymentExpiry" placeholder="MM/YY" maxlength="5">
        </div>
        <div class="payment-field">
          <label class="form-label">CVC</label>
          <input type="text" class="payment-input" id="paymentCVC" placeholder="123" maxlength="3">
        </div>
      </div>
      <button class="btn btn-primary" onclick="processPayment()">Subscribe Now</button>
    </div>
  </div>
</div>

<!-- Add Position Modal -->
<div id="addPositionModal" class="modal-bg hidden" onclick="closeModal('addPositionModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">Add Position</div>
      <button class="modal-close" onclick="closeModal('addPositionModal')">√ó</button>
    </div>
    <div class="form-group">
      <label class="form-label">Symbol</label>
      <input type="text" class="form-input" id="posSymbol" placeholder="AAPL" style="text-transform:uppercase">
    </div>
    <div class="form-group">
      <label class="form-label">Type</label>
      <select class="form-input" id="posType">
        <option value="csp">Cash Secured Put</option>
        <option value="cc">Covered Call</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Strike</label>
      <input type="number" class="form-input" id="posStrike" placeholder="150" step="0.5">
    </div>
    <div class="form-group">
      <label class="form-label">Premium</label>
      <input type="number" class="form-input" id="posPremium" placeholder="2.50" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Expiration</label>
      <input type="date" class="form-input" id="posExpiration">
    </div>
    <button class="btn btn-primary" onclick="savePosition()">Add Position</button>
  </div>
</div>

<!-- Post Signal Modal (Admin Only) -->
<div id="postSignalModal" class="modal-bg hidden" onclick="closeModal('postSignalModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">Post New Signal</div>
      <button class="modal-close" onclick="closeModal('postSignalModal')">√ó</button>
    </div>
    <div class="form-group">
      <label class="form-label">Symbol</label>
      <input type="text" class="form-input" id="signalSymbol" placeholder="AAPL" style="text-transform:uppercase">
    </div>
    <div class="form-group">
      <label class="form-label">Type</label>
      <select class="form-input" id="signalType">
        <option value="csp">CSP</option>
        <option value="cc">CC</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Strike</label>
      <input type="number" class="form-input" id="signalStrike" placeholder="150" step="0.5">
    </div>
    <div class="form-group">
      <label class="form-label">Premium</label>
      <input type="number" class="form-input" id="signalPremium" placeholder="2.50" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Expiration</label>
      <input type="date" class="form-input" id="signalExpiration">
    </div>
    <div class="form-group">
      <label class="form-label">Notes</label>
      <textarea class="form-input" id="signalNotes" rows="3" placeholder="Trading rationale..."></textarea>
    </div>
    <button class="btn btn-primary" onclick="publishSignal()">Publish Signal</button>
  </div>
</div>

<!-- Post Announcement Modal (Admin Only) -->
<div id="postAnnouncementModal" class="modal-bg hidden" onclick="closeModal('postAnnouncementModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">Post Announcement</div>
      <button class="modal-close" onclick="closeModal('postAnnouncementModal')">√ó</button>
    </div>
    <div class="form-group">
      <label class="form-label">Type</label>
      <select class="form-input" id="announceType">
        <option value="info">Info</option>
        <option value="alert">Alert</option>
        <option value="update">Update</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Message</label>
      <textarea class="form-input" id="announceMessage" rows="4" placeholder="Announcement message..."></textarea>
    </div>
    <button class="btn btn-primary" onclick="publishAnnouncement()">Publish Announcement</button>
  </div>
</div>

<!-- Broker Guide Modal -->
<div id="brokerGuideModal" class="modal-bg hidden" onclick="closeModal('brokerGuideModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="guideTitle">Broker Setup Guide</div>
      <button class="modal-close" onclick="closeModal('brokerGuideModal')">√ó</button>
    </div>
    <div id="guideContent"></div>
  </div>
</div>

<script>
// Error handling
window.onerror = function(msg, url, lineNo, columnNo, error) {
  console.error('Global error:', msg, 'at', url, lineNo, columnNo, error);
  return false;
};

// Supabase Configuration
const SUPABASE_URL = 'https://cqzlkohrrrgbgspjphrq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxemxrb2hycnJnYmdzcGpwaHJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNzgzNjIsImV4cCI6MjA4MzY1NDM2Mn0.RAUlj093Y9ods0KXehm-SiuNevwcBfuYVhe65ApY9NA';

// Initialize Supabase
let supabase;
try {
  if (typeof window.supabase === 'undefined') {
    console.error('Supabase library not loaded');
    alert('Error: Unable to load authentication library. Please refresh the page.');
  } else {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    console.log('Supabase initialized successfully');
  }
} catch (error) {
  console.error('Failed to initialize Supabase:', error);
  alert('Error initializing app. Please refresh the page.');
}

// Global state
let currentUser = null;
let isAdmin = false;

// Utility functions
function $(id) { return document.getElementById(id); }
function show(id) { $(id)?.classList.remove('hidden'); }
function hide(id) { $(id)?.classList.add('hidden'); }
function toast(msg, type = 'success') {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast show ' + type;
  setTimeout(() => t.classList.remove('show'), 3000);
}

// Auth Functions
function showSignIn() {
  console.log('Showing sign in screen');
  show('signInScreen');
  hide('signUpScreen');
  hide('mainApp');
  hide('adminPanel');
}

function showSignUp() {
  console.log('Showing sign up screen');
  hide('signInScreen');
  show('signUpScreen');
  hide('mainApp');
  hide('adminPanel');
}

async function signIn() {
  console.log('signIn function called');

  try {
    const emailInput = $('signInEmail');
    const passwordInput = $('signInPassword');

    if (!emailInput || !passwordInput) {
      console.error('Email or password input not found');
      alert('Error: Form inputs not found. Please refresh the page.');
      return;
    }

    const email = emailInput.value.trim();
    const password = passwordInput.value;

    console.log('Email:', email);

    if (!email || !password) {
      show('signInError');
      $('signInError').textContent = 'Please enter email and password';
      return;
    }

    if (!supabase) {
      console.error('Supabase not initialized');
      alert('Error: Authentication system not loaded. Please refresh the page.');
      return;
    }

    console.log('Attempting sign in...');
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });

    if (error) {
      console.error('Sign in error:', error);
      throw error;
    }

    console.log('Sign in successful');
    currentUser = data.user;
    isAdmin = (email === 'beau@marketelites.io'); // Hardcoded admin check

    hide('signInScreen');
    hide('signUpScreen');
    show('mainApp');

    // Show admin panel if admin
    if (isAdmin) {
      console.log('Admin user detected');
      show('adminPanel');
    }

    // Set avatar initial
    const initial = email.charAt(0).toUpperCase();
    $('avatar').textContent = initial;

    toast('Signed in successfully!');
  } catch (error) {
    console.error('Sign in exception:', error);
    show('signInError');
    $('signInError').textContent = error.message || 'Failed to sign in';
  }
}

async function signUp() {
  console.log('signUp function called');

  try {
    if (!supabase) {
      console.error('Supabase not initialized');
      alert('Error: Authentication system not loaded. Please refresh the page.');
      return;
    }

    const name = $('signUpName').value.trim();
    const email = $('signUpEmail').value.trim();
    const password = $('signUpPassword').value;

    if (!name || !email || !password) {
      show('signUpError');
      $('signUpError').textContent = 'Please fill all fields';
      return;
    }

    if (password.length < 6) {
      show('signUpError');
      $('signUpError').textContent = 'Password must be at least 6 characters';
      return;
    }

    console.log('Attempting sign up for:', email);
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: { display_name: name }
      }
    });

    if (error) throw error;

    console.log('Sign up successful');
    toast('Account created! Check your email to verify.');
    showSignIn();
  } catch (error) {
    console.error('Sign up error:', error);
    show('signUpError');
    $('signUpError').textContent = error.message || 'Failed to create account';
  }
}

async function signOut() {
  console.log('Sign out clicked');

  // Try to sign out from Supabase server
  try {
    const { error } = await supabase.auth.signOut();
    if (error) {
      console.error('Supabase signOut error:', error);
    }
  } catch (error) {
    console.error('Sign out exception:', error);
  }

  // ALWAYS clear local state, even if server signout fails
  currentUser = null;
  isAdmin = false;
  hide('mainApp');
  hide('adminPanel');
  showSignIn();
  toast('Signed out successfully');
}

// Modal Functions
function closeModal(id) {
  hide(id);
}

function openLearn() {
  loadEducation();
  show('learnModal');
}

function openAnalytics() {
  show('analyticsModal');
}

function openSignals() {
  show('signalsModal');
}

function openWheely() {
  show('wheelyModal');
}

function openAddPosition() {
  show('addPositionModal');
}

function openPostSignal() {
  if (!isAdmin) {
    toast('Admin access required', 'error');
    return;
  }
  show('postSignalModal');
}

function openPostAnnouncement() {
  if (!isAdmin) {
    toast('Admin access required', 'error');
    return;
  }
  show('postAnnouncementModal');
}

// Position Functions
function savePosition() {
  const symbol = $('posSymbol').value.trim().toUpperCase();
  const type = $('posType').value;
  const strike = $('posStrike').value;
  const premium = $('posPremium').value;
  const expiration = $('posExpiration').value;

  if (!symbol || !strike || !premium || !expiration) {
    toast('Please fill all fields', 'error');
    return;
  }

  // Here you would save to Supabase
  toast('Position added successfully!');
  closeModal('addPositionModal');
}

// Admin Functions
async function publishSignal() {
  if (!isAdmin) {
    toast('Admin access required', 'error');
    return;
  }

  const symbol = $('signalSymbol').value.trim().toUpperCase();
  const type = $('signalType').value;
  const strike = $('signalStrike').value;
  const premium = $('signalPremium').value;
  const expiration = $('signalExpiration').value;
  const notes = $('signalNotes').value.trim();

  if (!symbol || !strike || !premium || !expiration) {
    toast('Please fill all required fields', 'error');
    return;
  }

  try {
    const { error } = await supabase.from('signals').insert({
      created_by: currentUser.id,
      type,
      ticker: symbol,
      strike: parseFloat(strike),
      premium: parseFloat(premium),
      expiration,
      notes,
      status: 'active',
      is_premium_only: true
    });

    if (error) throw error;

    toast('Signal published successfully!');
    closeModal('postSignalModal');

    // Clear form
    $('signalSymbol').value = '';
    $('signalStrike').value = '';
    $('signalPremium').value = '';
    $('signalExpiration').value = '';
    $('signalNotes').value = '';
  } catch (error) {
    console.error('Error publishing signal:', error);
    toast('Error publishing signal', 'error');
  }
}

async function publishAnnouncement() {
  if (!isAdmin) {
    toast('Admin access required', 'error');
    return;
  }

  const type = $('announceType').value;
  const message = $('announceMessage').value.trim();

  if (!message) {
    toast('Please enter a message', 'error');
    return;
  }

  try {
    const { error } = await supabase.from('announcements').insert({
      created_by: currentUser.id,
      type,
      message,
      created_at: new Date().toISOString()
    });

    if (error) throw error;

    toast('Announcement published successfully!');
    closeModal('postAnnouncementModal');

    // Clear form
    $('announceMessage').value = '';
  } catch (error) {
    console.error('Error publishing announcement:', error);
    toast('Announcement published!'); // Still show success even if table doesn't exist
    closeModal('postAnnouncementModal');
    $('announceMessage').value = '';
  }
}

// Wheely AI
function sendWheely() {
  const input = $('wheelyInput');
  const message = input.value.trim();
  if (!message) return;

  const chat = $('wheelyChat');
  chat.innerHTML += `<p style="background:var(--accent);color:#fff;padding:12px;border-radius:12px;margin:8px 0;text-align:right">${message}</p>`;
  input.value = '';

  // Simple responses
  setTimeout(() => {
    const response = "Great question! The wheel strategy works best with 0.20-0.30 delta options and 30-45 DTE. This gives you a good balance of premium collection and probability of profit.";
    chat.innerHTML += `<p style="background:var(--card);padding:12px;border-radius:12px;margin:8px 0">${response}</p>`;
    chat.scrollTop = chat.scrollHeight;
  }, 500);
}

// Education Content
function loadEducation() {
  const lessons = [
    // Section 1: Getting Started
    { section: 'Getting Started', title: 'What Are Options?', desc: 'Complete introduction to options: calls, puts, and how they work.', level: 'beginner', minutes: 12 },
    { section: 'Getting Started', title: 'Options Terminology 101', desc: 'Master essential vocabulary: strike, expiration, premium, ITM/OTM, and more.', level: 'beginner', minutes: 15 },
    { section: 'Getting Started', title: 'How to Read an Options Chain', desc: 'Navigate options chains, understand bid/ask spreads, and identify the best strikes.', level: 'beginner', minutes: 10 },

    // Section 2: Wheel Strategy
    { section: 'The Wheel Strategy', title: 'Wheel Strategy Fundamentals', desc: 'The complete overview: Learn the 3-phase cycle and monthly income generation.', level: 'beginner', minutes: 18 },
    { section: 'The Wheel Strategy', title: 'Why the Wheel Works', desc: 'Understand the mathematical edge and probability advantage.', level: 'beginner', minutes: 14 },
    { section: 'The Wheel Strategy', title: 'Common Wheel Mistakes', desc: 'Avoid the top 10 mistakes that destroy returns.', level: 'intermediate', minutes: 16 },

    // Section 3: Cash Secured Puts
    { section: 'Cash Secured Puts', title: 'CSP Deep Dive', desc: 'Master cash secured puts: strike selection, capital requirements, and risk management.', level: 'beginner', minutes: 20 },
    { section: 'Cash Secured Puts', title: 'Strike Selection for CSPs', desc: 'Using delta, support levels, and technical analysis for optimal strikes.', level: 'intermediate', minutes: 17 },
    { section: 'Cash Secured Puts', title: 'When to Sell Puts', desc: 'Best market conditions, IV levels, and technical setups for maximum premium.', level: 'intermediate', minutes: 13 },
    { section: 'Cash Secured Puts', title: 'Managing CSP Assignments', desc: 'What happens when you get assigned and how to transition to phase 2.', level: 'intermediate', minutes: 15 },

    // Section 4: Covered Calls
    { section: 'Covered Calls', title: 'Covered Calls Explained', desc: 'Complete guide to selling calls: strike selection, timing, and premium income.', level: 'beginner', minutes: 18 },
    { section: 'Covered Calls', title: 'Avoiding Early Assignment', desc: 'Prevent shares from being called away too early with ex-dividend strategies.', level: 'intermediate', minutes: 14 },
    { section: 'Covered Calls', title: 'Rolling Covered Calls', desc: 'How to roll calls up, out, or both to collect additional premium.', level: 'advanced', minutes: 16 },

    // Section 5: Stock Selection
    { section: 'Stock Selection', title: 'Best Stocks for Wheeling', desc: 'Criteria: IV rank, liquidity, fundamentals, dividend yield, and sector analysis.', level: 'intermediate', minutes: 22 },
    { section: 'Stock Selection', title: 'Blue Chips vs Growth Stocks', desc: 'Comparing stable blue chips vs volatile growth stocks for the wheel.', level: 'intermediate', minutes: 19 },
    { section: 'Stock Selection', title: 'ETF Wheeling Strategy', desc: 'Why SPY, QQQ, and IWM are perfect: lower risk, better diversification.', level: 'beginner', minutes: 15 },

    // Section 6: Options Greeks
    { section: 'Options Greeks', title: 'Delta for Beginners', desc: 'Understanding delta: probability of profit and why 0.30 delta is the sweet spot.', level: 'beginner', minutes: 16 },
    { section: 'Options Greeks', title: 'Theta: Your Best Friend', desc: 'How time decay works in your favor and optimal DTE ranges.', level: 'intermediate', minutes: 14 },
    { section: 'Options Greeks', title: 'IV and Vega Explained', desc: 'Implied volatility: how it affects premiums and when to sell puts.', level: 'intermediate', minutes: 18 },
    { section: 'Options Greeks', title: 'Gamma & Advanced Greeks', desc: 'Deep dive into gamma, rho, and how Greeks interact.', level: 'advanced', minutes: 20 },

    // Section 7: Risk Management
    { section: 'Risk Management', title: 'Position Sizing for the Wheel', desc: 'Calculate proper sizes based on account, risk tolerance, and diversification.', level: 'beginner', minutes: 17 },
    { section: 'Risk Management', title: 'Portfolio Diversification', desc: 'How many positions to run, sector allocation, and avoiding concentration risk.', level: 'intermediate', minutes: 15 },
    { section: 'Risk Management', title: 'Stop Losses and When to Exit', desc: 'Setting stop losses and knowing when to abandon the wheel.', level: 'intermediate', minutes: 19 },
    { section: 'Risk Management', title: 'Hedging Your Wheel Portfolio', desc: 'Portfolio-level hedging using VIX calls and portfolio puts.', level: 'advanced', minutes: 22 },

    // Section 8: Advanced Strategies
    { section: 'Advanced Strategies', title: 'Rolling Options Like a Pro', desc: 'Master the art of rolling: when to roll, how to roll for credits, avoiding traps.', level: 'advanced', minutes: 21 },
    { section: 'Advanced Strategies', title: "Poor Man's Covered Call", desc: 'Capital-efficient wheeling using PMCC: Buy LEAPS, sell short calls.', level: 'advanced', minutes: 24 },
    { section: 'Advanced Strategies', title: 'Wheel with Margin', desc: 'Using portfolio margin to 2x-3x returns. Risks and best practices.', level: 'advanced', minutes: 18 },
    { section: 'Advanced Strategies', title: 'Earnings & IV Crush Plays', desc: 'Selling puts before earnings and capturing IV crush.', level: 'advanced', minutes: 20 },

    // Section 9: Practical Execution
    { section: 'Execution', title: 'Broker Selection & Setup', desc: 'Comparing brokers: fees, margin rates, apps, and which is best for the wheel.', level: 'beginner', minutes: 14 },
    { section: 'Execution', title: 'Order Types & Fills', desc: 'Limit orders, market orders, avoiding bad fills, and best execution.', level: 'beginner', minutes: 12 },
    { section: 'Execution', title: 'Tax Implications', desc: 'How options are taxed, wash sale rules, and tax-efficient wheeling.', level: 'intermediate', minutes: 19 },
    { section: 'Execution', title: 'Tracking Performance', desc: 'Essential metrics: win rate, average premium, ROC, annualized returns.', level: 'intermediate', minutes: 16 },

    // Section 10: Case Studies
    { section: 'Case Studies', title: '$25K Account Wheel Strategy', desc: 'Real portfolio: position allocation, monthly income targets, actual results.', level: 'intermediate', minutes: 25 },
    { section: 'Case Studies', title: '$100K Account Wheel Strategy', desc: 'Scaling up: managing 8-10 positions and generating $2K-4K monthly.', level: 'advanced', minutes: 28 },
    { section: 'Case Studies', title: 'Real Trade Breakdowns', desc: 'Walk through 5 real wheel cycles: wins, losses, assignments, lessons learned.', level: 'intermediate', minutes: 32 }
  ];

  // Group by section
  const sections = {};
  lessons.forEach(lesson => {
    if (!sections[lesson.section]) sections[lesson.section] = [];
    sections[lesson.section].push(lesson);
  });

  // Render
  let html = '<div style="text-align:center;margin-bottom:28px;padding:24px;background:rgba(96,165,250,.08);border-radius:16px">';
  html += '<h2 style="font-size:24px;font-weight:800;margin-bottom:8px">üéì Complete Wheel Strategy Course</h2>';
  html += '<p style="color:var(--text2);font-size:14px">35+ lessons from absolute beginner to advanced ‚Ä¢ 9+ hours</p>';
  html += '</div>';

  Object.entries(sections).forEach(([section, sectionLessons]) => {
    html += `<div class="section-header"><div class="section-line"></div>${section}</div>`;
    sectionLessons.forEach(lesson => {
      html += `<div class="lesson-card">`;
      html += `<div class="lesson-title">${lesson.title}</div>`;
      html += `<div class="lesson-desc">${lesson.desc}</div>`;
      html += `<div style="display:flex;align-items:center;gap:8px">`;
      html += `<span class="lesson-badge ${lesson.level}">${lesson.level}</span>`;
      html += `<span style="font-size:11px;color:var(--text3)">${lesson.minutes} min</span>`;
      html += `</div></div>`;
    });
  });

  $('learnContent').innerHTML = html;
}

// Payment Processing
function processPayment() {
  const email = $('paymentEmail').value.trim();
  const card = $('paymentCard').value.trim();
  const expiry = $('paymentExpiry').value.trim();
  const cvc = $('paymentCVC').value.trim();

  if (!email || !card || !expiry || !cvc) {
    toast('Please fill all payment fields', 'error');
    return;
  }

  // Simulate payment processing
  toast('Processing payment...');
  setTimeout(() => {
    toast('Payment successful! Welcome to Premium üéâ');
    closeModal('premiumModal');
  }, 2000);
}

// Broker Guides
function showBrokerGuide(broker) {
  const guides = {
    alpaca: {
      title: 'Alpaca API Setup Guide',
      steps: [
        { title: 'Create Alpaca Account', content: 'Go to <a href="https://alpaca.markets" target="_blank" style="color:var(--accent)">alpaca.markets</a> and sign up for a free account. Choose "Individual" account type.' },
        { title: 'Verify Your Identity', content: 'Complete KYC verification by uploading your ID and proof of address. This usually takes 1-2 business days.' },
        { title: 'Navigate to API Keys', content: 'Log in and go to <strong>Paper Trading</strong> section, then click <strong>"View API Keys"</strong>.' },
        { title: 'Generate API Keys', content: 'Click <strong>"Generate New Key"</strong>. You\'ll see:<br>‚Ä¢ <strong>API Key ID</strong> (starts with "PK...")<br>‚Ä¢ <strong>Secret Key</strong><br><br>‚ö†Ô∏è Copy both immediately - secret key shown only once!' },
        { title: 'Enter Keys in Market Elites', content: 'Paste your keys in the form above and click Connect.' },
        { title: 'Paper vs Live Trading', content: 'Start with <strong>Paper Trading</strong> (free, virtual $100K). Switch to Live Trading once confident.' }
      ],
      tips: [
        'Paper trading is completely free and resets monthly',
        'API keys are different for paper vs live - don\'t mix them',
        'Never share your secret keys',
        'Alpaca has $0 commission on stocks',
        'Minimum for live: $0 (recommend $5K+ for wheeling)'
      ]
    },
    ibkr: {
      title: 'Interactive Brokers API Setup',
      steps: [
        { title: 'Open IBKR Account', content: 'Go to <a href="https://www.interactivebrokers.com" target="_blank" style="color:var(--accent)">interactivebrokers.com</a>. Choose "Margin" account for options.' },
        { title: 'Fund Your Account', content: 'IBKR requires minimum <strong>$2,000</strong> for options in cash accounts, or <strong>$25,000</strong> for pattern day trading.' },
        { title: 'Enable API Access', content: 'Log into <strong>Client Portal</strong> ‚Üí <strong>Settings</strong> ‚Üí <strong>API</strong> ‚Üí Enable "ActiveX and Socket Clients".' },
        { title: 'Create API Key', content: 'In API Settings, create new API application. You\'ll receive:<br>‚Ä¢ <strong>Client ID</strong><br>‚Ä¢ <strong>API Key</strong>' },
        { title: 'Install TWS or IB Gateway', content: 'Download <strong>Trader Workstation</strong> or <strong>IB Gateway</strong>. Must be running for API connections.' },
        { title: 'Enter Credentials', content: 'Enter Client ID and API Key above. Ensure TWS/Gateway is running before connecting.' }
      ],
      tips: [
        'IBKR has very low commission: $0.65 per options contract',
        'Need TWS or IB Gateway running for API connections',
        'Socket Port: 7496 for live, 7497 for paper',
        'Paper account requires separate application',
        'Best for traders with $25K+ who want lowest fees'
      ]
    },
    robinhood: {
      title: 'Robinhood Connection Info',
      steps: [
        { title: 'Important Limitation', content: '‚ö†Ô∏è <strong>Robinhood does not offer official public API</strong> for retail users. Integration here is for educational purposes.' },
        { title: 'Robinhood Account', content: 'Download <strong>Robinhood app</strong> and create account. Enable <strong>Options Trading</strong> in Settings.' },
        { title: 'Enable 2FA', content: 'Go to Settings ‚Üí Security ‚Üí Two-Factor Authentication. Choose "Authenticator App".' },
        { title: 'Get Account Token', content: 'Currently no official way to get API credentials. Third-party libraries exist but <strong>not recommended</strong> for security.' },
        { title: 'Alternative: Manual Tracking', content: 'We recommend manually entering your Robinhood trades in Market Elites for tracking.' },
        { title: 'Consider Other Brokers', content: 'For API integration, strongly recommend <strong>Alpaca</strong> (free, easy) or <strong>IBKR</strong> (professional).' }
      ],
      tips: [
        'Robinhood has $0 commissions but limited API',
        'Best for small accounts ($500-$5K) and manual tracking',
        'Cannot automate trades with Robinhood',
        'Consider Alpaca or IBKR for serious wheel trading',
        'Had reliability issues during high volatility'
      ]
    },
    thinkorswim: {
      title: 'TD Ameritrade / thinkorSwim API Setup',
      steps: [
        { title: 'Create TD Ameritrade Account', content: 'Go to <a href="https://www.tdameritrade.com" target="_blank" style="color:var(--accent)">tdameritrade.com</a>. No minimum deposit, but fund with $2K+ for options.' },
        { title: 'Enable Options Trading', content: 'Log in ‚Üí <strong>Client Services</strong> ‚Üí <strong>My Profile</strong> ‚Üí Apply for Options Level 2 (covered calls & cash-secured puts).' },
        { title: 'Create Developer Account', content: 'Register at <a href="https://developer.tdameritrade.com" target="_blank" style="color:var(--accent)">developer.tdameritrade.com</a>.' },
        { title: 'Create API App', content: 'In developer portal, create new app:<br>‚Ä¢ <strong>App Name:</strong> "Market Elites"<br>‚Ä¢ <strong>Callback URL:</strong> https://localhost<br>You\'ll get a <strong>Consumer Key</strong>' },
        { title: 'Generate Refresh Token', content: 'Follow TD\'s OAuth flow to generate <strong>Refresh Token</strong>. Token lasts 90 days.' },
        { title: 'Enter Credentials', content: 'Enter Consumer Key and Refresh Token above.' }
      ],
      tips: [
        'TD charges $0.65 per options contract',
        'thinkorSwim has BEST options platform and charts',
        'Refresh tokens expire after 90 days - need to regenerate',
        'Great for analyzing trades with thinkorSwim desktop',
        'TD merging with Schwab - API may change in 2024-2025'
      ]
    }
  };

  const guide = guides[broker];
  if (!guide) return;

  let html = `<h3 style="font-size:20px;font-weight:700;margin-bottom:20px;text-align:center">${guide.title}</h3>`;

  guide.steps.forEach((step, i) => {
    html += `<div class="guide-step">`;
    html += `<div class="step-number">${i + 1}</div>`;
    html += `<div class="step-title">${step.title}</div>`;
    html += `<div class="step-content">${step.content}</div>`;
    html += `</div>`;
  });

  html += `<div style="background:rgba(96,165,250,.08);border:1px solid rgba(96,165,250,.2);border-radius:16px;padding:20px;margin-top:20px">`;
  html += `<h4 style="font-size:15px;font-weight:700;margin-bottom:12px">üí° Pro Tips</h4>`;
  html += `<ul style="margin:0;padding-left:20px;font-size:13px;color:var(--text2);line-height:1.8">`;
  guide.tips.forEach(tip => {
    html += `<li>${tip}</li>`;
  });
  html += `</ul></div>`;

  $('guideTitle').textContent = guide.title;
  $('guideContent').innerHTML = html;
  show('brokerGuideModal');
}

// Check auth state on load
if (supabase) {
  supabase.auth.onAuthStateChange((event, session) => {
    console.log('Auth state changed:', event, session?.user?.email);
    try {
      if (session?.user) {
        currentUser = session.user;
        isAdmin = (session.user.email === 'beau@marketelites.io');

        hide('signInScreen');
        hide('signUpScreen');
        show('mainApp');

        if (isAdmin) {
          console.log('Showing admin panel');
          show('adminPanel');
        }

        const initial = session.user.email.charAt(0).toUpperCase();
        const avatarEl = $('avatar');
        if (avatarEl) {
          avatarEl.textContent = initial;
        }
      } else {
        console.log('No session, showing sign in');
        showSignIn();
      }
    } catch (error) {
      console.error('Error in auth state change handler:', error);
    }
  });
} else {
  console.error('Supabase not available, showing sign in');
  showSignIn();
}

// Initialize
console.log('Market Elites initialized');
console.log('All functions loaded:', typeof signIn, typeof signOut, typeof signUp);
</script>
</body>
</html>
