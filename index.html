<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1d1d1f">
  <meta name="description" content="Master the wheel strategy. Track your options portfolio, get live trading signals, and learn to generate consistent income selling cash secured puts and covered calls.">
  <meta property="og:title" content="Market Elites — Wheel Strategy Platform">
  <meta property="og:description" content="Track your wheel strategy portfolio, get live signals, and learn to generate consistent income from options.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://elitesbeau.github.io/wheel/logo.png">
  <meta property="og:url" content="https://elitesbeau.github.io/wheel/">
  <meta name="twitter:card" content="summary">
  <link rel="icon" type="image/png" href="logo.png">
  <link rel="apple-touch-icon" href="logo.png">
  <title>Market Elites — Wheel Strategy Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    /* === THEME: Default (Light) === */
    :root{--bg:#f5f5f7;--card:#fff;--input:#f0f0f2;--text:#1d1d1f;--text2:#86868b;--text3:#aeaeb2;--border:#e5e5e7;--hero:#1d1d1f;--green:#34c759;--green-bg:rgba(52,199,89,.12);--red:#ff3b30;--red-bg:rgba(255,59,48,.12);--blue:#007aff;--blue-bg:rgba(0,122,255,.12);--orange:#ff9500;--orange-bg:rgba(255,149,0,.12);--purple:#af52de;--purple-bg:rgba(175,82,222,.12);--accent:#007aff;--accent-bg:rgba(0,122,255,.12);--glow:none;--card-shadow:0 1px 3px rgba(0,0,0,.06);--nav-bg:rgba(255,255,255,.92);--font-display:'Inter',sans-serif;--font-body:'Inter',sans-serif;--radius:12px;--hero-gradient:none}

    /* === THEME: Dark — Midnight Terminal (ufotimeline + ana.sh + Aceternity) === */
    [data-theme=dark]{
      --bg:#0d0f13;--card:rgba(255,255,255,.03);--input:rgba(255,255,255,.06);--text:rgba(255,255,255,.95);
      --text2:rgba(255,255,255,.5);--text3:rgba(255,255,255,.3);--border:rgba(255,255,255,.06);
      --hero:rgba(255,255,255,.04);--green:#00C853;--green-bg:rgba(0,200,83,.12);--red:#FF1744;
      --red-bg:rgba(255,23,68,.12);--blue:#7A5AF8;--blue-bg:rgba(122,90,248,.12);--orange:#febe02;
      --orange-bg:rgba(254,190,2,.12);--purple:#A78BFA;--purple-bg:rgba(167,139,250,.12);
      --accent:#7A5AF8;--accent-bg:rgba(122,90,248,.12);--nav-bg:rgba(13,15,19,.85);
      --card-shadow:none;--glow:none;--radius:16px
    }
    /* Dark — Page background with subtle noise texture */
    [data-theme=dark] body{background:#0d0f13;color:rgba(255,255,255,.7);-webkit-font-smoothing:antialiased}
    /* Dark — Glassmorphic cards with inset glow */
    [data-theme=dark] .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);box-shadow:inset 0 1px 0 rgba(255,255,255,.04);backdrop-filter:blur(12px) saturate(1.3)}
    [data-theme=dark] .card:hover{background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.1)}
    /* Dark — Hero with gradient glow */
    [data-theme=dark] .hero{background:linear-gradient(180deg,rgba(122,90,248,.06) 0%,#0d0f13 100%);border-bottom:none}
    [data-theme=dark] .hero::before{background:radial-gradient(ellipse at 70% 20%,rgba(122,90,248,.12) 0%,transparent 60%)}
    [data-theme=dark] .balance-amount{color:#fff;text-shadow:0 0 40px rgba(122,90,248,.15)}
    [data-theme=dark] .balance-label{color:rgba(255,255,255,.4);letter-spacing:1px;text-transform:uppercase;font-size:11px}
    [data-theme=dark] .balance-change{background:rgba(0,200,83,.1);border:1px solid rgba(0,200,83,.2);color:#00C853;border-radius:8px}
    /* Dark — Hero action buttons: glass circles with glow */
    [data-theme=dark] .hero-btn-icon{border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.04);backdrop-filter:blur(8px);transition:all .2s ease}
    [data-theme=dark] .hero-btn-icon:hover{background:rgba(255,255,255,.08);border-color:rgba(122,90,248,.3);box-shadow:0 0 20px rgba(122,90,248,.1)}
    [data-theme=dark] .hero-btn span{color:rgba(255,255,255,.5)}
    /* Dark — Quick action circles: colored glow */
    [data-theme=dark] .quick-icon{backdrop-filter:blur(8px);transition:all .2s ease}
    [data-theme=dark] .quick-icon.blue{background:rgba(122,90,248,.1);border-color:rgba(122,90,248,.25)}
    [data-theme=dark] .quick-icon.blue svg{stroke:#7A5AF8}
    [data-theme=dark] .quick-icon.green{background:rgba(0,200,83,.1);border-color:rgba(0,200,83,.25)}
    [data-theme=dark] .quick-icon.green svg{stroke:#00C853}
    [data-theme=dark] .quick-icon.purple{background:rgba(167,139,250,.1);border-color:rgba(167,139,250,.25)}
    [data-theme=dark] .quick-icon.purple svg{stroke:#A78BFA}
    [data-theme=dark] .quick-icon.orange{background:rgba(254,190,2,.1);border-color:rgba(254,190,2,.25)}
    [data-theme=dark] .quick-icon.orange svg{stroke:#febe02}
    [data-theme=dark] .quick-icon:hover{transform:scale(1.1);box-shadow:0 0 24px rgba(122,90,248,.15)}
    [data-theme=dark] .quick-btn span{color:rgba(255,255,255,.5)}
    /* Dark — Position cards: transparent + border-left accent + inset glow */
    [data-theme=dark] .pos-card{background:transparent;border:none;border-bottom:1px solid rgba(255,255,255,.06);border-radius:0;padding:14px 0;transition:all .2s ease}
    [data-theme=dark] .pos-card:hover{background:rgba(255,255,255,.03);padding-left:12px;border-radius:12px}
    [data-theme=dark] .pos-card:active{transform:none}
    [data-theme=dark] .pos-logo{border-radius:10px;background:rgba(255,255,255,.06)}
    [data-theme=dark] .pos-logo-text{background:linear-gradient(135deg,#7A5AF8,#A78BFA);border-radius:10px}
    [data-theme=dark] .pos-symbol{color:rgba(255,255,255,.95);font-weight:600}
    [data-theme=dark] .pos-name{color:rgba(255,255,255,.4)}
    [data-theme=dark] .pos-badge.csp{background:rgba(0,200,83,.1);color:#00C853;border:1px solid rgba(0,200,83,.2)}
    [data-theme=dark] .pos-badge.cc{background:rgba(122,90,248,.1);color:#7A5AF8;border:1px solid rgba(122,90,248,.2)}
    [data-theme=dark] .pos-badge.shares{background:rgba(167,139,250,.1);color:#A78BFA;border:1px solid rgba(167,139,250,.2)}
    [data-theme=dark] .pos-stat-val{color:rgba(255,255,255,.85);font-variant-numeric:tabular-nums}
    [data-theme=dark] .pos-stat-val.pos{color:#00C853}
    [data-theme=dark] .pos-stat-val.neg{color:#FF1744}
    [data-theme=dark] .pos-stat-label{color:rgba(255,255,255,.3)}
    /* Dark — Section headers */
    [data-theme=dark] .section-title{color:rgba(255,255,255,.85);font-weight:600}
    [data-theme=dark] .section-link{color:#7A5AF8}
    /* Dark — Navigation: glass with blur */
    [data-theme=dark] .nav{background:rgba(13,15,19,.92);backdrop-filter:blur(20px) saturate(1.5);border-top:none;box-shadow:0 -1px 12px rgba(0,0,0,.3)}
    [data-theme=dark] .nav-btn.active svg{stroke:#7A5AF8}
    [data-theme=dark] .nav-btn.active span{color:#7A5AF8;font-weight:600}
    [data-theme=dark] .nav-btn:not(.active) svg{stroke:rgba(255,255,255,.3)}
    [data-theme=dark] .nav-btn:not(.active) span{color:rgba(255,255,255,.3)}
    /* Dark — Buttons: gradient with shimmer */
    [data-theme=dark] .btn{background:linear-gradient(135deg,#7A5AF8,#6344e0);border:none;position:relative;overflow:hidden;transition:all .2s ease}
    [data-theme=dark] .btn:hover{box-shadow:0 8px 30px rgba(122,90,248,.25);transform:translateY(-1px)}
    [data-theme=dark] .btn:active{transform:translateY(0) scale(.98)}
    [data-theme=dark] .btn-outline{background:transparent;border:1px solid rgba(255,255,255,.12);color:rgba(255,255,255,.7)}
    [data-theme=dark] .btn-outline:hover{border-color:rgba(122,90,248,.4);color:#7A5AF8;box-shadow:0 0 20px rgba(122,90,248,.08)}
    [data-theme=dark] .btn-red{background:rgba(255,23,68,.1);color:#FF1744;border:1px solid rgba(255,23,68,.2)}
    /* Dark — Forms: subtle glass inputs */
    [data-theme=dark] .form-input{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);color:rgba(255,255,255,.85)}
    [data-theme=dark] .form-select,[data-theme=dark] select.form-input,[data-theme=dark] select{background:#1a1d24;border:1px solid rgba(255,255,255,.08);color:rgba(255,255,255,.85);color-scheme:dark}
    [data-theme=dark] select option,[data-theme=dark] .form-select option{background:#1a1d24;color:rgba(255,255,255,.85)}
    [data-theme=dark] .form-input:focus{border-color:rgba(122,90,248,.4);box-shadow:0 0 0 3px rgba(122,90,248,.08);background:rgba(255,255,255,.06)}
    [data-theme=dark] .form-label{color:rgba(255,255,255,.4)}
    /* Dark — Toggle: purple active */
    [data-theme=dark] .toggle{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.06)}
    [data-theme=dark] .toggle-btn{color:rgba(255,255,255,.4)}
    [data-theme=dark] .toggle-btn.active{background:rgba(122,90,248,.15);color:#7A5AF8;box-shadow:none}
    /* Dark — Switch */
    [data-theme=dark] .switch.on{background:linear-gradient(135deg,#7A5AF8,#6344e0)}
    /* Dark — Chip buttons */
    [data-theme=dark] .chip-btn{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);color:rgba(255,255,255,.6)}
    [data-theme=dark] .chip-btn:hover,[data-theme=dark] .chip-btn.active{background:rgba(122,90,248,.12);color:#7A5AF8;border-color:rgba(122,90,248,.3)}
    /* Dark — Ticker buttons */
    [data-theme=dark] .ticker-btn{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);color:rgba(255,255,255,.5)}
    [data-theme=dark] .ticker-btn:active{background:#7A5AF8;color:#fff;border-color:#7A5AF8}
    /* Dark — Transaction list */
    [data-theme=dark] .tx-list{background:transparent;border:none}
    [data-theme=dark] .tx-item{border-bottom:1px solid rgba(255,255,255,.06)}
    [data-theme=dark] .tx-icon.csp{background:rgba(0,200,83,.1)}.tx-icon.csp svg{stroke:#00C853}
    [data-theme=dark] .tx-icon.cc{background:rgba(122,90,248,.1)}.tx-icon.cc svg{stroke:#7A5AF8}
    [data-theme=dark] .tx-title{color:rgba(255,255,255,.85)}
    [data-theme=dark] .tx-amount.pos{color:#00C853}
    [data-theme=dark] .tx-amount.neg{color:#FF1744}
    /* Dark — Stats */
    [data-theme=dark] .stat-box{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);box-shadow:inset 0 1px 0 rgba(255,255,255,.03)}
    [data-theme=dark] .stat-val{font-variant-numeric:tabular-nums}
    [data-theme=dark] .stat-val.green{color:#00C853;text-shadow:0 0 20px rgba(0,200,83,.2)}
    [data-theme=dark] .stat-val.blue{color:#7A5AF8;text-shadow:0 0 20px rgba(122,90,248,.2)}
    /* Dark — Modals: glass */
    [data-theme=dark] .modal{background:rgba(20,22,28,.95);backdrop-filter:blur(20px) saturate(1.5);border:1px solid rgba(255,255,255,.06);border-bottom:none}
    [data-theme=dark] .modal-bg{background:rgba(0,0,0,.7)}
    [data-theme=dark] .modal-handle{background:rgba(255,255,255,.15)}
    [data-theme=dark] .modal-title{color:rgba(255,255,255,.95)}
    /* Dark — Signals */
    [data-theme=dark] .signal-card{background:transparent;border:1px solid rgba(255,255,255,.06)}
    [data-theme=dark] .signal-card:hover{background:rgba(255,255,255,.03)}
    [data-theme=dark] .signal-ticker{color:rgba(255,255,255,.95)}
    [data-theme=dark] .signal-type.csp{background:rgba(0,200,83,.1);color:#00C853;border:1px solid rgba(0,200,83,.2)}
    [data-theme=dark] .signal-type.cc{background:rgba(122,90,248,.1);color:#7A5AF8;border:1px solid rgba(122,90,248,.2)}
    /* Dark — Copy trade button */
    [data-theme=dark] .copy-trade-btn{background:linear-gradient(135deg,#00C853,#36bdaa);color:#0d0f13;font-weight:700}
    /* Dark — Chain picker */
    [data-theme=dark] .chain-row{border-bottom:1px solid rgba(255,255,255,.04)}
    [data-theme=dark] .chain-row:hover{background:rgba(255,255,255,.04)}
    [data-theme=dark] .chain-row.selected{background:rgba(0,200,83,.08);border-left:3px solid #00C853}
    [data-theme=dark] .chain-exp-btn{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);color:rgba(255,255,255,.5)}
    [data-theme=dark] .chain-exp-btn.active{background:rgba(122,90,248,.15);color:#7A5AF8;border-color:rgba(122,90,248,.3)}
    /* Dark — Empty states */
    [data-theme=dark] .empty{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06)}
    [data-theme=dark] .empty-icon{background:rgba(255,255,255,.04)}
    [data-theme=dark] .empty-btn{background:linear-gradient(135deg,#7A5AF8,#6344e0)}
    /* Dark — Search */
    [data-theme=dark] .search-input{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);color:rgba(255,255,255,.85)}
    [data-theme=dark] .search-btn{background:linear-gradient(135deg,#7A5AF8,#6344e0)}
    /* Dark — Status indicator with breathing glow */
    [data-theme=dark] .status{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06)}
    [data-theme=dark] .status.live .status-dot{background:#00C853;box-shadow:0 0 8px rgba(0,200,83,.6)}
    /* Dark — Avatar */
    [data-theme=dark] .avatar-btn{background:linear-gradient(135deg,#7A5AF8,#36bdaa);border:2px solid rgba(255,255,255,.15)}
    /* Dark — Settings rows */
    [data-theme=dark] .setting-row{border-bottom:1px solid rgba(255,255,255,.06)}
    /* Dark — Icon buttons in hero */
    [data-theme=dark] .icon-btn{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08)}
    [data-theme=dark] .icon-btn:hover{background:rgba(255,255,255,.1)}
    /* Dark — Goal bar */
    [data-theme=dark] .goal-bar-wrap{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06)}
    [data-theme=dark] .goal-fill{background:linear-gradient(90deg,#7A5AF8,#36bdaa)}
    /* Dark — Screener cards */
    [data-theme=dark] .screener-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.04)}
    [data-theme=dark] .screener-card:hover{background:rgba(255,255,255,.06);border-color:rgba(0,200,83,.3)}
    /* Dark — Earnings */
    [data-theme=dark] .earn-date{background:rgba(255,255,255,.04)}
    /* Dark — Leaderboard */
    [data-theme=dark] .lb-rank.normal{background:rgba(255,255,255,.06)}
    /* Dark — Backtest */
    [data-theme=dark] .bt-result{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06)}
    /* Dark — Badges */
    [data-theme=dark] .badge{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06)}
    [data-theme=dark] .badge.gold{background:rgba(255,215,0,.08);border:1px solid rgba(255,215,0,.2);color:#ffd700}
    /* Dark — Roll cards */
    [data-theme=dark] .roll-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06)}
    [data-theme=dark] .roll-card:hover{border-color:rgba(122,90,248,.3);background:rgba(122,90,248,.04)}
    /* Dark — DTE warnings */
    [data-theme=dark] .dte-warn.danger{background:rgba(255,23,68,.1);color:#FF1744;border:1px solid rgba(255,23,68,.2)}
    [data-theme=dark] .dte-warn.caution{background:rgba(254,190,2,.1);color:#febe02;border:1px solid rgba(254,190,2,.2)}
    /* Dark — Footer */
    [data-theme=dark] .footer a{color:rgba(255,255,255,.3)}
    [data-theme=dark] .footer p{color:rgba(255,255,255,.2)}

    /* === THEME: Pro Trader (Webull/TradingView) === */
    [data-theme=pro]{--bg:#0a0e17;--card:#131722;--input:#1e222d;--text:#d1d4dc;--text2:#787b86;--text3:#4c525e;--border:#2a2e39;--hero:#131722;--green:#26a69a;--green-bg:rgba(38,166,154,.15);--red:#ef5350;--red-bg:rgba(239,83,80,.15);--blue:#2962ff;--blue-bg:rgba(41,98,255,.15);--orange:#ff9800;--orange-bg:rgba(255,152,0,.15);--purple:#7c4dff;--purple-bg:rgba(124,77,255,.15);--accent:#2962ff;--accent-bg:rgba(41,98,255,.15);--nav-bg:rgba(10,14,23,.95);--card-shadow:0 2px 8px rgba(0,0,0,.4);--hero-gradient:linear-gradient(135deg,rgba(41,98,255,.08),rgba(38,166,154,.05))}

    /* === THEME: Luxury Fintech (Bloomberg + Gold) === */
    [data-theme=luxury]{--bg:#0c0c0f;--card:#16161a;--input:#1e1e24;--text:#e8e6e3;--text2:#9b9792;--text3:#6b6760;--border:#2a2925;--hero:#16161a;--green:#c9a962;--green-bg:rgba(201,169,98,.12);--red:#c45050;--red-bg:rgba(196,80,80,.12);--blue:#8b7355;--blue-bg:rgba(139,115,85,.12);--orange:#d4a055;--orange-bg:rgba(212,160,85,.12);--purple:#9b8ec4;--purple-bg:rgba(155,142,196,.12);--accent:#c9a962;--accent-bg:rgba(201,169,98,.12);--nav-bg:rgba(12,12,15,.95);--card-shadow:0 2px 12px rgba(0,0,0,.5),0 0 1px rgba(201,169,98,.1);--hero-gradient:linear-gradient(135deg,rgba(201,169,98,.06),rgba(139,115,85,.03))}

    /* === THEME: 80s Retro (Synthwave) === */
    [data-theme=retro]{--bg:#1a1025;--card:#211332;--input:#2a1a3d;--text:#e8ddf5;--text2:#a893c4;--text3:#6e5a8a;--border:#342150;--hero:#211332;--green:#5cf5a0;--green-bg:rgba(92,245,160,.1);--red:#e8507a;--red-bg:rgba(232,80,122,.1);--blue:#5cc8e8;--blue-bg:rgba(92,200,232,.1);--orange:#e8884a;--orange-bg:rgba(232,136,74,.1);--purple:#b08ee0;--purple-bg:rgba(176,142,224,.12);--accent:#e8507a;--accent-bg:rgba(232,80,122,.1);--nav-bg:rgba(26,16,37,.95);--card-shadow:0 2px 12px rgba(176,142,224,.06);--glow:0 0 16px rgba(176,142,224,.1);--hero-gradient:linear-gradient(135deg,rgba(232,80,122,.06),rgba(92,200,232,.04),rgba(176,142,224,.06))}

    /* === THEME: Fun / Playful === */
    [data-theme=fun]{--bg:#fef7f0;--card:#fff;--input:#fff5eb;--text:#2d1b69;--text2:#6b5b95;--text3:#9b8fc2;--border:#ede3f7;--hero:#2d1b69;--green:#10b981;--green-bg:rgba(16,185,129,.12);--red:#f43f5e;--red-bg:rgba(244,63,94,.12);--blue:#6366f1;--blue-bg:rgba(99,102,241,.12);--orange:#f59e0b;--orange-bg:rgba(245,158,11,.12);--purple:#a855f7;--purple-bg:rgba(168,85,247,.15);--accent:#6366f1;--accent-bg:rgba(99,102,241,.12);--nav-bg:rgba(254,247,240,.95);--card-shadow:0 2px 8px rgba(45,27,105,.06);--hero-gradient:linear-gradient(135deg,rgba(99,102,241,.06),rgba(168,85,247,.04))}

    /* === THEME: Clean Minimal (Robinhood) === */
    [data-theme=clean]{--bg:#ffffff;--card:#ffffff;--input:#f4f4f5;--text:#1a1a1d;--text2:#6b6f76;--text3:#9ea2ab;--border:#e8e8eb;--hero:#1a1a1d;--green:#00c805;--green-bg:rgba(0,200,5,.08);--red:#ff5000;--red-bg:rgba(255,80,0,.08);--blue:#1a1a1d;--blue-bg:rgba(26,26,29,.06);--orange:#ff9500;--orange-bg:rgba(255,149,0,.08);--purple:#7b61ff;--purple-bg:rgba(123,97,255,.08);--accent:#00c805;--accent-bg:rgba(0,200,5,.08);--nav-bg:rgba(255,255,255,.97);--card-shadow:none;--hero-gradient:none;--glow:none;--font-display:-apple-system,'SF Pro Display','Inter',sans-serif;--font-body:-apple-system,'SF Pro Text','Inter',sans-serif;--radius:8px}

    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .app{max-width:430px;margin:0 auto;padding:12px 0 90px}
    .hero{margin:0 16px 8px;background:var(--hero);border-radius:24px;padding:20px;position:relative;overflow:hidden}
    .hero::before{content:'';position:absolute;top:-80%;right:-20%;width:300px;height:300px;background:radial-gradient(circle,rgba(255,255,255,.08) 0%,transparent 70%)}
    .hero-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;position:relative;z-index:1}
    .hero-left{display:flex;align-items:center;gap:10px}
    .icon-btn{width:40px;height:40px;background:rgba(255,255,255,.1);border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .icon-btn:active{background:rgba(255,255,255,.2)}
    .icon-btn svg{width:20px;height:20px;stroke:#fff;stroke-width:1.75;fill:none}
    .avatar-btn{width:40px;height:40px;border-radius:50%;border:2px solid rgba(255,255,255,.3);background:linear-gradient(135deg,#f97316,#dc2626);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .avatar-btn span{color:#fff;font-weight:700;font-size:14px}
    .status{display:flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(255,255,255,.1);border-radius:20px;font-size:11px;font-weight:600;color:#fff}
    .status-dot{width:6px;height:6px;border-radius:50%;background:var(--red)}
    .status.ready .status-dot{background:var(--orange)}
    .status.live .status-dot{background:var(--green);animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .hero-balance{text-align:center;margin-bottom:32px;position:relative;z-index:1}
    .balance-label{color:rgba(255,255,255,.6);font-size:13px;margin-bottom:6px}
    .balance-amount{font-size:44px;font-weight:800;color:#fff}
    .balance-change{display:inline-flex;flex-direction:column;align-items:center;margin-top:8px;padding:8px 16px;background:var(--green-bg);border-radius:12px;font-size:14px;font-weight:600;color:var(--green);line-height:1.4;gap:2px}
    .hero-actions{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;position:relative;z-index:1}
    .hero-btn{display:flex;flex-direction:column;align-items:center;gap:10px;background:none;border:none;cursor:pointer;padding:8px}
    .hero-btn-icon{width:52px;height:52px;border-radius:50%;border:1.5px solid rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center}
    .hero-btn:active .hero-btn-icon{background:rgba(255,255,255,.1);transform:scale(.95)}
    .hero-btn-icon svg{width:22px;height:22px;stroke:#fff;stroke-width:2;fill:none}
    .hero-btn span{font-size:11px;font-weight:500;color:rgba(255,255,255,.85)}
    .quick-actions{display:grid;grid-template-columns:repeat(4,1fr);padding:0 20px;margin-bottom:20px;gap:8px}
    .quick-btn{display:flex;flex-direction:column;align-items:center;gap:8px;background:none;border:none;cursor:pointer}
    .quick-btn:active{transform:scale(.95)}
    .quick-icon{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:transform .2s cubic-bezier(.34,1.56,.64,1),box-shadow .2s ease}
    .quick-icon svg{width:24px;height:24px;stroke-width:2;fill:none}
    .quick-icon.blue{background:var(--blue-bg);border:1.5px solid transparent}.quick-icon.blue svg{stroke:var(--blue)}
    .quick-icon.green{background:var(--green-bg);border:1.5px solid transparent}.quick-icon.green svg{stroke:var(--green)}
    .quick-icon.purple{background:var(--purple-bg);border:1.5px solid transparent}.quick-icon.purple svg{stroke:var(--purple)}
    .quick-icon.orange{background:var(--orange-bg);border:1.5px solid transparent}.quick-icon.orange svg{stroke:var(--orange)}
    .quick-btn span{font-size:12px;font-weight:500;color:var(--text2)}
    .quick-btn:hover .quick-icon{transform:scale(1.08)}

    /* (Quick icon dark overrides now in main dark theme block above) */
    /* Pro theme quick icons */
    [data-theme=pro] .quick-icon.blue{background:rgba(41,98,255,.12);border-color:rgba(41,98,255,.25)}
    [data-theme=pro] .quick-icon.green{background:rgba(38,166,154,.12);border-color:rgba(38,166,154,.25)}
    [data-theme=pro] .quick-icon.purple{background:rgba(124,77,255,.12);border-color:rgba(124,77,255,.25)}
    [data-theme=pro] .quick-icon.orange{background:rgba(255,152,0,.12);border-color:rgba(255,152,0,.25)}
    /* Luxury theme quick icons */
    [data-theme=luxury] .quick-icon.blue{background:rgba(201,169,98,.08);border-color:rgba(201,169,98,.15)}
    [data-theme=luxury] .quick-icon.green{background:rgba(201,169,98,.08);border-color:rgba(201,169,98,.15)}
    [data-theme=luxury] .quick-icon.purple{background:rgba(201,169,98,.08);border-color:rgba(201,169,98,.15)}
    [data-theme=luxury] .quick-icon.orange{background:rgba(201,169,98,.08);border-color:rgba(201,169,98,.15)}
    [data-theme=luxury] .quick-icon svg{stroke:#c9a962 !important}
    /* Retro theme quick icons */
    [data-theme=retro] .quick-icon.blue{background:rgba(92,200,232,.1);border-color:rgba(92,200,232,.25)}
    [data-theme=retro] .quick-icon.green{background:rgba(92,245,160,.1);border-color:rgba(92,245,160,.25)}
    [data-theme=retro] .quick-icon.purple{background:rgba(176,142,224,.1);border-color:rgba(176,142,224,.25)}
    [data-theme=retro] .quick-icon.orange{background:rgba(232,136,74,.1);border-color:rgba(232,136,74,.25)}
    .section{padding:0 16px;margin-bottom:24px}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .section-title{font-size:18px;font-weight:700}
    .section-link{font-size:13px;font-weight:600;color:var(--blue);background:none;border:none;cursor:pointer}
    .pos-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px;cursor:pointer;transition:transform .1s}
    .pos-card:active{transform:scale(.98)}
    .pos-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .pos-left{display:flex;align-items:center;gap:10px;min-width:0;flex:1}
    .pos-logo{width:34px;height:34px;border-radius:8px;background:var(--input);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0}
    .pos-logo img{width:100%;height:100%;object-fit:contain}
    .pos-logo-text{font-size:12px;font-weight:700;color:#fff;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#6366f1,#8b5cf6);border-radius:8px}
    .pos-info{min-width:0;flex:1}
    .pos-symbol{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pos-name{font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pos-badge{padding:3px 8px;border-radius:6px;font-size:10px;font-weight:700;flex-shrink:0;margin-left:8px}
    .pos-badge.csp{background:var(--green-bg);color:var(--green)}
    .pos-badge.cc{background:var(--blue-bg);color:var(--blue)}
    .pos-badge.shares{background:var(--purple-bg);color:var(--purple)}
    .pos-stats{display:flex;justify-content:space-between}
    .pos-stat-val{font-size:14px;font-weight:700}
    .pos-stat-val.pos{color:var(--green)}.pos-stat-val.neg{color:var(--red)}
    .pos-stat-label{font-size:11px;color:var(--text3);margin-top:2px}
    .tx-list{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .tx-item{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border)}
    .tx-item:last-child{border-bottom:none}
    .tx-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center}
    .tx-icon svg{width:18px;height:18px;stroke-width:2;fill:none}
    .tx-icon.csp{background:var(--green-bg)}.tx-icon.csp svg{stroke:var(--green)}
    .tx-icon.cc{background:var(--blue-bg)}.tx-icon.cc svg{stroke:var(--blue)}
    .tx-info{flex:1}.tx-title{font-size:15px;font-weight:600}.tx-sub{font-size:12px;color:var(--text3)}
    .tx-amount{font-size:15px;font-weight:700}
    .tx-amount.pos{color:var(--green)}.tx-amount.neg{color:var(--red)}
    .empty{text-align:center;padding:40px 20px;background:var(--card);border:1px solid var(--border);border-radius:16px}
    .empty-icon{width:56px;height:56px;margin:0 auto 12px;background:var(--input);border-radius:50%;display:flex;align-items:center;justify-content:center}
    .empty-icon svg{width:24px;height:24px;stroke:var(--text3);stroke-width:1.5;fill:none}
    .empty-title{font-size:16px;font-weight:600;margin-bottom:4px}
    .empty-text{font-size:13px;color:var(--text2);margin-bottom:16px}
    .empty-btn{padding:12px 24px;background:var(--hero);border:none;border-radius:12px;font-size:14px;font-weight:600;color:#fff;cursor:pointer}
    .nav{position:fixed;bottom:0;left:0;right:0;background:var(--nav-bg,var(--card));border-top:none;padding:0;z-index:100;box-shadow:0 -1px 8px rgba(0,0,0,.06)}
    .nav-inner{max-width:500px;margin:0 auto;display:flex}
    .nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;padding:8px 4px calc(8px + env(safe-area-inset-bottom,0px)) 4px;background:none;border:none;cursor:pointer;min-height:52px;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
    .nav-btn svg{width:24px;height:24px;stroke-width:1.75;fill:none}
    .nav-btn span{font-size:10px;font-weight:500}
    .nav-btn.active svg{stroke:var(--text)}.nav-btn.active span{color:var(--text);font-weight:600}
    .nav-btn:not(.active) svg{stroke:var(--text3)}.nav-btn:not(.active) span{color:var(--text3)}
    .tab{display:none}.tab.active{display:block}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius,16px);padding:20px;margin:0 16px 16px;box-shadow:var(--card-shadow,none)}

    /* ============================================
       PRO TRADER — Webull / TradingView feel
       Dense, data-forward, sharp, monospace numbers
       ============================================ */
    [data-theme=pro] body{font-family:'JetBrains Mono','SF Mono','Fira Code','Consolas',monospace;font-size:13px}
    [data-theme=pro] .app{max-width:480px}
    [data-theme=pro] .hero{border-radius:0;margin:0 0 0;padding:16px 16px 14px;background:linear-gradient(180deg,#131722 0%,#0a0e17 100%);border-bottom:none}
    [data-theme=pro] .hero::before{display:none}
    [data-theme=pro] .hero-top{margin-bottom:16px}
    [data-theme=pro] .balance-amount{font-size:32px;font-weight:700;font-family:'JetBrains Mono','SF Mono',monospace;letter-spacing:-0.5px}
    [data-theme=pro] .balance-label{font-size:11px;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.4)}
    [data-theme=pro] .balance-change{border-radius:3px;font-size:12px;padding:3px 8px;font-family:'SF Mono',monospace}
    [data-theme=pro] .hero-balance{margin-bottom:24px}
    [data-theme=pro] .hero-actions{gap:4px}
    [data-theme=pro] .quick-actions{gap:4px;padding:0 8px}
    [data-theme=pro] .hero-btn-icon{width:42px;height:42px;border-radius:6px;border:1px solid #2a2e39;background:rgba(41,98,255,.06)}
    [data-theme=pro] .hero-btn span{font-size:10px;text-transform:uppercase;letter-spacing:0.8px;color:rgba(255,255,255,.5)}
    [data-theme=pro] .card{border-radius:4px;padding:14px;margin:0 8px 8px;border:1px solid #2a2e39}
    [data-theme=pro] .card-title{font-size:11px;text-transform:uppercase;letter-spacing:1.5px;color:#787b86;font-weight:600}
    [data-theme=pro] .section{padding:0 8px;margin-bottom:8px}
    [data-theme=pro] .section-title{font-size:13px;text-transform:uppercase;letter-spacing:1.2px;font-weight:600;color:#787b86}
    [data-theme=pro] .pos-card{border-radius:4px;padding:12px;margin-bottom:6px;border:1px solid #2a2e39}
    [data-theme=pro] .pos-card:hover{border-color:#2962ff}
    [data-theme=pro] .pos-logo{border-radius:4px;width:36px;height:36px}
    [data-theme=pro] .pos-logo-text{border-radius:4px;font-size:11px}
    [data-theme=pro] .pos-symbol{font-size:14px;font-family:'SF Mono',monospace}
    [data-theme=pro] .pos-name{font-size:11px}
    [data-theme=pro] .pos-badge{border-radius:3px;font-size:10px;padding:3px 6px;letter-spacing:0.5px}
    [data-theme=pro] .pos-stat-val{font-size:13px;font-family:'SF Mono',monospace}
    [data-theme=pro] .pos-stat-label{font-size:10px;text-transform:uppercase;letter-spacing:0.5px}
    [data-theme=pro] .btn{border-radius:4px;text-transform:uppercase;letter-spacing:0.8px;font-size:12px;font-weight:600;padding:10px 16px;background:#2962ff}
    [data-theme=pro] .btn-outline{background:transparent;color:#2962ff;border:1px solid #2962ff}
    [data-theme=pro] .signal-card{border-radius:4px;padding:12px;border-width:2px}
    [data-theme=pro] .signal-ticker{font-family:'SF Mono',monospace;font-size:18px}
    [data-theme=pro] .signal-details{font-family:'SF Mono',monospace;font-size:12px}
    [data-theme=pro] .signal-type{border-radius:3px;font-size:10px;letter-spacing:1px;padding:3px 8px}
    [data-theme=pro] .nav{border-top:none;border-radius:0;background:rgba(10,14,23,.98);box-shadow:0 -1px 10px rgba(0,0,0,.4)}
    [data-theme=pro] .nav-btn{padding:8px 4px calc(8px + env(safe-area-inset-bottom,0px)) 4px;min-height:48px}
    [data-theme=pro] .nav-btn span{font-size:9px;text-transform:uppercase;letter-spacing:0.5px}
    [data-theme=pro] .toggle{border-radius:4px}
    [data-theme=pro] .toggle-btn{border-radius:3px;font-size:11px;text-transform:uppercase;letter-spacing:0.5px}
    [data-theme=pro] .toggle-btn.active{background:#2962ff}
    [data-theme=pro] .form-input{border-radius:4px;font-size:13px;padding:10px 12px}
    [data-theme=pro] .form-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#787b86}
    [data-theme=pro] .tx-list{border-radius:4px}
    [data-theme=pro] .tx-icon{border-radius:4px;width:32px;height:32px}
    [data-theme=pro] .tx-title{font-size:13px;font-family:'SF Mono',monospace}
    [data-theme=pro] .tx-amount{font-family:'SF Mono',monospace;font-size:13px}
    [data-theme=pro] .quick-icon{border-radius:6px;width:44px;height:44px}
    [data-theme=pro] .quick-btn span{font-size:10px;text-transform:uppercase;letter-spacing:0.5px}
    [data-theme=pro] .empty{border-radius:4px;padding:24px 16px}
    [data-theme=pro] .modal{border-radius:6px}
    [data-theme=pro] .switch{border-radius:4px;width:40px;height:22px}
    [data-theme=pro] .switch-knob{width:18px;height:18px;border-radius:3px}
    [data-theme=pro] .switch.on{background:#2962ff}
    [data-theme=pro] .switch.on .switch-knob{transform:translateX(18px)}
    [data-theme=pro] .chip-btn{border-radius:3px;font-family:'SF Mono',monospace;font-size:11px}
    [data-theme=pro] .copy-trade-btn{border-radius:3px;font-size:11px;text-transform:uppercase;letter-spacing:0.5px}
    [data-theme=pro] .chain-row{padding:8px 10px;font-family:'SF Mono',monospace;font-size:12px}
    [data-theme=pro] .chain-exp-btn{border-radius:3px;font-family:'SF Mono',monospace}
    [data-theme=pro] .home-alert-card{border-radius:4px}
    [data-theme=pro] .pos-card:hover{border-color:#2962ff;background:#161b27}
    [data-theme=pro] .stat-val{font-family:'JetBrains Mono','SF Mono',monospace}
    [data-theme=pro] .stat-box{border-radius:4px;border:1px solid #2a2e39;background:#131722}
    [data-theme=pro] .stat-label{text-transform:uppercase;letter-spacing:0.5px;font-size:10px}
    [data-theme=pro] .modal-title{font-size:14px;text-transform:uppercase;letter-spacing:1px;font-weight:600}
    [data-theme=pro] .ticker-btn{border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:11px;padding:6px 10px}
    [data-theme=pro] .empty{padding:16px}
    [data-theme=pro] .empty-title{font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
    [data-theme=pro] .search-input{font-family:'JetBrains Mono',monospace}
    [data-theme=pro] .form-select,[data-theme=pro] select{border-radius:4px;font-size:12px;color-scheme:dark}
    [data-theme=pro] select option{background:#131722;color:#d1d4dc}

    /* ============================================
       LUXURY FINTECH — Bloomberg meets high fashion
       Spacious, elegant, gold, thin borders
       ============================================ */
    [data-theme=luxury] select,[data-theme=luxury] .form-select{color-scheme:dark}
    [data-theme=luxury] select option{background:#16161a;color:#e8e6e3}
    [data-theme=luxury] body{font-family:'Inter',-apple-system,sans-serif;-webkit-font-smoothing:antialiased}
    [data-theme=luxury] .app{max-width:440px}
    [data-theme=luxury] *{transition:all .3s ease-out}
    [data-theme=luxury] .hero{border-radius:0;margin:0 0 8px;padding:28px 20px;background:linear-gradient(170deg,#1a1814 0%,#0c0c0f 100%);border-bottom:none}
    [data-theme=luxury] .hero::before{background:radial-gradient(circle,rgba(201,169,98,.04) 0%,transparent 70%)}
    [data-theme=luxury] .balance-amount{font-family:'Playfair Display',Georgia,serif;font-size:44px;font-weight:400;letter-spacing:-0.5px}
    [data-theme=luxury] .balance-label{font-size:11px;text-transform:uppercase;letter-spacing:3px;color:rgba(255,255,255,.35)}
    [data-theme=luxury] .balance-change{border-radius:4px;background:rgba(201,169,98,.1);color:#c9a962}
    [data-theme=luxury] .card{border-radius:2px;padding:24px;margin:0 20px 16px;border:0.5px solid #2a2925}
    [data-theme=luxury] .card-title{font-size:11px;text-transform:uppercase;letter-spacing:2.5px;color:#9b9792;font-weight:400}
    [data-theme=luxury] .section{padding:0 20px;margin-bottom:20px}
    [data-theme=luxury] .section-title{font-family:'Playfair Display',Georgia,serif;font-size:16px;text-transform:uppercase;letter-spacing:2px;font-weight:400;color:#9b9792}
    [data-theme=luxury] .section-link{color:#c9a962;font-weight:400;letter-spacing:0.5px}
    [data-theme=luxury] .pos-card{border-radius:2px;padding:18px;border:0.5px solid #2a2925}
    [data-theme=luxury] .pos-logo{border-radius:2px}
    [data-theme=luxury] .pos-logo-text{border-radius:2px;background:linear-gradient(135deg,#c9a962,#8b7355)}
    [data-theme=luxury] .pos-symbol{font-size:15px;font-weight:400;letter-spacing:0.5px}
    [data-theme=luxury] .pos-badge{border-radius:2px;font-weight:400;letter-spacing:1px}
    [data-theme=luxury] .pos-stat-val{font-weight:300;font-size:16px}
    [data-theme=luxury] .btn{border-radius:2px;background:linear-gradient(135deg,#c9a962 0%,#a8893e 100%);color:#0c0c0f;font-weight:500;letter-spacing:1.5px;text-transform:uppercase;font-size:12px;padding:14px 24px;transition:all .3s ease}
    [data-theme=luxury] .btn:hover{box-shadow:0 4px 20px rgba(201,169,98,.25)}
    [data-theme=luxury] .btn-outline{background:transparent;color:#c9a962;border:0.5px solid #c9a962}
    [data-theme=luxury] .signal-card{border-radius:2px;border-width:0.5px;padding:18px}
    [data-theme=luxury] .signal-ticker{font-family:'Playfair Display',Georgia,serif;font-weight:400;font-size:24px;letter-spacing:0.5px}
    [data-theme=luxury] .signal-type{border-radius:2px;font-weight:400;letter-spacing:1.5px}
    [data-theme=luxury] .nav{border-top:none;background:rgba(12,12,15,.98);box-shadow:0 -1px 12px rgba(0,0,0,.4)}
    [data-theme=luxury] .nav-btn span{letter-spacing:0.5px}
    [data-theme=luxury] .toggle{border-radius:2px}
    [data-theme=luxury] .toggle-btn{border-radius:2px;letter-spacing:1px;font-weight:400}
    [data-theme=luxury] .toggle-btn.active{background:#c9a962;color:#0c0c0f}
    [data-theme=luxury] .form-input{border-radius:2px;border-width:0.5px;border-color:#2a2925;padding:14px 16px}
    [data-theme=luxury] .form-label{text-transform:uppercase;letter-spacing:1.5px;font-size:10px;color:#9b9792;font-weight:400}
    [data-theme=luxury] .tx-list{border-radius:2px;border-width:0.5px}
    [data-theme=luxury] .quick-icon{border-radius:2px}
    [data-theme=luxury] .icon-btn{background:rgba(201,169,98,.08);border:1px solid rgba(201,169,98,.15)}
    [data-theme=luxury] .icon-btn svg{stroke:#c9a962}
    [data-theme=luxury] .avatar-btn{border-color:rgba(201,169,98,.3);background:linear-gradient(135deg,#c9a962,#8b7355)}
    [data-theme=luxury] .status{background:rgba(201,169,98,.08);border:1px solid rgba(201,169,98,.12)}
    [data-theme=luxury] .status-dot{background:#c9a962}
    [data-theme=luxury] .hero-btn-icon{border-radius:2px;border-color:rgba(201,169,98,.25);background:rgba(201,169,98,.08)}
    [data-theme=luxury] .hero-btn-icon svg{stroke:#c9a962}
    [data-theme=luxury] .hero-btn span{letter-spacing:1px;color:rgba(201,169,98,.6)}
    [data-theme=luxury] .empty{border-radius:2px;border-width:0.5px}
    [data-theme=luxury] .modal{border-radius:4px}
    [data-theme=luxury] .switch.on{background:linear-gradient(135deg,#c9a962,#a8893e)}
    [data-theme=luxury] .modal-title{font-family:'Playfair Display',Georgia,serif;font-weight:500;letter-spacing:0.5px}
    [data-theme=luxury] .balance-label{font-family:'Playfair Display',Georgia,serif}
    [data-theme=luxury] .hero-balance{margin-bottom:36px}
    [data-theme=luxury] .pos-card{transition:all .3s ease-out}
    [data-theme=luxury] .pos-card:hover{border-color:rgba(201,169,98,.3);box-shadow:0 4px 24px rgba(0,0,0,.3),0 0 1px rgba(201,169,98,.15)}
    [data-theme=luxury] .pos-stat-val{font-family:'Playfair Display',Georgia,serif;letter-spacing:0.3px}
    [data-theme=luxury] .stat-val{font-family:'Playfair Display',Georgia,serif}
    [data-theme=luxury] .copy-trade-btn{border-radius:2px;background:linear-gradient(135deg,#c9a962,#a8893e);color:#0c0c0f;letter-spacing:1px;transition:all .3s ease}
    [data-theme=luxury] .copy-trade-btn:hover{box-shadow:0 4px 16px rgba(201,169,98,.3)}
    [data-theme=luxury] .chip-btn{border-radius:2px;letter-spacing:1px;transition:all .3s ease}
    [data-theme=luxury] .chain-exp-btn{border-radius:2px;transition:all .3s ease}
    [data-theme=luxury] .auth-btn.primary{background:linear-gradient(135deg,#c9a962,#a8893e);color:#0c0c0f}
    [data-theme=luxury] .auth-btn.google{background:#1e1e24;border-color:#2a2925;border-radius:2px}
    [data-theme=luxury] .auth-btn.secondary{background:#1e1e24;border-color:#2a2925;border-radius:2px}
    [data-theme=luxury] .auth-container{background:#0c0c0f}
    [data-theme=luxury] .auth-welcome{font-family:'Playfair Display',Georgia,serif;font-weight:400}
    [data-theme=luxury] .float-input input{border-radius:2px;border-color:#2a2925}

    /* ============================================
       80s RETRO — Synthwave / Outrun
       Neon glow, scan lines, CRT feel, bold
       ============================================ */
    [data-theme=retro] body{font-family:'Orbitron','Space Grotesk','Inter',sans-serif}
    @keyframes retroFlicker{0%,100%{opacity:1}92%{opacity:1}93%{opacity:0.8}94%{opacity:1}96%{opacity:0.9}97%{opacity:1}}
    @keyframes retroGradient{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    @keyframes retroGlow{0%,100%{filter:drop-shadow(0 0 12px rgba(199,125,255,.2))}50%{filter:drop-shadow(0 0 20px rgba(255,45,111,.3))}}
    [data-theme=retro] .app::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.02) 3px,rgba(0,0,0,.02) 6px);pointer-events:none;z-index:9999}
    [data-theme=retro] .app::after{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse at center,transparent 70%,rgba(0,0,0,.15) 100%);pointer-events:none;z-index:9998}
    [data-theme=retro] .hero{border-radius:0;margin:0 0 0;padding:28px 16px 28px;background:linear-gradient(180deg,rgba(45,24,69,.6) 0%,rgba(26,16,37,.3) 60%,transparent 100%);border-bottom:none;box-shadow:none;position:relative}
    [data-theme=retro] .hero::before{background:radial-gradient(ellipse at 50% 0%,rgba(232,80,122,.1) 0%,rgba(176,142,224,.05) 40%,transparent 70%);pointer-events:none}
    [data-theme=retro] .hero::after{display:none}
    [data-theme=retro] .balance-amount{font-size:38px;font-weight:900;background:linear-gradient(180deg,#e8507a,#b08ee0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:none}
    [data-theme=retro] .balance-label{font-size:10px;text-transform:uppercase;letter-spacing:3px;color:#b08ee0}
    [data-theme=retro] .balance-change{border-radius:4px;border:1px solid rgba(0,255,135,.3);background:rgba(0,255,135,.08);box-shadow:0 0 12px rgba(0,255,135,.1)}
    [data-theme=retro] .hero-btn-icon{border-radius:8px;border:1.5px solid #b08ee0;box-shadow:0 0 10px rgba(199,125,255,.15);background:rgba(199,125,255,.06)}
    [data-theme=retro] .hero-btn span{color:#b08ee0;text-transform:uppercase;letter-spacing:1px;font-size:9px}
    [data-theme=retro] .card{border-radius:8px;border:1px solid #3d2a5c;box-shadow:0 0 15px rgba(199,125,255,.06),inset 0 1px 0 rgba(199,125,255,.06);padding:18px}
    [data-theme=retro] .card-title{text-transform:uppercase;letter-spacing:2px;font-size:12px;color:#b08ee0}
    [data-theme=retro] .section-title{text-transform:uppercase;letter-spacing:2px;font-size:14px;color:#b08ee0}
    [data-theme=retro] .section-link{color:#5cc8e8}
    [data-theme=retro] .pos-card{border-radius:8px;border:1px solid #3d2a5c;box-shadow:0 0 10px rgba(199,125,255,.04)}
    [data-theme=retro] .pos-card:hover{border-color:#b08ee0;box-shadow:0 0 20px rgba(199,125,255,.1)}
    [data-theme=retro] .pos-logo{border-radius:8px}
    [data-theme=retro] .pos-logo-text{border-radius:8px;background:linear-gradient(135deg,#e8507a,#b08ee0)}
    [data-theme=retro] .pos-symbol{color:#e8ddf5}
    [data-theme=retro] .pos-badge.csp{background:rgba(92,245,160,.08);color:#5cf5a0;border:1px solid rgba(92,245,160,.15)}
    [data-theme=retro] .pos-badge.cc{background:rgba(92,200,232,.08);color:#5cc8e8;border:1px solid rgba(92,200,232,.15)}
    [data-theme=retro] .btn{border-radius:6px;background:linear-gradient(135deg,#e8507a,#b08ee0);color:#fff;font-weight:700;text-transform:uppercase;letter-spacing:1px;border:none;transition:all .2s}
    [data-theme=retro] .btn:hover{box-shadow:0 4px 16px rgba(232,80,122,.2);transform:translateY(-1px)}
    [data-theme=retro] .btn-outline{background:transparent;color:#b08ee0;border:1.5px solid #b08ee0;box-shadow:none}
    [data-theme=retro] .signal-card{border-radius:8px;border:1px solid #3d2a5c;box-shadow:0 0 10px rgba(199,125,255,.04)}
    [data-theme=retro] .signal-ticker{font-size:20px;font-weight:900}
    [data-theme=retro] .signal-type.csp{background:rgba(92,245,160,.08);color:#5cf5a0;border:1px solid rgba(92,245,160,.15)}
    [data-theme=retro] .signal-type.cc{background:rgba(92,200,232,.08);color:#5cc8e8;border:1px solid rgba(92,200,232,.15)}
    [data-theme=retro] .nav{border-top:none;border-radius:0;background:rgba(26,16,37,.98);box-shadow:0 -1px 16px rgba(176,142,224,.1)}
    [data-theme=retro] .nav-btn.active svg{stroke:#e8507a}
    [data-theme=retro] .nav-btn.active span{color:#e8507a}
    [data-theme=retro] .toggle{border-radius:6px;border:1px solid #3d2a5c}
    [data-theme=retro] .toggle-btn{border-radius:4px}
    [data-theme=retro] .toggle-btn.active{background:linear-gradient(135deg,#e8507a,#b08ee0);color:#fff;box-shadow:0 0 12px rgba(255,45,111,.3)}
    [data-theme=retro] .form-input{border-radius:6px;border:1px solid #3d2a5c;background:#2e1d42}
    [data-theme=retro] .form-input:focus{border-color:#b08ee0;box-shadow:0 0 12px rgba(199,125,255,.15)}
    [data-theme=retro] .form-label{color:#b08ee0;text-transform:uppercase;letter-spacing:1.5px;font-size:10px}
    [data-theme=retro] .tx-list{border-radius:8px;border-color:#3d2a5c}
    [data-theme=retro] .tx-icon{border-radius:8px}
    [data-theme=retro] .quick-icon{border-radius:8px;box-shadow:0 0 10px rgba(199,125,255,.06)}
    [data-theme=retro] .quick-btn span{text-transform:uppercase;letter-spacing:1px;font-size:10px;color:#b89fda}
    [data-theme=retro] .empty{border-radius:8px;border-color:#3d2a5c}
    [data-theme=retro] .modal{border-radius:8px;border:1px solid #3d2a5c;box-shadow:0 0 40px rgba(199,125,255,.1)}
    [data-theme=retro] .switch{border-radius:6px}
    [data-theme=retro] .switch-knob{border-radius:4px}
    [data-theme=retro] .switch.on{background:linear-gradient(135deg,#e8507a,#b08ee0);box-shadow:0 0 10px rgba(255,45,111,.3)}
    [data-theme=retro] .copy-trade-btn{background:linear-gradient(135deg,#5cf5a0,#5cc8e8);color:#1a1025;border-radius:6px;font-weight:700}
    [data-theme=retro] .chip-btn{border-radius:6px;border-color:#3d2a5c;color:#b08ee0}
    [data-theme=retro] .chip-btn:hover,.chip-btn.active{background:linear-gradient(135deg,#e8507a,#b08ee0);color:#fff;border-color:transparent}
    [data-theme=retro] .chain-exp-btn{border-radius:6px;border-color:#3d2a5c;color:#b89fda}
    [data-theme=retro] .chain-exp-btn.active{background:linear-gradient(135deg,#e8507a,#b08ee0);color:#fff;border-color:transparent}
    [data-theme=retro] .home-alert-card{border-radius:8px;border-color:#3d2a5c}
    [data-theme=retro] .status{border:1px solid rgba(199,125,255,.2);background:rgba(199,125,255,.06)}
    [data-theme=retro] .stat-val{font-family:'Orbitron',monospace}
    [data-theme=retro] .stat-val.green{color:#5cf5a0}
    [data-theme=retro] .stat-val.blue{color:#5cc8e8}
    [data-theme=retro] .tx-title{font-family:'Space Grotesk','Inter',sans-serif}
    [data-theme=retro] .modal-title{font-family:'Orbitron','Inter',sans-serif}
    [data-theme=retro] .stat-box{border:1px solid #3d2a5c;box-shadow:0 0 8px rgba(199,125,255,.04)}
    [data-theme=retro] .ticker-btn{border-color:#3d2a5c;color:#b89fda}
    [data-theme=retro] .ticker-btn:active{background:linear-gradient(135deg,#e8507a,#b08ee0);color:#fff;border-color:transparent}
    [data-theme=retro] .pos-stat-val{font-family:'Orbitron',monospace;font-size:12px}
    [data-theme=retro] .form-select,[data-theme=retro] select{border-radius:6px;border:1px solid #3d2a5c;background:#2e1d42;color:#f0e6ff;color-scheme:dark}
    [data-theme=retro] select option{background:#2e1d42;color:#f0e6ff}

    /* ============================================
       FUN / PLAYFUL — Bouncy, colorful, friendly
       Big corners, gradients, emoji-friendly
       ============================================ */
    @keyframes funFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
    @keyframes funBlob1{0%,100%{border-radius:42% 58% 70% 30% / 45% 45% 55% 55%}25%{border-radius:30% 70% 42% 58% / 60% 40% 60% 40%}50%{border-radius:58% 42% 30% 70% / 50% 60% 40% 50%}75%{border-radius:70% 30% 58% 42% / 40% 55% 45% 60%}}
    [data-theme=fun] body{font-family:'Space Grotesk','Inter',sans-serif}
    [data-theme=fun] .hero{border-radius:28px;margin:8px 12px 20px;background:linear-gradient(135deg,#2d1b69 0%,#6366f1 50%,#a855f7 100%);padding:24px;box-shadow:0 8px 30px rgba(99,102,241,.2);position:relative;overflow:hidden}
    [data-theme=fun] .hero::before{background:radial-gradient(circle at 80% 20%,rgba(255,255,255,.15) 0%,transparent 50%);animation:funBlob1 8s ease-in-out infinite;width:200px;height:200px;top:-40px;right:-40px;border-radius:50%}
    [data-theme=fun] .balance-amount{font-size:42px;font-weight:800}
    [data-theme=fun] .balance-change{border-radius:20px}
    [data-theme=fun] .hero-btn-icon{border-radius:16px;border-color:rgba(255,255,255,.3);background:rgba(255,255,255,.1)}
    [data-theme=fun] .card{border-radius:20px;padding:20px;border-color:#ede3f7;box-shadow:0 2px 12px rgba(45,27,105,.04)}
    [data-theme=fun] .card-title{color:#6b5b95}
    [data-theme=fun] .section-title{color:#2d1b69}
    [data-theme=fun] .section-link{color:#6366f1}
    [data-theme=fun] .pos-card{border-radius:20px;border-color:#ede3f7;box-shadow:0 2px 8px rgba(45,27,105,.03);transition:all .25s cubic-bezier(.34,1.56,.64,1)}
    [data-theme=fun] .pos-card:hover{transform:rotate(-0.5deg) translateY(-3px);box-shadow:0 8px 24px rgba(45,27,105,.08)}
    [data-theme=fun] .pos-card:nth-child(even):hover{transform:rotate(0.5deg) translateY(-3px)}
    [data-theme=fun] .pos-logo{border-radius:14px}
    [data-theme=fun] .pos-logo-text{border-radius:14px;background:linear-gradient(135deg,#6366f1,#a855f7)}
    [data-theme=fun] .pos-badge{border-radius:12px;font-weight:700}
    [data-theme=fun] .btn{border-radius:24px;background:linear-gradient(135deg,#6366f1,#a855f7);font-weight:700;box-shadow:0 4px 15px rgba(99,102,241,.25);padding:14px 24px;transition:all .2s cubic-bezier(.34,1.56,.64,1)}
    [data-theme=fun] .btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(99,102,241,.35)}
    [data-theme=fun] .btn:active{transform:scale(.96)}
    [data-theme=fun] .btn-outline{border-radius:24px;border:2px solid #6366f1;color:#6366f1;background:transparent;box-shadow:none}
    [data-theme=fun] .signal-card{border-radius:20px;border-color:#ede3f7}
    [data-theme=fun] .signal-ticker{font-size:20px;font-weight:800}
    [data-theme=fun] .signal-type{border-radius:12px;font-weight:700}
    [data-theme=fun] .nav{border-radius:24px 24px 0 0;border-top:none;box-shadow:0 -4px 20px rgba(45,27,105,.06)}
    [data-theme=fun] .nav-btn.active svg{stroke:#6366f1}
    [data-theme=fun] .nav-btn.active span{color:#6366f1}
    [data-theme=fun] .toggle{border-radius:20px}
    [data-theme=fun] .toggle-btn{border-radius:16px}
    [data-theme=fun] .toggle-btn.active{background:linear-gradient(135deg,#6366f1,#a855f7);box-shadow:0 2px 8px rgba(99,102,241,.25)}
    [data-theme=fun] .form-input{border-radius:16px;border:2px solid #ede3f7;padding:14px 16px}
    [data-theme=fun] .form-input:focus{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,.15)}
    [data-theme=fun] .quick-icon{border-radius:16px;border-width:2px}
    [data-theme=fun] .quick-icon.blue{background:rgba(99,102,241,.15);border-color:rgba(99,102,241,.25)}
    [data-theme=fun] .quick-icon.green{background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.25)}
    [data-theme=fun] .quick-icon.purple{background:rgba(168,85,247,.15);border-color:rgba(168,85,247,.25)}
    [data-theme=fun] .quick-icon.orange{background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.25)}
    [data-theme=fun] .tx-list{border-radius:20px;border-color:#ede3f7}
    [data-theme=fun] .tx-icon{border-radius:14px}
    [data-theme=fun] .empty{border-radius:20px;border-color:#ede3f7}
    [data-theme=fun] .modal{border-radius:24px}
    [data-theme=fun] .switch{border-radius:20px}
    [data-theme=fun] .switch.on{background:linear-gradient(135deg,#6366f1,#a855f7)}
    [data-theme=fun] .copy-trade-btn{border-radius:16px;background:linear-gradient(135deg,#10b981,#06b6d4)}
    [data-theme=fun] .chip-btn{border-radius:16px;border-color:#ede3f7}
    [data-theme=fun] .chip-btn:hover,[data-theme=fun] .chip-btn.active{background:linear-gradient(135deg,#6366f1,#a855f7);color:#fff;border-color:transparent}
    [data-theme=fun] .chain-exp-btn{border-radius:16px}
    [data-theme=fun] .chain-exp-btn.active{background:linear-gradient(135deg,#6366f1,#a855f7);color:#fff}
    [data-theme=fun] .home-alert-card{border-radius:16px}
    [data-theme=fun] .card{transition:all .25s cubic-bezier(.34,1.56,.64,1)}
    [data-theme=fun] .card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(45,27,105,.06)}
    [data-theme=fun] .stat-box{border-radius:16px;border:2px solid #ede3f7;transition:all .25s cubic-bezier(.34,1.56,.64,1)}
    [data-theme=fun] .stat-box:hover{transform:scale(1.03);box-shadow:0 4px 16px rgba(99,102,241,.12)}
    [data-theme=fun] .stat-val{font-family:'Space Grotesk','Inter',sans-serif;font-weight:700}
    [data-theme=fun] .section-title{font-family:'Space Grotesk','Inter',sans-serif;font-weight:700}
    [data-theme=fun] .balance-amount{font-family:'Space Grotesk','Inter',sans-serif}
    [data-theme=fun] .modal-title{font-family:'Space Grotesk','Inter',sans-serif;font-weight:700}
    [data-theme=fun] .quick-icon{animation:funFloat 3s ease-in-out infinite}
    [data-theme=fun] .quick-icon:nth-child(1){animation-delay:0s}
    [data-theme=fun] .quick-btn:nth-child(2) .quick-icon{animation-delay:0.3s}
    [data-theme=fun] .quick-btn:nth-child(3) .quick-icon{animation-delay:0.6s}
    [data-theme=fun] .quick-btn:nth-child(4) .quick-icon{animation-delay:0.9s}
    [data-theme=fun] .ticker-btn{border-radius:20px;border-color:#ede3f7;transition:all .2s cubic-bezier(.34,1.56,.64,1)}
    [data-theme=fun] .ticker-btn:hover{transform:scale(1.05);border-color:#6366f1}
    [data-theme=fun] .empty-icon{animation:funFloat 3s ease-in-out infinite;border-radius:20px;background:linear-gradient(135deg,rgba(99,102,241,.1),rgba(168,85,247,.1))}

    /* ============================================
       CLEAN MINIMAL — Robinhood inspired
       White space, system font, green-only accent
       ============================================ */
    [data-theme=clean] body{font-family:-apple-system,'SF Pro Text','SF Pro Display','Inter',system-ui,sans-serif;-webkit-font-smoothing:antialiased}
    [data-theme=clean] .app{max-width:420px}
    [data-theme=clean] .hero{border-radius:0;margin:0 0 8px;padding:32px 20px 28px;background:#1a1a1d;box-shadow:none}
    [data-theme=clean] .hero::before{display:none}
    [data-theme=clean] .balance-amount{font-size:48px;font-weight:800;letter-spacing:-1.5px}
    [data-theme=clean] .balance-label{font-size:14px;font-weight:400;color:rgba(255,255,255,.55);letter-spacing:0}
    [data-theme=clean] .balance-change{border-radius:6px;background:rgba(0,200,5,.12);color:#00c805;font-weight:600;font-size:14px;padding:6px 12px}
    [data-theme=clean] .hero-balance{margin-bottom:36px}
    [data-theme=clean] .hero-actions{gap:0}
    [data-theme=clean] .hero-btn-icon{width:56px;height:56px;border-radius:50%;border:none;background:rgba(255,255,255,.08)}
    [data-theme=clean] .hero-btn span{font-size:12px;font-weight:500;color:rgba(255,255,255,.7);letter-spacing:0}
    [data-theme=clean] .card{border-radius:0;padding:20px;margin:0 0 1px;border:none;border-bottom:1px solid #e8e8eb;box-shadow:none}
    [data-theme=clean] .card-title{font-size:14px;text-transform:none;letter-spacing:0;color:#1a1a1d;font-weight:700}
    [data-theme=clean] .section{padding:0;margin-bottom:0}
    [data-theme=clean] .section-header{padding:0 20px;margin-bottom:8px;margin-top:20px}
    [data-theme=clean] .section-title{font-size:20px;font-weight:800;letter-spacing:-0.3px;text-transform:none;color:#1a1a1d}
    [data-theme=clean] .section-link{color:#00c805;font-weight:600}
    [data-theme=clean] .pos-card{border-radius:0;padding:16px 20px;margin-bottom:0;border:none;border-bottom:1px solid #e8e8eb}
    [data-theme=clean] .pos-card:active{transform:none;background:#f4f4f5}
    [data-theme=clean] .pos-logo{border-radius:50%;width:40px;height:40px}
    [data-theme=clean] .pos-logo-text{border-radius:50%;background:#1a1a1d}
    [data-theme=clean] .pos-symbol{font-size:16px;font-weight:700}
    [data-theme=clean] .pos-name{font-size:13px;color:#6b6f76}
    [data-theme=clean] .pos-badge{border-radius:4px;font-size:11px;font-weight:600;padding:4px 8px}
    [data-theme=clean] .pos-stat-val{font-size:16px;font-weight:700}
    [data-theme=clean] .btn{border-radius:24px;background:#00c805;font-size:16px;font-weight:700;padding:16px;letter-spacing:0;transition:opacity .15s}
    [data-theme=clean] .btn:hover{opacity:0.9}
    [data-theme=clean] .btn:active{opacity:0.8;transform:none}
    [data-theme=clean] .btn-outline{border-radius:24px;border:1.5px solid #e8e8eb;background:transparent;color:#1a1a1d}
    [data-theme=clean] .signal-card{border-radius:12px;padding:16px;border:1px solid #e8e8eb}
    [data-theme=clean] .signal-ticker{font-size:20px;font-weight:800}
    [data-theme=clean] .signal-type{border-radius:4px;font-weight:700}
    [data-theme=clean] .nav{border-top:none;border-radius:0;background:#fff;box-shadow:0 -1px 6px rgba(0,0,0,.04)}
    [data-theme=clean] .nav-btn{min-height:52px}
    [data-theme=clean] .nav-btn.active svg{stroke:#00c805}
    [data-theme=clean] .nav-btn.active span{color:#00c805;font-weight:700}
    [data-theme=clean] .nav-btn span{font-size:10px;letter-spacing:0}
    [data-theme=clean] .toggle{border-radius:8px;background:#f4f4f5;border:none}
    [data-theme=clean] .toggle-btn{border-radius:6px;font-weight:600}
    [data-theme=clean] .toggle-btn.active{background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.08);color:#1a1a1d}
    [data-theme=clean] .form-input{border-radius:8px;border:1px solid #e8e8eb;padding:14px 16px;font-size:16px}
    [data-theme=clean] .form-input:focus{border-color:#1a1a1d;box-shadow:none}
    [data-theme=clean] .form-label{font-size:14px;font-weight:600;color:#1a1a1d;text-transform:none;letter-spacing:0}
    [data-theme=clean] .tx-list{border-radius:0;border:none;border-top:1px solid #e8e8eb;border-bottom:1px solid #e8e8eb}
    [data-theme=clean] .tx-item{padding:16px 20px}
    [data-theme=clean] .tx-icon{border-radius:50%}
    [data-theme=clean] .quick-actions{padding:8px 20px;margin-bottom:16px}
    [data-theme=clean] .quick-icon{border-radius:50%;width:48px;height:48px;background:#f4f4f5}
    [data-theme=clean] .quick-icon.blue,.quick-icon.green,.quick-icon.purple,.quick-icon.orange{background:#f4f4f5}
    [data-theme=clean] .quick-icon svg{stroke:#1a1a1d !important}
    [data-theme=clean] .quick-btn span{font-size:12px;color:#6b6f76}
    [data-theme=clean] .empty{border-radius:0;border:none;border-top:1px solid #e8e8eb;border-bottom:1px solid #e8e8eb}
    [data-theme=clean] .modal{border-radius:16px 16px 0 0}
    [data-theme=clean] .switch{border-radius:16px}
    [data-theme=clean] .switch.on{background:#00c805}
    [data-theme=clean] .copy-trade-btn{border-radius:24px;background:#00c805}
    [data-theme=clean] .chip-btn{border-radius:8px}
    [data-theme=clean] .chip-btn:hover,[data-theme=clean] .chip-btn.active{background:#1a1a1d;color:#fff;border-color:#1a1a1d}
    [data-theme=clean] .chain-exp-btn{border-radius:8px}
    [data-theme=clean] .chain-exp-btn.active{background:#1a1a1d;color:#fff;border-color:#1a1a1d}
    [data-theme=clean] .home-alert-card{border-radius:0;border:none;border-bottom:1px solid #e8e8eb}
    [data-theme=clean] .status{background:rgba(0,200,5,.08);border-radius:6px}
    [data-theme=clean] .icon-btn{border-radius:50%;background:rgba(255,255,255,.12)}
    [data-theme=clean] .avatar-btn{border:2px solid rgba(255,255,255,.2);background:#00c805}

    .card-title{font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:16px}
    .form-group{margin-bottom:16px}
    .form-label{font-size:13px;font-weight:500;color:var(--text2);margin-bottom:8px;display:block}
    .form-input,.form-select{width:100%;background:var(--input);border:1px solid var(--border);border-radius:12px;padding:14px 16px;font-size:15px;color:var(--text);outline:none}
    .toggle{display:flex;background:var(--input);border-radius:10px;padding:4px;margin-bottom:16px}
    .toggle-btn{flex:1;padding:10px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;background:transparent;color:var(--text2)}
    .toggle-btn.active{background:var(--card);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .search-row{display:flex;gap:10px;margin-bottom:12px}
    .search-input{flex:1;background:var(--input);border:1px solid var(--border);border-radius:12px;padding:14px 16px;font-size:18px;font-weight:700;text-transform:uppercase;color:var(--text);outline:none}
    .search-btn{width:52px;height:52px;background:var(--hero);border:none;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .search-btn svg{width:22px;height:22px;stroke:#fff;stroke-width:2.5;fill:none}
    .help-btn{width:32px;height:32px;background:var(--blue-bg);border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .help-btn svg{width:16px;height:16px;stroke:var(--blue);stroke-width:2;fill:none}
    .tickers{display:flex;gap:8px;flex-wrap:wrap}
    .ticker-btn{padding:8px 14px;background:var(--input);border:1px solid var(--border);border-radius:20px;font-size:12px;font-weight:600;color:var(--text2);cursor:pointer}
    .ticker-btn:active{background:var(--hero);color:#fff}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .stat-box{background:var(--input);border-radius:12px;padding:16px;text-align:center}
    .stat-val{font-size:22px;font-weight:700}.stat-val.green{color:var(--green)}.stat-val.blue{color:var(--blue)}
    .stat-label{font-size:11px;color:var(--text2)}
    .btn{width:100%;padding:16px;background:var(--hero);border:none;border-radius:12px;font-size:15px;font-weight:600;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
    .btn svg{width:18px;height:18px;stroke:#fff;stroke-width:2;fill:none}
    .btn-outline{background:transparent;border:1.5px solid var(--border);color:var(--text)}.btn-outline svg{stroke:var(--text)}
    .btn-red{background:var(--red-bg);color:var(--red)}.btn-red svg{stroke:var(--red)}
    .chip-btn{background:var(--input);border:1px solid var(--border);border-radius:20px;padding:6px 14px;font-size:12px;font-weight:600;color:var(--text);cursor:pointer;transition:all .15s}
    .chip-btn:hover,.chip-btn.active{background:var(--blue);color:#fff;border-color:var(--blue)}
    .chain-row{display:flex;align-items:center;padding:8px 10px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;gap:4px;font-size:13px}
    .chain-row:hover{background:var(--input)}
    .chain-row:last-child{border-bottom:none}
    .chain-row.selected{background:var(--green-bg)}
    .chain-exp-btn{background:var(--input);border:1px solid var(--border);border-radius:16px;padding:5px 12px;font-size:11px;font-weight:600;white-space:nowrap;cursor:pointer;color:var(--text);transition:all .15s}
    .chain-exp-btn.active{background:var(--blue);color:#fff;border-color:var(--blue)}
    .copy-trade-btn{background:var(--green);color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px;margin-top:8px}
    .copy-trade-btn:active{opacity:0.8}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:none;align-items:flex-end;justify-content:center}
    .modal-bg.show{display:flex}.modal-bg.center{align-items:center}
    .modal{background:var(--card);border-radius:20px 20px 0 0;padding:20px;padding-bottom:max(20px,env(safe-area-inset-bottom));width:100%;max-width:430px;max-height:85vh;overflow-y:auto;animation:slideUp .3s ease}
    .modal-bg.center .modal{border-radius:20px;margin:20px}
    @keyframes slideUp{from{transform:translateY(100%)}}
    .modal-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-title{font-size:18px;font-weight:700}
    .modal-close{width:32px;height:32px;background:var(--input);border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .modal-close svg{width:16px;height:16px;stroke:var(--text2);stroke-width:2;fill:none}
    .learn-modal{max-height:92vh;max-width:600px}
    .learn-content{padding-bottom:20px}
    .learn-module{background:var(--input);border-radius:16px;padding:16px;margin-bottom:12px;cursor:pointer;transition:transform .2s}
    .learn-module:hover{transform:translateY(-2px)}
    .learn-module-icon{width:50px;height:50px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px}
    .learn-module-info{flex:1;margin-left:14px}
    .learn-module-title{font-weight:700;font-size:16px;margin-bottom:4px}
    .learn-module-desc{font-size:13px;color:var(--text2)}
    .learn-module-meta{display:flex;gap:12px;margin-top:8px}
    .learn-module-meta span{font-size:11px;color:var(--text3);background:var(--card);padding:4px 8px;border-radius:6px}
    .learn-chapter{background:var(--input);border-radius:12px;padding:14px;margin-bottom:10px;cursor:pointer;display:flex;align-items:center;gap:12px}
    .learn-chapter:hover{background:var(--border)}
    .learn-chapter-num{width:32px;height:32px;border-radius:50%;background:var(--card);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:var(--text2)}
    .learn-chapter-num.completed{background:var(--green);color:#fff}
    .learn-chapter-title{flex:1;font-size:14px;font-weight:500}
    .learn-chapter-dur{font-size:12px;color:var(--text3)}
    .lesson-content{font-size:15px;line-height:1.8;color:var(--text)}
    .lesson-content h2{font-size:22px;font-weight:700;margin:24px 0 12px;color:var(--text)}
    .lesson-content h3{font-size:18px;font-weight:600;margin:20px 0 10px;color:var(--text)}
    .lesson-content p{margin-bottom:16px}
    .lesson-content ul,.lesson-content ol{margin:16px 0;padding-left:24px}
    .lesson-content li{margin-bottom:8px}
    .lesson-content strong{color:var(--text);font-weight:600}
    .lesson-video{width:100%;aspect-ratio:16/9;border-radius:12px;background:#000;margin:20px 0 8px 0;overflow:hidden}
    .lesson-video iframe{width:100%;height:100%;border:none}
    .video-credit{font-size:12px;color:var(--text3);margin-bottom:16px;text-align:right}
    .video-credit a{color:var(--text3);text-decoration:underline}
    .lesson-img{width:100%;border-radius:12px;margin:20px 0}
    .lesson-callout{background:var(--input);border-left:4px solid var(--blue);padding:16px;border-radius:0 12px 12px 0;margin:20px 0}
    .lesson-callout.warning{border-color:var(--orange);background:var(--orange-bg)}
    .lesson-callout.success{border-color:var(--green);background:var(--green-bg)}
    .lesson-callout-title{font-weight:700;margin-bottom:6px}
    .quiz-container{background:var(--input);border-radius:16px;padding:20px;margin-top:24px}
    .quiz-question{font-size:16px;font-weight:600;margin-bottom:16px}
    .quiz-option{display:block;width:100%;text-align:left;padding:14px 16px;background:var(--card);border:2px solid var(--border);border-radius:12px;margin-bottom:10px;cursor:pointer;font-size:14px;transition:all .2s}
    .quiz-option:hover{border-color:var(--text3)}
    .quiz-option.selected{border-color:var(--blue);background:var(--blue-bg)}
    .quiz-option.correct{border-color:var(--green);background:var(--green-bg)}
    .quiz-option.incorrect{border-color:var(--red);background:var(--red-bg)}
    .callout{background:var(--input);border-left:4px solid var(--blue);padding:16px;border-radius:0 12px 12px 0;margin:20px 0}
    .callout.blue{border-color:var(--blue);background:var(--blue-bg)}
    .callout.green{border-color:var(--green);background:var(--green-bg)}
    .callout.orange{border-color:var(--orange);background:var(--orange-bg)}
    .callout.red{border-color:var(--red);background:var(--red-bg)}
    .callout.purple{border-color:var(--purple);background:var(--purple-bg)}
    .quiz-result{text-align:center;padding:20px;margin-top:16px;border-radius:12px}
    .quiz-result.passed{background:var(--green-bg);color:var(--green)}
    .quiz-result.failed{background:var(--red-bg);color:var(--red)}
    .progress-bar{height:6px;background:var(--border);border-radius:3px;margin:12px 0;overflow:hidden}
    .progress-bar-fill{height:100%;background:var(--green);border-radius:3px;transition:width .3s}
    .setting-row{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid var(--border)}
    .setting-row:last-child{border-bottom:none}
    .switch{width:50px;height:28px;background:var(--input);border-radius:14px;padding:2px;border:none;cursor:pointer}
    .switch.on{background:var(--green)}
    .switch-knob{width:24px;height:24px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
    .switch.on .switch-knob{transform:translateX(22px)}
    .profile-header{text-align:center;padding:20px 0}
    .profile-avatar{width:100px;height:100px;border-radius:50%;margin:0 auto 16px;background:linear-gradient(135deg,#f97316,#dc2626);display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer}
    .profile-avatar span{color:#fff;font-size:36px;font-weight:700}
    .profile-avatar-edit{position:absolute;bottom:0;right:0;width:32px;height:32px;background:var(--blue);border-radius:50%;display:flex;align-items:center;justify-content:center}
    .profile-avatar-edit svg{width:16px;height:16px;stroke:#fff;stroke-width:2;fill:none}
    .profile-name{font-size:24px;font-weight:700}
    .profile-email{font-size:14px;color:var(--text2);margin-bottom:16px}
    .profile-badge{display:inline-flex;padding:8px 16px;background:var(--text);border-radius:20px;font-size:13px;font-weight:600;color:var(--bg)}
    .profile-stats{display:flex;justify-content:space-around;padding:20px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border);margin:20px 0}
    .profile-stat{text-align:center}.profile-stat-val{font-size:20px;font-weight:700}.profile-stat-label{font-size:12px;color:var(--text2)}
    .signal-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px;position:relative}
    .signal-card.locked::after{content:'';position:absolute;inset:0;background:var(--bg);opacity:.85;border-radius:16px}
    .signal-header{display:flex;justify-content:space-between;margin-bottom:12px}
    .signal-type{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700}
    .signal-type.csp{background:var(--green-bg);color:var(--green)}
    .signal-type.cc{background:var(--blue-bg);color:var(--blue)}
    .signal-time{font-size:12px;color:var(--text3)}
    .signal-ticker{font-size:20px;font-weight:700}
    .signal-details{font-size:14px;color:var(--text2);margin:4px 0 12px}
    .signal-lock{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1}
    .signal-lock svg{width:24px;height:24px;stroke:var(--text3);stroke-width:1.5;margin-bottom:6px}
    .signal-lock span{font-weight:500;color:var(--text2);font-size:13px}
    .wheely-avatar{width:48px;height:48px;background:linear-gradient(145deg,#6366f1,#4f46e5);border-radius:14px;position:relative;display:flex;align-items:center;justify-content:center}
    .wheely-face{width:36px;height:20px;background:#fff;border-radius:6px;display:flex;align-items:center;justify-content:center;gap:10px}
    .wheely-eye{width:6px;height:8px;background:#4f46e5;border-radius:2px;animation:blink 3s infinite}
    @keyframes blink{0%,94%,100%{transform:scaleY(1)}96%{transform:scaleY(.1)}}
    .wheely-antenna{position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:3px;height:8px;background:#6366f1;border-radius:2px}
    .wheely-antenna::after{content:'';position:absolute;top:-5px;left:50%;transform:translateX(-50%);width:8px;height:8px;background:#a5b4fc;border-radius:50%}
    .ai-header{display:flex;align-items:center;gap:12px;margin-bottom:20px}
    .ai-info h3{font-size:16px;font-weight:700}.ai-info p{font-size:12px;color:var(--text2)}
    .ai-messages{min-height:200px;max-height:300px;overflow-y:auto;margin-bottom:16px}
    .ai-msg{padding:12px;border-radius:12px;margin-bottom:8px;font-size:14px;line-height:1.5;max-width:85%}
    .ai-msg.user{background:var(--blue);color:#fff;margin-left:auto}
    .ai-msg.bot{background:var(--input)}
    .legal-content{font-size:13px;line-height:1.7;color:var(--text2);max-height:50vh;overflow-y:auto;margin-bottom:20px;padding:16px;background:var(--input);border-radius:12px}
    .legal-content h3{color:var(--text);margin:16px 0 8px;font-size:14px}
    .legal-content h3:first-child{margin-top:0}
    .legal-checkbox{display:flex;align-items:flex-start;gap:12px;margin-bottom:20px}
    .legal-checkbox input{width:20px;height:20px;margin-top:2px;accent-color:var(--blue)}
    .legal-checkbox label{font-size:13px;color:var(--text2)}
    .footer{padding:20px 16px;text-align:center;font-size:11px;color:var(--text3)}
    .footer a{color:var(--text2);margin:0 8px}
    .loading{display:flex;justify-content:center;padding:40px}
    .spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none!important}
    .mt-4{margin-top:16px}
    .live-dot{display:inline-block;width:8px;height:8px;background:var(--green);border-radius:50%;margin-right:6px;animation:pulse 2s infinite}
    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 24px;font-size:14px;font-weight:500;box-shadow:0 4px 20px rgba(0,0,0,.3);z-index:300;opacity:0;visibility:hidden;pointer-events:none;transition:opacity .3s ease,transform .3s ease,visibility .3s}
    .toast.show{opacity:1;visibility:visible;pointer-events:auto}
    .toast.success{border-color:var(--green);background:var(--green-bg);color:var(--green)}
    .toast.error{border-color:var(--red);background:var(--red-bg);color:var(--red)}
    .confetti{position:fixed;width:10px;height:10px;z-index:400;animation:fall linear forwards}
    @keyframes fall{to{transform:translateY(100vh) rotate(720deg);opacity:0}}
    .celebration-overlay{position:fixed;inset:0;z-index:350;pointer-events:none;display:flex;align-items:center;justify-content:center}
    .celebration-text{font-size:48px;font-weight:800;color:var(--green);text-shadow:0 4px 20px rgba(52,199,89,.5);animation:celebratePop .6s ease-out}
    @keyframes celebratePop{0%{transform:scale(0);opacity:0}50%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}
    @keyframes shimmerSweep{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .post-actions{display:flex;gap:6px;margin-top:8px}
    .post-action-btn{padding:4px 10px;border:none;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer}
    .post-action-btn.winner{background:var(--green-bg);color:var(--green)}
    .post-action-btn.roll{background:var(--purple-bg);color:var(--purple)}
    .post-action-btn.delete{background:var(--red-bg);color:var(--red)}
    .status-badge{padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700;margin-left:6px}
    .status-badge.open{background:var(--blue-bg);color:var(--blue)}
    .status-badge.winner{background:var(--green-bg);color:var(--green)}
    .status-badge.rolled{background:var(--purple-bg);color:var(--purple)}
    .status-badge.closed{background:var(--text3);color:var(--bg)}
    .position-select{width:100%;background:var(--input);border:1px solid var(--border);border-radius:12px;padding:14px 16px;font-size:15px;color:var(--text);outline:none;cursor:pointer}
    .auth-container{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:0;background:var(--bg)}
    .auth-container > div{width:100%;max-width:420px;min-height:100vh;display:flex;flex-direction:column;background:var(--bg)}
    @media(min-width:600px){
      .auth-container{background:var(--bg)}
      .auth-container > div{min-height:auto;background:var(--card);border-radius:24px;box-shadow:0 8px 32px rgba(0,0,0,0.08);margin:40px 20px;padding-bottom:0}
      .auth-content{padding:32px 40px 24px}
      .auth-terms{padding:20px 40px}
      .auth-switch{padding:16px 40px 32px}
    }
    .auth-header{padding:40px 24px 0;display:flex;flex-direction:column;align-items:center;gap:6px}
    @media(min-width:600px){.auth-header{padding:40px 40px 0}}
    .auth-logo-img{height:40px;width:auto}
    .auth-back{width:40px;height:40px;border:none;background:none;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .auth-back svg{width:24px;height:24px;stroke:var(--text);stroke-width:2;fill:none}
    .auth-page-title{font-size:13px;font-weight:600;color:var(--text3);letter-spacing:1px;text-transform:uppercase}
    .auth-content{flex:1;padding:20px 24px}
    .auth-welcome{font-size:26px;font-weight:700;color:var(--text);margin-bottom:6px;text-align:center}
    @media(min-width:600px){.auth-welcome{font-size:30px}}
    .auth-subtitle{font-size:14px;color:var(--text2);margin-bottom:28px;line-height:1.5;text-align:center}
    @media(min-width:600px){.auth-subtitle{font-size:15px}}
    .float-input{position:relative;margin-bottom:20px}
    .float-input input{width:100%;padding:20px 16px 8px;font-size:16px;border:2px solid var(--border);border-radius:12px;background:var(--card);color:var(--text);outline:none;transition:all .2s;box-sizing:border-box}
    .float-input input:focus{border-color:var(--text);box-shadow:0 0 0 4px rgba(0,0,0,0.04)}
    .float-input input:hover:not(:focus){border-color:var(--text3)}
    .float-input label{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:16px;color:var(--text3);pointer-events:none;transition:all .2s}
    .float-input input:focus+label,.float-input input:not(:placeholder-shown)+label{top:12px;transform:translateY(0);font-size:11px;color:var(--text2);font-weight:500}
    .float-input .toggle-pass{position:absolute;right:16px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px}
    .float-input .toggle-pass svg{width:20px;height:20px;stroke:var(--text3);stroke-width:1.5;fill:none}
    .pass-requirements{margin-bottom:24px}
    .pass-requirements p{font-size:13px;color:var(--text2);margin-bottom:12px;font-weight:500}
    .pass-checks{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .pass-check{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text3)}
    .pass-check .check-circle{width:18px;height:18px;border:1.5px solid #ddd;border-radius:50%;display:flex;align-items:center;justify-content:center}
    .pass-check.valid{color:var(--text)}
    .pass-check.valid .check-circle{background:var(--green);border-color:var(--green)}
    .pass-check.valid .check-circle::after{content:'✓';color:#fff;font-size:10px}
    .auth-btn{width:100%;padding:16px;font-size:16px;font-weight:600;border:none;border-radius:12px;cursor:pointer;transition:all .2s}
    .auth-btn.primary{background:var(--text);color:var(--bg)}
    .auth-btn.primary:hover{opacity:0.85;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
    .auth-btn.primary:active{transform:translateY(0);box-shadow:none}
    .auth-btn.primary:disabled{background:var(--border);color:var(--text3);cursor:not-allowed;transform:none;box-shadow:none}
    .auth-btn.secondary{background:var(--card);color:var(--text);border:2px solid var(--border)}
    .auth-btn.secondary:hover{border-color:var(--text);background:var(--input)}
    .auth-btn.google{background:var(--card);color:var(--text);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:12px}
    .auth-btn.google:hover{border-color:var(--blue);background:var(--input)}
    .auth-btn.google svg{flex-shrink:0}
    .auth-terms{font-size:12px;color:var(--text3);text-align:center;margin-top:auto;padding:24px;line-height:1.6}
    .auth-terms a{color:var(--text);text-decoration:underline}
    .auth-switch{text-align:center;padding:20px;font-size:14px;color:var(--text2);border-top:1px solid var(--border)}
    @media(min-width:600px){.auth-switch{background:var(--input);border-radius:0 0 24px 24px}}
    .auth-switch a{color:var(--text);font-weight:600;text-decoration:none}
    .auth-switch a:hover{text-decoration:underline}
    .auth-divider{display:flex;align-items:center;gap:12px;margin:24px 0;color:var(--text3);font-size:13px}
    .auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border)}
    .confirm-modal{background:var(--bg);border:1px solid var(--border);border-radius:20px;padding:24px;max-width:320px;margin:20px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.3)}
    .confirm-title{font-size:18px;font-weight:700;color:var(--text);margin-bottom:8px}
    .confirm-message{font-size:14px;color:var(--text2);margin-bottom:24px;line-height:1.5}
    .confirm-buttons{display:flex;gap:12px}
    .premium-modal{background:var(--card);border-radius:24px;padding:32px 24px;text-align:center;max-width:340px;margin:20px}
    .premium-modal-icon{font-size:80px;margin-bottom:16px}
    .premium-modal h2{font-size:24px;font-weight:700;margin-bottom:12px;color:var(--text)}
    .premium-modal p{font-size:15px;color:var(--text2);line-height:1.5;margin-bottom:24px}
    .premium-modal .float-input{text-align:left}
    .premium-features{text-align:left;margin:20px 0}
    .premium-feature{display:flex;align-items:center;gap:12px;padding:10px 0;font-size:14px;color:var(--text)}
    .premium-feature svg{width:20px;height:20px;stroke:#22c55e;stroke-width:2.5;fill:none}
    .status-badge.assigned{background:var(--orange-bg);color:var(--orange)}
    .status-badge.called{background:var(--blue-bg);color:var(--blue)}
    .post-action-btn.assigned{background:var(--orange-bg);color:var(--orange)}
    .post-action-btn.called{background:var(--blue-bg);color:var(--blue)}
    .home-alerts{margin-top:16px}
    .home-alert-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:12px}
    .home-alert-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
    .home-alert-content{flex:1}
    .home-alert-title{font-size:13px;font-weight:600}
    .home-alert-sub{font-size:11px;color:var(--text2)}

    /* === INCOME GOAL PROGRESS === */
    .goal-bar-wrap{margin:0 16px 20px;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;cursor:pointer}
    .goal-bar-wrap:active{transform:scale(.98)}
    .goal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .goal-label{font-size:13px;font-weight:600;color:var(--text2)}
    .goal-amount{font-size:13px;font-weight:700}
    .goal-track{height:10px;background:var(--input);border-radius:5px;overflow:hidden;position:relative}
    .goal-fill{height:100%;border-radius:5px;background:linear-gradient(90deg,var(--green),var(--blue));transition:width .6s ease}
    .goal-streak{display:flex;align-items:center;gap:4px;margin-top:8px;font-size:11px;color:var(--text3)}

    /* === SCREENER === */
    .screener-filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
    .screener-card{background:var(--input);border:1px solid transparent;border-radius:12px;padding:14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:all .15s}
    .screener-card:hover{background:var(--card);border-color:var(--green)}
    .screener-left{display:flex;align-items:center;gap:12px}
    .screener-logo{width:40px;height:40px;border-radius:10px;background:var(--card);display:flex;align-items:center;justify-content:center;overflow:hidden}
    .screener-logo img{width:100%;height:100%;object-fit:cover}
    .screener-sym{font-size:15px;font-weight:700}
    .screener-name{font-size:11px;color:var(--text3)}
    .screener-metrics{text-align:right}
    .screener-price{font-size:15px;font-weight:700}
    .screener-yield{font-size:12px;font-weight:600;color:var(--green)}
    .screener-loading{text-align:center;padding:40px;color:var(--text3)}

    /* === EARNINGS CALENDAR === */
    .earn-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
    .earn-item:last-child{border-bottom:none}
    .earn-date{min-width:56px;text-align:center;background:var(--input);border-radius:10px;padding:8px 6px}
    .earn-month{font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase}
    .earn-day{font-size:18px;font-weight:800}
    .earn-info{flex:1}
    .earn-sym{font-size:14px;font-weight:700}
    .earn-timing{font-size:11px;color:var(--text3)}
    .earn-countdown{font-size:12px;font-weight:600;padding:4px 10px;border-radius:8px}
    .earn-countdown.soon{background:var(--red-bg);color:var(--red)}
    .earn-countdown.upcoming{background:var(--orange-bg);color:var(--orange)}
    .earn-countdown.later{background:var(--input);color:var(--text3)}

    /* === BACKTEST === */
    .bt-result{background:var(--input);border-radius:12px;padding:16px;margin-bottom:12px}
    .bt-big{font-size:28px;font-weight:800;text-align:center;margin:8px 0}
    .bt-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px}
    .bt-row:last-child{border-bottom:none}
    .bt-row span:last-child{font-weight:600}

    /* === LEADERBOARD === */
    .lb-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
    .lb-item:last-child{border-bottom:none}
    .lb-rank{min-width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px}
    .lb-rank.gold{background:linear-gradient(135deg,#ffd700,#ffb800);color:#000}
    .lb-rank.silver{background:linear-gradient(135deg,#c0c0c0,#a0a0a0);color:#000}
    .lb-rank.bronze{background:linear-gradient(135deg,#cd7f32,#b8690e);color:#fff}
    .lb-rank.normal{background:var(--input);color:var(--text2)}
    .lb-info{flex:1}
    .lb-name{font-size:14px;font-weight:600}
    .lb-stats{font-size:11px;color:var(--text3)}
    .lb-val{text-align:right;font-size:15px;font-weight:700;color:var(--green)}
    .badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:8px;font-size:10px;font-weight:700;background:var(--input);color:var(--text2)}
    .badge.gold{background:rgba(255,215,0,.15);color:#ffd700}
    .badge-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}

    /* === DTE WARNING BADGE === */
    .dte-warn{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:700;letter-spacing:0.3px;vertical-align:middle;margin-left:6px;animation:pulse 2s infinite}
    .dte-warn.danger{background:var(--red-bg);color:var(--red)}
    .dte-warn.caution{background:var(--orange-bg);color:var(--orange)}
    .dte-warn.earnings{background:var(--purple-bg);color:var(--purple)}

    /* === ROLL SUGGESTION === */
    .roll-card{background:var(--input);border-radius:12px;padding:14px;margin-bottom:10px;cursor:pointer;border:1px solid transparent;transition:all .15s}
    .roll-card:hover{border-color:var(--blue)}
    .roll-label{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
    .roll-desc{font-size:14px;font-weight:600;margin-bottom:4px}
    .roll-detail{font-size:12px;color:var(--text2)}

    /* === P&L CHART === */
    .pnl-chart-wrap{background:var(--input);border-radius:12px;padding:16px;margin-bottom:16px}
    .pnl-chart-title{font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px}
    .pnl-canvas{width:100%;height:160px;border-radius:8px}
    .monthly-bar{display:flex;align-items:flex-end;gap:4px;height:100px;padding:0 4px}
    .month-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
    .month-bar{width:100%;min-height:2px;border-radius:4px 4px 0 0;background:var(--green);transition:height .4s ease}
    .month-label{font-size:9px;color:var(--text3);white-space:nowrap}
    .month-val{font-size:9px;font-weight:600;color:var(--green)}
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div class="auth-container" id="authScreen">
    <div id="authLogin">
      <div class="auth-header">
        <img src="logo.png" alt="Market Elites" class="auth-logo-img" onerror="this.style.display='none'">
        <span class="auth-page-title">Market Elites</span>
      </div>
      <div class="auth-content">
        <div class="auth-welcome">Welcome back</div>
        <div class="auth-subtitle">Track your wheel strategy, get live signals, and learn to generate consistent income from options.</div>

        <div class="float-input">
          <input type="email" id="loginEmail" placeholder=" " autocomplete="email">
          <label>Email</label>
        </div>

        <div class="float-input">
          <input type="password" id="loginPassword" placeholder=" " autocomplete="current-password">
          <label>Password</label>
          <button class="toggle-pass" onclick="togglePasswordVisibility('loginPassword', this)">
            <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text2);cursor:pointer">
            <input type="checkbox" id="rememberMe" style="width:18px;height:18px;accent-color:var(--text);cursor:pointer">
            Remember me
          </label>
          <a href="#" onclick="showForgotPassword();return false" style="font-size:13px;color:var(--text);font-weight:500;text-decoration:none">Forgot password?</a>
        </div>

        <button class="auth-btn primary" onclick="handleLogin()">Sign In</button>

        <div class="auth-divider">or</div>

        <button class="auth-btn google" onclick="handleGoogleSignIn()">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Continue with Google
        </button>

        <button class="auth-btn google" onclick="handleAppleSignIn()" style="background:var(--card);color:var(--text);border-color:var(--border)">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/></svg>
          Continue with Apple
        </button>

        <button class="auth-btn secondary" onclick="handleGuestLogin()">Continue as Guest</button>
      </div>
      <div class="auth-terms">
        By continuing, you agree to Market Elites'<br><a href="#" onclick="openModal('legalModal');return false">Terms of Use</a> and <a href="#" onclick="openModal('privacyModal');return false">Privacy Policy</a>.
      </div>
      <div class="auth-switch">Don't have an account? <a href="#" onclick="showAuthTab('signup');return false">Sign up</a></div>
    </div>

    <div id="authSignup" class="hidden">
      <div class="auth-header">
        <button class="auth-back" onclick="showAuthTab('login')">
          <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </button>
        <span class="auth-page-title">Create Account</span>
      </div>
      <div class="auth-content">
        <div class="float-input">
          <input type="text" id="signupName" placeholder=" " autocomplete="name">
          <label>Full Name</label>
        </div>

        <div class="float-input">
          <input type="email" id="signupEmail" placeholder=" " autocomplete="email">
          <label>Email</label>
        </div>

        <div class="float-input">
          <input type="password" id="signupPassword" placeholder=" " autocomplete="new-password" oninput="checkPasswordStrength()">
          <label>Password</label>
          <button class="toggle-pass" onclick="togglePasswordVisibility('signupPassword', this)">
            <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>

        <div class="pass-requirements">
          <p>Password must contain:</p>
          <div class="pass-checks">
            <div class="pass-check" id="passLength"><span class="check-circle"></span>8+ characters</div>
            <div class="pass-check" id="passNumber"><span class="check-circle"></span>Number</div>
            <div class="pass-check" id="passLower"><span class="check-circle"></span>Lowercase letter</div>
            <div class="pass-check" id="passSpecial"><span class="check-circle"></span>Special character</div>
            <div class="pass-check" id="passUpper"><span class="check-circle"></span>Uppercase letter</div>
          </div>
        </div>

        <button class="auth-btn primary" id="signupBtn" onclick="handleSignup()" disabled>Create Account</button>

        <div class="auth-divider">or</div>

        <button class="auth-btn google" onclick="handleGoogleSignIn()">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Sign up with Google
        </button>

        <button class="auth-btn google" onclick="handleAppleSignIn()" style="background:var(--card);color:var(--text);border-color:var(--border)">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/></svg>
          Sign up with Apple
        </button>
      </div>
      <div class="auth-terms">
        By creating an account, you agree to Market Elites'<br><a href="#" onclick="openModal('legalModal');return false">Terms of Use</a> and <a href="#" onclick="openModal('privacyModal');return false">Privacy Policy</a>.
      </div>
      <div class="auth-switch">Already have an account? <a href="#" onclick="showAuthTab('login');return false">Sign in</a></div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-bg center" id="confirmModal" style="z-index:250" onclick="closeModal('confirmModal')">
    <div class="confirm-modal" onclick="event.stopPropagation()">
      <div class="confirm-title" id="confirmTitle">Are you sure?</div>
      <div class="confirm-message" id="confirmMessage">This action cannot be undone.</div>
      <div class="confirm-buttons">
        <button class="btn btn-outline" onclick="closeModal('confirmModal')" style="flex:1">Cancel</button>
        <button class="btn" id="confirmAction" onclick="closeModal('confirmModal')" style="flex:1">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Premium Popup Modal -->
  <div class="modal-bg center" id="premiumPopup" onclick="closeModal('premiumPopup')">
    <div class="premium-modal" onclick="event.stopPropagation()">
      <div class="premium-modal-icon">🔔📈</div>
      <h2>Never miss a trade</h2>
      <p>Get instant alerts the second a new signal drops – no noise, just actionable moves.</p>

      <div class="premium-features">
        <div class="premium-feature"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Real-time trading signals</div>
        <div class="premium-feature"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Email & Discord alerts</div>
        <div class="premium-feature"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Full position history</div>
        <div class="premium-feature"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Priority support</div>
      </div>

      <div class="float-input" style="margin-top:20px">
        <input type="email" id="premiumEmail" placeholder=" ">
        <label>Your email</label>
      </div>

      <button class="auth-btn primary" onclick="submitPremiumInterest()" style="margin-bottom:12px">Turn on alerts</button>
      <button class="auth-btn secondary" onclick="dismissAlertsPopup()">Not now</button>
    </div>
  </div>

  <div class="modal-bg center" id="legalModal">
    <div class="modal">
      <div class="modal-header"><span class="modal-title">Terms & Risk Disclosure</span></div>
      <div class="legal-content">
        <h3>⚠️ Risk Disclosure</h3>
        <p>Options trading involves substantial risk of loss. You could lose more than your initial investment. Past performance does not guarantee future results. The wheel strategy, while considered conservative among options strategies, still carries significant risk including the risk of being assigned shares that decline in value.</p>
        <h3>📋 Not Financial Advice</h3>
        <p>Market Elites is for educational and informational purposes only. Nothing on this platform constitutes investment advice, financial advice, trading advice, or any other sort of advice. You should not treat any of the platform's content as such. Market Elites does not recommend that any securities, options, or strategies are suitable for any particular person. You are solely responsible for your own trading decisions.</p>
        <h3>📊 Signals & Alerts</h3>
        <p>Trade signals shared on this platform represent the opinions of their authors and are not recommendations to buy or sell. You should conduct your own research and consult with a licensed financial advisor before making any investment decisions. Signal performance displayed may not reflect actual fills or results.</p>
      </div>
      <div class="legal-checkbox">
        <input type="checkbox" id="legalAgree" onchange="document.getElementById('legalBtn').disabled=!this.checked">
        <label for="legalAgree">I understand the risks and agree to these terms.</label>
      </div>
      <button class="btn" id="legalBtn" onclick="acceptLegal()" disabled>Accept & Continue</button>
    </div>
  </div>

  <div class="modal-bg" id="privacyModal" onclick="closeModal('privacyModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-height:90vh">
      <div class="modal-header"><span class="modal-title">Privacy Policy</span><button class="modal-close" onclick="closeModal('privacyModal')">×</button></div>
      <div class="legal-content">
        <p><strong>Last updated:</strong> February 8, 2026</p>

        <h3>1. Information We Collect</h3>
        <p><strong>Account Information:</strong> When you create an account, we collect your name, email address, and authentication provider (Google, Apple, or email). This is stored securely in Firebase.</p>
        <p><strong>Usage Data:</strong> We track basic usage information such as login timestamps to improve the platform experience.</p>
        <p><strong>Locally Stored Data:</strong> Your portfolio positions, trade history, settings, and preferences are stored in your browser's local storage. API keys you enter (Groq, Twelve Data, Alpaca) are stored only in your browser and are never transmitted to our servers.</p>

        <h3>2. How We Use Your Information</h3>
        <p>We use your information to:</p>
        <ul style="margin:8px 0;padding-left:20px">
          <li>Provide and maintain the platform</li>
          <li>Send trade signals and alerts (if you opt in)</li>
          <li>Display leaderboard rankings (if you opt in)</li>
          <li>Improve platform features and user experience</li>
        </ul>

        <h3>3. Data Sharing</h3>
        <p>We do not sell, trade, or rent your personal information to third parties. We may share data with:</p>
        <ul style="margin:8px 0;padding-left:20px">
          <li><strong>Firebase (Google):</strong> Authentication and database services</li>
          <li><strong>Discord:</strong> Signal notifications (admin-configured webhook only)</li>
        </ul>

        <h3>4. Data Security</h3>
        <p>We use Firebase Authentication and Firebase Realtime Database with security rules to protect your data. However, no method of electronic storage is 100% secure, and we cannot guarantee absolute security.</p>

        <h3>5. Your Rights</h3>
        <p>You may request deletion of your account and associated data by contacting us. You can clear locally stored data at any time by clearing your browser storage.</p>

        <h3>6. Cookies & Local Storage</h3>
        <p>We use browser local storage to save your preferences, positions, and settings. We do not use tracking cookies or third-party analytics.</p>

        <h3>7. Changes to This Policy</h3>
        <p>We may update this Privacy Policy from time to time. Continued use of the platform after changes constitutes acceptance of the updated policy.</p>

        <h3>8. Contact</h3>
        <p>For privacy-related questions, reach out through the platform or our Discord community.</p>
      </div>
    </div>
  </div>

  <div class="modal-bg" id="disclaimerModal" onclick="closeModal('disclaimerModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-height:90vh">
      <div class="modal-header"><span class="modal-title">Disclaimer</span><button class="modal-close" onclick="closeModal('disclaimerModal')">×</button></div>
      <div class="legal-content">
        <p><strong>Last updated:</strong> February 8, 2026</p>

        <h3>1. Not Financial Advice</h3>
        <p>Market Elites ("the Platform") is an educational and informational tool for options traders. <strong>Nothing on this platform constitutes financial advice, investment advice, or a recommendation to buy or sell any security.</strong> All content, including trade signals, educational materials, and AI-generated responses, is provided for informational purposes only.</p>

        <h3>2. Risk of Loss</h3>
        <p>Options trading involves substantial risk and is not appropriate for all investors. You can lose your entire investment and potentially more. Specific risks include but are not limited to:</p>
        <ul style="margin:8px 0;padding-left:20px">
          <li>Assignment risk on cash-secured puts resulting in holding declining stocks</li>
          <li>Opportunity cost of capital secured for put positions</li>
          <li>Early assignment on covered calls limiting upside potential</li>
          <li>Market gaps and overnight moves exceeding strike prices</li>
          <li>Liquidity risk in options markets</li>
        </ul>

        <h3>3. No Guarantees</h3>
        <p>Past performance of any trade signals, strategies, or educational content does not guarantee future results. Win rates, premium collected, and P&L figures shown on the platform reflect individual tracking and may not represent actual brokerage results. Fills, timing, and execution may differ from displayed information.</p>

        <h3>4. Your Responsibility</h3>
        <p>You are solely responsible for your own investment decisions. Before trading options, you should:</p>
        <ul style="margin:8px 0;padding-left:20px">
          <li>Understand the risks of options trading</li>
          <li>Consult with a licensed financial advisor</li>
          <li>Only trade with money you can afford to lose</li>
          <li>Conduct your own due diligence on any trade</li>
        </ul>

        <h3>5. AI Chatbot Disclaimer</h3>
        <p>The AI assistant ("Wheely") provides general educational information about options strategies. Its responses are generated by artificial intelligence and should not be relied upon as financial advice. AI responses may contain errors or inaccuracies.</p>

        <h3>6. Third-Party Services</h3>
        <p>The Platform integrates with third-party services (brokers, data providers, APIs). We are not responsible for the accuracy of third-party data, outages, or any losses resulting from third-party service failures. Stock quotes and options data may be delayed or inaccurate.</p>

        <h3>7. Limitation of Liability</h3>
        <p>To the fullest extent permitted by law, Market Elites and its operators shall not be liable for any direct, indirect, incidental, consequential, or punitive damages arising from your use of the platform or reliance on any information provided herein.</p>

        <h3>8. Changes</h3>
        <p>We reserve the right to modify this disclaimer at any time. Your continued use of the platform constitutes acceptance of any changes.</p>
      </div>
    </div>
  </div>

  <div class="app">
    <div class="tab active" id="homeTab">
      <div class="hero">
        <div class="hero-top">
          <div class="hero-left">
            <button class="icon-btn" onclick="openSettings()">
              <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </button>
            <button class="avatar-btn" onclick="goToProfile()"><span id="heroInitials">?</span></button>
          </div>
          <div class="status" id="statusPill"><span class="status-dot"></span><span id="statusText">Offline</span></div>
        </div>
        <div class="hero-balance">
          <div class="balance-label">Portfolio Value</div>
          <div class="balance-amount">$<span id="balanceVal">25,000</span></div>
          <div class="balance-change" id="balanceChange">↑ +$0 (0%)</div>
        </div>
        <div class="hero-actions">
          <button class="hero-btn" onclick="goCalc('csp')"><div class="hero-btn-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12l4 4 4-4"/></svg></div><span>CSP Calc</span></button>
          <button class="hero-btn" onclick="openAdd()"><div class="hero-btn-icon"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg></div><span>Add Trade</span></button>
          <button class="hero-btn" onclick="openModal('alertsConfigModal')"><div class="hero-btn-icon"><svg viewBox="0 0 24 24"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg></div><span>Alerts</span></button>
          <button class="hero-btn" onclick="syncPositions()"><div class="hero-btn-icon"><svg viewBox="0 0 24 24"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg></div><span>Sync</span></button>
        </div>
      </div>
      <div class="quick-actions">
        <button class="quick-btn" onclick="openLearn()"><div class="quick-icon blue"><svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg></div><span>Learn</span></button>
        <button class="quick-btn" onclick="openAnalytics()"><div class="quick-icon green"><svg viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg></div><span>Analytics</span></button>
        <button class="quick-btn" onclick="openAI()"><div class="quick-icon purple"><svg viewBox="0 0 24 24"><rect x="3" y="8" width="18" height="12" rx="2"/><path d="M7 8V6a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2"/><circle cx="9" cy="14" r="1.5"/><circle cx="15" cy="14" r="1.5"/></svg></div><span>Wheely</span></button>
        <button class="quick-btn" onclick="nav('signals')"><div class="quick-icon orange"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div><span>Signals</span></button>
      </div>
      <!-- Income Goal Progress -->
      <div class="goal-bar-wrap" id="goalSection" style="display:none" onclick="openGoals()">
        <div class="goal-header"><span class="goal-label">Monthly Income Goal</span><span class="goal-amount" id="goalAmountText">$0 / $500</span></div>
        <div class="goal-track"><div class="goal-fill" id="goalFill" style="width:0%"></div></div>
        <div class="goal-streak" id="goalStreak"></div>
      </div>
      <div class="section" id="alertsFeedSection" style="display:none"><div class="section-header"><span class="section-title">Latest Alerts</span><button class="section-link" onclick="nav('signals')">See All</button></div><div id="alertsFeedContainer"></div></div>
      <div class="section" id="guestBanner" style="display:none">
        <div style="background:linear-gradient(135deg,#1a1a1a,#333);border-radius:16px;padding:20px;text-align:center">
          <div style="font-size:24px;margin-bottom:8px">👋</div>
          <div style="font-size:16px;font-weight:600;color:#fff;margin-bottom:4px">You're browsing as a guest</div>
          <div style="font-size:13px;color:#999;margin-bottom:16px">Create an account to save your portfolio and get alerts</div>
          <button class="btn" onclick="promptCreateAccount()" style="background:var(--card);color:var(--text)">Create Free Account</button>
        </div>
      </div>
      <div class="section" id="newUserBanner" style="display:none">
        <div style="background:linear-gradient(135deg,var(--blue),var(--purple));border-radius:16px;padding:20px;text-align:center;cursor:pointer" onclick="openLearn();dismissNewUser()">
          <div style="font-size:24px;margin-bottom:8px">🎡</div>
          <div style="font-size:16px;font-weight:600;color:#fff;margin-bottom:4px">New to the Wheel Strategy?</div>
          <div style="font-size:13px;color:rgba(255,255,255,0.8);margin-bottom:12px">Learn how to generate consistent income selling options — from the basics to advanced setups.</div>
          <div style="display:inline-flex;padding:10px 20px;background:rgba(255,255,255,0.2);border-radius:12px;font-size:14px;font-weight:600;color:#fff">Start Learning →</div>
        </div>
      </div>
      <div class="section"><div class="section-header"><span class="section-title">Active Positions</span><button class="section-link" onclick="openEarnings()">Earnings</button></div><div id="positionsContainer"></div></div>
      <div class="section"><div class="section-header"><span class="section-title">Recent Trades</span><button class="section-link" onclick="openAnalytics()">Analytics</button></div><div id="historyContainer"></div></div>
      <div class="footer"><a href="#" onclick="openModal('legalModal');return false">Terms</a>•<a href="#" onclick="openModal('privacyModal');return false">Privacy</a>•<a href="#" onclick="openModal('disclaimerModal');return false">Disclaimer</a><p style="margin-top:8px" onclick="secretAdminTap()">© 2026 Market Elites. Not financial advice.</p></div>
    </div>

    <div class="tab" id="calcTab">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span class="card-title" style="margin:0">Options Calculator</span><div style="display:flex;gap:6px"><button class="chip-btn" onclick="openBacktest()" style="font-size:10px;padding:4px 10px">Backtest</button><button class="help-btn" onclick="openLearn()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></button></div></div>
        <div class="toggle"><button class="toggle-btn active" id="cspBtn" onclick="setMode('csp')">Cash Secured Put</button><button class="toggle-btn" id="ccBtn" onclick="setMode('cc')">Covered Call</button></div>
        <div class="search-row"><input type="text" class="search-input" id="tickerInput" placeholder="AAPL" maxlength="5"><button class="search-btn" onclick="searchTicker()"><svg viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button></div>
        <div class="tickers"><button class="ticker-btn" onclick="qSearch('AAPL')">AAPL</button><button class="ticker-btn" onclick="qSearch('NVDA')">NVDA</button><button class="ticker-btn" onclick="qSearch('TSLA')">TSLA</button><button class="ticker-btn" onclick="qSearch('SPY')">SPY</button></div>
      </div>
      <div class="card hidden" id="loadingCard"><div class="loading"><div class="spinner"></div><p style="font-size:13px;color:var(--text2);text-align:center;margin-top:12px">Fetching live options data...</p><p style="font-size:11px;color:var(--text3);text-align:center;margin-top:4px">This may take a few seconds — we're pulling real-time pricing from multiple sources</p></div></div>
      <div class="card hidden" id="stockCard"><div style="font-size:24px;font-weight:700" id="stockSymbol">AAPL</div><div style="font-size:13px;color:var(--text2)" id="stockName">Apple Inc.</div><div style="font-size:36px;font-weight:700;margin:8px 0">$<span id="stockPrice">0.00</span></div></div>
      <div class="card hidden" id="optCard"><div class="card-title">Select Contract</div><div class="form-group"><label class="form-label">Expiration</label><select class="form-select" id="expSelect" onchange="onExpChange()"><option>Select...</option></select></div><div class="form-group"><label class="form-label">Strike</label><select class="form-select" id="strikeSelect" onchange="onStrikeChange()"><option>Select...</option></select></div></div>
      <div class="card hidden" id="resultCard">
        <div class="card-title" id="resTitle">Analysis</div>
        <div id="resExplainer" style="font-size:12px;color:var(--text2);margin-bottom:14px;line-height:1.5;padding:10px 12px;background:var(--green-bg);border-radius:8px"></div>
        <div style="margin-bottom:16px">
          <label class="form-label" style="margin-bottom:4px;font-weight:600">How many contracts?</label>
          <div id="resConDisplay" style="text-align:center;font-size:48px;font-weight:800;line-height:1.1;padding:8px 0">1</div>
          <div id="resPerContract" style="font-size:12px;color:var(--text3);text-align:center;margin-bottom:10px;font-style:italic"></div>
          <input type="hidden" id="resConInput" value="1">
          <div style="display:flex;gap:8px">
            <button class="btn btn-outline" onclick="adjustContracts(-1)" style="flex:1;padding:12px;font-size:20px;font-weight:700;min-width:auto;line-height:1">−</button>
            <button class="btn btn-outline" onclick="adjustContracts(1)" style="flex:1;padding:12px;font-size:20px;font-weight:700;min-width:auto;line-height:1">+</button>
          </div>
        </div>
        <div id="resCapitalBreakdown" style="background:var(--input);border-radius:12px;padding:16px;margin-bottom:14px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="color:var(--text2);font-size:13px" id="resCashLabel">Cash to Secure</span><span style="font-weight:700;font-size:16px" id="resCashVal">$0</span></div>
          <div id="resCashExplain" style="font-size:11px;color:var(--text3);margin:-4px 0 10px;padding-left:2px"></div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="color:var(--text2);font-size:13px">Premium You Collect</span><span style="font-weight:700;font-size:16px;color:var(--green)" id="resPremVal">+$0</span></div>
          <div id="resPremExplain" style="font-size:11px;color:var(--text3);margin:-0px 0 10px;padding-left:2px"></div>
          <div style="height:1px;background:var(--border);margin:10px 0"></div>
          <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-weight:700;font-size:14px" id="resNetLabel">Net Capital Needed</span><span style="font-weight:800;font-size:18px" id="resNetVal">$0</span></div>
          <div id="resNetExplain" style="font-size:11px;color:var(--text3);margin-top:4px;padding-left:2px"></div>
        </div>
        <div class="stats-grid">
          <div class="stat-box"><div class="stat-val blue"><span id="resAnn">0</span>%</div><div class="stat-label">Annualized</div></div>
          <div class="stat-box"><div class="stat-val"><span id="resProb">0</span>%</div><div class="stat-label">Prob. Profit</div></div>
          <div class="stat-box"><div class="stat-val green" id="resMaxBox"><span id="resMax">0</span></div><div class="stat-label" id="resMaxLabel">Max w/ Balance</div></div>
        </div>
        <button class="btn mt-4" onclick="addFromCalc()"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>Add to Portfolio</button>
      </div>
      <div class="card" id="emptyCalc"><div class="empty" style="background:transparent;border:none"><div class="empty-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></div><div class="empty-title">Search a Symbol</div><div class="empty-text">Enter a ticker to see live options data</div><div style="display:flex;align-items:center;justify-content:center;gap:6px;margin:12px 0;padding:8px 16px;background:var(--green-bg);border-radius:20px;font-size:12px;color:var(--green);font-weight:600"><span class="live-dot"></span>Live pricing • No login required</div><button class="btn btn-outline" style="width:auto;margin:0 auto" onclick="openLearn()">New? Learn the basics →</button></div></div>
    </div>

    <div class="tab" id="watchTab"><div class="section" style="padding-top:16px"><div class="section-header"><span class="section-title">Watchlist</span><button class="section-link" onclick="refreshWatch()">↻ Refresh</button></div><div id="watchContainer"></div></div></div>

    <div class="tab" id="signalsTab"><div class="section" style="padding-top:16px"><div class="section-header"><span class="section-title">Live Signals</span></div><p style="font-size:13px;color:var(--text2);margin-bottom:8px">Real-time wheel plays from our team</p><div id="exampleDisclaimer" style="padding:10px 14px;background:var(--input);border-radius:10px;margin-bottom:16px;font-size:12px;color:var(--text3)">Below are <b>example signals</b> showing what premium alerts look like. Subscribe to receive live plays.</div><div id="signalsContainer"></div></div></div>

    <div class="tab" id="alertsTab"><div class="section" style="padding-top:16px"><div class="section-header"><span class="section-title">Alerts</span></div><div id="alertsContainer"></div></div></div>


    <div class="tab" id="profileTab">
      <div class="card">
        <div class="profile-header">
          <div class="profile-avatar" onclick="$('avatarInput').click()">
            <img id="profileAvatarImg" src="" style="width:100%;height:100%;border-radius:50%;object-fit:cover;display:none">
            <span id="profileInitials">?</span>
            <div class="profile-avatar-edit"><svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg></div>
          </div>
          <input type="file" id="avatarInput" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)">
          <div class="profile-name" id="profileName" onclick="secretPremiumTap()">Set up your profile</div>
          <div class="profile-email" id="profileEmail">Tap to edit</div>
          <div class="profile-badge hidden" id="proBadge">Premium Member</div>
        </div>
        <div class="profile-stats">
          <div class="profile-stat"><div class="profile-stat-val" id="pTrades">0</div><div class="profile-stat-label">Trades</div></div>
          <div class="profile-stat"><div class="profile-stat-val" id="pWinRate">0%</div><div class="profile-stat-label">Win Rate</div></div>
          <div class="profile-stat"><div class="profile-stat-val" id="pPremium">$0</div><div class="profile-stat-label">Premium</div></div>
        </div>
      </div>
      <div class="card"><div class="card-title">Account</div><div class="form-group"><label class="form-label">Display Name</label><input type="text" class="form-input" id="userName" placeholder="Your name"></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="userEmail" placeholder="email@example.com"></div><div class="form-group"><label class="form-label">Phone (for SMS alerts)</label><input type="tel" class="form-input" id="userPhone" placeholder="5551234567"></div><div class="form-group"><label class="form-label">Mobile Carrier</label><select class="form-input" id="userCarrier"><option value="">Select carrier...</option><option value="txt.att.net">AT&T</option><option value="tmomail.net">T-Mobile</option><option value="vtext.com">Verizon</option><option value="messaging.sprintpcs.com">Sprint</option><option value="email.uscc.net">US Cellular</option><option value="sms.cricketwireless.net">Cricket</option><option value="mymetropcs.com">Metro by T-Mobile</option><option value="sms.myboostmobile.com">Boost Mobile</option></select><p style="font-size:11px;color:var(--text3);margin-top:4px">Required for free SMS alerts via email-to-text</p></div><button class="btn btn-outline" onclick="saveProfile()">Save Profile</button></div>
      <div class="card" id="alertPrefsCard" style="display:none"><div class="card-title">Alert Notifications</div><p style="font-size:13px;color:var(--text2);margin-bottom:16px">Get notified instantly when new signals are posted</p><div class="setting-row"><span>Discord Alerts</span><button class="switch" id="discordSwitch" onclick="toggleDiscordAlerts()"><div class="switch-knob"></div></button></div><div class="setting-row"><span>SMS Alerts</span><button class="switch" id="smsSwitch" onclick="toggleSmsAlerts()"><div class="switch-knob"></div></button></div><p style="font-size:11px;color:var(--text3);margin-top:12px">SMS alerts require phone number + carrier selection in Account above</p></div>
      <div class="card"><div class="card-title">Brokerage (Optional)</div><div style="padding:12px;background:var(--green-bg);border-radius:12px;margin-bottom:16px;font-size:13px;color:var(--green)"><span class="live-dot"></span><b>Live pricing works without login!</b><br><span style="opacity:0.8">Connect Alpaca only to sync your actual positions.</span></div><div id="brokerStatus"></div><div class="form-group"><label class="form-label">Alpaca API Key</label><input type="text" class="form-input" id="apiKeyInput" placeholder="PK..."></div><div class="form-group"><label class="form-label">Secret Key</label><input type="password" class="form-input" id="secretKeyInput" placeholder="••••••••"></div><div class="form-group"><label class="form-label">Account Size ($)</label><input type="number" class="form-input" id="accSizeInput" value="25000"></div><div class="form-group"><label class="form-label">Fee Per Contract ($)</label><input type="number" class="form-input" id="feeInput" value="0.65" step="0.01" min="0" placeholder="0.65"><p style="font-size:11px;color:var(--text3);margin-top:4px">Per contract, per leg. Common: $0.65 (most brokers), $0 (Robinhood)</p></div><button class="btn" onclick="connectBroker()">Connect</button></div>
      <div class="card"><div class="card-title">Preferences</div><div class="form-group"><label class="form-label">Theme</label><select class="form-input" id="themeSelect" onchange="setTheme(this.value)" style="cursor:pointer"><option value="light">Light</option><option value="dark">Dark</option><option value="pro">Pro Trader</option><option value="luxury">Luxury</option><option value="retro">80s Retro</option><option value="fun">Fun</option><option value="clean">Minimal</option></select></div><div class="setting-row"><span>Notifications</span><button class="switch" id="notifSwitch" onclick="toggleNotif()"><div class="switch-knob"></div></button></div></div>
      <div class="card" id="proCard"><div style="text-align:center"><div style="font-size:18px;font-weight:700;margin-bottom:8px">Upgrade to Premium</div><div style="font-size:13px;color:var(--text2);margin-bottom:20px">Unlock live signals & more</div><button class="btn" onclick="openPremium()">Get Premium · $9.99/mo</button></div></div>
      <div style="padding:16px;margin-bottom:100px">
        <button class="btn" onclick="confirmSignOut()" style="width:100%;background:transparent;border:2px solid var(--red);color:var(--red)">Sign Out</button>
      </div>
    </div>
  </div>

  <nav class="nav"><div class="nav-inner">
    <button class="nav-btn active" data-tab="home" onclick="nav('home')"><svg viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span>Home</span></button>
    <button class="nav-btn" data-tab="calc" onclick="nav('calc')"><svg viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M8 6h8M8 10h8M8 14h4"/></svg><span>Calc</span></button>
    <button class="nav-btn" data-tab="watch" onclick="nav('watch')"><svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg><span>Watch</span></button>
    <button class="nav-btn" data-tab="signals" onclick="nav('signals')"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><span>Signals</span></button>
    <button class="nav-btn" data-tab="profile" onclick="goToProfile()"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><span>Profile</span></button>
  </div></nav>

  <div class="modal-bg" id="settingsModal" onclick="closeModal('settingsModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div><div class="modal-header"><span class="modal-title">Quick Settings</span><button class="modal-close" onclick="closeModal('settingsModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
    <div class="form-group" style="margin-bottom:12px"><label class="form-label">Account Balance ($)</label><input type="number" class="form-input" id="qBalanceInput" placeholder="25000" style="width:100%;margin-bottom:8px"><button class="btn btn-outline" onclick="const v=parseFloat($('qBalanceInput').value);if(v>0){S.startingBalance=v;S.accSize=v;S.balance=v;save();renderHome();showToast('Starting balance set to $'+v.toLocaleString(),'success')}else{showToast('Enter a valid amount','error')}" style="width:100%">Update Balance</button></div>
    <div class="form-group" style="margin-bottom:12px"><label class="form-label">Theme</label><select class="form-input" id="qThemeSelect" onchange="setTheme(this.value)" style="cursor:pointer"><option value="light">Light</option><option value="dark">Dark</option><option value="pro">Pro Trader</option><option value="luxury">Luxury</option><option value="retro">80s Retro</option><option value="fun">Fun</option><option value="clean">Minimal</option></select></div>
    <div class="setting-row"><span>Notifications</span><button class="switch" id="qNotifSwitch" onclick="toggleNotif()"><div class="switch-knob"></div></button></div>
    <div style="padding:12px 0;border-bottom:1px solid var(--border)">
      <div class="form-group" style="margin-bottom:8px"><label class="form-label">Email for Alerts</label><input type="email" class="form-input" id="userAlertEmail" placeholder="your@email.com"></div>
      <div class="setting-row" style="padding:8px 0"><span>Receive Email Alerts</span><button class="switch" id="emailAlertSwitch" onclick="toggleEmailAlerts()"><div class="switch-knob"></div></button></div>
      <button class="btn btn-outline" onclick="saveEmailSubscription()" style="width:100%">Save Email Preferences</button>
    </div>
    <div style="padding:16px 0;border-bottom:1px solid var(--border)"><div class="form-group" style="margin-bottom:12px"><label class="form-label">Broker Sync (Alpaca)</label><input type="text" class="form-input" id="qApiKey" placeholder="API Key (PK...)"></div><div class="form-group" style="margin-bottom:12px"><input type="password" class="form-input" id="qSecretKey" placeholder="Secret Key"></div><button class="btn btn-outline" onclick="quickSaveApi()" style="width:100%;margin-bottom:8px">Save Broker Keys</button><p style="font-size:11px;color:var(--text3)">Don't have an account? <a href="https://app.alpaca.markets/signup" target="_blank" style="color:var(--blue)">Sign up at Alpaca</a></p></div>
    <button class="btn btn-red mt-4" onclick="confirmSignOut()"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Sign Out</button>
  </div></div>

  <div class="modal-bg" id="addModal" onclick="closeModal('addModal')"><div class="modal" onclick="event.stopPropagation()" style="max-height:85vh;overflow-y:auto">
    <div class="modal-handle"></div>
    <div class="modal-header"><span class="modal-title">Add Position</span><button class="modal-close" onclick="closeModal('addModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>

    <div class="toggle"><button class="toggle-btn active" id="addCspBtn" onclick="setAddMode('csp')">CSP</button><button class="toggle-btn" id="addCcBtn" onclick="setAddMode('cc')">CC</button><button class="toggle-btn" id="addSharesBtn" onclick="setAddMode('shares')">Shares</button></div>

    <!-- Quick ticker buttons -->
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin:12px 0">
      <button class="chip-btn" onclick="quickAddTicker('AAPL')">AAPL</button>
      <button class="chip-btn" onclick="quickAddTicker('NVDA')">NVDA</button>
      <button class="chip-btn" onclick="quickAddTicker('TSLA')">TSLA</button>
      <button class="chip-btn" onclick="quickAddTicker('SPY')">SPY</button>
      <button class="chip-btn" onclick="quickAddTicker('AMD')">AMD</button>
      <button class="chip-btn" onclick="quickAddTicker('MSFT')">MSFT</button>
      <button class="chip-btn" onclick="quickAddTicker('AMZN')">AMZN</button>
      <button class="chip-btn" onclick="quickAddTicker('QQQ')">QQQ</button>
    </div>

    <!-- Ticker input with live price + load chain -->
    <div class="form-group">
      <label class="form-label">Symbol — type any ticker</label>
      <input type="text" class="form-input" id="addSymbol" placeholder="e.g. AAPL, NVDA, SPY..." style="text-transform:uppercase;width:100%;font-size:18px;font-weight:600;letter-spacing:1px;margin-bottom:8px" maxlength="6">
      <button class="btn" onclick="loadAddChainBtn()" id="addLoadChainBtn" style="width:100%;padding:12px;font-size:14px">Load Chain</button>
      <div id="addTickerPrice" style="font-size:13px;margin-top:6px;color:var(--text3)"></div>
    </div>

    <!-- Options chain picker (loads after ticker) -->
    <div id="addChainPicker" style="display:none">
      <div style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:8px">TAP A STRIKE TO SELECT</div>
      <div id="addChainExps" style="display:flex;gap:6px;overflow-x:auto;padding-bottom:8px;margin-bottom:8px"></div>
      <div id="addChainStrikes" style="max-height:220px;overflow-y:auto;border:1px solid var(--border);border-radius:12px"></div>
    </div>

    <!-- Manual entry fields (always visible as fallback) -->
    <div id="optFields">
      <div style="font-size:12px;font-weight:600;color:var(--text2);margin:12px 0 8px" id="manualEntryLabel">OR ENTER MANUALLY</div>
      <div class="form-group"><label class="form-label">Strike</label><input type="number" class="form-input" id="addStrike" placeholder="150" step="0.5"></div>
      <div class="form-group"><label class="form-label">Expiration</label><input type="date" class="form-input" id="addExp"></div>
      <div class="form-group"><label class="form-label">Premium</label><input type="number" class="form-input" id="addPremium" placeholder="2.50" step="0.01"></div>
    </div>
    <div id="shareFields" class="hidden">
      <div class="form-group"><label class="form-label">Cost Basis</label><input type="number" class="form-input" id="addCost" placeholder="150" step="0.01"></div>
    </div>
    <div class="form-group"><label class="form-label">Contracts</label><input type="number" class="form-input" id="addContracts" value="1" min="1"></div>

    <!-- Selected option summary -->
    <div id="addSelectedSummary" style="display:none;background:var(--green-bg);border-radius:12px;padding:12px;margin-bottom:12px">
      <div style="font-size:11px;text-transform:uppercase;font-weight:600;color:var(--green);margin-bottom:4px">Selected</div>
      <div id="addSummaryText" style="font-size:14px;font-weight:600"></div>
    </div>

    <button class="btn" onclick="savePosition()" style="width:100%">Add Position</button>
  </div></div>

  <div class="modal-bg" id="learnModal" onclick="closeModal('learnModal')">
    <div class="modal learn-modal" onclick="event.stopPropagation()">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <button class="auth-back" id="learnBackBtn" onclick="goBackLearn()" style="display:none"><svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
        <span class="modal-title" id="learnTitle">Elite Trading Academy</span>
        <button class="modal-close" onclick="closeModal('learnModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
      </div>
      <div id="learnContent" class="learn-content"></div>
    </div>
  </div>

  <div class="modal-bg" id="analyticsModal" onclick="closeModal('analyticsModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div><div class="modal-header"><span class="modal-title">Analytics</span><button class="modal-close" onclick="closeModal('analyticsModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div id="analyticsContent"></div></div></div>

  <div class="modal-bg" id="aiModal" onclick="closeModal('aiModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div>
    <div class="ai-header">
      <div class="wheely-avatar"><div class="wheely-antenna"></div><div class="wheely-face"><div class="wheely-eye"></div><div class="wheely-eye"></div></div></div>
      <div class="ai-info"><h3>Wheely</h3><p>Your wheel strategy assistant</p></div>
    </div>
    <div class="ai-messages" id="aiMessages"></div>
    <div class="search-row"><input type="text" class="form-input" id="aiInput" placeholder="Ask Wheely..." style="flex:1" onkeydown="if(event.key==='Enter')sendAI()"><button class="search-btn" onclick="sendAI()" style="width:48px;height:48px"><svg viewBox="0 0 24 24"><path d="m22 2-7 20-4-9-9-4Z"/></svg></button></div>
  </div></div>

  <div class="modal-bg" id="posModal" onclick="closeModal('posModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div><div class="modal-header"><span class="modal-title" id="posTitle">Position</span><button class="modal-close" onclick="closeModal('posModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div id="posContent"></div><div id="rollSuggestions" style="display:none;margin-top:16px"></div><div style="display:flex;gap:12px;margin-top:20px"><button class="btn btn-red" style="flex:1" onclick="closePosition()">Close</button><button class="btn btn-outline" style="flex:1" onclick="showRollSuggestions()"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:var(--text);stroke-width:2;fill:none"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>Roll</button><button class="btn" style="flex:1" onclick="closeModal('posModal')">Done</button></div><button style="width:100%;margin-top:8px;background:none;border:none;color:var(--text3);font-size:12px;cursor:pointer;padding:8px" onclick="removePosition()">Remove (no balance change)</button></div></div>

  <!-- Screener Modal -->
  <div class="modal-bg" id="screenerModal" onclick="closeModal('screenerModal')"><div class="modal" onclick="event.stopPropagation()" style="max-height:90vh">
    <div class="modal-handle"></div>
    <div class="modal-header"><span class="modal-title">Wheel Screener</span><button class="modal-close" onclick="closeModal('screenerModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
    <div class="screener-filters" id="screenerFilters">
      <button class="chip-btn active" onclick="filterScreener('all',this)">All</button>
      <button class="chip-btn" onclick="filterScreener('etf',this)">ETFs</button>
      <button class="chip-btn" onclick="filterScreener('mega',this)">Mega Cap</button>
      <button class="chip-btn" onclick="filterScreener('value',this)">Value</button>
      <button class="chip-btn" onclick="filterScreener('growth',this)">Growth</button>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px">
      <select class="form-select" id="screenerSort" onchange="sortScreener()" style="flex:1;padding:8px 12px;border-radius:8px;background:var(--input);border:1px solid var(--border);color:var(--text);font-size:12px">
        <option value="yield">Sort: Premium Yield</option>
        <option value="price">Sort: Price</option>
        <option value="alpha">Sort: A-Z</option>
      </select>
      <button class="btn" onclick="runScreener()" style="padding:8px 16px;width:auto;font-size:12px">Scan</button>
    </div>
    <div id="screenerResults"><div class="screener-loading">Tap "Scan" to find wheel candidates</div></div>
  </div></div>

  <!-- Earnings Calendar Modal -->
  <div class="modal-bg" id="earningsModal" onclick="closeModal('earningsModal')"><div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-header"><span class="modal-title">Earnings Calendar</span><button class="modal-close" onclick="closeModal('earningsModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
    <p style="font-size:12px;color:var(--text2);margin-bottom:12px">Upcoming earnings for your portfolio & watchlist</p>
    <div id="earningsContent"><div class="screener-loading">Loading earnings dates...</div></div>
  </div></div>

  <!-- Income Goals Modal -->
  <div class="modal-bg" id="goalsModal" onclick="closeModal('goalsModal')"><div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-header"><span class="modal-title">Income Goals</span><button class="modal-close" onclick="closeModal('goalsModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
    <div style="text-align:center;margin-bottom:20px">
      <div style="font-size:13px;color:var(--text2);margin-bottom:4px">Monthly Premium Target</div>
      <div style="display:flex;align-items:center;justify-content:center;gap:8px">
        <span style="font-size:28px;font-weight:800">$</span>
        <input type="number" class="form-input" id="goalInput" placeholder="500" style="width:120px;font-size:28px;font-weight:800;text-align:center;padding:8px" value="">
      </div>
      <button class="btn" onclick="saveGoal()" style="margin-top:12px">Set Goal</button>
    </div>
    <div id="goalsContent"></div>
  </div></div>

  <!-- Backtest Modal -->
  <div class="modal-bg" id="backtestModal" onclick="closeModal('backtestModal')"><div class="modal" onclick="event.stopPropagation()" style="max-height:90vh">
    <div class="modal-handle"></div>
    <div class="modal-header"><span class="modal-title">Strategy Backtest</span><button class="modal-close" onclick="closeModal('backtestModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
    <div style="background:var(--accent-bg);border-radius:10px;padding:12px;margin-bottom:14px;font-size:12px;color:var(--text2);line-height:1.5">See how much premium income you could have earned selling options on any stock. Enter a ticker and account size to simulate the wheel strategy over time.</div>
    <div class="form-group"><label class="form-label">Ticker</label><input type="text" class="form-input" id="btTicker" placeholder="SPY" style="text-transform:uppercase" maxlength="5"></div>
    <div class="toggle" style="margin-bottom:12px"><button class="toggle-btn active" id="btCspBtn" onclick="setBtMode('csp')">Sell Puts (CSP)</button><button class="toggle-btn" id="btCcBtn" onclick="setBtMode('cc')">Sell Calls (CC)</button></div>
    <div style="display:flex;gap:8px;margin-bottom:12px">
      <div class="form-group" style="flex:1;margin-bottom:0"><label class="form-label">Risk Level</label><select class="form-select" id="btDelta" style="padding:10px;border-radius:8px"><option value="0.16">Conservative</option><option value="0.20">Moderate</option><option value="0.30" selected>Standard</option><option value="0.40">Aggressive</option></select></div>
      <div class="form-group" style="flex:1;margin-bottom:0"><label class="form-label">Frequency</label><select class="form-select" id="btDTE" style="padding:10px;border-radius:8px"><option value="7">Weekly</option><option value="30" selected>Monthly</option><option value="45">Every 45 Days</option></select></div>
    </div>
    <div class="form-group"><label class="form-label">Time Period</label><select class="form-select" id="btPeriod" style="padding:10px;border-radius:8px"><option value="12">1 Year</option><option value="24">2 Years</option><option value="52">5 Years (est.)</option></select></div>
    <div class="form-group"><label class="form-label">Account Size ($)</label><input type="number" class="form-input" id="btAccount" placeholder="25000" value="25000"></div>
    <button class="btn" onclick="runBacktest()">Run Backtest</button>
    <div id="btResults" style="margin-top:16px"></div>
  </div></div>

  <!-- Leaderboard Modal -->
  <div class="modal-bg" id="leaderboardModal" onclick="closeModal('leaderboardModal')"><div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-header"><span class="modal-title">Rankings</span><button class="modal-close" onclick="closeModal('leaderboardModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
    <div id="achievementsSection" style="margin-bottom:16px"></div>
    <div style="font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Leaderboard</div>
    <div id="leaderboardContent"></div>
    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <span style="font-size:13px;color:var(--text2)">Share my stats publicly</span>
        <button class="switch" id="lbOptIn" onclick="toggleLeaderboardOptIn()"><div class="switch-knob"></div></button>
      </div>
    </div>
  </div></div>

  <!-- Position Alerts Config Modal -->
  <div class="modal-bg" id="alertsConfigModal" onclick="closeModal('alertsConfigModal')"><div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-header"><span class="modal-title">Position Alerts</span><button class="modal-close" onclick="closeModal('alertsConfigModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
    <div class="form-group"><label class="form-label">DTE Warning Threshold</label>
      <div style="display:flex;gap:8px">
        <button class="chip-btn" onclick="setDteThreshold(3,this)">3 days</button>
        <button class="chip-btn active" onclick="setDteThreshold(7,this)">7 days</button>
        <button class="chip-btn" onclick="setDteThreshold(14,this)">14 days</button>
        <button class="chip-btn" onclick="setDteThreshold(21,this)">21 days</button>
      </div>
    </div>
    <div class="setting-row" style="padding:12px 0;border-bottom:1px solid var(--border)"><span>DTE Expiry Warnings</span><button class="switch on" id="alertDteSwitch" onclick="toggleAlertType('dte')"><div class="switch-knob"></div></button></div>
    <div class="setting-row" style="padding:12px 0;border-bottom:1px solid var(--border)"><span>Earnings Proximity Warnings</span><button class="switch on" id="alertEarnSwitch" onclick="toggleAlertType('earnings')"><div class="switch-knob"></div></button></div>
    <div class="setting-row" style="padding:12px 0"><span>Browser Notifications</span><button class="switch" id="alertBrowserSwitch" onclick="toggleAlertType('browser')"><div class="switch-knob"></div></button></div>
    <div id="activeAlertsContainer" style="margin-top:16px"></div>
  </div></div>

  <div class="modal-bg" id="premiumModal" onclick="closeModal('premiumModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div>
    <div style="text-align:center;padding:20px 0"><div style="font-size:28px;font-weight:700">Premium</div><div style="font-size:14px;color:var(--text2);margin-top:8px">Unlock the full experience</div></div>
    <div style="margin:24px 0">
      <div style="display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--border)"><span style="color:var(--green)">✓</span><span>Live trading signals</span></div>
      <div style="display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--border)"><span style="color:var(--green)">✓</span><span>Priority alerts</span></div>
      <div style="display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--border)"><span style="color:var(--green)">✓</span><span>Advanced analytics</span></div>
      <div style="display:flex;align-items:center;gap:12px;padding:14px 0"><span style="color:var(--green)">✓</span><span>Direct support</span></div>
    </div>
    <button class="btn" onclick="handlePremiumSubscribe()">Subscribe · $9.99/month</button>
    <p style="font-size:12px;color:var(--text3);text-align:center;margin-top:16px">Cancel anytime</p>
  </div></div>

  <div class="modal-bg" id="adminModal" onclick="closeModal('adminModal')"><div class="modal" onclick="event.stopPropagation()" style="max-height:90vh">
    <div class="modal-handle"></div>
    <div class="modal-header"><span class="modal-title">Admin Panel</span><button class="modal-close" onclick="closeModal('adminModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>

    <div id="masterPortfolio" style="margin-bottom:16px;padding:14px;background:var(--input);border-radius:12px;border-left:3px solid var(--green)"></div>

    <div class="toggle" style="margin-bottom:20px">
      <button class="toggle-btn active" id="adminSignalBtn" onclick="setAdminTab('signal')">Signal</button>
      <button class="toggle-btn" id="adminAnnBtn" onclick="setAdminTab('announcement')">Announce</button>
      <button class="toggle-btn" id="adminRollBtn" onclick="setAdminTab('roll')">Roll</button>
    </div>

    <div id="adminSignalForm">
      <div style="display:flex;gap:8px;justify-content:center;margin-bottom:10px">
        <div class="toggle"><button class="toggle-btn active" id="sigCspBtn" onclick="S.adminSigType='csp';this.classList.add('active');$('sigCcBtn').classList.remove('active');if(adminChainData)renderAdminChain(adminChainData)">CSP</button><button class="toggle-btn" id="sigCcBtn" onclick="S.adminSigType='cc';this.classList.add('active');$('sigCspBtn').classList.remove('active');if(adminChainData)renderAdminChain(adminChainData)">CC</button></div>
      </div>
      <div style="margin-bottom:10px">
        <input type="text" class="form-input" id="adminTicker" placeholder="TICKER" style="text-transform:uppercase;width:100%;font-size:16px;font-weight:700;letter-spacing:1px;text-align:center;padding:12px" maxlength="6">
      </div>
      <div style="margin-bottom:12px">
        <button class="btn" onclick="loadAdminChain()" style="width:100%;padding:12px;font-size:14px">Load Chain</button>
      </div>
      <div id="adminTickerInfo" style="font-size:12px;color:var(--text3);margin-bottom:8px;text-align:center"></div>

      <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px">
        <button class="chip-btn" onclick="adminQuickTicker('AAPL')">AAPL</button>
        <button class="chip-btn" onclick="adminQuickTicker('NVDA')">NVDA</button>
        <button class="chip-btn" onclick="adminQuickTicker('TSLA')">TSLA</button>
        <button class="chip-btn" onclick="adminQuickTicker('SPY')">SPY</button>
        <button class="chip-btn" onclick="adminQuickTicker('AMD')">AMD</button>
        <button class="chip-btn" onclick="adminQuickTicker('MSFT')">MSFT</button>
        <button class="chip-btn" onclick="adminQuickTicker('AMZN')">AMZN</button>
        <button class="chip-btn" onclick="adminQuickTicker('QQQ')">QQQ</button>
      </div>

      <div id="adminChainPicker" style="display:none;margin-bottom:12px">
        <div id="adminChainExps" style="display:flex;gap:4px;overflow-x:auto;padding-bottom:6px;margin-bottom:6px;-webkit-overflow-scrolling:touch"></div>
        <div id="adminChainStrikes" style="max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;font-size:12px"></div>
      </div>

      <div style="display:flex;gap:6px;margin-bottom:8px">
        <div class="form-group" style="flex:1;margin-bottom:0"><label class="form-label" style="font-size:10px">Strike</label><input type="number" class="form-input" id="adminStrike" placeholder="130" style="padding:8px 10px"></div>
        <div class="form-group" style="flex:1;margin-bottom:0"><label class="form-label" style="font-size:10px">Exp</label><select class="form-input" id="adminExp" style="padding:8px 10px"></select></div>
        <div class="form-group" style="flex:1;margin-bottom:0"><label class="form-label" style="font-size:10px">Premium</label><input type="text" class="form-input" id="adminPrem" placeholder="$3.20" style="padding:8px 10px"></div>
        <div class="form-group" style="flex:0.7;margin-bottom:0"><label class="form-label" style="font-size:10px">Delta</label><input type="text" class="form-input" id="adminDelta" placeholder=".25" style="padding:8px 10px"></div>
      </div>
      <div class="form-group" style="margin-bottom:10px"><input type="text" class="form-input" id="adminNotes" placeholder="Notes (optional)" style="padding:8px 12px;font-size:13px"></div>
      <button class="btn" onclick="postSignal()" style="width:100%">Post Signal</button>
    </div>

    <div id="adminAnnForm" class="hidden">
      <div class="form-group"><label class="form-label">Title</label><input type="text" class="form-input" id="annTitle" placeholder="Market Update"></div>
      <div class="form-group"><label class="form-label">Message</label><textarea class="form-input" id="annMsg" placeholder="Your announcement..." rows="4" style="resize:none"></textarea></div>
      <button class="btn" onclick="postAnnouncement()">Post Announcement</button>
    </div>

    <div id="adminRollForm" class="hidden">
      <div class="form-group"><label class="form-label">Select Position to Roll</label>
        <select class="form-select" id="rollPositionSelect" onchange="fillRollFromPosition()">
          <option value="">-- Select a position --</option>
        </select>
      </div>
      <div id="rollOrigInfo" style="display:none;padding:10px 12px;background:var(--input);border-radius:8px;margin-bottom:12px;font-size:13px">
        <div style="font-weight:600;margin-bottom:4px" id="rollOrigLabel"></div>
        <div style="color:var(--text2)" id="rollOrigDetails"></div>
      </div>
      <div id="rollNewFields" style="display:none">
        <div class="form-label" style="font-weight:600;margin-bottom:8px">Roll To:</div>
        <div style="display:flex;gap:6px;margin-bottom:8px">
          <div class="form-group" style="flex:1;margin-bottom:0">
            <label class="form-label" style="font-size:10px">New Strike</label>
            <input type="number" class="form-input" id="rollNewStrike" placeholder="125" style="padding:8px 10px">
          </div>
          <div class="form-group" style="flex:1;margin-bottom:0">
            <label class="form-label" style="font-size:10px">New Exp</label>
            <select class="form-input" id="rollNewExp" style="padding:8px 10px"></select>
          </div>
          <div class="form-group" style="flex:1;margin-bottom:0">
            <label class="form-label" style="font-size:10px">New Premium</label>
            <input type="number" class="form-input" id="rollNewPrem" placeholder="2.50" step="0.01" style="padding:8px 10px" oninput="updateRollSummary()">
          </div>
        </div>
        <button class="btn btn-outline" onclick="loadRollChain()" style="width:100%;margin-bottom:10px;font-size:12px">Load Options Chain for Strikes</button>
        <div id="rollChainPicker" style="display:none;margin-bottom:10px">
          <div id="rollChainExps" style="display:flex;gap:4px;overflow-x:auto;margin-bottom:6px;padding:2px 0"></div>
          <div id="rollChainStrikes" style="max-height:280px;overflow-y:auto;border:1px solid var(--border);border-radius:8px"></div>
        </div>
        <div id="rollPremiumSummary" style="padding:12px;background:var(--green-bg);border-radius:10px;margin-bottom:12px;font-size:13px">
          <div style="font-weight:600;margin-bottom:6px">Premium Summary</div>
          <div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text2)">Original premium collected:</span><span style="color:var(--green);font-weight:600" id="rollOrigPrem">$0</span></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text2)">New premium (roll):</span><span style="font-weight:600;color:var(--green)" id="rollNewPremAmt">$0</span></div>
          <div style="height:1px;background:var(--border);margin:6px 0"></div>
          <div style="display:flex;justify-content:space-between"><span style="font-weight:600">Total premium collected:</span><span style="font-weight:700;color:var(--green)" id="rollTotalPrem">$0</span></div>
        </div>
        <div class="form-group" style="margin-bottom:10px"><input type="text" class="form-input" id="rollNotes" placeholder="Notes (optional)" style="padding:8px 12px;font-size:13px"></div>
        <button class="btn" onclick="postRoll()" style="width:100%">Post Roll & Update Position</button>
      </div>
    </div>

    <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
      <div class="card-title">Manage Positions</div>
      <p style="font-size:11px;color:var(--text3);margin-bottom:12px">Mark as winner, assigned, rolled, or called away</p>
      <div id="adminPostsList" style="max-height:300px;overflow-y:auto"></div>
    </div>

    <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
      <div class="card-title" style="display:flex;align-items:center;gap:8px">Wheel Positions <span style="font-size:11px;padding:2px 8px;background:var(--orange-bg);color:var(--orange);border-radius:20px;font-weight:600" id="wheelCount">0</span></div>
      <p style="font-size:11px;color:var(--text3);margin-bottom:12px">Assigned shares being wheeled — sell CCs to lower cost basis, then get called away</p>
      <div id="wheelPositionsList" style="max-height:400px;overflow-y:auto"></div>
    </div>

    <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
      <div class="card-title" style="display:flex;align-items:center;gap:8px">Registered Users <span style="font-size:11px;padding:2px 8px;background:var(--blue-bg,rgba(59,130,246,0.1));color:var(--blue,#3b82f6);border-radius:20px;font-weight:600" id="userCount">0</span></div>
      <p style="font-size:11px;color:var(--text3);margin-bottom:12px">Everyone who has signed up</p>
      <div id="adminUsersList" style="max-height:300px;overflow-y:auto"></div>
    </div>

    <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
      <div class="card-title">Notification Settings</div>
      <div style="margin-top:12px">
        <div class="form-label" style="font-weight:600;margin-bottom:8px">🎮 Discord Alerts</div>
        <div class="form-group"><label class="form-label">Webhook URL</label><input type="text" class="form-input" id="discordWebhook" placeholder="https://discord.com/api/webhooks/..."></div>
        <p style="font-size:11px;color:var(--text3);margin-top:4px">Signals, winners & announcements sent to your Discord server</p>
        <button class="btn btn-outline" onclick="testDiscordWebhook()" style="margin-top:8px;font-size:12px;padding:6px 16px">🧪 Send Test Message</button>
      </div>

      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
        <div class="form-label" style="font-weight:600;margin-bottom:8px">💳 Stripe (Premium Payments)</div>
        <div class="form-group"><label class="form-label">Payment Link URL</label><input type="text" class="form-input" id="stripePaymentLink" placeholder="https://buy.stripe.com/your_link_id"></div>
        <p style="font-size:11px;color:var(--text3);margin-top:4px">Create a Payment Link at <a href="https://dashboard.stripe.com/payment-links" target="_blank" style="color:var(--blue)">stripe.com/dashboard</a></p>
      </div>

      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
        <div class="form-label" style="font-weight:600;margin-bottom:8px">📧 EmailJS (Free Email Alerts)</div>
        <div class="form-group"><label class="form-label">Public Key</label><input type="text" class="form-input" id="emailjsPublicKey" placeholder="Your EmailJS public key"></div>
        <div class="form-group"><label class="form-label">Service ID</label><input type="text" class="form-input" id="emailjsServiceId" placeholder="service_xxxxxxx"></div>
        <div class="form-group"><label class="form-label">Template ID</label><input type="text" class="form-input" id="emailjsTemplateId" placeholder="template_xxxxxxx"></div>
        <p style="font-size:11px;color:var(--text3);margin-top:4px">Free at <a href="https://emailjs.com" target="_blank" style="color:var(--blue)">emailjs.com</a> - 200 emails/month</p>
      </div>

      <button class="btn btn-outline" onclick="saveAdminSettings()" style="margin-top:12px">Save Settings</button>
    </div>
  </div></div>

  <div class="modal-bg center" id="promptModal" style="z-index:250" onclick="closePrompt()"><div class="modal" onclick="event.stopPropagation()" style="max-width:360px;background:var(--bg);border:1px solid var(--border)">
    <div class="modal-header"><span class="modal-title" id="promptTitle">Enter Value</span><button class="modal-close" onclick="closePrompt()"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
    <div class="form-group"><input type="text" class="form-input" id="promptInput" placeholder="" style="font-size:18px;text-transform:uppercase"></div>
    <div style="display:flex;gap:12px"><button class="btn" onclick="submitPrompt()" style="flex:1">OK</button><button class="btn btn-outline" onclick="closePrompt()" style="flex:1">Cancel</button></div>
  </div></div>

  <div class="toast" id="toast"></div>

  <!-- Wheel Recap Modal -->
  <div class="modal-bg" id="wheelRecapModal" onclick="closeModal('wheelRecapModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width:440px;max-height:90vh;overflow-y:auto">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <span class="modal-title">Wheel Complete</span>
        <button class="modal-close" onclick="closeModal('wheelRecapModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
      </div>
      <div id="wheelRecapContent" style="padding:0 20px 20px"></div>
    </div>
  </div>

<script>
const S={theme:'light',mode:'csp',addMode:'csp',apiKey:'',secretKey:'',accSize:25000,feePerContract:0.65,positions:[],history:[],selPosId:null,user:{name:'',email:''},isPremium:false,legalOk:false,notifOn:false,emailAlerts:false,alertEmail:'',alertsPopupDismissed:false,watchlist:['AAPL','NVDA','TSLA','SPY','AMD','MSFT'],incomeGoal:500,incomeGoalHistory:[],dteThreshold:7,alertSettings:{dte:true,earnings:true,browser:false},achievements:[],leaderboardOptIn:false,leaderboardName:''};
const names={AAPL:'Apple Inc.',NVDA:'NVIDIA',TSLA:'Tesla',MSFT:'Microsoft',AMD:'AMD',SPY:'S&P 500 ETF',QQQ:'Nasdaq 100 ETF',AMZN:'Amazon',GOOGL:'Alphabet',META:'Meta Platforms',RKLB:'Rocket Lab',PLTR:'Palantir',SOFI:'SoFi',COIN:'Coinbase',HOOD:'Robinhood',NET:'Cloudflare',SNOW:'Snowflake',CRWD:'CrowdStrike',DDOG:'Datadog',ZS:'Zscaler'};
const domains={AAPL:'apple.com',NVDA:'nvidia.com',TSLA:'tesla.com',MSFT:'microsoft.com',AMD:'amd.com',SPY:'ssga.com',QQQ:'invesco.com',AMZN:'amazon.com',GOOGL:'google.com',META:'meta.com',RKLB:'rocketlabusa.com',PLTR:'palantir.com',SOFI:'sofi.com',COIN:'coinbase.com',HOOD:'robinhood.com',NET:'cloudflare.com',SNOW:'snowflake.com',CRWD:'crowdstrike.com',DDOG:'datadoghq.com',ZS:'zscaler.com'};
const signals=[{type:'csp',ticker:'NVDA',strike:130,exp:'Jan 24',prem:'$3.20',delta:'0.25',time:'2h ago'},{type:'cc',ticker:'AAPL',strike:260,exp:'Jan 31',prem:'$2.80',delta:'0.30',time:'5h ago'},{type:'csp',ticker:'AMD',strike:135,exp:'Feb 7',prem:'$4.50',delta:'0.28',time:'1d ago'}];

// ========== AUTHENTICATION ==========
function showAuthTab(tab) {
  $('authLogin').classList.toggle('hidden', tab !== 'login');
  $('authSignup').classList.toggle('hidden', tab !== 'signup');
}

function togglePasswordVisibility(inputId, btn) {
  const input = $(inputId);
  if (input.type === 'password') {
    input.type = 'text';
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';
  } else {
    input.type = 'password';
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
  }
}

function checkPasswordStrength() {
  const pass = $('signupPassword').value;
  const checks = {
    passLength: pass.length >= 8,
    passLower: /[a-z]/.test(pass),
    passUpper: /[A-Z]/.test(pass),
    passNumber: /[0-9]/.test(pass),
    passSpecial: /[!@#$%^&*(),.?":{}|<>]/.test(pass)
  };

  Object.entries(checks).forEach(([id, valid]) => {
    $(id).classList.toggle('valid', valid);
  });

  // Enable signup button if all checks pass
  const allValid = Object.values(checks).every(v => v);
  $('signupBtn').disabled = !allValid;
}

function submitPremiumInterest() {
  const email = $('premiumEmail').value.trim();
  if (!email || !email.includes('@')) {
    showToast('Please enter a valid email', 'error');
    return;
  }

  // Subscribe to email alerts in Firebase
  initFirebase().then(ok => {
    if (ok) {
      const emailKey = email.replace(/[.#$[\]]/g, '_');
      const db = firebase.database();
      // Add to actual email subscribers list so they receive alerts
      db.ref('emailSubscribers/' + emailKey).set({
        email: email,
        active: true,
        subscribedAt: Date.now(),
        source: 'alerts_popup',
        uid: S.firebaseUid || null
      });
      // Also track interest
      db.ref('premiumInterest/' + emailKey).set({
        email: email,
        timestamp: Date.now(),
        source: 'alerts_popup'
      });
    }
  });

  S.alertEmail = email;
  S.emailAlerts = true;
  S.alertsPopupDismissed = true;
  save();

  closeModal('premiumPopup');
  showToast('Alerts activated! You\'ll be notified of new signals.', 'success');

  // Request browser notifications too
  requestBrowserNotifications();

  nav('profile');
}

// Show alerts popup (only once, on first profile click)
function showAlertsPopupOnce() {
  // Check if already dismissed
  if (S.alertsPopupDismissed) return false;

  // Pre-fill email if user is logged in
  if (S.user.email) $('premiumEmail').value = S.user.email;
  openModal('premiumPopup');
  return true;
}

// Called when "Not now" is clicked on alerts popup
function dismissAlertsPopup() {
  S.alertsPopupDismissed = true;
  save();
  closeModal('premiumPopup');
  // Now go to profile
  nav('profile');
}

// Called when user clicks avatar/profile button
function goToProfile() {
  // If guest, prompt to create account
  if (S.isGuest) {
    promptCreateAccount();
    return;
  }

  // Show alerts popup once if not dismissed, not premium, and alerts not already on
  if (!S.isPremium && !S.alertsPopupDismissed && !S.notifOn && !S.emailAlerts) {
    showAlertsPopupOnce();
    return;
  }
  nav('profile');
}

// Prompt guest to create an account
function promptCreateAccount() {
  // Clear guest state and show signup
  S.isGuest = false;
  save();
  showAuthScreen();
  showAuthTab('signup');
  showToast('Create an account to save your progress!', '');
}

async function handleLogin() {
  const email = $('loginEmail').value.trim();
  const pass = $('loginPassword').value;
  const rememberMe = $('rememberMe')?.checked;

  if (!email || !pass) return showToast('Please fill all fields', 'error');

  try {
    if (!await initFirebase()) throw new Error('Firebase init failed');

    // Set persistence based on "Remember me" checkbox
    const persistence = rememberMe
      ? firebase.auth.Auth.Persistence.LOCAL      // Persists even after browser close
      : firebase.auth.Auth.Persistence.SESSION;   // Cleared when tab closes
    await firebase.auth().setPersistence(persistence);

    const cred = await firebase.auth().signInWithEmailAndPassword(email, pass);
    await loadUserData(cred.user.uid);
    completeAuth(cred.user);
  } catch (e) {
    console.error('Login error:', e);
    showToast(e.message || 'Login failed', 'error');
  }
}

async function handleSignup() {
  const name = $('signupName').value.trim();
  const email = $('signupEmail').value.trim();
  const pass = $('signupPassword').value;

  if (!name || !email || !pass) return showToast('Please fill all fields', 'error');

  // Validate password strength
  const hasLength = pass.length >= 8;
  const hasLower = /[a-z]/.test(pass);
  const hasUpper = /[A-Z]/.test(pass);
  const hasNumber = /[0-9]/.test(pass);
  const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(pass);

  if (!hasLength || !hasLower || !hasUpper || !hasNumber || !hasSpecial) {
    return showToast('Password doesn\'t meet requirements', 'error');
  }

  try {
    if (!await initFirebase()) throw new Error('Firebase init failed');
    const cred = await firebase.auth().createUserWithEmailAndPassword(email, pass);

    // Save user profile to Firebase
    await firebase.database().ref('users/' + cred.user.uid).set({
      name: name,
      email: email,
      isPremium: false,
      createdAt: Date.now(),
      lastLogin: Date.now()
    });

    S.user.name = name;
    S.user.email = email;
    S.isPremium = false;
    save();

    completeAuth(cred.user);
    showToast('Welcome to Market Elites!', 'success');
    notifyNewSignup(name, email, 'email').catch(() => {});
  } catch (e) {
    console.error('Signup error:', e);
    showToast(e.message || 'Signup failed', 'error');
  }
}

function handleGuestLogin() {
  S.isGuest = true;
  S.user.name = 'Guest';
  save();
  hideAuthScreen();
  checkLegal();
  renderHome(); // Fix: render home after guest login
  showToast('Browsing as guest - Sign up to save your data!', '');
}

async function handleGoogleSignIn() {
  try {
    if (!await initFirebase()) throw new Error('Firebase init failed');

    const provider = new firebase.auth.GoogleAuthProvider();
    const result = await firebase.auth().signInWithPopup(provider);
    const user = result.user;

    // Check if user exists in database, if not create profile
    const userRef = firebase.database().ref('users/' + user.uid);
    const snapshot = await userRef.once('value');

    const isNewUser = !snapshot.exists();
    if (isNewUser) {
      // New user - create profile
      await userRef.set({
        name: user.displayName || 'User',
        email: user.email,
        isPremium: false,
        createdAt: Date.now(),
        lastLogin: Date.now(),
        provider: 'google'
      });
    }

    // Load user data
    const userData = snapshot.val() || {};
    S.user.name = user.displayName || userData.name || 'User';
    S.user.email = user.email;
    S.isPremium = userData.isPremium || false;
    save();

    completeAuth(user);
    showToast('Welcome, ' + S.user.name + '!', 'success');
    if (isNewUser) notifyNewSignup(user.displayName || 'User', user.email, 'google').catch(() => {});
  } catch (e) {
    console.error('Google sign-in error:', e);
    if (e.code === 'auth/popup-closed-by-user') {
      // User closed popup, don't show error
      return;
    }
    showToast(e.message || 'Google sign-in failed', 'error');
  }
}

async function handleAppleSignIn() {
  try {
    if (!await initFirebase()) throw new Error('Firebase init failed');

    const provider = new firebase.auth.OAuthProvider('apple.com');
    provider.addScope('email');
    provider.addScope('name');
    const result = await firebase.auth().signInWithPopup(provider);
    const user = result.user;

    // Check if user exists in database, if not create profile
    const userRef = firebase.database().ref('users/' + user.uid);
    const snapshot = await userRef.once('value');

    const isNewApple = !snapshot.exists();
    if (isNewApple) {
      await userRef.set({
        name: user.displayName || 'User',
        email: user.email || '',
        isPremium: false,
        createdAt: Date.now(),
        lastLogin: Date.now(),
        provider: 'apple'
      });
    }

    const userData = snapshot.val() || {};
    S.user.name = user.displayName || userData.name || 'User';
    S.user.email = user.email || userData.email || '';
    S.isPremium = userData.isPremium || false;
    save();

    completeAuth(user);
    showToast('Welcome, ' + S.user.name + '!', 'success');
    if (isNewApple) notifyNewSignup(user.displayName || 'User', user.email || '', 'apple').catch(() => {});
  } catch (e) {
    console.error('Apple sign-in error:', e);
    if (e.code === 'auth/popup-closed-by-user') return;
    showToast(e.message || 'Apple sign-in failed', 'error');
  }
}

function completeAuth(user) {
  S.firebaseUid = user.uid;
  // Save remember me preference
  if ($('rememberMe')?.checked) {
    localStorage.setItem('meRemember', 'true');
  }
  save();
  hideAuthScreen();
  checkLegal();
  renderHome(); // Fix: render home after login
  // Track last login in Firebase (Firebase is already initialized since auth just succeeded)
  firebase.database().ref('users/' + user.uid).update({ lastLogin: Date.now() }).catch(e => console.warn('lastLogin update:', e));
}

async function loadUserData(uid) {
  try {
    const snapshot = await firebase.database().ref('users/' + uid).once('value');
    const data = snapshot.val();
    if (data) {
      S.user.name = data.name || '';
      S.user.email = data.email || '';
      S.isPremium = data.isPremium || false;
      save();
    }
    // Listen for real-time premium status changes (e.g. admin grants PRO)
    firebase.database().ref('users/' + uid + '/isPremium').on('value', snap => {
      const wasPremium = S.isPremium;
      S.isPremium = snap.val() || false;
      if (S.isPremium !== wasPremium) {
        save();
        if (S.isPremium && !wasPremium) {
          showToast('Premium activated! Welcome to PRO', 'success');
        }
        // Re-render to show/hide premium features
        renderProfile();
        renderSignals();
        renderHome();
      }
    });
  } catch (e) {
    console.error('Load user data error:', e);
  }
}

function checkAuthState() {
  // Check if user is logged in locally (guest or has firebase uid)
  if (S.firebaseUid || S.isGuest) {
    hideAuthScreen();
    return true;
  }

  // Check if "Remember me" was selected - try to restore Firebase session
  const remembered = localStorage.getItem('meRemember');
  if (remembered) {
    // Firebase will auto-restore session, set up listener
    initFirebase().then(ok => {
      if (ok && firebase.auth) {
        firebase.auth().onAuthStateChanged(user => {
          if (user) {
            S.firebaseUid = user.uid;
            loadUserData(user.uid);
            save();
            hideAuthScreen();
            checkLegal();
            renderHome();
            // Track last active on session restore
            firebase.database().ref('users/' + user.uid).update({ lastLogin: Date.now() }).catch(() => {});
          }
        });
      }
    });
  }

  showAuthScreen();
  return false;
}

function showAuthScreen() {
  $('authScreen').style.display = 'flex';
  document.querySelector('.app').style.display = 'none';
  document.querySelector('.nav').style.display = 'none';
}

function hideAuthScreen() {
  $('authScreen').style.display = 'none';
  document.querySelector('.app').style.display = 'block';
  document.querySelector('.nav').style.display = '';  // Restore CSS default
}

function showForgotPassword() {
  showPrompt('Reset Password', 'Enter your email address', async (email) => {
    if (!email) return;
    try {
      if (!await initFirebase()) throw new Error('Firebase init failed');
      await firebase.auth().sendPasswordResetEmail(email);
      showToast('Password reset email sent!', 'success');
    } catch (e) {
      showToast(e.message || 'Reset failed', 'error');
    }
  });
}

// Live pricing cache
const priceCache = {};
const optionsCache = {};

function getTwelveDataKey() {
  return localStorage.getItem('twelveDataKey') || '';
}

// Fetch live stock quote — Twelve Data primary, Yahoo fallback
async function fetchLiveQuote(symbol) {
  const cacheKey = symbol.toUpperCase();
  const cached = priceCache[cacheKey];
  if (cached && Date.now() - cached.time < 30000) return cached.data; // 30s cache

  const apiKey = getTwelveDataKey();

  // Try Twelve Data first (reliable, no CORS issues)
  if (apiKey) {
    try {
      const url = `https://api.twelvedata.com/quote?symbol=${encodeURIComponent(symbol)}&apikey=${apiKey}`;
      const r = await fetch(url);
      if (r.ok) {
        const data = await r.json();
        if (data.symbol && !data.code) {
          const price = parseFloat(data.close) || 0;
          const prevClose = parseFloat(data.previous_close) || price;
          const change = price - prevClose;
          const changePercent = prevClose > 0 ? ((change / prevClose) * 100).toFixed(2) : '0.00';
          const quote = {
            symbol: data.symbol,
            price: price,
            prevClose: prevClose,
            change: change,
            changePercent: changePercent,
            high: parseFloat(data.high) || 0,
            low: parseFloat(data.low) || 0,
            volume: parseInt(data.volume) || 0
          };
          priceCache[cacheKey] = { data: quote, time: Date.now() };
          return quote;
        }
      }
    } catch (e) {
      console.warn('Twelve Data error, falling back:', e);
    }
  }

  // Fallback: Yahoo Finance via CORS proxy (race all proxies for speed)
  const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`;
  const quoteProxies = [
    u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
    u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
    u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`
  ];

  // Race all proxies — first valid response wins
  const proxyAttempts = quoteProxies.map(async makeProxy => {
    const proxyUrl = makeProxy(yahooUrl);
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 8000);
    try {
      const r = await fetch(proxyUrl, { signal: controller.signal });
      clearTimeout(timeout);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const text = await r.text();
      if (text.startsWith('<') || text.startsWith('<!')) throw new Error('HTML response');
      const data = JSON.parse(text);
      const result = data.chart?.result?.[0];
      if (!result) throw new Error('No data');
      const meta = result.meta;
      const price = meta.regularMarketPrice || 0;
      const prevClose = meta.previousClose || meta.chartPreviousClose || price;
      const change = price - prevClose;
      const changePercent = prevClose > 0 ? ((change / prevClose) * 100).toFixed(2) : '0.00';
      return {
        symbol: meta.symbol,
        price: price,
        prevClose: prevClose,
        change: change,
        changePercent: changePercent,
        high: meta.regularMarketDayHigh,
        low: meta.regularMarketDayLow,
        volume: meta.regularMarketVolume
      };
    } catch (e) {
      clearTimeout(timeout);
      throw e;
    }
  });

  try {
    const quote = await Promise.any(proxyAttempts);
    priceCache[cacheKey] = { data: quote, time: Date.now() };
    return quote;
  } catch (e) {
    // All proxies failed
  }

  console.error('All quote sources failed for', symbol);
  return null;
}

// Fetch options chain with multi-proxy fallback
async function fetchOptionsChain(symbol, expDate = null) {
  const cacheKey = `${symbol.toUpperCase()}_${expDate || 'default'}`;
  const cached = optionsCache[cacheKey];
  if (cached && Date.now() - cached.time < 60000) return cached.data;

  const sym = symbol.toUpperCase();
  const datePart = expDate ? `?date=${expDate}` : '';

  // Build all proxy+endpoint combos to race in parallel
  const yahooUrls = [
    `https://query1.finance.yahoo.com/v7/finance/options/${sym}${datePart}`,
    `https://query2.finance.yahoo.com/v7/finance/options/${sym}${datePart}`
  ];
  const makeProxies = [
    u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
    u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
    u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
    u => `https://thingproxy.freeboard.io/fetch/${u}`,
    u => `https://cors-anywhere.herokuapp.com/${u}`
  ];

  const allUrls = [];
  for (const yahoo of yahooUrls) {
    for (const make of makeProxies) {
      allUrls.push(make(yahoo));
    }
  }

  function tryProxy(url) {
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 6000);
    return fetch(url, { signal: controller.signal })
      .then(r => { clearTimeout(t); if (!r.ok) throw new Error('bad'); return r.text(); })
      .then(text => {
        if (text.startsWith('<')) throw new Error('html');
        const data = JSON.parse(text);
        const result = data.optionChain?.result?.[0];
        if (!result) throw new Error('no data');
        return {
          symbol: result.quote?.symbol || sym,
          price: result.quote?.regularMarketPrice,
          expirations: result.expirationDates || [],
          strikes: result.strikes || [],
          calls: result.options?.[0]?.calls || [],
          puts: result.options?.[0]?.puts || []
        };
      });
  }

  try {
    const chain = await Promise.any(allUrls.map(tryProxy));
    optionsCache[cacheKey] = { data: chain, time: Date.now() };
    return chain;
  } catch (e) {
    console.warn('All Yahoo proxies failed for', sym, '— generating estimated chain');
  }

  // Fallback: estimated chain from Twelve Data price (always available)
  try {
    const quote = await fetchLiveQuote(sym);
    if (quote && quote.price > 0) {
      const price = quote.price;
      const strikes = [];
      const step = price > 200 ? 5 : price > 50 ? 2.5 : price > 20 ? 1 : 0.5;
      // Wide range: 50% below to 30% above (deep OTM puts for wheel strategy)
      const low = Math.max(step, Math.round((price * 0.30) / step) * step);
      const high = Math.round((price * 2.00) / step) * step;
      for (let s = low; s <= high; s += step) {
        strikes.push(Math.round(s * 100) / 100);
      }
      const iv = 0.35;
      // Find next 6 Fridays (options expire on Fridays)
      const now = Math.floor(Date.now() / 1000);
      const expirations = [];
      const today = new Date();
      const dayOfWeek = today.getDay(); // 0=Sun
      const daysToFri = dayOfWeek <= 5 ? (5 - dayOfWeek) : 6; // days until next Friday
      const firstFri = new Date(today);
      firstFri.setDate(today.getDate() + (daysToFri === 0 ? 7 : daysToFri)); // skip today if already Friday
      firstFri.setHours(16, 0, 0, 0); // market close
      for (let i = 0; i < 6; i++) {
        const fri = new Date(firstFri);
        fri.setDate(firstFri.getDate() + i * 7);
        expirations.push(Math.floor(fri.getTime() / 1000));
      }
      const dte = 30;
      const calls = [], puts = [];
      strikes.forEach(strike => {
        const moneyness = (price - strike) / price;
        const timeVal = price * iv * Math.sqrt(dte / 365) * 0.4;
        const putPrem = Math.max(0, strike - price) + timeVal * Math.exp(-Math.abs(moneyness) * 3);
        const callPrem = Math.max(0, price - strike) + timeVal * Math.exp(-Math.abs(moneyness) * 3);
        puts.push({ strike, bid: Math.max(0.01, putPrem * 0.95), ask: putPrem * 1.05, delta: -Math.max(0.01, Math.min(0.99, 0.5 - moneyness * 2.5)), impliedVolatility: iv });
        calls.push({ strike, bid: Math.max(0.01, callPrem * 0.95), ask: callPrem * 1.05, delta: Math.max(0.01, Math.min(0.99, 0.5 + moneyness * 2.5)), impliedVolatility: iv });
      });
      const chain = { symbol: sym, price, expirations, strikes, calls, puts, estimated: true };
      optionsCache[cacheKey] = { data: chain, time: Date.now() };
      return chain;
    }
  } catch(e) { /* estimated also failed */ }

  return null;
}

// Format expiration date from Unix timestamp
function formatExpDate(ts) {
  const d = new Date(ts * 1000);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
}

// Calculate days to expiration
function calcDTE(ts) {
  return Math.ceil((ts * 1000 - Date.now()) / 86400000);
}
const $=id=>document.getElementById(id);
const show=el=>$(el)?.classList.remove('hidden');
const hide=el=>$(el)?.classList.add('hidden');

// Generate consistent color from ticker symbol
const tickerColors = ['#6366f1','#8b5cf6','#ec4899','#f43f5e','#f97316','#eab308','#22c55e','#14b8a6','#06b6d4','#3b82f6'];
function getTickerColor(sym) {
  let hash = 0;
  for (let i = 0; i < sym.length; i++) hash = sym.charCodeAt(i) + ((hash << 5) - hash);
  return tickerColors[Math.abs(hash) % tickerColors.length];
}

// Custom toast notification
function showToast(msg, type='') {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast' + (type ? ' ' + type : '');
  setTimeout(() => t.classList.add('show'), 10);
  setTimeout(() => t.classList.remove('show'), 3000);
}

// Custom prompt modal
let promptCallback = null;
function showPrompt(title, defaultVal, callback) {
  $('promptTitle').textContent = title;
  $('promptInput').placeholder = defaultVal || '';
  $('promptInput').value = defaultVal || '';
  promptCallback = callback;
  openModal('promptModal');
  setTimeout(() => { $('promptInput').focus(); $('promptInput').select(); }, 100);
}
function submitPrompt() {
  const val = $('promptInput').value.trim();
  closeModal('promptModal');
  const cb = promptCallback;
  promptCallback = null;
  if (cb && val) cb(val);
}
function closePrompt() {
  closeModal('promptModal');
  promptCallback = null;
}
$('promptInput')?.addEventListener('keydown', e => { if (e.key === 'Enter') submitPrompt(); });

// Admin Panel Functions
// Admin access is restricted to specific Firebase UIDs
const ADMIN_UIDS = new Set([
  'EG4Qi2PZVdPfh3PT0SXl0GKQC972'
]);

// EmailJS defaults (hardcoded so alerts work without admin config)
const EMAILJS_DEFAULTS = { publicKey: 'IuC7s7RY-Y2OOQtNw', serviceId: 'service_4vdqrrj', templateId: 'template_k2xol6b' };

// Secret admin access - tap copyright 5 times quickly
let adminTapCount = 0;
let adminTapTimer = null;
function secretAdminTap() {
  adminTapCount++;
  clearTimeout(adminTapTimer);
  if (adminTapCount >= 5) {
    adminTapCount = 0;
    checkAdminAccess();
  } else {
    adminTapTimer = setTimeout(() => { adminTapCount = 0; }, 2000);
  }
}

// Secret premium toggle - tap profile name 5 times (for testing, admin only)
let premiumTapCount = 0;
let premiumTapTimer = null;
function secretPremiumTap() {
  if (!isAdmin()) return;
  premiumTapCount++;
  clearTimeout(premiumTapTimer);
  if (premiumTapCount >= 5) {
    premiumTapCount = 0;
    S.isPremium = !S.isPremium;
    save();
    renderProfile();
    showToast(S.isPremium ? 'Premium activated!' : 'Premium deactivated', S.isPremium ? 'success' : '');
  } else {
    premiumTapTimer = setTimeout(() => { premiumTapCount = 0; }, 2000);
  }
}

function isAdmin() {
  return S.firebaseUid && ADMIN_UIDS.has(S.firebaseUid);
}

function initAdminAccess() {
  document.addEventListener('keydown', e => {
    if (e.ctrlKey && e.shiftKey && e.key === 'A') { e.preventDefault(); checkAdminAccess(); }
  });
}

function checkAdminAccess() {
  if (isAdmin()) {
    S.adminAuthenticated = true;
    openAdmin();
  } else if (S.firebaseUid) {
    // Show UID so it can be added to ADMIN_UIDS
    console.log('Your Firebase UID:', S.firebaseUid);
    showToast('Not authorized. Check console for your UID.', 'error');
  } else {
    showToast('Sign in first', 'error');
  }
}

function openAdmin() {
  if (!isAdmin()) return checkAdminAccess();
  S.adminSigType = 'csp';
  // Populate expiration dropdowns with upcoming Fridays
  const adminExpEl = $('adminExp');
  if (adminExpEl && adminExpEl.tagName === 'SELECT') adminExpEl.innerHTML = '<option value="">Select</option>' + getExpDateOptions();
  const rollExpEl = $('rollNewExp');
  if (rollExpEl && rollExpEl.tagName === 'SELECT') rollExpEl.innerHTML = '<option value="">Select</option>' + getExpDateOptions();
  renderMasterPortfolio();
  renderAdminPosts();
  renderWheelPositions();
  renderAdminUsers();
  loadPostsFromFirebase();
  loadAdminSettings();
  openModal('adminModal');
  // Auto-enable notifications for admin
  if (!S.notifOn && 'Notification' in window && Notification.permission !== 'denied') {
    requestBrowserNotifications().then(granted => {
      if (granted) { S.notifOn = true; save(); }
    });
  }
}

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyANXf3yA7qRE-BuT-PrPW--4eKre-9YqiI",
  authDomain: "market-elites.firebaseapp.com",
  databaseURL: "https://market-elites-default-rtdb.firebaseio.com",
  projectId: "market-elites",
  storageBucket: "market-elites.firebasestorage.app",
  messagingSenderId: "347581977529",
  appId: "1:347581977529:web:7cb9c741577eec19ff1c68"
};

let firebaseReady = false;

// Initialize Firebase (lazy load)
async function initFirebase() {
  if (firebaseReady) return true;
  if (firebaseConfig.apiKey === "YOUR_API_KEY") {
    console.log('Firebase not configured - using localStorage only');
    return false;
  }
  try {
    if (!window.firebase) {
      // Load Firebase SDK - app, auth, and database
      await loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js');
    }
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    firebaseReady = true;
    return true;
  } catch (e) {
    console.error('Firebase init error:', e);
    return false;
  }
}

function loadScript(src) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = src;
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

// Save post to Firebase
async function savePostToFirebase(post) {
  if (!await initFirebase()) {
    // Fallback to localStorage only
    if (!S.adminPosts) S.adminPosts = [];
    if (!S.adminPosts.find(p => p === post || p.id === post.id)) S.adminPosts.unshift(post);
    save();
    return;
  }
  try {
    const db = firebase.database();
    // Strip any local id before pushing so it doesn't conflict with Firebase key on reload
    const { id: _stripId, ...postData } = post;
    const ref = await db.ref('posts').push(postData);
    // Update with Firebase key; only add to local state if not already there
    post.id = ref.key;
    if (!S.adminPosts) S.adminPosts = [];
    if (!S.adminPosts.find(p => p === post || p.id === post.id)) S.adminPosts.unshift(post);
    save();
    renderAdminPosts();
    renderSignals();
    renderAlertsFeed();
    showToast('Posted to all users!', 'success');
  } catch (e) {
    console.error('Firebase save error:', e);
    if (!S.adminPosts) S.adminPosts = [];
    if (!S.adminPosts.find(p => p === post || p.id === post.id)) S.adminPosts.unshift(post);
    save();
    renderAdminPosts();
    renderSignals();
    showToast('Slow connection — signal may still post. Check manage list.', '');
  }
  // Fire-and-forget notifications (don't block UI)
  if (post.kind === 'signal') {
    showBrowserNotification(
      `New ${(post.type||'').toUpperCase()} Signal: ${post.ticker}`,
      `$${post.strike} ${post.type==='csp'?'Put':'Call'} · Exp ${post.exp} · Premium ${post.prem}`
    );
  } else if (post.kind === 'announcement') {
    showBrowserNotification('Market Elites Announcement', post.title || post.message || 'New announcement');
  }
  sendDiscordNotification(post).catch(e => console.warn('Discord notify error:', e));
  sendEmailNotifications(post).catch(e => console.warn('Email notify error:', e));
  sendSmsNotifications(post).catch(e => console.warn('SMS notify error:', e));
}

// Send notification to Discord webhook
async function sendDiscordNotification(post) {
  const webhookUrl = localStorage.getItem('discordWebhook');
  if (!webhookUrl) {
    console.warn('Discord: No webhook URL configured');
    return;
  }

  const brand = {
    name: 'Market Elites',
    icon_url: 'https://raw.githubusercontent.com/elitesbeau/wheel/main/logo.png'
  };

  let embed = {
    timestamp: new Date().toISOString(),
    footer: { text: 'Market Elites · The Wheel Strategy', icon_url: brand.icon_url },
    author: { name: brand.name, icon_url: brand.icon_url }
  };

  if (post.kind === 'signal') {
    const isCsp = post.type === 'csp';
    embed.title = `${isCsp ? '🟢' : '🔵'} NEW ${post.type.toUpperCase()} SIGNAL`;
    embed.color = isCsp ? 0x34c759 : 0x007aff;
    embed.description = [
      `## ${post.ticker}`,
      `**$${post.strike} ${isCsp ? 'Put' : 'Call'}**`,
      '',
      `> ${isCsp ? 'Cash Secured Put' : 'Covered Call'} — Sell to open`
    ].join('\n');
    embed.fields = [
      { name: '📅 Expiration', value: `\`${post.exp || 'N/A'}\``, inline: true },
      { name: '💰 Premium', value: `\`${post.prem || 'N/A'}\``, inline: true },
      { name: '📊 Delta', value: `\`${post.delta || 'N/A'}\``, inline: true }
    ];
    if (post.iv) embed.fields.push({ name: '📈 IV', value: `\`${post.iv}\``, inline: true });
    if (post.notes) embed.fields.push({ name: '📝 Notes', value: post.notes, inline: false });
  } else if (post.kind === 'announcement') {
    embed.title = `📢 ${post.title || 'Announcement'}`;
    embed.description = post.message || post.content || '';
    embed.color = 0xff9500;
  } else if (post.kind === 'roll') {
    embed.title = '🔄 POSITION ROLL';
    embed.color = 0xaf52de;
    embed.description = [
      '**Original →** ' + (post.original || 'N/A'),
      '**New Position →** ' + (post.newPos || 'N/A')
    ].join('\n');
    embed.fields = [{ name: '💵 Credit/Debit', value: `\`${post.credit || 'N/A'}\``, inline: true }];
    if (post.notes) embed.fields.push({ name: '📝 Notes', value: post.notes, inline: false });
  } else if (post.kind === 'winner') {
    embed.title = `🎉 WINNER — ${post.ticker}`;
    embed.color = 0x34c759;
    embed.description = [
      `**${(post.type||'').toUpperCase()} $${post.strike} ${post.type==='csp'?'Put':'Call'}** closed for profit!`,
      '',
      '> Another successful wheel cycle 💪'
    ].join('\n');
    embed.fields = [
      { name: '💰 Premium', value: `\`${post.prem || 'N/A'}\``, inline: true },
      { name: '📅 Expiration', value: `\`${post.exp || 'N/A'}\``, inline: true }
    ];
  } else if (post.kind === 'assigned') {
    embed.title = `📦 ASSIGNED — ${post.ticker}`;
    embed.color = 0xff9500;
    embed.description = [
      `**CSP $${post.strike} Put** was assigned`,
      '',
      '> Now holding 100 shares — time to sell covered calls! 🔄'
    ].join('\n');
  } else if (post.kind === 'called') {
    embed.title = `📤 CALLED AWAY — ${post.ticker}`;
    embed.color = 0x007aff;
    embed.description = [
      `**CC $${post.strike} Call** was exercised`,
      '',
      '> Shares sold at strike — back to selling puts! 🔄'
    ].join('\n');
  } else {
    // Generic fallback
    embed.title = '📋 New Update';
    embed.description = post.content || post.message || '';
    embed.color = 0x86868b;
  }

  try {
    const res = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username: 'Market Elites',
        avatar_url: brand.icon_url,
        embeds: [embed]
      })
    });
    if (!res.ok) {
      const errText = await res.text().catch(() => '');
      console.error('Discord webhook failed:', res.status, errText);
      showToast('Discord alert failed: ' + res.status, 'error');
    }
  } catch (e) {
    console.error('Discord webhook error:', e);
    showToast('Discord alert failed to send', 'error');
  }
}

// Test Discord webhook
async function testDiscordWebhook() {
  const webhookUrl = $('discordWebhook')?.value.trim() || localStorage.getItem('discordWebhook');
  if (!webhookUrl) {
    showToast('Enter a Discord webhook URL first', 'error');
    return;
  }
  // Save it first
  localStorage.setItem('discordWebhook', webhookUrl);

  showToast('Sending test message...', '');
  await sendDiscordNotification({
    kind: 'announcement',
    title: 'Connection Test',
    message: '**Discord alerts are live!** 🟢\n\nYou\'ll receive notifications here when new signals, winners, and announcements are posted.\n\n*— Market Elites*',
    timestamp: Date.now()
  });
}

// Save admin settings
function saveAdminSettings() {
  const webhook = $('discordWebhook')?.value.trim();
  if (webhook) localStorage.setItem('discordWebhook', webhook);

  // Save Stripe Payment Link
  const stripeLink = $('stripePaymentLink')?.value.trim();
  if (stripeLink) localStorage.setItem('stripePaymentLink', stripeLink);
  else localStorage.removeItem('stripePaymentLink');

  // Save EmailJS settings
  const publicKey = $('emailjsPublicKey')?.value.trim();
  const serviceId = $('emailjsServiceId')?.value.trim();
  const templateId = $('emailjsTemplateId')?.value.trim();
  if (publicKey) localStorage.setItem('emailjsPublicKey', publicKey);
  if (serviceId) localStorage.setItem('emailjsServiceId', serviceId);
  if (templateId) localStorage.setItem('emailjsTemplateId', templateId);

  // Initialize EmailJS if configured
  if (publicKey && typeof emailjs !== 'undefined') {
    emailjs.init(publicKey);
  }

  showToast('Settings saved!', 'success');
}

// Load admin settings
function loadAdminSettings() {
  const webhook = localStorage.getItem('discordWebhook');
  if (webhook && $('discordWebhook')) $('discordWebhook').value = webhook;

  // Load Stripe Payment Link
  const stripeLink = localStorage.getItem('stripePaymentLink');
  if (stripeLink && $('stripePaymentLink')) $('stripePaymentLink').value = stripeLink;

  // Load EmailJS settings (with hardcoded defaults)
  const publicKey = localStorage.getItem('emailjsPublicKey') || EMAILJS_DEFAULTS.publicKey;
  const serviceId = localStorage.getItem('emailjsServiceId') || EMAILJS_DEFAULTS.serviceId;
  const templateId = localStorage.getItem('emailjsTemplateId') || EMAILJS_DEFAULTS.templateId;
  if ($('emailjsPublicKey')) $('emailjsPublicKey').value = publicKey;
  if ($('emailjsServiceId')) $('emailjsServiceId').value = serviceId;
  if ($('emailjsTemplateId')) $('emailjsTemplateId').value = templateId;

  // Initialize EmailJS
  if (publicKey && typeof emailjs !== 'undefined') {
    emailjs.init(publicKey);
  }

}

// Send email notifications to subscribed users
async function sendEmailNotifications(post) {
  const publicKey = localStorage.getItem('emailjsPublicKey') || EMAILJS_DEFAULTS.publicKey;
  const serviceId = localStorage.getItem('emailjsServiceId') || EMAILJS_DEFAULTS.serviceId;
  const templateId = localStorage.getItem('emailjsTemplateId') || EMAILJS_DEFAULTS.templateId;

  if (!publicKey || !serviceId || !templateId) return;

  // Get subscribed emails from Firebase
  if (!await initFirebase()) return;

  try {
    const db = firebase.database();
    const snapshot = await db.ref('emailSubscribers').once('value');
    const subscribers = snapshot.val() || {};

    // Build email content based on post type
    let subject = '', body = '';
    if (post.kind === 'winner') {
      subject = `🎉 WINNER! ${post.ticker} Closed for Profit!`;
      body = `Congratulations! Another winning trade!\n\n${post.type.toUpperCase()} ${post.ticker} $${post.strike} ${post.type === 'csp' ? 'Put' : 'Call'}\nExpiration: ${post.exp}\nPremium Collected: ${post.prem}\n\nThis position has been closed for profit! 🎉`;
    } else if (post.kind === 'signal') {
      subject = `🚨 New ${post.type.toUpperCase()} Signal - ${post.ticker}`;
      body = `New ${post.type === 'csp' ? 'Cash Secured Put' : 'Covered Call'} Signal!\n\nTicker: ${post.ticker}\nStrike: $${post.strike}\nExpiration: ${post.exp}\nPremium: ${post.prem}\nDelta: ${post.delta}`;
    } else if (post.kind === 'announcement') {
      subject = `📢 ${post.title}`;
      body = post.message;
    } else if (post.kind === 'roll') {
      subject = `🔄 Position Roll Alert`;
      body = `Rolling position:\n${post.original} → ${post.newPos}\nCredit/Debit: ${post.credit}${post.notes ? '\nNotes: ' + post.notes : ''}`;
    } else if (post.kind === 'assigned') {
      subject = `📦 ${post.ticker} Assigned - Wheel Continues!`;
      body = `Your CSP on ${post.ticker} $${post.strike} was assigned!\n\nYou now own 100 shares at $${post.strike}.\nNext step: Sell covered calls to continue the wheel strategy.`;
    } else if (post.kind === 'called') {
      subject = `📤 ${post.ticker} Called Away - Wheel Complete!`;
      body = `Your CC on ${post.ticker} $${post.strike} was exercised!\n\nShares sold at $${post.strike}.\nWheel cycle complete! Time to start selling CSPs again.`;
    }

    // Send to each subscriber
    for (const [key, sub] of Object.entries(subscribers)) {
      if (sub.active && sub.email) {
        try {
          await emailjs.send(serviceId, templateId, {
            to_email: sub.email,
            to_name: sub.name || '',
            subject: subject,
            message: body,
            from_name: 'Market Elites',
            reply_to: 'noreply@marketelites.com'
          });
        } catch (e) {
          console.error('Email send error:', e);
        }
      }
    }
  } catch (e) {
    console.error('Email notification error:', e);
  }
}

// Send SMS notifications via email-to-SMS gateway
async function sendSmsNotifications(post) {
  const publicKey = localStorage.getItem('emailjsPublicKey') || EMAILJS_DEFAULTS.publicKey;
  const serviceId = localStorage.getItem('emailjsServiceId') || EMAILJS_DEFAULTS.serviceId;
  const templateId = localStorage.getItem('emailjsTemplateId') || EMAILJS_DEFAULTS.templateId;
  if (!publicKey || !serviceId || !templateId) return;
  if (!await initFirebase()) return;
  try {
    const snapshot = await firebase.database().ref('smsSubscribers').once('value');
    const subs = snapshot.val() || {};
    // Build short SMS message (160 char limit)
    let msg = '';
    if (post.kind === 'signal') {
      msg = `ME Signal: ${post.type.toUpperCase()} ${post.ticker} $${post.strike} ${post.type==='csp'?'Put':'Call'} Exp ${post.exp} Prem ${post.prem}`;
    } else if (post.kind === 'winner') {
      msg = `ME Winner! ${post.ticker} $${post.strike} closed for profit!`;
    } else if (post.kind === 'assigned') {
      msg = `ME: ${post.ticker} $${post.strike} CSP assigned - 100 shares acquired`;
    } else if (post.kind === 'called') {
      msg = `ME: ${post.ticker} $${post.strike} CC called away - wheel complete`;
    } else if (post.kind === 'announcement') {
      msg = `ME: ${(post.title || post.message || '').slice(0, 140)}`;
    } else if (post.kind === 'roll') {
      msg = `ME Roll: ${post.original} -> ${post.newPos}`;
    } else {
      return; // Unknown kind, skip SMS
    }
    for (const [uid, sub] of Object.entries(subs)) {
      if (sub.active && sub.phone && sub.carrier) {
        const smsEmail = sub.phone.replace(/\D/g, '') + '@' + sub.carrier;
        try {
          // For SMS: put signal text in subject (many gateways display it)
          // Keep message minimal — EmailJS template wraps it with boilerplate
          await emailjs.send(serviceId, templateId, {
            to_email: smsEmail,
            to_name: '',
            subject: msg,
            message: msg,
            from_name: '',
            reply_to: ''
          });
        } catch (e) {
          console.warn('SMS send error for', uid, e);
        }
      }
    }
  } catch (e) {
    console.error('SMS notification error:', e);
  }
}

// Toggle email alerts for user
function toggleEmailAlerts() {
  S.emailAlerts = !S.emailAlerts;
  const sw = $('emailAlertSwitch');
  if (sw) sw.classList.toggle('on', S.emailAlerts);
  save();
  if (S.emailAlerts) {
    showToast('Email alerts enabled', 'success');
  } else {
    showToast('Email alerts disabled', '');
  }
}

function toggleDiscordAlerts() {
  S.discordAlerts = !S.discordAlerts;
  const sw = $('discordSwitch');
  if (sw) sw.classList.toggle('on', S.discordAlerts);
  save();
  showToast(S.discordAlerts ? 'Discord alerts enabled' : 'Discord alerts disabled', S.discordAlerts ? 'success' : '');
}

async function toggleSmsAlerts() {
  const phone = S.user.phone || $('userPhone')?.value.trim();
  const carrier = S.user.carrier || $('userCarrier')?.value;
  if (!phone) {
    showToast('Add your phone number in Account first', 'error');
    return;
  }
  if (!carrier) {
    showToast('Select your mobile carrier in Account first', 'error');
    return;
  }
  S.smsAlerts = !S.smsAlerts;
  const sw = $('smsSwitch');
  if (sw) sw.classList.toggle('on', S.smsAlerts);
  save();
  // Save/remove SMS subscription in Firebase
  if (await initFirebase() && S.firebaseUid) {
    const ref = firebase.database().ref('smsSubscribers/' + S.firebaseUid);
    if (S.smsAlerts) {
      ref.set({ phone: phone.replace(/\D/g, ''), carrier, active: true }).catch(() => {});
    } else {
      ref.remove().catch(() => {});
    }
  }
  showToast(S.smsAlerts ? 'SMS alerts enabled' : 'SMS alerts disabled', S.smsAlerts ? 'success' : '');
}

// Save email subscription to Firebase
async function saveEmailSubscription() {
  const email = $('userAlertEmail')?.value.trim();
  if (!email || !email.includes('@')) {
    showToast('Please enter a valid email', 'error');
    return;
  }

  if (!await initFirebase()) {
    // Save locally if Firebase not available
    S.alertEmail = email;
    save();
    showToast('Email saved locally', 'success');
    return;
  }

  try {
    const db = firebase.database();
    const emailKey = email.replace(/[.#$[\]]/g, '_'); // Firebase-safe key
    await db.ref('emailSubscribers/' + emailKey).set({
      email: email,
      name: S.user.name || '',
      active: true,
      subscribedAt: Date.now(),
      uid: S.firebaseUid || null
    });
    S.alertEmail = email;
    S.emailAlerts = true;
    const sw = $('emailAlertSwitch');
    if (sw) sw.classList.toggle('on', true);
    save();
    showToast('Email alerts subscribed!', 'success');
  } catch (e) {
    console.error('Subscription error:', e);
    showToast('Failed to subscribe', 'error');
  }
}

// Load user email settings
function loadEmailSettings() {
  if (S.alertEmail && $('userAlertEmail')) $('userAlertEmail').value = S.alertEmail;
  const sw = $('emailAlertSwitch');
  if (sw) sw.classList.toggle('active', S.emailAlerts !== false);
}

// Load posts from Firebase
async function loadPostsFromFirebase(skipRender) {
  if (!await initFirebase()) return;
  try {
    const db = firebase.database();
    const snapshot = await db.ref('posts').orderByChild('timestamp').limitToLast(50).once('value');
    const posts = [];
    snapshot.forEach(child => {
      posts.unshift({ ...child.val(), id: child.key });
    });
    // Filter out locally deleted posts that Firebase hasn't processed yet
    const filtered = posts.filter(p => !_deletedPostIds.has(p.id));
    if (filtered.length > 0 || !S.adminPosts || S.adminPosts.length === 0) {
      S.adminPosts = filtered;
      save();
    }
    if (!skipRender) {
      renderAdminPosts();
      renderSignals();
    }
  } catch (e) {
    console.error('Firebase load error:', e);
  }
}

// Delete post from Firebase
async function deletePostFromFirebase(postId) {
  if (!await initFirebase()) return;
  try {
    const db = firebase.database();
    await db.ref('posts/' + postId).remove();
  } catch (e) {
    console.error('Firebase delete error:', e);
  }
}

// Listen for real-time updates (for all users)
// Track which winners we've celebrated to avoid duplicates
const celebratedWinners = new Set();
const notifiedPosts = new Set();
let initialPostsLoaded = false;

async function listenToFirebasePosts() {
  if (!await initFirebase()) return;
  try {
    const db = firebase.database();
    db.ref('posts').orderByChild('timestamp').limitToLast(50).on('value', snapshot => {
      const posts = [];
      snapshot.forEach(child => {
        posts.unshift({ ...child.val(), id: child.key });
      });

      // On first load, mark all existing posts as already notified
      if (!initialPostsLoaded) {
        posts.forEach(p => { if (p.id) notifiedPosts.add(p.id); });
        initialPostsLoaded = true;
      } else {
        // Notify about genuinely new posts (not from admin who just posted)
        posts.forEach(p => {
          if (p.id && !notifiedPosts.has(p.id)) {
            notifiedPosts.add(p.id);
            // Browser notification for all users (including admin for testing)
            if (p.kind === 'signal') {
              showBrowserNotification(
                `New ${(p.type||'').toUpperCase()} Signal: ${p.ticker}`,
                `$${p.strike} ${p.type==='csp'?'Put':'Call'} · Exp ${p.exp} · Premium ${p.prem}`
              );
            } else if (p.kind === 'winner') {
              showBrowserNotification(
                `Winner! ${p.ticker}`,
                p.content || 'A position was closed for profit!'
              );
            } else if (p.kind === 'announcement') {
              showBrowserNotification(
                'Market Elites Announcement',
                p.content || 'New announcement posted'
              );
            }
            // Discord handled by notifyPost() on creation — not here (avoids double-send)
          }
        });
      }

      // Check for new winners to celebrate
      posts.forEach(p => {
        if (p.status === 'winner' && p.id && !celebratedWinners.has(p.id)) {
          // Only celebrate if this is recent (within last 30 seconds)
          if (p.closedAt && Date.now() - p.closedAt < 30000) {
            celebratedWinners.add(p.id);
            if (!S.adminAuthenticated) { // Don't double-celebrate on admin side
              showCelebration(p);
            }
          } else {
            // Mark as already celebrated if it's old
            celebratedWinners.add(p.id);
          }
        }
      });

      // Always use Firebase as source of truth when it returns data
      // Filter out locally deleted posts (prevents re-add before Firebase propagates)
      if (posts.length > 0) {
        S.adminPosts = posts.filter(p => !_deletedPostIds.has(p.id));
        save();
        // Clean up _deletedPostIds once Firebase confirms the post is actually gone
        _deletedPostIds.forEach(id => {
          if (!posts.find(p => p.id === id)) _deletedPostIds.delete(id);
        });
      }

      // Clean orphaned history after Firebase sync (source of truth updated)
      cleanOrphanedHistory();

      // Auto-sync copied positions when signal status changes
      syncCopiedPositions(posts);

      renderSignals();
      renderAdminPosts();
      renderAlertsFeed();
      renderHome();
      renderMasterPortfolio();
    });
  } catch (e) {
    console.error('Firebase listen error:', e);
  }
}

function syncCopiedPositions(posts) {
  let changed = false;
  (S.positions || []).forEach(pos => {
    if (!pos.signalId) return;
    const signal = posts.find(p => p.id === pos.signalId);
    if (!signal || !signal.status || signal.status === 'open') return;
    if (pos.signalStatus === signal.status) return; // already synced

    pos.signalStatus = signal.status;
    changed = true;

    if (signal.status === 'winner') {
      // Auto-close as winner: expired worthless, full premium kept
      const contracts = pos.contracts || 1;
      const fee = (S.feePerContract || 0) * contracts;
      const totalFees = (pos.fees || 0) + fee;
      const grossPnl = (pos.premium || 0) * contracts * 100;
      const pnl = grossPnl - totalFees;
      S.history = S.history || [];
      S.history.unshift({...pos, closeDate: new Date().toISOString(), pnl, grossPnl, fees: totalFees, outcome: 'expired', autoSynced: true});
      S.positions = S.positions.filter(x => x.id !== pos.id);
      showToast(`${pos.symbol} signal closed as WINNER! +$${pnl.toFixed(0)}`, 'success');
    } else if (signal.status === 'closed') {
      S.positions = S.positions.filter(x => x.id !== pos.id);
      showToast(`${pos.symbol} signal marked CLOSED by admin`, '');
    }
    // assigned/rolled/called: keep position but show updated status
  });
  if (changed) { save(); renderHome(); }
}

// Listen for winners (backup method)
async function listenForWinners() {
  if (!await initFirebase()) return;
  // Pre-populate celebrated winners to avoid showing old celebrations on load
  const posts = S.adminPosts || [];
  posts.forEach(p => {
    if (p.status === 'winner' && p.id) celebratedWinners.add(p.id);
  });
}

function setAdminTab(tab) {
  $('adminSignalBtn').classList.toggle('active', tab === 'signal');
  $('adminAnnBtn').classList.toggle('active', tab === 'announcement');
  $('adminRollBtn').classList.toggle('active', tab === 'roll');
  $('adminSignalForm').classList.toggle('hidden', tab !== 'signal');
  $('adminAnnForm').classList.toggle('hidden', tab !== 'announcement');
  $('adminRollForm').classList.toggle('hidden', tab !== 'roll');

  // Populate roll position selector when roll tab is opened
  if (tab === 'roll') populateRollSelector();
}

// Populate the roll position selector with open positions
function populateRollSelector() {
  const select = $('rollPositionSelect');
  if (!select) return;

  const posts = S.adminPosts || [];
  const openSignals = posts.filter(p => p.kind === 'signal' && (!p.status || p.status === 'open'));

  select.innerHTML = '<option value="">-- Select a position --</option>' +
    openSignals.map(p => {
      const posStr = `${p.ticker} $${p.strike}${p.type === 'csp' ? 'P' : 'C'} ${p.exp}`;
      return `<option value="${p.id}">${p.type.toUpperCase()} - ${posStr} · ${p.prem || ''}</option>`;
    }).join('');

  // Reset roll form state
  rollSelectedPost = null;
  const origInfo = $('rollOrigInfo');
  const newFields = $('rollNewFields');
  if (origInfo) origInfo.style.display = 'none';
  if (newFields) newFields.style.display = 'none';
}

// Fill roll form from selected position
let rollSelectedPost = null;
function fillRollFromPosition() {
  const select = $('rollPositionSelect');
  const origInfo = $('rollOrigInfo');
  const newFields = $('rollNewFields');
  if (!select || !select.value) {
    rollSelectedPost = null;
    if (origInfo) origInfo.style.display = 'none';
    if (newFields) newFields.style.display = 'none';
    return;
  }

  const posts = S.adminPosts || [];
  const p = posts.find(x => x.id === select.value);
  if (!p) return;
  rollSelectedPost = p;

  const posStr = `${p.type.toUpperCase()} ${p.ticker} $${p.strike}${p.type === 'csp' ? 'P' : 'C'} · Exp ${p.exp}`;
  const origPrem = parseFloat((p.prem || '').replace(/[$,]/g, '')) || 0;
  $('rollOrigLabel').textContent = posStr;
  $('rollOrigDetails').textContent = `Premium collected: $${origPrem.toFixed(2)}/share`;
  origInfo.style.display = 'block';
  newFields.style.display = 'block';

  // Pre-fill
  $('rollNewStrike').value = '';
  $('rollNewExp').value = '';
  $('rollNewPrem').value = '';
  $('rollOrigPrem').textContent = '$' + (origPrem * 100).toFixed(0);

  // Track accumulated roll premiums from previous rolls
  const totalPrevPrem = (p.rollHistory || []).reduce((s, r) => s + (r.premiumPerShare || 0), 0);
  rollSelectedPost._totalPrevPrem = origPrem + totalPrevPrem;

  updateRollSummary();
  $('rollChainPicker').style.display = 'none';
}

function updateRollSummary() {
  if (!rollSelectedPost) return;
  const origPrem = parseFloat((rollSelectedPost.prem || '').replace(/[$,]/g, '')) || 0;
  const totalPrev = rollSelectedPost._totalPrevPrem || origPrem;
  const newPrem = parseFloat($('rollNewPrem')?.value) || 0;
  const total = totalPrev + newPrem;

  $('rollOrigPrem').textContent = '$' + (totalPrev * 100).toFixed(0);
  $('rollNewPremAmt').textContent = newPrem > 0 ? '+$' + (newPrem * 100).toFixed(0) : '$0';
  $('rollTotalPrem').textContent = '$' + (total * 100).toFixed(0);
}

async function loadRollChain() {
  if (!rollSelectedPost) return showToast('Select a position first', 'error');
  const ticker = rollSelectedPost.ticker;
  const picker = $('rollChainPicker');
  picker.style.display = 'block';
  $('rollChainStrikes').innerHTML = '<div style="padding:16px;text-align:center"><div class="spinner" style="margin:0 auto"></div><p style="font-size:12px;color:var(--text3);margin-top:8px">Loading chain...</p></div>';

  try {
    const chain = await fetchOptionsChain(ticker);
    if (!chain || !chain.expirations) { $('rollChainStrikes').innerHTML = '<p style="padding:12px;text-align:center;color:var(--text3);font-size:12px">No data found</p>'; return; }

    const expsDiv = $('rollChainExps');
    expsDiv.innerHTML = chain.expirations.slice(0, 6).map((exp, i) => {
      const d = new Date(exp * 1000);
      const label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      return `<button class="chip-btn${i===0?' active':''}" onclick="selectRollExp(${exp},'${label}',this)">${label}</button>`;
    }).join('');

    if (chain.expirations.length > 0) selectRollExp(chain.expirations[0], '', null);
  } catch (e) {
    $('rollChainStrikes').innerHTML = `<p style="padding:12px;text-align:center;color:var(--red);font-size:12px">Error: ${e.message}</p>`;
  }
}

async function selectRollExp(exp, label, btn) {
  if (btn) {
    btn.parentElement.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  if (!rollSelectedPost) return;
  const isCsp = rollSelectedPost.type === 'csp';
  $('rollChainStrikes').innerHTML = '<div style="padding:12px;text-align:center"><div class="spinner" style="margin:0 auto"></div></div>';

  try {
    const chain = await fetchOptionsChain(rollSelectedPost.ticker, exp);
    if (!chain) return;
    const options = isCsp ? chain.puts : chain.calls;
    const price = chain.price || 0;
    const strikes = options
      .filter(o => o.lastPrice > 0 || o.bid > 0)
      .sort((a, b) => Math.abs(a.strike - price) - Math.abs(b.strike - price))
      .slice(0, 25)
      .sort((a, b) => isCsp ? b.strike - a.strike : a.strike - b.strike);

    const d = new Date(exp * 1000);
    const expLabel = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

    $('rollChainStrikes').innerHTML = strikes.length ? strikes.map(o => {
      const itm = isCsp ? o.strike >= price : o.strike <= price;
      const premPrice = o.bid > 0 ? ((o.bid + (o.ask||o.bid)) / 2) : o.lastPrice;
      const itmLabel = itm ? '<span style="font-size:10px;color:var(--orange)">ITM </span>' : '';
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border);cursor:pointer;font-size:13px${itm?';background:rgba(255,149,0,0.06)':''}" onclick="pickRollStrike(${o.strike},${premPrice.toFixed(2)},'${expLabel}')">
        <span style="font-weight:600">${itmLabel}$${o.strike}</span>
        <span style="color:var(--green)">$${premPrice.toFixed(2)}</span>
      </div>`; }).join('') : '<p style="padding:12px;text-align:center;color:var(--text3);font-size:12px">No options found</p>';
  } catch (e) {
    $('rollChainStrikes').innerHTML = `<p style="padding:12px;color:var(--red);font-size:12px">${e.message}</p>`;
  }
}

function pickRollStrike(strike, premium, exp) {
  $('rollNewStrike').value = strike;
  $('rollNewPrem').value = premium;
  const expSel = $('rollNewExp');
  expSel.value = exp;
  if (!expSel.value) { const o = document.createElement('option'); o.value = exp; o.textContent = exp; expSel.insertBefore(o, expSel.firstChild?.nextSibling); expSel.value = exp; }
  $('rollChainPicker').style.display = 'none';
  updateRollSummary();
}

// Admin chain picker
let adminChainData = null;
let adminTickerTimer = null;

function adminQuickTicker(sym) {
  $('adminTicker').value = sym;
  document.querySelectorAll('#adminSignalForm .chip-btn').forEach(b => b.classList.toggle('active', b.textContent === sym));
  loadAdminChain();
}

// Admin ticker also loads on Enter key
document.addEventListener('DOMContentLoaded', () => {
  const adminInput = $('adminTicker');
  if (adminInput) adminInput.addEventListener('keydown', e => { if (e.key === 'Enter') loadAdminChain(); });
  const addInput = $('addSymbol');
  if (addInput) addInput.addEventListener('keydown', e => { if (e.key === 'Enter') loadAddChainBtn(); });
});

async function loadAdminChain() {
  const sym = $('adminTicker').value.trim().toUpperCase();
  if (!sym) { showToast('Type a ticker first', 'error'); return; }

  // Show loading state on button
  const btn = document.querySelector('#adminSignalForm .btn[onclick*="loadAdminChain"]');
  if (btn) { btn.disabled = true; btn.textContent = 'Loading...'; }
  $('adminTickerInfo').innerHTML = `Loading <b>${sym}</b>...`;

  try {
    const quote = await fetchLiveQuote(sym);
    if (quote) {
      const color = quote.change >= 0 ? 'var(--green)' : 'var(--red)';
      $('adminTickerInfo').innerHTML = `<b>${sym}</b> $${quote.price.toFixed(2)} <span style="color:${color}">${quote.change >= 0?'+':''}${quote.change.toFixed(2)} (${quote.changePercent}%)</span>`;
    } else {
      $('adminTickerInfo').innerHTML = `<span style="color:var(--orange)">${sym} — could not fetch price. Enter details manually below.</span>`;
    }
  } catch(e) {
    $('adminTickerInfo').innerHTML = `<span style="color:var(--orange)">Price fetch failed for ${sym}</span>`;
  }

  try {
    const chain = await fetchOptionsChain(sym);
    if (chain && (chain.puts.length || chain.calls.length)) {
      adminChainData = chain;
      $('adminChainPicker').style.display = 'block';

      const exps = (chain.expirations || []).slice(0, 6);
      $('adminChainExps').innerHTML = exps.map((exp, i) =>
        `<button class="chain-exp-btn${i===0?' active':''}" onclick="selectAdminExp(${exp},this)">${formatExpDate(exp)} (${calcDTE(exp)}d)</button>`
      ).join('');

      renderAdminChain(chain);
      showToast(chain.estimated ? 'Estimated chain loaded (live data unavailable)' : 'Chain loaded! Tap a strike to auto-fill.', chain.estimated ? '' : 'success');
    } else {
      $('adminChainPicker').style.display = 'none';
      $('adminTickerInfo').innerHTML += ' <span style="color:var(--orange)">· No options chain available — use manual entry</span>';
      showToast('Options chain unavailable. Use manual entry fields below.', 'error');
    }
  } catch(e) {
    $('adminChainPicker').style.display = 'none';
    $('adminTickerInfo').innerHTML += ' <span style="color:var(--orange)">· Chain fetch failed — use manual entry</span>';
    showToast('Chain fetch failed. Use manual entry fields below.', 'error');
    console.error('Admin chain error:', e);
  }

  // Restore button
  if (btn) { btn.disabled = false; btn.textContent = 'Load Chain'; }

}

function selectAdminExp(expTs, btn) {
  $('adminChainExps').querySelectorAll('.chain-exp-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const sym = $('adminTicker').value.trim().toUpperCase();
  fetchOptionsChain(sym, expTs).then(chain => {
    if (chain) { adminChainData = chain; renderAdminChain(chain); }
  });
}

function renderAdminChain(chain) {
  const isCsp = (S.adminSigType || 'csp') === 'csp';
  const options = isCsp ? (chain.puts || []) : (chain.calls || []);
  const price = chain.price || 0;

  // For CSPs: show 2 above current price + 50 below (deep OTM puts)
  // For CCs: show 2 below current price + 50 above (deep OTM calls)
  let near;
  if (isCsp) {
    const above = options.filter(o => o.strike >= price).sort((a,b) => a.strike - b.strike).slice(0, 2);
    const below = options.filter(o => o.strike < price).sort((a,b) => b.strike - a.strike).slice(0, 50);
    near = [...above, ...below].sort((a,b) => b.strike - a.strike);
  } else {
    const below = options.filter(o => o.strike <= price).sort((a,b) => b.strike - a.strike).slice(0, 2);
    const above = options.filter(o => o.strike > price).sort((a,b) => a.strike - b.strike).slice(0, 50);
    near = [...below, ...above].sort((a,b) => b.strike - a.strike);
  }

  $('adminChainStrikes').innerHTML = `
    <div class="chain-row" style="background:var(--input);font-size:10px;font-weight:600;color:var(--text3);cursor:default;padding:6px 8px">
      <div style="flex:1">Strike</div><div style="width:50px;text-align:right">Bid</div><div style="width:50px;text-align:right">Ask</div><div style="width:35px;text-align:right">Δ</div><div style="width:35px;text-align:right">IV</div>
    </div>
  ` + near.map(o => {
    const delta = o.delta ? Math.abs(o.delta).toFixed(2) : '—';
    const iv = o.impliedVolatility ? (o.impliedVolatility * 100).toFixed(0) + '%' : '—';
    const atm = Math.abs(o.strike - price) / price < 0.01;
    return `<div class="chain-row" style="padding:6px 8px;font-size:12px" onclick="pickAdminOption(${o.strike},${o.bid||0},${o.ask||0},${o.delta||0},${o.impliedVolatility||0})">
      <div style="flex:1;font-weight:600;${atm?'color:var(--blue)':''}">$${o.strike}${atm?' ◄':''}</div>
      <div style="width:50px;text-align:right;color:var(--green)">${(o.bid||0).toFixed(2)}</div>
      <div style="width:50px;text-align:right">${(o.ask||0).toFixed(2)}</div>
      <div style="width:35px;text-align:right;font-size:11px">${delta}</div>
      <div style="width:35px;text-align:right;font-size:11px">${iv}</div>
    </div>`;
  }).join('');
}

function pickAdminOption(strike, bid, ask, delta, iv) {
  const mid = ((bid + ask) / 2).toFixed(2);
  $('adminStrike').value = strike;
  $('adminPrem').value = '$' + mid;
  $('adminDelta').value = delta ? Math.abs(delta).toFixed(2) : '';

  // Get expiration from active tab
  const activeExp = $('adminChainExps')?.querySelector('.chain-exp-btn.active');
  if (activeExp) {
    const expVal = activeExp.textContent.split('(')[0].trim();
    const sel = $('adminExp');
    sel.value = expVal;
    // If the value from chain isn't in the dropdown, add it
    if (!sel.value) {
      const opt = document.createElement('option');
      opt.value = expVal; opt.textContent = expVal;
      sel.insertBefore(opt, sel.firstChild.nextSibling);
      sel.value = expVal;
    }
  }

  // Highlight
  $('adminChainStrikes').querySelectorAll('.chain-row').forEach(r => r.classList.remove('selected'));
  event.currentTarget.classList.add('selected');

  showToast(`Selected $${strike} · Premium $${mid}`, 'success');
}

async function postSignal() {
  const notes = $('adminNotes')?.value.trim() || '';
  const sig = {
    type: S.adminSigType || 'csp',
    ticker: $('adminTicker').value.toUpperCase().trim(),
    strike: parseFloat($('adminStrike').value) || 0,
    exp: $('adminExp').value.trim(),
    prem: $('adminPrem').value.trim(),
    delta: $('adminDelta').value.trim(),
    notes: notes || undefined,
    time: 'Just now',
    timestamp: Date.now(),
    kind: 'signal'
  };
  if (!sig.ticker || !sig.strike) return showToast('Fill ticker and strike', 'error');
  // Validate expiration isn't in the past
  if (sig.exp) {
    const expDate = new Date(sig.exp);
    if (!isNaN(expDate) && expDate < new Date(new Date().toDateString())) {
      return showToast('Expiration date is in the past', 'error');
    }
  }
  try {
    await savePostToFirebase(sig);
  } catch(e) {
    console.error('postSignal error:', e);
    showToast('Error posting signal: ' + e.message, 'error');
    return;
  }
  $('adminTicker').value = '';
  $('adminStrike').value = '';
  $('adminExp').value = '';
  $('adminPrem').value = '';
  $('adminDelta').value = '';
  if ($('adminNotes')) $('adminNotes').value = '';
  $('adminTickerInfo').textContent = '';
  $('adminChainPicker').style.display = 'none';
  adminChainData = null;
}

async function postAnnouncement() {
  const ann = {
    title: $('annTitle').value.trim(),
    message: $('annMsg').value.trim(),
    time: 'Just now',
    timestamp: Date.now(),
    kind: 'announcement'
  };
  if (!ann.title || !ann.message) return showToast('Fill title and message', 'error');
  await savePostToFirebase(ann);
  $('annTitle').value = '';
  $('annMsg').value = '';
  renderAdminPosts();
  renderSignals();
}

async function postRoll() {
  if (!rollSelectedPost) return showToast('Select a position to roll', 'error');
  const newStrike = parseFloat($('rollNewStrike')?.value);
  const newExp = $('rollNewExp')?.value?.trim();
  const newPrem = parseFloat($('rollNewPrem')?.value) || 0;
  if (!newStrike || !newExp) return showToast('Enter new strike and expiration', 'error');

  const origPost = rollSelectedPost;
  const origPrem = parseFloat((origPost.prem || '').replace(/[$,]/g, '')) || 0;
  const origStr = `${origPost.ticker} $${origPost.strike}${origPost.type==='csp'?'P':'C'} ${origPost.exp}`;
  const newStr = `${origPost.ticker} $${newStrike}${origPost.type==='csp'?'P':'C'} ${newExp}`;
  const totalPrevPrem = origPost._totalPrevPrem || origPrem;
  const totalPrem = totalPrevPrem + newPrem;

  // 1. Mark original as rolled
  origPost.status = 'rolled';
  origPost.closedAt = Date.now();
  if (await initFirebase() && origPost.id) {
    firebase.database().ref('posts/' + origPost.id).update({ status: 'rolled', closedAt: Date.now() }).catch(e => console.warn(e));
  }

  // 2. Post the roll update notification
  const rollNotif = {
    original: origStr,
    newPos: newStr,
    credit: newPrem > 0 ? `+$${(newPrem*100).toFixed(0)} credit` : 'even',
    notes: $('rollNotes')?.value?.trim() || '',
    time: 'Just now',
    timestamp: Date.now(),
    kind: 'roll'
  };
  await savePostToFirebase(rollNotif);

  // 3. Create new signal for the rolled position (carries forward premium history)
  const newSignal = {
    type: origPost.type,
    ticker: origPost.ticker,
    strike: newStrike,
    exp: newExp,
    prem: '$' + newPrem.toFixed(2),
    delta: origPost.delta || '',
    notes: `Rolled from $${origPost.strike} · Total premium collected: $${(totalPrem*100).toFixed(0)}`,
    time: 'Just now',
    timestamp: Date.now() + 1,
    kind: 'signal',
    rollHistory: [...(origPost.rollHistory || []), { strike: origPost.strike, exp: origPost.exp, premiumPerShare: origPrem, rolledAt: Date.now() }],
    totalPremiumCollected: totalPrem
  };
  await savePostToFirebase(newSignal);

  // 4. Reset form
  $('rollPositionSelect').value = '';
  $('rollNewStrike').value = '';
  $('rollNewExp').value = '';
  $('rollNewPrem').value = '';
  if ($('rollNotes')) $('rollNotes').value = '';
  $('rollOrigInfo').style.display = 'none';
  $('rollNewFields').style.display = 'none';
  $('rollChainPicker').style.display = 'none';
  rollSelectedPost = null;

  save();
  renderAdminPosts();
  renderSignals();
  showToast(`Rolled ${origPost.ticker} to $${newStrike} ${newExp}`, 'success');
}

let _deleting = false;
const _deletedPostIds = new Set(); // Prevent Firebase listener from re-adding deleted posts
async function deletePost(postId) {
  if (_deleting || !S.adminPosts) return;
  _deleting = true;
  try {
    // Support both id-based and index-based lookup
    let idx = S.adminPosts.findIndex(p => p.id === postId);
    if (idx === -1 && typeof postId === 'number') idx = postId;
    if (idx === -1 || idx >= S.adminPosts.length) { _deleting = false; return; }

    const post = S.adminPosts[idx];
    const firebaseId = post.id;

    // CC post deletion: remove from wheel's ccHistory, but DON'T delete the wheel position
    if (post.type === 'cc' && post.wheelId && S.wheelPositions) {
      const wheel = S.wheelPositions.find(w => w.id === post.wheelId);
      if (wheel) {
        // Find matching CC in history by timestamp or strike
        const ccIdx = wheel.ccHistory.findIndex(cc =>
          cc.strike === post.strike && Math.abs((cc.soldAt || 0) - (post.timestamp || 0)) < 5000
        );
        if (ccIdx !== -1) wheel.ccHistory.splice(ccIdx, 1);
      }
    }
    // CSP post deletion: remove the wheel position and all linked CC posts
    else if (post.type === 'csp' && post.wheelId) {
      if (S.wheelPositions) {
        // Clean up trade history entries from this wheel before removing it
        const delWheel = S.wheelPositions.find(w => w.id === post.wheelId);
        if (delWheel) {
          S.history = (S.history || []).filter(h => {
            if (h.outcome === 'called_away' && h.symbol === delWheel.symbol && h.wheelSummary) return false;
            if (h.id && h.id.startsWith('called-') && h.symbol === delWheel.symbol) return false;
            return true;
          });
        }
        S.wheelPositions = S.wheelPositions.filter(w => w.id !== post.wheelId);
      }
      // Clean up orphaned CC posts that share the same wheelId
      const orphanedCCs = S.adminPosts.filter(p => p !== post && p.wheelId === post.wheelId);
      orphanedCCs.forEach(cc => {
        const ccFirebaseId = cc.id;
        if (ccFirebaseId) deletePostFromFirebase(ccFirebaseId).catch(e => console.warn('Firebase CC cleanup:', e));
      });
      S.adminPosts = S.adminPosts.filter(p => p === post || p.wheelId !== post.wheelId);
      // Recalculate idx after filtering
      idx = S.adminPosts.findIndex(p => p === post);
      if (idx === -1) { _deleting = false; return; }
    }
    // Also remove any wheel positions that link back to this post via cspSignalId
    if (post.id && post.type === 'csp' && S.wheelPositions) {
      // Clean up history for these too
      const linkedWheels = S.wheelPositions.filter(w => w.cspSignalId === post.id);
      linkedWheels.forEach(lw => {
        S.history = (S.history || []).filter(h => {
          if (h.outcome === 'called_away' && h.symbol === lw.symbol && h.wheelSummary) return false;
          if (h.id && h.id.startsWith('called-') && h.symbol === lw.symbol) return false;
          return true;
        });
      });
      S.wheelPositions = S.wheelPositions.filter(w => w.cspSignalId !== post.id);
    }

    // Remove from local array first (instant UI update)
    S.adminPosts.splice(idx, 1);
    save();
    renderAdminPosts();
    renderSignals();
    renderWheelPositions();
    renderHome();
    renderMasterPortfolio();
    showToast('Post deleted', '');

    // Delete from Firebase — AWAIT so listener doesn't re-add it
    if (firebaseId) {
      _deletedPostIds.add(firebaseId);
      await deletePostFromFirebase(firebaseId).catch(e => console.warn('Firebase delete:', e));
    }
  } finally {
    _deleting = false;
  }
}

// === WHEEL POSITIONS MANAGEMENT ===
function renderWheelPositions() {
  const c = $('wheelPositionsList');
  if (!c) return;
  const positions = S.wheelPositions || [];
  const active = positions.filter(w => w.status === 'holding');
  const countEl = $('wheelCount');
  if (countEl) countEl.textContent = active.length;

  c.innerHTML = '';
  if (active.length) {
  c.innerHTML = active.map(w => {
    const totalCCPrem = w.ccHistory.reduce((s, cc) => s + (cc.premiumTotal || 0), 0);
    const totalPremium = (w.totalPremiumCollected || 0) + totalCCPrem;
    const livePrice = w.currentPrice || w.assignPrice;
    const stockPnl = (livePrice - w.assignPrice) * w.shares;
    const netPnl = stockPnl + totalPremium;
    const stockColor = stockPnl >= 0 ? 'var(--green)' : 'var(--red)';
    const netColor = netPnl >= 0 ? 'var(--green)' : 'var(--red)';
    const ccCount = w.ccHistory.length;
    const fmtPnl = (v) => v >= 0 ? `+$${v.toFixed(0)}` : `-$${Math.abs(v).toFixed(0)}`;

    return `<div style="padding:12px;background:var(--input);border-radius:10px;margin-bottom:10px;border-left:3px solid var(--orange)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-weight:700;font-size:15px">${w.symbol}</span>
        <span style="font-size:11px;color:var(--text3)">${new Date(w.assignedAt).toLocaleDateString()}</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px 12px;font-size:12px;margin-bottom:8px">
        <div><span style="color:var(--text3)">Shares:</span> <b>${w.shares}</b></div>
        <div><span style="color:var(--text3)">Bought At:</span> <b>$${w.assignPrice.toFixed(2)}</b></div>
        <div><span style="color:var(--text3)">Live Price:</span> <b id="wheelPrice-${w.id}">$${livePrice.toFixed(2)}</b></div>
        <div><span style="color:var(--text3)">Stock P&L:</span> <b style="color:${stockColor}">${fmtPnl(stockPnl)}</b></div>
        <div><span style="color:var(--text3)">CSP Premium:</span> <b style="color:var(--green)">+$${(w.totalPremiumCollected || 0).toFixed(0)}</b></div>
        <div><span style="color:var(--text3)">CC Premium:</span> <b style="color:var(--green)">+$${totalCCPrem.toFixed(0)}</b></div>
        <div><span style="color:var(--text3)">CCs Sold:</span> <b>${ccCount}</b></div>
        <div><span style="color:var(--text3)">Total Premium:</span> <b style="color:var(--green)">+$${totalPremium.toFixed(0)}</b></div>
      </div>
      ${(() => {
        const activeCC = w.ccHistory.find(cc => cc.status === 'open');
        if (activeCC) {
          return `<div style="padding:8px;background:var(--blue-bg,rgba(0,122,255,0.08));border-radius:8px;margin-bottom:8px;border-left:3px solid var(--blue)">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-size:11px;font-weight:600;color:var(--blue)">ACTIVE CC</div>
                <div style="font-size:12px;margin-top:2px">$${activeCC.strike} Call · Exp ${activeCC.exp} · <span style="color:var(--green)">+$${activeCC.premiumTotal.toFixed(0)}</span></div>
              </div>
              <button onclick="event.stopPropagation();closeCCOnWheel('${w.id}','${activeCC.id}')" style="font-size:10px;padding:4px 10px;background:var(--text3);color:#fff;border:none;border-radius:6px;cursor:pointer">Close CC</button>
            </div>
          </div>`;
        }
        return '';
      })()}
      <div style="padding:8px;background:var(--card);border-radius:8px;margin-bottom:8px;text-align:center">
        <span style="font-size:11px;color:var(--text3)">Net Wheel P&L:</span>
        <b style="font-size:16px;color:${netColor};margin-left:6px">${fmtPnl(netPnl)}</b>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-outline" onclick="sellCCOnWheel('${w.id}')" style="flex:1;font-size:11px;padding:6px">Sell CC</button>
        <button class="btn" onclick="calledAwayWheel('${w.id}')" style="flex:1;font-size:11px;padding:6px;background:var(--blue)">Called Away</button>
        <button onclick="deleteWheelPosition('${w.id}')" style="font-size:11px;padding:6px 10px;background:transparent;border:1px solid var(--red);color:var(--red);border-radius:8px;cursor:pointer" title="Delete">✕</button>
      </div>
    </div>`;
  }).join('');

  // Fetch live prices for all active wheel positions
  active.forEach(w => {
    fetchLiveQuote(w.symbol).then(q => {
      if (!q || (!q.price && !q.close)) return;
      const livePrice = q.price || q.close;
      w.currentPrice = livePrice;
      const el = $(`wheelPrice-${w.id}`);
      if (el) {
        el.textContent = `$${livePrice.toFixed(2)}`;
        // Re-calc and update P&L display inline
        const totalCCPrem = w.ccHistory.reduce((s, cc) => s + (cc.premiumTotal || 0), 0);
        const totalPremium = (w.totalPremiumCollected || 0) + totalCCPrem;
        const stockPnl = (livePrice - w.assignPrice) * w.shares;
        const netPnl = stockPnl + totalPremium;
        // Update the parent card's P&L cells
        const card = el.closest('div[style*="border-left"]');
        if (card) {
          const cells = card.querySelectorAll('b');
          cells.forEach(b => {
            if (b.previousElementSibling?.textContent === 'Stock P&L:') {
              b.style.color = stockPnl >= 0 ? 'var(--green)' : 'var(--red)';
              b.textContent = stockPnl >= 0 ? `+$${stockPnl.toFixed(0)}` : `-$${Math.abs(stockPnl).toFixed(0)}`;
            }
          });
          const netEl = card.querySelector('div[style*="text-align:center"] b[style*="font-size:16px"]');
          if (netEl) {
            netEl.style.color = netPnl >= 0 ? 'var(--green)' : 'var(--red)';
            netEl.textContent = netPnl >= 0 ? `+$${netPnl.toFixed(0)}` : `-$${Math.abs(netPnl).toFixed(0)}`;
          }
        }
      }
      save();
    }).catch(() => {});
  });
  } // end if (active.length)

  // Completed wheels — full lifecycle log
  const completed = positions.filter(w => w.status === 'completed');
  if (completed.length > 0) {
    c.innerHTML += `<div style="font-size:13px;font-weight:700;margin:16px 0 8px;color:var(--text2)">Completed Wheels (${completed.length})</div>`;
    c.innerHTML += completed.slice(0, 10).map(w => {
      const totalCCPrem = w.ccHistory.reduce((s, cc) => s + (cc.premiumTotal || 0), 0);
      const totalPremium = (w.totalPremiumCollected || 0) + totalCCPrem;
      const stockPnl = ((w.callStrike || w.assignPrice) - w.assignPrice) * w.shares;
      const finalPnl = w.finalPnl || (stockPnl + totalPremium);
      const fmtPnl = v => v >= 0 ? `+$${v.toFixed(0)}` : `-$${Math.abs(v).toFixed(0)}`;
      const pnlColor = v => v >= 0 ? 'var(--green)' : 'var(--red)';
      const assignDate = w.assignedAt ? new Date(w.assignedAt).toLocaleDateString('en-US', {month:'short',day:'numeric'}) : '?';
      const completeDate = w.completedAt ? new Date(w.completedAt).toLocaleDateString('en-US', {month:'short',day:'numeric'}) : '?';

      // Build lifecycle timeline
      let timeline = `<div style="font-size:11px;color:var(--text3);margin-top:8px;border-left:2px solid var(--border);padding-left:10px">`;
      // CSP phase
      timeline += `<div style="margin-bottom:4px"><span style="color:var(--green);font-weight:600">CSP</span> $${w.assignPrice} Put · Premium: <span style="color:var(--green)">+$${(w.totalPremiumCollected || 0).toFixed(0)}</span></div>`;
      // Assignment
      timeline += `<div style="margin-bottom:4px"><span style="color:var(--orange);font-weight:600">ASSIGNED</span> ${w.shares} shares at $${w.assignPrice.toFixed(2)} · ${assignDate}</div>`;
      // Each CC
      w.ccHistory.forEach((cc, i) => {
        const outcome = cc.outcome === 'winner' ? '<span style="color:var(--green)"> WIN</span>' : cc.status === 'closed' ? '' : ' <span style="color:var(--blue)">(open)</span>';
        timeline += `<div style="margin-bottom:4px"><span style="color:var(--blue);font-weight:600">CC #${i+1}</span> $${cc.strike} Call · Exp ${cc.exp} · <span style="color:var(--green)">+$${(cc.premiumTotal||0).toFixed(0)}</span>${outcome}</div>`;
      });
      // Called away
      if (w.callStrike) {
        timeline += `<div style="margin-bottom:4px"><span style="color:var(--purple);font-weight:600">CALLED</span> Shares sold at $${w.callStrike.toFixed(2)} · ${completeDate}</div>`;
      }
      timeline += `</div>`;

      // Summary
      const summary = `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-top:8px;font-size:11px;text-align:center">
        <div style="padding:4px;background:var(--input);border-radius:4px"><div style="color:var(--text3)">Stock</div><b style="color:${pnlColor(stockPnl)}">${fmtPnl(stockPnl)}</b></div>
        <div style="padding:4px;background:var(--input);border-radius:4px"><div style="color:var(--text3)">Premiums</div><b style="color:var(--green)">+$${totalPremium.toFixed(0)}</b></div>
        <div style="padding:4px;background:var(--input);border-radius:4px"><div style="color:var(--text3)">Total P&L</div><b style="color:${pnlColor(finalPnl)}">${fmtPnl(finalPnl)}</b></div>
      </div>`;

      return `<div style="border-left:3px solid ${finalPnl >= 0 ? 'var(--green)' : 'var(--red)'};padding:12px;margin-bottom:8px;background:var(--input);border-radius:0 8px 8px 0">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700;font-size:14px">${w.symbol} <span style="font-size:11px;font-weight:400;color:var(--text3)">Wheel Complete</span></div>
          <span style="font-size:14px;font-weight:800;color:${pnlColor(finalPnl)}">${fmtPnl(finalPnl)}</span>
        </div>
        <div style="font-size:11px;color:var(--text3)">${assignDate} → ${completeDate} · ${w.ccHistory.length} CC${w.ccHistory.length!==1?'s':''} sold</div>
        ${timeline}${summary}
        <div style="display:flex;gap:6px;margin-top:8px">
          <button onclick="showWheelRecap('${w.id}')" style="flex:1;font-size:11px;padding:5px 10px;background:var(--blue);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600">View Full Recap</button>
          <button onclick="shareWheelWin('${w.id}')" style="flex:1;font-size:11px;padding:5px 10px;background:var(--green);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600">Share Win</button>
          <button onclick="deleteWheelPosition('${w.id}')" style="font-size:11px;padding:5px 10px;background:transparent;border:1px solid var(--text3);color:var(--text3);border-radius:6px;cursor:pointer" title="Delete">✕</button>
        </div>
      </div>`;
    }).join('');
  }

  if (!c.innerHTML) {
    c.innerHTML = '<p style="color:var(--text3);font-size:13px;text-align:center;padding:16px">No wheel positions yet. When a CSP gets assigned, shares appear here.</p>';
  }
}

function deleteWheelPosition(wheelId) {
  if (!confirm('Delete this wheel position and all linked posts? This cannot be undone.')) return;
  const w = (S.wheelPositions || []).find(x => x.id === wheelId);
  S.wheelPositions = (S.wheelPositions || []).filter(x => x.id !== wheelId);
  // Delete all linked admin posts from Firebase AND local state
  const linkedPosts = (S.adminPosts || []).filter(p => p.wheelId === wheelId);
  linkedPosts.forEach(p => {
    if (p.id) {
      _deletedPostIds.add(p.id);
      deletePostFromFirebase(p.id).catch(e => console.warn('Firebase cleanup:', e));
    }
  });
  S.adminPosts = (S.adminPosts || []).filter(p => p.wheelId !== wheelId);
  // Clean up trade history entries from this wheel
  if (w) {
    S.history = (S.history || []).filter(h => {
      if (h.outcome === 'called_away' && h.symbol === w.symbol && h.wheelSummary) return false;
      if (h.id && h.id.startsWith('called-') && h.symbol === w.symbol) return false;
      return true;
    });
  }
  save();
  renderWheelPositions();
  renderAdminPosts();
  renderSignals();
  renderHome();
  renderMasterPortfolio();
  showToast('Wheel position and linked posts deleted', '');
}

// Show full wheel lifecycle recap modal
function showWheelRecap(wheelId) {
  const w = (S.wheelPositions || []).find(x => x.id === wheelId);
  if (!w) return;

  const totalCCPrem = w.ccHistory.reduce((s, cc) => s + (cc.premiumTotal || 0), 0);
  const cspPrem = w.totalPremiumCollected || 0;
  const totalPremium = cspPrem + totalCCPrem;
  const stockPnl = ((w.callStrike || w.assignPrice) - w.assignPrice) * w.shares;
  const finalPnl = w.finalPnl || (stockPnl + totalPremium);
  const fmtPnl = v => v >= 0 ? `+$${v.toFixed(0)}` : `-$${Math.abs(v).toFixed(0)}`;
  const pnlColor = v => v >= 0 ? 'var(--green)' : 'var(--red)';
  const assignDate = w.assignedAt ? new Date(w.assignedAt) : new Date();
  const completeDate = w.completedAt ? new Date(w.completedAt) : new Date();
  const daysHeld = Math.max(1, Math.round((completeDate - assignDate) / 86400000));
  const fmtDate = d => d.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});

  let html = `
    <div style="text-align:center;padding:20px 0 12px">
      <div style="font-size:40px;margin-bottom:8px">${finalPnl >= 0 ? '🎉' : '📊'}</div>
      <div style="font-size:22px;font-weight:800;margin-bottom:4px">${w.symbol} Wheel Complete</div>
      <div style="font-size:36px;font-weight:800;color:${pnlColor(finalPnl)}">${fmtPnl(finalPnl)}</div>
      <div style="font-size:13px;color:var(--text3);margin-top:4px">${fmtDate(assignDate)} → ${fmtDate(completeDate)} · ${daysHeld} day${daysHeld!==1?'s':''}</div>
    </div>
    <div style="font-size:13px;font-weight:700;margin:16px 0 8px;color:var(--text2)">How This Wheel Played Out</div>
    <div style="border-left:3px solid var(--border);margin-left:8px;padding-left:16px">
      <div style="position:relative;margin-bottom:16px">
        <div style="position:absolute;left:-25px;top:2px;width:12px;height:12px;border-radius:50%;background:var(--green)"></div>
        <div style="font-size:12px;font-weight:700;color:var(--green)">STEP 1 · Sold Cash-Secured Put</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">Collected premium upfront by agreeing to buy shares if the stock drops</div>
        <div style="margin-top:6px;padding:8px;background:var(--input);border-radius:8px;font-size:12px">
          <div>${w.symbol} $${w.assignPrice} Put</div>
          <div style="color:var(--green);font-weight:600;margin-top:4px">Premium: +$${cspPrem.toFixed(0)}</div>
        </div>
      </div>
      <div style="position:relative;margin-bottom:16px">
        <div style="position:absolute;left:-25px;top:2px;width:12px;height:12px;border-radius:50%;background:var(--orange)"></div>
        <div style="font-size:12px;font-weight:700;color:var(--orange)">STEP 2 · Got Assigned Shares</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">Stock dropped below strike — now you own shares at the strike price</div>
        <div style="margin-top:6px;padding:8px;background:var(--input);border-radius:8px;font-size:12px">
          <div>${w.shares} shares at $${w.assignPrice.toFixed(2)} = $${(w.shares * w.assignPrice).toLocaleString()} invested</div>
          <div style="color:var(--text3);margin-top:2px;font-size:11px">${fmtDate(assignDate)}</div>
        </div>
      </div>`;

  if (w.ccHistory.length > 0) {
    html += `<div style="position:relative;margin-bottom:16px">
        <div style="position:absolute;left:-25px;top:2px;width:12px;height:12px;border-radius:50%;background:var(--blue)"></div>
        <div style="font-size:12px;font-weight:700;color:var(--blue)">STEP 3 · Sold Covered Calls (${w.ccHistory.length})</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">Earned extra income by selling call options against your shares</div>
        <div style="margin-top:6px">`;
    w.ccHistory.forEach((cc, i) => {
      const outcome = cc.outcome === 'winner' ? 'Expired Worthless (WIN)' : cc.status === 'closed' ? 'Closed' : 'Active';
      const outcomeColor = cc.outcome === 'winner' ? 'var(--green)' : 'var(--text3)';
      html += `<div style="padding:8px;background:var(--input);border-radius:8px;font-size:12px;margin-bottom:4px">
          <div style="display:flex;justify-content:space-between">
            <span>CC #${i+1}: $${cc.strike} Call · ${cc.exp}</span>
            <span style="color:${outcomeColor};font-size:11px">${outcome}</span>
          </div>
          <div style="color:var(--green);font-weight:600;margin-top:2px">+$${(cc.premiumTotal||0).toFixed(0)}</div>
        </div>`;
    });
    html += `<div style="text-align:right;font-size:12px;font-weight:600;color:var(--green);padding-top:4px">Total CC Premium: +$${totalCCPrem.toFixed(0)}</div></div></div>`;
  }

  const stepNum = w.ccHistory.length > 0 ? '4' : '3';
  if (w.callStrike) {
    html += `<div style="position:relative;margin-bottom:8px">
        <div style="position:absolute;left:-25px;top:2px;width:12px;height:12px;border-radius:50%;background:var(--purple,#9C27B0)"></div>
        <div style="font-size:12px;font-weight:700;color:var(--purple,#9C27B0)">STEP ${stepNum} · Shares Called Away</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">Stock rose above your call strike — shares automatically sold</div>
        <div style="margin-top:6px;padding:8px;background:var(--input);border-radius:8px;font-size:12px">
          <div>${w.shares} shares sold at $${w.callStrike.toFixed(2)} = $${(w.shares * w.callStrike).toLocaleString()}</div>
          <div style="color:${pnlColor(stockPnl)};font-weight:600;margin-top:2px">Stock P&L: ${fmtPnl(stockPnl)} ($${w.assignPrice.toFixed(2)} → $${w.callStrike.toFixed(2)})</div>
          <div style="color:var(--text3);margin-top:2px;font-size:11px">${fmtDate(completeDate)}</div>
        </div>
      </div>`;
  }
  html += `</div>`;

  // Math breakdown
  html += `
    <div style="margin-top:20px;padding:16px;background:var(--input);border-radius:12px">
      <div style="font-size:13px;font-weight:700;margin-bottom:12px;text-align:center">Profit Breakdown</div>
      <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)">
        <span style="color:var(--text3)">CSP Premium Collected</span>
        <span style="color:var(--green);font-weight:600">+$${cspPrem.toFixed(0)}</span>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)">
        <span style="color:var(--text3)">CC Premiums (${w.ccHistory.length} sold)</span>
        <span style="color:var(--green);font-weight:600">+$${totalCCPrem.toFixed(0)}</span>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)">
        <span style="color:var(--text3)">Stock P&L ($${w.assignPrice.toFixed(2)} → $${(w.callStrike||w.assignPrice).toFixed(2)})</span>
        <span style="color:${pnlColor(stockPnl)};font-weight:600">${fmtPnl(stockPnl)}</span>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:15px;font-weight:800;padding-top:4px">
        <span>Total Profit</span>
        <span style="color:${pnlColor(finalPnl)}">${fmtPnl(finalPnl)}</span>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:16px">
      <button class="btn btn-outline" onclick="closeModal('wheelRecapModal')" style="flex:1">Close</button>
      <button class="btn" onclick="shareWheelWin('${w.id}')" style="flex:1;background:var(--blue)">Share Win</button>
    </div>`;

  $('wheelRecapContent').innerHTML = html;
  openModal('wheelRecapModal');
}

// Generate shareable image for completed wheel
function shareWheelWin(wheelId) {
  const w = (S.wheelPositions || []).find(x => x.id === wheelId);
  if (!w) return;

  const canvas = document.createElement('canvas');
  canvas.width = 600;
  canvas.height = 420;
  const ctx = canvas.getContext('2d');

  // Dark gradient background
  const grad = ctx.createLinearGradient(0, 0, 600, 420);
  grad.addColorStop(0, '#0f1419');
  grad.addColorStop(1, '#1a2332');
  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.roundRect(0, 0, 600, 420, 16);
  ctx.fill();

  // Subtle border
  ctx.strokeStyle = 'rgba(255,255,255,0.08)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.roundRect(0, 0, 600, 420, 16);
  ctx.stroke();

  // Brand
  ctx.fillStyle = 'rgba(255,255,255,0.5)';
  ctx.font = '700 14px Inter, system-ui, sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText('MARKET ELITES', 32, 40);

  ctx.fillStyle = 'rgba(255,255,255,0.25)';
  ctx.font = '500 12px Inter, system-ui, sans-serif';
  ctx.textAlign = 'right';
  ctx.fillText('WHEEL STRATEGY COMPLETE', 568, 40);
  ctx.textAlign = 'left';

  // Ticker
  ctx.fillStyle = '#ffffff';
  ctx.font = '800 48px Inter, system-ui, sans-serif';
  ctx.fillText(w.symbol, 32, 100);

  // P&L calc
  const totalCCPrem = w.ccHistory.reduce((s, cc) => s + (cc.premiumTotal || 0), 0);
  const cspPrem = w.totalPremiumCollected || 0;
  const totalPremium = cspPrem + totalCCPrem;
  const stockPnl = ((w.callStrike || w.assignPrice) - w.assignPrice) * w.shares;
  const finalPnl = w.finalPnl || (stockPnl + totalPremium);
  const fmtPnl = v => v >= 0 ? `+$${v.toFixed(0)}` : `-$${Math.abs(v).toFixed(0)}`;

  // Big P&L
  ctx.fillStyle = finalPnl >= 0 ? '#00C853' : '#FF1744';
  ctx.font = '800 56px Inter, system-ui, sans-serif';
  ctx.fillText(fmtPnl(finalPnl), 32, 170);

  // Breakdown rows
  const breakdown = [
    { label: 'CSP Premium', value: `+$${cspPrem.toFixed(0)}`, color: '#00C853' },
    { label: `CC Premiums (${w.ccHistory.length})`, value: `+$${totalCCPrem.toFixed(0)}`, color: '#00C853' },
    { label: 'Stock P&L', value: fmtPnl(stockPnl), color: stockPnl >= 0 ? '#00C853' : '#FF1744' }
  ];

  ctx.font = '500 15px Inter, system-ui, sans-serif';
  let y = 220;
  breakdown.forEach(item => {
    ctx.fillStyle = 'rgba(255,255,255,0.45)';
    ctx.textAlign = 'left';
    ctx.fillText(item.label, 32, y);
    ctx.fillStyle = item.color;
    ctx.textAlign = 'right';
    ctx.fillText(item.value, 568, y);
    y += 32;
  });

  // Divider
  ctx.strokeStyle = 'rgba(255,255,255,0.08)';
  ctx.beginPath();
  ctx.moveTo(32, y + 4);
  ctx.lineTo(568, y + 4);
  ctx.stroke();

  // Duration line
  y += 30;
  const assignDate = w.assignedAt ? new Date(w.assignedAt) : new Date();
  const completeDate = w.completedAt ? new Date(w.completedAt) : new Date();
  const days = Math.max(1, Math.round((completeDate - assignDate) / 86400000));
  const fmtDate = d => d.toLocaleDateString('en-US', {month:'short', day:'numeric'});

  ctx.fillStyle = 'rgba(255,255,255,0.35)';
  ctx.font = '500 13px Inter, system-ui, sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText(`${fmtDate(assignDate)} → ${fmtDate(completeDate)} · ${days} days · ${w.ccHistory.length} covered call${w.ccHistory.length!==1?'s':''} sold`, 32, y);

  // Total line
  y += 30;
  ctx.strokeStyle = 'rgba(255,255,255,0.08)';
  ctx.beginPath();
  ctx.moveTo(32, y - 14);
  ctx.lineTo(568, y - 14);
  ctx.stroke();

  ctx.fillStyle = 'rgba(255,255,255,0.5)';
  ctx.font = '600 14px Inter, system-ui, sans-serif';
  ctx.fillText('Total Profit', 32, y + 4);
  ctx.fillStyle = finalPnl >= 0 ? '#00C853' : '#FF1744';
  ctx.font = '800 18px Inter, system-ui, sans-serif';
  ctx.textAlign = 'right';
  ctx.fillText(fmtPnl(finalPnl), 568, y + 4);
  ctx.textAlign = 'left';

  // Watermark
  ctx.fillStyle = 'rgba(255,255,255,0.15)';
  ctx.font = '400 11px Inter, system-ui, sans-serif';
  ctx.textAlign = 'right';
  ctx.fillText('elitesbeau.github.io', 568, 405);

  canvas.toBlob(blob => {
    if (navigator.share && navigator.canShare) {
      try {
        const file = new File([blob], `${w.symbol}-wheel-win.png`, { type: 'image/png' });
        if (navigator.canShare({ files: [file] })) {
          navigator.share({
            title: `${w.symbol} Wheel Complete: ${fmtPnl(finalPnl)}`,
            text: `Just completed a wheel strategy on ${w.symbol} for ${fmtPnl(finalPnl)} profit!`,
            files: [file]
          }).catch(() => downloadShareImage(blob, w.symbol));
          return;
        }
      } catch(e) {}
    }
    downloadShareImage(blob, w.symbol);
  }, 'image/png');
}

function downloadShareImage(blob, symbol) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${symbol}-wheel-win.png`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('Image downloaded! Share it on social media', 'success');
}

// Sell a covered call against assigned shares
let ccChainData = null;
let ccWheelId = null;

async function sellCCOnWheel(wheelId) {
  const w = (S.wheelPositions || []).find(x => x.id === wheelId);
  if (!w) return;
  ccWheelId = wheelId;
  ccChainData = null;

  // Build inline CC sell modal
  const contracts = w.contracts || Math.floor(w.shares / 100);
  const modal = document.createElement('div');
  modal.className = 'modal-bg';
  modal.id = 'ccSellModal';
  modal.onclick = (e) => { if (e.target === modal) closeCCSellModal(); };
  modal.innerHTML = `<div class="modal" onclick="event.stopPropagation()" style="max-height:85vh;overflow-y:auto">
    <div class="modal-handle"></div>
    <div class="modal-header"><span class="modal-title">Sell CC — ${w.symbol}</span><button class="modal-close" onclick="closeCCSellModal()"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
    <div style="padding:0 16px 16px">
      <div style="display:flex;gap:12px;margin-bottom:12px;font-size:12px;color:var(--text2)">
        <span>${w.shares} shares at $${w.assignPrice.toFixed(2)}</span>
        <span>${contracts} contract${contracts>1?'s':''}</span>
        <span id="ccTickerPrice" style="margin-left:auto;font-weight:600"></span>
      </div>
      <div id="ccChainLoading" style="text-align:center;padding:16px;color:var(--text3);font-size:13px">Loading options chain...</div>
      <div id="ccChainPicker" style="display:none;margin-bottom:12px">
        <div id="ccChainExps" style="display:flex;gap:4px;overflow-x:auto;padding-bottom:6px;margin-bottom:6px;-webkit-overflow-scrolling:touch"></div>
        <div id="ccChainStrikes" style="max-height:250px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;font-size:12px"></div>
      </div>
      <div style="display:flex;gap:6px;margin-bottom:8px">
        <div class="form-group" style="flex:1;margin-bottom:0"><label class="form-label" style="font-size:10px">Strike</label><input type="number" class="form-input" id="ccStrike" placeholder="Strike" style="padding:8px 10px"></div>
        <div class="form-group" style="flex:1;margin-bottom:0"><label class="form-label" style="font-size:10px">Expiration</label><select class="form-input" id="ccExp" style="padding:8px 10px">${getExpDateOptions()}</select></div>
        <div class="form-group" style="flex:1;margin-bottom:0"><label class="form-label" style="font-size:10px">Premium/share</label><input type="text" class="form-input" id="ccPrem" placeholder="$1.50" style="padding:8px 10px" oninput="updateCCTotal()"></div>
      </div>
      <div id="ccTotalLine" style="font-size:13px;color:var(--text2);margin-bottom:10px;padding:6px 8px;background:var(--input);border-radius:6px;display:none">
        Collecting: <b style="color:var(--green)" id="ccTotalAmt">$0</b>
      </div>
      <div class="form-group" style="margin-bottom:10px"><input type="text" class="form-input" id="ccNotes" placeholder="Notes (optional)" style="padding:8px 12px;font-size:13px"></div>
      <button class="btn" onclick="confirmSellCC()" style="width:100%">Sell Covered Call</button>
    </div>
  </div>`;
  document.body.appendChild(modal);
  setTimeout(() => modal.classList.add('show'), 10);

  // Fetch quote + chain
  try {
    const quote = await fetchLiveQuote(w.symbol);
    if (quote) {
      const color = quote.change >= 0 ? 'var(--green)' : 'var(--red)';
      $('ccTickerPrice').innerHTML = `$${quote.price.toFixed(2)} <span style="color:${color}">${quote.change >= 0?'+':''}${quote.change.toFixed(2)}</span>`;
    }
  } catch(e) {}

  try {
    const chain = await fetchOptionsChain(w.symbol);
    $('ccChainLoading').style.display = 'none';
    if (chain && chain.calls.length) {
      ccChainData = chain;
      $('ccChainPicker').style.display = 'block';
      const exps = (chain.expirations || []).slice(0, 6);
      $('ccChainExps').innerHTML = exps.map((exp, i) =>
        `<button class="chain-exp-btn${i===0?' active':''}" onclick="selectCCExp(${exp},this)">${formatExpDate(exp)} (${calcDTE(exp)}d)</button>`
      ).join('');
      renderCCChain(chain);
    } else {
      $('ccChainLoading').innerHTML = '<span style="color:var(--orange);font-size:12px">Chain unavailable — enter details manually</span>';
    }
  } catch(e) {
    $('ccChainLoading').innerHTML = '<span style="color:var(--orange);font-size:12px">Chain fetch failed — enter manually</span>';
  }
}

function selectCCExp(expTs, btn) {
  $('ccChainExps').querySelectorAll('.chain-exp-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const w = (S.wheelPositions || []).find(x => x.id === ccWheelId);
  if (!w) return;
  fetchOptionsChain(w.symbol, expTs).then(chain => {
    if (chain) { ccChainData = chain; renderCCChain(chain); }
  });
}

function renderCCChain(chain) {
  const options = chain.calls || [];
  const price = chain.price || 0;
  // CC: show 2 below + 50 above (deep OTM calls)
  const below = options.filter(o => o.strike <= price).sort((a,b) => b.strike - a.strike).slice(0, 2);
  const above = options.filter(o => o.strike > price).sort((a,b) => a.strike - b.strike).slice(0, 50);
  const near = [...below, ...above].sort((a,b) => b.strike - a.strike);

  $('ccChainStrikes').innerHTML = `
    <div class="chain-row" style="background:var(--input);font-size:10px;font-weight:600;color:var(--text3);cursor:default;padding:6px 8px">
      <div style="flex:1">Strike</div><div style="width:50px;text-align:right">Bid</div><div style="width:50px;text-align:right">Ask</div><div style="width:35px;text-align:right">DTE</div>
    </div>
  ` + near.map(o => {
    const atm = Math.abs(o.strike - price) / price < 0.01;
    return `<div class="chain-row" style="padding:6px 8px;font-size:12px" onclick="pickCCOption(${o.strike},${o.bid||0},${o.ask||0})">
      <div style="flex:1;font-weight:600;${atm?'color:var(--blue)':''}">$${o.strike}${atm?' ◄':''}</div>
      <div style="width:50px;text-align:right;color:var(--green)">${(o.bid||0).toFixed(2)}</div>
      <div style="width:50px;text-align:right">${(o.ask||0).toFixed(2)}</div>
      <div style="width:35px;text-align:right;font-size:11px">${o.dte||'—'}</div>
    </div>`;
  }).join('');
}

function pickCCOption(strike, bid, ask) {
  const mid = ((bid + ask) / 2).toFixed(2);
  $('ccStrike').value = strike;
  $('ccPrem').value = '$' + mid;
  // Set expiration from active tab
  const activeExp = $('ccChainExps')?.querySelector('.chain-exp-btn.active');
  if (activeExp) {
    const expVal = activeExp.textContent.split('(')[0].trim();
    const sel = $('ccExp');
    sel.value = expVal;
    if (!sel.value) {
      const opt = document.createElement('option');
      opt.value = expVal; opt.textContent = expVal;
      sel.insertBefore(opt, sel.firstChild.nextSibling);
      sel.value = expVal;
    }
  }
  $('ccChainStrikes').querySelectorAll('.chain-row').forEach(r => r.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  updateCCTotal();
  showToast(`Selected $${strike} Call · Premium $${mid}`, 'success');
}

function updateCCTotal() {
  const w = (S.wheelPositions || []).find(x => x.id === ccWheelId);
  if (!w) return;
  const premStr = ($('ccPrem')?.value || '').replace(/[$,]/g, '');
  const prem = parseFloat(premStr);
  const contracts = w.contracts || Math.floor(w.shares / 100);
  const line = $('ccTotalLine');
  if (prem > 0) {
    const total = prem * 100 * contracts;
    $('ccTotalAmt').textContent = '$' + total.toFixed(0);
    line.style.display = 'block';
  } else {
    line.style.display = 'none';
  }
}

function closeCCSellModal() {
  const m = $('ccSellModal');
  if (m) { m.classList.remove('show'); setTimeout(() => m.remove(), 200); }
  ccWheelId = null;
  ccChainData = null;
}

function confirmSellCC() {
  const w = (S.wheelPositions || []).find(x => x.id === ccWheelId);
  if (!w) return;

  const ccStrike = parseFloat($('ccStrike')?.value);
  const exp = $('ccExp')?.value.trim();
  const premStr = ($('ccPrem')?.value || '').replace(/[$,]/g, '');
  const premPerShare = parseFloat(premStr);
  const notes = $('ccNotes')?.value.trim() || '';

  if (!ccStrike) return showToast('Select or enter a strike', 'error');
  if (!exp) return showToast('Select an expiration', 'error');
  if (!premPerShare) return showToast('Enter premium per share', 'error');

  const contracts = w.contracts || Math.floor(w.shares / 100);
  const totalPrem = premPerShare * 100 * contracts;

  const ccEntry = {
    id: Date.now().toString(),
    strike: ccStrike,
    exp: exp,
    premiumPerShare: premPerShare,
    premiumTotal: totalPrem,
    contracts: contracts,
    soldAt: Date.now(),
    status: 'open'
  };
  w.ccHistory.push(ccEntry);

  const ccSignal = {
    id: 'cc-' + Date.now(),
    type: 'cc',
    ticker: w.symbol,
    strike: ccStrike,
    exp: exp,
    prem: '$' + premPerShare.toFixed(2) + ' ($' + totalPrem.toFixed(0) + ' total)',
    notes: notes || `Selling CC against ${w.shares} assigned shares (bought at $${w.assignPrice.toFixed(2)})`,
    time: 'Just now',
    timestamp: Date.now(),
    kind: 'signal',
    status: 'open',
    wheelId: w.id
  };
  if (!S.adminPosts) S.adminPosts = [];
  S.adminPosts.unshift(ccSignal);
  save();
  savePostToFirebase(ccSignal).catch(e => console.warn('CC signal save error:', e));

  const totalCCPrem = w.ccHistory.reduce((s, cc) => s + (cc.premiumTotal || 0), 0);
  const totalPremium = (w.totalPremiumCollected || 0) + totalCCPrem;

  closeCCSellModal();
  renderWheelPositions();
  renderAdminPosts();
  renderSignals();
  renderHome();
  showToast(`Sold ${contracts} CC at $${ccStrike} for $${totalPrem.toFixed(0)} · Total premiums: $${totalPremium.toFixed(0)}`, 'success');
}

// Close an active CC (expired worthless or bought back)
function closeCCOnWheel(wheelId, ccId) {
  const w = (S.wheelPositions || []).find(x => x.id === wheelId);
  if (!w) return;
  const cc = w.ccHistory.find(c => c.id === ccId);
  if (!cc) return;

  cc.status = 'closed';
  cc.closedAt = Date.now();

  // Also update the linked CC signal post to 'winner' (expired worthless = win for seller)
  const ccPost = (S.adminPosts || []).find(p => p.wheelId === wheelId && p.type === 'cc' && p.strike === cc.strike && p.status === 'open');
  if (ccPost) {
    ccPost.status = 'winner';
    ccPost.closedAt = Date.now();
    (async () => {
      if (await initFirebase() && ccPost.id) {
        firebase.database().ref('posts/' + ccPost.id).update({ status: 'winner', closedAt: Date.now() }).catch(e => console.warn(e));
      }
    })();
  }

  save();
  renderWheelPositions();
  renderAdminPosts();
  renderSignals();
  showToast(`CC $${cc.strike} closed · Premium kept: +$${cc.premiumTotal.toFixed(0)}`, 'success');
}

// Called away — shares sold at CC strike, complete the wheel
function calledAwayWheel(wheelId) {
  const w = (S.wheelPositions || []).find(x => x.id === wheelId);
  if (!w) return;

  const totalCCPrem = w.ccHistory.reduce((s, cc) => s + (cc.premiumTotal || 0), 0);
  const lastCC = w.ccHistory.length > 0 ? w.ccHistory[w.ccHistory.length - 1] : null;
  const defaultStrike = lastCC ? lastCC.strike.toString() : w.assignPrice.toString();

  showPrompt(`${w.symbol} called away! At what strike price?`, defaultStrike, (strikeStr) => {
    const callStrike = parseFloat(strikeStr);
    if (!callStrike) return showToast('Enter the call strike', 'error');

    // Stock P&L = (sell price - buy price) × shares
    // Bought at assignPrice, sold at callStrike
    const stockPnl = (callStrike - w.assignPrice) * w.shares;
    // Total premiums = CSP premium + all CC premiums
    const totalPremium = (w.totalPremiumCollected || 0) + totalCCPrem;
    // Final P&L = stock gain/loss + all premiums collected
    const finalPnl = stockPnl + totalPremium;

    const assignDate = w.assignedAt ? new Date(w.assignedAt) : new Date();
    const completeDate = new Date();
    const daysHeld = Math.max(1, Math.round((completeDate - assignDate) / 86400000));

    // Build wheel summary for Firebase (so users can see it)
    const wheelSummary = {
      assignPrice: w.assignPrice,
      cspPremium: w.totalPremiumCollected || 0,
      ccPremium: totalCCPrem,
      totalPremium: totalPremium,
      stockPnl: stockPnl,
      callStrike: callStrike,
      finalPnl: finalPnl,
      shares: w.shares,
      ccCount: w.ccHistory.length,
      daysHeld: daysHeld,
      assignedAt: w.assignedAt,
      completedAt: Date.now(),
      ccHistory: w.ccHistory.map(cc => ({
        strike: cc.strike, exp: cc.exp,
        premiumTotal: cc.premiumTotal || 0,
        outcome: cc.outcome || cc.status
      }))
    };

    // Book the called away PnL to trade history
    S.history = S.history || [];
    S.history.unshift({
      id: 'called-' + Date.now(),
      symbol: w.symbol,
      type: 'wheel',
      strike: callStrike,
      premium: 0,
      contracts: w.contracts,
      openDate: new Date(w.assignedAt).toISOString(),
      closeDate: new Date().toISOString(),
      pnl: finalPnl,
      grossPnl: finalPnl,
      fees: 0,
      outcome: 'called_away',
      wheelSummary: wheelSummary
    });

    // Mark wheel position as completed
    w.status = 'completed';
    w.completedAt = Date.now();
    w.callStrike = callStrike;
    w.finalPnl = finalPnl;

    // Update ALL linked posts to 'called' + save wheel summary to CSP post
    const linkedPosts = (S.adminPosts || []).filter(p => p.wheelId === wheelId);
    linkedPosts.forEach(lp => {
      if (lp.status !== 'called' && lp.status !== 'winner') {
        lp.status = 'called';
        lp.calledAt = Date.now();
      }
      // Save wheelSummary on CSP post so users can see the full recap
      if (lp.type === 'csp') {
        lp.wheelComplete = true;
        lp.wheelSummary = wheelSummary;
      }
    });

    // Sync to Firebase
    (async () => {
      if (await initFirebase()) {
        for (const lp of linkedPosts) {
          if (!lp.id) continue;
          const updates = { status: lp.status || 'called', calledAt: Date.now() };
          if (lp.type === 'csp') {
            updates.wheelComplete = true;
            updates.wheelSummary = wheelSummary;
          }
          firebase.database().ref('posts/' + lp.id).update(updates).catch(e => console.warn(e));
        }
      }
    })();

    // Sync ccHistory entries to closed
    w.ccHistory.forEach(cc => { cc.status = 'closed'; });

    save();
    renderWheelPositions();
    renderAdminPosts();
    renderSignals();
    renderHome();

    // Show the full recap modal instead of just a toast
    showWheelRecap(w.id);

    // Notify users
    sendAssignmentNotification({ ticker: w.symbol, strike: callStrike }, 'called').catch(e => console.warn(e));
  });
}

function renderAdminPosts() {
  const c = $('adminPostsList');
  if (!c) return;
  const posts = S.adminPosts || [];
  // Filter out posts linked to completed wheels (wheel is done, no actions needed)
  const activePosts = posts.filter(p => {
    if (p.wheelId) {
      const linkedWheel = (S.wheelPositions || []).find(w => w.id === p.wheelId);
      if (linkedWheel && linkedWheel.status === 'completed') return false;
    }
    // Also hide called/closed CC/CSP posts (already in history)
    if (p.kind === 'signal' && (p.status === 'called' || p.status === 'winner' || p.status === 'closed')) return false;
    return true;
  });
  if (!activePosts.length) {
    c.innerHTML = '<p style="color:var(--text3);font-size:13px;text-align:center;padding:16px">No active posts</p>';
    return;
  }
  c.innerHTML = activePosts.slice(0, 15).map((p, i) => {
    let label = '', showActions = false, statusBadge = '';
    const status = p.status || 'open';

    if (p.kind === 'signal') {
      label = `<span style="color:var(--${p.type==='csp'?'green':'blue'})">${p.type.toUpperCase()}</span> ${p.ticker} $${p.strike}`;
      showActions = true;
      if (status === 'winner') statusBadge = '<span class="status-badge winner">WIN 🎉</span>';
      else if (status === 'rolled') statusBadge = '<span class="status-badge rolled">ROLLED</span>';
      else if (status === 'assigned') statusBadge = '<span class="status-badge assigned">ASSIGNED 📦</span>';
      else if (status === 'called') statusBadge = '<span class="status-badge called">CALLED AWAY 📤</span>';
      else if (status === 'closed') statusBadge = '<span class="status-badge closed">CLOSED</span>';
      else statusBadge = '<span class="status-badge open">OPEN</span>';
    } else if (p.kind === 'announcement') {
      label = `<span style="color:var(--orange)">ANN</span> ${p.title}`;
    } else if (p.kind === 'roll') {
      label = `<span style="color:var(--purple)">ROLL</span> ${p.original?.split(' ')[0] || 'Position'}`;
    }

    // Different actions based on signal type and status
    let actions = '';
    // Use index into original S.adminPosts array (not filtered activePosts)
    const pidx = posts.indexOf(p);
    if (showActions && status === 'open') {
      if (p.type === 'csp') {
        actions = `<div class="post-actions">
          <button type="button" class="post-action-btn winner" onclick="adminAction('winner',${pidx})">🎉 Winner</button>
          <button type="button" class="post-action-btn assigned" onclick="adminAction('assigned',${pidx})">📦 Assigned</button>
          <button type="button" class="post-action-btn roll" onclick="adminAction('roll',${pidx})">🔄 Roll</button>
          <button type="button" class="post-action-btn delete" onclick="adminAction('delete',${pidx})">✕</button>
        </div>`;
      } else {
        actions = `<div class="post-actions">
          <button type="button" class="post-action-btn winner" onclick="adminAction('winner',${pidx})">🎉 Winner</button>
          <button type="button" class="post-action-btn called" onclick="adminAction('called',${pidx})">📤 Called</button>
          <button type="button" class="post-action-btn roll" onclick="adminAction('roll',${pidx})">🔄 Roll</button>
          <button type="button" class="post-action-btn delete" onclick="adminAction('delete',${pidx})">✕</button>
        </div>`;
      }
    } else if (showActions && status === 'assigned' && p.wheelId) {
      // Assigned CSP: show wheel info + management buttons
      const wId = p.wheelId;
      const wPos = (S.wheelPositions || []).find(x => x.id === wId);
      let wheelInfo = '';
      if (wPos && wPos.status === 'holding') {
        const totalCCPrem = wPos.ccHistory.reduce((s, cc) => s + (cc.premiumTotal || 0), 0);
        const adjBasis = wPos.costBasis - (totalCCPrem / wPos.shares);
        wheelInfo = `<div style="font-size:11px;color:var(--text3);margin:4px 0 6px;padding:6px;background:var(--input);border-radius:6px">
          <b>${wPos.shares}</b> shares · Cost basis: <b>$${adjBasis.toFixed(2)}</b> · CCs sold: <b>${wPos.ccHistory.length}</b>${totalCCPrem > 0 ? ` · CC income: <span style="color:var(--green)">$${totalCCPrem.toFixed(0)}</span>` : ''}
        </div>`;
        actions = `${wheelInfo}<div class="post-actions">
          <button type="button" class="post-action-btn" onclick="sellCCOnWheel('${wId}')" style="background:var(--blue);color:#fff">📝 Sell CC</button>
          <button type="button" class="post-action-btn called" onclick="calledAwayWheel('${wId}')">📤 Called Away</button>
          <button type="button" class="post-action-btn delete" onclick="adminAction('delete',${pidx})">✕</button>
        </div>`;
      } else if (wPos && wPos.status === 'completed') {
        const pnlStr = wPos.finalPnl >= 0 ? `+$${wPos.finalPnl.toFixed(0)}` : `-$${Math.abs(wPos.finalPnl).toFixed(0)}`;
        wheelInfo = `<div style="font-size:11px;color:var(--text3);margin:4px 0 6px;padding:6px;background:var(--input);border-radius:6px">
          Wheel complete · P&L: <b style="color:${wPos.finalPnl>=0?'var(--green)':'var(--red)'}">${pnlStr}</b>
        </div>`;
        actions = `${wheelInfo}<div class="post-actions"><button type="button" class="post-action-btn delete" onclick="adminAction('delete',${pidx})">✕</button></div>`;
      } else {
        actions = `<div class="post-actions"><button type="button" class="post-action-btn delete" onclick="adminAction('delete',${pidx})">✕</button></div>`;
      }
    } else {
      actions = `<div class="post-actions"><button type="button" class="post-action-btn delete" onclick="adminAction('delete',${pidx})">Delete</button></div>`;
    }

    return `<div style="padding:10px 0;border-bottom:1px solid var(--border)">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:13px">${label}${statusBadge}</span>
        <span style="font-size:11px;color:var(--text3)">${getTimeAgo(p.timestamp)}</span>
      </div>
      ${actions}
    </div>`;
  }).join('');
}

// Central admin action dispatcher — uses array index for reliable post lookup
function adminAction(action, idx) {
  try {
    const posts = S.adminPosts || [];
    const post = posts[idx];
    if (!post) { alert('Post not found at index ' + idx + ' (total: ' + posts.length + ')'); return; }
    const postId = post.id || idx;
    closeModal('adminModal'); // Always close admin first so prompts/toasts are visible
    if (action === 'winner') markPostWinner(postId, post);
    else if (action === 'assigned') markPostAssigned(postId, post);
    else if (action === 'roll') markPostRolled(postId, post);
    else if (action === 'called') markPostCalled(postId, post);
    else if (action === 'delete') { deletePost(postId).then(() => openAdmin()); }
  } catch(e) {
    alert('Admin action error: ' + e.message);
    console.error('[adminAction] error:', e);
  }
}

// Mark post as winner (with celebration!)
function markPostWinner(postId, postRef) {
  try {
    const post = postRef || (S.adminPosts || []).find(p => p.id === postId);
    if (!post) { alert('markPostWinner: post not found'); return; }

    post.status = 'winner';
    post.closedAt = Date.now();

    // If this CC is linked to a wheel, close the active CC in ccHistory
    if (post.wheelId && post.type === 'cc') {
      const wheel = (S.wheelPositions || []).find(w => w.id === post.wheelId);
      if (wheel) {
        const activeCC = wheel.ccHistory.find(cc => cc.status === 'open');
        if (activeCC) {
          activeCC.status = 'closed';
          activeCC.closedAt = Date.now();
          activeCC.outcome = 'winner';
        }
      }
    }

    // Update local state immediately
    save();
    showCelebration(post);
    showToast(`${post.ticker} marked as WINNER! 🎉`, 'success');

    // Re-render everything
    renderSignals();
    renderAlertsFeed();
    renderWheelPositions();
    renderHome();

    // Reopen admin after brief delay
    setTimeout(() => openAdmin(), 500);

    // Firebase + notifications in background (don't block UI)
    (async () => {
      if (await initFirebase() && post.id) {
        firebase.database().ref('posts/' + post.id).update({ status: 'winner', closedAt: Date.now() }).catch(e => console.warn(e));
      }
      sendWinnerNotification(post).catch(e => console.warn(e));
    })();
  } catch(e) {
    alert('markPostWinner error: ' + e.message);
    console.error(e);
  }
}

// Mark post as rolled
function markPostRolled(postId, postRef) {
  try {
  const post = postRef || (S.adminPosts || []).find(p => p.id === postId);
  if (!post) { alert('markPostRolled: post not found'); return; }

  // adminAction already closed the admin modal
  const origPrem = parseFloat((post.prem || '').replace(/[$,]/g, '')) || 0;
  const prevRollCredits = (post.rollHistory || []).reduce((s, r) => s + (r.netCredit || r.premiumPerShare || 0), 0);
  const totalPrevPrem = origPrem + prevRollCredits;

  // Step 1: New strike
  showPrompt(`Roll ${post.ticker} $${post.strike}${post.type==='csp'?'P':'C'} — New strike?`, '', (strikeStr) => {
    const newStrike = parseFloat(strikeStr);
    if (!newStrike) return showToast('Enter a valid strike', 'error');

    // Step 2: New expiration
    showPrompt('New expiration? (e.g. Feb 21)', '', (newExp) => {
      if (!newExp) return showToast('Enter expiration', 'error');

      // Step 3: Net credit of the roll (negative = debit roll)
      showPrompt(`Net credit per share for this roll? (negative if debit roll, e.g. -2.50 or 1.50)\nPrevious total premium: $${totalPrevPrem.toFixed(2)}/share`, '', async (premStr) => {
        const netCredit = parseFloat(premStr);
        if (isNaN(netCredit)) return showToast('Enter net credit (can be negative)', 'error');

        const totalPrem = totalPrevPrem + netCredit;
        const contracts = post.assignedContracts || 1;

        // Mark original as ROLLED
        post.status = 'rolled';
        post.closedAt = Date.now();
        post.rolledToStrike = newStrike;
        post.rolledToExp = newExp;

        // Save rolled status immediately (before any async Firebase calls)
        save();

        // Create NEW open signal for the rolled-to position
        const newSignal = {
          type: post.type,
          ticker: post.ticker,
          strike: newStrike,
          exp: newExp,
          prem: '$' + netCredit.toFixed(2),
          delta: post.delta || '',
          notes: `Rolled from $${post.strike} · Net credit: ${netCredit >= 0 ? '+' : ''}$${netCredit.toFixed(2)}/share · Total net premium: $${(totalPrem * 100).toFixed(0)} (${(post.rollHistory||[]).length + 1} rolls)`,
          time: 'Just now',
          timestamp: Date.now(),
          kind: 'signal',
          rolledFrom: post.id,
          rollHistory: [...(post.rollHistory || []), { strike: post.strike, exp: post.exp, premiumPerShare: origPrem, netCredit: netCredit, rolledAt: Date.now() }],
          totalPremiumCollected: totalPrem,
          rollCount: (post.rollCount || 0) + 1
        };
        // savePostToFirebase handles its own local state + save + renders
        savePostToFirebase(newSignal).catch(e => console.warn('Roll signal save error:', e));

        // Post roll notification for users
        const creditStr = netCredit >= 0 ? `+$${(netCredit * 100).toFixed(0)} credit` : `-$${(Math.abs(netCredit) * 100).toFixed(0)} debit`;
        const rollNotif = {
          original: `${post.ticker} $${post.strike}${post.type==='csp'?'P':'C'} ${post.exp}`,
          newPos: `${post.ticker} $${newStrike}${post.type==='csp'?'P':'C'} ${newExp}`,
          credit: creditStr,
          notes: `Total premium collected across rolls: $${(totalPrem * 100).toFixed(0)}`,
          time: 'Just now',
          timestamp: Date.now() + 2,
          kind: 'roll'
        };
        savePostToFirebase(rollNotif).catch(e => console.warn('Roll notif save error:', e));

        // Update original post in Firebase (fire-and-forget)
        (async () => {
          try {
            if (await initFirebase() && post.id) {
              firebase.database().ref('posts/' + post.id).update({
                status: 'rolled', closedAt: Date.now(),
                rolledToStrike: newStrike, rolledToExp: newExp
              }).catch(e => console.warn(e));
            }
          } catch(e) { console.warn('Firebase roll update failed:', e); }
        })();

        renderHome();
        const rollCreditStr = netCredit >= 0 ? `+$${(netCredit * 100).toFixed(0)} credit` : `-$${(Math.abs(netCredit) * 100).toFixed(0)} debit`;
        showToast(`Rolled ${post.ticker} to $${newStrike} ${newExp} · ${rollCreditStr} · Net premium: $${(totalPrem * 100).toFixed(0)}`, 'success');
        setTimeout(() => openAdmin(), 300);
      });
    });
  });
  } catch(e) { alert('markPostRolled error: ' + e.message); console.error(e); }
}

// Mark CSP as assigned (now holding shares, start selling CCs)
// Assignment is NOT a closing trade — it's a transition to holding shares at a loss.
// Cost basis = strike - premium per share. Unrealized loss = (stock price - cost basis) × shares.
function markPostAssigned(postId, postRef) {
  try {
  const post = postRef || (S.adminPosts || []).find(p => p.id === postId);
  if (!post) { alert('markPostAssigned: post not found'); return; }

  // Guard: don't assign twice
  if (post.status === 'assigned' || post.wheelId) { showToast('Already assigned', 'error'); return; }
  if ((S.wheelPositions || []).find(w => w.cspSignalId === post.id)) { showToast('Wheel position already exists for this CSP', 'error'); return; }

  // adminAction already closed the admin modal
  // Fetch live stock price first, then prompt for contracts
  showToast(`Fetching ${post.ticker} price...`, '');
  fetchLiveQuote(post.ticker).then(quote => {
    const livePrice = quote?.price || quote?.close || 0;
    const priceDisplay = livePrice > 0 ? livePrice.toFixed(2) : post.strike.toString();

    showPrompt(`${post.ticker} assigned at $${post.strike} strike. Current price: $${priceDisplay}. Confirm price or adjust:`, priceDisplay, (priceStr) => {
      const currentPrice = parseFloat(priceStr);
      if (!currentPrice || currentPrice <= 0) return showToast('Enter a valid price', 'error');

      showPrompt('How many contracts were assigned?', '1', (conStr) => {
        const contracts = parseInt(conStr) || 1;
        const shares = contracts * 100;

        // Premium per share from CSP (including any roll premiums)
        const premPerShare = post.totalPremiumCollected || parseFloat((post.prem || '').replace(/[$,]/g, '')) || 0;

        // Cost basis = STRIKE price (what you actually paid per share when assigned)
        // Premium is tracked separately as income, NOT baked into cost basis
        const costBasis = post.strike;

        // Total premium in dollars (income collected from selling the CSP)
        const totalPremDollars = premPerShare * 100 * contracts;

        // Stock P&L = (current price - strike) × shares (NEGATIVE at assignment, stock dropped)
        const stockPnl = (currentPrice - costBasis) * shares;
        // Net P&L = stock loss + premium income
        const netPnl = stockPnl + totalPremDollars;

        // Create wheel position — this is an OPEN position, not a closed trade
        if (!S.wheelPositions) S.wheelPositions = [];
        const wheelPos = {
          id: Date.now().toString(),
          symbol: post.ticker,
          shares: shares,
          contracts: contracts,
          assignPrice: post.strike,
          currentPrice: currentPrice,
          cspPremium: premPerShare,
          costBasis: costBasis,
          originalCostBasis: costBasis,
          assignedAt: Date.now(),
          cspSignalId: post.id,
          status: 'holding',
          ccHistory: [],
          totalPremiumCollected: totalPremDollars
        };
        S.wheelPositions.push(wheelPos);

        // Update post status — link to wheel position for admin panel buttons
        post.status = 'assigned';
        post.assignedAt = Date.now();
        post.assignmentPrice = currentPrice;
        post.assignedContracts = contracts;
        post.wheelId = wheelPos.id;

        // Save and render FIRST (before any async Firebase calls)
        save();
        renderAdminPosts();
        renderWheelPositions();
        renderSignals();
        renderAlertsFeed();
        renderHome();

        // Show real numbers: stock loss + premium income = net
        const stockStr = stockPnl >= 0 ? `+$${stockPnl.toFixed(0)}` : `-$${Math.abs(stockPnl).toFixed(0)}`;
        const netStr = netPnl >= 0 ? `+$${netPnl.toFixed(0)}` : `-$${Math.abs(netPnl).toFixed(0)}`;
        showToast(`${post.ticker} assigned! ${shares} shares at $${costBasis.toFixed(2)} · Stock: ${stockStr} · Premium: +$${totalPremDollars.toFixed(0)} · Net: ${netStr}`, '');
        setTimeout(() => openAdmin(), 300);

        // Firebase + notifications (fire-and-forget)
        (async () => {
          try {
            if (await initFirebase() && post.id) {
              firebase.database().ref('posts/' + post.id).update({
                status: 'assigned', assignedAt: Date.now(),
                assignmentPrice: currentPrice, assignedContracts: contracts, wheelId: wheelPos.id
              }).catch(e => console.warn(e));
            }
            sendAssignmentNotification(post, 'assigned').catch(e => console.warn(e));
          } catch(e) { console.warn('Firebase sync failed:', e); }
        })();
      });
    });
  }).catch(e => {
    console.warn('Live quote fetch failed:', e);
    // Fallback: prompt for price manually
    showPrompt(`${post.ticker} assigned at $${post.strike}. Current stock price?`, post.strike.toString(), (priceStr) => {
      // Re-enter the flow with manual price
      const fakeQuote = { price: parseFloat(priceStr) };
      // Store temporarily and re-call
      const currentPrice = parseFloat(priceStr);
      if (!currentPrice || currentPrice <= 0) return showToast('Enter a valid price', 'error');
      showPrompt('How many contracts were assigned?', '1', (conStr) => {
        const contracts = parseInt(conStr) || 1;
        const shares = contracts * 100;
        const premPerShare = post.totalPremiumCollected || parseFloat((post.prem || '').replace(/[$,]/g, '')) || 0;
        const costBasis = post.strike;
        const totalPremDollars = premPerShare * 100 * contracts;
        const stockPnl = (currentPrice - costBasis) * shares;
        const netPnl = stockPnl + totalPremDollars;
        if (!S.wheelPositions) S.wheelPositions = [];
        const wheelPos = { id: Date.now().toString(), symbol: post.ticker, shares, contracts, assignPrice: post.strike, currentPrice, cspPremium: premPerShare, costBasis, originalCostBasis: costBasis, assignedAt: Date.now(), cspSignalId: post.id, status: 'holding', ccHistory: [], totalPremiumCollected: totalPremDollars };
        S.wheelPositions.push(wheelPos);
        post.status = 'assigned'; post.assignedAt = Date.now(); post.assignmentPrice = currentPrice; post.assignedContracts = contracts; post.wheelId = wheelPos.id;
        save(); renderAdminPosts(); renderWheelPositions(); renderSignals(); renderAlertsFeed(); renderHome();
        const stockStr = stockPnl >= 0 ? `+$${stockPnl.toFixed(0)}` : `-$${Math.abs(stockPnl).toFixed(0)}`;
        const netStr = netPnl >= 0 ? `+$${netPnl.toFixed(0)}` : `-$${Math.abs(netPnl).toFixed(0)}`;
        showToast(`${post.ticker} assigned! ${shares} shares at $${costBasis.toFixed(2)} · Stock: ${stockStr} · Premium: +$${totalPremDollars.toFixed(0)} · Net: ${netStr}`, '');
        setTimeout(() => openAdmin(), 300);
        (async () => { try { if (await initFirebase() && post.id) { firebase.database().ref('posts/' + post.id).update({ status: 'assigned', assignedAt: Date.now(), assignmentPrice: currentPrice, assignedContracts: contracts, wheelId: wheelPos.id }).catch(e => console.warn('Firebase assignment sync:', e)); } sendAssignmentNotification(post, 'assigned').catch(e => console.warn(e)); } catch(e) { console.warn('Assignment sync error:', e); } })();
      });
    });
  });
  } catch(e) { alert('markPostAssigned error: ' + e.message); console.error(e); }
}

// Mark CC as called away (shares sold, back to selling CSPs)
function markPostCalled(postId, postRef) {
  const post = postRef || (S.adminPosts || []).find(p => p.id === postId);
  if (!post) { alert('markPostCalled: post not found'); return; }

  // Check if this CC is linked to a wheel position
  const wheelPos = post.wheelId ? (S.wheelPositions || []).find(w => w.id === post.wheelId) : null;

  if (wheelPos && wheelPos.status === 'holding') {
    calledAwayWheel(wheelPos.id);
    post.status = 'called';
    post.calledAt = Date.now();
    save();
    // Firebase in background
    (async () => {
      if (await initFirebase() && post.id) {
        firebase.database().ref('posts/' + post.id).update({ status: 'called', calledAt: Date.now() }).catch(e => console.warn(e));
      }
    })();
    setTimeout(() => openAdmin(), 300);
    return;
  }

  if (wheelPos && wheelPos.status === 'completed') {
    showToast('This wheel is already completed', '');
    return;
  }

  post.status = 'called';
  post.calledAt = Date.now();
  save();
  renderSignals();
  renderHome();
  showToast(`${post.ticker} called away! Back to selling puts 📤`, 'success');
  setTimeout(() => openAdmin(), 300);

  // Firebase + notifications in background
  (async () => {
    if (await initFirebase() && post.id) {
      firebase.database().ref('posts/' + post.id).update({ status: 'called', calledAt: Date.now() }).catch(e => console.warn(e));
    }
    sendAssignmentNotification(post, 'called').catch(e => console.warn(e));
  })();
}

// Send notification for assigned/called
async function sendAssignmentNotification(post, type) {
  await sendDiscordNotification({ ...post, kind: type });
  await sendEmailNotifications({
    ...post,
    kind: type,
    message: type === 'assigned'
      ? `CSP assigned - now holding shares, will sell covered calls`
      : `CC exercised - shares called away, back to selling puts`
  });
}

// Show celebration animation
function showCelebration(post) {
  // Create overlay with text
  const overlay = document.createElement('div');
  overlay.className = 'celebration-overlay';
  overlay.innerHTML = `<div class="celebration-text">🎉 WINNER! 🎉</div>`;
  document.body.appendChild(overlay);

  // Create confetti
  const colors = ['#34c759', '#007aff', '#ff9500', '#af52de', '#ff3b30', '#ffcc00'];
  for (let i = 0; i < 50; i++) {
    setTimeout(() => {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + 'vw';
      confetti.style.top = '-10px';
      confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
      confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 4000);
    }, i * 30);
  }

  // Remove overlay after animation
  setTimeout(() => overlay.remove(), 2500);

  showToast(`${post.ticker} closed for profit! 🎉`, 'success');
}

// Send winner notification
async function sendWinnerNotification(post) {
  await sendDiscordNotification({ ...post, kind: 'winner' });
  await sendEmailNotifications({ ...post, kind: 'winner' });
}

function getTimeAgo(ts) {
  const mins = Math.floor((Date.now() - ts) / 60000);
  if (mins < 1) return 'Just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  return days + 'd ago';
}

initAdminAccess();
const logo=s=>'https://financialmodelingprep.com/image-stock/'+s.toUpperCase()+'.png';
function load(){try{const d=localStorage.getItem('meV6');if(d)Object.assign(S,JSON.parse(d));cleanOrphanedHistory()}catch(e){}}
function save(){try{localStorage.setItem('meV6',JSON.stringify(S))}catch(e){}}
function cleanOrphanedHistory(){
  if(!S.history||!S.history.length)return;
  const wheels=S.wheelPositions||[];
  const before=S.history.length;
  S.history=S.history.filter(h=>{
    if(h.outcome==='called_away'){
      // Keep only if a matching completed wheel still exists in wheelPositions
      return wheels.some(w=>w.status==='completed'&&w.symbol===h.symbol);
    }
    return true;
  });
  if(S.history.length<before)save();
}
function checkLegal(){if(!S.legalOk)openModal('legalModal')}
function acceptLegal(){S.legalOk=true;save();closeModal('legalModal')}
const THEMES = ['light','dark','pro','luxury','retro','fun','clean'];
const THEME_NAMES = {light:'Light',dark:'Dark',pro:'Pro Trader',luxury:'Luxury',retro:'80s Retro',fun:'Fun',clean:'Minimal'};

function setTheme(t){
  if (THEMES.includes(t)) S.theme = t;
  applyTheme();save();
  showToast(`Theme: ${THEME_NAMES[S.theme]}`,'success');
}
function toggleTheme(){
  const idx = THEMES.indexOf(S.theme);
  S.theme = THEMES[(idx + 1) % THEMES.length];
  applyTheme();save();
}
function applyTheme(){
  document.documentElement.setAttribute('data-theme',S.theme);
  // Sync dropdowns
  ['themeSelect','qThemeSelect'].forEach(id=>{if($(id))$(id).value=S.theme});
}
function nav(t){document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));$(`${t}Tab`)?.classList.add('active');document.querySelector(`.nav-btn[data-tab="${t}"]`)?.classList.add('active');if(t==='home')renderHome();if(t==='watch')renderWatch();if(t==='alerts')renderAlerts();if(t==='signals')renderSignals();if(t==='profile')renderProfile()}
function goCalc(m){nav('calc');setMode(m)}
function openModal(id){$(id)?.classList.add('show')}
function closeModal(id){$(id)?.classList.remove('show')}
function saveTwelveDataKey(){const k=$('qTwelveKey')?.value.trim();if(k){localStorage.setItem('twelveDataKey',k);showToast('Market data key saved!','success');Object.keys(priceCache).forEach(k=>delete priceCache[k])}else{showToast('Enter a key first','error')}}
function saveGroqKey(){const k=$('qGroqKey')?.value.trim();if(k){localStorage.setItem('groqApiKey',k);showToast('AI key saved!','success')}else{showToast('Enter a key first','error')}}
function openSettings(){$('qApiKey').value=S.apiKey;$('qSecretKey').value=S.secretKey;if($('qBalanceInput'))$('qBalanceInput').value=S.startingBalance||S.balance||S.accSize||25000;loadEmailSettings();applyTheme();openModal('settingsModal')}
function quickSaveApi(){S.apiKey=$('qApiKey').value.trim();S.secretKey=$('qSecretKey').value.trim();save();updateStatus();closeModal('settingsModal');if(S.apiKey)showToast('API keys saved!','success')}
function confirmSignOut() {
  showConfirm('Sign Out', 'Are you sure you want to sign out?', signOut);
}

function showConfirm(title, message, onConfirm) {
  $('confirmTitle').textContent = title;
  $('confirmMessage').textContent = message;
  $('confirmAction').onclick = () => { closeModal('confirmModal'); onConfirm(); };
  // Reset cancel button to default state (closePosition overrides it)
  const cancelBtn = $('confirmModal').querySelector('.btn-outline');
  if (cancelBtn) { cancelBtn.textContent = 'Cancel'; cancelBtn.onclick = () => closeModal('confirmModal'); }
  openModal('confirmModal');
}

async function signOut(){
  try { if (firebase?.auth) await firebase.auth().signOut(); } catch(e) {}
  // Clear auth state but keep user data for when they log back in
  S.firebaseUid = null;
  S.isGuest = false;
  localStorage.removeItem('meRemember');
  save();
  showAuthScreen();
  showToast('Signed out', '');
}
function dismissNewUser(){S.newUserDismissed=true;save();const b=$('newUserBanner');if(b)b.style.display='none'}
function openAdd(){setAddMode('csp');openModal('addModal')}
// Education System
const EDUCATION = {
  modules: [
    {
      id: 'fundamentals',
      title: 'Options Fundamentals',
      desc: 'Master the basics of options trading',
      icon: '📚',
      color: 'blue',
      level: 'Beginner',
      duration: '45 min',
      chapters: [
        { id: 'what-are-options', title: 'What Are Options?', duration: '8 min' },
        { id: 'calls-vs-puts', title: 'Calls vs Puts Explained', duration: '10 min' },
        { id: 'key-terms', title: 'Essential Options Terms', duration: '12 min' },
        { id: 'options-pricing', title: 'How Options Are Priced', duration: '10 min' },
        { id: 'fundamentals-quiz', title: 'Chapter Quiz', duration: '5 min', isQuiz: true }
      ]
    },
    {
      id: 'greeks',
      title: 'Understanding the Greeks',
      desc: 'Learn the forces that move option prices',
      icon: '🔬',
      color: 'purple',
      level: 'Beginner',
      duration: '40 min',
      chapters: [
        { id: 'delta-explained', title: 'Delta: Direction & Probability', duration: '10 min' },
        { id: 'theta-decay', title: 'Theta: Time Decay', duration: '10 min' },
        { id: 'iv-vega', title: 'Implied Volatility & Vega', duration: '12 min' },
        { id: 'greeks-quiz', title: 'Chapter Quiz', duration: '5 min', isQuiz: true }
      ]
    },
    {
      id: 'wheel-overview',
      title: 'The Wheel Strategy',
      desc: 'Complete overview of the wheel approach',
      icon: '🎡',
      color: 'green',
      level: 'Intermediate',
      duration: '35 min',
      chapters: [
        { id: 'wheel-intro', title: 'What Is The Wheel?', duration: '8 min' },
        { id: 'wheel-cycle', title: 'The Full Wheel Cycle', duration: '12 min' },
        { id: 'wheel-benefits', title: 'Why The Wheel Works', duration: '10 min' },
        { id: 'wheel-quiz', title: 'Chapter Quiz', duration: '5 min', isQuiz: true }
      ]
    },
    {
      id: 'csp-deep',
      title: 'Cash Secured Puts',
      desc: 'Deep dive into selling puts for income',
      icon: '📉',
      color: 'green',
      level: 'Intermediate',
      duration: '50 min',
      chapters: [
        { id: 'csp-basics', title: 'CSP Fundamentals', duration: '10 min' },
        { id: 'csp-stock-selection', title: 'Selecting The Right Stock', duration: '12 min' },
        { id: 'csp-strike-exp', title: 'Strike & Expiration Selection', duration: '12 min' },
        { id: 'csp-management', title: 'Managing Your CSP', duration: '10 min' },
        { id: 'csp-quiz', title: 'Chapter Quiz', duration: '5 min', isQuiz: true }
      ]
    },
    {
      id: 'cc-deep',
      title: 'Covered Calls',
      desc: 'Generate income from your shares',
      icon: '📈',
      color: 'blue',
      level: 'Intermediate',
      duration: '45 min',
      chapters: [
        { id: 'cc-basics', title: 'Covered Call Fundamentals', duration: '10 min' },
        { id: 'cc-when-to-sell', title: 'When To Sell Covered Calls', duration: '10 min' },
        { id: 'cc-strike-selection', title: 'Strike Price Strategy', duration: '12 min' },
        { id: 'cc-management', title: 'Managing Your Covered Calls', duration: '8 min' },
        { id: 'cc-quiz', title: 'Chapter Quiz', duration: '5 min', isQuiz: true }
      ]
    },
    {
      id: 'beau-strategy',
      title: "Beau's Elite Strategy",
      desc: 'The exact system used by Market Elites',
      icon: '🎯',
      color: 'orange',
      level: 'Advanced',
      duration: '55 min',
      chapters: [
        { id: 'beau-philosophy', title: 'Trading Philosophy', duration: '8 min' },
        { id: 'beau-entry', title: 'Entry Criteria & Setup', duration: '15 min' },
        { id: 'beau-management', title: 'Position Management', duration: '12 min' },
        { id: 'beau-risk', title: 'Risk Management Rules', duration: '12 min' },
        { id: 'beau-mistakes', title: 'Common Mistakes To Avoid', duration: '8 min' },
        { id: 'beau-quiz', title: 'Final Assessment', duration: '10 min', isQuiz: true }
      ]
    },
    {
      id: 'app-guide',
      title: 'Using Market Elites',
      desc: 'Get the most out of this app',
      icon: '📱',
      color: 'blue',
      level: 'Beginner',
      duration: '20 min',
      chapters: [
        { id: 'app-overview', title: 'App Overview', duration: '5 min' },
        { id: 'app-signals', title: 'Following Signals', duration: '8 min' },
        { id: 'app-calculator', title: 'Using The Calculator', duration: '7 min' }
      ]
    }
  ]
};

let learnHistory = [];
let currentQuiz = null;
let quizAnswers = {};

function openLearn() {
  learnHistory = [];
  showModuleList();
  openModal('learnModal');
}

function goBackLearn() {
  if (learnHistory.length > 1) {
    learnHistory.pop();
    const prev = learnHistory[learnHistory.length - 1];
    if (prev.type === 'modules') showModuleList(false);
    else if (prev.type === 'chapters') showChapterList(prev.moduleId, false);
  } else {
    showModuleList(false);
  }
}

function showModuleList(addHistory = true) {
  if (addHistory) learnHistory.push({ type: 'modules' });
  $('learnTitle').textContent = 'Elite Trading Academy';
  $('learnBackBtn').style.display = 'none';

  const progress = getLearnProgress();
  const totalChapters = EDUCATION.modules.reduce((sum, m) => sum + m.chapters.length, 0);
  const completedChapters = Object.keys(progress).filter(k => progress[k]).length;
  const pct = totalChapters > 0 ? Math.round((completedChapters / totalChapters) * 100) : 0;

  let html = `
    <div style="background:linear-gradient(135deg,var(--blue),var(--purple));border-radius:16px;padding:20px;margin-bottom:20px;color:#fff">
      <div style="font-size:13px;opacity:0.9">Your Progress</div>
      <div style="font-size:28px;font-weight:700;margin:4px 0">${pct}% Complete</div>
      <div class="progress-bar" style="background:rgba(255,255,255,0.3)"><div class="progress-bar-fill" style="width:${pct}%;background:#fff"></div></div>
      <div style="font-size:12px;opacity:0.8;margin-top:8px">${completedChapters} of ${totalChapters} lessons completed</div>
    </div>
  `;

  html += EDUCATION.modules.map(m => {
    const modProgress = m.chapters.filter(c => progress[c.id]).length;
    const modPct = Math.round((modProgress / m.chapters.length) * 100);
    return `
      <div class="learn-module" onclick="showChapterList('${m.id}')">
        <div style="display:flex;align-items:center">
          <div class="learn-module-icon" style="background:var(--${m.color}-bg)">${m.icon}</div>
          <div class="learn-module-info">
            <div class="learn-module-title">${m.title}</div>
            <div class="learn-module-desc">${m.desc}</div>
            <div class="learn-module-meta">
              <span>${m.level}</span>
              <span>${m.duration}</span>
              <span>${modPct}% done</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');

  $('learnContent').innerHTML = html;
}

function showChapterList(moduleId, addHistory = true) {
  const mod = EDUCATION.modules.find(m => m.id === moduleId);
  if (!mod) return;

  if (addHistory) learnHistory.push({ type: 'chapters', moduleId });
  $('learnTitle').textContent = mod.title;
  $('learnBackBtn').style.display = 'flex';

  const progress = getLearnProgress();

  let html = `
    <div style="background:var(--${mod.color}-bg);border-radius:16px;padding:20px;margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <span style="font-size:32px">${mod.icon}</span>
        <div>
          <div style="font-weight:700;font-size:18px">${mod.title}</div>
          <div style="font-size:13px;color:var(--text2)">${mod.chapters.length} lessons · ${mod.duration}</div>
        </div>
      </div>
      <p style="font-size:14px;color:var(--text2);margin:0">${mod.desc}</p>
    </div>
  `;

  html += mod.chapters.map((c, i) => {
    const completed = progress[c.id];
    return `
      <div class="learn-chapter" onclick="showLesson('${moduleId}', '${c.id}')">
        <div class="learn-chapter-num ${completed ? 'completed' : ''}">${completed ? '✓' : i + 1}</div>
        <div class="learn-chapter-title">${c.title}</div>
        <div class="learn-chapter-dur">${c.duration}</div>
      </div>
    `;
  }).join('');

  $('learnContent').innerHTML = html;
}

function getLearnProgress() {
  try {
    return JSON.parse(localStorage.getItem('learnProgress') || '{}');
  } catch (e) { return {}; }
}

function saveLearnProgress(chapterId) {
  const progress = getLearnProgress();
  progress[chapterId] = true;
  localStorage.setItem('learnProgress', JSON.stringify(progress));
}

function showLesson(moduleId, chapterId) {
  const mod = EDUCATION.modules.find(m => m.id === moduleId);
  const chapter = mod?.chapters.find(c => c.id === chapterId);
  if (!mod || !chapter) return;

  learnHistory.push({ type: 'lesson', moduleId, chapterId });
  $('learnTitle').textContent = chapter.title;
  $('learnBackBtn').style.display = 'flex';

  if (chapter.isQuiz) {
    showQuiz(moduleId, chapterId);
    return;
  }

  const content = getLessonContent(chapterId);
  const chapterIndex = mod.chapters.findIndex(c => c.id === chapterId);
  const nextChapter = mod.chapters[chapterIndex + 1];

  let html = `<div class="lesson-content">${content}</div>`;

  html += `
    <div style="display:flex;gap:12px;margin-top:24px">
      <button class="btn btn-outline" style="flex:1" onclick="showChapterList('${moduleId}')">Back to Chapters</button>
      ${nextChapter ? `<button class="btn" style="flex:1" onclick="completeAndNext('${moduleId}', '${chapterId}', '${nextChapter.id}')">Complete & Continue</button>` : `<button class="btn" style="flex:1" onclick="completeLesson('${chapterId}');showChapterList('${moduleId}')">Complete Module</button>`}
    </div>
  `;

  $('learnContent').innerHTML = html;
}

function completeLesson(chapterId) {
  saveLearnProgress(chapterId);
  showToast('Lesson completed! 🎉', 'success');
}

function completeAndNext(moduleId, currentId, nextId) {
  saveLearnProgress(currentId);
  showLesson(moduleId, nextId);
}

// Quiz System
const QUIZZES = {
  'fundamentals-quiz': {
    title: 'Options Fundamentals Quiz',
    questions: [
      {
        q: 'What does an options contract give you the right to do?',
        options: ['Obligation to buy/sell shares', 'Right (not obligation) to buy/sell shares at a set price', 'Free shares from the company', 'Guaranteed profits'],
        correct: 1
      },
      {
        q: 'A PUT option gives the holder the right to:',
        options: ['Buy shares at the strike price', 'Sell shares at the strike price', 'Hold shares indefinitely', 'Receive dividends'],
        correct: 1
      },
      {
        q: 'What does "premium" refer to in options trading?',
        options: ['The strike price of the option', 'The price paid to buy or received to sell an option', 'The expiration date', 'The underlying stock price'],
        correct: 1
      },
      {
        q: 'One standard options contract controls how many shares?',
        options: ['10 shares', '50 shares', '100 shares', '1000 shares'],
        correct: 2
      },
      {
        q: 'If you SELL a put option, you are:',
        options: ['Buying the right to sell shares', 'Taking on the obligation to buy shares if assigned', 'Guaranteed to make money', 'Buying shares immediately'],
        correct: 1
      }
    ]
  },
  'greeks-quiz': {
    title: 'Understanding the Greeks Quiz',
    questions: [
      {
        q: 'What does Delta measure?',
        options: ['Time decay per day', 'Price change per $1 stock move', 'Volatility sensitivity', 'Interest rate sensitivity'],
        correct: 1
      },
      {
        q: 'A put option with delta of -0.25 has approximately what probability of expiring worthless?',
        options: ['25%', '50%', '75%', '100%'],
        correct: 2
      },
      {
        q: 'Theta decay accelerates:',
        options: ['In the first month', 'Evenly throughout the option life', 'As expiration approaches', 'Only on weekends'],
        correct: 2
      },
      {
        q: 'As an option SELLER, theta works:',
        options: ['Against you', 'In your favor', 'Has no effect', 'Only on calls'],
        correct: 1
      },
      {
        q: 'High Implied Volatility means:',
        options: ['Lower option premiums', 'Higher option premiums', 'Guaranteed profit', 'The stock will definitely move'],
        correct: 1
      },
      {
        q: 'When is the best time to SELL options based on IV?',
        options: ['When IV is low', 'When IV is elevated (high IV rank)', 'Right before earnings', 'IV doesn\'t matter'],
        correct: 1
      }
    ]
  },
  'wheel-quiz': {
    title: 'The Wheel Strategy Quiz',
    questions: [
      {
        q: 'The Wheel Strategy consists of which two main phases?',
        options: ['Buy calls, buy puts', 'Sell cash secured puts, sell covered calls', 'Buy shares, sell shares', 'Day trading, swing trading'],
        correct: 1
      },
      {
        q: 'Why is it called "Cash SECURED" puts?',
        options: ['Because you need a security deposit', 'Because you must have cash to buy shares if assigned', 'Because the broker secures your money', 'Because it\'s a guaranteed profit'],
        correct: 1
      },
      {
        q: 'When selling a CSP, you WIN if the stock:',
        options: ['Only goes up significantly', 'Goes up, stays flat, or drops a little', 'Only stays perfectly flat', 'Goes to zero'],
        correct: 1
      },
      {
        q: 'After getting assigned on a CSP, your next step in the wheel is to:',
        options: ['Sell the shares immediately', 'Buy more puts', 'Sell covered calls on your shares', 'Wait for the stock to recover'],
        correct: 2
      },
      {
        q: 'The wheel strategy works best for traders who:',
        options: ['Want quick, large profits', 'Are patient and seek consistent income', 'Only trade during bull markets', 'Prefer high-risk speculation'],
        correct: 1
      }
    ]
  },
  'csp-quiz': {
    title: 'Cash Secured Puts Quiz',
    questions: [
      {
        q: 'What does "Cash Secured" mean?',
        options: ['Using margin to back your puts', 'Having full cash to buy shares if assigned', 'Keeping cash in a savings account', 'Using a secured credit card'],
        correct: 1
      },
      {
        q: 'You should only sell CSPs on stocks that:',
        options: ['Have the highest IV possible', 'You would be happy to own at the strike price', 'Are in a strong downtrend', 'Are about to report earnings'],
        correct: 1
      },
      {
        q: 'A 0.30 delta put has approximately what probability of expiring worthless?',
        options: ['30%', '50%', '70%', '90%'],
        correct: 2
      },
      {
        q: 'When should you roll a CSP?',
        options: ['Immediately after opening', 'When the stock gaps up', 'When approaching the strike and you want to avoid assignment', 'Never roll, always take assignment'],
        correct: 2
      },
      {
        q: 'The golden rule of rolling is:',
        options: ['Always roll to the same strike', 'Only roll for a credit', 'Roll as soon as possible', 'Never roll puts'],
        correct: 1
      },
      {
        q: 'If you get assigned on a CSP, your next step in the wheel is:',
        options: ['Sell the shares immediately', 'Sell covered calls on the shares', 'Buy more puts', 'Stop trading'],
        correct: 1
      }
    ]
  },
  'cc-quiz': {
    title: 'Covered Calls Quiz',
    questions: [
      {
        q: 'What makes a call "covered"?',
        options: ['Having insurance on the position', 'Owning 100 shares of the underlying stock', 'Using margin', 'Buying another call to hedge'],
        correct: 1
      },
      {
        q: 'If your covered call is exercised (shares called away), you:',
        options: ['Lose your shares and all premium', 'Keep the premium and sell shares at the strike price', 'Must buy more shares', 'Get nothing'],
        correct: 1
      },
      {
        q: 'When is a good time to sell a covered call?',
        options: ['When the stock just crashed 50%', 'When IV is elevated and you\'d be happy selling at the strike', 'Right before earnings', 'When you need the shares for another trade'],
        correct: 1
      },
      {
        q: 'If you\'re "underwater" on shares (cost basis higher than current price), you should:',
        options: ['Never sell covered calls', 'Sell calls at strikes where premium + strike ≥ cost basis', 'Sell immediately at market price', 'Buy more shares to average down'],
        correct: 1
      },
      {
        q: 'Rolling a covered call means:',
        options: ['Letting it expire', 'Buying back the current call and selling a new one', 'Converting it to a put', 'Exercising the option'],
        correct: 1
      }
    ]
  },
  'beau-quiz': {
    title: 'Elite Strategy Final Assessment',
    questions: [
      {
        q: 'What is the target weekly return in Beau\'s strategy?',
        options: ['5-10%', '2-3%', '0.5-1%', '10-20%'],
        correct: 2
      },
      {
        q: 'What delta range does Beau use for both CSPs and CCs?',
        options: ['0.10-0.20', '0.20-0.30', '0.40-0.90', '0.95-1.00'],
        correct: 2
      },
      {
        q: 'What is the maximum number of concurrent positions recommended?',
        options: ['1', '3', '5', '10'],
        correct: 1
      },
      {
        q: 'What should you ALWAYS avoid holding options through?',
        options: ['Weekends', 'Earnings announcements', 'Lunch time', 'The last hour of trading'],
        correct: 1
      },
      {
        q: 'The cardinal rule of rolling is:',
        options: ['Always roll to the same strike', 'Never roll - take assignment', 'Only roll for a credit', 'Roll every position'],
        correct: 2
      },
      {
        q: 'What type of stocks should you target?',
        options: ['Stocks in downtrends for cheaper prices', 'Uptrending stocks with higher IV', 'Any stock with high IV', 'Only penny stocks'],
        correct: 1
      },
      {
        q: '"Cash Secured" means:',
        options: ['Using margin as backup', 'Having 50% of the cash needed', 'Having 100% cash to buy shares if assigned', 'Keeping cash in a safe'],
        correct: 2
      },
      {
        q: 'What DTE (days to expiration) does Beau prefer?',
        options: ['60-90 days', '30-45 days', 'Same week', '6 months'],
        correct: 2
      },
      {
        q: 'Why is "understanding the full wheel before starting" emphasized?',
        options: ['It\'s not important, just start trading', 'Half-knowledge leads to panic decisions', 'It\'s a legal requirement', 'To impress other traders'],
        correct: 1
      },
      {
        q: 'The core philosophy can be summarized as:',
        options: ['Get rich quick', 'Slow and consistent wins', 'Maximum risk for maximum reward', 'Trade as much as possible'],
        correct: 1
      }
    ]
  }
};

function showQuiz(moduleId, chapterId) {
  const quiz = QUIZZES[chapterId];
  if (!quiz) {
    $('learnContent').innerHTML = '<p>Quiz not found.</p>';
    return;
  }

  currentQuiz = { moduleId, chapterId, quiz };
  quizAnswers = {};

  let html = `
    <div class="quiz-container">
      <div style="text-align:center;margin-bottom:24px">
        <div style="font-size:48px;margin-bottom:12px">📝</div>
        <h3 style="margin:0 0 8px 0">${quiz.title}</h3>
        <p style="color:var(--text2);margin:0">${quiz.questions.length} questions · Must pass to continue</p>
      </div>

      <div id="quizQuestions">
  `;

  quiz.questions.forEach((question, qIdx) => {
    html += `
      <div class="quiz-question" data-q="${qIdx}">
        <div style="font-weight:600;margin-bottom:12px">${qIdx + 1}. ${question.q}</div>
        <div class="quiz-options">
    `;
    question.options.forEach((opt, oIdx) => {
      html += `<button class="quiz-option" data-q="${qIdx}" data-o="${oIdx}" onclick="selectQuizAnswer(${qIdx}, ${oIdx})">${opt}</button>`;
    });
    html += '</div></div>';
  });

  html += `
      </div>
      <button class="btn" style="width:100%;margin-top:20px" onclick="submitQuiz()">Submit Answers</button>
    </div>
  `;

  $('learnContent').innerHTML = html;
}

function selectQuizAnswer(qIdx, oIdx) {
  quizAnswers[qIdx] = oIdx;
  document.querySelectorAll(`.quiz-option[data-q="${qIdx}"]`).forEach(btn => {
    btn.classList.remove('selected');
  });
  document.querySelector(`.quiz-option[data-q="${qIdx}"][data-o="${oIdx}"]`).classList.add('selected');
}

function submitQuiz() {
  if (!currentQuiz) return;

  const quiz = currentQuiz.quiz;
  const total = quiz.questions.length;

  // Check all questions are answered
  const answered = Object.keys(quizAnswers).length;
  if (answered < total) {
    showToast(`Please answer all ${total} questions (${answered}/${total} answered)`, 'error');
    return;
  }

  let correct = 0;

  quiz.questions.forEach((q, idx) => {
    const userAnswer = quizAnswers[idx];
    const optionBtns = document.querySelectorAll(`.quiz-option[data-q="${idx}"]`);

    optionBtns.forEach((btn, oIdx) => {
      btn.disabled = true;
      if (oIdx === q.correct) {
        btn.classList.add('correct');
      } else if (oIdx === userAnswer && userAnswer !== q.correct) {
        btn.classList.add('incorrect');
      }
    });

    if (userAnswer === q.correct) correct++;
  });

  const pct = Math.round((correct / total) * 100);
  const passed = pct >= 80;

  const resultsHtml = `
    <div style="text-align:center;margin-top:24px;padding:20px;background:var(--${passed ? 'green' : 'red'}-bg);border-radius:12px">
      <div style="font-size:36px;margin-bottom:8px">${passed ? '🎉' : '📚'}</div>
      <div style="font-size:24px;font-weight:700;color:var(--${passed ? 'green' : 'red'})">${pct}%</div>
      <div style="color:var(--text2);margin-top:4px">${correct}/${total} correct</div>
      <div style="margin-top:12px;font-weight:600">${passed ? 'Congratulations! You passed!' : 'You need 80% to pass. Review the material and try again.'}</div>
    </div>
    <div style="display:flex;gap:12px;margin-top:16px">
      ${passed ? `<button class="btn" style="flex:1" onclick="completeLesson('${currentQuiz.chapterId}');showModuleList()">Complete Module</button>` : `<button class="btn btn-outline" style="flex:1" onclick="showChapterList('${currentQuiz.moduleId}')">Review Lessons</button><button class="btn" style="flex:1" onclick="showQuiz('${currentQuiz.moduleId}', '${currentQuiz.chapterId}')">Retry Quiz</button>`}
    </div>
  `;

  document.querySelector('.quiz-container').insertAdjacentHTML('beforeend', resultsHtml);
  document.querySelector('.quiz-container > .btn').remove();
}

// Lesson Content
function getLessonContent(chapterId) {
  const content = {
    // MODULE 1: OPTIONS FUNDAMENTALS
    'what-are-options': `
      <h2>What Are Options?</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/7PM4rNDr4oI" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@projectoption" target="_blank">projectoption</a></div>

      <p>Options are <strong>financial contracts</strong> that give you the right—but not the obligation—to buy or sell an underlying asset (like a stock) at a predetermined price within a specific time period.</p>

      <div class="callout blue">
        <strong>Key Insight:</strong> Unlike buying stocks where you own part of a company, options give you the <em>right</em> to transact at a certain price. This right has value, which is why options have a price (premium).
      </div>

      <h3>The Building Blocks</h3>

      <p>Every options contract has these essential components:</p>

      <ul>
        <li><strong>Underlying Asset</strong> - The stock or ETF the option is based on (e.g., AAPL, SPY)</li>
        <li><strong>Strike Price</strong> - The price at which you can buy/sell the underlying</li>
        <li><strong>Expiration Date</strong> - When the contract expires and becomes worthless</li>
        <li><strong>Premium</strong> - The price you pay (or receive) for the option contract</li>
        <li><strong>Contract Size</strong> - Standard options control 100 shares per contract</li>
      </ul>

      <div class="callout green">
        <strong>Example:</strong> If you buy 1 AAPL $150 Call expiring in 30 days for $3.00 premium, you're paying $300 (100 shares × $3) for the right to buy 100 shares of Apple at $150/share anytime before expiration.
      </div>

      <h3>Buyers vs Sellers</h3>

      <p>Options trading has two sides to every transaction:</p>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0">
        <div style="background:var(--blue-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--blue);margin-bottom:8px">Option Buyers</div>
          <ul style="margin:0;padding-left:20px;font-size:14px">
            <li>Pay premium upfront</li>
            <li>Have rights, no obligations</li>
            <li>Limited risk (premium paid)</li>
            <li>Need the stock to move</li>
          </ul>
        </div>
        <div style="background:var(--green-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--green);margin-bottom:8px">Option Sellers</div>
          <ul style="margin:0;padding-left:20px;font-size:14px">
            <li>Collect premium upfront</li>
            <li>Have obligations if assigned</li>
            <li>Profit from time decay</li>
            <li>Can profit if stock stays flat</li>
          </ul>
        </div>
      </div>

      <div class="callout orange">
        <strong>Why This Matters:</strong> In the Wheel Strategy, you are primarily an option SELLER. You collect premium and let time work in your favor. Understanding this distinction is crucial.
      </div>

      <h3>Why Trade Options?</h3>

      <p>Options offer several advantages over simply buying stocks:</p>

      <ol>
        <li><strong>Generate Income</strong> - Sell options to collect premium consistently</li>
        <li><strong>Leverage</strong> - Control more shares with less capital</li>
        <li><strong>Flexibility</strong> - Profit in up, down, or sideways markets</li>
        <li><strong>Defined Risk</strong> - Know your maximum loss upfront (when buying)</li>
        <li><strong>Lower Cost Basis</strong> - Use premium to reduce your entry price on stocks</li>
      </ol>
    `,

    'calls-vs-puts': `
      <h2>Calls vs Puts Explained</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/MiybniIIvx0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@SkyViewTrading" target="_blank">Sky View Trading</a></div>

      <p>There are only two types of options: <strong>CALLS</strong> and <strong>PUTS</strong>. Understanding the difference is fundamental to everything we do.</p>

      <h3>CALL Options</h3>

      <div style="background:var(--blue-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-size:24px;margin-bottom:8px">📈 CALL = Right to BUY</div>
        <p style="margin:0">A call option gives the holder the right to <strong>BUY</strong> 100 shares at the strike price before expiration.</p>
      </div>

      <p><strong>Buying a Call:</strong> You're bullish. You want the stock to go UP. If the stock rises above your strike price, you can buy shares at a discount or sell the option for profit.</p>

      <p><strong>Selling a Call:</strong> You're neutral to slightly bullish. You collect premium and hope the stock stays below the strike price so the option expires worthless and you keep the premium.</p>

      <div class="callout green">
        <strong>Covered Call Example:</strong> You own 100 shares of AAPL at $150. You sell a $160 Call for $2.00 premium. You collect $200. If AAPL stays below $160, you keep the premium AND your shares. If it goes above $160, your shares get "called away" (sold) at $160.
      </div>

      <h3>PUT Options</h3>

      <div style="background:var(--green-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-size:24px;margin-bottom:8px">📉 PUT = Right to SELL</div>
        <p style="margin:0">A put option gives the holder the right to <strong>SELL</strong> 100 shares at the strike price before expiration.</p>
      </div>

      <p><strong>Buying a Put:</strong> You're bearish or want protection. You want the stock to go DOWN. If it drops below your strike, you can sell shares at a higher price than market value.</p>

      <p><strong>Selling a Put:</strong> You're bullish. You want to buy the stock at a lower price. You collect premium and if the stock drops below your strike, you buy 100 shares at that price (minus the premium collected).</p>

      <div class="callout green">
        <strong>Cash Secured Put Example:</strong> AAPL is at $150. You sell a $145 Put for $2.50 premium. You collect $250. If AAPL stays above $145, you keep the premium. If it drops below $145, you buy 100 shares at $145 (but your effective cost is $142.50 after premium).
      </div>

      <h3>Quick Reference Chart</h3>

      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;font-size:14px;margin:16px 0">
          <tr style="background:var(--input)">
            <th style="padding:12px;text-align:left;border-bottom:1px solid var(--border)">Action</th>
            <th style="padding:12px;text-align:left;border-bottom:1px solid var(--border)">Outlook</th>
            <th style="padding:12px;text-align:left;border-bottom:1px solid var(--border)">Max Profit</th>
            <th style="padding:12px;text-align:left;border-bottom:1px solid var(--border)">Max Loss</th>
          </tr>
          <tr>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Buy Call</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Bullish</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Unlimited</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Premium paid</td>
          </tr>
          <tr>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Sell Call</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Neutral/Bearish</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Premium received</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Unlimited (if naked)</td>
          </tr>
          <tr>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Buy Put</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Bearish</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Strike - Premium</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Premium paid</td>
          </tr>
          <tr>
            <td style="padding:12px">Sell Put</td>
            <td style="padding:12px">Bullish</td>
            <td style="padding:12px">Premium received</td>
            <td style="padding:12px">Strike × 100 - Premium</td>
          </tr>
        </table>
      </div>

      <div class="callout orange">
        <strong>The Wheel Strategy Focus:</strong> We primarily SELL puts (cash secured) and SELL calls (covered). We're collecting premium and using time decay to our advantage. Buying options is speculation; selling options is income generation.
      </div>
    `,

    'key-terms': `
      <h2>Essential Options Terms</h2>

      <p>Before diving deeper, you need to master these key terms. Bookmark this lesson for reference!</p>

      <h3>The Core Terms</h3>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--blue);font-size:16px">Strike Price</div>
        <p style="margin:8px 0 0 0">The price at which the underlying stock can be bought (call) or sold (put). This is the "target" price of your contract.</p>
      </div>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--green);font-size:16px">Premium</div>
        <p style="margin:8px 0 0 0">The price of the options contract. Quoted per share, so multiply by 100 for total cost. A $2.50 premium = $250 per contract.</p>
      </div>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--purple);font-size:16px">Expiration Date (DTE)</div>
        <p style="margin:8px 0 0 0">The date when the option contract expires. DTE = Days To Expiration. After this date, the option is worthless.</p>
      </div>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--orange);font-size:16px">Assignment</div>
        <p style="margin:8px 0 0 0">When an option seller is required to fulfill their obligation. Put sellers buy shares; call sellers sell shares.</p>
      </div>

      <h3>Money-ness Terms</h3>

      <p>These terms describe where the stock price is relative to the strike:</p>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="background:var(--green-bg);padding:16px;border-radius:12px">
          <strong style="color:var(--green)">In The Money (ITM)</strong>
          <p style="margin:4px 0 0 0;font-size:14px">The option has intrinsic value. For calls: stock > strike. For puts: stock < strike. Higher chance of assignment.</p>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px">
          <strong>At The Money (ATM)</strong>
          <p style="margin:4px 0 0 0;font-size:14px">Stock price equals or is very close to the strike price. Maximum extrinsic value.</p>
        </div>
        <div style="background:var(--blue-bg);padding:16px;border-radius:12px">
          <strong style="color:var(--blue)">Out of The Money (OTM)</strong>
          <p style="margin:4px 0 0 0;font-size:14px">The option has no intrinsic value. For calls: stock < strike. For puts: stock > strike. Lower premium but higher probability of expiring worthless.</p>
        </div>
      </div>

      <div class="callout green">
        <strong>Wheel Strategy Note:</strong> We typically sell OTM options. This gives us a "cushion" - the stock can move against us somewhat and we still profit from time decay.
      </div>

      <h3>Value Terms</h3>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--blue)">Intrinsic Value</div>
        <p style="margin:8px 0 0 0">The real, tangible value if exercised right now. ITM amount. A $100 call when stock is $105 has $5 intrinsic value.</p>
      </div>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--purple)">Extrinsic Value (Time Value)</div>
        <p style="margin:8px 0 0 0">The "hope" value - premium above intrinsic value based on time remaining and volatility. This decays as expiration approaches.</p>
      </div>

      <h3>Action Terms</h3>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--green)">Open / Close</div>
        <p style="margin:8px 0 0 0">"Open" = entering a new position. "Close" = exiting an existing position. You can open by buying OR selling.</p>
      </div>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--orange)">Rolling</div>
        <p style="margin:8px 0 0 0">Closing your current option and opening a new one, usually at a different strike or expiration. Used to manage positions and collect more premium.</p>
      </div>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--blue)">Exercise</div>
        <p style="margin:8px 0 0 0">The option buyer uses their right to buy (call) or sell (put) shares at the strike price. Happens automatically at expiration if ITM.</p>
      </div>
    `,

    'options-pricing': `
      <h2>How Options Are Priced</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/kCJcEOYuuII" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@OptionAlpha" target="_blank">Option Alpha</a></div>

      <p>Understanding what drives option prices is crucial for consistent profitability. Option premiums aren't random—they're based on mathematical models influenced by several factors.</p>

      <h3>The Premium Formula</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;text-align:center;margin:16px 0">
        <div style="font-size:18px;font-weight:600">Option Premium = Intrinsic Value + Extrinsic Value</div>
      </div>

      <p><strong>Intrinsic Value:</strong> The amount the option is ITM. If stock is $105 and you have a $100 call, intrinsic value = $5. OTM options have $0 intrinsic value.</p>

      <p><strong>Extrinsic Value:</strong> Everything else—time value + volatility premium. This is what decays over time and what we profit from as sellers.</p>

      <h3>The 5 Factors That Affect Price</h3>

      <div style="margin:20px 0">
        <div style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--input);border-radius:12px;margin-bottom:10px">
          <div style="width:40px;height:40px;background:var(--blue-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">📊</div>
          <div style="flex:1">
            <div style="font-weight:600">Stock Price vs Strike</div>
            <div style="font-size:13px;color:var(--text2)">How far ITM or OTM the option is</div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--input);border-radius:12px;margin-bottom:10px">
          <div style="width:40px;height:40px;background:var(--purple-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">⏱️</div>
          <div style="flex:1">
            <div style="font-weight:600">Time to Expiration</div>
            <div style="font-size:13px;color:var(--text2)">More time = more premium (and more decay to capture)</div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--input);border-radius:12px;margin-bottom:10px">
          <div style="width:40px;height:40px;background:var(--orange-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">📈</div>
          <div style="flex:1">
            <div style="font-weight:600">Implied Volatility (IV)</div>
            <div style="font-size:13px;color:var(--text2)">Higher IV = higher premiums (good for sellers!)</div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--input);border-radius:12px;margin-bottom:10px">
          <div style="width:40px;height:40px;background:var(--green-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">💵</div>
          <div style="flex:1">
            <div style="font-weight:600">Interest Rates</div>
            <div style="font-size:13px;color:var(--text2)">Minor impact, affects cost of carry</div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--input);border-radius:12px">
          <div style="width:40px;height:40px;background:var(--red-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">💰</div>
          <div style="flex:1">
            <div style="font-weight:600">Dividends</div>
            <div style="font-size:13px;color:var(--text2)">Expected dividends reduce call prices, increase put prices</div>
          </div>
        </div>
      </div>

      <h3>Time Decay: The Seller's Edge</h3>

      <p>This is the most important concept for wheel traders. Options lose value every day simply due to the passage of time. This is called <strong>theta decay</strong>.</p>

      <div class="callout green">
        <strong>Key Insight:</strong> Time decay accelerates as expiration approaches. An option loses more value in its final week than in its first month. This is why we often sell weekly options—maximum decay, minimum time for things to go wrong.
      </div>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Time Decay Curve</div>
        <div style="display:flex;align-items:flex-end;height:100px;gap:4px">
          <div style="flex:1;background:var(--green);border-radius:4px 4px 0 0;height:95%"></div>
          <div style="flex:1;background:var(--green);border-radius:4px 4px 0 0;height:90%"></div>
          <div style="flex:1;background:var(--green);border-radius:4px 4px 0 0;height:82%"></div>
          <div style="flex:1;background:var(--green);border-radius:4px 4px 0 0;height:72%"></div>
          <div style="flex:1;background:var(--green);border-radius:4px 4px 0 0;height:60%"></div>
          <div style="flex:1;background:var(--orange);border-radius:4px 4px 0 0;height:45%"></div>
          <div style="flex:1;background:var(--orange);border-radius:4px 4px 0 0;height:28%"></div>
          <div style="flex:1;background:var(--red);border-radius:4px 4px 0 0;height:10%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:12px;color:var(--text2)">
          <span>45 DTE</span>
          <span>30 DTE</span>
          <span>14 DTE</span>
          <span>7 DTE</span>
          <span>Exp</span>
        </div>
      </div>

      <h3>Implied Volatility Explained</h3>

      <p>Implied Volatility (IV) is the market's expectation of how much a stock will move. High IV = expensive options. Low IV = cheap options.</p>

      <ul>
        <li><strong>High IV events:</strong> Earnings, FDA announcements, major news</li>
        <li><strong>We prefer:</strong> Elevated IV (good premiums) but not during binary events</li>
        <li><strong>IV Crush:</strong> After events, IV drops rapidly. Great for sellers who entered before.</li>
      </ul>

      <div class="callout orange">
        <strong>Beau's Approach:</strong> Look for stocks with higher IV that are in an uptrend. This gives you better premium while the trend provides a tailwind. Avoid selling options right before earnings—the IV crush isn't worth the binary risk.
      </div>
    `,

    // MODULE 2: UNDERSTANDING THE GREEKS
    'delta-explained': `
      <h2>Delta: Direction & Probability</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/gZqzEF-Rlnw" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@projectoption" target="_blank">projectoption</a></div>

      <p>Delta is arguably the most important Greek for wheel traders. It tells you two critical things: how much your option price will change when the stock moves, and your approximate probability of profit.</p>

      <h3>What Delta Measures</h3>

      <div style="background:var(--blue-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">Delta = Price Change per $1 Stock Move</div>
        <p style="margin:0">A delta of 0.30 means your option gains/loses $0.30 for every $1 the stock moves (or $30 per contract).</p>
      </div>

      <h3>Delta Values</h3>

      <ul>
        <li><strong>CALLS:</strong> Delta ranges from 0 to +1.00</li>
        <li><strong>PUTS:</strong> Delta ranges from 0 to -1.00</li>
        <li><strong>At The Money:</strong> Delta is approximately ±0.50</li>
        <li><strong>Deep ITM:</strong> Delta approaches ±1.00</li>
        <li><strong>Far OTM:</strong> Delta approaches 0</li>
      </ul>

      <h3>Delta as Probability</h3>

      <p>Here's the powerful part: <strong>Delta approximates the probability of expiring ITM</strong>.</p>

      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:20px 0">
        <div style="background:var(--green-bg);padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:28px;font-weight:700;color:var(--green)">0.20</div>
          <div style="font-size:13px;color:var(--text2)">~20% chance ITM</div>
          <div style="font-size:12px;margin-top:4px">80% win rate</div>
        </div>
        <div style="background:var(--orange-bg);padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:28px;font-weight:700;color:var(--orange)">0.30</div>
          <div style="font-size:13px;color:var(--text2)">~30% chance ITM</div>
          <div style="font-size:12px;margin-top:4px">70% win rate</div>
        </div>
        <div style="background:var(--blue-bg);padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:28px;font-weight:700;color:var(--blue)">0.50</div>
          <div style="font-size:13px;color:var(--text2)">~50% chance ITM</div>
          <div style="font-size:12px;margin-top:4px">50% win rate</div>
        </div>
      </div>

      <div class="callout green">
        <strong>For Put Sellers:</strong> If you sell a put with a delta of -0.25, there's approximately a 75% chance it expires worthless (you keep full premium) and only 25% chance you'll be assigned.
      </div>

      <h3>Delta for The Wheel</h3>

      <p>As wheel traders, we use delta to select our strike prices:</p>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)">
          <span>Conservative</span>
          <span style="font-weight:600">0.15 - 0.20 delta</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)">
          <span>Standard</span>
          <span style="font-weight:600">0.20 - 0.30 delta</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0">
          <span>Aggressive</span>
          <span style="font-weight:600">0.30 - 0.40 delta</span>
        </div>
      </div>

      <div class="callout orange">
        <strong>Beau's Delta Range:</strong> 0.40 - 0.90 delta. This is more aggressive than many traders recommend, but when you combine it with proper stock selection (uptrending stocks with higher IV) and short DTE (same week), the higher premium collected compensates for the increased risk.
      </div>

      <h3>Important Delta Concepts</h3>

      <ul>
        <li><strong>Delta Changes:</strong> As the stock moves, delta changes. This is measured by Gamma (next lesson's topic).</li>
        <li><strong>100 Shares = Delta 1.00:</strong> Owning 100 shares is like having +100 delta. This is why covered calls reduce your effective delta.</li>
        <li><strong>Delta Neutral:</strong> Advanced traders balance deltas to reduce directional exposure.</li>
      </ul>
    `,

    'theta-decay': `
      <h2>Theta: Time Decay</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/UJO0rskYaGE" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@InTheMoney" target="_blank">InTheMoney</a></div>

      <p>Theta is the option seller's best friend. It represents how much value an option loses each day simply due to time passing. As a wheel trader, <strong>theta works FOR you</strong>.</p>

      <h3>What Theta Measures</h3>

      <div style="background:var(--green-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">Theta = Daily Time Decay in Dollars</div>
        <p style="margin:0">A theta of -0.05 means the option loses $0.05 per day ($5 per contract). As a seller, you're collecting this decay!</p>
      </div>

      <h3>The Theta Decay Curve</h3>

      <p>Time decay is NOT linear—it accelerates as expiration approaches. This is crucial for strategy:</p>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px;text-align:center">Option Value Over Time</div>
        <div style="display:flex;align-items:flex-end;height:120px;gap:2px;padding:0 10px">
          <div style="flex:1;background:linear-gradient(to top, var(--green), var(--green-bg));border-radius:4px 4px 0 0;height:98%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--green), var(--green-bg));border-radius:4px 4px 0 0;height:96%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--green), var(--green-bg));border-radius:4px 4px 0 0;height:93%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--green), var(--green-bg));border-radius:4px 4px 0 0;height:89%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--green), var(--green-bg));border-radius:4px 4px 0 0;height:84%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--green), var(--green-bg));border-radius:4px 4px 0 0;height:78%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--orange), var(--orange-bg));border-radius:4px 4px 0 0;height:70%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--orange), var(--orange-bg));border-radius:4px 4px 0 0;height:60%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--orange), var(--orange-bg));border-radius:4px 4px 0 0;height:48%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--red), var(--red-bg));border-radius:4px 4px 0 0;height:32%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--red), var(--red-bg));border-radius:4px 4px 0 0;height:15%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--red), var(--red-bg));border-radius:4px 4px 0 0;height:3%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:11px;color:var(--text2)">
          <span>60 DTE</span>
          <span>45 DTE</span>
          <span>30 DTE</span>
          <span>14 DTE</span>
          <span>7 DTE</span>
          <span>Exp</span>
        </div>
      </div>

      <div class="callout blue">
        <strong>Key Insight:</strong> About 1/3 of an option's time value decays in the final week before expiration. This is why selling weekly options is so attractive—maximum decay in minimum time.
      </div>

      <h3>Theta by Strike Price</h3>

      <p>Not all options decay at the same rate:</p>

      <ul>
        <li><strong>ATM options</strong> have the highest theta (most time value to decay)</li>
        <li><strong>ITM options</strong> have less theta (more intrinsic value, less time value)</li>
        <li><strong>OTM options</strong> have moderate theta but decay to zero faster</li>
      </ul>

      <h3>Using Theta in The Wheel</h3>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Daily Theta Example</div>
        <p style="font-size:14px;margin:0">You sell a put with theta of -$8/day. If the stock stays flat for 5 days, the option loses $40 in value—that's $40 profit for you without the stock moving at all!</p>
      </div>

      <h3>Theta Strategies</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="background:var(--green-bg);padding:16px;border-radius:12px">
          <strong style="color:var(--green)">Sell Weeklies</strong>
          <p style="margin:4px 0 0 0;font-size:14px">Maximum theta decay per day. Less time for things to go wrong. This is Beau's preferred approach.</p>
        </div>
        <div style="background:var(--blue-bg);padding:16px;border-radius:12px">
          <strong style="color:var(--blue)">30-45 DTE Entry</strong>
          <p style="margin:4px 0 0 0;font-size:14px">Traditional approach. Enter at 30-45 DTE, exit at 21 DTE or 50% profit. Captures the sweet spot of decay.</p>
        </div>
        <div style="background:var(--orange-bg);padding:16px;border-radius:12px">
          <strong style="color:var(--orange)">Let It Expire</strong>
          <p style="margin:4px 0 0 0;font-size:14px">Hold until expiration to capture 100% of premium and avoid closing fees. Requires more monitoring near expiration.</p>
        </div>
      </div>

      <div class="callout green">
        <strong>Beau's Approach:</strong> Sell same-week options and let them expire worthless. This maximizes theta decay per day, minimizes time in the trade, and avoids paying closing commissions. The key is proper strike selection to avoid assignment.
      </div>
    `,

    'iv-vega': `
      <h2>Implied Volatility & Vega</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/MEVVXTHxS0k" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@projectoption" target="_blank">projectoption</a></div>

      <p>Implied Volatility (IV) and its Greek, Vega, are crucial for maximizing premium collection. Understanding IV is what separates profitable wheel traders from the rest.</p>

      <h3>What is Implied Volatility?</h3>

      <div style="background:var(--orange-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">IV = Market's Expected Future Movement</div>
        <p style="margin:0">IV represents how much the market expects a stock to move over the next year, expressed as a percentage. Higher IV = more expensive options.</p>
      </div>

      <h3>IV Ranges</h3>

      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:16px 0">
        <div style="background:var(--input);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--blue)">Low IV (10-25%)</div>
          <p style="font-size:13px;margin:8px 0 0 0">Blue chip stocks, utilities, stable companies. Lower premiums but more predictable.</p>
          <div style="font-size:12px;color:var(--text3);margin-top:4px">Examples: JNJ, PG, KO</div>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--green)">Moderate IV (25-45%)</div>
          <p style="font-size:13px;margin:8px 0 0 0">Growth stocks, tech companies. Good balance of premium and risk.</p>
          <div style="font-size:12px;color:var(--text3);margin-top:4px">Examples: AAPL, MSFT, GOOGL</div>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--orange)">High IV (45-80%)</div>
          <p style="font-size:13px;margin:8px 0 0 0">Volatile stocks, meme stocks, pre-earnings. Excellent premium but higher risk.</p>
          <div style="font-size:12px;color:var(--text3);margin-top:4px">Examples: TSLA, AMD, NVDA</div>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--red)">Extreme IV (80%+)</div>
          <p style="font-size:13px;margin:8px 0 0 0">Meme stocks, biotech, extreme events. Very high premium but dangerous.</p>
          <div style="font-size:12px;color:var(--text3);margin-top:4px">Examples: GME, AMC, SPCE</div>
        </div>
      </div>

      <h3>IV Rank & IV Percentile</h3>

      <p>Raw IV numbers don't tell the whole story. You need context:</p>

      <ul>
        <li><strong>IV Rank:</strong> Where current IV sits relative to its 52-week range. IV Rank of 50 means IV is halfway between its yearly low and high.</li>
        <li><strong>IV Percentile:</strong> What percentage of days in the past year had lower IV. 80th percentile means IV is higher than 80% of the past year.</li>
      </ul>

      <div class="callout green">
        <strong>Best Time to Sell:</strong> When IV Rank is above 50 (preferably above 70). Options are "expensive" relative to their normal levels, so you collect more premium for the same risk.
      </div>

      <h3>What is Vega?</h3>

      <div style="background:var(--purple-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">Vega = Price Change per 1% IV Move</div>
        <p style="margin:0">A vega of 0.10 means the option gains/loses $0.10 for every 1% change in IV ($10 per contract).</p>
      </div>

      <h3>IV Crush</h3>

      <p>One of the most important concepts for option sellers:</p>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <strong>IV Crush</strong> happens when IV drops rapidly, typically after an anticipated event (earnings, FDA decisions, etc.). Options lose value regardless of stock direction.
      </div>

      <p>As a seller, IV crush works in your favor IF you sold before the event. However, selling right before earnings is risky because the stock might move more than expected.</p>

      <h3>Using IV in The Wheel</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">✅</div>
          <div>
            <div style="font-weight:600">Sell when IV is elevated</div>
            <div style="font-size:13px;color:var(--text2)">Higher premium for the same strike/expiration</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">✅</div>
          <div>
            <div style="font-weight:600">Look for uptrending stocks with higher IV</div>
            <div style="font-size:13px;color:var(--text2)">Trend gives you a tailwind while IV boosts premium</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">⚠️</div>
          <div>
            <div style="font-weight:600">Avoid selling right before earnings</div>
            <div style="font-size:13px;color:var(--text2)">Binary event risk outweighs IV crush benefit</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">⚠️</div>
          <div>
            <div style="font-weight:600">Be cautious with extreme IV</div>
            <div style="font-size:13px;color:var(--text2)">IV is high for a reason—big moves expected</div>
          </div>
        </div>
      </div>

      <div class="callout orange">
        <strong>Beau's Approach:</strong> Target stocks with elevated IV (above average for that stock) that are in a clear uptrend. The combination of higher IV (better premium) and bullish trend (lower assignment risk) is the sweet spot for consistent weekly income.
      </div>
    `,

    // MODULE 3: THE WHEEL STRATEGY OVERVIEW
    'wheel-intro': `
      <h2>What Is The Wheel Strategy?</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/dRYBh6dtxjY" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@KamikazeCash" target="_blank">Kamikaze Cash</a></div>

      <p>The Wheel Strategy is a systematic approach to generating consistent income from options while building positions in stocks you want to own. It's called "The Wheel" because it cycles between two phases repeatedly.</p>

      <div style="background:var(--green-bg);padding:24px;border-radius:16px;margin:20px 0;text-align:center">
        <div style="font-size:48px;margin-bottom:12px">🎡</div>
        <div style="font-size:20px;font-weight:700;margin-bottom:8px">The Wheel = CSP → Shares → CC → Repeat</div>
        <p style="margin:0;color:var(--text2)">A continuous cycle of selling puts, owning shares, and selling calls</p>
      </div>

      <h3>The Two Phases</h3>

      <div style="display:grid;gap:16px;margin:20px 0">
        <div style="background:var(--input);padding:20px;border-radius:12px;border-left:4px solid var(--green)">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
            <div style="width:40px;height:40px;background:var(--green-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">1️⃣</div>
            <div style="font-size:18px;font-weight:600">Cash Secured Put Phase</div>
          </div>
          <p style="margin:0;font-size:14px">Sell put options on stocks you want to own at prices you're happy to pay. Collect premium while waiting. If assigned, you buy shares at your chosen price minus the premium collected.</p>
        </div>

        <div style="text-align:center;font-size:24px">⬇️</div>

        <div style="background:var(--input);padding:20px;border-radius:12px;border-left:4px solid var(--blue)">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
            <div style="width:40px;height:40px;background:var(--blue-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">2️⃣</div>
            <div style="font-size:18px;font-weight:600">Covered Call Phase</div>
          </div>
          <p style="margin:0;font-size:14px">Once you own shares (from assignment), sell call options against them. Collect more premium while waiting. If called away, you sell your shares at your target price plus keep the premium.</p>
        </div>
      </div>

      <h3>Why It's Called "The Wheel"</h3>

      <p>The strategy naturally cycles:</p>

      <ol>
        <li><strong>Sell CSP</strong> → Collect premium, wait</li>
        <li><strong>Get Assigned</strong> → Now own 100 shares</li>
        <li><strong>Sell CC</strong> → Collect more premium</li>
        <li><strong>Get Called Away</strong> → Back to cash</li>
        <li><strong>Repeat from Step 1</strong></li>
      </ol>

      <div class="callout blue">
        <strong>Key Insight:</strong> You're collecting premium at EVERY stage. Whether you're waiting to buy (CSP) or waiting to sell (CC), time decay is working for you and money is flowing into your account.
      </div>

      <h3>Who Is The Wheel For?</h3>

      <ul>
        <li>Traders seeking <strong>consistent income</strong> over speculation</li>
        <li>Investors who want to <strong>lower cost basis</strong> on stocks they like</li>
        <li>Those with enough capital to buy 100 shares (for CSPs)</li>
        <li>Patient traders who understand options basics</li>
        <li>Anyone tired of trying to time the market perfectly</li>
      </ul>

      <div class="callout orange">
        <strong>Critical Requirement:</strong> You MUST have the cash to buy 100 shares if assigned. This is why it's called "Cash SECURED" puts. Never sell puts without the capital to back them up.
      </div>
    `,

    'wheel-cycle': `
      <h2>The Full Wheel Cycle</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/siFsIleNTzk" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@InTheMoney" target="_blank">InTheMoney</a></div>

      <p>Let's walk through a complete wheel cycle with a real example to see exactly how this strategy generates income at every step.</p>

      <h3>Example Setup</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;text-align:center">
          <div>
            <div style="font-size:24px;font-weight:700">AAPL</div>
            <div style="color:var(--text2)">Stock</div>
          </div>
          <div>
            <div style="font-size:24px;font-weight:700">$150</div>
            <div style="color:var(--text2)">Current Price</div>
          </div>
          <div>
            <div style="font-size:24px;font-weight:700">$15,000</div>
            <div style="color:var(--text2)">Cash Available</div>
          </div>
          <div>
            <div style="font-size:24px;font-weight:700">Target: 1%</div>
            <div style="color:var(--text2)">Weekly Return</div>
          </div>
        </div>
      </div>

      <h3>Step 1: Sell Cash Secured Put</h3>

      <div style="background:var(--green-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Action: Sell 1 AAPL $145 Put, 7 DTE</div>
        <div style="display:grid;gap:8px;font-size:14px">
          <div>Premium Collected: <strong style="color:var(--green)">$1.50 ($150 total)</strong></div>
          <div>Cash Reserved: <strong>$14,500</strong> (strike × 100)</div>
          <div>Max Profit: <strong>$150</strong> if AAPL stays above $145</div>
          <div>Break-even: <strong>$143.50</strong> ($145 - $1.50 premium)</div>
        </div>
      </div>

      <p><strong>Scenario A:</strong> AAPL stays above $145 at expiration → Put expires worthless → You keep $150 → Return to Step 1</p>

      <p><strong>Scenario B:</strong> AAPL drops to $142 → You get assigned → Move to Step 2</p>

      <h3>Step 2: Assignment (You Now Own Shares)</h3>

      <div style="background:var(--blue-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">You Now Own 100 Shares of AAPL</div>
        <div style="display:grid;gap:8px;font-size:14px">
          <div>Strike Price Paid: <strong>$145.00</strong></div>
          <div>Less Premium Collected: <strong>-$1.50</strong></div>
          <div>Effective Cost Basis: <strong style="color:var(--green)">$143.50/share</strong></div>
          <div>Current Price: <strong>$142.00</strong></div>
          <div>Paper Loss: <strong style="color:var(--red)">-$150</strong> (but better than buying at $150!)</div>
        </div>
      </div>

      <h3>Step 3: Sell Covered Call</h3>

      <div style="background:var(--green-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Action: Sell 1 AAPL $147 Call, 7 DTE</div>
        <div style="display:grid;gap:8px;font-size:14px">
          <div>Premium Collected: <strong style="color:var(--green)">$1.00 ($100 total)</strong></div>
          <div>If Called Away: Sell at $147 + keep $100 premium</div>
          <div>New Break-even: <strong>$142.50</strong> ($143.50 - $1.00)</div>
        </div>
      </div>

      <p><strong>Scenario A:</strong> AAPL stays below $147 → Call expires worthless → You keep $100 + shares → Sell another call</p>

      <p><strong>Scenario B:</strong> AAPL rises to $150 → Shares called away at $147 → Move to Step 4</p>

      <h3>Step 4: Called Away (Back to Cash)</h3>

      <div style="background:var(--orange-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Cycle Complete - Final Accounting</div>
        <div style="display:grid;gap:8px;font-size:14px">
          <div>Shares Sold At: <strong>$147.00</strong></div>
          <div>Original Cost Basis: <strong>$145.00</strong></div>
          <div>Capital Gain: <strong style="color:var(--green)">+$200</strong></div>
          <div>CSP Premium: <strong style="color:var(--green)">+$150</strong></div>
          <div>CC Premium: <strong style="color:var(--green)">+$100</strong></div>
          <div style="border-top:1px solid var(--border);padding-top:8px;margin-top:8px">
            <strong>Total Profit: <span style="color:var(--green)">$450</span></strong> (3% on $15,000)
          </div>
        </div>
      </div>

      <div class="callout green">
        <strong>The Power of The Wheel:</strong> Even though AAPL dropped initially and you got assigned, you still made $450 profit by collecting premium at every stage. The wheel turns losses into opportunities.
      </div>

      <h3>The Continuous Cycle</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0;text-align:center">
        <div style="display:flex;justify-content:center;align-items:center;gap:20px;flex-wrap:wrap">
          <div style="background:var(--green-bg);padding:12px 20px;border-radius:20px;font-weight:600">Sell CSP</div>
          <div>→</div>
          <div style="background:var(--blue-bg);padding:12px 20px;border-radius:20px;font-weight:600">Own Shares</div>
          <div>→</div>
          <div style="background:var(--orange-bg);padding:12px 20px;border-radius:20px;font-weight:600">Sell CC</div>
          <div>→</div>
          <div style="background:var(--purple-bg);padding:12px 20px;border-radius:20px;font-weight:600">Called Away</div>
          <div>→</div>
          <div style="font-size:20px">🔄</div>
        </div>
      </div>
    `,

    'wheel-benefits': `
      <h2>Why The Wheel Works</h2>

      <p>The Wheel Strategy has become one of the most popular income strategies for good reason. Here's why it consistently works for patient, disciplined traders.</p>

      <h3>1. Multiple Win Conditions</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <p style="margin:0 0 12px 0;font-weight:600">When Selling CSPs, You Win If:</p>
        <ul style="margin:0;font-size:14px">
          <li>Stock goes up → Put expires worthless ✅</li>
          <li>Stock stays flat → Put expires worthless ✅</li>
          <li>Stock goes down a little → Put expires worthless ✅</li>
          <li>Stock goes down a lot → You buy stock you wanted at a discount ✅</li>
        </ul>
      </div>

      <div class="callout green">
        <strong>Key Advantage:</strong> You don't need to predict direction. As long as you're selling puts on stocks you want to own, every outcome is acceptable.
      </div>

      <h3>2. Time Is On Your Side</h3>

      <p>Unlike buying options where time works against you, as a seller:</p>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0">
        <div style="background:var(--red-bg);padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:28px;margin-bottom:8px">📉</div>
          <div style="font-weight:600;color:var(--red)">Option Buyers</div>
          <div style="font-size:13px;margin-top:8px">Lose value every day</div>
          <div style="font-size:13px">Fighting the clock</div>
        </div>
        <div style="background:var(--green-bg);padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:28px;margin-bottom:8px">📈</div>
          <div style="font-weight:600;color:var(--green)">Option Sellers (You)</div>
          <div style="font-size:13px;margin-top:8px">Gain value every day</div>
          <div style="font-size:13px">Time is your friend</div>
        </div>
      </div>

      <h3>3. Lower Cost Basis</h3>

      <p>Every premium you collect reduces your effective cost:</p>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-size:14px;margin-bottom:8px">Example: AAPL at $150</div>
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
          <span>Buying outright:</span>
          <span style="font-weight:600">$150.00 cost basis</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
          <span>After 1 CSP expires ($1.50):</span>
          <span style="font-weight:600;color:var(--green)">$148.50 effective</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
          <span>After 2 CSPs expire:</span>
          <span style="font-weight:600;color:var(--green)">$147.00 effective</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:8px 0">
          <span>After 1 month of CSPs:</span>
          <span style="font-weight:600;color:var(--green)">$144.00 effective</span>
        </div>
      </div>

      <h3>4. Defined Risk</h3>

      <p>Your maximum risk is always known:</p>

      <ul>
        <li><strong>CSP Max Risk:</strong> Strike price × 100 (minus premium) - same as buying the stock</li>
        <li><strong>CC Max Risk:</strong> Stock going to $0 - but you'd have this risk anyway owning shares</li>
        <li><strong>No Unlimited Risk:</strong> Unlike naked calls, covered positions have defined max loss</li>
      </ul>

      <h3>5. Works In Any Market</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;background:var(--green-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">📈</div>
          <div>
            <div style="font-weight:600">Bull Market</div>
            <div style="font-size:13px;color:var(--text2)">CSPs expire worthless repeatedly. Collect premium without buying shares.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--blue-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">➡️</div>
          <div>
            <div style="font-weight:600">Sideways Market</div>
            <div style="font-size:13px;color:var(--text2)">Perfect for the wheel. Collect premium on both CSPs and CCs.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--orange-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">📉</div>
          <div>
            <div style="font-weight:600">Bear Market</div>
            <div style="font-size:13px;color:var(--text2)">Get assigned at lower prices. Premium cushions the drop. CCs help recover.</div>
          </div>
        </div>
      </div>

      <h3>6. Psychological Benefits</h3>

      <ul>
        <li><strong>Less Stressful:</strong> No need to time entries perfectly</li>
        <li><strong>Clear Rules:</strong> Systematic approach removes emotion</li>
        <li><strong>Regular Income:</strong> Weekly/monthly premium feels like a paycheck</li>
        <li><strong>No FOMO:</strong> You're getting paid to wait</li>
      </ul>

      <div class="callout orange">
        <strong>The Catch:</strong> The wheel requires patience and discipline. It's not a get-rich-quick scheme. It's a slow, consistent approach to building wealth. Target 0.5-1% per week, and let compounding do the heavy lifting over time.
      </div>
    `,

    // MODULE 4: CASH SECURED PUTS DEEP DIVE
    'csp-basics': `
      <h2>CSP Fundamentals</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/r_rKof8IdfU" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@InTheMoney" target="_blank">InTheMoney</a></div>

      <p>The Cash Secured Put (CSP) is the entry point of the Wheel Strategy. It's one of the most powerful income-generating strategies available, and mastering it is essential for consistent profits.</p>

      <h3>What Is a Cash Secured Put?</h3>

      <div style="background:var(--green-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">CSP = Selling a put with cash reserved to buy shares if assigned</div>
        <p style="margin:0">You collect premium upfront and agree to buy 100 shares at the strike price if the stock drops below that level.</p>
      </div>

      <h3>The Mechanics</h3>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="display:grid;gap:12px">
          <div style="display:flex;justify-content:space-between;padding-bottom:12px;border-bottom:1px solid var(--border)">
            <span>You Sell:</span>
            <span style="font-weight:600">1 Put Option</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding-bottom:12px;border-bottom:1px solid var(--border)">
            <span>You Receive:</span>
            <span style="font-weight:600;color:var(--green)">Premium (immediately)</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding-bottom:12px;border-bottom:1px solid var(--border)">
            <span>Your Obligation:</span>
            <span style="font-weight:600">Buy 100 shares at strike if assigned</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span>Cash Required:</span>
            <span style="font-weight:600">Strike × 100</span>
          </div>
        </div>
      </div>

      <h3>Example Trade</h3>

      <div style="background:var(--blue-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Sell to Open: 1 NVDA $420 Put, 7 DTE @ $5.00</div>
        <ul style="margin:0;font-size:14px">
          <li>Premium Collected: <strong style="color:var(--green)">$500</strong></li>
          <li>Cash Required: <strong>$42,000</strong></li>
          <li>Return on Capital: <strong>1.19%</strong> for 7 days</li>
          <li>Annualized Return: <strong>62%</strong> (if repeated)</li>
        </ul>
      </div>

      <h3>Possible Outcomes</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="background:var(--green-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--green)">Stock Stays Above Strike</div>
          <p style="margin:8px 0 0 0;font-size:14px">Put expires worthless. You keep the $500 premium. No shares purchased. Repeat the process.</p>
        </div>
        <div style="background:var(--orange-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--orange)">Stock Falls Below Strike</div>
          <p style="margin:8px 0 0 0;font-size:14px">You buy 100 shares at $420. Your effective cost: $415/share (strike minus premium). Move to covered calls.</p>
        </div>
      </div>

      <div class="callout blue">
        <strong>Key Insight:</strong> You should ONLY sell CSPs on stocks you genuinely want to own. Think of it as getting paid to place a limit order. If assigned, you're happy to own the shares.
      </div>

      <h3>Margin vs Cash Secured</h3>

      <ul>
        <li><strong>Cash Secured:</strong> Full cash reserved. Safest approach. Required for the wheel.</li>
        <li><strong>Margin Secured:</strong> Only partial cash required. Increases risk significantly. Not recommended for beginners.</li>
      </ul>

      <div class="callout orange">
        <strong>Golden Rule:</strong> Never sell a put without having 100% of the cash to buy shares. Margin can amplify losses and lead to forced liquidations. Always be cash secured.
      </div>
    `,

    'csp-stock-selection': `
      <h2>Selecting The Right Stock</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/s-zTaECoG0c" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@InTheMoney" target="_blank">InTheMoney</a></div>

      <p>Stock selection is arguably the most important factor in wheel success. Choosing the wrong stock can turn a winning strategy into a losing one. Here's how to pick the right underlyings.</p>

      <h3>The Golden Rule</h3>

      <div style="background:var(--green-bg);padding:24px;border-radius:12px;margin:16px 0;text-align:center">
        <div style="font-size:24px;font-weight:700;margin-bottom:8px">Only Sell Puts on Stocks You Want to Own</div>
        <p style="margin:0;color:var(--text2)">If you wouldn't buy the stock outright, don't sell puts on it.</p>
      </div>

      <h3>Ideal Stock Characteristics</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:start;background:var(--input);padding:16px;border-radius:12px">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center">1</div>
          <div>
            <div style="font-weight:600">Strong Fundamentals</div>
            <div style="font-size:13px;color:var(--text2);margin-top:4px">Profitable companies, good balance sheets, competitive advantages. Think: Would this company still exist in 10 years?</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:start;background:var(--input);padding:16px;border-radius:12px">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center">2</div>
          <div>
            <div style="font-weight:600">Uptrend or Stable</div>
            <div style="font-size:13px;color:var(--text2);margin-top:4px">Stock in an uptrend reduces assignment risk. Avoid stocks in clear downtrends or freefall.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:start;background:var(--input);padding:16px;border-radius:12px">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center">3</div>
          <div>
            <div style="font-weight:600">Good Liquidity</div>
            <div style="font-size:13px;color:var(--text2);margin-top:4px">Tight bid-ask spreads, high volume. Allows easy entry/exit. Look for spreads under $0.10.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:start;background:var(--input);padding:16px;border-radius:12px">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center">4</div>
          <div>
            <div style="font-weight:600">Reasonable IV</div>
            <div style="font-size:13px;color:var(--text2);margin-top:4px">Higher IV means better premiums, but not so high that the stock is unpredictable. Sweet spot: 25-60% IV.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:start;background:var(--input);padding:16px;border-radius:12px">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center">5</div>
          <div>
            <div style="font-weight:600">Affordable</div>
            <div style="font-size:13px;color:var(--text2);margin-top:4px">Price you can afford 100 shares of. A $50 stock requires $5,000 cash secured. A $500 stock requires $50,000.</div>
          </div>
        </div>
      </div>

      <h3>Stocks to AVOID</h3>

      <div style="display:grid;gap:8px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--red-bg);border-radius:10px">
          <span style="font-size:18px">❌</span>
          <span><strong>Meme stocks</strong> - GME, AMC, etc. Unpredictable moves destroy accounts.</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--red-bg);border-radius:10px">
          <span style="font-size:18px">❌</span>
          <span><strong>Biotech/FDA plays</strong> - Binary events can gap 50%+ overnight.</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--red-bg);border-radius:10px">
          <span style="font-size:18px">❌</span>
          <span><strong>Stocks in freefall</strong> - "Catching a falling knife" rarely works.</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--red-bg);border-radius:10px">
          <span style="font-size:18px">❌</span>
          <span><strong>Low-volume stocks</strong> - Wide spreads eat your profits.</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--red-bg);border-radius:10px">
          <span style="font-size:18px">❌</span>
          <span><strong>Stocks with earnings this week</strong> - Wait until after.</span>
        </div>
      </div>

      <h3>Great Wheel Candidates</h3>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-size:14px;color:var(--text2);margin-bottom:12px">Examples (do your own research):</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px">
          <span style="background:var(--card);padding:8px 12px;border-radius:8px;font-weight:600">AAPL</span>
          <span style="background:var(--card);padding:8px 12px;border-radius:8px;font-weight:600">MSFT</span>
          <span style="background:var(--card);padding:8px 12px;border-radius:8px;font-weight:600">AMD</span>
          <span style="background:var(--card);padding:8px 12px;border-radius:8px;font-weight:600">NVDA</span>
          <span style="background:var(--card);padding:8px 12px;border-radius:8px;font-weight:600">GOOGL</span>
          <span style="background:var(--card);padding:8px 12px;border-radius:8px;font-weight:600">AMZN</span>
          <span style="background:var(--card);padding:8px 12px;border-radius:8px;font-weight:600">SPY</span>
          <span style="background:var(--card);padding:8px 12px;border-radius:8px;font-weight:600">QQQ</span>
        </div>
      </div>

      <div class="callout orange">
        <strong>Beau's Approach:</strong> Focus on higher IV stocks that are in a clear uptrend. The uptrend gives you a tailwind (less likely to get assigned), while higher IV gives you better premium. Check the daily and weekly charts before entering any position.
      </div>
    `,

    'csp-strike-exp': `
      <h2>Strike & Expiration Selection</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/sd9GAViEEBY" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@InTheMoney" target="_blank">InTheMoney</a></div>

      <p>Choosing the right strike price and expiration date is where art meets science. These decisions directly impact your risk, reward, and probability of success.</p>

      <h3>Strike Selection</h3>

      <p>Your strike choice determines your risk-reward tradeoff:</p>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="background:var(--green-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--green)">Far OTM (0.10-0.20 delta)</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;font-size:13px">
            <div>✅ High probability (80-90%)</div>
            <div>❌ Lower premium</div>
            <div>✅ Large cushion from current price</div>
            <div>❌ Less weekly income</div>
          </div>
        </div>
        <div style="background:var(--blue-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--blue)">Standard OTM (0.20-0.30 delta)</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;font-size:13px">
            <div>✅ Good probability (70-80%)</div>
            <div>✅ Solid premium</div>
            <div>✅ Balanced approach</div>
            <div>⚠️ Moderate cushion</div>
          </div>
        </div>
        <div style="background:var(--orange-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--orange)">Aggressive OTM (0.30-0.50 delta)</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;font-size:13px">
            <div>⚠️ Moderate probability (50-70%)</div>
            <div>✅ Higher premium</div>
            <div>⚠️ Smaller cushion</div>
            <div>✅ More income if successful</div>
          </div>
        </div>
      </div>

      <div class="callout orange">
        <strong>Beau's Delta Range:</strong> 0.40-0.90. This is aggressive, but when combined with proper stock selection (uptrending stocks with higher IV) and short DTE, the higher premium compensates. The key is having conviction in the stocks you select.
      </div>

      <h3>Expiration Selection</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="background:var(--input);padding:16px;border-radius:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Weekly (0-7 DTE)</strong>
            <span style="background:var(--green-bg);color:var(--green);padding:4px 10px;border-radius:12px;font-size:12px">BEAU'S PICK</span>
          </div>
          <ul style="margin:8px 0 0 0;font-size:14px;padding-left:20px">
            <li>Maximum theta decay per day</li>
            <li>Less time for things to go wrong</li>
            <li>Can let expire to avoid fees</li>
            <li>Requires more active management</li>
          </ul>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px">
          <strong>2-3 Weeks (7-21 DTE)</strong>
          <ul style="margin:8px 0 0 0;font-size:14px;padding-left:20px">
            <li>Good balance of premium and decay</li>
            <li>Still captures accelerating theta</li>
            <li>More cushion than weeklies</li>
          </ul>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px">
          <strong>Monthly (30-45 DTE)</strong>
          <ul style="margin:8px 0 0 0;font-size:14px;padding-left:20px">
            <li>Traditional approach</li>
            <li>More time value to capture</li>
            <li>Often closed at 50% profit</li>
            <li>Less management required</li>
          </ul>
        </div>
      </div>

      <h3>The Premium Rule</h3>

      <p>A simple rule for strike selection based on desired return:</p>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="text-align:center;margin-bottom:16px">
          <div style="font-size:18px;font-weight:600">Target Weekly Return = Premium ÷ Cash Required</div>
        </div>
        <div style="font-size:14px">
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
            <span>Want 0.5% weekly?</span>
            <span>$50 per $10,000 cash</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
            <span>Want 1.0% weekly?</span>
            <span>$100 per $10,000 cash</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0">
            <span>Want 1.5% weekly?</span>
            <span>$150 per $10,000 cash</span>
          </div>
        </div>
      </div>

      <h3>Putting It Together</h3>

      <div style="background:var(--green-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Example: AAPL at $175</div>
        <div style="font-size:14px">
          <p>Target: 1% weekly return on ~$17,000 = $170 premium</p>
          <p style="margin:12px 0">Check the options chain for strikes that offer ~$1.70 premium with 7 DTE</p>
          <p style="margin:0"><strong>Result:</strong> $170 strike put at $1.75 = $175 premium (1.03% return, 0.45 delta)</p>
        </div>
      </div>

      <div class="callout blue">
        <strong>Pro Tip:</strong> Look at the delta AND the premium. Sometimes stepping down one strike gives you much better risk/reward. Always check multiple strikes before placing your trade.
      </div>
    `,

    'csp-management': `
      <h2>Managing Your CSP</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/fW5hY5Ivkeg" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@tastylive" target="_blank">tastylive</a></div>

      <p>Opening the position is just the beginning. Proper management determines whether you consistently profit or suffer unnecessary losses. Here's how to manage your CSPs like a pro.</p>

      <h3>After Opening: Monitor These</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">📊</div>
          <div>
            <div style="font-weight:600">Stock Price vs Strike</div>
            <div style="font-size:13px;color:var(--text2)">Are you still safely OTM? How much cushion remains?</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">💰</div>
          <div>
            <div style="font-weight:600">Current Premium Value</div>
            <div style="font-size:13px;color:var(--text2)">Has time decay worked in your favor? At 50%+ profit, consider closing.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">📅</div>
          <div>
            <div style="font-weight:600">Days to Expiration</div>
            <div style="font-size:13px;color:var(--text2)">Risk increases in final days if near the strike.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">📰</div>
          <div>
            <div style="font-weight:600">News & Events</div>
            <div style="font-size:13px;color:var(--text2)">Any upcoming earnings, announcements, or catalysts?</div>
          </div>
        </div>
      </div>

      <h3>Exit Strategies</h3>

      <div style="background:var(--green-bg);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;color:var(--green);margin-bottom:8px">Option 1: Let It Expire (Beau's Approach)</div>
        <p style="margin:0;font-size:14px">If stock stays above strike, the option expires worthless and you keep 100% of premium. No closing fees. Requires holding through expiration.</p>
      </div>

      <div style="background:var(--blue-bg);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;color:var(--blue);margin-bottom:8px">Option 2: Close at 50% Profit</div>
        <p style="margin:0;font-size:14px">Buy back the put when it's lost half its value. Locks in profit early, frees capital for new trades. Small fee but reduces risk.</p>
      </div>

      <div style="background:var(--orange-bg);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;color:var(--orange);margin-bottom:8px">Option 3: Roll the Position</div>
        <p style="margin:0;font-size:14px">If threatened, "roll" to a later expiration and/or lower strike. Collect additional premium. Discussed in detail below.</p>
      </div>

      <h3>When to Roll</h3>

      <p>Rolling = closing current position and opening a new one. Do this when:</p>

      <ul>
        <li>Stock is approaching your strike near expiration</li>
        <li>You want to avoid assignment but stay in the trade</li>
        <li>You can roll for a NET CREDIT (collect more premium)</li>
      </ul>

      <div class="callout green">
        <strong>Golden Rule of Rolling:</strong> Only roll for a credit. If you can't collect additional premium by rolling, either take the assignment or close the trade. Never pay to roll.
      </div>

      <h3>Roll Types</h3>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="margin-bottom:16px">
          <strong>Roll Out (Same Strike, Later Date)</strong>
          <p style="font-size:14px;margin:4px 0 0 0">Gives you more time. Good when you're still bullish on the stock.</p>
        </div>
        <div style="margin-bottom:16px">
          <strong>Roll Down (Lower Strike, Same Date)</strong>
          <p style="font-size:14px;margin:4px 0 0 0">Gives you more cushion. Harder to get a credit.</p>
        </div>
        <div>
          <strong>Roll Down and Out (Lower Strike + Later Date)</strong>
          <p style="font-size:14px;margin:4px 0 0 0">Best of both. More cushion AND more time. Easiest to get credit.</p>
        </div>
      </div>

      <h3>Assignment: Not the End of the World</h3>

      <p>If assigned, remember:</p>

      <ul>
        <li>You chose a stock you wanted to own</li>
        <li>Your cost basis is strike - premium (better than market price at the time)</li>
        <li>You now move to Phase 2: Covered Calls</li>
        <li>You'll continue collecting premium on the shares</li>
      </ul>

      <div class="callout orange">
        <strong>Beau's Management:</strong> Sell same-week options. If getting too close to strike, roll to avoid overnight assignment risk. If it looks like it will close below strike on expiration day, roll out. Always roll for a credit. If the stock tanks badly, sometimes it's better to take assignment and sell covered calls to recover.
      </div>
    `,

    // MODULE 5: COVERED CALLS DEEP DIVE
    'cc-basics': `
      <h2>Covered Call Fundamentals</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/jnTsQBJHMSk" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@InTheMoney" target="_blank">InTheMoney</a></div>

      <p>The Covered Call is Phase 2 of the Wheel Strategy. Once you own shares (either from a CSP assignment or outright purchase), you can generate income by selling calls against them.</p>

      <h3>What Is a Covered Call?</h3>

      <div style="background:var(--blue-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">Covered Call = Selling a call while owning 100 shares</div>
        <p style="margin:0">You collect premium upfront and agree to sell your shares at the strike price if the stock rises above that level.</p>
      </div>

      <h3>The Mechanics</h3>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="display:grid;gap:12px">
          <div style="display:flex;justify-content:space-between;padding-bottom:12px;border-bottom:1px solid var(--border)">
            <span>You Own:</span>
            <span style="font-weight:600">100 Shares of Stock</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding-bottom:12px;border-bottom:1px solid var(--border)">
            <span>You Sell:</span>
            <span style="font-weight:600">1 Call Option</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding-bottom:12px;border-bottom:1px solid var(--border)">
            <span>You Receive:</span>
            <span style="font-weight:600;color:var(--green)">Premium (immediately)</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span>Your Obligation:</span>
            <span style="font-weight:600">Sell 100 shares at strike if called</span>
          </div>
        </div>
      </div>

      <h3>Why "Covered"?</h3>

      <p>The call is "covered" because you own the underlying shares. If the option is exercised, you simply deliver your shares. This is different from a "naked" call where you don't own shares and would have unlimited risk.</p>

      <h3>Example Trade</h3>

      <div style="background:var(--green-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Position: Own 100 AAPL at $170 cost basis</div>
        <div style="margin-bottom:12px">Current Price: $175</div>
        <div style="font-weight:600;margin-bottom:8px">Sell to Open: 1 AAPL $180 Call, 7 DTE @ $1.50</div>
        <ul style="margin:0;font-size:14px">
          <li>Premium Collected: <strong style="color:var(--green)">$150</strong></li>
          <li>If Called Away: Sell at $180 + keep $150 = $3,150 total gain</li>
          <li>If Expires Worthless: Keep $150 + keep shares</li>
        </ul>
      </div>

      <h3>Possible Outcomes</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="background:var(--green-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--green)">Stock Stays Below Strike</div>
          <p style="margin:8px 0 0 0;font-size:14px">Call expires worthless. You keep the $150 premium AND your shares. Sell another call next week.</p>
        </div>
        <div style="background:var(--blue-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--blue)">Stock Rises Above Strike</div>
          <p style="margin:8px 0 0 0;font-size:14px">Shares "called away" at $180. You keep the $150 premium + $10/share gain. Return to selling CSPs.</p>
        </div>
        <div style="background:var(--orange-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--orange)">Stock Drops Significantly</div>
          <p style="margin:8px 0 0 0;font-size:14px">Call expires worthless. You keep premium but shares lose value. Continue selling calls to lower cost basis.</p>
        </div>
      </div>

      <div class="callout blue">
        <strong>Key Insight:</strong> Covered calls generate income while you wait for your shares to recover or reach your target price. Even if the stock drops, you're collecting premium that reduces your effective cost basis.
      </div>
    `,

    'cc-when-to-sell': `
      <h2>When To Sell Covered Calls</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/jKnXp2KBQSA" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@InTheMoney" target="_blank">InTheMoney</a></div>

      <p>Timing your covered calls correctly can significantly impact your returns. Here's when to sell and when to wait.</p>

      <h3>Ideal Conditions for Selling CCs</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;background:var(--green-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">✅</div>
          <div>
            <div style="font-weight:600">Stock is flat or slightly bullish</div>
            <div style="font-size:13px;color:var(--text2)">Ideal for premium collection without getting called away</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--green-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">✅</div>
          <div>
            <div style="font-weight:600">IV is elevated</div>
            <div style="font-size:13px;color:var(--text2)">Higher premiums for the same strikes</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--green-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">✅</div>
          <div>
            <div style="font-weight:600">Stock is at or above your cost basis</div>
            <div style="font-size:13px;color:var(--text2)">Getting called away locks in profit</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--green-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">✅</div>
          <div>
            <div style="font-weight:600">No major catalyst expected</div>
            <div style="font-size:13px;color:var(--text2)">Avoid earnings, FDA decisions, etc.</div>
          </div>
        </div>
      </div>

      <h3>When to WAIT Before Selling CCs</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;background:var(--orange-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">⚠️</div>
          <div>
            <div style="font-weight:600">Stock just dropped significantly</div>
            <div style="font-size:13px;color:var(--text2)">Premiums at current strikes may be too low. Wait for a bounce.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--orange-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">⚠️</div>
          <div>
            <div style="font-weight:600">Strong bullish catalyst coming</div>
            <div style="font-size:13px;color:var(--text2)">You might miss significant upside if called away early</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--orange-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">⚠️</div>
          <div>
            <div style="font-weight:600">Stock is deep underwater</div>
            <div style="font-size:13px;color:var(--text2)">Selling a CC at your cost basis may have almost no premium</div>
          </div>
        </div>
      </div>

      <h3>The Underwater Dilemma</h3>

      <p>If you got assigned at $100 and the stock is now at $80, you have choices:</p>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="margin-bottom:16px">
          <strong>Option A: Sell CC at Cost Basis ($100 strike)</strong>
          <ul style="margin:8px 0 0 0;font-size:14px">
            <li>Very low premium (stock needs to rally 25%)</li>
            <li>Preserves breakeven if called</li>
            <li>May take many weeks to get premium</li>
          </ul>
        </div>
        <div style="margin-bottom:16px">
          <strong>Option B: Sell CC Below Cost Basis ($90 strike)</strong>
          <ul style="margin:8px 0 0 0;font-size:14px">
            <li>Better premium</li>
            <li>If called, you lock in a loss</li>
            <li>Premium collected reduces that loss</li>
          </ul>
        </div>
        <div>
          <strong>Option C: Wait for Recovery</strong>
          <ul style="margin:8px 0 0 0;font-size:14px">
            <li>No premium while waiting</li>
            <li>Stock may continue to drop</li>
            <li>Sometimes the right choice</li>
          </ul>
        </div>
      </div>

      <div class="callout green">
        <strong>Best Practice:</strong> When underwater, sell calls at strikes where the premium collected plus the strike equals at least your cost basis. This ensures you don't lock in a loss when considering total premium collected.
      </div>

      <h3>The Best Day to Sell</h3>

      <ul>
        <li><strong>Monday:</strong> Full week of theta decay ahead. Good for weeklies.</li>
        <li><strong>After a Green Day:</strong> Strikes are higher, premiums are better.</li>
        <li><strong>When IV Spikes:</strong> Market fear = higher premiums.</li>
      </ul>
    `,

    'cc-strike-selection': `
      <h2>Strike Price Strategy</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/VH2lgFVL2VA" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@projectfinance" target="_blank">projectfinance</a></div>

      <p>Your covered call strike selection depends on your goals and outlook. Different strikes serve different purposes.</p>

      <h3>Strike Selection Philosophy</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0;text-align:center">
        <div style="font-size:18px;font-weight:600">Where would you be HAPPY to sell your shares?</div>
        <p style="margin:8px 0 0 0;color:var(--text2)">That's your strike price.</p>
      </div>

      <h3>Strike Price Strategies</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="background:var(--green-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--green)">Above Cost Basis (Aggressive Growth)</div>
          <div style="font-size:14px;margin-top:8px">
            <p style="margin:0 0 8px 0">Strike > Your cost basis. If called away, you profit from both stock gain AND premium.</p>
            <p style="margin:0"><strong>Use when:</strong> Bullish on the stock, okay with letting shares go for a profit.</p>
          </div>
        </div>
        <div style="background:var(--blue-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--blue)">At Cost Basis (Breakeven Focus)</div>
          <div style="font-size:14px;margin-top:8px">
            <p style="margin:0 0 8px 0">Strike = Your cost basis. If called away, you break even on shares but keep premium as profit.</p>
            <p style="margin:0"><strong>Use when:</strong> Want out of the position without taking a loss.</p>
          </div>
        </div>
        <div style="background:var(--orange-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--orange)">Below Cost Basis (Income Focus)</div>
          <div style="font-size:14px;margin-top:8px">
            <p style="margin:0 0 8px 0">Strike < Your cost basis. Higher premium, but if called away you have a capital loss (offset by premium).</p>
            <p style="margin:0"><strong>Use when:</strong> Stock is underwater, need income, or planning to harvest tax loss.</p>
          </div>
        </div>
      </div>

      <h3>Delta-Based Selection</h3>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)">
          <span>Conservative: 0.15-0.20 delta</span>
          <span style="font-size:13px;color:var(--text2)">~80-85% chance of keeping shares</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)">
          <span>Standard: 0.25-0.30 delta</span>
          <span style="font-size:13px;color:var(--text2)">~70-75% chance of keeping shares</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:10px 0">
          <span>Aggressive: 0.35-0.45 delta</span>
          <span style="font-size:13px;color:var(--text2)">~55-65% chance of keeping shares</span>
        </div>
      </div>

      <h3>The Premium vs Upside Tradeoff</h3>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:16px 0">
        <div style="background:var(--input);padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:28px;margin-bottom:8px">📈</div>
          <div style="font-weight:600">Higher Strike</div>
          <div style="font-size:13px;color:var(--text2);margin-top:8px">Less premium<br>More upside potential<br>Less likely to be called</div>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:28px;margin-bottom:8px">💰</div>
          <div style="font-weight:600">Lower Strike</div>
          <div style="font-size:13px;color:var(--text2);margin-top:8px">More premium<br>Less upside potential<br>More likely to be called</div>
        </div>
      </div>

      <div class="callout orange">
        <strong>Beau's Strike Selection:</strong> Same approach as CSPs - 0.40-0.90 delta range, same week expiration. The goal is to collect meaningful premium while still having a reasonable chance of keeping shares. If you're happy to let shares go at the strike price, it's a good strike.
      </div>

      <h3>Example Strike Comparison</h3>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-size:14px;margin-bottom:12px"><strong>AAPL at $175, your cost basis $170</strong></div>
        <table style="width:100%;font-size:13px">
          <tr style="border-bottom:1px solid var(--border)">
            <th style="text-align:left;padding:8px 0">Strike</th>
            <th style="text-align:center;padding:8px 0">Premium</th>
            <th style="text-align:center;padding:8px 0">Delta</th>
            <th style="text-align:right;padding:8px 0">If Called</th>
          </tr>
          <tr style="border-bottom:1px solid var(--border)">
            <td style="padding:8px 0">$180</td>
            <td style="text-align:center">$0.80</td>
            <td style="text-align:center">0.25</td>
            <td style="text-align:right;color:var(--green)">+$1,080 profit</td>
          </tr>
          <tr style="border-bottom:1px solid var(--border)">
            <td style="padding:8px 0">$177.50</td>
            <td style="text-align:center">$1.40</td>
            <td style="text-align:center">0.35</td>
            <td style="text-align:right;color:var(--green)">+$890 profit</td>
          </tr>
          <tr>
            <td style="padding:8px 0">$175</td>
            <td style="text-align:center">$2.20</td>
            <td style="text-align:center">0.50</td>
            <td style="text-align:right;color:var(--green)">+$720 profit</td>
          </tr>
        </table>
      </div>
    `,

    'cc-management': `
      <h2>Managing Your Covered Calls</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/x0VmGOMBaQY" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@tastylive" target="_blank">tastylive</a></div>

      <p>Like CSPs, covered calls require active management to maximize returns and avoid unnecessary losses. Here's how to manage them effectively.</p>

      <h3>Monitoring Your Position</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">📊</div>
          <div>
            <div style="font-weight:600">Stock Price vs Strike</div>
            <div style="font-size:13px;color:var(--text2)">Is it approaching your strike? Prepare for assignment or roll.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">⏱️</div>
          <div>
            <div style="font-weight:600">Time Remaining</div>
            <div style="font-size:13px;color:var(--text2)">More time = more can go wrong. Less time = theta accelerates.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">📰</div>
          <div>
            <div style="font-weight:600">Upcoming Events</div>
            <div style="font-size:13px;color:var(--text2)">Ex-dividend dates, earnings, major announcements.</div>
          </div>
        </div>
      </div>

      <h3>Exit Strategies</h3>

      <div style="background:var(--green-bg);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;color:var(--green);margin-bottom:8px">Option 1: Let It Expire</div>
        <p style="margin:0;font-size:14px">If OTM at expiration, option expires worthless. Keep 100% of premium, keep shares. No fees. Beau's preferred method.</p>
      </div>

      <div style="background:var(--blue-bg);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;color:var(--blue);margin-bottom:8px">Option 2: Let Shares Get Called Away</div>
        <p style="margin:0;font-size:14px">If ITM at expiration, shares sold at strike. You keep premium + any stock gains. Returns you to cash for CSPs.</p>
      </div>

      <div style="background:var(--orange-bg);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;color:var(--orange);margin-bottom:8px">Option 3: Roll the Call</div>
        <p style="margin:0;font-size:14px">Buy back current call, sell new one at later date and/or higher strike. Do this to keep shares or collect more premium.</p>
      </div>

      <h3>When to Roll Your Covered Call</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:start;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:20px">1.</div>
          <div>
            <div style="font-weight:600">Stock rallied through your strike</div>
            <div style="font-size:13px;color:var(--text2);margin-top:4px">Roll up and out to a higher strike + later expiration. Keeps shares, captures more upside.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:start;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:20px">2.</div>
          <div>
            <div style="font-weight:600">Want to keep shares for dividend</div>
            <div style="font-size:13px;color:var(--text2);margin-top:4px">Roll to avoid assignment before ex-dividend date.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:start;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:20px">3.</div>
          <div>
            <div style="font-weight:600">Expect continued upside</div>
            <div style="font-size:13px;color:var(--text2);margin-top:4px">If bullish outlook changed, roll to higher strike to participate in gains.</div>
          </div>
        </div>
      </div>

      <h3>Rolling Mechanics</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Example Roll</div>
        <div style="font-size:14px">
          <p><strong>Current position:</strong> Short AAPL $180 Call expiring Friday, stock at $182</p>
          <p><strong>Action:</strong> Buy to close $180 Call at $3.00 (debit)</p>
          <p><strong>Action:</strong> Sell to open $185 Call next week at $2.00 (credit)</p>
          <p><strong>Net:</strong> $1.00 debit, but now have $5 more upside potential and another week of premium opportunity.</p>
        </div>
      </div>

      <div class="callout green">
        <strong>Roll Rule:</strong> Try to roll for a NET CREDIT when possible. If you must pay a small debit to roll up and out, make sure the extra upside potential justifies it.
      </div>

      <h3>Early Assignment</h3>

      <p>American-style options can be exercised any time. Early assignment usually happens:</p>

      <ul>
        <li><strong>Before ex-dividend date</strong> (if dividend > remaining time value)</li>
        <li><strong>Deep ITM near expiration</strong> (almost no time value left)</li>
      </ul>

      <p>Early assignment isn't bad—you just sell shares sooner than expected. You keep all the premium and any stock gains up to the strike.</p>

      <div class="callout orange">
        <strong>Beau's CC Management:</strong> Same as CSPs—weekly expiration, let expire when possible. If stock approaches strike and you want to keep shares, roll up and/or out. Getting called away isn't bad; it means you made money and return to selling CSPs.
      </div>
    `,

    // MODULE 6: BEAU'S ELITE STRATEGY
    'beau-philosophy': `
      <h2>Trading Philosophy</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/dRYBh6dtxjY" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@KamikazeCash" target="_blank">Kamikaze Cash</a> — The Wheel Strategy Overview</div>

      <p>After 12+ years of full-time trading, the most important lessons aren't about techniques—they're about mindset. This philosophy has been refined through bull markets, bear markets, and everything in between.</p>

      <h3>The Core Philosophy</h3>

      <div style="background:linear-gradient(135deg, var(--orange-bg), var(--card));padding:24px;border-radius:16px;margin:20px 0;text-align:center;border:2px solid var(--orange)">
        <div style="font-size:32px;margin-bottom:12px">🎯</div>
        <div style="font-size:24px;font-weight:700;margin-bottom:8px">Slow and Consistent Wins</div>
        <p style="margin:0;font-size:16px">Target 0.5% - 1% per week. That's 26-52% per year. Compounded, this builds wealth.</p>
      </div>

      <h3>The Fundamental Truths</h3>

      <div style="display:grid;gap:16px;margin:20px 0">
        <div style="display:flex;gap:16px;align-items:start;background:var(--input);padding:20px;border-radius:12px">
          <div style="min-width:40px;height:40px;background:var(--green-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--green)">1</div>
          <div>
            <div style="font-weight:600;font-size:16px">Understand Before You Act</div>
            <p style="margin:8px 0 0 0;color:var(--text2)">You must understand the FULL wheel strategy before opening your first CSP. Know what happens if assigned. Know how covered calls work. Know when to roll. Half-knowledge leads to panic decisions.</p>
          </div>
        </div>

        <div style="display:flex;gap:16px;align-items:start;background:var(--input);padding:20px;border-radius:12px">
          <div style="min-width:40px;height:40px;background:var(--green-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--green)">2</div>
          <div>
            <div style="font-weight:600;font-size:16px">Cash Secured Means CASH SECURED</div>
            <p style="margin:8px 0 0 0;color:var(--text2)">Never sell a put without 100% of the cash to buy shares. Margin amplifies losses and leads to forced liquidations. If you can't afford assignment, you can't afford the trade.</p>
          </div>
        </div>

        <div style="display:flex;gap:16px;align-items:start;background:var(--input);padding:20px;border-radius:12px">
          <div style="min-width:40px;height:40px;background:var(--green-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--green)">3</div>
          <div>
            <div style="font-weight:600;font-size:16px">Consistency Over Home Runs</div>
            <p style="margin:8px 0 0 0;color:var(--text2)">You don't need 50% returns in a month. You need reliable, repeatable income. Small wins compound into life-changing money over time.</p>
          </div>
        </div>

        <div style="display:flex;gap:16px;align-items:start;background:var(--input);padding:20px;border-radius:12px">
          <div style="min-width:40px;height:40px;background:var(--green-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--green)">4</div>
          <div>
            <div style="font-weight:600;font-size:16px">Risk Management Is Everything</div>
            <p style="margin:8px 0 0 0;color:var(--text2)">The best strategy in the world fails without proper risk management. Position sizing, avoiding earnings, and knowing when NOT to trade matter more than finding the "perfect" setup.</p>
          </div>
        </div>
      </div>

      <h3>The Math of Consistency</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px;text-align:center">$50,000 Account at 0.75%/Week</div>
        <div style="display:grid;gap:8px;font-size:14px">
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
            <span>Weekly Income:</span>
            <span style="font-weight:600;color:var(--green)">$375</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
            <span>Monthly Income:</span>
            <span style="font-weight:600;color:var(--green)">$1,500</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
            <span>Year 1 (39% compounded):</span>
            <span style="font-weight:600;color:var(--green)">$69,500</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
            <span>Year 3:</span>
            <span style="font-weight:600;color:var(--green)">$134,300</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0">
            <span>Year 5:</span>
            <span style="font-weight:600;color:var(--green)">$259,400</span>
          </div>
        </div>
      </div>

      <div class="callout orange">
        <strong>Reality Check:</strong> These numbers assume no losing weeks, which isn't realistic. But even at 60% of this rate accounting for losses, you're still dramatically outperforming most investment strategies. Consistency compounds.
      </div>
    `,

    'beau-entry': `
      <h2>Entry Criteria & Setup</h2>

      <p>This is the exact entry criteria used for every trade. No exceptions, no "gut feelings," no chasing. If a setup doesn't meet ALL criteria, skip it.</p>

      <h3>The Entry Checklist</h3>

      <div style="background:var(--card);border:2px solid var(--green);border-radius:16px;padding:20px;margin:16px 0">
        <div style="font-weight:700;font-size:18px;margin-bottom:16px;color:var(--green)">✓ Pre-Trade Checklist</div>

        <div style="display:grid;gap:12px">
          <label style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:10px">
            <div style="min-width:24px;height:24px;border:2px solid var(--green);border-radius:6px"></div>
            <span><strong>Stock in uptrend</strong> - Check daily/weekly charts</span>
          </label>

          <label style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:10px">
            <div style="min-width:24px;height:24px;border:2px solid var(--green);border-radius:6px"></div>
            <span><strong>Higher IV</strong> - Above average for this stock</span>
          </label>

          <label style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:10px">
            <div style="min-width:24px;height:24px;border:2px solid var(--green);border-radius:6px"></div>
            <span><strong>No earnings this week</strong> - Check calendar</span>
          </label>

          <label style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:10px">
            <div style="min-width:24px;height:24px;border:2px solid var(--green);border-radius:6px"></div>
            <span><strong>Cash available</strong> - 100% secured for CSP</span>
          </label>

          <label style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:10px">
            <div style="min-width:24px;height:24px;border:2px solid var(--green);border-radius:6px"></div>
            <span><strong>Max 3 positions</strong> - Manageable, not overexposed</span>
          </label>
        </div>
      </div>

      <h3>Delta & DTE Selection</h3>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:16px 0">
        <div style="background:var(--green-bg);padding:20px;border-radius:12px;text-align:center">
          <div style="font-size:14px;color:var(--text2);margin-bottom:4px">Delta Range</div>
          <div style="font-size:32px;font-weight:700;color:var(--green)">0.40 - 0.90</div>
          <div style="font-size:13px;margin-top:8px">Higher delta = more premium<br>Requires conviction in stock</div>
        </div>
        <div style="background:var(--blue-bg);padding:20px;border-radius:12px;text-align:center">
          <div style="font-size:14px;color:var(--text2);margin-bottom:4px">Days to Expiration</div>
          <div style="font-size:32px;font-weight:700;color:var(--blue)">Same Week</div>
          <div style="font-size:13px;margin-top:8px">Maximum theta decay<br>Less time for problems</div>
        </div>
      </div>

      <div class="callout orange">
        <strong>Why Higher Delta?</strong> Traditional advice says 0.20-0.30 delta. We go higher because: (1) We carefully select uptrending stocks, (2) Short DTE means less time for breakdown, (3) Higher premium compensates for risk, (4) We're prepared to take assignment on stocks we like.
      </div>

      <h3>Stock Selection Criteria</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px">Ideal Stock Profile</div>

        <div style="display:grid;gap:12px">
          <div style="display:flex;gap:12px;align-items:center">
            <span style="color:var(--green);font-size:18px">✓</span>
            <span><strong>Clear uptrend</strong> on daily and weekly timeframes</span>
          </div>
          <div style="display:flex;gap:12px;align-items:center">
            <span style="color:var(--green);font-size:18px">✓</span>
            <span><strong>Higher IV than usual</strong> for this specific stock</span>
          </div>
          <div style="display:flex;gap:12px;align-items:center">
            <span style="color:var(--green);font-size:18px">✓</span>
            <span><strong>Liquid options</strong> - tight bid/ask spreads</span>
          </div>
          <div style="display:flex;gap:12px;align-items:center">
            <span style="color:var(--green);font-size:18px">✓</span>
            <span><strong>No binary events</strong> - no earnings, FDA, etc.</span>
          </div>
          <div style="display:flex;gap:12px;align-items:center">
            <span style="color:var(--green);font-size:18px">✓</span>
            <span><strong>Stock you'd own</strong> - if assigned, you're happy</span>
          </div>
        </div>
      </div>

      <h3>Position Sizing</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="text-align:center;margin-bottom:16px">
          <div style="font-size:48px;font-weight:700;color:var(--orange)">3</div>
          <div style="font-size:14px;color:var(--text2)">Maximum Concurrent Positions</div>
        </div>

        <p style="font-size:14px;margin:0">Never have more than 3 positions open at once. This keeps the portfolio manageable, limits correlation risk, and ensures you have cash available for opportunities or rolling.</p>
      </div>

      <h3>Strike Selection</h3>

      <p>For both CSPs and CCs, use the same approach:</p>

      <ul>
        <li><strong>OTM</strong> - Always out of the money</li>
        <li><strong>0.40-0.90 delta</strong> - Yes, this is aggressive</li>
        <li><strong>Premium target:</strong> 0.5-1% of capital at risk</li>
        <li><strong>Price you'd be happy with</strong> - to buy (CSP) or sell (CC)</li>
      </ul>
    `,

    'beau-management': `
      <h2>Position Management</h2>

      <p>Opening a position is just the start. How you manage it determines your success. Here are the exact management rules.</p>

      <h3>The Default: Let It Expire</h3>

      <div style="background:var(--green-bg);padding:24px;border-radius:12px;margin:16px 0;text-align:center">
        <div style="font-size:48px;margin-bottom:12px">🎯</div>
        <div style="font-size:20px;font-weight:700">Goal: Let Options Expire Worthless</div>
        <p style="margin:8px 0 0 0;color:var(--text2)">No closing fees. 100% of premium kept. Time does the work.</p>
      </div>

      <h3>When to Roll</h3>

      <p>Roll your position when:</p>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:start;background:var(--orange-bg);padding:16px;border-radius:12px">
          <div style="font-size:24px">⚠️</div>
          <div>
            <div style="font-weight:600">Getting Too Close to Strike (CSP)</div>
            <p style="margin:4px 0 0 0;font-size:14px">If stock approaches your put strike near expiration, roll out to avoid assignment. Don't wait until expiration day.</p>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:start;background:var(--orange-bg);padding:16px;border-radius:12px">
          <div style="font-size:24px">⚠️</div>
          <div>
            <div style="font-weight:600">Risk of Overnight Assignment</div>
            <p style="margin:4px 0 0 0;font-size:14px">If it looks like stock will close BELOW your put strike, you risk assignment overnight. Roll before close if you don't want shares.</p>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:start;background:var(--blue-bg);padding:16px;border-radius:12px">
          <div style="font-size:24px">📈</div>
          <div>
            <div style="font-weight:600">Stock Rallied Through CC Strike</div>
            <p style="margin:4px 0 0 0;font-size:14px">If you want to keep shares and capture more upside, roll up and/or out to a higher strike.</p>
          </div>
        </div>
      </div>

      <h3>Rolling Rules</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px;color:var(--green)">The Cardinal Rule of Rolling</div>
        <div style="font-size:20px;text-align:center;padding:16px;background:var(--green-bg);border-radius:8px;margin-bottom:16px">
          <strong>Only Roll For a Credit</strong>
        </div>
        <p style="font-size:14px;margin:0">If you can't collect additional premium by rolling, either take assignment (for CSPs) or let shares be called away (for CCs). Never pay to extend a losing trade.</p>
      </div>

      <h3>Daily Monitoring Routine</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:10px">
          <div style="min-width:32px;text-align:center;font-size:14px;color:var(--text2)">AM</div>
          <span>Check pre-market. Any news on your positions? Gap up/down?</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:10px">
          <div style="min-width:32px;text-align:center;font-size:14px;color:var(--text2)">MID</div>
          <span>Quick check. How far from strikes? Any concerns?</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:10px">
          <div style="min-width:32px;text-align:center;font-size:14px;color:var(--text2)">PM</div>
          <span>Final check. If expiration day, decide: let expire or roll?</span>
        </div>
      </div>

      <h3>Expiration Day Protocol</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">For CSPs on Expiration Day:</div>
        <ul style="margin:0;font-size:14px">
          <li>If stock is comfortably above strike → Let expire worthless ✅</li>
          <li>If stock is near strike (within 1-2%) → Consider rolling</li>
          <li>If stock is below strike → Roll out OR prepare for assignment</li>
        </ul>
      </div>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">For CCs on Expiration Day:</div>
        <ul style="margin:0;font-size:14px">
          <li>If stock is below strike → Let expire, keep shares ✅</li>
          <li>If stock is above strike → Let get called away (profit!) OR roll up/out</li>
        </ul>
      </div>

      <div class="callout green">
        <strong>Pro Tip:</strong> Most brokers auto-exercise ITM options at expiration. If you're close to the strike on expiration Friday, make your decision BEFORE 3pm to avoid surprises from after-hours moves.
      </div>
    `,

    'beau-risk': `
      <h2>Risk Management Rules</h2>

      <p>These rules are non-negotiable. They exist because they've been learned through experience (often painful). Follow them without exception.</p>

      <h3>The Non-Negotiable Rules</h3>

      <div style="display:grid;gap:16px;margin:20px 0">
        <div style="background:var(--card);border-left:4px solid var(--red);padding:20px;border-radius:0 12px 12px 0">
          <div style="font-weight:700;font-size:16px;color:var(--red)">Rule #1: Always Be Cash Secured</div>
          <p style="margin:8px 0 0 0">Never sell a put without 100% cash to cover assignment. No margin. No "I'll figure it out." Have the money or don't trade.</p>
        </div>

        <div style="background:var(--card);border-left:4px solid var(--red);padding:20px;border-radius:0 12px 12px 0">
          <div style="font-weight:700;font-size:16px;color:var(--red)">Rule #2: Avoid Earnings</div>
          <p style="margin:8px 0 0 0">Never hold options through earnings announcements. The binary risk isn't worth it. Check the earnings calendar before every trade.</p>
        </div>

        <div style="background:var(--card);border-left:4px solid var(--red);padding:20px;border-radius:0 12px 12px 0">
          <div style="font-weight:700;font-size:16px;color:var(--red)">Rule #3: Maximum 3 Positions</div>
          <p style="margin:8px 0 0 0">More positions = more to manage = more things to go wrong. Three positions keeps you focused and limits correlation risk.</p>
        </div>

        <div style="background:var(--card);border-left:4px solid var(--red);padding:20px;border-radius:0 12px 12px 0">
          <div style="font-weight:700;font-size:16px;color:var(--red)">Rule #4: Only Trade Stocks You'd Own</div>
          <p style="margin:8px 0 0 0">If you wouldn't buy the stock outright, don't sell puts on it. Assignment should feel like an opportunity, not a punishment.</p>
        </div>

        <div style="background:var(--card);border-left:4px solid var(--red);padding:20px;border-radius:0 12px 12px 0">
          <div style="font-weight:700;font-size:16px;color:var(--red)">Rule #5: Only Roll For a Credit</div>
          <p style="margin:8px 0 0 0">Never pay to extend a losing position. If you can't roll for a credit, take the assignment or loss and move on.</p>
        </div>
      </div>

      <h3>Capital Allocation</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px">Set Aside Dedicated Capital</div>
        <p style="font-size:14px;margin:0 0 16px 0">Use a specific portion of your account for CSPs. This is your "wheel capital." Don't touch it for other trades.</p>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div style="background:var(--green-bg);padding:16px;border-radius:10px;text-align:center">
            <div style="font-weight:600;color:var(--green)">Conservative</div>
            <div style="font-size:24px;font-weight:700;margin:8px 0">50-70%</div>
            <div style="font-size:12px;color:var(--text2)">of account for wheel</div>
          </div>
          <div style="background:var(--orange-bg);padding:16px;border-radius:10px;text-align:center">
            <div style="font-weight:600;color:var(--orange)">Aggressive</div>
            <div style="font-size:24px;font-weight:700;margin:8px 0">80-90%</div>
            <div style="font-size:12px;color:var(--text2)">of account for wheel</div>
          </div>
        </div>
      </div>

      <h3>When NOT to Trade</h3>

      <div style="display:grid;gap:8px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-size:18px">🚫</span>
          <span>Major economic events (Fed meetings, jobs reports, CPI)</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-size:18px">🚫</span>
          <span>Extreme market volatility (VIX > 30)</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-size:18px">🚫</span>
          <span>When emotional (just had a loss, stressed, FOMO)</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-size:18px">🚫</span>
          <span>When you can't monitor positions properly</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-size:18px">🚫</span>
          <span>If you don't have enough cash secured</span>
        </div>
      </div>

      <div class="callout orange">
        <strong>Remember:</strong> Missing a trade is not losing money. Taking a bad trade IS losing money. There will always be another opportunity. Patience is profitable.
      </div>
    `,

    'beau-mistakes': `
      <h2>Common Mistakes To Avoid</h2>

      <p>These mistakes have cost traders thousands (or more). Learn from them without paying the price yourself.</p>

      <h3>The Deadly Mistakes</h3>

      <div style="display:grid;gap:16px;margin:20px 0">
        <div style="background:var(--red-bg);padding:20px;border-radius:12px">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span style="font-size:24px">💀</span>
            <span style="font-weight:700;font-size:16px">Trading Without Full Understanding</span>
          </div>
          <p style="margin:0;font-size:14px">"I'll figure out covered calls when I get assigned." Wrong. If you don't understand the full cycle BEFORE starting, panic will drive your decisions. Complete this entire course first.</p>
        </div>

        <div style="background:var(--red-bg);padding:20px;border-radius:12px">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span style="font-size:24px">💀</span>
            <span style="font-weight:700;font-size:16px">Using Margin for "Cash Secured" Puts</span>
          </div>
          <p style="margin:0;font-size:14px">If you're using margin, they're not cash secured. A market crash can wipe you out and trigger margin calls. Always use actual cash. Always.</p>
        </div>

        <div style="background:var(--red-bg);padding:20px;border-radius:12px">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span style="font-size:24px">💀</span>
            <span style="font-weight:700;font-size:16px">Selling Puts on Stocks You Don't Want</span>
          </div>
          <p style="margin:0;font-size:14px">"The premium on this meme stock is crazy!" Until you're assigned, the stock drops another 40%, and you're stuck holding garbage. Only sell puts on stocks you'd buy anyway.</p>
        </div>

        <div style="background:var(--red-bg);padding:20px;border-radius:12px">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span style="font-size:24px">💀</span>
            <span style="font-weight:700;font-size:16px">Holding Through Earnings</span>
          </div>
          <p style="margin:0;font-size:14px">That 70% probability of profit becomes a coin flip when earnings drop. One bad report can move a stock 20%+ overnight. Close or roll before earnings. Every time.</p>
        </div>
      </div>

      <h3>The Sneaky Mistakes</h3>

      <div style="display:grid;gap:16px;margin:20px 0">
        <div style="background:var(--orange-bg);padding:20px;border-radius:12px">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span style="font-size:24px">⚠️</span>
            <span style="font-weight:700;font-size:16px">Chasing Premium</span>
          </div>
          <p style="margin:0;font-size:14px">"If 1% is good, 3% must be better!" High premium usually means high risk. There's a reason that premium is elevated. Stick to your target return range.</p>
        </div>

        <div style="background:var(--orange-bg);padding:20px;border-radius:12px">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span style="font-size:24px">⚠️</span>
            <span style="font-weight:700;font-size:16px">Overtrading</span>
          </div>
          <p style="margin:0;font-size:14px">Opening 10 positions because "more premium = more money." More positions = more to manage = more mistakes. Stick to the maximum of 3.</p>
        </div>

        <div style="background:var(--orange-bg);padding:20px;border-radius:12px">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span style="font-size:24px">⚠️</span>
            <span style="font-weight:700;font-size:16px">Panic Closing</span>
          </div>
          <p style="margin:0;font-size:14px">Stock drops 5% and you close for a loss. But if you'd held, it recovered and expired worthless. Have a plan BEFORE entering. Stick to it.</p>
        </div>

        <div style="background:var(--orange-bg);padding:20px;border-radius:12px">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span style="font-size:24px">⚠️</span>
            <span style="font-weight:700;font-size:16px">Ignoring the Trend</span>
          </div>
          <p style="margin:0;font-size:14px">"This stock is cheap, it must bounce." Cheap can get cheaper. Don't fight the trend. Sell puts on uptrending stocks, not falling knives.</p>
        </div>
      </div>

      <h3>The Recovery Framework</h3>

      <p>When things go wrong (and they will sometimes), here's how to recover:</p>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <ol style="margin:0;padding-left:20px">
          <li style="margin-bottom:12px"><strong>Don't panic.</strong> One bad trade doesn't ruin you if you followed the rules.</li>
          <li style="margin-bottom:12px"><strong>Evaluate honestly.</strong> Did you break a rule? What went wrong?</li>
          <li style="margin-bottom:12px"><strong>If assigned:</strong> It's not a loss until you sell. Sell covered calls to recover.</li>
          <li style="margin-bottom:12px"><strong>If truly stuck:</strong> Consider selling for a loss, harvest the tax benefit, move on.</li>
          <li><strong>Learn and adjust.</strong> Every loss is tuition. Make sure you learn the lesson.</li>
        </ol>
      </div>

      <div class="callout green">
        <strong>Final Thought:</strong> The best traders aren't the ones who never lose. They're the ones who lose small and win consistently. Follow the rules, manage your risk, and let time and compounding work their magic.
      </div>
    `,

    // MODULE 7: USING MARKET ELITES APP
    'app-overview': `
      <h2>App Overview</h2>

      <p>Welcome to Market Elites! This app is designed to be your companion for executing the wheel strategy. Here's a quick tour of everything available to you.</p>

      <h3>Home Screen</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="display:grid;gap:16px">
          <div style="display:flex;gap:12px;align-items:start">
            <div style="min-width:40px;height:40px;background:var(--green-bg);border-radius:10px;display:flex;align-items:center;justify-content:center">💰</div>
            <div>
              <div style="font-weight:600">Account Balance</div>
              <p style="margin:4px 0 0 0;font-size:14px;color:var(--text2)">Shows your total account value and current premium collected</p>
            </div>
          </div>
          <div style="display:flex;gap:12px;align-items:start">
            <div style="min-width:40px;height:40px;background:var(--blue-bg);border-radius:10px;display:flex;align-items:center;justify-content:center">📊</div>
            <div>
              <div style="font-weight:600">Active Positions</div>
              <p style="margin:4px 0 0 0;font-size:14px;color:var(--text2)">Your current CSPs and CCs with P&L, premium, and DTE</p>
            </div>
          </div>
          <div style="display:flex;gap:12px;align-items:start">
            <div style="min-width:40px;height:40px;background:var(--purple-bg);border-radius:10px;display:flex;align-items:center;justify-content:center">📜</div>
            <div>
              <div style="font-weight:600">Trade History</div>
              <p style="margin:4px 0 0 0;font-size:14px;color:var(--text2)">Closed trades with profits/losses for tracking performance</p>
            </div>
          </div>
        </div>
      </div>

      <h3>Main Navigation</h3>

      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:16px 0">
        <div style="background:var(--input);padding:16px 8px;border-radius:12px;text-align:center">
          <div style="font-size:24px;margin-bottom:4px">🏠</div>
          <div style="font-size:12px;font-weight:600">Home</div>
        </div>
        <div style="background:var(--input);padding:16px 8px;border-radius:12px;text-align:center">
          <div style="font-size:24px;margin-bottom:4px">🧮</div>
          <div style="font-size:12px;font-weight:600">Calculator</div>
        </div>
        <div style="background:var(--input);padding:16px 8px;border-radius:12px;text-align:center">
          <div style="font-size:24px;margin-bottom:4px">📡</div>
          <div style="font-size:12px;font-weight:600">Signals</div>
        </div>
        <div style="background:var(--input);padding:16px 8px;border-radius:12px;text-align:center">
          <div style="font-size:24px;margin-bottom:4px">⚙️</div>
          <div style="font-size:12px;font-weight:600">Settings</div>
        </div>
      </div>

      <h3>Quick Actions</h3>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <ul style="margin:0;padding-left:20px;font-size:14px">
          <li style="margin-bottom:8px"><strong>+ Add Position:</strong> Manually add a new CSP or CC to track</li>
          <li style="margin-bottom:8px"><strong>Sync:</strong> Connect to Alpaca to auto-import positions</li>
          <li style="margin-bottom:8px"><strong>Learn:</strong> Access this education center anytime</li>
          <li><strong>Wheely AI:</strong> Chat with our AI assistant for quick answers</li>
        </ul>
      </div>

      <h3>Premium Features</h3>

      <div style="background:linear-gradient(135deg, var(--orange-bg), var(--card));padding:20px;border-radius:12px;margin:16px 0;border:1px solid var(--orange)">
        <div style="font-weight:600;color:var(--orange);margin-bottom:12px">🔥 Elite Premium</div>
        <ul style="margin:0;padding-left:20px;font-size:14px">
          <li style="margin-bottom:8px"><strong>Live Trade Signals:</strong> Real-time alerts when trades are placed</li>
          <li style="margin-bottom:8px"><strong>Roll Notifications:</strong> Know when positions are being rolled</li>
          <li><strong>Market Announcements:</strong> Important updates and market commentary</li>
        </ul>
      </div>

      <div class="callout blue">
        <strong>Tip:</strong> The status indicator in the top right shows your connection status. "Live" means you're connected to real-time market data.
      </div>
    `,

    'app-signals': `
      <h2>Following Signals</h2>

      <p>Premium members get access to real-time trading signals. Here's how to use them effectively.</p>

      <h3>What Are Signals?</h3>

      <div style="background:var(--green-bg);padding:20px;border-radius:12px;margin:16px 0">
        <p style="margin:0"><strong>Signals</strong> are real-time notifications when trades are placed. They include the ticker, strike, expiration, premium, and delta—everything you need to evaluate and potentially follow the trade.</p>
      </div>

      <h3>Signal Types</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="background:var(--input);padding:16px;border-radius:12px;border-left:4px solid var(--green)">
          <div style="font-weight:600;color:var(--green);margin-bottom:8px">CSP Signal</div>
          <p style="margin:0;font-size:14px">A new cash secured put has been opened. Shows ticker, strike, premium, delta, and DTE.</p>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px;border-left:4px solid var(--blue)">
          <div style="font-weight:600;color:var(--blue);margin-bottom:8px">CC Signal</div>
          <p style="margin:0;font-size:14px">A new covered call has been opened. Shows ticker, strike, premium, delta, and DTE.</p>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px;border-left:4px solid var(--purple)">
          <div style="font-weight:600;color:var(--purple);margin-bottom:8px">Roll Alert</div>
          <p style="margin:0;font-size:14px">A position is being rolled. Shows the original position and new position with credit collected.</p>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px;border-left:4px solid var(--orange)">
          <div style="font-weight:600;color:var(--orange);margin-bottom:8px">Announcement</div>
          <p style="margin:0;font-size:14px">Important market commentary, strategy updates, or general information.</p>
        </div>
      </div>

      <h3>How to Use Signals</h3>

      <div style="display:grid;gap:16px;margin:20px 0">
        <div style="display:flex;gap:16px;align-items:start">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700">1</div>
          <div>
            <div style="font-weight:600">Review the Signal</div>
            <p style="margin:4px 0 0 0;font-size:14px;color:var(--text2)">Check the ticker, strike, premium, and delta. Does it fit your criteria?</p>
          </div>
        </div>
        <div style="display:flex;gap:16px;align-items:start">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700">2</div>
          <div>
            <div style="font-weight:600">Do Your Own Analysis</div>
            <p style="margin:4px 0 0 0;font-size:14px;color:var(--text2)">Check the chart. Verify no earnings this week. Confirm you have the capital.</p>
          </div>
        </div>
        <div style="display:flex;gap:16px;align-items:start">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700">3</div>
          <div>
            <div style="font-weight:600">Decide to Follow or Pass</div>
            <p style="margin:4px 0 0 0;font-size:14px;color:var(--text2)">Not every signal is right for everyone. Your position size and risk tolerance matter.</p>
          </div>
        </div>
        <div style="display:flex;gap:16px;align-items:start">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700">4</div>
          <div>
            <div style="font-weight:600">Execute in Your Broker</div>
            <p style="margin:4px 0 0 0;font-size:14px;color:var(--text2)">Place the trade in your brokerage account. Prices may vary slightly.</p>
          </div>
        </div>
      </div>

      <div class="callout orange">
        <strong>Important:</strong> Signals are educational and informational. They are NOT financial advice. Always do your own due diligence and only trade what you can afford to lose. Past performance doesn't guarantee future results.
      </div>

      <h3>Signal Timing</h3>

      <p>Signals are typically posted:</p>
      <ul>
        <li>Near market open (9:30-10:30 AM ET) for new positions</li>
        <li>Near market close (3:00-4:00 PM ET) for rolls on expiration days</li>
        <li>Throughout the day for urgent rolls or announcements</li>
      </ul>

      <div class="callout blue">
        <strong>Tip:</strong> Enable notifications to get alerted when new signals are posted. Speed matters for getting similar fills.
      </div>
    `,

    'app-calculator': `
      <h2>Using The Calculator</h2>

      <p>The Options Calculator is your primary tool for finding and evaluating trades. It pulls real-time data and helps you find the best opportunities.</p>

      <h3>Finding Options</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px">Step 1: Enter a Ticker</div>
        <p style="font-size:14px;margin:0">Type any stock symbol (AAPL, NVDA, SPY, etc.) in the search bar and hit enter or tap search. The app will fetch real-time price and options data.</p>
      </div>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px">Step 2: Select CSP or CC Mode</div>
        <p style="font-size:14px;margin:0">Toggle between Cash Secured Put and Covered Call modes. This filters the options chain to show the relevant options.</p>
      </div>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px">Step 3: Choose Expiration</div>
        <p style="font-size:14px;margin:0">Select an expiration date from the available options. Remember: same-week expirations align with Beau's strategy.</p>
      </div>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px">Step 4: Review the Options Chain</div>
        <p style="font-size:14px;margin:0">See all available strikes with their premiums, deltas, and other data. Tap a strike to see more details.</p>
      </div>

      <h3>Understanding the Display</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;justify-content:space-between;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-weight:600">Strike</span>
          <span style="color:var(--text2)">The price you'll buy (CSP) or sell (CC) at</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-weight:600">Premium</span>
          <span style="color:var(--text2)">Price per share you collect (× 100 for total)</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-weight:600">Delta</span>
          <span style="color:var(--text2)">Probability indicator (and price sensitivity)</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-weight:600">ROC</span>
          <span style="color:var(--text2)">Return on Capital (premium ÷ capital required)</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-weight:600">Bid/Ask</span>
          <span style="color:var(--text2)">Current market prices for the option</span>
        </div>
      </div>

      <h3>Filtering Options</h3>

      <p>Use the quick filter buttons to find options matching your criteria:</p>

      <ul>
        <li><strong>By Delta:</strong> Filter to show only options in your target delta range</li>
        <li><strong>By ROC:</strong> Filter to show options meeting minimum return targets</li>
        <li><strong>By DTE:</strong> Filter by days to expiration</li>
      </ul>

      <h3>Adding to Portfolio</h3>

      <p>Once you find an option you like:</p>

      <ol>
        <li>Tap the strike to select it</li>
        <li>Adjust contracts if needed</li>
        <li>Tap "Add to Portfolio" to track it in the app</li>
        <li>Execute the actual trade in your broker</li>
      </ol>

      <div class="callout green">
        <strong>Pro Tip:</strong> Use the quick search buttons (AAPL, NVDA, AMD, etc.) to quickly jump to popular tickers. The calculator remembers your last search too.
      </div>

      <h3>Quick Searches</h3>

      <p>Popular tickers are available as quick buttons for fast access:</p>

      <div style="display:flex;flex-wrap:wrap;gap:8px;margin:16px 0">
        <span style="background:var(--input);padding:8px 16px;border-radius:20px;font-weight:600">AAPL</span>
        <span style="background:var(--input);padding:8px 16px;border-radius:20px;font-weight:600">NVDA</span>
        <span style="background:var(--input);padding:8px 16px;border-radius:20px;font-weight:600">AMD</span>
        <span style="background:var(--input);padding:8px 16px;border-radius:20px;font-weight:600">TSLA</span>
        <span style="background:var(--input);padding:8px 16px;border-radius:20px;font-weight:600">SPY</span>
        <span style="background:var(--input);padding:8px 16px;border-radius:20px;font-weight:600">QQQ</span>
      </div>

      <div class="callout blue">
        <strong>Remember:</strong> The calculator shows real-time data, but prices can change quickly. Always verify the current price in your broker before executing.
      </div>
    `
  };

  return content[chapterId] || '<p>Lesson content coming soon...</p>';
}

function openAnalytics(){
  const positions = S.positions || [];
  const history = S.history || [];
  const allTrades = [...positions, ...history];

  // Calculate stats
  const openPrem = positions.reduce((s,p)=>s+(p.premium||0)*(p.contracts||1)*100,0);
  const closedPrem = history.reduce((s,t)=>s+(t.premium||0)*(t.contracts||1)*100,0);
  const totalPrem = openPrem + closedPrem;
  const totalPnl = history.reduce((s,t)=>s+(t.pnl||0),0);
  const wins = history.filter(t=>(t.pnl||0)>=0).length;
  const losses = history.filter(t=>(t.pnl||0)<0).length;
  const total = history.length;
  const winRate = total > 0 ? Math.round(wins/total*100) : 0;
  const avgWin = wins > 0 ? history.filter(t=>(t.pnl||0)>=0).reduce((s,t)=>s+(t.pnl||0),0)/wins : 0;
  const avgLoss = losses > 0 ? Math.abs(history.filter(t=>(t.pnl||0)<0).reduce((s,t)=>s+(t.pnl||0),0)/losses) : 0;

  // Group by ticker
  const byTicker = {};
  allTrades.forEach(t => {
    if (!byTicker[t.symbol]) byTicker[t.symbol] = { prem: 0, trades: 0, pnl: 0 };
    byTicker[t.symbol].prem += (t.premium||0)*(t.contracts||1)*100;
    byTicker[t.symbol].trades++;
    byTicker[t.symbol].pnl += (t.pnl||0);
  });

  // Group by type
  const cspTrades = allTrades.filter(t=>t.type==='csp');
  const ccTrades = allTrades.filter(t=>t.type==='cc');
  const cspPrem = cspTrades.reduce((s,t)=>s+(t.premium||0)*(t.contracts||1)*100,0);
  const ccPrem = ccTrades.reduce((s,t)=>s+(t.premium||0)*(t.contracts||1)*100,0);

  let html = `
    <div style="background:linear-gradient(135deg,var(--green),#059669);border-radius:16px;padding:24px;text-align:center;margin-bottom:16px;color:#fff">
      <div style="font-size:13px;opacity:0.9">Total Premium</div>
      <div style="font-size:36px;font-weight:800;margin:4px 0">$${totalPrem.toFixed(0)}</div>
      <div style="font-size:13px;opacity:0.8">$${closedPrem.toFixed(0)} realized · $${openPrem.toFixed(0)} pending</div>
      <div style="font-size:12px;opacity:0.6;margin-top:2px">${positions.length} open · ${history.length} closed</div>
    </div>

    <div class="stats-grid" style="margin-bottom:16px">
      <div class="stat-box"><div class="stat-val" style="color:var(--green)">${winRate}%</div><div class="stat-label">Win Rate</div></div>
      <div class="stat-box"><div class="stat-val">${total}</div><div class="stat-label">Closed Trades</div></div>
      <div class="stat-box"><div class="stat-val" style="color:${totalPnl>=0?'var(--green)':'var(--red)'}">${totalPnl>=0?'+':''}$${totalPnl.toFixed(0)}</div><div class="stat-label">Realized P&L</div></div>
      <div class="stat-box"><div class="stat-val">${positions.length}</div><div class="stat-label">Open Positions</div></div>
    </div>

    ${total > 0 ? `<div style="background:var(--input);border-radius:12px;padding:16px;margin-bottom:16px">
      <div style="font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px">Performance</div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text2)">Avg Win</span><span style="font-weight:600;color:var(--green)">+$${avgWin.toFixed(0)}</span></div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text2)">Avg Loss</span><span style="font-weight:600;color:var(--red)">-$${avgLoss.toFixed(0)}</span></div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text2)">Wins / Losses</span><span style="font-weight:600">${wins}W / ${losses}L</span></div>
      <div style="display:flex;justify-content:space-between;padding:8px 0"><span style="color:var(--text2)">Profit Factor</span><span style="font-weight:600">${avgLoss>0?(avgWin*wins/(avgLoss*losses)).toFixed(2):'—'}</span></div>
    </div>` : ''}

    <div style="background:var(--input);border-radius:12px;padding:16px;margin-bottom:16px">
      <div style="font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px">By Strategy</div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text2)">CSP Premium</span><span style="font-weight:600;color:var(--green)">$${cspPrem.toFixed(0)} (${cspTrades.length} trades)</span></div>
      <div style="display:flex;justify-content:space-between;padding:8px 0"><span style="color:var(--text2)">CC Premium</span><span style="font-weight:600;color:var(--blue)">$${ccPrem.toFixed(0)} (${ccTrades.length} trades)</span></div>
    </div>`;

  // Top tickers
  const sortedTickers = Object.entries(byTicker).sort((a,b) => b[1].prem - a[1].prem).slice(0,5);
  if (sortedTickers.length > 0) {
    html += `<div style="background:var(--input);border-radius:12px;padding:16px">
      <div style="font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px">By Ticker</div>`;
    sortedTickers.forEach(([sym, data], i) => {
      const border = i < sortedTickers.length - 1 ? 'border-bottom:1px solid var(--border);' : '';
      html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;${border}"><div><span style="font-weight:600">${sym}</span> <span style="font-size:12px;color:var(--text3)">${data.trades} trades</span></div><span style="font-weight:600;color:var(--green)">$${data.prem.toFixed(0)}</span></div>`;
    });
    html += '</div>';
  }

  $('analyticsContent').innerHTML = html;
  // Add P&L charts at top of analytics
  renderPnlCharts($('analyticsContent'));
  openModal('analyticsModal');
}
function openAI(){
  if(!$('aiMessages').innerHTML){
    $('aiMessages').innerHTML='<div class="ai-msg bot">Hey! I\'m <b>Wheely</b> — your wheel strategy assistant. Ask me anything about options, CSPs, covered calls, the Greeks, position sizing, or managing trades!</div>';
  }
  openModal('aiModal');
}

const WHEELY_SYSTEM = `You are Wheely, an expert options trading assistant for Market Elites, a wheel strategy platform. You specialize in:
- The wheel strategy (selling cash secured puts and covered calls)
- Options Greeks (delta, theta, gamma, vega, IV)
- Strike selection, DTE selection, position sizing
- Rolling positions, managing assignments
- Risk management for options sellers

Keep responses concise (2-4 sentences max unless asked for detail). Use plain language. If the user asks something unrelated to trading/options, politely redirect them. Never give specific trade recommendations or financial advice — always note this is educational.`;

let aiConversation = [];

async function sendAI(){
  const i=$('aiInput'),m=i.value.trim();
  if(!m)return;
  $('aiMessages').innerHTML+=`<div class="ai-msg user">${escapeHtml(m)}</div>`;
  i.value='';
  $('aiMessages').scrollTop=$('aiMessages').scrollHeight;

  // Show typing indicator
  $('aiMessages').innerHTML+='<div class="ai-msg bot" id="aiTyping" style="opacity:0.6">Thinking...</div>';
  $('aiMessages').scrollTop=$('aiMessages').scrollHeight;

  const groqKey = localStorage.getItem('groqApiKey');
  if(!groqKey){
    document.getElementById('aiTyping')?.remove();
    $('aiMessages').innerHTML+='<div class="ai-msg bot">To chat with me, add your free Groq API key in <b>Profile > Settings</b>. Get one free at <a href="https://console.groq.com" target="_blank" style="color:var(--blue)">console.groq.com</a></div>';
    $('aiMessages').scrollTop=$('aiMessages').scrollHeight;
    return;
  }

  aiConversation.push({role:'user',content:m});
  // Keep last 10 messages for context
  if(aiConversation.length>10) aiConversation=aiConversation.slice(-10);

  try{
    const r=await fetch('https://api.groq.com/openai/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+groqKey},
      body:JSON.stringify({
        model:'llama-3.3-70b-versatile',
        messages:[{role:'system',content:WHEELY_SYSTEM},...aiConversation],
        max_tokens:500,
        temperature:0.7
      })
    });
    const data=await r.json();
    document.getElementById('aiTyping')?.remove();

    if(data.error){
      $('aiMessages').innerHTML+='<div class="ai-msg bot">Sorry, I hit an error. '+escapeHtml(data.error.message||'Try again.')+'</div>';
    } else {
      const reply=data.choices?.[0]?.message?.content||'Sorry, I couldn\'t generate a response.';
      aiConversation.push({role:'assistant',content:reply});
      $('aiMessages').innerHTML+=`<div class="ai-msg bot">${formatAiResponse(reply)}</div>`;
    }
  }catch(e){
    document.getElementById('aiTyping')?.remove();
    $('aiMessages').innerHTML+='<div class="ai-msg bot">Connection error. Check your API key and try again.</div>';
  }
  $('aiMessages').scrollTop=$('aiMessages').scrollHeight;
}

function escapeHtml(str){return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function formatAiResponse(text){
  return text
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.*?)\*/g,'<em>$1</em>')
    .replace(/\n/g,'<br>');
}
function openPremium(){openModal('premiumModal')}

// === STRIPE PREMIUM SUBSCRIPTION ===
// Replace this URL with your Stripe Payment Link
// Create one at: https://dashboard.stripe.com/payment-links
function getStripePaymentLink() {
  return localStorage.getItem('stripePaymentLink') || '';
}

function handlePremiumSubscribe() {
  if (!S.firebaseUid && !S.isGuest) {
    showToast('Please sign in first', 'error');
    return;
  }

  if (S.isGuest) {
    showToast('Create an account to subscribe', 'error');
    promptCreateAccount();
    return;
  }

  const stripeLink = getStripePaymentLink();
  if (!stripeLink) {
    // No Stripe link configured yet - enable premium directly for testing
    showConfirm('Enable Premium', 'Premium payments are being set up. Enable premium access for testing?', () => {
      activatePremium();
    });
    return;
  }

  // Redirect to Stripe with user info for webhook matching
  const url = new URL(stripeLink);
  url.searchParams.set('client_reference_id', S.firebaseUid);
  if (S.user.email) url.searchParams.set('prefilled_email', S.user.email);
  window.open(url.toString(), '_blank');
  closeModal('premiumModal');
  showToast('Complete payment in the new tab', 'success');
}

async function activatePremium() {
  S.isPremium = true;
  save();

  // Save to Firebase
  if (S.firebaseUid && await initFirebase()) {
    try {
      await firebase.database().ref('users/' + S.firebaseUid).update({ isPremium: true, premiumSince: Date.now() });
    } catch (e) { console.error('Firebase update error:', e); }
  }

  closeModal('premiumModal');
  renderProfile();
  renderSignals();
  showToast('Premium activated!', 'success');
}
function toggleNotif(){
  if (!S.notifOn) {
    // Turning ON - request browser permission
    requestBrowserNotifications().then(granted => {
      S.notifOn = granted;
      ['notifSwitch','qNotifSwitch'].forEach(id=>$(id)?.classList.toggle('on',S.notifOn));
      save();
      if (granted) {
        showToast('Notifications enabled!', 'success');
        // Also subscribe email if available
        if (S.alertEmail || S.user?.email) {
          subscribeEmailToAlerts(S.alertEmail || S.user.email);
        }
      }
    });
  } else {
    // Turning OFF
    S.notifOn = false;
    ['notifSwitch','qNotifSwitch'].forEach(id=>$(id)?.classList.toggle('on', false));
    save();
    showToast('Notifications disabled', '');
  }
}

// Request browser notification permission
async function requestBrowserNotifications() {
  if (!('Notification' in window)) {
    showToast('Browser notifications not supported', 'error');
    return false;
  }
  if (Notification.permission === 'granted') return true;
  if (Notification.permission === 'denied') {
    showToast('Notifications blocked. Enable in browser settings.', 'error');
    return false;
  }
  const permission = await Notification.requestPermission();
  return permission === 'granted';
}

// Subscribe email to Firebase alerts
async function subscribeEmailToAlerts(email) {
  if (!email || !email.includes('@')) return;
  const ok = await initFirebase();
  if (!ok) return;
  const emailKey = email.replace(/[.#$[\]]/g, '_');
  firebase.database().ref('emailSubscribers/' + emailKey).set({
    email: email,
    active: true,
    subscribedAt: Date.now(),
    source: 'notif_toggle',
    uid: S.firebaseUid || null
  });
}

// Show browser notification for new posts
function showBrowserNotification(title, body) {
  if (!S.notifOn || Notification.permission !== 'granted') return;
  try {
    const n = new Notification(title, {
      body: body,
      icon: 'logo.png',
      badge: 'logo.png',
      tag: 'market-elites-' + Date.now()
    });
    n.onclick = () => { window.focus(); n.close(); };
  } catch(e) { console.error('Notification error:', e); }
}
function getComputedBalance(){
  // Use explicitly set starting balance, or default 25000
  const base = S.startingBalance || 25000;
  const historyPnl = (S.history || []).reduce((s,t) => s + (t.pnl || 0), 0);
  return base + historyPnl;
}
function updateStatus(){
  const hasBroker=S.apiKey.length>10&&S.secretKey.length>10;
  // Always show live for market data (no API key needed)
  $('statusPill').className='status live';
  $('statusText').textContent=hasBroker?'Live + Broker':'Live Data';
}


// ========== MASTER PORTFOLIO TRACKER ==========
function computePortfolioStats() {
  const posts = S.adminPosts || [];
  const wheels = S.wheelPositions || [];
  const history = S.history || [];
  const allSignals = posts.filter(p => p.kind === 'signal');
  const openCSPs = allSignals.filter(p => p.type === 'csp' && (!p.status || p.status === 'open'));
  const openCCs = allSignals.filter(p => p.type === 'cc' && (!p.status || p.status === 'open'));
  // Only count winners/called that still have matching wheel positions or are standalone
  const winners = allSignals.filter(p => p.status === 'winner' && (!p.wheelId || wheels.some(w => w.id === p.wheelId)));
  const assigned = allSignals.filter(p => p.status === 'assigned');
  const called = allSignals.filter(p => p.status === 'called' && (!p.wheelId || wheels.some(w => w.id === p.wheelId)));
  const rolled = allSignals.filter(p => p.status === 'rolled' || p.rollCount > 0);

  let totalPremiumCollected = 0;
  winners.forEach(p => {
    const prem = p.totalPremiumCollected || parseFloat((p.prem || '').replace(/[$,]/g, '')) || 0;
    totalPremiumCollected += prem * 100 * (p.assignedContracts || 1);
  });

  let wheelPremium = 0, wheelStockPnl = 0;
  wheels.filter(w => w.status === 'holding').forEach(w => {
    const ccPrem = w.ccHistory.reduce((s, cc) => s + (cc.premiumTotal || 0), 0);
    wheelPremium += (w.totalPremiumCollected || 0) + ccPrem;
    wheelStockPnl += ((w.currentPrice || w.assignPrice) - w.assignPrice) * w.shares;
  });

  let realizedWheelPnl = 0;
  history.filter(h => h.outcome === 'called_away').forEach(h => { realizedWheelPnl += h.pnl || 0; });

  const closedTrades = winners.length + called.length;
  const winRate = closedTrades > 0 ? Math.round(winners.length / closedTrades * 100) : 0;

  return {
    totalSignals: allSignals.length, openCSPs: openCSPs.length, openCCs: openCCs.length,
    activeWheels: wheels.filter(w => w.status === 'holding').length,
    winners: winners.length, assigned: assigned.length, called: called.length, rolled: rolled.length,
    totalPremiumCollected, wheelPremium, wheelStockPnl,
    wheelNetPnl: wheelStockPnl + wheelPremium, realizedWheelPnl,
    totalPnl: totalPremiumCollected + wheelStockPnl + wheelPremium + realizedWheelPnl,
    winRate, closedTrades
  };
}


function timeAgo(ts) {
  const s = Math.floor((Date.now() - ts) / 1000);
  if (s < 60) return 'just now';
  if (s < 3600) return Math.floor(s/60) + 'm ago';
  if (s < 86400) return Math.floor(s/3600) + 'h ago';
  if (s < 604800) return Math.floor(s/86400) + 'd ago';
  return new Date(ts).toLocaleDateString();
}

async function renderAdminUsers() {
  const el = $('adminUsersList');
  const countEl = $('userCount');
  if (!el) return;
  if (!await initFirebase()) { el.innerHTML = '<div style="font-size:12px;color:var(--text3);padding:12px">Firebase not connected</div>'; return; }
  try {
    const snapshot = await firebase.database().ref('users').orderByChild('createdAt').once('value');
    const users = [];
    snapshot.forEach(child => { users.unshift({ uid: child.key, ...child.val() }); });
    if (countEl) countEl.textContent = users.length;
    if (!users.length) { el.innerHTML = '<div style="font-size:12px;color:var(--text3);padding:12px">No users yet</div>'; return; }
    el.innerHTML = users.map(u => {
      const date = u.createdAt ? new Date(u.createdAt).toLocaleDateString() : '?';
      const lastLogin = u.lastLogin ? timeAgo(u.lastLogin) : 'Never';
      const prov = u.provider ? `<span style="font-size:10px;background:var(--input);padding:1px 6px;border-radius:3px;margin-left:4px">${u.provider}</span>` : '';
      const premium = u.isPremium ? '<span style="font-size:10px;background:var(--green-bg);color:var(--green);padding:1px 6px;border-radius:3px;margin-left:4px;font-weight:600">PRO</span>' : '';
      const proBtn = u.isPremium
        ? `<button onclick="toggleUserPremium('${u.uid}',false)" style="font-size:10px;padding:3px 8px;border-radius:4px;border:1px solid var(--red);background:transparent;color:var(--red);cursor:pointer;white-space:nowrap">Revoke PRO</button>`
        : `<button onclick="toggleUserPremium('${u.uid}',true)" style="font-size:10px;padding:3px 8px;border-radius:4px;border:1px solid var(--green);background:var(--green-bg);color:var(--green);cursor:pointer;white-space:nowrap">Grant PRO</button>`;
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);font-size:13px;gap:8px">
        <div style="flex:1;min-width:0">
          <div style="font-weight:600">${u.name || 'User'}${prov}${premium}</div>
          <div style="font-size:11px;color:var(--text3)">${u.email || 'No email'}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          ${proBtn}
          <div style="text-align:right;font-size:11px;color:var(--text3);white-space:nowrap">
            <div>Joined ${date}</div><div>Last active ${lastLogin}</div>
          </div>
        </div>
      </div>`;
    }).join('');
  } catch (e) { console.warn('Load users error:', e); el.innerHTML = '<div style="font-size:12px;color:var(--text3);padding:12px">Failed to load users</div>'; }
}

async function toggleUserPremium(uid, grant) {
  if (!isAdmin()) return;
  try {
    const updates = grant ? { isPremium: true, premiumSince: Date.now() } : { isPremium: false, premiumSince: null };
    await firebase.database().ref('users/' + uid).update(updates);
    showToast(grant ? 'Premium granted!' : 'Premium revoked', grant ? 'success' : '');
    renderAdminUsers();
  } catch (e) {
    console.error('Toggle premium error:', e);
    showToast('Failed to update premium status', 'error');
  }
}

async function notifyNewSignup(name, email, provider) {
  const webhookUrl = localStorage.getItem('discordWebhook');
  if (!webhookUrl) return;
  try {
    await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username: 'Market Elites',
        embeds: [{
          title: '🆕 New User Signed Up!',
          color: 0x3b82f6,
          fields: [
            { name: 'Name', value: name || 'Unknown', inline: true },
            { name: 'Email', value: email || 'N/A', inline: true },
            { name: 'Method', value: provider || 'email', inline: true }
          ],
          timestamp: new Date().toISOString(),
          footer: { text: 'Market Elites · New Registration' }
        }]
      })
    });
  } catch (e) { console.warn('Signup Discord notify:', e); }
}

function renderMasterPortfolio() {
  const c = $('masterPortfolio');
  if (!c) return;
  const s = computePortfolioStats();
  const fmtPnl = (v) => v >= 0 ? `+$${v.toFixed(0)}` : `-$${Math.abs(v).toFixed(0)}`;
  const pnlColor = (v) => v >= 0 ? 'var(--green)' : 'var(--red)';
  c.innerHTML = `
    <div style="font-size:13px;font-weight:700;margin-bottom:10px">Master Portfolio</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:12px;margin-bottom:10px">
      <div style="text-align:center;padding:8px;background:var(--card);border-radius:8px">
        <div style="font-size:18px;font-weight:700;color:${pnlColor(s.totalPnl)}">${fmtPnl(s.totalPnl)}</div>
        <div style="font-size:10px;color:var(--text3);margin-top:2px">Total P&L</div>
      </div>
      <div style="text-align:center;padding:8px;background:var(--card);border-radius:8px">
        <div style="font-size:18px;font-weight:700">${s.winRate}%</div>
        <div style="font-size:10px;color:var(--text3);margin-top:2px">Win Rate</div>
      </div>
      <div style="text-align:center;padding:8px;background:var(--card);border-radius:8px">
        <div style="font-size:18px;font-weight:700">${s.totalSignals}</div>
        <div style="font-size:10px;color:var(--text3);margin-top:2px">Signals</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px 12px;font-size:11px">
      <div><span style="color:var(--text3)">Open CSPs:</span> <b>${s.openCSPs}</b></div>
      <div><span style="color:var(--text3)">Open CCs:</span> <b>${s.openCCs}</b></div>
      <div><span style="color:var(--text3)">Winners:</span> <b style="color:var(--green)">${s.winners}</b></div>
      <div><span style="color:var(--text3)">Assigned:</span> <b>${s.assigned}</b></div>
      <div><span style="color:var(--text3)">Called Away:</span> <b>${s.called}</b></div>
      <div><span style="color:var(--text3)">Rolled:</span> <b>${s.rolled}</b></div>
      <div><span style="color:var(--text3)">Premium:</span> <b style="color:var(--green)">+$${s.totalPremiumCollected.toFixed(0)}</b></div>
      <div><span style="color:var(--text3)">Wheel P&L:</span> <b style="color:${pnlColor(s.wheelNetPnl)}">${fmtPnl(s.wheelNetPnl)}</b></div>
    </div>`;
}

function renderHome(){
  // Ensure critical DOM elements exist
  const balanceEl = $('balanceVal');
  const posContainer = $('positionsContainer');
  const histContainer = $('historyContainer');

  if (!balanceEl || !posContainer || !histContainer) {
    // DOM not ready, schedule retry
    setTimeout(renderHome, 100);
    return;
  }

  // Render balance (computed from starting balance + all trade PnL)
  const computedBal = getComputedBalance();
  balanceEl.textContent = computedBal.toLocaleString();
  const pendingPrem = (S.positions || []).reduce((s,p) => s + (p.premium||0) * (p.contracts||1) * 100, 0);
  const realizedPnl = (S.history || []).reduce((s,t) => s + (t.pnl || 0), 0);
  const totalChange = pendingPrem + realizedPnl;
  const base = S.startingBalance || 25000;
  const pct = base > 0 ? (totalChange / base * 100).toFixed(1) : 0;
  const changeEl = $('balanceChange');
  if (changeEl) {
    const arrow = totalChange >= 0 ? '↑' : '↓';
    const sign = totalChange >= 0 ? '+' : '';
    changeEl.innerHTML = `<span>${arrow} ${sign}$${Math.abs(totalChange).toFixed(0)} &nbsp;(${pct}%)</span>` +
      (pendingPrem > 0 ? `<span style="font-size:11px;font-weight:500;opacity:0.75">$${realizedPnl.toFixed(0)} realized &nbsp;&middot;&nbsp; $${pendingPrem.toFixed(0)} pending</span>` : '');
    changeEl.style.color = totalChange >= 0 ? 'var(--green)' : 'var(--red)';
    changeEl.style.background = totalChange >= 0 ? 'var(--green-bg)' : 'var(--red-bg,rgba(255,23,68,0.1))';
  }

  // Render user initials
  const init = S.user && S.user.name ? S.user.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0,2) : '?';
  const initEl = $('heroInitials');
  if (initEl) initEl.textContent = init;

  // Show guest banner if guest
  const guestBanner = $('guestBanner');
  if (guestBanner) {
    guestBanner.style.display = S.isGuest ? 'block' : 'none';
  }

  renderAlertsFeed();

  // Show new user banner if no trades and learn progress is empty
  const newBanner = $('newUserBanner');
  if (newBanner) {
    const progress = getLearnProgress();
    const hasProgress = Object.keys(progress).length > 0;
    const hasTrades = (S.positions || []).length > 0 || (S.history || []).length > 0;
    const dismissed = S.newUserDismissed;
    newBanner.style.display = (!hasProgress && !hasTrades && !dismissed) ? 'block' : 'none';
  }

  // Force render positions and history with explicit content
  renderPositions(posContainer);
  renderHistory(histContainer);

  // Income goal progress bar
  renderIncomeGoal();

  // Check achievements silently
  checkAchievements();

  // Check position alerts
  checkPositionAlerts();
}

function renderAlertsFeed() {
  const section = $('alertsFeedSection');
  const container = $('alertsFeedContainer');
  if (!section || !container) return;

  // Show for premium users and admins
  if (!S.isPremium && !isAdmin()) {
    section.style.display = 'none';
    return;
  }

  const posts = S.adminPosts || [];
  if (!posts.length) {
    section.style.display = 'none';
    return;
  }

  section.style.display = 'block';
  // Show recent posts, prioritizing actionable items (open signals, assignments)
  // Exclude orphaned called/winner posts whose wheel was deleted
  const wheels = S.wheelPositions || [];
  const actionable = posts.filter(p => !p.status || p.status === 'open' || p.status === 'assigned' || p.kind === 'announcement' || p.kind === 'roll');
  const completed = posts.filter(p => (p.status === 'called' || p.status === 'winner') && (!p.wheelId || wheels.some(w => w.id === p.wheelId)));
  const recent = [...actionable, ...completed].slice(0, 3);

  container.innerHTML = recent.map(p => {
    if (p.kind === 'signal' && (!p.status || p.status === 'open')) {
      const sid = p.id ? `,'${p.id}'` : '';
      const premVal = p.prem || '';
      return `<div class="pos-card" style="border-left:3px solid var(--${p.type==='csp'?'green':'blue'});padding:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><span class="pos-badge ${p.type}" style="margin-right:8px">${p.type.toUpperCase()}</span><b>${p.ticker}</b> $${p.strike}</div>
          <span style="font-size:11px;color:var(--text3)">${getTimeAgo(p.timestamp)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
          <span style="font-size:13px;color:var(--text2)">Premium: <span style="color:var(--green)">${p.prem}</span> · ${p.exp}</span>
          <button onclick="event.stopPropagation();copyTradeFromSignal('${p.ticker}','${p.type}','${p.strike}','${p.exp}','${premVal}'${sid})" style="font-size:11px;padding:3px 8px;min-width:auto;background:none;border:1px solid var(--border);border-radius:6px;color:var(--blue);cursor:pointer;font-weight:600">+ Copy</button>
        </div>
      </div>`;
    } else if (p.kind === 'announcement') {
      return `<div class="pos-card" style="border-left:3px solid var(--orange);background:var(--orange-bg);padding:14px" onclick="nav('signals')">
        <div style="font-weight:600">${p.title}</div>
        <div style="font-size:13px;color:var(--text2);margin-top:4px">${p.message.slice(0, 80)}${p.message.length > 80 ? '...' : ''}</div>
        <span style="font-size:11px;color:var(--text3)">${getTimeAgo(p.timestamp)}</span>
      </div>`;
    } else if (p.kind === 'roll') {
      return `<div class="pos-card" style="border-left:3px solid var(--purple);padding:14px" onclick="nav('signals')">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span class="pos-badge" style="background:var(--purple-bg);color:var(--purple)">ROLL</span>
          <span style="font-size:11px;color:var(--text3)">${getTimeAgo(p.timestamp)}</span>
        </div>
        <div style="font-size:13px;margin-top:6px">${p.original} → ${p.newPos}</div>
        <div style="font-size:14px;font-weight:600;color:var(--green);margin-top:4px">${p.credit}</div>
      </div>`;
    } else if (p.kind === 'signal' && p.status === 'assigned') {
      const hasCopy = (S.positions || []).find(pos => pos.signalId === p.id);
      const assignBtn = hasCopy && !hasCopy.assigned
        ? `<button onclick="event.stopPropagation();userMarkAssigned('${p.id}')" style="font-size:11px;padding:4px 10px;background:var(--orange);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-top:6px">I was assigned too</button>`
        : hasCopy && hasCopy.assigned
        ? `<span style="font-size:11px;color:var(--orange);font-weight:600;margin-top:6px;display:inline-block">You marked assigned</span>`
        : '';
      return `<div class="pos-card" style="border-left:3px solid var(--orange);padding:14px" onclick="nav('signals')">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span class="pos-badge" style="background:var(--orange-bg,rgba(255,152,0,0.1));color:var(--orange)">ASSIGNED</span>
          <span style="font-size:11px;color:var(--text3)">${getTimeAgo(p.assignedAt || p.timestamp)}</span>
        </div>
        <div style="font-size:14px;font-weight:700;margin-top:6px">${p.ticker} — now holding shares</div>
        <div style="font-size:12px;color:var(--text2);margin-top:2px">CSP $${p.strike} assigned · Selling covered calls</div>
        ${assignBtn}
      </div>`;
    } else if (p.kind === 'signal' && p.status === 'called') {
      const ws = p.wheelSummary;
      const fmtPnl = v => v >= 0 ? `+$${v.toFixed(0)}` : `-$${Math.abs(v).toFixed(0)}`;
      if (ws) {
        return `<div class="pos-card" style="border-left:3px solid ${(ws.finalPnl||0) >= 0 ? 'var(--green)' : 'var(--red)'};padding:14px" onclick="nav('signals')">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span class="pos-badge" style="background:${(ws.finalPnl||0) >= 0 ? 'var(--green-bg)' : 'var(--red-bg,rgba(255,23,68,0.1))'};color:${(ws.finalPnl||0) >= 0 ? 'var(--green)' : 'var(--red)'}">WHEEL COMPLETE</span>
            <span style="font-size:11px;color:var(--text3)">${getTimeAgo(p.closedAt || p.timestamp)}</span>
          </div>
          <div style="font-size:14px;font-weight:700;margin-top:6px">${p.ticker} <span style="font-size:18px;font-weight:800;color:${(ws.finalPnl||0) >= 0 ? 'var(--green)' : 'var(--red)'}">${fmtPnl(ws.finalPnl||0)}</span></div>
          <div style="display:flex;gap:12px;font-size:11px;margin-top:6px;color:var(--text3)">
            <span>Premiums: <b style="color:var(--green)">+$${(ws.totalPremium||0).toFixed(0)}</b></span>
            <span>Stock: <b style="color:${(ws.stockPnl||0) >= 0 ? 'var(--green)' : 'var(--red)'}">${fmtPnl(ws.stockPnl||0)}</b></span>
            <span>${ws.daysHeld||'?'}d · ${ws.ccCount||0} CCs</span>
          </div>
        </div>`;
      }
      return `<div class="pos-card" style="border-left:3px solid var(--blue);padding:14px" onclick="nav('signals')">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span class="pos-badge" style="background:var(--blue-bg,rgba(0,122,255,0.1));color:var(--blue)">CALLED AWAY</span>
          <span style="font-size:11px;color:var(--text3)">${getTimeAgo(p.closedAt || p.timestamp)}</span>
        </div>
        <div style="font-size:14px;font-weight:700;margin-top:6px">${p.ticker} — shares called away</div>
        <div style="font-size:12px;color:var(--text2);margin-top:2px">Wheel complete! Back to selling puts</div>
      </div>`;
    } else if (p.kind === 'signal' && p.status === 'winner') {
      return `<div class="pos-card" style="border-left:3px solid var(--green);padding:14px" onclick="nav('signals')">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span class="pos-badge" style="background:var(--green-bg);color:var(--green)">WIN 🎉</span>
          <span style="font-size:11px;color:var(--text3)">${getTimeAgo(p.closedAt || p.timestamp)}</span>
        </div>
        <div style="font-size:14px;font-weight:700;margin-top:6px">${p.ticker} $${p.strike} ${(p.type||'').toUpperCase()} closed for profit</div>
        <div style="font-size:12px;color:var(--green);margin-top:2px">Premium kept — option expired worthless</div>
      </div>`;
    }
    return '';
  }).join('');
}
function renderPositions(container){
  const c = container || $('positionsContainer');
  if(!c) return; // Guard against null

  const positions = S.positions || [];
  if(!positions.length){
    c.innerHTML='<div class="empty"><div class="empty-icon"><svg viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div><div class="empty-title">No Positions</div><div class="empty-text">Add positions or sync from Alpaca</div><button class="empty-btn" onclick="openAdd()">+ Add Position</button></div>';
    return;
  }
  c.innerHTML=positions.map(p=>{const expD=parseExpDate(p.expiration);const dte=expD?Math.ceil((expD-new Date())/864e5):null;const premCollected=(p.premium||0)*(p.contracts||1)*100;const clr=getTickerColor(p.symbol);const isShares=p.type==='shares';const dteBadge=getPositionAlertBadges(p);const dteValColor=dte!==null&&dte<=0?'color:var(--red)':dte!==null&&dte<=3?'color:var(--red)':dte!==null&&dte<=7?'color:var(--orange)':'';const rollBadge=p.rollCount?` <span style="font-size:10px;background:var(--blue-bg,rgba(59,130,246,0.1));color:var(--blue,#3b82f6);padding:2px 6px;border-radius:4px;font-weight:600">Roll #${p.rollCount}</span>`:'';const rollFrom=p.rolledFromStrike?`<span style="font-size:11px;color:var(--text3)"> · from $${p.rolledFromStrike}</span>`:'';return`<div class="pos-card" onclick="viewPos('${p.id}')"><div class="pos-top"><div class="pos-left"><div class="pos-logo"><span class="pos-logo-text" style="background:${clr}">${p.symbol.slice(0,2)}</span></div><div class="pos-info"><div class="pos-symbol">${p.symbol}${p.strike?' $'+p.strike+(p.type==='csp'?'P':'C'):''}${rollBadge}${dteBadge}</div><div class="pos-name">${names[p.symbol]||p.symbol}${p.expiration?' · Exp '+p.expiration:''}${rollFrom}</div></div></div><span class="pos-badge ${p.type}">${(p.type||'').toUpperCase()}</span></div><div class="pos-stats"><div><div class="pos-stat-val pos">+$${premCollected.toFixed(0)}</div><div class="pos-stat-label">Premium</div></div><div><div class="pos-stat-val">${p.contracts||1}</div><div class="pos-stat-label">${isShares?'Shares':'Contracts'}</div></div><div style="text-align:right"><div class="pos-stat-val" style="${dteValColor}">${dte!==null&&dte>=0?dte:'—'}</div><div class="pos-stat-label">DTE</div></div></div></div>`}).join('');
}
function renderHistory(container){
  const c = container || $('historyContainer');
  if(!c) return; // Guard against null

  const history = S.history || [];
  if(!history.length){
    c.innerHTML='<div style="text-align:center;padding:32px;color:var(--text2);font-size:14px;background:var(--card);border:1px solid var(--border);border-radius:16px">Closed trades appear here</div>';
    return;
  }
  c.innerHTML='<div class="tx-list">'+history.slice(0,10).map((t,i)=>{const rollTag=t.outcome==='rolled'?` <span style="font-size:10px;background:var(--blue-bg,rgba(59,130,246,0.1));color:var(--blue,#3b82f6);padding:1px 5px;border-radius:3px">→ $${t.rolledToStrike||'?'}</span>`:'';const typeLabel=t.type==='wheel'?'W':t.type==='csp'?'P':'C';return`<div class="tx-item" style="position:relative"><div class="tx-icon ${t.type}"><svg viewBox="0 0 24 24">${t.type==='csp'||t.type==='wheel'?'<circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12l4 4 4-4"/>':'<circle cx="12" cy="12" r="10"/><path d="M12 16V8M8 12l4-4 4 4"/>'}</svg></div><div class="tx-info"><div class="tx-title">${t.symbol} $${t.strike||''}${typeLabel}${rollTag}</div><div class="tx-sub">${new Date(t.closeDate||Date.now()).toLocaleDateString()}${t.outcome==='rolled'?' · Rolled':''}${t.outcome==='called_away'?' · Called Away':''}</div></div><div class="tx-amount ${(t.pnl||0)>=0?'pos':'neg'}">${(t.pnl||0)>=0?'+':'-'}$${Math.abs(t.pnl||0).toFixed(0)}</div><button onclick="event.stopPropagation();deleteTrade(${i})" style="position:absolute;top:4px;right:4px;background:none;border:none;color:var(--text3);font-size:10px;cursor:pointer;padding:4px 6px;opacity:0.5">✕</button></div>`}).join('')+'</div>';
}
function deleteTrade(idx) {
  if (!S.history || !S.history[idx]) return;
  const t = S.history[idx];
  showConfirm('Delete Trade', `Remove ${t.symbol} $${t.strike||''}${t.type==='csp'?'P':'C'} from history?`, () => {
    S.history.splice(idx, 1);
    save(); renderHome();
    showToast('Trade deleted', 'success');
  });
}
function viewPos(id){const p=S.positions.find(x=>x.id===id);if(!p)return;S.selPosId=id;$('posTitle').textContent=p.symbol;const rollInfo=p.rollCount?`<div style="background:var(--blue-bg,rgba(59,130,246,0.1));border-radius:8px;padding:8px 12px;margin-bottom:12px;font-size:12px;color:var(--blue,#3b82f6)"><b>Roll #${p.rollCount}</b>${p.rolledFromStrike?' · Rolled from $'+p.rolledFromStrike:''}<br><span style="font-size:11px;opacity:0.8">Total premium across rolls: $${((p.totalPremiumCollected||0)*(p.contracts||1)*100).toFixed(0)}</span></div>`:'';$('posContent').innerHTML=rollInfo+`<div class="stats-grid"><div class="stat-box"><div class="stat-val">${p.type.toUpperCase()}</div><div class="stat-label">Type</div></div><div class="stat-box"><div class="stat-val">${p.contracts||1}</div><div class="stat-label">Contracts</div></div>${p.strike?`<div class="stat-box"><div class="stat-val">$${p.strike}</div><div class="stat-label">Strike</div></div>`:''}<div class="stat-box"><div class="stat-val green">$${((p.premium||0)*(p.contracts||1)*100).toFixed(0)}</div><div class="stat-label">Premium</div></div></div>`;openModal('posModal')}
function removePosition(){
  if(!S.selPosId)return;
  S.positions=S.positions.filter(x=>x.id!==S.selPosId);
  save();closeModal('posModal');renderHome();
  showToast('Position removed (balance unchanged)','');
}
function closePosition(){
  if(!S.selPosId)return;
  const p=S.positions.find(x=>x.id===S.selPosId);
  if(!p)return;

  if(p.type==='shares'){
    // Shares: just remove
    S.positions=S.positions.filter(x=>x.id!==S.selPosId);
    save();closeModal('posModal');renderHome();
    return;
  }

  // Calculate fees: fee on open + fee on close = 2 legs
  const contracts = p.contracts || 1;
  const fee = (S.feePerContract || 0) * contracts;
  const totalFees = (p.fees || 0) + fee; // open fee + close fee

  // Options: ask if expired worthless (full profit) or closed early
  showConfirm('Close Position', 'Did this option expire worthless (full profit)?', () => {
    // Expired worthless = keep all premium minus fees
    const grossPnl = (p.premium||0) * contracts * 100;
    const pnl = grossPnl - totalFees;
    S.history.unshift({...p,closeDate:new Date().toISOString(),pnl:pnl,grossPnl:grossPnl,fees:totalFees,outcome:'expired'});
    S.positions=S.positions.filter(x=>x.id!==S.selPosId);
    save();closeModal('posModal');renderHome();
    const feeStr = totalFees > 0 ? ` (fees: -$${totalFees.toFixed(2)})` : '';
    showToast(`Position closed for +$${pnl.toFixed(0)}${feeStr}`,'success');
  });

  // Override cancel button to offer "Closed Early" option
  const cancelBtn=$('confirmModal').querySelector('.btn-outline');
  if(cancelBtn){
    cancelBtn.textContent='Closed Early';
    cancelBtn.onclick=()=>{
      closeModal('confirmModal');
      showPrompt('Close Price','What did you close for? (per share, e.g. 0.50)',(val)=>{
        const closePrice=parseFloat(val)||0;
        const openPrem=(p.premium||0);
        const grossPnl=(openPrem-closePrice)*contracts*100;
        const pnl=grossPnl-totalFees;
        S.history.unshift({...p,closeDate:new Date().toISOString(),pnl:pnl,grossPnl:grossPnl,closePrice:closePrice,fees:totalFees,outcome:'closed'});
        S.positions=S.positions.filter(x=>x.id!==S.selPosId);
        save();closeModal('posModal');renderHome();
        const feeStr = totalFees > 0 ? ` (fees: -$${totalFees.toFixed(2)})` : '';
        showToast(`Position closed for ${pnl>=0?'+':''}$${pnl.toFixed(0)}${feeStr}`,(pnl>=0?'success':'error'));
      });
    };
  }
}
async function syncPositions(){if(!S.apiKey)return showToast('Add API keys in settings first','error');try{$('statusPill').className='status live';$('statusText').textContent='Syncing...';const r=await fetch('https://paper-api.alpaca.markets/v2/positions',{headers:{'APCA-API-KEY-ID':S.apiKey,'APCA-API-SECRET-KEY':S.secretKey}});if(!r.ok)throw new Error('Failed');const pos=await r.json();pos.forEach(p=>{if(!S.positions.find(x=>x.symbol===p.symbol)){S.positions.push({id:Date.now().toString()+Math.random(),symbol:p.symbol,type:'shares',contracts:parseInt(p.qty),costBasis:parseFloat(p.avg_entry_price),synced:true,openDate:new Date().toISOString()})}});const ar=await fetch('https://paper-api.alpaca.markets/v2/account',{headers:{'APCA-API-KEY-ID':S.apiKey,'APCA-API-SECRET-KEY':S.secretKey}});if(ar.ok){const a=await ar.json();S.accSize=parseFloat(a.equity)||S.accSize}save();$('statusPill').className='status live';$('statusText').textContent='Live';renderHome()}catch(e){$('statusPill').className='status';$('statusText').textContent='Error';showToast('Sync failed','error')}}
function setAddMode(m){S.addMode=m;$('addCspBtn').classList.toggle('active',m==='csp');$('addCcBtn').classList.toggle('active',m==='cc');$('addSharesBtn').classList.toggle('active',m==='shares');if(m==='shares'){hide('optFields');show('shareFields');$('addChainPicker').style.display='none'}else{show('optFields');hide('shareFields')}}
// --- Smart Add Position ---
let addChainData = null;
let addSelectedChainOption = null;

function quickAddTicker(sym) {
  $('addSymbol').value = sym;
  document.querySelectorAll('#addModal .chip-btn').forEach(b => b.classList.toggle('active', b.textContent === sym));
  loadAddChainBtn();
}

function loadAddChainBtn() {
  const sym = $('addSymbol').value.trim().toUpperCase();
  if (!sym) { showToast('Type a ticker first', 'error'); return; }
  loadAddChain(sym);
}

async function loadAddChain(sym) {
  const priceEl = $('addTickerPrice');
  const pickerEl = $('addChainPicker');
  const btn = $('addLoadChainBtn');

  priceEl.textContent = 'Loading ' + sym + '...';
  priceEl.style.color = 'var(--text3)';
  if (btn) { btn.disabled = true; btn.textContent = 'Loading...'; }

  try {
    const quote = await fetchLiveQuote(sym);
    if (quote) {
      const color = quote.change >= 0 ? 'var(--green)' : 'var(--red)';
      priceEl.innerHTML = `<b>${sym}</b> $${quote.price.toFixed(2)} <span style="color:${color}">${quote.change >= 0?'+':''}${quote.change.toFixed(2)} (${quote.changePercent}%)</span>`;
    } else {
      priceEl.innerHTML = `<span style="color:var(--red)">Could not fetch price for ${sym}</span>`;
    }
  } catch(e) {
    priceEl.innerHTML = `<span style="color:var(--red)">Price fetch failed</span>`;
  }

  if (btn) { btn.disabled = false; btn.textContent = 'Load Chain'; }

  // Load options chain
  if (S.addMode === 'shares') return;
  try {
    const chain = await fetchOptionsChain(sym);
    if (!chain || (!chain.puts.length && !chain.calls.length)) {
      pickerEl.style.display = 'none';
      priceEl.innerHTML += ' <span style="color:var(--orange)">· No options chain found — use manual entry below</span>';
      return;
    }
    addChainData = chain;
    pickerEl.style.display = 'block';

    if (chain.estimated) {
      priceEl.innerHTML += ' <span style="color:var(--orange)">· Estimated chain (live data unavailable)</span>';
    }

    // Render expiration tabs
    const expsEl = $('addChainExps');
    const exps = (chain.expirations || []).slice(0, 8);
    expsEl.innerHTML = exps.map((exp, i) => {
      const label = formatExpDate(exp);
      const dte = calcDTE(exp);
      return `<button class="chain-exp-btn${i===0?' active':''}" onclick="selectAddExp(${exp},this)">${label} <span style="opacity:0.6">(${dte}d)</span></button>`;
    }).join('');

    // Render strikes for first expiration
    renderAddChainStrikes(chain);
  } catch(e) {
    pickerEl.style.display = 'none';
    priceEl.innerHTML += ' <span style="color:var(--orange)">· Chain load failed — use manual entry</span>';
  }
}

function selectAddExp(expTs, btn) {
  // Update active button
  $('addChainExps').querySelectorAll('.chain-exp-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  const sym = $('addSymbol').value.trim().toUpperCase();
  fetchOptionsChain(sym, expTs).then(chain => {
    if (chain) {
      addChainData = chain;
      renderAddChainStrikes(chain);
    }
  });
}

function renderAddChainStrikes(chain) {
  const isCsp = S.addMode === 'csp';
  const options = isCsp ? (chain.puts || []) : (chain.calls || []);
  const price = chain.price || 0;
  const strikesEl = $('addChainStrikes');

  // Show 40 closest strikes (ITM + OTM, include $0 bid deep OTM)
  const nearMoney = options
    .sort((a, b) => Math.abs(a.strike - price) - Math.abs(b.strike - price))
    .slice(0, 50)
    .sort((a,b) => b.strike - a.strike);

  if (nearMoney.length === 0) {
    strikesEl.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text3);font-size:13px">No options found near current price</div>';
    return;
  }

  strikesEl.innerHTML = `
    <div class="chain-row" style="background:var(--input);font-size:11px;font-weight:600;color:var(--text3);cursor:default">
      <div style="flex:1">Strike</div>
      <div style="width:70px;text-align:right">Bid</div>
      <div style="width:70px;text-align:right">Ask</div>
      <div style="width:50px;text-align:right">Delta</div>
      <div style="width:50px;text-align:right">IV</div>
    </div>
  ` + nearMoney.map(o => {
    const bid = (o.bid || 0).toFixed(2);
    const ask = (o.ask || 0).toFixed(2);
    const mid = ((o.bid + o.ask) / 2).toFixed(2);
    const delta = o.delta ? Math.abs(o.delta).toFixed(2) : (o.impliedVolatility ? '—' : '—');
    const iv = o.impliedVolatility ? (o.impliedVolatility * 100).toFixed(0) + '%' : '—';
    const otm = isCsp ? o.strike < price : o.strike > price;
    const atm = Math.abs(o.strike - price) / price < 0.01;
    return `<div class="chain-row" onclick="selectChainOption(${o.strike},${o.bid||0},${o.ask||0},'${o.expiration||''}',${o.delta||0},${o.impliedVolatility||0})" data-strike="${o.strike}">
      <div style="flex:1;font-weight:600;${atm?'color:var(--blue)':otm?'':'color:var(--red)'}">$${o.strike}${atm?' ◄':''}</div>
      <div style="width:70px;text-align:right;color:var(--green)">${bid}</div>
      <div style="width:70px;text-align:right">${ask}</div>
      <div style="width:50px;text-align:right;font-size:12px">${delta}</div>
      <div style="width:50px;text-align:right;font-size:12px">${iv}</div>
    </div>`;
  }).join('');
}

function selectChainOption(strike, bid, ask, expiration, delta, iv) {
  const mid = ((bid + ask) / 2);
  addSelectedChainOption = { strike, bid, ask, mid, expiration, delta, iv };

  // Highlight selected row
  $('addChainStrikes').querySelectorAll('.chain-row').forEach(r => r.classList.remove('selected'));
  const row = $('addChainStrikes').querySelector(`[data-strike="${strike}"]`);
  if (row) row.classList.add('selected');

  // Fill manual fields too (so they're in sync)
  $('addStrike').value = strike;
  $('addPremium').value = mid.toFixed(2);
  // Fill expiration from active tab
  const activeExpBtn = $('addChainExps')?.querySelector('.chain-exp-btn.active');
  if (activeExpBtn) {
    const expText = activeExpBtn.textContent.trim().split('(')[0].trim();
    // Try to set date input if possible
    $('addExp').value = expText;
  }

  // Show summary
  const sym = $('addSymbol').value.trim().toUpperCase();
  const isCsp = S.addMode === 'csp';
  $('addSelectedSummary').style.display = 'block';
  $('addSummaryText').textContent = `${sym} $${strike} ${isCsp?'Put':'Call'} · Premium $${mid.toFixed(2)} · ${delta ? 'Δ' + Math.abs(delta).toFixed(2) : ''}`;
}

function savePosition(){
  const sym=$('addSymbol').value.trim().toUpperCase();
  if(!sym)return showToast('Enter symbol','error');
  const numContracts = parseInt($('addContracts').value)||1;
  const openFee = (S.feePerContract || 0) * numContracts;
  const p={id:Date.now().toString(),symbol:sym,type:S.addMode,contracts:numContracts,openDate:new Date().toISOString(),fees:openFee};
  if(S.addMode==='shares') {
    p.costBasis=parseFloat($('addCost').value)||0;
  } else {
    // Use chain selection if available, otherwise use manual fields
    p.strike=parseFloat($('addStrike').value)||0;
    p.expiration=$('addExp').value;
    p.premium=parseFloat($('addPremium').value)||0;
    // Chain selection auto-fills these fields, so they'll have values either way
    if(!p.strike)return showToast('Select a strike price','error');
  }
  S.positions.push(p);save();
  closeModal('addModal');
  // Reset state
  addSelectedChainOption = null;
  addChainData = null;
  $('addSelectedSummary').style.display = 'none';
  $('addChainPicker').style.display = 'none';
  $('addTickerPrice').textContent = '';
  renderHome();
  showToast(`Added ${sym} ${p.strike?'$'+p.strike:''}${S.addMode==='csp'?'P':S.addMode==='cc'?'C':''} to portfolio!`,'success');
}

// Copy trade from signal to portfolio
function copyTradeFromSignal(ticker, type, strike, exp, prem, signalId) {
  try {
    const premVal = parseFloat((prem||'').replace('$','')) || 0;
    const bal = getComputedBalance();
    const maxContracts = Math.floor(bal / (parseFloat(strike) * 100)) || 1;
    showPrompt(`Your fill premium? (signal: $${premVal.toFixed(2)})`, premVal.toFixed(2), (premInput) => {
      const myPrem = parseFloat(premInput) || premVal;
      showPrompt(`How many contracts? (max ~${maxContracts})`, '1', (val) => {
        try {
          const contracts = Math.max(1, parseInt(val) || 1);
          const fee = (S.feePerContract || 0) * contracts;
          if (!S.positions) S.positions = [];
          const p = {
            id: Date.now().toString(),
            symbol: ticker,
            type: type,
            strike: parseFloat(strike) || 0,
            expiration: exp,
            premium: myPrem,
            contracts: contracts,
            openDate: new Date().toISOString(),
            fromSignal: true,
            signalId: signalId || null,
            fees: fee
          };
          S.positions.push(p);
          save();
          // Force render - don't rely on nav()
          renderHome();
          const totalPrem = (myPrem * contracts * 100).toFixed(0);
          const feeStr = fee > 0 ? ` (fees: $${fee.toFixed(2)})` : '';
          showToast(`Added ${contracts}x ${ticker} $${strike}${type==='csp'?'P':'C'} · $${totalPrem} premium${feeStr}`, 'success');
        } catch(e) {
          alert('Copy trade error: ' + e.message);
          console.error(e);
        }
      });
    });
  } catch(e) {
    alert('Copy trade error: ' + e.message);
    console.error(e);
  }
}
function userMarkAssigned(signalId) {
  const pos = (S.positions || []).find(p => p.signalId === signalId);
  if (!pos) return showToast('No copied position found for this signal', 'error');
  const signal = (S.adminPosts || []).find(p => p.id === signalId);
  const strike = signal ? signal.strike : pos.strike;
  const ticker = pos.symbol;

  showPrompt(`${ticker} assigned at $${strike}. Your assignment price?`, strike.toString(), (priceStr) => {
    const assignPrice = parseFloat(priceStr);
    if (!assignPrice || assignPrice <= 0) return showToast('Enter a valid price', 'error');
    const shares = (pos.contracts || 1) * 100;
    const premPerShare = pos.premium || 0;
    const totalPremDollars = premPerShare * 100 * (pos.contracts || 1);

    // Mark position as assigned
    pos.assigned = true;
    pos.assignedAt = Date.now();
    pos.assignPrice = assignPrice;
    pos.assignShares = shares;

    // Create user wheel position
    if (!S.wheelPositions) S.wheelPositions = [];
    S.wheelPositions.push({
      id: Date.now().toString(),
      symbol: ticker,
      shares: shares,
      contracts: pos.contracts || 1,
      assignPrice: strike,
      currentPrice: assignPrice,
      cspPremium: premPerShare,
      costBasis: strike,
      originalCostBasis: strike,
      assignedAt: Date.now(),
      cspSignalId: signalId,
      status: 'holding',
      ccHistory: [],
      totalPremiumCollected: totalPremDollars,
      userWheel: true
    });

    save();
    renderHome();
    renderSignals();
    renderAlertsFeed();
    const stockPnl = (assignPrice - strike) * shares;
    const netPnl = stockPnl + totalPremDollars;
    const fmtPnl = (v) => v >= 0 ? `+$${v.toFixed(0)}` : `-$${Math.abs(v).toFixed(0)}`;
    showToast(`Marked assigned! ${shares} shares of ${ticker} at $${strike} · Stock: ${fmtPnl(stockPnl)} · Premium: +$${totalPremDollars.toFixed(0)} · Net: ${fmtPnl(netPnl)}`, '');
  });
}

function setMode(m){S.mode=m;$('cspBtn').classList.toggle('active',m==='csp');$('ccBtn').classList.toggle('active',m==='cc');
  // Reload options if we have a current ticker
  if(currentTicker && currentChain) loadOptionsChain(currentTicker);
}

function addFromCalc() {
  if (!currentTicker || !selectedOption) return showToast('Select an option first','error');

  const expDate = selectedExp ? new Date(selectedExp * 1000) : new Date(Date.now() + selectedOption.dte * 86400000);

  const p = {
    id: Date.now().toString(),
    symbol: currentTicker,
    type: S.mode,
    strike: selectedOption.strike,
    premium: selectedOption.premium,
    contracts: selectedOption.contracts,
    expiration: expDate.toISOString().split('T')[0],
    openDate: new Date().toISOString()
  };

  S.positions.push(p);
  save();
  nav('home');
  showToast(`Added ${currentTicker} $${selectedOption.strike}${S.mode==='csp'?'P':'C'} to portfolio!`,'success');
}

function qSearch(s){$('tickerInput').value=s;searchTicker()}
// Current ticker state for options chain
let currentTicker = null;
let currentChain = null;
let selectedExp = null;
let selectedOption = null;

async function searchTicker(){
  const t=$('tickerInput').value.trim().toUpperCase();
  if(!t)return;

  hide('emptyCalc');
  hide('stockCard');
  hide('optCard');
  hide('resultCard');
  show('loadingCard');

  try {
    // Fetch live quote (no API key needed!)
    const quote = await fetchLiveQuote(t);
    if (!quote) throw new Error('Symbol not found');

    currentTicker = t;
    $('stockSymbol').textContent = t;
    $('stockName').textContent = names[t] || t;
    $('stockPrice').textContent = quote.price.toFixed(2);

    // Add price change display
    const priceEl = $('stockPrice').parentElement;
    let changeEl = priceEl.querySelector('.price-change');
    if (!changeEl) {
      changeEl = document.createElement('div');
      changeEl.className = 'price-change';
      changeEl.style.cssText = 'font-size:14px;margin-top:4px;font-weight:600';
      priceEl.appendChild(changeEl);
    }
    changeEl.style.color = quote.change >= 0 ? 'var(--green)' : 'var(--red)';
    changeEl.textContent = `${quote.change >= 0 ? '+' : ''}${quote.change.toFixed(2)} (${quote.changePercent}%)`;

    hide('loadingCard');
    show('stockCard');

    // Fetch options chain
    await loadOptionsChain(t);

    $('statusPill').className='status live';
    $('statusText').textContent='Live Data';

  } catch(e) {
    hide('loadingCard');
    show('emptyCalc');
    showToast('Could not find: ' + t,'error');
  }
}

async function loadOptionsChain(symbol) {
  show('loadingCard');
  hide('resultCard');

  // Reset optCard to original structure
  $('optCard').innerHTML = `<div class="card-title">Select Contract</div>
    <div class="form-group"><label class="form-label">Expiration</label>
    <select class="form-select" id="expSelect" onchange="onExpChange()"><option>Loading...</option></select></div>
    <div class="form-group"><label class="form-label">Strike · Premium · Delta · OTM%</label>
    <select class="form-select" id="strikeSelect" onchange="onStrikeChange()"><option>Select expiration first...</option></select></div>`;

  try {
    const chain = await fetchOptionsChain(symbol);
    if (!chain || !chain.expirations?.length) {
      hide('loadingCard');
      // Show manual entry if no options available
      showManualEntry();
      return;
    }

    currentChain = chain;

    // Populate expiration dropdown
    const expSelect = $('expSelect');
    expSelect.innerHTML = '<option value="">Select expiration...</option>' +
      chain.expirations.slice(0, 12).map(exp => {
        const dte = calcDTE(exp);
        const label = formatExpDate(exp);
        const dteLabel = dte === 1 ? '1 day' : `${dte} days`;
        return `<option value="${exp}">${label} (${dteLabel})</option>`;
      }).join('');

    hide('loadingCard');
    show('optCard');

    // Reset strike select
    $('strikeSelect').innerHTML = '<option value="">Select strike...</option>';

  } catch(e) {
    hide('loadingCard');
    showManualEntry();
  }
}

function showManualEntry() {
  // Show manual premium entry for tickers without options data
  $('optCard').innerHTML = `
    <div class="card-title">Enter Contract Details</div>
    <div class="form-group">
      <label class="form-label">Strike Price</label>
      <input type="number" class="form-input" id="manualStrike" placeholder="150.00" step="0.5">
    </div>
    <div class="form-group">
      <label class="form-label">Premium (per share)</label>
      <input type="number" class="form-input" id="manualPremium" placeholder="2.50" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Days to Expiration</label>
      <input type="number" class="form-input" id="manualDTE" placeholder="30" value="30">
    </div>
    <button class="btn btn-outline" onclick="calcManualOption()">Calculate</button>
  `;
  show('optCard');
}

function calcManualOption() {
  const strike = parseFloat($('manualStrike')?.value) || 0;
  const premium = parseFloat($('manualPremium')?.value) || 0;
  const dte = parseInt($('manualDTE')?.value) || 30;

  if (!strike || !premium) return showToast('Enter strike and premium','error');

  const bal = getComputedBalance();
  const maxContracts = Math.floor(bal / (strike * 100)) || 1;

  selectedOption = { strike, premium, dte, maxContracts };
  $('resConInput').value = 1;
  $('resAnn').textContent = ((premium / strike) * (365 / dte) * 100).toFixed(1);
  $('resProb').textContent = '~75';
  updateCalcResults();
  show('resultCard');
}

async function onExpChange() {
  const expSelect = $('expSelect');
  const exp = parseInt(expSelect.value);
  if (!exp || !currentChain) return;

  selectedExp = exp;

  // Fetch options for this expiration
  show('loadingCard');
  const chain = await fetchOptionsChain(currentTicker, exp);
  hide('loadingCard');

  if (!chain) return;
  currentChain = chain;

  // Get relevant options based on mode
  const options = S.mode === 'csp' ? chain.puts : chain.calls;
  const price = chain.price || parseFloat($('stockPrice').textContent);

  // Find ATM, OTM, and some ITM strikes (25 total)
  const strikes = options
    .filter(o => o.bid > 0 || o.lastPrice > 0)
    .sort((a, b) => Math.abs(a.strike - price) - Math.abs(b.strike - price))
    .slice(0, 25)
    .sort((a, b) => S.mode === 'csp' ? b.strike - a.strike : a.strike - b.strike);

  const strikeSelect = $('strikeSelect');
  strikeSelect.innerHTML = '<option value="">Select strike...</option>' +
    strikes.map(o => {
      const delta = o.delta ? Math.abs(o.delta).toFixed(2) : '—';
      const prem = ((o.bid + o.ask) / 2).toFixed(2);
      const otmPct = ((Math.abs(price - o.strike) / price) * 100).toFixed(1);
      const iv = o.impliedVolatility ? (o.impliedVolatility * 100).toFixed(0) + '%' : '';
      return `<option value="${o.strike}" data-premium="${prem}" data-delta="${delta}" data-dte="${calcDTE(selectedExp)}" data-iv="${o.impliedVolatility||0}">$${o.strike} · $${prem} · Δ${delta} · ${otmPct}% OTM${iv?' · IV '+iv:''}</option>`;
    }).join('');
}

function onStrikeChange() {
  const strikeSelect = $('strikeSelect');
  const opt = strikeSelect.options[strikeSelect.selectedIndex];
  if (!opt || !opt.value) return;

  const strike = parseFloat(opt.value);
  const premium = parseFloat(opt.dataset.premium) || 0;
  const delta = parseFloat(opt.dataset.delta) || 0.25;
  const dte = parseInt(opt.dataset.dte) || 30;
  const iv = parseFloat(opt.dataset.iv) || 0;

  const bal = getComputedBalance();
  const maxContracts = Math.floor(bal / (strike * 100)) || 1;
  const probProfit = delta ? Math.round((1 - Math.abs(delta)) * 100) : 75;

  selectedOption = { strike, premium, dte, maxContracts, delta };
  $('resConInput').value = 1;
  $('resAnn').textContent = ((premium / strike) * (365 / dte) * 100).toFixed(1);
  $('resProb').textContent = probProfit;
  updateCalcResults();

  // Show IV if available
  let ivEl = document.getElementById('resIvRow');
  if (iv > 0) {
    if (!ivEl) {
      const grid = $('resultCard').querySelector('.stats-grid');
      const ivBox = document.createElement('div');
      ivBox.className = 'stat-box';
      ivBox.id = 'resIvRow';
      ivBox.innerHTML = `<div class="stat-val" style="color:var(--orange)"><span id="resIV">0</span>%</div><div class="stat-label">Implied Vol</div>`;
      grid.appendChild(ivBox);
    }
    const ivSpan = document.getElementById('resIV');
    if (ivSpan) ivSpan.textContent = (iv * 100).toFixed(0);
  }

  show('resultCard');
}
function adjustContracts(delta) {
  const input = $('resConInput');
  const val = Math.max(1, (parseInt(input.value) || 1) + delta);
  input.value = val;
  $('resConDisplay').textContent = val;
  updateCalcResults();
}
function updateCalcResults() {
  if (!selectedOption) return;
  const {strike, premium, maxContracts} = selectedOption;
  const contracts = Math.max(1, parseInt($('resConInput')?.value) || 1);
  $('resConDisplay').textContent = contracts;
  const isCsp = S.mode === 'csp';
  const cashPerContract = strike * 100;
  const premPerContract = premium * 100;
  const totalCash = cashPerContract * contracts;
  const totalPrem = premPerContract * contracts;
  const netCash = totalCash - totalPrem;
  const totalShares = contracts * 100;

  $('resTitle').textContent = isCsp ? 'Cash Secured Put' : 'Covered Call';

  // Beginner-friendly explanation
  const expl = $('resExplainer');
  if (expl) {
    if (isCsp) {
      expl.innerHTML = `You're <b>selling ${contracts} put${contracts>1?'s':''}</b> at the <b>$${strike} strike</b>. Your broker holds <b>$${totalCash.toLocaleString()}</b> as collateral, but you collect <b>$${totalPrem.toFixed(0)}</b> in premium upfront. If the stock stays above $${strike} by expiration, you keep all the premium as profit.`;
    } else {
      expl.innerHTML = `You're <b>selling ${contracts} call${contracts>1?'s':''}</b> at the <b>$${strike} strike</b>. You need <b>${totalShares.toLocaleString()} shares</b>. You collect <b>$${totalPrem.toFixed(0)}</b> in premium upfront. If the stock stays below $${strike}, you keep your shares + the premium.`;
    }
  }

  // Per contract note
  const perC = $('resPerContract');
  if (perC) perC.textContent = contracts > 1 ? `$${premPerContract.toFixed(0)} premium × ${contracts} contracts` : '1 contract = 100 shares';

  $('resCashLabel').textContent = isCsp ? 'Cash to Secure' : 'Shares Needed';
  $('resCashVal').textContent = isCsp ? '$' + totalCash.toLocaleString() : totalShares.toLocaleString() + ' shares';
  const cashExp = $('resCashExplain');
  if (cashExp) cashExp.textContent = isCsp ? `$${strike} strike × 100 shares × ${contracts} contract${contracts>1?'s':''}` : `100 shares per contract × ${contracts}`;

  $('resPremVal').textContent = '+$' + totalPrem.toFixed(0);
  const premExp = $('resPremExplain');
  if (premExp) premExp.textContent = `$${premium.toFixed(2)}/share × 100 × ${contracts} = yours to keep`;

  const netLabel = $('resNetLabel');
  if (netLabel) netLabel.textContent = isCsp ? 'Net Capital Needed' : 'Stock Value Needed';
  $('resNetVal').textContent = '$' + (isCsp ? netCash : totalCash).toLocaleString();
  const netExp = $('resNetExplain');
  if (netExp) netExp.textContent = isCsp ? `$${totalCash.toLocaleString()} − $${totalPrem.toFixed(0)} premium` : 'Must own shares to sell covered calls';

  $('resMax').textContent = maxContracts;
  $('resMaxLabel').textContent = isCsp ? 'Max w/ Balance' : 'Max Contracts';
  show('resultCard');
}
async function renderWatch(){
  const c=$('watchContainer');
  const watchlist = S.watchlist || ['AAPL','NVDA','TSLA','SPY','AMD','MSFT'];

  // Show loading state
  c.innerHTML='<div class="tx-list">'+watchlist.map(sym=>{const clr=getTickerColor(sym);return`<div class="tx-item" id="watch-${sym}"><div class="pos-logo"><img src="${logo(sym)}" onerror="this.outerHTML='<span class=pos-logo-text style=background:${clr}>${sym.slice(0,2)}</span>'"></div><div class="tx-info"><div class="tx-title">${sym}</div><div class="tx-sub">${names[sym]||sym}</div></div><div style="text-align:right"><div style="font-size:15px;font-weight:700;color:var(--text3)">Loading...</div><div style="font-size:12px;color:var(--text3)">—</div></div></div>`}).join('')+'</div><button class="btn btn-outline mt-4" onclick="openAddWatch()">+ Add to Watchlist</button>';

  // Fetch live prices — update each item as it resolves (no waiting for all)
  const resolved = new Set();
  watchlist.forEach(async (sym) => {
    try {
      const q = await fetchLiveQuote(sym);
      resolved.add(sym);
      const el = $(`watch-${sym}`);
      if (!el) return;
      const chg = q ? (parseFloat(q.changePercent) || 0) : 0;
      const chgColor = chg >= 0 ? 'var(--green)' : 'var(--red)';
      const chgSign = chg >= 0 ? '+' : '';
      const clr = getTickerColor(sym);
      if (q) {
        el.innerHTML = `<div class="pos-logo" style="cursor:pointer" onclick="qSearch('${sym}');nav('calc')"><img src="${logo(sym)}" onerror="this.outerHTML='<span class=pos-logo-text style=background:${clr}>${sym.slice(0,2)}</span>'"></div><div class="tx-info" style="cursor:pointer" onclick="qSearch('${sym}');nav('calc')"><div class="tx-title">${sym} <span class="live-dot" style="width:6px;height:6px"></span></div><div class="tx-sub">${names[sym]||sym}</div></div><div style="text-align:right;cursor:pointer" onclick="qSearch('${sym}');nav('calc')"><div style="font-size:15px;font-weight:700">$${q.price.toFixed(2)}</div><div style="font-size:12px;color:${chgColor}">${chgSign}${chg.toFixed(2)}%</div></div><button style="background:none;border:none;padding:8px;cursor:pointer;color:var(--text3)" onclick="event.stopPropagation();removeFromWatch('${sym}')">×</button>`;
      } else {
        el.innerHTML = `<div class="pos-logo"><img src="${logo(sym)}" onerror="this.outerHTML='<span class=pos-logo-text style=background:${clr}>${sym.slice(0,2)}</span>'"></div><div class="tx-info"><div class="tx-title">${sym}</div><div class="tx-sub">${names[sym]||sym}</div></div><div style="text-align:right"><div style="font-size:13px;color:var(--text3)">Unavailable</div></div><button style="background:none;border:none;padding:8px;cursor:pointer;color:var(--text3)" onclick="removeFromWatch('${sym}')">×</button>`;
      }
    } catch(e) { console.warn('Watch quote error:', sym, e); resolved.add(sym); }
  });

  // Safety timeout: mark any still-loading tickers as unavailable after 12s
  setTimeout(() => {
    watchlist.forEach(sym => {
      if (resolved.has(sym)) return;
      const el = $(`watch-${sym}`);
      if (!el) return;
      const clr = getTickerColor(sym);
      el.innerHTML = `<div class="pos-logo"><img src="${logo(sym)}" onerror="this.outerHTML='<span class=pos-logo-text style=background:${clr}>${sym.slice(0,2)}</span>'"></div><div class="tx-info"><div class="tx-title">${sym}</div><div class="tx-sub">${names[sym]||sym}</div></div><div style="text-align:right"><div style="font-size:13px;color:var(--text3)">Unavailable</div></div><button style="background:none;border:none;padding:8px;cursor:pointer;color:var(--text3)" onclick="removeFromWatch('${sym}')">×</button>`;
    });
  }, 12000);

  // Update status to show live data is working
  $('statusPill').className='status live';
  $('statusText').textContent='Live Data';

}

function removeFromWatch(sym) {
  S.watchlist = (S.watchlist || []).filter(s => s !== sym);
  save();
  renderWatch();
}

function openAddWatch() {
  showPrompt('Add to Watchlist', 'AAPL', (sym) => {
    const ticker = sym.toUpperCase().trim();
    if (!S.watchlist) S.watchlist = ['AAPL','NVDA','TSLA','SPY'];
    if (!S.watchlist.includes(ticker)) {
      S.watchlist.push(ticker);
      save();
      renderWatch();
      showToast(`${ticker} added to watchlist`, 'success');
    } else {
      showToast(`${ticker} already in watchlist`, '');
    }
  });
}

async function refreshWatch(){
  // Clear cache for fresh data
  Object.keys(priceCache).forEach(k => delete priceCache[k]);
  renderWatch();
}
function renderAlerts(){const c=$('alertsContainer');const alerts=[];S.positions.forEach(p=>{if(!p.expiration)return;const expD=parseExpDate(p.expiration);if(!expD)return;const dte=Math.ceil((expD-new Date())/864e5);if(dte<=7&&dte>0)alerts.push({...p,dte,urgent:dte<=3})});if(!alerts.length){c.innerHTML='<div class="empty"><div class="empty-icon"><svg viewBox="0 0 24 24"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/></svg></div><div class="empty-title">No Alerts</div><div class="empty-text">Alerts appear when positions expire soon</div></div>';return}c.innerHTML=alerts.map(a=>`<div class="pos-card" style="border-left:3px solid ${a.urgent?'var(--red)':'var(--orange)'}"><div style="font-weight:600">${a.symbol} $${a.strike}${a.type==='csp'?'P':'C'}</div><div style="font-size:13px;color:var(--text2);margin-top:4px">${a.dte} days remaining</div></div>`).join('')}
function renderSignals(){
  const c=$('signalsContainer');
  const posts = S.adminPosts || [];
  const disclaimer = $('exampleDisclaimer');

  // NON-PREMIUM (and not admin): Show only examples
  if (!S.isPremium && !isAdmin()) {
    if (disclaimer) disclaimer.style.display = 'block';

    let html = '<div class="card-title" style="margin:16px 0 12px">Example Signals</div>';
    signals.forEach((s, i) => {
      const locked = i > 0;
      html += `<div class="signal-card ${locked?'locked':''}" style="border-left:3px solid var(--${s.type==='csp'?'green':'blue'})"><div class="signal-header"><span class="signal-type ${s.type}">${s.type.toUpperCase()}</span><span class="signal-time">${s.time}</span></div><div class="signal-ticker">${s.ticker}</div><div class="signal-details">$${s.strike} ${s.type==='csp'?'Put':'Call'} · Exp ${s.exp}</div><div style="display:flex;gap:16px;font-size:13px"><span>Premium: <b style="color:var(--green)">${s.prem}</b></span><span>Delta: <b>${s.delta}</b></span></div>${locked?`<div class="signal-lock"><svg viewBox="0 0 24 24" fill="none" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg><span>Unlock with Premium</span></div>`:''}</div>`;
    });
    html += '<button class="btn mt-4" onclick="openPremium()">Unlock Live Signals</button>';
    c.innerHTML = html;
    return;
  }

  // PREMIUM: Show real signals
  if (disclaimer) disclaimer.style.display = 'none';

  // Separate by type
  const sigs = posts.filter(p => p.kind === 'signal');
  const anns = posts.filter(p => p.kind === 'announcement');
  const rolls = posts.filter(p => p.kind === 'roll');

  // Separate open vs closed positions
  // "assigned" signals are NOT closed — they're active wheel positions shown in Assigned Shares section
  // Also exclude CC posts whose linked wheel is already completed
  const openSigs = sigs.filter(p => {
    if (p.status && p.status !== 'open') return false;
    if (p.wheelId) {
      const linkedWheel = (S.wheelPositions || []).find(w => w.id === p.wheelId);
      if (linkedWheel && linkedWheel.status === 'completed') return false;
    }
    return true;
  });
  const closedSigs = sigs.filter(p => p.status && p.status !== 'open' && p.status !== 'assigned');

  let html = '';

  // Announcements at top
  anns.slice(0, 3).forEach(a => {
    html += `<div class="signal-card" style="border-left:3px solid var(--orange);background:var(--orange-bg)"><div style="font-weight:600;margin-bottom:4px">${a.title}</div><div style="font-size:13px;color:var(--text2)">${a.message}</div><div style="font-size:11px;color:var(--text3);margin-top:8px">${getTimeAgo(a.timestamp)}</div></div>`;
  });

  // Roll updates
  rolls.slice(0, 5).forEach(r => {
    html += `<div class="signal-card" style="border-left:3px solid var(--purple)"><div class="signal-header"><span class="signal-type" style="background:var(--purple-bg);color:var(--purple)">ROLL</span><span class="signal-time">${getTimeAgo(r.timestamp)}</span></div><div style="font-size:13px;margin:8px 0"><span style="color:var(--red)">${r.original}</span> → <span style="color:var(--green)">${r.newPos}</span></div><div style="font-size:14px;font-weight:600;color:var(--green)">${r.credit}</div>${r.notes?`<div style="font-size:12px;color:var(--text2);margin-top:4px">${r.notes}</div>`:''}</div>`;
  });

  // ASSIGNED SHARES section (wheel positions with live tracking)
  const activeWheels = (S.wheelPositions || []).filter(w => w.status === 'holding');
  if (activeWheels.length > 0) {
    html += `<div class="card-title" style="margin:16px 0 12px;display:flex;align-items:center;gap:8px"><span style="display:inline-block;width:8px;height:8px;background:var(--orange);border-radius:50%;animation:pulse 2s infinite"></span>Assigned Shares (${activeWheels.length})</div>`;
    activeWheels.forEach(w => {
      const totalCCPrem = w.ccHistory.reduce((s, cc) => s + (cc.premiumTotal || 0), 0);
      const totalPremium = (w.totalPremiumCollected || 0) + totalCCPrem;
      const livePrice = w.currentPrice || w.assignPrice;
      const stockPnl = (livePrice - w.assignPrice) * w.shares;
      const netPnl = stockPnl + totalPremium;
      const fmtPnl = (v) => v >= 0 ? `+$${v.toFixed(0)}` : `-$${Math.abs(v).toFixed(0)}`;
      const netColor = netPnl >= 0 ? 'var(--green)' : 'var(--red)';
      // Check if user has a copied position for this signal but hasn't marked assigned yet
      const userCopy = !isAdmin() && w.cspSignalId ? (S.positions || []).find(pos => pos.signalId === w.cspSignalId && !pos.assigned) : null;
      const userAssignBtn = userCopy ? `<button onclick="event.stopPropagation();userMarkAssigned('${w.cspSignalId}')" style="font-size:11px;padding:5px 12px;background:var(--orange);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-top:6px">I was assigned too</button>` : '';
      // Show active CC attached to this position
      const activeCC = w.ccHistory.find(cc => cc.status === 'open');
      const ccHistoryCount = w.ccHistory.length;
      let activeCCHtml = '';
      if (activeCC) {
        activeCCHtml = `<div style="margin-top:8px;padding:8px 10px;background:var(--blue-bg,rgba(0,122,255,0.08));border-radius:8px;border-left:3px solid var(--blue)">
          <div style="font-size:11px;font-weight:600;color:var(--blue);margin-bottom:2px">COVERED CALL ACTIVE</div>
          <div style="font-size:12px">$${activeCC.strike} Call · Exp ${activeCC.exp} · <span style="color:var(--green)">+$${activeCC.premiumTotal.toFixed(0)} collected</span></div>
        </div>`;
      }
      const ccCountLabel = ccHistoryCount > 0 ? ` · ${ccHistoryCount} CC${ccHistoryCount>1?'s':''} sold` : '';
      html += `<div class="signal-card" style="border-left:3px solid var(--orange)">
        <div class="signal-header"><span class="signal-type" style="background:var(--orange-bg,rgba(255,152,0,0.1));color:var(--orange)">SHARES</span><span class="signal-time" style="margin-left:auto">Assigned ${getTimeAgo(w.assignedAt)}</span></div>
        <div class="signal-ticker">${w.symbol}</div>
        <div class="signal-details">${w.shares} shares · Bought at $${w.assignPrice.toFixed(2)} · Now $${livePrice.toFixed(2)}</div>
        <div style="display:flex;gap:16px;font-size:13px;align-items:center;flex-wrap:wrap">
          <span>Stock: <b style="color:${stockPnl>=0?'var(--green)':'var(--red)'}">${fmtPnl(stockPnl)}</b></span>
          <span>Premiums: <b style="color:var(--green)">+$${totalPremium.toFixed(0)}</b></span>
          <span>Net: <b style="color:${netColor};font-size:14px">${fmtPnl(netPnl)}</b></span>
        </div>
        <div style="font-size:11px;color:var(--text3);margin-top:4px">Selling covered calls to reduce cost basis${ccCountLabel}</div>
        ${activeCCHtml}
        ${userAssignBtn}
      </div>`;
    });
  }

  // OPEN POSITIONS section
  const totalOpen = openSigs.length + activeWheels.length;
  if (openSigs.length > 0) {
    html += `<div class="card-title" style="margin:16px 0 12px;display:flex;align-items:center;gap:8px"><span style="display:inline-block;width:8px;height:8px;background:var(--green);border-radius:50%;animation:pulse 2s infinite"></span>Open Options (${openSigs.length})</div>`;
    openSigs.forEach((s) => {
      const time = s.timestamp ? getTimeAgo(s.timestamp) : s.time;
      const premVal = s.prem || '';
      const sid = s.id ? `,'${s.id}'` : '';
      const rollBadge = s.rollCount ? `<span style="font-size:10px;padding:2px 6px;background:var(--purple-bg);color:var(--purple);border-radius:10px;font-weight:600;margin-left:6px">ROLL #${s.rollCount}</span>` : '';
      const totalPremLine = s.totalPremiumCollected ? `<div style="font-size:11px;color:var(--text3);margin-top:4px">Net premium (all rolls): <b style="color:${s.totalPremiumCollected >= 0 ? 'var(--green)' : 'var(--red)'}">$${(s.totalPremiumCollected * 100).toFixed(0)}</b></div>` : '';
      // Show "Covered by X shares" tag on CC signals linked to wheel positions
      const linkedWheel = s.wheelId ? (S.wheelPositions || []).find(w => w.id === s.wheelId) : null;
      const coveredBadge = linkedWheel ? `<div style="font-size:11px;color:var(--blue);margin-top:4px;padding:4px 8px;background:var(--blue-bg,rgba(0,122,255,0.08));border-radius:6px;display:inline-block">Covered by ${linkedWheel.shares} assigned ${linkedWheel.symbol} shares</div>` : '';
      const notesLine = s.notes ? `<div style="font-size:12px;color:var(--text2);margin-top:6px;padding:6px 8px;background:var(--input);border-radius:6px;border-left:2px solid var(--text3)">📝 ${s.notes}</div>` : '';
      html += `<div class="signal-card" style="border-left:3px solid var(--${s.type==='csp'?'green':'blue'})"><div class="signal-header"><span class="signal-type ${s.type}">${s.type.toUpperCase()}</span>${rollBadge}<span class="signal-time" style="margin-left:auto">${time}</span></div><div class="signal-ticker">${s.ticker}</div><div class="signal-details">$${s.strike} ${s.type==='csp'?'Put':'Call'} · Exp ${s.exp}</div><div style="display:flex;gap:16px;font-size:13px;align-items:center"><span>Premium: <b style="color:var(--green)">${premVal}</b></span><span>Delta: <b>${s.delta||''}</b></span><button class="copy-trade-btn" onclick="event.stopPropagation();copyTradeFromSignal('${s.ticker}','${s.type}','${s.strike}','${s.exp}','${premVal}'${sid})">+ Copy Trade</button></div>${notesLine}${totalPremLine}${coveredBadge}</div>`;
    });
  } else if (activeWheels.length === 0) {
    html += `<div class="empty" style="padding:24px"><div class="empty-title">No Open Positions</div><div class="empty-text">New signals will appear here when posted</div></div>`;
  }

  // COMPLETED WHEELS section — full lifecycle recap for users
  const completedWheelSigs = closedSigs.filter(s => s.wheelComplete && s.wheelSummary);
  const otherClosedSigs = closedSigs.filter(s => !s.wheelComplete);

  if (completedWheelSigs.length > 0) {
    html += `<div class="card-title" style="margin:24px 0 12px;display:flex;align-items:center;gap:8px">🏆 Completed Wheels (${completedWheelSigs.length})</div>`;
    completedWheelSigs.slice(0, 10).forEach(s => {
      const ws = s.wheelSummary;
      const fmtPnl = v => v >= 0 ? `+$${v.toFixed(0)}` : `-$${Math.abs(v).toFixed(0)}`;
      const pnlColor = v => v >= 0 ? 'var(--green)' : 'var(--red)';
      const assignDate = ws.assignedAt ? new Date(ws.assignedAt).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '';
      const completeDate = ws.completedAt ? new Date(ws.completedAt).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '';

      let timeline = `<div style="font-size:11px;color:var(--text3);margin-top:10px;border-left:2px solid var(--border);padding-left:10px">`;
      timeline += `<div style="margin-bottom:4px"><span style="color:var(--green);font-weight:600">CSP</span> Sold $${ws.assignPrice} Put · <span style="color:var(--green)">+$${(ws.cspPremium||0).toFixed(0)}</span></div>`;
      timeline += `<div style="margin-bottom:4px"><span style="color:var(--orange);font-weight:600">ASSIGNED</span> ${ws.shares} shares at $${ws.assignPrice.toFixed(2)} · ${assignDate}</div>`;
      if (ws.ccHistory) {
        ws.ccHistory.forEach((cc, i) => {
          const outcome = cc.outcome === 'winner' ? ' WIN' : '';
          timeline += `<div style="margin-bottom:4px"><span style="color:var(--blue);font-weight:600">CC #${i+1}</span> $${cc.strike} Call · ${cc.exp} · <span style="color:var(--green)">+$${(cc.premiumTotal||0).toFixed(0)}</span>${outcome ? '<span style="color:var(--green)">'+outcome+'</span>' : ''}</div>`;
        });
      }
      timeline += `<div style="margin-bottom:4px"><span style="color:var(--purple,#9C27B0);font-weight:600">CALLED</span> Shares sold at $${ws.callStrike.toFixed(2)} · ${completeDate}</div>`;
      timeline += `</div>`;

      html += `<div class="signal-card" style="border-left:3px solid ${(ws.finalPnl||0) >= 0 ? 'var(--green)' : 'var(--red)'}">
        <div class="signal-header">
          <span class="signal-type" style="background:${(ws.finalPnl||0) >= 0 ? 'var(--green-bg)' : 'var(--red-bg,rgba(255,23,68,0.1))'};color:${pnlColor(ws.finalPnl||0)}">WHEEL COMPLETE</span>
          <span class="signal-time" style="margin-left:auto">${ws.daysHeld||'?'} days</span>
        </div>
        <div class="signal-ticker">${s.ticker}</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-top:8px;font-size:11px;text-align:center">
          <div style="padding:6px;background:var(--input);border-radius:6px"><div style="color:var(--text3)">Premiums</div><b style="color:var(--green)">+$${(ws.totalPremium||0).toFixed(0)}</b></div>
          <div style="padding:6px;background:var(--input);border-radius:6px"><div style="color:var(--text3)">Stock</div><b style="color:${pnlColor(ws.stockPnl||0)}">${fmtPnl(ws.stockPnl||0)}</b></div>
          <div style="padding:6px;background:var(--input);border-radius:6px"><div style="color:var(--text3)">Total P&L</div><b style="color:${pnlColor(ws.finalPnl||0)}">${fmtPnl(ws.finalPnl||0)}</b></div>
        </div>
        ${timeline}
      </div>`;
    });
  }

  // OTHER CLOSED POSITIONS section
  if (otherClosedSigs.length > 0) {
    html += `<div class="card-title" style="margin:24px 0 12px">📊 Position History (${otherClosedSigs.length})</div>`;
    otherClosedSigs.slice(0, 15).forEach((s) => {
      let statusBadge = '';
      if (s.status === 'winner') statusBadge = '<span class="status-badge winner">WIN 🎉</span>';
      else if (s.status === 'rolled') statusBadge = '<span class="status-badge rolled">ROLLED</span>';
      else if (s.status === 'assigned') statusBadge = '<span class="status-badge assigned">ASSIGNED 📦</span>';
      else if (s.status === 'called') statusBadge = '<span class="status-badge called">CALLED 📤</span>';
      else statusBadge = '<span class="status-badge closed">CLOSED</span>';

      const borderColor = s.status === 'winner' ? 'var(--green)' : s.status === 'assigned' ? 'var(--orange)' : s.status === 'called' ? 'var(--blue)' : s.status === 'rolled' ? 'var(--purple)' : 'var(--text3)';
      const rolledTo = s.rolledToStrike ? `<div style="font-size:11px;color:var(--purple);margin-top:4px">→ Rolled to $${s.rolledToStrike} ${s.rolledToExp||''}</div>` : '';
      html += `<div class="signal-card" style="border-left:3px solid ${borderColor}${['winner','assigned','called','rolled'].includes(s.status)?'':';opacity:0.8'}"><div class="signal-header"><span class="signal-type ${s.type}">${s.type.toUpperCase()}</span>${statusBadge}<span class="signal-time" style="margin-left:auto">${getTimeAgo(s.closedAt || s.timestamp)}</span></div><div class="signal-ticker">${s.ticker}</div><div class="signal-details">$${s.strike} ${s.type==='csp'?'Put':'Call'} · Exp ${s.exp}</div><div style="display:flex;gap:16px;font-size:13px"><span>Premium: <b style="color:var(--green)">${s.prem}</b></span></div>${rolledTo}</div>`;
    });
  }

  c.innerHTML = html || '<div class="empty"><div class="empty-title">No Signals Yet</div><div class="empty-text">Live trading signals will appear here</div></div>';
}
function renderProfile(){
  $('userName').value=S.user.name||'';
  $('userEmail').value=S.user.email||'';
  $('userPhone').value=S.user.phone||'';
  if($('userCarrier'))$('userCarrier').value=S.user.carrier||'';
  $('profileName').textContent=S.user.name||'Set up your profile';
  $('profileEmail').textContent=S.user.email||'Tap to edit';
  const init=S.user.name?S.user.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2):'?';
  $('profileInitials').textContent=init;

  // Show avatar image if exists
  const avatarImg = $('profileAvatarImg');
  const initials = $('profileInitials');
  if (S.user.avatar && avatarImg) {
    avatarImg.src = S.user.avatar;
    avatarImg.style.display = 'block';
    if (initials) initials.style.display = 'none';
  } else if (avatarImg) {
    avatarImg.style.display = 'none';
    if (initials) initials.style.display = 'block';
  }
  $('apiKeyInput').value=S.apiKey;
  $('secretKeyInput').value=S.secretKey;
  $('accSizeInput').value=S.accSize;
  $('feeInput').value=S.feePerContract||0;
  const ok=S.apiKey.length>10;
  $('brokerStatus').innerHTML=ok?'<div style="padding:12px;background:var(--green-bg);border-radius:12px;margin-bottom:16px;font-weight:600;color:var(--green)"><span class="live-dot"></span>Connected</div>':'<div style="padding:12px;background:var(--orange-bg);border-radius:12px;margin-bottom:16px;font-size:13px;color:var(--orange)">Not connected</div>';
  const wins=S.history.filter(t=>(t.pnl||0)>=0).length;
  const total=S.history.length;
  const realPrem=S.history.reduce((s,t)=>s+(t.premium||0)*(t.contracts||1)*100,0);
  const pendPrem=S.positions.reduce((s,p)=>s+(p.premium||0)*(p.contracts||1)*100,0);
  $('pTrades').textContent=total;
  $('pWinRate').textContent=total?Math.round(wins/total*100)+'%':'0%';
  $('pPremium').innerHTML='$'+realPrem.toFixed(0)+(pendPrem>0?' <span style="font-size:11px;opacity:0.6">(+$'+pendPrem.toFixed(0)+' pending)</span>':'');
  // Sync notification switches to current state
  ['notifSwitch','qNotifSwitch'].forEach(id=>$(id)?.classList.toggle('on',!!S.notifOn));
  const emailSw = $('emailAlertSwitch');
  if (emailSw) emailSw.classList.toggle('on', !!S.emailAlerts);
  const discordSw = $('discordSwitch');
  if (discordSw) discordSw.classList.toggle('on', !!S.discordAlerts);
  const smsSw = $('smsSwitch');
  if (smsSw) smsSw.classList.toggle('on', !!S.smsAlerts);
  const alertEmailInput = $('userAlertEmail');
  if (alertEmailInput && S.alertEmail) alertEmailInput.value = S.alertEmail;

  // Show alert prefs for premium users, but show basic notif controls for all
  if(S.isPremium){show('proBadge');hide('proCard');$('alertPrefsCard').style.display='block';}
  else{$('alertPrefsCard').style.display='none';}
}
function saveProfile(){S.user.name=$('userName').value.trim();S.user.email=$('userEmail').value.trim();S.user.phone=$('userPhone')?.value.trim()||'';S.user.carrier=$('userCarrier')?.value||'';save();renderProfile();showToast('Saved!','success')}

function handleAvatarUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  // Check file size (max 500KB to avoid localStorage issues)
  if (file.size > 500000) {
    showToast('Image too large. Max 500KB', 'error');
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      // Resize image to max 200x200 to save space
      const canvas = document.createElement('canvas');
      const max = 200;
      let w = img.width, h = img.height;
      if (w > h) { if (w > max) { h = h * max / w; w = max; } }
      else { if (h > max) { w = w * max / h; h = max; } }
      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);

      const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
      S.user.avatar = dataUrl;
      save();
      renderProfile();
      showToast('Photo updated!', 'success');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// ====================================
// FEATURE: WHEEL CANDIDATE SCREENER
// ====================================
const SCREENER_TICKERS = [
  {sym:'SPY',name:'S&P 500 ETF',cat:'etf'},{sym:'QQQ',name:'Nasdaq 100 ETF',cat:'etf'},{sym:'IWM',name:'Russell 2000 ETF',cat:'etf'},
  {sym:'DIA',name:'Dow Jones ETF',cat:'etf'},{sym:'XLF',name:'Financials ETF',cat:'etf'},{sym:'XLE',name:'Energy ETF',cat:'etf'},
  {sym:'GLD',name:'Gold ETF',cat:'etf'},{sym:'SLV',name:'Silver ETF',cat:'etf'},{sym:'TLT',name:'20yr Treasury ETF',cat:'etf'},
  {sym:'AAPL',name:'Apple',cat:'mega'},{sym:'MSFT',name:'Microsoft',cat:'mega'},{sym:'NVDA',name:'NVIDIA',cat:'mega'},
  {sym:'AMZN',name:'Amazon',cat:'mega'},{sym:'GOOGL',name:'Alphabet',cat:'mega'},{sym:'META',name:'Meta',cat:'mega'},
  {sym:'TSLA',name:'Tesla',cat:'growth'},{sym:'AMD',name:'AMD',cat:'growth'},{sym:'CRM',name:'Salesforce',cat:'growth'},
  {sym:'NFLX',name:'Netflix',cat:'growth'},{sym:'SHOP',name:'Shopify',cat:'growth'},{sym:'SQ',name:'Block',cat:'growth'},
  {sym:'SOFI',name:'SoFi',cat:'growth'},{sym:'PLTR',name:'Palantir',cat:'growth'},{sym:'COIN',name:'Coinbase',cat:'growth'},
  {sym:'JPM',name:'JPMorgan',cat:'value'},{sym:'BAC',name:'Bank of America',cat:'value'},{sym:'WFC',name:'Wells Fargo',cat:'value'},
  {sym:'KO',name:'Coca-Cola',cat:'value'},{sym:'PEP',name:'PepsiCo',cat:'value'},{sym:'JNJ',name:'Johnson & Johnson',cat:'value'},
  {sym:'WMT',name:'Walmart',cat:'value'},{sym:'HD',name:'Home Depot',cat:'value'},{sym:'PFE',name:'Pfizer',cat:'value'},
  {sym:'T',name:'AT&T',cat:'value'},{sym:'F',name:'Ford',cat:'value'},{sym:'INTC',name:'Intel',cat:'value'},
  {sym:'DIS',name:'Disney',cat:'value'},{sym:'NKE',name:'Nike',cat:'value'},{sym:'PYPL',name:'PayPal',cat:'growth'},
  {sym:'UBER',name:'Uber',cat:'growth'}
];
let screenerData = [];
let screenerFilter = 'all';

function openScreener() { openModal('screenerModal'); }

async function runScreener() {
  const el = $('screenerResults');
  el.innerHTML = '<div class="screener-loading">Scanning tickers... 0/' + SCREENER_TICKERS.length + '</div>';
  screenerData = [];
  const batch = SCREENER_TICKERS.filter(t => screenerFilter === 'all' || t.cat === screenerFilter);
  let done = 0;
  // Fetch in batches of 5
  for (let i = 0; i < batch.length; i += 5) {
    const chunk = batch.slice(i, i + 5);
    const results = await Promise.allSettled(chunk.map(async t => {
      const q = await fetchLiveQuote(t.sym);
      if (!q) return null;
      // Estimate premium yield: ~0.5-2% of price per month for ATM options
      const baseYield = Math.abs(q.changePercent || 1) * 0.3 + 0.8;
      const monthlyYield = Math.min(baseYield, 5).toFixed(1);
      const annualYield = (monthlyYield * 12).toFixed(0);
      return { ...t, price: q.price, change: q.change, changePercent: q.changePercent, monthlyYield, annualYield };
    }));
    results.forEach(r => { if (r.status === 'fulfilled' && r.value) screenerData.push(r.value); });
    done += chunk.length;
    el.innerHTML = '<div class="screener-loading">Scanning tickers... ' + Math.min(done, batch.length) + '/' + batch.length + '</div>';
  }
  sortScreener();
}

function filterScreener(cat, btn) {
  screenerFilter = cat;
  document.querySelectorAll('#screenerFilters .chip-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (screenerData.length) sortScreener();
}

function sortScreener() {
  const sortBy = $('screenerSort')?.value || 'yield';
  let data = [...screenerData].filter(t => screenerFilter === 'all' || t.cat === screenerFilter);
  if (sortBy === 'yield') data.sort((a, b) => b.monthlyYield - a.monthlyYield);
  else if (sortBy === 'price') data.sort((a, b) => a.price - b.price);
  else data.sort((a, b) => a.sym.localeCompare(b.sym));
  renderScreenerResults(data);
}

function renderScreenerResults(data) {
  if (!data.length) { $('screenerResults').innerHTML = '<div class="screener-loading">No results. Tap Scan to search.</div>'; return; }
  $('screenerResults').innerHTML = data.map(t => {
    const chg = t.change >= 0 ? 'var(--green)' : 'var(--red)';
    return `<div class="screener-card" onclick="screenerToCalc('${t.sym}')">
      <div class="screener-left"><div class="screener-logo"><img src="${logo(t.sym)}" onerror="this.outerHTML='<span style=font-weight:700;font-size:11px;color:var(--text2)>${t.sym}</span>'"></div>
      <div><div class="screener-sym">${t.sym}</div><div class="screener-name">${t.name}</div></div></div>
      <div class="screener-metrics"><div class="screener-price">$${t.price.toFixed(2)} <span style="font-size:11px;color:${chg}">${t.change>=0?'+':''}${t.changePercent}%</span></div>
      <div class="screener-yield">~${t.monthlyYield}%/mo · ${t.annualYield}%/yr est.</div></div></div>`;
  }).join('');
}

function screenerToCalc(sym) {
  closeModal('screenerModal');
  nav('calc');
  $('tickerInput').value = sym;
  searchTicker();
}

// ====================================
// FEATURE: P&L CHARTS
// ====================================
function renderPnlCharts(container) {
  const history = S.history || [];
  if (history.length < 2) {
    container.insertAdjacentHTML('afterbegin', '<div class="pnl-chart-wrap"><div class="pnl-chart-title">P&L Over Time</div><div style="text-align:center;padding:20px;color:var(--text3);font-size:13px">Need 2+ closed trades to show chart</div></div>');
    return;
  }
  // Sort by close date
  const sorted = [...history].filter(t => t.closeDate).sort((a, b) => new Date(a.closeDate) - new Date(b.closeDate));

  // Cumulative P&L line chart
  let cumulative = 0;
  const points = sorted.map(t => { cumulative += (t.pnl || 0); return { date: new Date(t.closeDate), val: cumulative }; });
  const maxVal = Math.max(...points.map(p => p.val), 1);
  const minVal = Math.min(...points.map(p => p.val), 0);
  const range = maxVal - minVal || 1;

  let chartHtml = `<div class="pnl-chart-wrap"><div class="pnl-chart-title">Cumulative P&L</div><svg viewBox="0 0 360 120" style="width:100%;height:120px" preserveAspectRatio="none">`;
  // Fill area
  const pathPoints = points.map((p, i) => {
    const x = (i / (points.length - 1)) * 360;
    const y = 110 - ((p.val - minVal) / range) * 100;
    return `${x},${y}`;
  });
  chartHtml += `<defs><linearGradient id="pnlGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0" stop-color="var(--green)" stop-opacity=".3"/><stop offset="1" stop-color="var(--green)" stop-opacity="0"/></linearGradient></defs>`;
  chartHtml += `<path d="M0,110 L${pathPoints.join(' L')} L360,110 Z" fill="url(#pnlGrad)"/>`;
  chartHtml += `<polyline points="${pathPoints.join(' ')}" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
  // Zero line if range crosses zero
  if (minVal < 0 && maxVal > 0) {
    const zeroY = 110 - ((0 - minVal) / range) * 100;
    chartHtml += `<line x1="0" y1="${zeroY}" x2="360" y2="${zeroY}" stroke="var(--text3)" stroke-width="0.5" stroke-dasharray="4"/>`;
  }
  // Labels
  chartHtml += `<text x="4" y="12" fill="var(--text2)" font-size="9">$${maxVal.toFixed(0)}</text>`;
  chartHtml += `<text x="4" y="118" fill="var(--text2)" font-size="9">$${minVal.toFixed(0)}</text>`;
  chartHtml += '</svg></div>';

  // Monthly income bar chart
  const monthly = {};
  [...(S.positions || []), ...history].forEach(t => {
    const d = new Date(t.closeDate || t.openDate);
    const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
    if (!monthly[key]) monthly[key] = 0;
    monthly[key] += (t.premium || 0) * (t.contracts || 1) * 100;
  });
  const months = Object.entries(monthly).sort((a, b) => a[0].localeCompare(b[0])).slice(-6);
  if (months.length > 1) {
    const maxMonth = Math.max(...months.map(m => m[1]), 1);
    chartHtml += '<div class="pnl-chart-wrap"><div class="pnl-chart-title">Monthly Premium</div><div class="monthly-bar">';
    months.forEach(([key, val]) => {
      const h = Math.max((val / maxMonth) * 80, 2);
      const label = new Date(key + '-01').toLocaleDateString('en', { month: 'short' });
      chartHtml += `<div class="month-col"><div class="month-val">$${val.toFixed(0)}</div><div class="month-bar" style="height:${h}px"></div><div class="month-label">${label}</div></div>`;
    });
    chartHtml += '</div></div>';
  }

  container.insertAdjacentHTML('afterbegin', chartHtml);
}

// ====================================
// FEATURE: POSITION ALERTS
// ====================================
function checkPositionAlerts() {
  const positions = S.positions || [];
  const now = new Date();
  positions.forEach(p => {
    if (!p.expiration || p.type === 'shares') return;
    const expD = parseExpDate(p.expiration);
    if (!expD) return;
    const dte = Math.ceil((expD - now) / 864e5);
    if (dte <= S.dteThreshold && dte >= 0 && S.alertSettings.dte) {
      if (S.alertSettings.browser && Notification.permission === 'granted') {
        showBrowserNotification(
          `${p.symbol} expiring ${dte === 0 ? 'TODAY' : 'in ' + dte + ' days'}`,
          `$${p.strike} ${p.type.toUpperCase()} - Consider rolling or closing`
        );
      }
    }
  });
}

function setDteThreshold(days, btn) {
  S.dteThreshold = days;
  save();
  document.querySelectorAll('#alertsConfigModal .chip-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
}

function toggleAlertType(type) {
  if (type === 'browser') {
    S.alertSettings.browser = !S.alertSettings.browser;
    if (S.alertSettings.browser) requestBrowserNotifications();
    $('alertBrowserSwitch')?.classList.toggle('on', S.alertSettings.browser);
  } else if (type === 'dte') {
    S.alertSettings.dte = !S.alertSettings.dte;
    $('alertDteSwitch')?.classList.toggle('on', S.alertSettings.dte);
  } else if (type === 'earnings') {
    S.alertSettings.earnings = !S.alertSettings.earnings;
    $('alertEarnSwitch')?.classList.toggle('on', S.alertSettings.earnings);
  }
  save();
}

function getExpDateOptions(selectedVal) {
  const opts = [];
  const now = new Date();
  let d = new Date(now);
  // Find next Friday
  d.setDate(d.getDate() + ((5 - d.getDay() + 7) % 7 || 7));
  for (let i = 0; i < 12; i++) {
    const label = d.toLocaleDateString('en', { month: 'short', day: 'numeric' });
    const val = label; // "Feb 14" format
    const sel = selectedVal && val === selectedVal ? ' selected' : '';
    opts.push(`<option value="${val}"${sel}>${label}</option>`);
    d.setDate(d.getDate() + 7);
  }
  return opts.join('');
}

function parseExpDate(exp) {
  if (!exp) return null;
  let d = new Date(exp);
  // If "Feb 14" style (no year), append current year
  if (isNaN(d.getTime()) || d.getFullYear() < 2020) {
    d = new Date(exp + ' ' + new Date().getFullYear());
  }
  // Still invalid? try as-is
  if (isNaN(d.getTime())) return null;
  return d;
}

function getPositionAlertBadges(p) {
  // Only show badge for truly expired or about to expire (≤3 days)
  if (!p.expiration || p.type === 'shares') return '';
  const expDate = parseExpDate(p.expiration);
  if (!expDate) return '';
  const dte = Math.ceil((expDate - new Date()) / 864e5);
  if (dte <= 0) return '<span class="dte-warn danger">EXPIRED</span>';
  if (dte <= 3) return '<span class="dte-warn danger">' + dte + 'D</span>';
  return '';
}

// ====================================
// FEATURE: ROLLING STRATEGY SUGGESTIONS
// ====================================
function showRollSuggestions() {
  const p = S.positions.find(x => x.id === S.selPosId);
  if (!p || p.type === 'shares') { showToast('Roll not available for shares', 'error'); return; }
  const dte = p.expiration ? Math.ceil((new Date(p.expiration) - new Date()) / 864e5) : null;
  const rollDiv = $('rollSuggestions');
  const typeName = p.type === 'csp' ? 'Put' : 'Call';
  const dir = p.type === 'csp' ? 'down' : 'up';
  const dirOpp = p.type === 'csp' ? 'up' : 'down';

  let html = '<div style="font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Roll Suggestions</div>';

  // Roll Out (same strike, later date)
  html += `<div class="roll-card" onclick="startInlineRoll(${p.strike},'Roll Out')">
    <div class="roll-label">Roll Out</div>
    <div class="roll-desc">${p.symbol} $${p.strike}${typeName[0]} → Next Expiration</div>
    <div class="roll-detail">Same strike, more time = more premium. Best when still OTM.</div>
  </div>`;

  // Roll Out & Down/Up
  const adj = p.type === 'csp' ? Math.max(p.strike - 5, 0) : p.strike + 5;
  html += `<div class="roll-card" onclick="startInlineRoll(${adj},'Roll Out & ${dir === 'down' ? 'Down' : 'Up'}')">
    <div class="roll-label">Roll Out & ${dir === 'down' ? 'Down' : 'Up'}</div>
    <div class="roll-desc">${p.symbol} $${p.strike}${typeName[0]} → $${adj}${typeName[0]}</div>
    <div class="roll-detail">Lower risk — move strike further OTM. May reduce credit.</div>
  </div>`;

  // Roll Out & Up/Down (aggressive)
  const adjAgg = p.type === 'csp' ? p.strike + 5 : Math.max(p.strike - 5, 0);
  html += `<div class="roll-card" onclick="startInlineRoll(${adjAgg},'Roll Out & ${dirOpp === 'down' ? 'Down' : 'Up'}')">
    <div class="roll-label">Roll Out & ${dirOpp === 'down' ? 'Down' : 'Up'} (Aggressive)</div>
    <div class="roll-desc">${p.symbol} $${p.strike}${typeName[0]} → $${adjAgg}${typeName[0]}</div>
    <div class="roll-detail">Higher premium — strike closer to ATM. More assignment risk.</div>
  </div>`;

  if (dte !== null && dte <= 7) {
    html += `<div style="background:var(--orange-bg);border-radius:8px;padding:10px;margin-top:8px;font-size:12px;color:var(--orange)">⚠ Only ${dte} DTE remaining — consider rolling soon to avoid assignment.</div>`;
  }

  rollDiv.innerHTML = html;
  rollDiv.style.display = 'block';
}

function startInlineRoll(suggestedStrike, label) {
  const p = S.positions.find(x => x.id === S.selPosId);
  if (!p) return;
  const typeName = p.type === 'csp' ? 'Put' : 'Call';
  const rollDiv = $('rollSuggestions');

  rollDiv.innerHTML = `
    <div style="font-size:12px;font-weight:600;color:var(--blue);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">${label}</div>
    <div style="font-size:13px;color:var(--text2);margin-bottom:14px">Rolling ${p.symbol} $${p.strike}${typeName[0]} (sold at $${(p.premium||0).toFixed(2)}/share)</div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div style="background:var(--input);border-radius:10px;padding:12px">
        <label style="font-size:12px;font-weight:600;color:var(--red);display:block;margin-bottom:4px">Cost to Buy Back Current Position</label>
        <div style="font-size:11px;color:var(--text3);margin-bottom:4px">What you paid per share to close the old contract</div>
        <input type="number" id="rollBuybackCost" placeholder="e.g. 3.00" step="0.01" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:16px;font-weight:600">
      </div>
      <div style="border-top:1px solid var(--border);padding-top:12px">
        <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:4px">New Strike Price</label>
        <input type="number" id="rollNewStrike" value="${suggestedStrike}" step="0.5" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--input);color:var(--text);font-size:16px;font-weight:600">
      </div>
      <div>
        <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:4px">New Expiration</label>
        <select id="rollNewExp" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--input);color:var(--text);font-size:14px"><option value="">Select Friday</option>${getExpDateOptions()}</select>
      </div>
      <div>
        <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:4px">New Premium Collected</label>
        <div style="font-size:11px;color:var(--text3);margin-bottom:4px">Premium per share on the new contract</div>
        <input type="number" id="rollNewPremium" placeholder="e.g. 1.50" step="0.01" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--input);color:var(--text);font-size:16px;font-weight:600">
      </div>
      <div style="display:flex;gap:8px;margin-top:4px">
        <button class="btn" onclick="confirmInlineRoll()" style="flex:1;padding:12px;font-size:14px">Confirm Roll</button>
        <button class="btn btn-outline" onclick="showRollSuggestions()" style="flex:1;padding:12px;font-size:14px">Back</button>
      </div>
    </div>`;
}

function confirmInlineRoll() {
  const p = S.positions.find(x => x.id === S.selPosId);
  if (!p) return;

  const buybackCost = parseFloat($('rollBuybackCost')?.value);
  const newStrike = parseFloat($('rollNewStrike').value);
  const newExp = $('rollNewExp').value.trim();
  const newPremium = parseFloat($('rollNewPremium').value);

  if (isNaN(buybackCost) || buybackCost < 0) return showToast('Enter the cost to buy back per share', 'error');
  if (!newStrike) return showToast('Enter a valid strike', 'error');
  if (!newExp) return showToast('Select new expiration', 'error');
  if (isNaN(newPremium)) return showToast('Enter the new premium per share', 'error');

  const contracts = p.contracts || 1;
  const oldPremPerShare = p.premium || 0;

  // P&L on old position = (premium collected - buyback cost) × contracts × 100
  const pnlPerShare = oldPremPerShare - buybackCost;
  const grossPnl = pnlPerShare * contracts * 100;
  const fees = (S.feePerContract || 0) * contracts * 2; // open + close fees
  const pnl = grossPnl - fees;

  // Move old position to history with REAL P&L
  S.history.unshift({
    ...p,
    closeDate: new Date().toISOString(),
    pnl: pnl,
    grossPnl: grossPnl,
    fees: fees,
    outcome: 'rolled',
    buybackCost: buybackCost,
    rolledToStrike: newStrike,
    rolledToExp: newExp
  });

  // Remove old position
  S.positions = S.positions.filter(x => x.id !== S.selPosId);

  // Create new rolled position
  const newPos = {
    id: Date.now().toString(),
    symbol: p.symbol,
    type: p.type,
    strike: newStrike,
    premium: newPremium,
    contracts: contracts,
    expiration: newExp,
    openDate: new Date().toISOString(),
    rolledFrom: p.id,
    rolledFromStrike: p.strike,
    rollCount: (p.rollCount || 0) + 1,
    totalPremiumCollected: (p.totalPremiumCollected || oldPremPerShare) + newPremium
  };
  S.positions.push(newPos);

  save();
  closeModal('posModal');
  renderHome();

  const pnlStr = pnl >= 0 ? `+$${pnl.toFixed(0)}` : `-$${Math.abs(pnl).toFixed(0)}`;
  const newPremTotal = newPremium * contracts * 100;
  showToast(`Rolled ${p.symbol} $${p.strike} → $${newStrike} · Old P&L: ${pnlStr} · New premium: +$${newPremTotal.toFixed(0)}`, 'success');
}

// ====================================
// FEATURE: EARNINGS CALENDAR
// ====================================
let earningsCache = {};

function openEarnings() { openModal('earningsModal'); loadEarnings(); }

async function loadEarnings() {
  const tickers = [...new Set([...(S.positions || []).map(p => p.symbol), ...(S.watchlist || [])])];
  if (!tickers.length) {
    $('earningsContent').innerHTML = '<div style="text-align:center;padding:24px;color:var(--text3)">Add positions or watchlist tickers to see earnings</div>';
    return;
  }
  $('earningsContent').innerHTML = '<div class="screener-loading">Loading earnings for ' + tickers.length + ' tickers...</div>';

  const results = [];
  for (const sym of tickers) {
    try {
      if (earningsCache[sym] && Date.now() - earningsCache[sym].ts < 3600000) {
        if (earningsCache[sym].data) results.push(earningsCache[sym].data);
        continue;
      }
      // Use FMP API for earnings dates
      const r = await fetch(`https://financialmodelingprep.com/api/v3/earning_calendar?symbol=${sym}&apikey=demo`);
      if (r.ok) {
        const data = await r.json();
        if (data && data.length > 0) {
          const next = data.find(e => new Date(e.date) >= new Date());
          if (next) {
            const entry = { sym, date: next.date, time: next.time || 'bmo', eps: next.epsEstimated };
            results.push(entry);
            earningsCache[sym] = { data: entry, ts: Date.now() };
          } else {
            earningsCache[sym] = { data: null, ts: Date.now() };
          }
        }
      }
    } catch (e) { console.warn('Earnings fetch:', e.message); }
  }

  // If FMP demo fails (common), generate estimated dates
  if (results.length === 0) {
    tickers.forEach(sym => {
      // Estimate next earnings: roughly quarterly from random seed
      const hash = sym.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
      const now = new Date();
      const daysToNext = 15 + (hash % 60);
      const estDate = new Date(now.getTime() + daysToNext * 864e5);
      results.push({ sym, date: estDate.toISOString().split('T')[0], time: hash % 2 === 0 ? 'bmo' : 'amc', estimated: true });
    });
  }

  results.sort((a, b) => new Date(a.date) - new Date(b.date));
  renderEarnings(results);
}

function renderEarnings(data) {
  if (!data.length) {
    $('earningsContent').innerHTML = '<div style="text-align:center;padding:24px;color:var(--text3)">No upcoming earnings found</div>';
    return;
  }
  const now = new Date();
  $('earningsContent').innerHTML = data.map(e => {
    const d = new Date(e.date);
    const days = Math.ceil((d - now) / 864e5);
    const month = d.toLocaleDateString('en', { month: 'short' });
    const day = d.getDate();
    const timing = e.time === 'bmo' ? 'Before Market Open' : e.time === 'amc' ? 'After Market Close' : 'TBD';
    let cdClass = 'later', cdText = days + 'd';
    if (days <= 3) { cdClass = 'soon'; cdText = days <= 0 ? 'TODAY' : days + 'd'; }
    else if (days <= 14) { cdClass = 'upcoming'; }
    const est = e.estimated ? ' <span style="font-size:9px;color:var(--text3)">(est.)</span>' : '';
    const inPortfolio = (S.positions || []).some(p => p.symbol === e.sym);
    const warn = inPortfolio && days <= 7 ? ' <span style="color:var(--red);font-size:10px;font-weight:700">⚠ OPEN POSITION</span>' : '';
    return `<div class="earn-item">
      <div class="earn-date"><div class="earn-month">${month}</div><div class="earn-day">${day}</div></div>
      <div class="earn-info"><div class="earn-sym">${e.sym}${est}${warn}</div><div class="earn-timing">${timing}</div></div>
      <div class="earn-countdown ${cdClass}">${cdText}</div>
    </div>`;
  }).join('');
}

// ====================================
// FEATURE: INCOME GOALS
// ====================================
function openGoals() {
  $('goalInput').value = S.incomeGoal || '';
  renderGoalsContent();
  openModal('goalsModal');
}

function saveGoal() {
  const val = parseInt($('goalInput').value) || 0;
  if (val <= 0) { showToast('Enter a positive amount', 'error'); return; }
  S.incomeGoal = val;
  save();
  renderGoalsContent();
  renderIncomeGoal();
  showToast('Goal set to $' + val + '/month!', 'success');
}

function getMonthlyPremium(yearMonth) {
  // Only count CLOSED (realized) trades toward monthly income
  return (S.history || []).reduce((sum, t) => {
    const d = new Date(t.closeDate || t.openDate);
    const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
    if (key === yearMonth) sum += (t.premium || 0) * (t.contracts || 1) * 100;
    return sum;
  }, 0);
}
function getMonthlyPending(yearMonth) {
  return (S.positions || []).reduce((sum, p) => {
    const d = new Date(p.openDate);
    const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
    if (key === yearMonth) sum += (p.premium || 0) * (p.contracts || 1) * 100;
    return sum;
  }, 0);
}

function getCurrentMonthKey() {
  const n = new Date();
  return n.getFullYear() + '-' + String(n.getMonth() + 1).padStart(2, '0');
}

function getGoalStreak() {
  if (!S.incomeGoal) return 0;
  let streak = 0;
  const now = new Date();
  for (let i = 1; i <= 12; i++) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
    const earned = getMonthlyPremium(key);
    if (earned >= S.incomeGoal) streak++;
    else break;
  }
  return streak;
}

function renderIncomeGoal() {
  const section = $('goalSection');
  if (!section) return;
  if (!S.incomeGoal || S.incomeGoal <= 0) { section.style.display = 'none'; return; }
  section.style.display = 'block';
  const mk = getCurrentMonthKey();
  const realized = getMonthlyPremium(mk);
  const pending = getMonthlyPending(mk);
  const pct = Math.min((realized / S.incomeGoal) * 100, 100);
  $('goalAmountText').innerHTML = '$' + realized.toFixed(0) + ' / $' + S.incomeGoal + (pending > 0 ? ' <span style="font-size:11px;opacity:0.7">(+$' + pending.toFixed(0) + ' pending)</span>' : '');
  $('goalFill').style.width = pct + '%';
  if (pct >= 100) $('goalFill').style.background = 'linear-gradient(90deg, var(--green), #10b981)';
  const streak = getGoalStreak();
  const streakEl = $('goalStreak');
  if (streakEl) streakEl.innerHTML = streak > 0 ? '🔥 ' + streak + ' month streak' : pct >= 100 ? '✅ Goal reached this month!' : Math.round(pct) + '% of goal' + (pending > 0 ? ' · $' + pending.toFixed(0) + ' pending' : '');
}

function renderGoalsContent() {
  const el = $('goalsContent');
  if (!el) return;
  const now = new Date();
  let html = '<div style="font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Monthly History</div>';
  for (let i = 0; i < 6; i++) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
    const earned = getMonthlyPremium(key);
    const pend = getMonthlyPending(key);
    const goal = S.incomeGoal || 500;
    const pct = Math.min((earned / goal) * 100, 100);
    const label = d.toLocaleDateString('en', { month: 'long', year: 'numeric' });
    const hit = earned >= goal;
    const pendLabel = pend > 0 ? ` <span style="font-size:11px;opacity:0.6">(+$${pend.toFixed(0)} pending)</span>` : '';
    html += `<div style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px"><span>${label}</span><span style="font-weight:600;color:${hit?'var(--green)':'var(--text)'}">${hit?'✅ ':''}$${earned.toFixed(0)} / $${goal}${pendLabel}</span></div>
      <div class="goal-track"><div class="goal-fill" style="width:${pct}%;${hit?'background:var(--green)':''}"></div></div>
    </div>`;
  }
  el.innerHTML = html;
}

// ====================================
// FEATURE: BACKTESTING
// ====================================
let btMode = 'csp';

function setBtMode(m) {
  btMode = m;
  $('btCspBtn').classList.toggle('active', m === 'csp');
  $('btCcBtn').classList.toggle('active', m === 'cc');
}

function openBacktest() { openModal('backtestModal'); }

async function runBacktest() {
  const ticker = ($('btTicker').value || 'SPY').trim().toUpperCase();
  const delta = parseFloat($('btDelta').value);
  const dte = parseInt($('btDTE').value);
  const periods = parseInt($('btPeriod').value);
  const account = parseInt($('btAccount').value) || 25000;
  const el = $('btResults');
  el.innerHTML = '<div class="screener-loading">Running backtest for ' + ticker + '...</div>';

  // Fetch current price
  const quote = await fetchLiveQuote(ticker);
  if (!quote) { el.innerHTML = '<div style="color:var(--red);text-align:center;padding:16px">Could not fetch ' + ticker + ' price</div>'; return; }
  const price = quote.price;

  // Simulate the wheel strategy
  const cashRequired = btMode === 'csp' ? price * 100 : price * 100; // 1 contract = 100 shares
  const contracts = Math.floor(account / cashRequired) || 1;

  let totalPrem = 0, wins = 0, losses = 0, assignments = 0, maxDD = 0, runningPnl = 0, peakPnl = 0;
  const trades = [];

  for (let i = 0; i < periods; i++) {
    // Estimate premium based on delta and DTE
    // Higher delta = more premium but more risk
    // Rough model: premium ≈ price * delta * sqrt(DTE/365) * IV_factor
    const ivFactor = 0.25 + Math.random() * 0.2; // 25-45% IV
    const premPerShare = price * delta * Math.sqrt(dte / 365) * ivFactor;
    const totalPremTrade = premPerShare * contracts * 100;

    // Simulate outcome: win probability ≈ 1 - delta
    const winProb = 1 - delta;
    const priceMove = (Math.random() - 0.5) * price * 0.15; // ±7.5% move
    const isWin = Math.random() < winProb;

    if (isWin) {
      wins++;
      totalPrem += totalPremTrade;
      runningPnl += totalPremTrade;
      trades.push({ pnl: totalPremTrade, type: 'win' });
    } else {
      assignments++;
      // Assignment loss: difference between strike and new price, minus premium
      const assignLoss = Math.abs(priceMove) * contracts * 100 * 0.3;
      const netPnl = totalPremTrade - assignLoss;
      totalPrem += totalPremTrade;
      runningPnl += netPnl;
      if (netPnl < 0) losses++;
      else wins++;
      trades.push({ pnl: netPnl, type: 'assignment' });
    }
    if (runningPnl > peakPnl) peakPnl = runningPnl;
    const dd = peakPnl - runningPnl;
    if (dd > maxDD) maxDD = dd;
  }

  const totalReturn = (runningPnl / account * 100).toFixed(1);
  const winRate = ((wins / periods) * 100).toFixed(0);
  const avgTrade = (runningPnl / periods).toFixed(0);
  const annualReturn = (runningPnl / (periods / 12) / account * 100).toFixed(1);

  el.innerHTML = `
    <div class="bt-result">
      <div style="text-align:center;font-size:12px;color:var(--text2);margin-bottom:4px">${ticker} ${btMode.toUpperCase()} @ ${(delta*100).toFixed(0)}Δ · ${dte} DTE · ${periods} trades</div>
      <div class="bt-big" style="color:${runningPnl>=0?'var(--green)':'var(--red)'}">$${runningPnl.toFixed(0)}</div>
      <div style="text-align:center;font-size:12px;color:var(--text2)">${totalReturn}% return on $${account.toLocaleString()}</div>
    </div>
    <div style="background:var(--input);border-radius:12px;padding:14px">
      <div class="bt-row"><span>Win Rate</span><span style="color:var(--green)">${winRate}%</span></div>
      <div class="bt-row"><span>Total Premium</span><span>$${totalPrem.toFixed(0)}</span></div>
      <div class="bt-row"><span>Avg Trade P&L</span><span style="color:${avgTrade>=0?'var(--green)':'var(--red)'}">$${avgTrade}</span></div>
      <div class="bt-row"><span>Assignments</span><span>${assignments} (${((assignments/periods)*100).toFixed(0)}%)</span></div>
      <div class="bt-row"><span>Max Drawdown</span><span style="color:var(--red)">-$${maxDD.toFixed(0)}</span></div>
      <div class="bt-row"><span>Annualized Return</span><span style="color:var(--green)">${annualReturn}%</span></div>
      <div class="bt-row"><span>Contracts/Trade</span><span>${contracts}</span></div>
    </div>
    <p style="font-size:10px;color:var(--text3);text-align:center;margin-top:12px">Simulated results using Monte Carlo estimation. Past performance is not indicative of future results. Not financial advice.</p>
  `;
}

// ====================================
// FEATURE: SOCIAL / LEADERBOARD
// ====================================
function openLeaderboard() {
  renderAchievements();
  renderLeaderboard();
  $('lbOptIn')?.classList.toggle('on', S.leaderboardOptIn);
  openModal('leaderboardModal');
}

function toggleLeaderboardOptIn() {
  S.leaderboardOptIn = !S.leaderboardOptIn;
  save();
  $('lbOptIn')?.classList.toggle('on', S.leaderboardOptIn);
  if (S.leaderboardOptIn) {
    saveToLeaderboard();
    showToast('Stats shared publicly!', 'success');
  } else {
    showToast('Stats hidden from leaderboard', 'success');
  }
}

function getMyStats() {
  const positions = S.positions || [];
  const history = S.history || [];
  const totalPrem = [...positions, ...history].reduce((s, t) => s + (t.premium || 0) * (t.contracts || 1) * 100, 0);
  const wins = history.filter(t => (t.pnl || 0) >= 0).length;
  const total = history.length;
  const winRate = total > 0 ? Math.round(wins / total * 100) : 0;
  const totalPnl = history.reduce((s, t) => s + (t.pnl || 0), 0);
  const roi = S.accSize > 0 ? ((totalPnl / S.accSize) * 100).toFixed(1) : 0;
  return { totalPrem, winRate, totalPnl, roi, trades: total + positions.length, name: S.user?.name || 'Anonymous' };
}

async function saveToLeaderboard() {
  if (!S.leaderboardOptIn || !S.firebaseUid) return;
  try {
    const stats = getMyStats();
    const db = window._fbDb;
    if (db) {
      await db.ref('leaderboard/' + S.firebaseUid).set({
        name: stats.name.split(' ')[0] || 'Trader',
        premium: Math.round(stats.totalPrem),
        winRate: stats.winRate,
        trades: stats.trades,
        roi: parseFloat(stats.roi),
        ts: Date.now()
      });
    }
  } catch (e) { console.warn('Leaderboard sync:', e.message); }
}

function renderLeaderboard() {
  const el = $('leaderboardContent');
  if (!el) return;

  // Try loading from Firebase
  const db = window._fbDb;
  if (db) {
    db.ref('leaderboard').orderByChild('premium').limitToLast(20).once('value', snap => {
      const entries = [];
      snap.forEach(child => { entries.push({ uid: child.key, ...child.val() }); });
      entries.reverse(); // highest first
      renderLeaderboardEntries(entries);
    });
  } else {
    // Fallback: show local stats + demo data
    const my = getMyStats();
    const demo = [
      { name: 'WheelMaster', premium: 12450, winRate: 89, trades: 156, roi: 34.2 },
      { name: 'ThetaGang', premium: 8920, winRate: 85, trades: 98, roi: 28.5 },
      { name: 'PremiumKing', premium: 6700, winRate: 82, trades: 74, roi: 22.1 },
      { name: my.name.split(' ')[0] || 'You', premium: Math.round(my.totalPrem), winRate: my.winRate, trades: my.trades, roi: parseFloat(my.roi), isMe: true },
      { name: 'CashSecured', premium: 3200, winRate: 78, trades: 45, roi: 15.8 },
    ].sort((a, b) => b.premium - a.premium);
    renderLeaderboardEntries(demo);
  }
}

function renderLeaderboardEntries(entries) {
  const el = $('leaderboardContent');
  if (!entries.length) { el.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text3)">No rankings yet. Be the first!</div>'; return; }
  el.innerHTML = entries.map((e, i) => {
    const rank = i + 1;
    const cls = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : 'normal';
    const medal = rank === 1 ? '👑' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : rank;
    const meTag = e.isMe ? ' <span style="font-size:10px;color:var(--blue)">(You)</span>' : '';
    return `<div class="lb-item${e.isMe ? ' style="background:var(--blue-bg);border-radius:12px;padding:12px;margin:-4px -8px"' : ''}">
      <div class="lb-rank ${cls}">${medal}</div>
      <div class="lb-info"><div class="lb-name">${escapeHtml(e.name || 'Trader')}${meTag}</div>
      <div class="lb-stats">${e.winRate}% WR · ${e.trades} trades · ${e.roi}% ROI</div></div>
      <div class="lb-val">$${(e.premium || 0).toLocaleString()}</div>
    </div>`;
  }).join('');
}

// ====================================
// FEATURE: ACHIEVEMENTS / BADGES
// ====================================
function checkAchievements() {
  const a = S.achievements || [];
  const positions = S.positions || [];
  const history = S.history || [];
  const total = positions.length + history.length;
  const wins = history.filter(t => (t.pnl || 0) >= 0).length;
  const totalPrem = [...positions, ...history].reduce((s, t) => s + (t.premium || 0) * (t.contracts || 1) * 100, 0);
  const streak = getGoalStreak();

  const badges = [
    { id: 'first_trade', name: 'First Trade', icon: '🎯', check: total >= 1 },
    { id: 'ten_trades', name: '10 Trades', icon: '📊', check: total >= 10 },
    { id: 'fifty_trades', name: '50 Trades', icon: '🏆', check: total >= 50 },
    { id: 'first_win', name: 'First Win', icon: '✅', check: wins >= 1 },
    { id: 'win_streak_5', name: '5 Wins in Row', icon: '🔥', check: getConsecutiveWins() >= 5 },
    { id: 'premium_1k', name: '$1K Premium', icon: '💰', check: totalPrem >= 1000 },
    { id: 'premium_5k', name: '$5K Premium', icon: '💎', check: totalPrem >= 5000 },
    { id: 'premium_10k', name: '$10K Club', icon: '🏅', check: totalPrem >= 10000 },
    { id: 'goal_streak_3', name: '3 Month Streak', icon: '🔥', check: streak >= 3 },
    { id: 'diversified', name: 'Diversified', icon: '🌐', check: new Set([...positions, ...history].map(t => t.symbol)).size >= 5 },
    { id: 'both_sides', name: 'Full Wheeler', icon: '🎡', check: [...positions, ...history].some(t => t.type === 'csp') && [...positions, ...history].some(t => t.type === 'cc') },
  ];

  let newBadge = false;
  badges.forEach(b => {
    if (b.check && !a.includes(b.id)) {
      a.push(b.id);
      newBadge = true;
    }
  });
  if (newBadge) { S.achievements = a; save(); }
  return badges;
}

function getConsecutiveWins() {
  const history = (S.history || []).slice().reverse();
  let streak = 0;
  for (const t of history) {
    if ((t.pnl || 0) >= 0) streak++;
    else break;
  }
  return streak;
}

function renderAchievements() {
  const el = $('achievementsSection');
  if (!el) return;
  const badges = checkAchievements();
  const earned = badges.filter(b => (S.achievements || []).includes(b.id));
  const locked = badges.filter(b => !(S.achievements || []).includes(b.id));

  let html = '<div style="font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Achievements (' + earned.length + '/' + badges.length + ')</div>';
  html += '<div class="badge-row">';
  earned.forEach(b => { html += `<div class="badge gold" title="${b.name}">${b.icon} ${b.name}</div>`; });
  locked.forEach(b => { html += `<div class="badge" title="${b.name}" style="opacity:0.4">🔒 ${b.name}</div>`; });
  html += '</div>';
  el.innerHTML = html;
}

function connectBroker(){S.apiKey=$('apiKeyInput').value.trim();S.secretKey=$('secretKeyInput').value.trim();S.accSize=parseInt($('accSizeInput').value)||25000;S.feePerContract=parseFloat($('feeInput').value)||0;save();updateStatus();renderProfile();showToast('Settings saved!','success')}
load();applyTheme();

// Initialize app when DOM is ready
// ====================================
// DARK MODE EFFECTS: Glow follow + shimmer + fade-up
// ====================================
function initDarkEffects() {
  const isDark = () => document.documentElement.getAttribute('data-theme') === 'dark';

  // Glow-follow effect on cards (only in dark mode)
  document.addEventListener('mousemove', (e) => {
    if (!isDark()) return;
    document.querySelectorAll('.pos-card:hover, .screener-card:hover, .signal-card:hover, .stat-box:hover').forEach(card => {
      const rect = card.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      card.style.background = `radial-gradient(circle 200px at ${x}px ${y}px, rgba(122,90,248,.06), transparent 70%), rgba(255,255,255,.03)`;
    });
  });
  // Reset glow when mouse leaves cards
  document.addEventListener('mouseout', (e) => {
    if (!isDark()) return;
    const card = e.target.closest('.pos-card, .screener-card, .signal-card, .stat-box');
    if (card && !card.matches(':hover')) card.style.background = '';
  });

  // Shimmer sweep via event delegation (works for dynamically rendered buttons)
  document.addEventListener('mouseenter', (e) => {
    if (!isDark()) return;
    const btn = e.target.closest('.btn:not(.btn-outline):not(.btn-red)');
    if (!btn) return;
    btn.style.backgroundSize = '200% 100%';
    btn.style.backgroundImage = 'linear-gradient(135deg, #7A5AF8 0%, #6344e0 40%, rgba(255,255,255,.15) 50%, #6344e0 60%, #7A5AF8 100%)';
    btn.style.animation = 'shimmerSweep .6s ease forwards';
  }, true);
  document.addEventListener('mouseleave', (e) => {
    if (!isDark()) return;
    const btn = e.target.closest('.btn:not(.btn-outline):not(.btn-red)');
    if (!btn) return;
    btn.style.backgroundImage = '';
    btn.style.backgroundSize = '';
    btn.style.animation = '';
  }, true);
}

function initApp() {
  // Check auth state on load
  if (!checkAuthState()) {
    // Not logged in, show auth screen and hide bottom nav
    showAuthScreen();
  } else {
    checkLegal();
  }
  updateStatus();
  initAdminAccess();
  // Initialize EmailJS with defaults on startup
  if (typeof emailjs !== 'undefined') { emailjs.init(localStorage.getItem('emailjsPublicKey') || EMAILJS_DEFAULTS.publicKey); }
  listenToFirebasePosts();
  listenForWinners();
  initDarkEffects();

  // Use requestAnimationFrame to ensure DOM is fully painted before rendering
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      renderHome();
    });
  });
}

// Run init when DOM is fully ready
function safeInit() {
  // Double-check DOM is ready with multiple elements
  const homeTab = $('homeTab');
  const posContainer = $('positionsContainer');
  const histContainer = $('historyContainer');

  if (!homeTab || !posContainer || !histContainer) {
    // DOM not ready, wait and retry
    setTimeout(safeInit, 50);
    return;
  }

  initApp();
}

// Run init when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', safeInit);
} else if (document.readyState === 'interactive') {
  // DOM is parsed but resources may still be loading
  setTimeout(safeInit, 10);
} else {
  // DOM is fully loaded
  safeInit();
}

// Re-render when tab becomes visible again (fixes blank content issue)
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && (S.firebaseUid || S.isGuest)) {
    // Use RAF to ensure smooth re-render after tab switch
    requestAnimationFrame(() => {
      renderHome();
    });
  }
});

// Failsafe: Re-render after all resources are fully loaded
window.addEventListener('load', () => {
  // Give a small delay to ensure everything is settled
  setTimeout(() => {
    if (S.firebaseUid || S.isGuest) {
      renderHome();
    }
  }, 100);
});
</script>
</body>
</html>
