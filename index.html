<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000">
  <title>Market Elites</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--bg:#f5f5f7;--card:#fff;--input:#f0f0f2;--text:#1d1d1f;--text2:#86868b;--text3:#aeaeb2;--border:#e5e5e7;--hero:#1d1d1f;--green:#34c759;--green-bg:rgba(52,199,89,.12);--red:#ff3b30;--red-bg:rgba(255,59,48,.12);--blue:#007aff;--blue-bg:rgba(0,122,255,.12);--orange:#ff9500;--orange-bg:rgba(255,149,0,.12);--purple:#af52de;--purple-bg:rgba(175,82,222,.12)}
    [data-theme=dark]{--bg:#000;--card:#1c1c1e;--input:#2c2c2e;--text:#fff;--text2:#98989f;--text3:#636366;--border:#38383a;--hero:#1c1c1e}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .app{max-width:430px;margin:0 auto;padding:12px 0 90px}
    .hero{margin:0 16px 20px;background:var(--hero);border-radius:24px;padding:20px;position:relative;overflow:hidden}
    .hero::before{content:'';position:absolute;top:-80%;right:-20%;width:300px;height:300px;background:radial-gradient(circle,rgba(255,255,255,.08) 0%,transparent 70%)}
    .hero-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;position:relative;z-index:1}
    .hero-left{display:flex;align-items:center;gap:10px}
    .icon-btn{width:40px;height:40px;background:rgba(255,255,255,.1);border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .icon-btn:active{background:rgba(255,255,255,.2)}
    .icon-btn svg{width:20px;height:20px;stroke:#fff;stroke-width:1.75;fill:none}
    .avatar-btn{width:40px;height:40px;border-radius:50%;border:2px solid rgba(255,255,255,.3);background:linear-gradient(135deg,#f97316,#dc2626);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .avatar-btn span{color:#fff;font-weight:700;font-size:14px}
    .status{display:flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(255,255,255,.1);border-radius:20px;font-size:11px;font-weight:600;color:#fff}
    .status-dot{width:6px;height:6px;border-radius:50%;background:var(--red)}
    .status.ready .status-dot{background:var(--orange)}
    .status.live .status-dot{background:var(--green);animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .hero-balance{text-align:center;margin-bottom:32px;position:relative;z-index:1}
    .balance-label{color:rgba(255,255,255,.6);font-size:13px;margin-bottom:6px}
    .balance-amount{font-size:44px;font-weight:800;color:#fff}
    .balance-change{display:inline-flex;margin-top:8px;padding:5px 12px;background:var(--green-bg);border-radius:12px;font-size:13px;font-weight:600;color:var(--green)}
    .hero-actions{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;position:relative;z-index:1}
    .hero-btn{display:flex;flex-direction:column;align-items:center;gap:10px;background:none;border:none;cursor:pointer;padding:8px}
    .hero-btn-icon{width:52px;height:52px;border-radius:50%;border:1.5px solid rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center}
    .hero-btn:active .hero-btn-icon{background:rgba(255,255,255,.1);transform:scale(.95)}
    .hero-btn-icon svg{width:22px;height:22px;stroke:#fff;stroke-width:2;fill:none}
    .hero-btn span{font-size:11px;font-weight:500;color:rgba(255,255,255,.85)}
    .quick-actions{display:flex;justify-content:space-around;padding:0 16px;margin-bottom:24px}
    .quick-btn{display:flex;flex-direction:column;align-items:center;gap:8px;background:none;border:none;cursor:pointer}
    .quick-btn:active{transform:scale(.95)}
    .quick-icon{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center}
    .quick-icon svg{width:24px;height:24px;stroke-width:2;fill:none}
    .quick-icon.blue{background:var(--blue-bg)}.quick-icon.blue svg{stroke:var(--blue)}
    .quick-icon.green{background:var(--green-bg)}.quick-icon.green svg{stroke:var(--green)}
    .quick-icon.purple{background:var(--purple-bg)}.quick-icon.purple svg{stroke:var(--purple)}
    .quick-icon.orange{background:var(--orange-bg)}.quick-icon.orange svg{stroke:var(--orange)}
    .quick-btn span{font-size:12px;font-weight:500;color:var(--text2)}
    .section{padding:0 16px;margin-bottom:24px}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .section-title{font-size:18px;font-weight:700}
    .section-link{font-size:13px;font-weight:600;color:var(--blue);background:none;border:none;cursor:pointer}
    .pos-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px;cursor:pointer}
    .pos-card:active{transform:scale(.98)}
    .pos-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
    .pos-left{display:flex;align-items:center;gap:12px}
    .pos-logo{width:44px;height:44px;border-radius:12px;background:var(--input);display:flex;align-items:center;justify-content:center;overflow:hidden}
    .pos-logo img{width:100%;height:100%;object-fit:cover}
    .pos-logo-text{font-size:14px;font-weight:700;color:#fff;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#6366f1,#8b5cf6);border-radius:12px}
    .pos-symbol{font-size:16px;font-weight:700}
    .pos-name{font-size:13px;color:var(--text2)}
    .pos-badge{padding:5px 10px;border-radius:8px;font-size:11px;font-weight:700}
    .pos-badge.csp{background:var(--green-bg);color:var(--green)}
    .pos-badge.cc{background:var(--blue-bg);color:var(--blue)}
    .pos-badge.shares{background:var(--purple-bg);color:var(--purple)}
    .pos-stats{display:flex;justify-content:space-between}
    .pos-stat-val{font-size:15px;font-weight:700}
    .pos-stat-val.pos{color:var(--green)}.pos-stat-val.neg{color:var(--red)}
    .pos-stat-label{font-size:11px;color:var(--text3);margin-top:2px}
    .tx-list{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .tx-item{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border)}
    .tx-item:last-child{border-bottom:none}
    .tx-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center}
    .tx-icon svg{width:18px;height:18px;stroke-width:2;fill:none}
    .tx-icon.csp{background:var(--green-bg)}.tx-icon.csp svg{stroke:var(--green)}
    .tx-icon.cc{background:var(--blue-bg)}.tx-icon.cc svg{stroke:var(--blue)}
    .tx-info{flex:1}.tx-title{font-size:15px;font-weight:600}.tx-sub{font-size:12px;color:var(--text3)}
    .tx-amount{font-size:15px;font-weight:700}
    .tx-amount.pos{color:var(--green)}.tx-amount.neg{color:var(--red)}
    .empty{text-align:center;padding:40px 20px;background:var(--card);border:1px solid var(--border);border-radius:16px}
    .empty-icon{width:56px;height:56px;margin:0 auto 12px;background:var(--input);border-radius:50%;display:flex;align-items:center;justify-content:center}
    .empty-icon svg{width:24px;height:24px;stroke:var(--text3);stroke-width:1.5;fill:none}
    .empty-title{font-size:16px;font-weight:600;margin-bottom:4px}
    .empty-text{font-size:13px;color:var(--text2);margin-bottom:16px}
    .empty-btn{padding:12px 24px;background:var(--hero);border:none;border-radius:12px;font-size:14px;font-weight:600;color:#fff;cursor:pointer}
    .nav{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);padding:4px 0 max(4px,env(safe-area-inset-bottom));z-index:100}
    .nav-inner{max-width:500px;margin:0 auto;display:flex;justify-content:stretch}
    .nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:12px 8px;background:none;border:none;cursor:pointer;min-height:56px}
    .nav-btn svg{width:24px;height:24px;stroke-width:1.75;fill:none}
    .nav-btn span{font-size:10px;font-weight:500}
    .nav-btn.active svg{stroke:var(--text)}.nav-btn.active span{color:var(--text);font-weight:600}
    .nav-btn:not(.active) svg{stroke:var(--text3)}.nav-btn:not(.active) span{color:var(--text3)}
    .tab{display:none}.tab.active{display:block}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin:0 16px 16px}
    .card-title{font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:16px}
    .form-group{margin-bottom:16px}
    .form-label{font-size:13px;font-weight:500;color:var(--text2);margin-bottom:8px;display:block}
    .form-input,.form-select{width:100%;background:var(--input);border:1px solid var(--border);border-radius:12px;padding:14px 16px;font-size:15px;color:var(--text);outline:none}
    .toggle{display:flex;background:var(--input);border-radius:10px;padding:4px;margin-bottom:16px}
    .toggle-btn{flex:1;padding:10px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;background:transparent;color:var(--text2)}
    .toggle-btn.active{background:var(--card);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .search-row{display:flex;gap:10px;margin-bottom:12px}
    .search-input{flex:1;background:var(--input);border:1px solid var(--border);border-radius:12px;padding:14px 16px;font-size:18px;font-weight:700;text-transform:uppercase;color:var(--text);outline:none}
    .search-btn{width:52px;height:52px;background:var(--hero);border:none;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .search-btn svg{width:22px;height:22px;stroke:#fff;stroke-width:2.5;fill:none}
    .help-btn{width:32px;height:32px;background:var(--blue-bg);border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .help-btn svg{width:16px;height:16px;stroke:var(--blue);stroke-width:2;fill:none}
    .tickers{display:flex;gap:8px;flex-wrap:wrap}
    .ticker-btn{padding:8px 14px;background:var(--input);border:1px solid var(--border);border-radius:20px;font-size:12px;font-weight:600;color:var(--text2);cursor:pointer}
    .ticker-btn:active{background:var(--hero);color:#fff}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .stat-box{background:var(--input);border-radius:12px;padding:16px;text-align:center}
    .stat-val{font-size:22px;font-weight:700}.stat-val.green{color:var(--green)}.stat-val.blue{color:var(--blue)}
    .stat-label{font-size:11px;color:var(--text2)}
    .btn{width:100%;padding:16px;background:var(--hero);border:none;border-radius:12px;font-size:15px;font-weight:600;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
    .btn svg{width:18px;height:18px;stroke:#fff;stroke-width:2;fill:none}
    .btn-outline{background:transparent;border:1.5px solid var(--border);color:var(--text)}.btn-outline svg{stroke:var(--text)}
    .btn-red{background:var(--red-bg);color:var(--red)}.btn-red svg{stroke:var(--red)}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:none;align-items:flex-end;justify-content:center}
    .modal-bg.show{display:flex}.modal-bg.center{align-items:center}
    .modal{background:var(--card);border-radius:20px 20px 0 0;padding:20px;padding-bottom:max(20px,env(safe-area-inset-bottom));width:100%;max-width:430px;max-height:85vh;overflow-y:auto;animation:slideUp .3s ease}
    .modal-bg.center .modal{border-radius:20px;margin:20px}
    @keyframes slideUp{from{transform:translateY(100%)}}
    .modal-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-title{font-size:18px;font-weight:700}
    .modal-close{width:32px;height:32px;background:var(--input);border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .modal-close svg{width:16px;height:16px;stroke:var(--text2);stroke-width:2;fill:none}
    .learn-modal{max-height:92vh;max-width:600px}
    .learn-content{padding-bottom:20px}
    .learn-module{background:var(--input);border-radius:16px;padding:16px;margin-bottom:12px;cursor:pointer;transition:transform .2s}
    .learn-module:hover{transform:translateY(-2px)}
    .learn-module-icon{width:50px;height:50px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px}
    .learn-module-info{flex:1;margin-left:14px}
    .learn-module-title{font-weight:700;font-size:16px;margin-bottom:4px}
    .learn-module-desc{font-size:13px;color:var(--text2)}
    .learn-module-meta{display:flex;gap:12px;margin-top:8px}
    .learn-module-meta span{font-size:11px;color:var(--text3);background:var(--card);padding:4px 8px;border-radius:6px}
    .learn-chapter{background:var(--input);border-radius:12px;padding:14px;margin-bottom:10px;cursor:pointer;display:flex;align-items:center;gap:12px}
    .learn-chapter:hover{background:var(--border)}
    .learn-chapter-num{width:32px;height:32px;border-radius:50%;background:var(--card);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:var(--text2)}
    .learn-chapter-num.completed{background:var(--green);color:#fff}
    .learn-chapter-title{flex:1;font-size:14px;font-weight:500}
    .learn-chapter-dur{font-size:12px;color:var(--text3)}
    .lesson-content{font-size:15px;line-height:1.8;color:var(--text)}
    .lesson-content h2{font-size:22px;font-weight:700;margin:24px 0 12px;color:var(--text)}
    .lesson-content h3{font-size:18px;font-weight:600;margin:20px 0 10px;color:var(--text)}
    .lesson-content p{margin-bottom:16px}
    .lesson-content ul,.lesson-content ol{margin:16px 0;padding-left:24px}
    .lesson-content li{margin-bottom:8px}
    .lesson-content strong{color:var(--text);font-weight:600}
    .lesson-video{width:100%;aspect-ratio:16/9;border-radius:12px;background:#000;margin:20px 0 8px 0;overflow:hidden}
    .lesson-video iframe{width:100%;height:100%;border:none}
    .video-credit{font-size:12px;color:var(--text3);margin-bottom:16px;text-align:right}
    .video-credit a{color:var(--text3);text-decoration:underline}
    .lesson-img{width:100%;border-radius:12px;margin:20px 0}
    .lesson-callout{background:var(--input);border-left:4px solid var(--blue);padding:16px;border-radius:0 12px 12px 0;margin:20px 0}
    .lesson-callout.warning{border-color:var(--orange);background:var(--orange-bg)}
    .lesson-callout.success{border-color:var(--green);background:var(--green-bg)}
    .lesson-callout-title{font-weight:700;margin-bottom:6px}
    .quiz-container{background:var(--input);border-radius:16px;padding:20px;margin-top:24px}
    .quiz-question{font-size:16px;font-weight:600;margin-bottom:16px}
    .quiz-option{display:block;width:100%;text-align:left;padding:14px 16px;background:var(--card);border:2px solid var(--border);border-radius:12px;margin-bottom:10px;cursor:pointer;font-size:14px;transition:all .2s}
    .quiz-option:hover{border-color:var(--text3)}
    .quiz-option.selected{border-color:var(--blue);background:var(--blue-bg)}
    .quiz-option.correct{border-color:var(--green);background:var(--green-bg)}
    .quiz-option.incorrect{border-color:var(--red);background:var(--red-bg)}
    .callout{background:var(--input);border-left:4px solid var(--blue);padding:16px;border-radius:0 12px 12px 0;margin:20px 0}
    .callout.blue{border-color:var(--blue);background:var(--blue-bg)}
    .callout.green{border-color:var(--green);background:var(--green-bg)}
    .callout.orange{border-color:var(--orange);background:var(--orange-bg)}
    .callout.red{border-color:var(--red);background:var(--red-bg)}
    .callout.purple{border-color:var(--purple);background:var(--purple-bg)}
    .quiz-result{text-align:center;padding:20px;margin-top:16px;border-radius:12px}
    .quiz-result.passed{background:var(--green-bg);color:var(--green)}
    .quiz-result.failed{background:var(--red-bg);color:var(--red)}
    .progress-bar{height:6px;background:var(--border);border-radius:3px;margin:12px 0;overflow:hidden}
    .progress-bar-fill{height:100%;background:var(--green);border-radius:3px;transition:width .3s}
    .setting-row{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid var(--border)}
    .setting-row:last-child{border-bottom:none}
    .switch{width:50px;height:28px;background:var(--input);border-radius:14px;padding:2px;border:none;cursor:pointer}
    .switch.on{background:var(--green)}
    .switch-knob{width:24px;height:24px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
    .switch.on .switch-knob{transform:translateX(22px)}
    .profile-header{text-align:center;padding:20px 0}
    .profile-avatar{width:100px;height:100px;border-radius:50%;margin:0 auto 16px;background:linear-gradient(135deg,#f97316,#dc2626);display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer}
    .profile-avatar span{color:#fff;font-size:36px;font-weight:700}
    .profile-avatar-edit{position:absolute;bottom:0;right:0;width:32px;height:32px;background:var(--blue);border-radius:50%;display:flex;align-items:center;justify-content:center}
    .profile-avatar-edit svg{width:16px;height:16px;stroke:#fff;stroke-width:2;fill:none}
    .profile-name{font-size:24px;font-weight:700}
    .profile-email{font-size:14px;color:var(--text2);margin-bottom:16px}
    .profile-badge{display:inline-flex;padding:8px 16px;background:var(--text);border-radius:20px;font-size:13px;font-weight:600;color:var(--bg)}
    .profile-stats{display:flex;justify-content:space-around;padding:20px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border);margin:20px 0}
    .profile-stat{text-align:center}.profile-stat-val{font-size:20px;font-weight:700}.profile-stat-label{font-size:12px;color:var(--text2)}
    .signal-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px;position:relative}
    .signal-card.locked::after{content:'';position:absolute;inset:0;background:var(--bg);opacity:.85;border-radius:16px}
    .signal-header{display:flex;justify-content:space-between;margin-bottom:12px}
    .signal-type{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700}
    .signal-type.csp{background:var(--green-bg);color:var(--green)}
    .signal-type.cc{background:var(--blue-bg);color:var(--blue)}
    .signal-time{font-size:12px;color:var(--text3)}
    .signal-ticker{font-size:20px;font-weight:700}
    .signal-details{font-size:14px;color:var(--text2);margin:4px 0 12px}
    .signal-lock{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1}
    .signal-lock svg{width:24px;height:24px;stroke:var(--text3);stroke-width:1.5;margin-bottom:6px}
    .signal-lock span{font-weight:500;color:var(--text2);font-size:13px}
    .wheely-avatar{width:48px;height:48px;background:linear-gradient(145deg,#6366f1,#4f46e5);border-radius:14px;position:relative;display:flex;align-items:center;justify-content:center}
    .wheely-face{width:36px;height:20px;background:#fff;border-radius:6px;display:flex;align-items:center;justify-content:center;gap:10px}
    .wheely-eye{width:6px;height:8px;background:#4f46e5;border-radius:2px;animation:blink 3s infinite}
    @keyframes blink{0%,94%,100%{transform:scaleY(1)}96%{transform:scaleY(.1)}}
    .wheely-antenna{position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:3px;height:8px;background:#6366f1;border-radius:2px}
    .wheely-antenna::after{content:'';position:absolute;top:-5px;left:50%;transform:translateX(-50%);width:8px;height:8px;background:#a5b4fc;border-radius:50%}
    .ai-header{display:flex;align-items:center;gap:12px;margin-bottom:20px}
    .ai-info h3{font-size:16px;font-weight:700}.ai-info p{font-size:12px;color:var(--text2)}
    .ai-messages{min-height:200px;max-height:300px;overflow-y:auto;margin-bottom:16px}
    .ai-msg{padding:12px;border-radius:12px;margin-bottom:8px;font-size:14px;line-height:1.5;max-width:85%}
    .ai-msg.user{background:var(--blue);color:#fff;margin-left:auto}
    .ai-msg.bot{background:var(--input)}
    .legal-content{font-size:13px;line-height:1.7;color:var(--text2);max-height:50vh;overflow-y:auto;margin-bottom:20px;padding:16px;background:var(--input);border-radius:12px}
    .legal-content h3{color:var(--text);margin:16px 0 8px;font-size:14px}
    .legal-content h3:first-child{margin-top:0}
    .legal-checkbox{display:flex;align-items:flex-start;gap:12px;margin-bottom:20px}
    .legal-checkbox input{width:20px;height:20px;margin-top:2px;accent-color:var(--blue)}
    .legal-checkbox label{font-size:13px;color:var(--text2)}
    .footer{padding:20px 16px;text-align:center;font-size:11px;color:var(--text3)}
    .footer a{color:var(--text2);margin:0 8px}
    .loading{display:flex;justify-content:center;padding:40px}
    .spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none!important}
    .mt-4{margin-top:16px}
    .live-dot{display:inline-block;width:8px;height:8px;background:var(--green);border-radius:50%;margin-right:6px;animation:pulse 2s infinite}
    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 24px;font-size:14px;font-weight:500;box-shadow:0 4px 20px rgba(0,0,0,.3);z-index:300;opacity:0;transition:all .3s ease}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.success{border-color:var(--green);background:var(--green-bg);color:var(--green)}
    .toast.error{border-color:var(--red);background:var(--red-bg);color:var(--red)}
    .confetti{position:fixed;width:10px;height:10px;z-index:400;animation:fall linear forwards}
    @keyframes fall{to{transform:translateY(100vh) rotate(720deg);opacity:0}}
    .celebration-overlay{position:fixed;inset:0;z-index:350;pointer-events:none;display:flex;align-items:center;justify-content:center}
    .celebration-text{font-size:48px;font-weight:800;color:var(--green);text-shadow:0 4px 20px rgba(52,199,89,.5);animation:celebratePop .6s ease-out}
    @keyframes celebratePop{0%{transform:scale(0);opacity:0}50%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}
    .post-actions{display:flex;gap:6px;margin-top:8px}
    .post-action-btn{padding:4px 10px;border:none;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer}
    .post-action-btn.winner{background:var(--green-bg);color:var(--green)}
    .post-action-btn.roll{background:var(--purple-bg);color:var(--purple)}
    .post-action-btn.delete{background:var(--red-bg);color:var(--red)}
    .status-badge{padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700;margin-left:6px}
    .status-badge.open{background:var(--blue-bg);color:var(--blue)}
    .status-badge.winner{background:var(--green-bg);color:var(--green)}
    .status-badge.rolled{background:var(--purple-bg);color:var(--purple)}
    .status-badge.closed{background:var(--text3);color:var(--bg)}
    .position-select{width:100%;background:var(--input);border:1px solid var(--border);border-radius:12px;padding:14px 16px;font-size:15px;color:var(--text);outline:none;cursor:pointer}
    .auth-container{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:0;background:var(--bg)}
    .auth-container > div{width:100%;max-width:420px;min-height:100vh;display:flex;flex-direction:column;background:var(--bg)}
    @media(min-width:600px){
      .auth-container{background:var(--bg)}
      .auth-container > div{min-height:auto;background:var(--card);border-radius:24px;box-shadow:0 8px 32px rgba(0,0,0,0.08);margin:40px 20px;padding-bottom:0}
      .auth-content{padding:32px 40px 24px}
      .auth-terms{padding:20px 40px}
      .auth-switch{padding:16px 40px 32px}
    }
    .auth-header{padding:40px 24px 0;display:flex;flex-direction:column;align-items:center;gap:6px}
    @media(min-width:600px){.auth-header{padding:40px 40px 0}}
    .auth-logo-img{height:40px;width:auto}
    .auth-back{width:40px;height:40px;border:none;background:none;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .auth-back svg{width:24px;height:24px;stroke:var(--text1);stroke-width:2;fill:none}
    .auth-page-title{font-size:13px;font-weight:600;color:var(--text3);letter-spacing:1px;text-transform:uppercase}
    .auth-content{flex:1;padding:20px 24px}
    .auth-welcome{font-size:26px;font-weight:700;color:var(--text1);margin-bottom:6px;text-align:center}
    @media(min-width:600px){.auth-welcome{font-size:30px}}
    .auth-subtitle{font-size:14px;color:var(--text2);margin-bottom:28px;line-height:1.5;text-align:center}
    @media(min-width:600px){.auth-subtitle{font-size:15px}}
    .float-input{position:relative;margin-bottom:20px}
    .float-input input{width:100%;padding:20px 16px 8px;font-size:16px;border:2px solid #e5e5e5;border-radius:12px;background:#fff;outline:none;transition:all .2s;box-sizing:border-box}
    .float-input input:focus{border-color:#1a1a1a;box-shadow:0 0 0 4px rgba(0,0,0,0.04)}
    .float-input input:hover:not(:focus){border-color:#ccc}
    .float-input label{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:16px;color:#999;pointer-events:none;transition:all .2s}
    .float-input input:focus+label,.float-input input:not(:placeholder-shown)+label{top:12px;transform:translateY(0);font-size:11px;color:#666;font-weight:500}
    .float-input .toggle-pass{position:absolute;right:16px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px}
    .float-input .toggle-pass svg{width:20px;height:20px;stroke:#999;stroke-width:1.5;fill:none}
    .pass-requirements{margin-bottom:24px}
    .pass-requirements p{font-size:13px;color:#666;margin-bottom:12px;font-weight:500}
    .pass-checks{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .pass-check{display:flex;align-items:center;gap:8px;font-size:13px;color:#999}
    .pass-check .check-circle{width:18px;height:18px;border:1.5px solid #ddd;border-radius:50%;display:flex;align-items:center;justify-content:center}
    .pass-check.valid{color:#1a1a1a}
    .pass-check.valid .check-circle{background:#1a1a1a;border-color:#1a1a1a}
    .pass-check.valid .check-circle::after{content:'‚úì';color:#fff;font-size:10px}
    .auth-btn{width:100%;padding:16px;font-size:16px;font-weight:600;border:none;border-radius:12px;cursor:pointer;transition:all .2s}
    .auth-btn.primary{background:var(--text1);color:var(--bg)}
    .auth-btn.primary:hover{opacity:0.85;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
    .auth-btn.primary:active{transform:translateY(0);box-shadow:none}
    .auth-btn.primary:disabled{background:var(--border);color:var(--text3);cursor:not-allowed;transform:none;box-shadow:none}
    .auth-btn.secondary{background:var(--card);color:var(--text1);border:2px solid var(--border)}
    .auth-btn.secondary:hover{border-color:var(--text1);background:var(--input)}
    .auth-btn.google{background:var(--card);color:var(--text1);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:12px}
    .auth-btn.google:hover{border-color:var(--blue);background:var(--input)}
    .auth-btn.google svg{flex-shrink:0}
    .auth-terms{font-size:12px;color:var(--text3);text-align:center;margin-top:auto;padding:24px;line-height:1.6}
    .auth-terms a{color:var(--text1);text-decoration:underline}
    .auth-switch{text-align:center;padding:20px;font-size:14px;color:var(--text2);border-top:1px solid var(--border)}
    @media(min-width:600px){.auth-switch{background:var(--input);border-radius:0 0 24px 24px}}
    .auth-switch a{color:var(--text1);font-weight:600;text-decoration:none}
    .auth-switch a:hover{text-decoration:underline}
    .auth-divider{display:flex;align-items:center;gap:12px;margin:24px 0;color:#999;font-size:13px}
    .auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:#e5e5e5}
    .confirm-modal{background:var(--card);border-radius:20px;padding:24px;max-width:320px;margin:20px;text-align:center}
    .confirm-title{font-size:18px;font-weight:700;color:var(--text);margin-bottom:8px}
    .confirm-message{font-size:14px;color:var(--text2);margin-bottom:24px;line-height:1.5}
    .confirm-buttons{display:flex;gap:12px}
    .premium-modal{background:#fff;border-radius:24px;padding:32px 24px;text-align:center;max-width:340px;margin:20px}
    .premium-modal-icon{font-size:80px;margin-bottom:16px}
    .premium-modal h2{font-size:24px;font-weight:700;margin-bottom:12px;color:#1a1a1a}
    .premium-modal p{font-size:15px;color:#666;line-height:1.5;margin-bottom:24px}
    .premium-modal .float-input{text-align:left}
    .premium-features{text-align:left;margin:20px 0}
    .premium-feature{display:flex;align-items:center;gap:12px;padding:10px 0;font-size:14px;color:#1a1a1a}
    .premium-feature svg{width:20px;height:20px;stroke:#22c55e;stroke-width:2.5;fill:none}
    .status-badge.assigned{background:var(--orange-bg);color:var(--orange)}
    .status-badge.called{background:var(--blue-bg);color:var(--blue)}
    .post-action-btn.assigned{background:var(--orange-bg);color:var(--orange)}
    .post-action-btn.called{background:var(--blue-bg);color:var(--blue)}
    .home-alerts{margin-top:16px}
    .home-alert-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:12px}
    .home-alert-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
    .home-alert-content{flex:1}
    .home-alert-title{font-size:13px;font-weight:600}
    .home-alert-sub{font-size:11px;color:var(--text2)}
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div class="auth-container" id="authScreen">
    <div id="authLogin">
      <div class="auth-header">
        <img src="logo.png" alt="Market Elites" class="auth-logo-img" onerror="this.style.display='none'">
        <span class="auth-page-title">Market Elites</span>
      </div>
      <div class="auth-content">
        <div class="auth-welcome">Welcome back</div>
        <div class="auth-subtitle">Track your wheel strategy, get live signals, and learn to generate consistent income from options.</div>

        <div class="float-input">
          <input type="email" id="loginEmail" placeholder=" " autocomplete="email">
          <label>Email</label>
        </div>

        <div class="float-input">
          <input type="password" id="loginPassword" placeholder=" " autocomplete="current-password">
          <label>Password</label>
          <button class="toggle-pass" onclick="togglePasswordVisibility('loginPassword', this)">
            <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:#666;cursor:pointer">
            <input type="checkbox" id="rememberMe" style="width:18px;height:18px;accent-color:#1a1a1a;cursor:pointer">
            Remember me
          </label>
          <a href="#" onclick="showForgotPassword();return false" style="font-size:13px;color:#1a1a1a;font-weight:500;text-decoration:none">Forgot password?</a>
        </div>

        <button class="auth-btn primary" onclick="handleLogin()">Sign In</button>

        <div class="auth-divider">or</div>

        <button class="auth-btn google" onclick="handleGoogleSignIn()">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Continue with Google
        </button>

        <button class="auth-btn google" onclick="handleAppleSignIn()" style="background:#fff;color:#1a1a1a;border-color:#e5e5e5">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="#1a1a1a" d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/></svg>
          Continue with Apple
        </button>

        <button class="auth-btn secondary" onclick="handleGuestLogin()">Continue as Guest</button>
      </div>
      <div class="auth-terms">
        By continuing, you agree to Market Elites'<br><a href="#">Terms of Use</a> and <a href="#">Privacy Policy</a>.
      </div>
      <div class="auth-switch">Don't have an account? <a href="#" onclick="showAuthTab('signup');return false">Sign up</a></div>
    </div>

    <div id="authSignup" class="hidden">
      <div class="auth-header">
        <button class="auth-back" onclick="showAuthTab('login')">
          <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </button>
        <span class="auth-page-title">Create Account</span>
      </div>
      <div class="auth-content">
        <div class="float-input">
          <input type="text" id="signupName" placeholder=" " autocomplete="name">
          <label>Full Name</label>
        </div>

        <div class="float-input">
          <input type="email" id="signupEmail" placeholder=" " autocomplete="email">
          <label>Email</label>
        </div>

        <div class="float-input">
          <input type="password" id="signupPassword" placeholder=" " autocomplete="new-password" oninput="checkPasswordStrength()">
          <label>Password</label>
          <button class="toggle-pass" onclick="togglePasswordVisibility('signupPassword', this)">
            <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>

        <div class="pass-requirements">
          <p>Password must contain:</p>
          <div class="pass-checks">
            <div class="pass-check" id="passLength"><span class="check-circle"></span>8+ characters</div>
            <div class="pass-check" id="passNumber"><span class="check-circle"></span>Number</div>
            <div class="pass-check" id="passLower"><span class="check-circle"></span>Lowercase letter</div>
            <div class="pass-check" id="passSpecial"><span class="check-circle"></span>Special character</div>
            <div class="pass-check" id="passUpper"><span class="check-circle"></span>Uppercase letter</div>
          </div>
        </div>

        <button class="auth-btn primary" id="signupBtn" onclick="handleSignup()" disabled>Create Account</button>

        <div class="auth-divider">or</div>

        <button class="auth-btn google" onclick="handleGoogleSignIn()">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Sign up with Google
        </button>

        <button class="auth-btn google" onclick="handleAppleSignIn()" style="background:#fff;color:#1a1a1a;border-color:#e5e5e5">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="#1a1a1a" d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/></svg>
          Sign up with Apple
        </button>
      </div>
      <div class="auth-terms">
        By creating an account, you agree to Market Elites'<br><a href="#" onclick="openModal('legalModal');return false">Terms of Use</a> and <a href="#" onclick="openModal('legalModal');return false">Privacy Policy</a>.
      </div>
      <div class="auth-switch">Already have an account? <a href="#" onclick="showAuthTab('login');return false">Sign in</a></div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-bg center" id="confirmModal" onclick="closeModal('confirmModal')">
    <div class="confirm-modal" onclick="event.stopPropagation()">
      <div class="confirm-title" id="confirmTitle">Are you sure?</div>
      <div class="confirm-message" id="confirmMessage">This action cannot be undone.</div>
      <div class="confirm-buttons">
        <button class="btn btn-outline" onclick="closeModal('confirmModal')" style="flex:1">Cancel</button>
        <button class="btn" id="confirmAction" onclick="closeModal('confirmModal')" style="flex:1">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Premium Popup Modal -->
  <div class="modal-bg center" id="premiumPopup" onclick="closeModal('premiumPopup')">
    <div class="premium-modal" onclick="event.stopPropagation()">
      <div class="premium-modal-icon">üîîüìà</div>
      <h2>Never miss a trade</h2>
      <p>Get instant alerts the second a new signal drops ‚Äì no noise, just actionable moves.</p>

      <div class="premium-features">
        <div class="premium-feature"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Real-time trading signals</div>
        <div class="premium-feature"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Email & Discord alerts</div>
        <div class="premium-feature"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Full position history</div>
        <div class="premium-feature"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Priority support</div>
      </div>

      <div class="float-input" style="margin-top:20px">
        <input type="email" id="premiumEmail" placeholder=" ">
        <label>Your email</label>
      </div>

      <button class="auth-btn primary" onclick="submitPremiumInterest()" style="margin-bottom:12px">Turn on alerts</button>
      <button class="auth-btn secondary" onclick="dismissAlertsPopup()">Not now</button>
    </div>
  </div>

  <div class="modal-bg center" id="legalModal">
    <div class="modal">
      <div class="modal-header"><span class="modal-title">Terms & Risk Disclosure</span></div>
      <div class="legal-content">
        <h3>‚ö†Ô∏è Risk Disclosure</h3>
        <p>Options trading involves substantial risk of loss. You could lose more than your initial investment.</p>
        <h3>üìã Not Financial Advice</h3>
        <p>Market Elites is for educational purposes only. Nothing herein constitutes investment advice.</p>
        <h3>üîê Data Privacy</h3>
        <p>Your data is stored locally. API keys are never transmitted to our servers.</p>
      </div>
      <div class="legal-checkbox">
        <input type="checkbox" id="legalAgree" onchange="document.getElementById('legalBtn').disabled=!this.checked">
        <label for="legalAgree">I understand the risks and agree to these terms.</label>
      </div>
      <button class="btn" id="legalBtn" onclick="acceptLegal()" disabled>Accept & Continue</button>
    </div>
  </div>

  <div class="app">
    <div class="tab active" id="homeTab">
      <div class="hero">
        <div class="hero-top">
          <div class="hero-left">
            <button class="icon-btn" onclick="openSettings()">
              <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </button>
            <button class="avatar-btn" onclick="goToProfile()"><span id="heroInitials">?</span></button>
          </div>
          <div class="status" id="statusPill"><span class="status-dot"></span><span id="statusText">Offline</span></div>
        </div>
        <div class="hero-balance">
          <div class="balance-label">Portfolio Value</div>
          <div class="balance-amount">$<span id="balanceVal">25,000</span></div>
          <div class="balance-change" id="balanceChange">‚Üë +$0 (0%)</div>
        </div>
        <div class="hero-actions">
          <button class="hero-btn" onclick="goCalc('csp')"><div class="hero-btn-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12l4 4 4-4"/></svg></div><span>CSP Calc</span></button>
          <button class="hero-btn" onclick="openAdd()"><div class="hero-btn-icon"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg></div><span>Add Trade</span></button>
          <button class="hero-btn" onclick="goCalc('cc')"><div class="hero-btn-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16V8M8 12l4-4 4 4"/></svg></div><span>CC Calc</span></button>
          <button class="hero-btn" onclick="syncPositions()"><div class="hero-btn-icon"><svg viewBox="0 0 24 24"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg></div><span>Sync</span></button>
        </div>
      </div>
      <div class="quick-actions">
        <button class="quick-btn" onclick="openLearn()"><div class="quick-icon blue"><svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg></div><span>Learn</span></button>
        <button class="quick-btn" onclick="openAnalytics()"><div class="quick-icon green"><svg viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg></div><span>Analytics</span></button>
        <button class="quick-btn" onclick="openAI()"><div class="quick-icon purple"><svg viewBox="0 0 24 24"><rect x="3" y="8" width="18" height="12" rx="2"/><path d="M7 8V6a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2"/><circle cx="9" cy="14" r="1.5"/><circle cx="15" cy="14" r="1.5"/></svg></div><span>Wheely</span></button>
        <button class="quick-btn" onclick="nav('signals')"><div class="quick-icon orange"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div><span>Signals</span></button>
      </div>
      <div class="section" id="alertsFeedSection" style="display:none"><div class="section-header"><span class="section-title">Latest Alerts</span><button class="section-link" onclick="nav('signals')">See All</button></div><div id="alertsFeedContainer"></div></div>
      <div class="section" id="guestBanner" style="display:none">
        <div style="background:linear-gradient(135deg,#1a1a1a,#333);border-radius:16px;padding:20px;text-align:center">
          <div style="font-size:24px;margin-bottom:8px">üëã</div>
          <div style="font-size:16px;font-weight:600;color:#fff;margin-bottom:4px">You're browsing as a guest</div>
          <div style="font-size:13px;color:#999;margin-bottom:16px">Create an account to save your portfolio and get alerts</div>
          <button class="btn" onclick="promptCreateAccount()" style="background:#fff;color:#1a1a1a">Create Free Account</button>
        </div>
      </div>
      <div class="section" id="newUserBanner" style="display:none">
        <div style="background:linear-gradient(135deg,var(--blue),var(--purple));border-radius:16px;padding:20px;text-align:center;cursor:pointer" onclick="openLearn();dismissNewUser()">
          <div style="font-size:24px;margin-bottom:8px">üé°</div>
          <div style="font-size:16px;font-weight:600;color:#fff;margin-bottom:4px">New to the Wheel Strategy?</div>
          <div style="font-size:13px;color:rgba(255,255,255,0.8);margin-bottom:12px">Learn how to generate consistent income selling options ‚Äî from the basics to advanced setups.</div>
          <div style="display:inline-flex;padding:10px 20px;background:rgba(255,255,255,0.2);border-radius:12px;font-size:14px;font-weight:600;color:#fff">Start Learning ‚Üí</div>
        </div>
      </div>
      <div class="section"><div class="section-header"><span class="section-title">Active Positions</span></div><div id="positionsContainer"></div></div>
      <div class="section"><div class="section-header"><span class="section-title">Recent Trades</span></div><div id="historyContainer"></div></div>
      <div class="footer"><a href="#" onclick="openModal('legalModal');return false">Terms</a>‚Ä¢<a href="#" onclick="openModal('legalModal');return false">Privacy</a>‚Ä¢<a href="#" onclick="openModal('legalModal');return false">Disclaimer</a><p style="margin-top:8px" onclick="secretAdminTap()">¬© 2026 Market Elites. Not financial advice.</p></div>
    </div>

    <div class="tab" id="calcTab">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span class="card-title" style="margin:0">Options Calculator</span><button class="help-btn" onclick="openLearn()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></button></div>
        <div class="toggle"><button class="toggle-btn active" id="cspBtn" onclick="setMode('csp')">Cash Secured Put</button><button class="toggle-btn" id="ccBtn" onclick="setMode('cc')">Covered Call</button></div>
        <div class="search-row"><input type="text" class="search-input" id="tickerInput" placeholder="AAPL" maxlength="5"><button class="search-btn" onclick="searchTicker()"><svg viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button></div>
        <div class="tickers"><button class="ticker-btn" onclick="qSearch('AAPL')">AAPL</button><button class="ticker-btn" onclick="qSearch('NVDA')">NVDA</button><button class="ticker-btn" onclick="qSearch('TSLA')">TSLA</button><button class="ticker-btn" onclick="qSearch('SPY')">SPY</button></div>
      </div>
      <div class="card hidden" id="loadingCard"><div class="loading"><div class="spinner"></div></div></div>
      <div class="card hidden" id="stockCard"><div style="font-size:24px;font-weight:700" id="stockSymbol">AAPL</div><div style="font-size:13px;color:var(--text2)" id="stockName">Apple Inc.</div><div style="font-size:36px;font-weight:700;margin:8px 0">$<span id="stockPrice">0.00</span></div></div>
      <div class="card hidden" id="optCard"><div class="card-title">Select Contract</div><div class="form-group"><label class="form-label">Expiration</label><select class="form-select" id="expSelect" onchange="onExpChange()"><option>Select...</option></select></div><div class="form-group"><label class="form-label">Strike</label><select class="form-select" id="strikeSelect" onchange="onStrikeChange()"><option>Select...</option></select></div></div>
      <div class="card hidden" id="resultCard"><div class="card-title">Analysis</div><div class="stats-grid"><div class="stat-box"><div class="stat-val green">$<span id="resPrem">0</span></div><div class="stat-label">Premium</div></div><div class="stat-box"><div class="stat-val blue"><span id="resAnn">0</span>%</div><div class="stat-label">Annualized</div></div><div class="stat-box"><div class="stat-val"><span id="resProb">0</span>%</div><div class="stat-label">Prob. Profit</div></div><div class="stat-box"><div class="stat-val"><span id="resCon">1</span></div><div class="stat-label">Contracts</div></div></div><button class="btn mt-4" onclick="addFromCalc()"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>Add to Portfolio</button></div>
      <div class="card" id="emptyCalc"><div class="empty" style="background:transparent;border:none"><div class="empty-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></div><div class="empty-title">Search a Symbol</div><div class="empty-text">Enter a ticker to see live options data</div><div style="display:flex;align-items:center;justify-content:center;gap:6px;margin:12px 0;padding:8px 16px;background:var(--green-bg);border-radius:20px;font-size:12px;color:var(--green);font-weight:600"><span class="live-dot"></span>Live pricing ‚Ä¢ No login required</div><button class="btn btn-outline" style="width:auto;margin:0 auto" onclick="openLearn()">New? Learn the basics ‚Üí</button></div></div>
    </div>

    <div class="tab" id="watchTab"><div class="section" style="padding-top:16px"><div class="section-header"><span class="section-title">Watchlist</span><button class="section-link" onclick="refreshWatch()">‚Üª Refresh</button></div><div id="watchContainer"></div></div></div>

    <div class="tab" id="signalsTab"><div class="section" style="padding-top:16px"><div class="section-header"><span class="section-title">Live Signals</span></div><p style="font-size:13px;color:var(--text2);margin-bottom:8px">Real-time wheel plays from our team</p><div id="exampleDisclaimer" style="padding:10px 14px;background:var(--input);border-radius:10px;margin-bottom:16px;font-size:12px;color:var(--text3)">Below are <b>example signals</b> showing what premium alerts look like. Subscribe to receive live plays.</div><div id="signalsContainer"></div></div></div>

    <div class="tab" id="alertsTab"><div class="section" style="padding-top:16px"><div class="section-header"><span class="section-title">Alerts</span></div><div id="alertsContainer"></div></div></div>

    <div class="tab" id="profileTab">
      <div class="card">
        <div class="profile-header">
          <div class="profile-avatar" onclick="$('avatarInput').click()">
            <img id="profileAvatarImg" src="" style="width:100%;height:100%;border-radius:50%;object-fit:cover;display:none">
            <span id="profileInitials">?</span>
            <div class="profile-avatar-edit"><svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg></div>
          </div>
          <input type="file" id="avatarInput" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)">
          <div class="profile-name" id="profileName" onclick="secretPremiumTap()">Set up your profile</div>
          <div class="profile-email" id="profileEmail">Tap to edit</div>
          <div class="profile-badge hidden" id="proBadge">Premium Member</div>
        </div>
        <div class="profile-stats">
          <div class="profile-stat"><div class="profile-stat-val" id="pTrades">0</div><div class="profile-stat-label">Trades</div></div>
          <div class="profile-stat"><div class="profile-stat-val" id="pWinRate">0%</div><div class="profile-stat-label">Win Rate</div></div>
          <div class="profile-stat"><div class="profile-stat-val" id="pPremium">$0</div><div class="profile-stat-label">Premium</div></div>
        </div>
      </div>
      <div class="card"><div class="card-title">Account</div><div class="form-group"><label class="form-label">Display Name</label><input type="text" class="form-input" id="userName" placeholder="Your name"></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="userEmail" placeholder="email@example.com"></div><div class="form-group"><label class="form-label">Phone (for SMS alerts)</label><input type="tel" class="form-input" id="userPhone" placeholder="+1 555 123 4567"></div><button class="btn btn-outline" onclick="saveProfile()">Save Profile</button></div>
      <div class="card" id="alertPrefsCard" style="display:none"><div class="card-title">Alert Notifications</div><p style="font-size:13px;color:var(--text2);margin-bottom:16px">Get notified instantly when new signals are posted</p><div class="setting-row"><span>Discord Alerts</span><button class="switch" id="discordSwitch" onclick="toggleDiscordAlerts()"><div class="switch-knob"></div></button></div><div class="setting-row"><span>SMS Alerts</span><button class="switch" id="smsSwitch" onclick="toggleSmsAlerts()"><div class="switch-knob"></div></button></div><p style="font-size:11px;color:var(--text3);margin-top:12px">SMS alerts require phone number above</p></div>
      <div class="card"><div class="card-title">Brokerage (Optional)</div><div style="padding:12px;background:var(--green-bg);border-radius:12px;margin-bottom:16px;font-size:13px;color:var(--green)"><span class="live-dot"></span><b>Live pricing works without login!</b><br><span style="opacity:0.8">Connect Alpaca only to sync your actual positions.</span></div><div id="brokerStatus"></div><div class="form-group"><label class="form-label">Alpaca API Key</label><input type="text" class="form-input" id="apiKeyInput" placeholder="PK..."></div><div class="form-group"><label class="form-label">Secret Key</label><input type="password" class="form-input" id="secretKeyInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div><div class="form-group"><label class="form-label">Account Size ($)</label><input type="number" class="form-input" id="accSizeInput" value="25000"></div><button class="btn" onclick="connectBroker()">Connect</button></div>
      <div class="card"><div class="card-title">Preferences</div><div class="setting-row"><span>Dark Mode</span><button class="switch" id="themeSwitch" onclick="toggleTheme()"><div class="switch-knob"></div></button></div><div class="setting-row"><span>Notifications</span><button class="switch" id="notifSwitch" onclick="toggleNotif()"><div class="switch-knob"></div></button></div></div>
      <div class="card" id="proCard"><div style="text-align:center"><div style="font-size:18px;font-weight:700;margin-bottom:8px">Upgrade to Premium</div><div style="font-size:13px;color:var(--text2);margin-bottom:20px">Unlock live signals & more</div><button class="btn" onclick="openPremium()">Get Premium ¬∑ $9.99/mo</button></div></div>
      <div style="padding:16px;margin-bottom:100px">
        <button class="btn" onclick="confirmSignOut()" style="width:100%;background:transparent;border:2px solid var(--red);color:var(--red)">Sign Out</button>
      </div>
    </div>
  </div>

  <nav class="nav"><div class="nav-inner">
    <button class="nav-btn active" data-tab="home" onclick="nav('home')"><svg viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span>Home</span></button>
    <button class="nav-btn" data-tab="calc" onclick="nav('calc')"><svg viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M8 6h8M8 10h8M8 14h4"/></svg><span>Calc</span></button>
    <button class="nav-btn" data-tab="watch" onclick="nav('watch')"><svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg><span>Watch</span></button>
    <button class="nav-btn" data-tab="signals" onclick="nav('signals')"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><span>Signals</span></button>
    <button class="nav-btn" data-tab="profile" onclick="goToProfile()"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><span>Profile</span></button>
  </div></nav>

  <div class="modal-bg" id="settingsModal" onclick="closeModal('settingsModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div><div class="modal-header"><span class="modal-title">Quick Settings</span><button class="modal-close" onclick="closeModal('settingsModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
    <div class="setting-row"><span>Dark Mode</span><button class="switch" id="qThemeSwitch" onclick="toggleTheme()"><div class="switch-knob"></div></button></div>
    <div class="setting-row"><span>Notifications</span><button class="switch" id="qNotifSwitch" onclick="toggleNotif()"><div class="switch-knob"></div></button></div>
    <div style="padding:12px 0;border-bottom:1px solid var(--border)">
      <div class="form-group" style="margin-bottom:8px"><label class="form-label">Email for Alerts</label><input type="email" class="form-input" id="userAlertEmail" placeholder="your@email.com"></div>
      <div class="setting-row" style="padding:8px 0"><span>Receive Email Alerts</span><button class="switch" id="emailAlertSwitch" onclick="toggleEmailAlerts()"><div class="switch-knob"></div></button></div>
      <button class="btn btn-outline" onclick="saveEmailSubscription()" style="width:100%">Save Email Preferences</button>
    </div>
    <div style="padding:16px 0;border-bottom:1px solid var(--border)"><div class="form-group" style="margin-bottom:12px"><label class="form-label">Twelve Data API Key (Live Market Data)</label><input type="password" class="form-input" id="qTwelveKey" placeholder="Your API key..."></div><p style="font-size:11px;color:var(--text3);margin-bottom:12px">Free: 800 req/day. Get key at <a href="https://twelvedata.com/register" target="_blank" style="color:var(--blue)">twelvedata.com</a></p><button class="btn btn-outline" onclick="saveTwelveDataKey()" style="margin-bottom:12px">Save Market Data Key</button></div>
    <div style="padding:16px 0;border-bottom:1px solid var(--border)"><div class="form-group" style="margin-bottom:12px"><label class="form-label">Groq API Key (Free ‚Äî powers Wheely AI)</label><input type="password" class="form-input" id="qGroqKey" placeholder="gsk_..."></div><p style="font-size:11px;color:var(--text3);margin-bottom:12px">Get a free key at <a href="https://console.groq.com" target="_blank" style="color:var(--blue)">console.groq.com</a></p><button class="btn btn-outline" onclick="saveGroqKey()" style="margin-bottom:12px">Save AI Key</button></div>
    <div style="padding:16px 0;border-bottom:1px solid var(--border)"><div class="form-group" style="margin-bottom:12px"><label class="form-label">Alpaca API Key (Broker Sync)</label><input type="text" class="form-input" id="qApiKey" placeholder="PK..."></div><div class="form-group" style="margin-bottom:12px"><label class="form-label">Secret Key</label><input type="password" class="form-input" id="qSecretKey" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div><button class="btn btn-outline" onclick="quickSaveApi()">Save Broker Keys</button></div>
    <button class="btn btn-red mt-4" onclick="confirmSignOut()"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Sign Out</button>
  </div></div>

  <div class="modal-bg" id="addModal" onclick="closeModal('addModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div><div class="modal-header"><span class="modal-title">Add Position</span><button class="modal-close" onclick="closeModal('addModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div class="toggle"><button class="toggle-btn active" id="addCspBtn" onclick="setAddMode('csp')">CSP</button><button class="toggle-btn" id="addCcBtn" onclick="setAddMode('cc')">CC</button><button class="toggle-btn" id="addSharesBtn" onclick="setAddMode('shares')">Shares</button></div><div class="form-group"><label class="form-label">Symbol</label><input type="text" class="form-input" id="addSymbol" placeholder="AAPL" style="text-transform:uppercase" maxlength="5"></div><div id="optFields"><div class="form-group"><label class="form-label">Strike</label><input type="number" class="form-input" id="addStrike" placeholder="150" step="0.5"></div><div class="form-group"><label class="form-label">Expiration</label><input type="date" class="form-input" id="addExp"></div><div class="form-group"><label class="form-label">Premium</label><input type="number" class="form-input" id="addPremium" placeholder="2.50" step="0.01"></div></div><div id="shareFields" class="hidden"><div class="form-group"><label class="form-label">Cost Basis</label><input type="number" class="form-input" id="addCost" placeholder="150" step="0.01"></div></div><div class="form-group"><label class="form-label">Contracts</label><input type="number" class="form-input" id="addContracts" value="1" min="1"></div><button class="btn" onclick="savePosition()">Add Position</button></div></div>

  <div class="modal-bg" id="learnModal" onclick="closeModal('learnModal')">
    <div class="modal learn-modal" onclick="event.stopPropagation()">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <button class="auth-back" id="learnBackBtn" onclick="goBackLearn()" style="display:none"><svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
        <span class="modal-title" id="learnTitle">Elite Trading Academy</span>
        <button class="modal-close" onclick="closeModal('learnModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
      </div>
      <div id="learnContent" class="learn-content"></div>
    </div>
  </div>

  <div class="modal-bg" id="analyticsModal" onclick="closeModal('analyticsModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div><div class="modal-header"><span class="modal-title">Analytics</span><button class="modal-close" onclick="closeModal('analyticsModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div id="analyticsContent"></div></div></div>

  <div class="modal-bg" id="aiModal" onclick="closeModal('aiModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div>
    <div class="ai-header">
      <div class="wheely-avatar"><div class="wheely-antenna"></div><div class="wheely-face"><div class="wheely-eye"></div><div class="wheely-eye"></div></div></div>
      <div class="ai-info"><h3>Wheely</h3><p>Your wheel strategy assistant</p></div>
    </div>
    <div class="ai-messages" id="aiMessages"></div>
    <div class="search-row"><input type="text" class="form-input" id="aiInput" placeholder="Ask Wheely..." style="flex:1" onkeydown="if(event.key==='Enter')sendAI()"><button class="search-btn" onclick="sendAI()" style="width:48px;height:48px"><svg viewBox="0 0 24 24"><path d="m22 2-7 20-4-9-9-4Z"/></svg></button></div>
  </div></div>

  <div class="modal-bg" id="posModal" onclick="closeModal('posModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div><div class="modal-header"><span class="modal-title" id="posTitle">Position</span><button class="modal-close" onclick="closeModal('posModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div id="posContent"></div><div style="display:flex;gap:12px;margin-top:20px"><button class="btn btn-red" style="flex:1" onclick="closePosition()">Close</button><button class="btn" style="flex:1" onclick="closeModal('posModal')">Done</button></div></div></div>

  <div class="modal-bg" id="premiumModal" onclick="closeModal('premiumModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div>
    <div style="text-align:center;padding:20px 0"><div style="font-size:28px;font-weight:700">Premium</div><div style="font-size:14px;color:var(--text2);margin-top:8px">Unlock the full experience</div></div>
    <div style="margin:24px 0">
      <div style="display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--border)"><span style="color:var(--green)">‚úì</span><span>Live trading signals</span></div>
      <div style="display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--border)"><span style="color:var(--green)">‚úì</span><span>Priority alerts</span></div>
      <div style="display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--border)"><span style="color:var(--green)">‚úì</span><span>Advanced analytics</span></div>
      <div style="display:flex;align-items:center;gap:12px;padding:14px 0"><span style="color:var(--green)">‚úì</span><span>Direct support</span></div>
    </div>
    <button class="btn" onclick="showToast('Coming soon!','')">Subscribe ¬∑ $9.99/month</button>
    <p style="font-size:12px;color:var(--text3);text-align:center;margin-top:16px">7-day free trial ¬∑ Cancel anytime</p>
  </div></div>

  <div class="modal-bg" id="adminModal" onclick="closeModal('adminModal')"><div class="modal" onclick="event.stopPropagation()" style="max-height:90vh">
    <div class="modal-handle"></div>
    <div class="modal-header"><span class="modal-title">Admin Panel</span><button class="modal-close" onclick="closeModal('adminModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>

    <div class="toggle" style="margin-bottom:20px">
      <button class="toggle-btn active" id="adminSignalBtn" onclick="setAdminTab('signal')">Signal</button>
      <button class="toggle-btn" id="adminAnnBtn" onclick="setAdminTab('announcement')">Announce</button>
      <button class="toggle-btn" id="adminRollBtn" onclick="setAdminTab('roll')">Roll</button>
    </div>

    <div id="adminSignalForm">
      <div class="form-group"><label class="form-label">Type</label>
        <div class="toggle"><button class="toggle-btn active" id="sigCspBtn" onclick="S.adminSigType='csp';this.classList.add('active');$('sigCcBtn').classList.remove('active')">CSP</button><button class="toggle-btn" id="sigCcBtn" onclick="S.adminSigType='cc';this.classList.add('active');$('sigCspBtn').classList.remove('active')">CC</button></div>
      </div>
      <div class="form-group"><label class="form-label">Ticker</label><input type="text" class="form-input" id="adminTicker" placeholder="NVDA" style="text-transform:uppercase"></div>
      <div class="form-group"><label class="form-label">Strike</label><input type="number" class="form-input" id="adminStrike" placeholder="130"></div>
      <div class="form-group"><label class="form-label">Expiration</label><input type="text" class="form-input" id="adminExp" placeholder="Feb 7"></div>
      <div class="form-group"><label class="form-label">Premium</label><input type="text" class="form-input" id="adminPrem" placeholder="$3.20"></div>
      <div class="form-group"><label class="form-label">Delta</label><input type="text" class="form-input" id="adminDelta" placeholder="0.25"></div>
      <button class="btn" onclick="postSignal()">Post Signal</button>
    </div>

    <div id="adminAnnForm" class="hidden">
      <div class="form-group"><label class="form-label">Title</label><input type="text" class="form-input" id="annTitle" placeholder="Market Update"></div>
      <div class="form-group"><label class="form-label">Message</label><textarea class="form-input" id="annMsg" placeholder="Your announcement..." rows="4" style="resize:none"></textarea></div>
      <button class="btn" onclick="postAnnouncement()">Post Announcement</button>
    </div>

    <div id="adminRollForm" class="hidden">
      <div class="form-group"><label class="form-label">Select Open Position</label>
        <select class="position-select" id="rollPositionSelect" onchange="fillRollFromPosition()">
          <option value="">-- Select a position to roll --</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Original Position</label><input type="text" class="form-input" id="rollOrig" placeholder="NVDA $130P Feb 7"></div>
      <div class="form-group"><label class="form-label">New Position</label><input type="text" class="form-input" id="rollNew" placeholder="NVDA $125P Feb 14"></div>
      <div class="form-group"><label class="form-label">Credit/Debit</label><input type="text" class="form-input" id="rollCredit" placeholder="+$0.50 credit"></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="rollNotes" placeholder="Rolling for credit..." rows="2" style="resize:none"></textarea></div>
      <button class="btn" onclick="postRoll()">Post Roll Update</button>
    </div>

    <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
      <div class="card-title">Manage Positions</div>
      <p style="font-size:11px;color:var(--text3);margin-bottom:12px">Mark as winner üéâ or rolled to update status</p>
      <div id="adminPostsList" style="max-height:300px;overflow-y:auto"></div>
    </div>

    <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
      <div class="card-title">Notification Settings</div>
      <div class="form-group" style="margin-top:12px"><label class="form-label">Discord Webhook URL</label><input type="text" class="form-input" id="discordWebhook" placeholder="https://discord.com/api/webhooks/..."></div>
      <p style="font-size:11px;color:var(--text3);margin-top:4px">Posts sent to your Discord server</p>

      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
        <div class="form-label" style="font-weight:600;margin-bottom:8px">üìß EmailJS (Free Email Alerts)</div>
        <div class="form-group"><label class="form-label">Public Key</label><input type="text" class="form-input" id="emailjsPublicKey" placeholder="Your EmailJS public key"></div>
        <div class="form-group"><label class="form-label">Service ID</label><input type="text" class="form-input" id="emailjsServiceId" placeholder="service_xxxxxxx"></div>
        <div class="form-group"><label class="form-label">Template ID</label><input type="text" class="form-input" id="emailjsTemplateId" placeholder="template_xxxxxxx"></div>
        <p style="font-size:11px;color:var(--text3);margin-top:4px">Free at <a href="https://emailjs.com" target="_blank" style="color:var(--blue)">emailjs.com</a> - 200 emails/month</p>
      </div>

      <button class="btn btn-outline" onclick="saveAdminSettings()" style="margin-top:12px">Save Settings</button>
    </div>
  </div></div>

  <div class="modal-bg center" id="promptModal" onclick="closePrompt()"><div class="modal" onclick="event.stopPropagation()" style="max-width:360px">
    <div class="modal-header"><span class="modal-title" id="promptTitle">Enter Value</span><button class="modal-close" onclick="closePrompt()"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
    <div class="form-group"><input type="text" class="form-input" id="promptInput" placeholder="" style="font-size:18px;text-transform:uppercase"></div>
    <div style="display:flex;gap:12px"><button class="btn" onclick="submitPrompt()" style="flex:1">OK</button><button class="btn btn-outline" onclick="closePrompt()" style="flex:1">Cancel</button></div>
  </div></div>

  <div class="toast" id="toast"></div>

<script>
const S={theme:'light',mode:'csp',addMode:'csp',apiKey:'',secretKey:'',accSize:25000,positions:[],history:[],selPosId:null,user:{name:'',email:''},isPremium:false,legalOk:false,notifOn:false,watchlist:['AAPL','NVDA','TSLA','SPY','AMD','MSFT']};
const names={AAPL:'Apple Inc.',NVDA:'NVIDIA',TSLA:'Tesla',MSFT:'Microsoft',AMD:'AMD',SPY:'S&P 500 ETF',QQQ:'Nasdaq 100 ETF',AMZN:'Amazon',GOOGL:'Alphabet',META:'Meta Platforms',RKLB:'Rocket Lab',PLTR:'Palantir',SOFI:'SoFi',COIN:'Coinbase',HOOD:'Robinhood',NET:'Cloudflare',SNOW:'Snowflake',CRWD:'CrowdStrike',DDOG:'Datadog',ZS:'Zscaler'};
const domains={AAPL:'apple.com',NVDA:'nvidia.com',TSLA:'tesla.com',MSFT:'microsoft.com',AMD:'amd.com',SPY:'ssga.com',QQQ:'invesco.com',AMZN:'amazon.com',GOOGL:'google.com',META:'meta.com',RKLB:'rocketlabusa.com',PLTR:'palantir.com',SOFI:'sofi.com',COIN:'coinbase.com',HOOD:'robinhood.com',NET:'cloudflare.com',SNOW:'snowflake.com',CRWD:'crowdstrike.com',DDOG:'datadoghq.com',ZS:'zscaler.com'};
const signals=[{type:'csp',ticker:'NVDA',strike:130,exp:'Jan 24',prem:'$3.20',delta:'0.25',time:'2h ago'},{type:'cc',ticker:'AAPL',strike:260,exp:'Jan 31',prem:'$2.80',delta:'0.30',time:'5h ago'},{type:'csp',ticker:'AMD',strike:135,exp:'Feb 7',prem:'$4.50',delta:'0.28',time:'1d ago'}];

// ========== AUTHENTICATION ==========
function showAuthTab(tab) {
  $('authLogin').classList.toggle('hidden', tab !== 'login');
  $('authSignup').classList.toggle('hidden', tab !== 'signup');
}

function togglePasswordVisibility(inputId, btn) {
  const input = $(inputId);
  if (input.type === 'password') {
    input.type = 'text';
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';
  } else {
    input.type = 'password';
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
  }
}

function checkPasswordStrength() {
  const pass = $('signupPassword').value;
  const checks = {
    passLength: pass.length >= 8,
    passLower: /[a-z]/.test(pass),
    passUpper: /[A-Z]/.test(pass),
    passNumber: /[0-9]/.test(pass),
    passSpecial: /[!@#$%^&*(),.?":{}|<>]/.test(pass)
  };

  Object.entries(checks).forEach(([id, valid]) => {
    $(id).classList.toggle('valid', valid);
  });

  // Enable signup button if all checks pass
  const allValid = Object.values(checks).every(v => v);
  $('signupBtn').disabled = !allValid;
}

function submitPremiumInterest() {
  const email = $('premiumEmail').value.trim();
  if (!email || !email.includes('@')) {
    showToast('Please enter a valid email', 'error');
    return;
  }

  // Save to Firebase
  initFirebase().then(ok => {
    if (ok) {
      const emailKey = email.replace(/[.#$[\]]/g, '_');
      firebase.database().ref('premiumInterest/' + emailKey).set({
        email: email,
        timestamp: Date.now(),
        source: 'alerts_popup'
      });
    }
  });

  // Also save email to user's alert subscription
  S.alertEmail = email;
  S.alertsPopupDismissed = true;
  save();

  closeModal('premiumPopup');
  showToast('You\'re on the list! We\'ll notify you of new signals.', 'success');

  // Now go to profile
  nav('profile');
}

// Show alerts popup (only once, on first profile click)
function showAlertsPopupOnce() {
  // Check if already dismissed
  if (S.alertsPopupDismissed) return false;

  // Pre-fill email if user is logged in
  if (S.user.email) $('premiumEmail').value = S.user.email;
  openModal('premiumPopup');
  return true;
}

// Called when "Not now" is clicked on alerts popup
function dismissAlertsPopup() {
  S.alertsPopupDismissed = true;
  save();
  closeModal('premiumPopup');
  // Now go to profile
  nav('profile');
}

// Called when user clicks avatar/profile button
function goToProfile() {
  // If guest, prompt to create account
  if (S.isGuest) {
    promptCreateAccount();
    return;
  }

  // Show alerts popup once if not dismissed and not premium
  if (!S.isPremium && !S.alertsPopupDismissed) {
    showAlertsPopupOnce();
    return;
  }
  nav('profile');
}

// Prompt guest to create an account
function promptCreateAccount() {
  // Clear guest state and show signup
  S.isGuest = false;
  save();
  showAuthScreen();
  showAuthTab('signup');
  showToast('Create an account to save your progress!', '');
}

async function handleLogin() {
  const email = $('loginEmail').value.trim();
  const pass = $('loginPassword').value;
  const rememberMe = $('rememberMe')?.checked;

  if (!email || !pass) return showToast('Please fill all fields', 'error');

  try {
    if (!await initFirebase()) throw new Error('Firebase init failed');

    // Set persistence based on "Remember me" checkbox
    const persistence = rememberMe
      ? firebase.auth.Auth.Persistence.LOCAL      // Persists even after browser close
      : firebase.auth.Auth.Persistence.SESSION;   // Cleared when tab closes
    await firebase.auth().setPersistence(persistence);

    const cred = await firebase.auth().signInWithEmailAndPassword(email, pass);
    await loadUserData(cred.user.uid);
    completeAuth(cred.user);
  } catch (e) {
    console.error('Login error:', e);
    showToast(e.message || 'Login failed', 'error');
  }
}

async function handleSignup() {
  const name = $('signupName').value.trim();
  const email = $('signupEmail').value.trim();
  const pass = $('signupPassword').value;

  if (!name || !email || !pass) return showToast('Please fill all fields', 'error');

  // Validate password strength
  const hasLength = pass.length >= 8;
  const hasLower = /[a-z]/.test(pass);
  const hasUpper = /[A-Z]/.test(pass);
  const hasNumber = /[0-9]/.test(pass);
  const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(pass);

  if (!hasLength || !hasLower || !hasUpper || !hasNumber || !hasSpecial) {
    return showToast('Password doesn\'t meet requirements', 'error');
  }

  try {
    if (!await initFirebase()) throw new Error('Firebase init failed');
    const cred = await firebase.auth().createUserWithEmailAndPassword(email, pass);

    // Save user profile to Firebase
    await firebase.database().ref('users/' + cred.user.uid).set({
      name: name,
      email: email,
      isPremium: false,
      createdAt: Date.now()
    });

    S.user.name = name;
    S.user.email = email;
    S.isPremium = false;
    save();

    completeAuth(cred.user);
    showToast('Welcome to Market Elites!', 'success');
  } catch (e) {
    console.error('Signup error:', e);
    showToast(e.message || 'Signup failed', 'error');
  }
}

function handleGuestLogin() {
  S.isGuest = true;
  S.user.name = 'Guest';
  save();
  hideAuthScreen();
  checkLegal();
  renderHome(); // Fix: render home after guest login
  showToast('Browsing as guest - Sign up to save your data!', '');
}

async function handleGoogleSignIn() {
  try {
    if (!await initFirebase()) throw new Error('Firebase init failed');

    const provider = new firebase.auth.GoogleAuthProvider();
    const result = await firebase.auth().signInWithPopup(provider);
    const user = result.user;

    // Check if user exists in database, if not create profile
    const userRef = firebase.database().ref('users/' + user.uid);
    const snapshot = await userRef.once('value');

    if (!snapshot.exists()) {
      // New user - create profile
      await userRef.set({
        name: user.displayName || 'User',
        email: user.email,
        isPremium: false,
        createdAt: Date.now(),
        provider: 'google'
      });
    }

    // Load user data
    const userData = snapshot.val() || {};
    S.user.name = user.displayName || userData.name || 'User';
    S.user.email = user.email;
    S.isPremium = userData.isPremium || false;
    save();

    completeAuth(user);
    showToast('Welcome, ' + S.user.name + '!', 'success');
  } catch (e) {
    console.error('Google sign-in error:', e);
    if (e.code === 'auth/popup-closed-by-user') {
      // User closed popup, don't show error
      return;
    }
    showToast(e.message || 'Google sign-in failed', 'error');
  }
}

async function handleAppleSignIn() {
  try {
    if (!await initFirebase()) throw new Error('Firebase init failed');

    const provider = new firebase.auth.OAuthProvider('apple.com');
    provider.addScope('email');
    provider.addScope('name');
    const result = await firebase.auth().signInWithPopup(provider);
    const user = result.user;

    // Check if user exists in database, if not create profile
    const userRef = firebase.database().ref('users/' + user.uid);
    const snapshot = await userRef.once('value');

    if (!snapshot.exists()) {
      await userRef.set({
        name: user.displayName || 'User',
        email: user.email || '',
        isPremium: false,
        createdAt: Date.now(),
        provider: 'apple'
      });
    }

    const userData = snapshot.val() || {};
    S.user.name = user.displayName || userData.name || 'User';
    S.user.email = user.email || userData.email || '';
    S.isPremium = userData.isPremium || false;
    save();

    completeAuth(user);
    showToast('Welcome, ' + S.user.name + '!', 'success');
  } catch (e) {
    console.error('Apple sign-in error:', e);
    if (e.code === 'auth/popup-closed-by-user') return;
    showToast(e.message || 'Apple sign-in failed', 'error');
  }
}

function completeAuth(user) {
  S.firebaseUid = user.uid;
  // Save remember me preference
  if ($('rememberMe')?.checked) {
    localStorage.setItem('meRemember', 'true');
  }
  save();
  hideAuthScreen();
  checkLegal();
  renderHome(); // Fix: render home after login
}

async function loadUserData(uid) {
  try {
    const snapshot = await firebase.database().ref('users/' + uid).once('value');
    const data = snapshot.val();
    if (data) {
      S.user.name = data.name || '';
      S.user.email = data.email || '';
      S.isPremium = data.isPremium || false;
      save();
    }
  } catch (e) {
    console.error('Load user data error:', e);
  }
}

function checkAuthState() {
  // Check if user is logged in locally (guest or has firebase uid)
  if (S.firebaseUid || S.isGuest) {
    hideAuthScreen();
    return true;
  }

  // Check if "Remember me" was selected - try to restore Firebase session
  const remembered = localStorage.getItem('meRemember');
  if (remembered) {
    // Firebase will auto-restore session, set up listener
    initFirebase().then(ok => {
      if (ok && firebase.auth) {
        firebase.auth().onAuthStateChanged(user => {
          if (user) {
            S.firebaseUid = user.uid;
            loadUserData(user.uid);
            save();
            hideAuthScreen();
            checkLegal();
            renderHome();
          }
        });
      }
    });
  }

  showAuthScreen();
  return false;
}

function showAuthScreen() {
  $('authScreen').style.display = 'flex';
  document.querySelector('.app').style.display = 'none';
  document.querySelector('.nav').style.display = 'none';
}

function hideAuthScreen() {
  $('authScreen').style.display = 'none';
  document.querySelector('.app').style.display = 'block';
  document.querySelector('.nav').style.display = '';  // Restore CSS default
}

function showForgotPassword() {
  showPrompt('Reset Password', 'Enter your email address', async (email) => {
    if (!email) return;
    try {
      if (!await initFirebase()) throw new Error('Firebase init failed');
      await firebase.auth().sendPasswordResetEmail(email);
      showToast('Password reset email sent!', 'success');
    } catch (e) {
      showToast(e.message || 'Reset failed', 'error');
    }
  });
}

// Live pricing cache
const priceCache = {};
const optionsCache = {};

function getTwelveDataKey() {
  return localStorage.getItem('twelveDataKey') || '';
}

// Fetch live stock quote ‚Äî Twelve Data primary, Yahoo fallback
async function fetchLiveQuote(symbol) {
  const cacheKey = symbol.toUpperCase();
  const cached = priceCache[cacheKey];
  if (cached && Date.now() - cached.time < 30000) return cached.data; // 30s cache

  const apiKey = getTwelveDataKey();

  // Try Twelve Data first (reliable, no CORS issues)
  if (apiKey) {
    try {
      const url = `https://api.twelvedata.com/quote?symbol=${encodeURIComponent(symbol)}&apikey=${apiKey}`;
      const r = await fetch(url);
      if (r.ok) {
        const data = await r.json();
        if (data.symbol && !data.code) {
          const price = parseFloat(data.close) || 0;
          const prevClose = parseFloat(data.previous_close) || price;
          const change = price - prevClose;
          const changePercent = prevClose > 0 ? ((change / prevClose) * 100).toFixed(2) : '0.00';
          const quote = {
            symbol: data.symbol,
            price: price,
            prevClose: prevClose,
            change: change,
            changePercent: changePercent,
            high: parseFloat(data.high) || 0,
            low: parseFloat(data.low) || 0,
            volume: parseInt(data.volume) || 0
          };
          priceCache[cacheKey] = { data: quote, time: Date.now() };
          return quote;
        }
      }
    } catch (e) {
      console.warn('Twelve Data error, falling back:', e);
    }
  }

  // Fallback: Yahoo Finance via CORS proxy
  try {
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`;
    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
    const r = await fetch(proxyUrl);
    if (!r.ok) throw new Error('Quote fetch failed');
    const data = await r.json();
    const result = data.chart?.result?.[0];
    if (!result) throw new Error('No data');
    const meta = result.meta;
    const price = meta.regularMarketPrice || 0;
    const prevClose = meta.previousClose || meta.chartPreviousClose || price;
    const change = price - prevClose;
    const changePercent = prevClose > 0 ? ((change / prevClose) * 100).toFixed(2) : '0.00';
    const quote = {
      symbol: meta.symbol,
      price: price,
      prevClose: prevClose,
      change: change,
      changePercent: changePercent,
      high: meta.regularMarketDayHigh,
      low: meta.regularMarketDayLow,
      volume: meta.regularMarketVolume
    };
    priceCache[cacheKey] = { data: quote, time: Date.now() };
    return quote;
  } catch (e) {
    console.error('Quote error:', e);
    return null;
  }
}

// Fetch options chain from Yahoo Finance (options data requires paid Twelve Data plan)
async function fetchOptionsChain(symbol, expDate = null) {
  const cacheKey = `${symbol.toUpperCase()}_${expDate || 'default'}`;
  const cached = optionsCache[cacheKey];
  if (cached && Date.now() - cached.time < 60000) return cached.data; // 1min cache

  try {
    let url = `https://query1.finance.yahoo.com/v7/finance/options/${symbol}`;
    if (expDate) url += `?date=${expDate}`;
    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
    const r = await fetch(proxyUrl);
    if (!r.ok) throw new Error('Options fetch failed');
    const data = await r.json();
    const result = data.optionChain?.result?.[0];
    if (!result) throw new Error('No options data');

    const chain = {
      symbol: result.quote?.symbol,
      price: result.quote?.regularMarketPrice,
      expirations: result.expirationDates || [],
      strikes: result.strikes || [],
      calls: result.options?.[0]?.calls || [],
      puts: result.options?.[0]?.puts || []
    };
    optionsCache[cacheKey] = { data: chain, time: Date.now() };
    return chain;
  } catch (e) {
    console.error('Options error:', e);
    return null;
  }
}

// Format expiration date from Unix timestamp
function formatExpDate(ts) {
  const d = new Date(ts * 1000);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
}

// Calculate days to expiration
function calcDTE(ts) {
  return Math.ceil((ts * 1000 - Date.now()) / 86400000);
}
const $=id=>document.getElementById(id);
const show=el=>$(el)?.classList.remove('hidden');
const hide=el=>$(el)?.classList.add('hidden');

// Generate consistent color from ticker symbol
const tickerColors = ['#6366f1','#8b5cf6','#ec4899','#f43f5e','#f97316','#eab308','#22c55e','#14b8a6','#06b6d4','#3b82f6'];
function getTickerColor(sym) {
  let hash = 0;
  for (let i = 0; i < sym.length; i++) hash = sym.charCodeAt(i) + ((hash << 5) - hash);
  return tickerColors[Math.abs(hash) % tickerColors.length];
}

// Custom toast notification
function showToast(msg, type='') {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast' + (type ? ' ' + type : '');
  setTimeout(() => t.classList.add('show'), 10);
  setTimeout(() => t.classList.remove('show'), 3000);
}

// Custom prompt modal
let promptCallback = null;
function showPrompt(title, placeholder, callback) {
  $('promptTitle').textContent = title;
  $('promptInput').placeholder = placeholder || '';
  $('promptInput').value = '';
  promptCallback = callback;
  openModal('promptModal');
  setTimeout(() => $('promptInput').focus(), 100);
}
function submitPrompt() {
  const val = $('promptInput').value.trim();
  closeModal('promptModal');
  if (promptCallback && val) promptCallback(val);
  promptCallback = null;
}
function closePrompt() {
  closeModal('promptModal');
  promptCallback = null;
}
$('promptInput')?.addEventListener('keydown', e => { if (e.key === 'Enter') submitPrompt(); });

// Admin Panel Functions
// Admin access is restricted to specific Firebase UIDs
const ADMIN_UIDS = new Set([
  // Add your Firebase UID here after first login.
  // Find it in Firebase Console > Authentication > Users
  // Or check browser console after login: console.log(S.firebaseUid)
]);

// Secret admin access - tap copyright 5 times quickly
let adminTapCount = 0;
let adminTapTimer = null;
function secretAdminTap() {
  adminTapCount++;
  clearTimeout(adminTapTimer);
  if (adminTapCount >= 5) {
    adminTapCount = 0;
    checkAdminAccess();
  } else {
    adminTapTimer = setTimeout(() => { adminTapCount = 0; }, 2000);
  }
}

// Secret premium toggle - tap profile name 5 times (for testing, admin only)
let premiumTapCount = 0;
let premiumTapTimer = null;
function secretPremiumTap() {
  if (!isAdmin()) return;
  premiumTapCount++;
  clearTimeout(premiumTapTimer);
  if (premiumTapCount >= 5) {
    premiumTapCount = 0;
    S.isPremium = !S.isPremium;
    save();
    renderProfile();
    showToast(S.isPremium ? 'Premium activated!' : 'Premium deactivated', S.isPremium ? 'success' : '');
  } else {
    premiumTapTimer = setTimeout(() => { premiumTapCount = 0; }, 2000);
  }
}

function isAdmin() {
  return S.firebaseUid && ADMIN_UIDS.has(S.firebaseUid);
}

function initAdminAccess() {
  document.addEventListener('keydown', e => {
    if (e.ctrlKey && e.shiftKey && e.key === 'A') { e.preventDefault(); checkAdminAccess(); }
  });
}

function checkAdminAccess() {
  if (isAdmin()) {
    S.adminAuthenticated = true;
    openAdmin();
  } else if (S.firebaseUid) {
    // Show UID so it can be added to ADMIN_UIDS
    console.log('Your Firebase UID:', S.firebaseUid);
    showToast('Not authorized. Check console for your UID.', 'error');
  } else {
    showToast('Sign in first', 'error');
  }
}

function openAdmin() {
  if (!isAdmin()) return checkAdminAccess();
  S.adminSigType = 'csp';
  renderAdminPosts();
  loadPostsFromFirebase();
  loadAdminSettings();
  openModal('adminModal');
}

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyANXf3yA7qRE-BuT-PrPW--4eKre-9YqiI",
  authDomain: "market-elites.firebaseapp.com",
  databaseURL: "https://market-elites-default-rtdb.firebaseio.com",
  projectId: "market-elites",
  storageBucket: "market-elites.firebasestorage.app",
  messagingSenderId: "347581977529",
  appId: "1:347581977529:web:7cb9c741577eec19ff1c68"
};

let firebaseReady = false;

// Initialize Firebase (lazy load)
async function initFirebase() {
  if (firebaseReady) return true;
  if (firebaseConfig.apiKey === "YOUR_API_KEY") {
    console.log('Firebase not configured - using localStorage only');
    return false;
  }
  try {
    if (!window.firebase) {
      // Load Firebase SDK - app, auth, and database
      await loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js');
    }
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    firebaseReady = true;
    return true;
  } catch (e) {
    console.error('Firebase init error:', e);
    return false;
  }
}

function loadScript(src) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = src;
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

// Save post to Firebase
async function savePostToFirebase(post) {
  if (!await initFirebase()) {
    // Fallback to localStorage only
    if (!S.adminPosts) S.adminPosts = [];
    S.adminPosts.unshift(post);
    save();
    return;
  }
  try {
    const db = firebase.database();
    await db.ref('posts').push(post);
    showToast('Posted to all users!', 'success');
  } catch (e) {
    console.error('Firebase save error:', e);
    showToast('Saved locally only', '');
  }
  // Send Discord notification
  await sendDiscordNotification(post);
  // Send email notifications
  await sendEmailNotifications(post);
}

// Send notification to Discord webhook
async function sendDiscordNotification(post) {
  const webhookUrl = localStorage.getItem('discordWebhook');
  if (!webhookUrl) return;

  let embed = { color: 0x00ff00, timestamp: new Date().toISOString() };

  if (post.kind === 'signal') {
    embed.title = `üö® New ${post.type.toUpperCase()} Signal`;
    embed.description = `**${post.ticker}** $${post.strike} ${post.type === 'csp' ? 'Put' : 'Call'}`;
    embed.fields = [
      { name: 'Expiration', value: post.exp, inline: true },
      { name: 'Premium', value: post.prem, inline: true },
      { name: 'Delta', value: post.delta, inline: true }
    ];
    embed.color = post.type === 'csp' ? 0x34c759 : 0x007aff;
  } else if (post.kind === 'announcement') {
    embed.title = `üì¢ ${post.title}`;
    embed.description = post.message;
    embed.color = 0xff9500;
  } else if (post.kind === 'roll') {
    embed.title = `üîÑ Position Roll`;
    embed.description = `${post.original} ‚Üí ${post.newPos}`;
    embed.fields = [{ name: 'Credit/Debit', value: post.credit, inline: true }];
    if (post.notes) embed.fields.push({ name: 'Notes', value: post.notes, inline: false });
    embed.color = 0xaf52de;
  }

  try {
    await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ embeds: [embed] })
    });
  } catch (e) {
    console.error('Discord webhook error:', e);
  }
}

// Save admin settings
function saveAdminSettings() {
  const webhook = $('discordWebhook')?.value.trim();
  if (webhook) localStorage.setItem('discordWebhook', webhook);

  // Save EmailJS settings
  const publicKey = $('emailjsPublicKey')?.value.trim();
  const serviceId = $('emailjsServiceId')?.value.trim();
  const templateId = $('emailjsTemplateId')?.value.trim();
  if (publicKey) localStorage.setItem('emailjsPublicKey', publicKey);
  if (serviceId) localStorage.setItem('emailjsServiceId', serviceId);
  if (templateId) localStorage.setItem('emailjsTemplateId', templateId);

  // Initialize EmailJS if configured
  if (publicKey && typeof emailjs !== 'undefined') {
    emailjs.init(publicKey);
  }

  showToast('Settings saved!', 'success');
}

// Load admin settings
function loadAdminSettings() {
  const webhook = localStorage.getItem('discordWebhook');
  if (webhook && $('discordWebhook')) $('discordWebhook').value = webhook;

  // Load EmailJS settings
  const publicKey = localStorage.getItem('emailjsPublicKey');
  const serviceId = localStorage.getItem('emailjsServiceId');
  const templateId = localStorage.getItem('emailjsTemplateId');
  if (publicKey && $('emailjsPublicKey')) $('emailjsPublicKey').value = publicKey;
  if (serviceId && $('emailjsServiceId')) $('emailjsServiceId').value = serviceId;
  if (templateId && $('emailjsTemplateId')) $('emailjsTemplateId').value = templateId;

  // Initialize EmailJS if configured
  if (publicKey && typeof emailjs !== 'undefined') {
    emailjs.init(publicKey);
  }
}

// Send email notifications to subscribed users
async function sendEmailNotifications(post) {
  const publicKey = localStorage.getItem('emailjsPublicKey');
  const serviceId = localStorage.getItem('emailjsServiceId');
  const templateId = localStorage.getItem('emailjsTemplateId');

  if (!publicKey || !serviceId || !templateId) return;

  // Get subscribed emails from Firebase
  if (!await initFirebase()) return;

  try {
    const db = firebase.database();
    const snapshot = await db.ref('emailSubscribers').once('value');
    const subscribers = snapshot.val() || {};

    // Build email content based on post type
    let subject = '', body = '';
    if (post.kind === 'winner') {
      subject = `üéâ WINNER! ${post.ticker} Closed for Profit!`;
      body = `Congratulations! Another winning trade!\n\n${post.type.toUpperCase()} ${post.ticker} $${post.strike} ${post.type === 'csp' ? 'Put' : 'Call'}\nExpiration: ${post.exp}\nPremium Collected: ${post.prem}\n\nThis position has been closed for profit! üéâ`;
    } else if (post.kind === 'signal') {
      subject = `üö® New ${post.type.toUpperCase()} Signal - ${post.ticker}`;
      body = `New ${post.type === 'csp' ? 'Cash Secured Put' : 'Covered Call'} Signal!\n\nTicker: ${post.ticker}\nStrike: $${post.strike}\nExpiration: ${post.exp}\nPremium: ${post.prem}\nDelta: ${post.delta}`;
    } else if (post.kind === 'announcement') {
      subject = `üì¢ ${post.title}`;
      body = post.message;
    } else if (post.kind === 'roll') {
      subject = `üîÑ Position Roll Alert`;
      body = `Rolling position:\n${post.original} ‚Üí ${post.newPos}\nCredit/Debit: ${post.credit}${post.notes ? '\nNotes: ' + post.notes : ''}`;
    } else if (post.kind === 'assigned') {
      subject = `üì¶ ${post.ticker} Assigned - Wheel Continues!`;
      body = `Your CSP on ${post.ticker} $${post.strike} was assigned!\n\nYou now own 100 shares at $${post.strike}.\nNext step: Sell covered calls to continue the wheel strategy.`;
    } else if (post.kind === 'called') {
      subject = `üì§ ${post.ticker} Called Away - Wheel Complete!`;
      body = `Your CC on ${post.ticker} $${post.strike} was exercised!\n\nShares sold at $${post.strike}.\nWheel cycle complete! Time to start selling CSPs again.`;
    }

    // Send to each subscriber
    for (const [key, sub] of Object.entries(subscribers)) {
      if (sub.active && sub.email) {
        try {
          await emailjs.send(serviceId, templateId, {
            to_email: sub.email,
            subject: subject,
            message: body,
            from_name: 'Market Elites'
          });
        } catch (e) {
          console.error('Email send error:', e);
        }
      }
    }
  } catch (e) {
    console.error('Email notification error:', e);
  }
}

// Toggle email alerts for user
function toggleEmailAlerts() {
  S.emailAlerts = !S.emailAlerts;
  const sw = $('emailAlertSwitch');
  if (sw) sw.classList.toggle('active', S.emailAlerts);
  save();
}

// Save email subscription to Firebase
async function saveEmailSubscription() {
  const email = $('userAlertEmail')?.value.trim();
  if (!email || !email.includes('@')) {
    showToast('Please enter a valid email', 'error');
    return;
  }

  if (!await initFirebase()) {
    // Save locally if Firebase not available
    S.alertEmail = email;
    save();
    showToast('Email saved locally', 'success');
    return;
  }

  try {
    const db = firebase.database();
    const emailKey = email.replace(/[.#$[\]]/g, '_'); // Firebase-safe key
    await db.ref('emailSubscribers/' + emailKey).set({
      email: email,
      active: S.emailAlerts !== false,
      subscribedAt: Date.now()
    });
    S.alertEmail = email;
    save();
    showToast('Email alerts enabled!', 'success');
  } catch (e) {
    console.error('Subscription error:', e);
    showToast('Failed to subscribe', 'error');
  }
}

// Load user email settings
function loadEmailSettings() {
  if (S.alertEmail && $('userAlertEmail')) $('userAlertEmail').value = S.alertEmail;
  const sw = $('emailAlertSwitch');
  if (sw) sw.classList.toggle('active', S.emailAlerts !== false);
}

// Load posts from Firebase
async function loadPostsFromFirebase() {
  if (!await initFirebase()) return;
  try {
    const db = firebase.database();
    const snapshot = await db.ref('posts').orderByChild('timestamp').limitToLast(50).once('value');
    const posts = [];
    snapshot.forEach(child => {
      posts.unshift({ id: child.key, ...child.val() });
    });
    S.adminPosts = posts;
    renderAdminPosts();
    renderSignals();
  } catch (e) {
    console.error('Firebase load error:', e);
  }
}

// Delete post from Firebase
async function deletePostFromFirebase(postId) {
  if (!await initFirebase()) return;
  try {
    const db = firebase.database();
    await db.ref('posts/' + postId).remove();
  } catch (e) {
    console.error('Firebase delete error:', e);
  }
}

// Listen for real-time updates (for all users)
// Track which winners we've celebrated to avoid duplicates
const celebratedWinners = new Set();

async function listenToFirebasePosts() {
  if (!await initFirebase()) return;
  try {
    const db = firebase.database();
    db.ref('posts').orderByChild('timestamp').limitToLast(50).on('value', snapshot => {
      const posts = [];
      snapshot.forEach(child => {
        posts.unshift({ id: child.key, ...child.val() });
      });

      // Check for new winners to celebrate
      posts.forEach(p => {
        if (p.status === 'winner' && p.id && !celebratedWinners.has(p.id)) {
          // Only celebrate if this is recent (within last 30 seconds)
          if (p.closedAt && Date.now() - p.closedAt < 30000) {
            celebratedWinners.add(p.id);
            if (!S.adminAuthenticated) { // Don't double-celebrate on admin side
              showCelebration(p);
            }
          } else {
            // Mark as already celebrated if it's old
            celebratedWinners.add(p.id);
          }
        }
      });

      S.adminPosts = posts;
      renderSignals();
      renderAlertsFeed(); // Update home alerts too
    });
  } catch (e) {
    console.error('Firebase listen error:', e);
  }
}

// Listen for winners (backup method)
async function listenForWinners() {
  if (!await initFirebase()) return;
  // Pre-populate celebrated winners to avoid showing old celebrations on load
  const posts = S.adminPosts || [];
  posts.forEach(p => {
    if (p.status === 'winner' && p.id) celebratedWinners.add(p.id);
  });
}

function setAdminTab(tab) {
  $('adminSignalBtn').classList.toggle('active', tab === 'signal');
  $('adminAnnBtn').classList.toggle('active', tab === 'announcement');
  $('adminRollBtn').classList.toggle('active', tab === 'roll');
  $('adminSignalForm').classList.toggle('hidden', tab !== 'signal');
  $('adminAnnForm').classList.toggle('hidden', tab !== 'announcement');
  $('adminRollForm').classList.toggle('hidden', tab !== 'roll');

  // Populate roll position selector when roll tab is opened
  if (tab === 'roll') populateRollSelector();
}

// Populate the roll position selector with open positions
function populateRollSelector() {
  const select = $('rollPositionSelect');
  if (!select) return;

  const posts = S.adminPosts || [];
  const openSignals = posts.filter(p => p.kind === 'signal' && (!p.status || p.status === 'open'));

  select.innerHTML = '<option value="">-- Select a position to roll --</option>' +
    openSignals.map((p, i) => {
      const posStr = `${p.ticker} $${p.strike}${p.type === 'csp' ? 'P' : 'C'} ${p.exp}`;
      return `<option value="${posts.indexOf(p)}">${p.type.toUpperCase()} - ${posStr}</option>`;
    }).join('');
}

// Fill roll form from selected position
function fillRollFromPosition() {
  const select = $('rollPositionSelect');
  if (!select || !select.value) return;

  const posts = S.adminPosts || [];
  const p = posts[parseInt(select.value)];
  if (!p) return;

  const posStr = `${p.ticker} $${p.strike}${p.type === 'csp' ? 'P' : 'C'} ${p.exp}`;
  $('rollOrig').value = posStr;
  $('rollNew').value = `${p.ticker} $`; // Pre-fill ticker for new position
  $('rollNew').focus();
}

async function postSignal() {
  const sig = {
    type: S.adminSigType || 'csp',
    ticker: $('adminTicker').value.toUpperCase().trim(),
    strike: parseFloat($('adminStrike').value) || 0,
    exp: $('adminExp').value.trim(),
    prem: $('adminPrem').value.trim(),
    delta: $('adminDelta').value.trim(),
    time: 'Just now',
    timestamp: Date.now(),
    kind: 'signal'
  };
  if (!sig.ticker || !sig.strike) return showToast('Fill ticker and strike', 'error');
  await savePostToFirebase(sig);
  $('adminTicker').value = '';
  $('adminStrike').value = '';
  $('adminExp').value = '';
  $('adminPrem').value = '';
  $('adminDelta').value = '';
  renderAdminPosts();
  renderSignals();
}

async function postAnnouncement() {
  const ann = {
    title: $('annTitle').value.trim(),
    message: $('annMsg').value.trim(),
    time: 'Just now',
    timestamp: Date.now(),
    kind: 'announcement'
  };
  if (!ann.title || !ann.message) return showToast('Fill title and message', 'error');
  await savePostToFirebase(ann);
  $('annTitle').value = '';
  $('annMsg').value = '';
  renderAdminPosts();
  renderSignals();
}

async function postRoll() {
  const selectedIdx = $('rollPositionSelect')?.value;
  const roll = {
    original: $('rollOrig').value.trim(),
    newPos: $('rollNew').value.trim(),
    credit: $('rollCredit').value.trim(),
    notes: $('rollNotes').value.trim(),
    time: 'Just now',
    timestamp: Date.now(),
    kind: 'roll'
  };
  if (!roll.original || !roll.newPos) return showToast('Fill original and new position', 'error');

  // Mark the original position as rolled if selected from dropdown
  if (selectedIdx && S.adminPosts[selectedIdx]) {
    await markPostRolled(parseInt(selectedIdx));
  }

  await savePostToFirebase(roll);
  $('rollOrig').value = '';
  $('rollNew').value = '';
  $('rollCredit').value = '';
  $('rollNotes').value = '';
  if ($('rollPositionSelect')) $('rollPositionSelect').value = '';
  renderAdminPosts();
  renderSignals();
}

async function deletePost(postId) {
  if (!S.adminPosts) return;
  const idx = S.adminPosts.findIndex(p => p.id === postId);
  if (idx === -1) return;

  // Delete from Firebase first
  await deletePostFromFirebase(postId);

  // Remove from local array
  S.adminPosts.splice(idx, 1);
  save();
  renderAdminPosts();
  renderSignals();
  showToast('Post deleted', '');
}

function renderAdminPosts() {
  const c = $('adminPostsList');
  if (!c) return;
  const posts = S.adminPosts || [];
  if (!posts.length) {
    c.innerHTML = '<p style="color:var(--text3);font-size:13px;text-align:center;padding:16px">No posts yet</p>';
    return;
  }
  c.innerHTML = posts.slice(0, 15).map((p, i) => {
    let label = '', showActions = false, statusBadge = '';
    const status = p.status || 'open';

    if (p.kind === 'signal') {
      label = `<span style="color:var(--${p.type==='csp'?'green':'blue'})">${p.type.toUpperCase()}</span> ${p.ticker} $${p.strike}`;
      showActions = true;
      if (status === 'winner') statusBadge = '<span class="status-badge winner">WIN üéâ</span>';
      else if (status === 'rolled') statusBadge = '<span class="status-badge rolled">ROLLED</span>';
      else if (status === 'assigned') statusBadge = '<span class="status-badge assigned">ASSIGNED üì¶</span>';
      else if (status === 'called') statusBadge = '<span class="status-badge called">CALLED AWAY üì§</span>';
      else if (status === 'closed') statusBadge = '<span class="status-badge closed">CLOSED</span>';
      else statusBadge = '<span class="status-badge open">OPEN</span>';
    } else if (p.kind === 'announcement') {
      label = `<span style="color:var(--orange)">ANN</span> ${p.title}`;
    } else if (p.kind === 'roll') {
      label = `<span style="color:var(--purple)">ROLL</span> ${p.original?.split(' ')[0] || 'Position'}`;
    }

    // Different actions based on signal type and status
    let actions = '';
    const pid = p.id ? `'${p.id}'` : i;
    if (showActions && status === 'open') {
      if (p.type === 'csp') {
        // CSP: can win, roll, or get assigned
        actions = `<div class="post-actions">
          <button class="post-action-btn winner" onclick="markPostWinner(${pid})">üéâ Winner</button>
          <button class="post-action-btn assigned" onclick="markPostAssigned(${pid})">üì¶ Assigned</button>
          <button class="post-action-btn roll" onclick="markPostRolled(${pid})">üîÑ Roll</button>
          <button class="post-action-btn delete" onclick="deletePost(${pid})">‚úï</button>
        </div>`;
      } else {
        // CC: can win, roll, or get called away
        actions = `<div class="post-actions">
          <button class="post-action-btn winner" onclick="markPostWinner(${pid})">üéâ Winner</button>
          <button class="post-action-btn called" onclick="markPostCalled(${pid})">üì§ Called</button>
          <button class="post-action-btn roll" onclick="markPostRolled(${pid})">üîÑ Roll</button>
          <button class="post-action-btn delete" onclick="deletePost(${pid})">‚úï</button>
        </div>`;
      }
    } else {
      actions = `<div class="post-actions"><button class="post-action-btn delete" onclick="deletePost(${pid})">Delete</button></div>`;
    }

    return `<div style="padding:10px 0;border-bottom:1px solid var(--border)">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:13px">${label}${statusBadge}</span>
        <span style="font-size:11px;color:var(--text3)">${getTimeAgo(p.timestamp)}</span>
      </div>
      ${actions}
    </div>`;
  }).join('');
}

// Mark post as winner (with celebration!)
async function markPostWinner(postId) {
  const posts = S.adminPosts || [];
  const post = posts.find(p => p.id === postId);
  if (!post) return;

  post.status = 'winner';
  post.closedAt = Date.now();

  // Save to Firebase
  if (await initFirebase() && post.id) {
    try {
      await firebase.database().ref('posts/' + post.id).update({ status: 'winner', closedAt: Date.now() });
    } catch (e) { console.error('Firebase update error:', e); }
  }

  save();
  renderAdminPosts();
  renderSignals();

  // Trigger celebration!
  showCelebration(post);

  // Send winner notification
  await sendWinnerNotification(post);
}

// Mark post as rolled
async function markPostRolled(postId) {
  const posts = S.adminPosts || [];
  const post = posts.find(p => p.id === postId);
  if (!post) return;

  post.status = 'rolled';
  post.closedAt = Date.now();

  // Save to Firebase
  if (await initFirebase() && post.id) {
    try {
      await firebase.database().ref('posts/' + post.id).update({ status: 'rolled', closedAt: Date.now() });
    } catch (e) { console.error('Firebase update error:', e); }
  }

  save();
  renderAdminPosts();
  renderSignals();
  showToast('Position marked as rolled', 'success');
}

// Mark CSP as assigned (now holding shares, start selling CCs)
async function markPostAssigned(postId) {
  const posts = S.adminPosts || [];
  const post = posts.find(p => p.id === postId);
  if (!post) return;

  post.status = 'assigned';
  post.assignedAt = Date.now();

  // Save to Firebase
  if (await initFirebase() && post.id) {
    try {
      await firebase.database().ref('posts/' + post.id).update({ status: 'assigned', assignedAt: Date.now() });
    } catch (e) { console.error('Firebase update error:', e); }
  }

  save();
  renderAdminPosts();
  renderSignals();

  // Send notification about assignment
  await sendAssignmentNotification(post, 'assigned');
  showToast(`${post.ticker} assigned! Time to sell covered calls üì¶`, 'success');
}

// Mark CC as called away (shares sold, back to selling CSPs)
async function markPostCalled(postId) {
  const posts = S.adminPosts || [];
  const post = posts.find(p => p.id === postId);
  if (!post) return;

  post.status = 'called';
  post.calledAt = Date.now();

  // Save to Firebase
  if (await initFirebase() && post.id) {
    try {
      await firebase.database().ref('posts/' + post.id).update({ status: 'called', calledAt: Date.now() });
    } catch (e) { console.error('Firebase update error:', e); }
  }

  save();
  renderAdminPosts();
  renderSignals();

  // Send notification about call
  await sendAssignmentNotification(post, 'called');
  showToast(`${post.ticker} called away! Back to selling puts üì§`, 'success');
}

// Send notification for assigned/called
async function sendAssignmentNotification(post, type) {
  const webhookUrl = localStorage.getItem('discordWebhook');
  if (webhookUrl) {
    const isAssigned = type === 'assigned';
    try {
      await fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          embeds: [{
            title: isAssigned ? `üì¶ ${post.ticker} Assigned!` : `üì§ ${post.ticker} Called Away!`,
            description: isAssigned
              ? `CSP $${post.strike} was assigned. Now holding 100 shares - time to sell covered calls!`
              : `CC $${post.strike} was exercised. Shares sold at strike - back to selling puts!`,
            color: isAssigned ? 0xff9500 : 0x007aff,
            timestamp: new Date().toISOString()
          }]
        })
      });
    } catch (e) { console.error('Discord error:', e); }
  }

  // Email notification
  await sendEmailNotifications({
    ...post,
    kind: type,
    message: type === 'assigned'
      ? `CSP assigned - now holding shares, will sell covered calls`
      : `CC exercised - shares called away, back to selling puts`
  });
}

// Show celebration animation
function showCelebration(post) {
  // Create overlay with text
  const overlay = document.createElement('div');
  overlay.className = 'celebration-overlay';
  overlay.innerHTML = `<div class="celebration-text">üéâ WINNER! üéâ</div>`;
  document.body.appendChild(overlay);

  // Create confetti
  const colors = ['#34c759', '#007aff', '#ff9500', '#af52de', '#ff3b30', '#ffcc00'];
  for (let i = 0; i < 50; i++) {
    setTimeout(() => {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + 'vw';
      confetti.style.top = '-10px';
      confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
      confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 4000);
    }, i * 30);
  }

  // Remove overlay after animation
  setTimeout(() => overlay.remove(), 2500);

  showToast(`${post.ticker} closed for profit! üéâ`, 'success');
}

// Send winner notification
async function sendWinnerNotification(post) {
  // Discord notification
  const webhookUrl = localStorage.getItem('discordWebhook');
  if (webhookUrl) {
    try {
      await fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          embeds: [{
            title: `üéâ WINNER! ${post.ticker} Closed for Profit!`,
            description: `${post.type.toUpperCase()} $${post.strike} ${post.type === 'csp' ? 'Put' : 'Call'} expired worthless or closed for profit!`,
            color: 0x34c759,
            fields: [
              { name: 'Premium Collected', value: post.prem, inline: true },
              { name: 'Expiration', value: post.exp, inline: true }
            ],
            timestamp: new Date().toISOString()
          }]
        })
      });
    } catch (e) { console.error('Discord error:', e); }
  }

  // Email notification
  await sendEmailNotifications({ ...post, kind: 'winner' });
}

function getTimeAgo(ts) {
  const mins = Math.floor((Date.now() - ts) / 60000);
  if (mins < 1) return 'Just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  return days + 'd ago';
}

initAdminAccess();
const logo=s=>'https://financialmodelingprep.com/image-stock/'+s.toUpperCase()+'.png';
function load(){try{const d=localStorage.getItem('meV6');if(d)Object.assign(S,JSON.parse(d))}catch(e){}}
function save(){try{localStorage.setItem('meV6',JSON.stringify(S))}catch(e){}}
function checkLegal(){if(!S.legalOk)openModal('legalModal')}
function acceptLegal(){S.legalOk=true;save();closeModal('legalModal')}
function toggleTheme(){S.theme=S.theme==='light'?'dark':'light';applyTheme();save()}
function applyTheme(){document.documentElement.setAttribute('data-theme',S.theme);['themeSwitch','qThemeSwitch'].forEach(id=>$(id)?.classList.toggle('on',S.theme==='dark'))}
function nav(t){document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));$(`${t}Tab`)?.classList.add('active');document.querySelector(`.nav-btn[data-tab="${t}"]`)?.classList.add('active');if(t==='home')renderHome();if(t==='watch')renderWatch();if(t==='alerts')renderAlerts();if(t==='signals')renderSignals();if(t==='profile')renderProfile()}
function goCalc(m){nav('calc');setMode(m)}
function openModal(id){$(id)?.classList.add('show')}
function closeModal(id){$(id)?.classList.remove('show')}
function saveTwelveDataKey(){const k=$('qTwelveKey')?.value.trim();if(k){localStorage.setItem('twelveDataKey',k);showToast('Market data key saved!','success');Object.keys(priceCache).forEach(k=>delete priceCache[k])}else{showToast('Enter a key first','error')}}
function saveGroqKey(){const k=$('qGroqKey')?.value.trim();if(k){localStorage.setItem('groqApiKey',k);showToast('AI key saved!','success')}else{showToast('Enter a key first','error')}}
function openSettings(){$('qApiKey').value=S.apiKey;$('qSecretKey').value=S.secretKey;const gk=localStorage.getItem('groqApiKey');if(gk&&$('qGroqKey'))$('qGroqKey').value=gk;const tk=localStorage.getItem('twelveDataKey');if(tk&&$('qTwelveKey'))$('qTwelveKey').value=tk;loadEmailSettings();applyTheme();openModal('settingsModal')}
function quickSaveApi(){S.apiKey=$('qApiKey').value.trim();S.secretKey=$('qSecretKey').value.trim();save();updateStatus();closeModal('settingsModal');if(S.apiKey)showToast('API keys saved!','success')}
function confirmSignOut() {
  showConfirm('Sign Out', 'Are you sure you want to sign out?', signOut);
}

function showConfirm(title, message, onConfirm) {
  $('confirmTitle').textContent = title;
  $('confirmMessage').textContent = message;
  $('confirmAction').onclick = () => { closeModal('confirmModal'); onConfirm(); };
  openModal('confirmModal');
}

async function signOut(){
  try { if (firebase?.auth) await firebase.auth().signOut(); } catch(e) {}
  // Clear auth state but keep user data for when they log back in
  S.firebaseUid = null;
  S.isGuest = false;
  S.alertsPopupDismissed = false;
  localStorage.removeItem('meRemember');
  save();
  showAuthScreen();
  showToast('Signed out', '');
}
function dismissNewUser(){S.newUserDismissed=true;save();const b=$('newUserBanner');if(b)b.style.display='none'}
function openAdd(){setAddMode('csp');openModal('addModal')}
// Education System
const EDUCATION = {
  modules: [
    {
      id: 'fundamentals',
      title: 'Options Fundamentals',
      desc: 'Master the basics of options trading',
      icon: 'üìö',
      color: 'blue',
      level: 'Beginner',
      duration: '45 min',
      chapters: [
        { id: 'what-are-options', title: 'What Are Options?', duration: '8 min' },
        { id: 'calls-vs-puts', title: 'Calls vs Puts Explained', duration: '10 min' },
        { id: 'key-terms', title: 'Essential Options Terms', duration: '12 min' },
        { id: 'options-pricing', title: 'How Options Are Priced', duration: '10 min' },
        { id: 'fundamentals-quiz', title: 'Chapter Quiz', duration: '5 min', isQuiz: true }
      ]
    },
    {
      id: 'greeks',
      title: 'Understanding the Greeks',
      desc: 'Learn the forces that move option prices',
      icon: 'üî¨',
      color: 'purple',
      level: 'Beginner',
      duration: '40 min',
      chapters: [
        { id: 'delta-explained', title: 'Delta: Direction & Probability', duration: '10 min' },
        { id: 'theta-decay', title: 'Theta: Time Decay', duration: '10 min' },
        { id: 'iv-vega', title: 'Implied Volatility & Vega', duration: '12 min' },
        { id: 'greeks-quiz', title: 'Chapter Quiz', duration: '5 min', isQuiz: true }
      ]
    },
    {
      id: 'wheel-overview',
      title: 'The Wheel Strategy',
      desc: 'Complete overview of the wheel approach',
      icon: 'üé°',
      color: 'green',
      level: 'Intermediate',
      duration: '35 min',
      chapters: [
        { id: 'wheel-intro', title: 'What Is The Wheel?', duration: '8 min' },
        { id: 'wheel-cycle', title: 'The Full Wheel Cycle', duration: '12 min' },
        { id: 'wheel-benefits', title: 'Why The Wheel Works', duration: '10 min' },
        { id: 'wheel-quiz', title: 'Chapter Quiz', duration: '5 min', isQuiz: true }
      ]
    },
    {
      id: 'csp-deep',
      title: 'Cash Secured Puts',
      desc: 'Deep dive into selling puts for income',
      icon: 'üìâ',
      color: 'green',
      level: 'Intermediate',
      duration: '50 min',
      chapters: [
        { id: 'csp-basics', title: 'CSP Fundamentals', duration: '10 min' },
        { id: 'csp-stock-selection', title: 'Selecting The Right Stock', duration: '12 min' },
        { id: 'csp-strike-exp', title: 'Strike & Expiration Selection', duration: '12 min' },
        { id: 'csp-management', title: 'Managing Your CSP', duration: '10 min' },
        { id: 'csp-quiz', title: 'Chapter Quiz', duration: '5 min', isQuiz: true }
      ]
    },
    {
      id: 'cc-deep',
      title: 'Covered Calls',
      desc: 'Generate income from your shares',
      icon: 'üìà',
      color: 'blue',
      level: 'Intermediate',
      duration: '45 min',
      chapters: [
        { id: 'cc-basics', title: 'Covered Call Fundamentals', duration: '10 min' },
        { id: 'cc-when-to-sell', title: 'When To Sell Covered Calls', duration: '10 min' },
        { id: 'cc-strike-selection', title: 'Strike Price Strategy', duration: '12 min' },
        { id: 'cc-management', title: 'Managing Your Covered Calls', duration: '8 min' },
        { id: 'cc-quiz', title: 'Chapter Quiz', duration: '5 min', isQuiz: true }
      ]
    },
    {
      id: 'beau-strategy',
      title: "Beau's Elite Strategy",
      desc: 'The exact system used by Market Elites',
      icon: 'üéØ',
      color: 'orange',
      level: 'Advanced',
      duration: '55 min',
      chapters: [
        { id: 'beau-philosophy', title: 'Trading Philosophy', duration: '8 min' },
        { id: 'beau-entry', title: 'Entry Criteria & Setup', duration: '15 min' },
        { id: 'beau-management', title: 'Position Management', duration: '12 min' },
        { id: 'beau-risk', title: 'Risk Management Rules', duration: '12 min' },
        { id: 'beau-mistakes', title: 'Common Mistakes To Avoid', duration: '8 min' },
        { id: 'beau-quiz', title: 'Final Assessment', duration: '10 min', isQuiz: true }
      ]
    },
    {
      id: 'app-guide',
      title: 'Using Market Elites',
      desc: 'Get the most out of this app',
      icon: 'üì±',
      color: 'blue',
      level: 'Beginner',
      duration: '20 min',
      chapters: [
        { id: 'app-overview', title: 'App Overview', duration: '5 min' },
        { id: 'app-signals', title: 'Following Signals', duration: '8 min' },
        { id: 'app-calculator', title: 'Using The Calculator', duration: '7 min' }
      ]
    }
  ]
};

let learnHistory = [];
let currentQuiz = null;
let quizAnswers = {};

function openLearn() {
  learnHistory = [];
  showModuleList();
  openModal('learnModal');
}

function goBackLearn() {
  if (learnHistory.length > 1) {
    learnHistory.pop();
    const prev = learnHistory[learnHistory.length - 1];
    if (prev.type === 'modules') showModuleList(false);
    else if (prev.type === 'chapters') showChapterList(prev.moduleId, false);
  } else {
    showModuleList(false);
  }
}

function showModuleList(addHistory = true) {
  if (addHistory) learnHistory.push({ type: 'modules' });
  $('learnTitle').textContent = 'Elite Trading Academy';
  $('learnBackBtn').style.display = 'none';

  const progress = getLearnProgress();
  const totalChapters = EDUCATION.modules.reduce((sum, m) => sum + m.chapters.length, 0);
  const completedChapters = Object.keys(progress).filter(k => progress[k]).length;
  const pct = totalChapters > 0 ? Math.round((completedChapters / totalChapters) * 100) : 0;

  let html = `
    <div style="background:linear-gradient(135deg,var(--blue),var(--purple));border-radius:16px;padding:20px;margin-bottom:20px;color:#fff">
      <div style="font-size:13px;opacity:0.9">Your Progress</div>
      <div style="font-size:28px;font-weight:700;margin:4px 0">${pct}% Complete</div>
      <div class="progress-bar" style="background:rgba(255,255,255,0.3)"><div class="progress-bar-fill" style="width:${pct}%;background:#fff"></div></div>
      <div style="font-size:12px;opacity:0.8;margin-top:8px">${completedChapters} of ${totalChapters} lessons completed</div>
    </div>
  `;

  html += EDUCATION.modules.map(m => {
    const modProgress = m.chapters.filter(c => progress[c.id]).length;
    const modPct = Math.round((modProgress / m.chapters.length) * 100);
    return `
      <div class="learn-module" onclick="showChapterList('${m.id}')">
        <div style="display:flex;align-items:center">
          <div class="learn-module-icon" style="background:var(--${m.color}-bg)">${m.icon}</div>
          <div class="learn-module-info">
            <div class="learn-module-title">${m.title}</div>
            <div class="learn-module-desc">${m.desc}</div>
            <div class="learn-module-meta">
              <span>${m.level}</span>
              <span>${m.duration}</span>
              <span>${modPct}% done</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');

  $('learnContent').innerHTML = html;
}

function showChapterList(moduleId, addHistory = true) {
  const mod = EDUCATION.modules.find(m => m.id === moduleId);
  if (!mod) return;

  if (addHistory) learnHistory.push({ type: 'chapters', moduleId });
  $('learnTitle').textContent = mod.title;
  $('learnBackBtn').style.display = 'flex';

  const progress = getLearnProgress();

  let html = `
    <div style="background:var(--${mod.color}-bg);border-radius:16px;padding:20px;margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <span style="font-size:32px">${mod.icon}</span>
        <div>
          <div style="font-weight:700;font-size:18px">${mod.title}</div>
          <div style="font-size:13px;color:var(--text2)">${mod.chapters.length} lessons ¬∑ ${mod.duration}</div>
        </div>
      </div>
      <p style="font-size:14px;color:var(--text2);margin:0">${mod.desc}</p>
    </div>
  `;

  html += mod.chapters.map((c, i) => {
    const completed = progress[c.id];
    return `
      <div class="learn-chapter" onclick="showLesson('${moduleId}', '${c.id}')">
        <div class="learn-chapter-num ${completed ? 'completed' : ''}">${completed ? '‚úì' : i + 1}</div>
        <div class="learn-chapter-title">${c.title}</div>
        <div class="learn-chapter-dur">${c.duration}</div>
      </div>
    `;
  }).join('');

  $('learnContent').innerHTML = html;
}

function getLearnProgress() {
  try {
    return JSON.parse(localStorage.getItem('learnProgress') || '{}');
  } catch (e) { return {}; }
}

function saveLearnProgress(chapterId) {
  const progress = getLearnProgress();
  progress[chapterId] = true;
  localStorage.setItem('learnProgress', JSON.stringify(progress));
}

function showLesson(moduleId, chapterId) {
  const mod = EDUCATION.modules.find(m => m.id === moduleId);
  const chapter = mod?.chapters.find(c => c.id === chapterId);
  if (!mod || !chapter) return;

  learnHistory.push({ type: 'lesson', moduleId, chapterId });
  $('learnTitle').textContent = chapter.title;
  $('learnBackBtn').style.display = 'flex';

  if (chapter.isQuiz) {
    showQuiz(moduleId, chapterId);
    return;
  }

  const content = getLessonContent(chapterId);
  const chapterIndex = mod.chapters.findIndex(c => c.id === chapterId);
  const nextChapter = mod.chapters[chapterIndex + 1];

  let html = `<div class="lesson-content">${content}</div>`;

  html += `
    <div style="display:flex;gap:12px;margin-top:24px">
      <button class="btn btn-outline" style="flex:1" onclick="showChapterList('${moduleId}')">Back to Chapters</button>
      ${nextChapter ? `<button class="btn" style="flex:1" onclick="completeAndNext('${moduleId}', '${chapterId}', '${nextChapter.id}')">Complete & Continue</button>` : `<button class="btn" style="flex:1" onclick="completeLesson('${chapterId}');showChapterList('${moduleId}')">Complete Module</button>`}
    </div>
  `;

  $('learnContent').innerHTML = html;
}

function completeLesson(chapterId) {
  saveLearnProgress(chapterId);
  showToast('Lesson completed! üéâ', 'success');
}

function completeAndNext(moduleId, currentId, nextId) {
  saveLearnProgress(currentId);
  showLesson(moduleId, nextId);
}

// Quiz System
const QUIZZES = {
  'fundamentals-quiz': {
    title: 'Options Fundamentals Quiz',
    questions: [
      {
        q: 'What does an options contract give you the right to do?',
        options: ['Obligation to buy/sell shares', 'Right (not obligation) to buy/sell shares at a set price', 'Free shares from the company', 'Guaranteed profits'],
        correct: 1
      },
      {
        q: 'A PUT option gives the holder the right to:',
        options: ['Buy shares at the strike price', 'Sell shares at the strike price', 'Hold shares indefinitely', 'Receive dividends'],
        correct: 1
      },
      {
        q: 'What does "premium" refer to in options trading?',
        options: ['The strike price of the option', 'The price paid to buy or received to sell an option', 'The expiration date', 'The underlying stock price'],
        correct: 1
      },
      {
        q: 'One standard options contract controls how many shares?',
        options: ['10 shares', '50 shares', '100 shares', '1000 shares'],
        correct: 2
      },
      {
        q: 'If you SELL a put option, you are:',
        options: ['Buying the right to sell shares', 'Taking on the obligation to buy shares if assigned', 'Guaranteed to make money', 'Buying shares immediately'],
        correct: 1
      }
    ]
  },
  'greeks-quiz': {
    title: 'Understanding the Greeks Quiz',
    questions: [
      {
        q: 'What does Delta measure?',
        options: ['Time decay per day', 'Price change per $1 stock move', 'Volatility sensitivity', 'Interest rate sensitivity'],
        correct: 1
      },
      {
        q: 'A put option with delta of -0.25 has approximately what probability of expiring worthless?',
        options: ['25%', '50%', '75%', '100%'],
        correct: 2
      },
      {
        q: 'Theta decay accelerates:',
        options: ['In the first month', 'Evenly throughout the option life', 'As expiration approaches', 'Only on weekends'],
        correct: 2
      },
      {
        q: 'As an option SELLER, theta works:',
        options: ['Against you', 'In your favor', 'Has no effect', 'Only on calls'],
        correct: 1
      },
      {
        q: 'High Implied Volatility means:',
        options: ['Lower option premiums', 'Higher option premiums', 'Guaranteed profit', 'The stock will definitely move'],
        correct: 1
      },
      {
        q: 'When is the best time to SELL options based on IV?',
        options: ['When IV is low', 'When IV is elevated (high IV rank)', 'Right before earnings', 'IV doesn\'t matter'],
        correct: 1
      }
    ]
  },
  'wheel-quiz': {
    title: 'The Wheel Strategy Quiz',
    questions: [
      {
        q: 'The Wheel Strategy consists of which two main phases?',
        options: ['Buy calls, buy puts', 'Sell cash secured puts, sell covered calls', 'Buy shares, sell shares', 'Day trading, swing trading'],
        correct: 1
      },
      {
        q: 'Why is it called "Cash SECURED" puts?',
        options: ['Because you need a security deposit', 'Because you must have cash to buy shares if assigned', 'Because the broker secures your money', 'Because it\'s a guaranteed profit'],
        correct: 1
      },
      {
        q: 'When selling a CSP, you WIN if the stock:',
        options: ['Only goes up significantly', 'Goes up, stays flat, or drops a little', 'Only stays perfectly flat', 'Goes to zero'],
        correct: 1
      },
      {
        q: 'After getting assigned on a CSP, your next step in the wheel is to:',
        options: ['Sell the shares immediately', 'Buy more puts', 'Sell covered calls on your shares', 'Wait for the stock to recover'],
        correct: 2
      },
      {
        q: 'The wheel strategy works best for traders who:',
        options: ['Want quick, large profits', 'Are patient and seek consistent income', 'Only trade during bull markets', 'Prefer high-risk speculation'],
        correct: 1
      }
    ]
  },
  'csp-quiz': {
    title: 'Cash Secured Puts Quiz',
    questions: [
      {
        q: 'What does "Cash Secured" mean?',
        options: ['Using margin to back your puts', 'Having full cash to buy shares if assigned', 'Keeping cash in a savings account', 'Using a secured credit card'],
        correct: 1
      },
      {
        q: 'You should only sell CSPs on stocks that:',
        options: ['Have the highest IV possible', 'You would be happy to own at the strike price', 'Are in a strong downtrend', 'Are about to report earnings'],
        correct: 1
      },
      {
        q: 'A 0.30 delta put has approximately what probability of expiring worthless?',
        options: ['30%', '50%', '70%', '90%'],
        correct: 2
      },
      {
        q: 'When should you roll a CSP?',
        options: ['Immediately after opening', 'When the stock gaps up', 'When approaching the strike and you want to avoid assignment', 'Never roll, always take assignment'],
        correct: 2
      },
      {
        q: 'The golden rule of rolling is:',
        options: ['Always roll to the same strike', 'Only roll for a credit', 'Roll as soon as possible', 'Never roll puts'],
        correct: 1
      },
      {
        q: 'If you get assigned on a CSP, your next step in the wheel is:',
        options: ['Sell the shares immediately', 'Sell covered calls on the shares', 'Buy more puts', 'Stop trading'],
        correct: 1
      }
    ]
  },
  'cc-quiz': {
    title: 'Covered Calls Quiz',
    questions: [
      {
        q: 'What makes a call "covered"?',
        options: ['Having insurance on the position', 'Owning 100 shares of the underlying stock', 'Using margin', 'Buying another call to hedge'],
        correct: 1
      },
      {
        q: 'If your covered call is exercised (shares called away), you:',
        options: ['Lose your shares and all premium', 'Keep the premium and sell shares at the strike price', 'Must buy more shares', 'Get nothing'],
        correct: 1
      },
      {
        q: 'When is a good time to sell a covered call?',
        options: ['When the stock just crashed 50%', 'When IV is elevated and you\'d be happy selling at the strike', 'Right before earnings', 'When you need the shares for another trade'],
        correct: 1
      },
      {
        q: 'If you\'re "underwater" on shares (cost basis higher than current price), you should:',
        options: ['Never sell covered calls', 'Sell calls at strikes where premium + strike ‚â• cost basis', 'Sell immediately at market price', 'Buy more shares to average down'],
        correct: 1
      },
      {
        q: 'Rolling a covered call means:',
        options: ['Letting it expire', 'Buying back the current call and selling a new one', 'Converting it to a put', 'Exercising the option'],
        correct: 1
      }
    ]
  },
  'beau-quiz': {
    title: 'Elite Strategy Final Assessment',
    questions: [
      {
        q: 'What is the target weekly return in Beau\'s strategy?',
        options: ['5-10%', '2-3%', '0.5-1%', '10-20%'],
        correct: 2
      },
      {
        q: 'What delta range does Beau use for both CSPs and CCs?',
        options: ['0.10-0.20', '0.20-0.30', '0.40-0.90', '0.95-1.00'],
        correct: 2
      },
      {
        q: 'What is the maximum number of concurrent positions recommended?',
        options: ['1', '3', '5', '10'],
        correct: 1
      },
      {
        q: 'What should you ALWAYS avoid holding options through?',
        options: ['Weekends', 'Earnings announcements', 'Lunch time', 'The last hour of trading'],
        correct: 1
      },
      {
        q: 'The cardinal rule of rolling is:',
        options: ['Always roll to the same strike', 'Never roll - take assignment', 'Only roll for a credit', 'Roll every position'],
        correct: 2
      },
      {
        q: 'What type of stocks should you target?',
        options: ['Stocks in downtrends for cheaper prices', 'Uptrending stocks with higher IV', 'Any stock with high IV', 'Only penny stocks'],
        correct: 1
      },
      {
        q: '"Cash Secured" means:',
        options: ['Using margin as backup', 'Having 50% of the cash needed', 'Having 100% cash to buy shares if assigned', 'Keeping cash in a safe'],
        correct: 2
      },
      {
        q: 'What DTE (days to expiration) does Beau prefer?',
        options: ['60-90 days', '30-45 days', 'Same week', '6 months'],
        correct: 2
      },
      {
        q: 'Why is "understanding the full wheel before starting" emphasized?',
        options: ['It\'s not important, just start trading', 'Half-knowledge leads to panic decisions', 'It\'s a legal requirement', 'To impress other traders'],
        correct: 1
      },
      {
        q: 'The core philosophy can be summarized as:',
        options: ['Get rich quick', 'Slow and consistent wins', 'Maximum risk for maximum reward', 'Trade as much as possible'],
        correct: 1
      }
    ]
  }
};

function showQuiz(moduleId, chapterId) {
  const quiz = QUIZZES[chapterId];
  if (!quiz) {
    $('learnContent').innerHTML = '<p>Quiz not found.</p>';
    return;
  }

  currentQuiz = { moduleId, chapterId, quiz };
  quizAnswers = {};

  let html = `
    <div class="quiz-container">
      <div style="text-align:center;margin-bottom:24px">
        <div style="font-size:48px;margin-bottom:12px">üìù</div>
        <h3 style="margin:0 0 8px 0">${quiz.title}</h3>
        <p style="color:var(--text2);margin:0">${quiz.questions.length} questions ¬∑ Must pass to continue</p>
      </div>

      <div id="quizQuestions">
  `;

  quiz.questions.forEach((question, qIdx) => {
    html += `
      <div class="quiz-question" data-q="${qIdx}">
        <div style="font-weight:600;margin-bottom:12px">${qIdx + 1}. ${question.q}</div>
        <div class="quiz-options">
    `;
    question.options.forEach((opt, oIdx) => {
      html += `<button class="quiz-option" data-q="${qIdx}" data-o="${oIdx}" onclick="selectQuizAnswer(${qIdx}, ${oIdx})">${opt}</button>`;
    });
    html += '</div></div>';
  });

  html += `
      </div>
      <button class="btn" style="width:100%;margin-top:20px" onclick="submitQuiz()">Submit Answers</button>
    </div>
  `;

  $('learnContent').innerHTML = html;
}

function selectQuizAnswer(qIdx, oIdx) {
  quizAnswers[qIdx] = oIdx;
  document.querySelectorAll(`.quiz-option[data-q="${qIdx}"]`).forEach(btn => {
    btn.classList.remove('selected');
  });
  document.querySelector(`.quiz-option[data-q="${qIdx}"][data-o="${oIdx}"]`).classList.add('selected');
}

function submitQuiz() {
  if (!currentQuiz) return;

  const quiz = currentQuiz.quiz;
  const total = quiz.questions.length;

  // Check all questions are answered
  const answered = Object.keys(quizAnswers).length;
  if (answered < total) {
    showToast(`Please answer all ${total} questions (${answered}/${total} answered)`, 'error');
    return;
  }

  let correct = 0;

  quiz.questions.forEach((q, idx) => {
    const userAnswer = quizAnswers[idx];
    const optionBtns = document.querySelectorAll(`.quiz-option[data-q="${idx}"]`);

    optionBtns.forEach((btn, oIdx) => {
      btn.disabled = true;
      if (oIdx === q.correct) {
        btn.classList.add('correct');
      } else if (oIdx === userAnswer && userAnswer !== q.correct) {
        btn.classList.add('incorrect');
      }
    });

    if (userAnswer === q.correct) correct++;
  });

  const pct = Math.round((correct / total) * 100);
  const passed = pct >= 80;

  const resultsHtml = `
    <div style="text-align:center;margin-top:24px;padding:20px;background:var(--${passed ? 'green' : 'red'}-bg);border-radius:12px">
      <div style="font-size:36px;margin-bottom:8px">${passed ? 'üéâ' : 'üìö'}</div>
      <div style="font-size:24px;font-weight:700;color:var(--${passed ? 'green' : 'red'})">${pct}%</div>
      <div style="color:var(--text2);margin-top:4px">${correct}/${total} correct</div>
      <div style="margin-top:12px;font-weight:600">${passed ? 'Congratulations! You passed!' : 'You need 80% to pass. Review the material and try again.'}</div>
    </div>
    <div style="display:flex;gap:12px;margin-top:16px">
      ${passed ? `<button class="btn" style="flex:1" onclick="completeLesson('${currentQuiz.chapterId}');showModuleList()">Complete Module</button>` : `<button class="btn btn-outline" style="flex:1" onclick="showChapterList('${currentQuiz.moduleId}')">Review Lessons</button><button class="btn" style="flex:1" onclick="showQuiz('${currentQuiz.moduleId}', '${currentQuiz.chapterId}')">Retry Quiz</button>`}
    </div>
  `;

  document.querySelector('.quiz-container').insertAdjacentHTML('beforeend', resultsHtml);
  document.querySelector('.quiz-container > .btn').remove();
}

// Lesson Content
function getLessonContent(chapterId) {
  const content = {
    // MODULE 1: OPTIONS FUNDAMENTALS
    'what-are-options': `
      <h2>What Are Options?</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/7PM4rNDr4oI" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@InTheMoney" target="_blank">InTheMoney</a></div>

      <p>Options are <strong>financial contracts</strong> that give you the right‚Äîbut not the obligation‚Äîto buy or sell an underlying asset (like a stock) at a predetermined price within a specific time period.</p>

      <div class="callout blue">
        <strong>Key Insight:</strong> Unlike buying stocks where you own part of a company, options give you the <em>right</em> to transact at a certain price. This right has value, which is why options have a price (premium).
      </div>

      <h3>The Building Blocks</h3>

      <p>Every options contract has these essential components:</p>

      <ul>
        <li><strong>Underlying Asset</strong> - The stock or ETF the option is based on (e.g., AAPL, SPY)</li>
        <li><strong>Strike Price</strong> - The price at which you can buy/sell the underlying</li>
        <li><strong>Expiration Date</strong> - When the contract expires and becomes worthless</li>
        <li><strong>Premium</strong> - The price you pay (or receive) for the option contract</li>
        <li><strong>Contract Size</strong> - Standard options control 100 shares per contract</li>
      </ul>

      <div class="callout green">
        <strong>Example:</strong> If you buy 1 AAPL $150 Call expiring in 30 days for $3.00 premium, you're paying $300 (100 shares √ó $3) for the right to buy 100 shares of Apple at $150/share anytime before expiration.
      </div>

      <h3>Buyers vs Sellers</h3>

      <p>Options trading has two sides to every transaction:</p>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0">
        <div style="background:var(--blue-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--blue);margin-bottom:8px">Option Buyers</div>
          <ul style="margin:0;padding-left:20px;font-size:14px">
            <li>Pay premium upfront</li>
            <li>Have rights, no obligations</li>
            <li>Limited risk (premium paid)</li>
            <li>Need the stock to move</li>
          </ul>
        </div>
        <div style="background:var(--green-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--green);margin-bottom:8px">Option Sellers</div>
          <ul style="margin:0;padding-left:20px;font-size:14px">
            <li>Collect premium upfront</li>
            <li>Have obligations if assigned</li>
            <li>Profit from time decay</li>
            <li>Can profit if stock stays flat</li>
          </ul>
        </div>
      </div>

      <div class="callout orange">
        <strong>Why This Matters:</strong> In the Wheel Strategy, you are primarily an option SELLER. You collect premium and let time work in your favor. Understanding this distinction is crucial.
      </div>

      <h3>Why Trade Options?</h3>

      <p>Options offer several advantages over simply buying stocks:</p>

      <ol>
        <li><strong>Generate Income</strong> - Sell options to collect premium consistently</li>
        <li><strong>Leverage</strong> - Control more shares with less capital</li>
        <li><strong>Flexibility</strong> - Profit in up, down, or sideways markets</li>
        <li><strong>Defined Risk</strong> - Know your maximum loss upfront (when buying)</li>
        <li><strong>Lower Cost Basis</strong> - Use premium to reduce your entry price on stocks</li>
      </ol>
    `,

    'calls-vs-puts': `
      <h2>Calls vs Puts Explained</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/MiybniIIvx0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@InTheMoney" target="_blank">InTheMoney</a></div>

      <p>There are only two types of options: <strong>CALLS</strong> and <strong>PUTS</strong>. Understanding the difference is fundamental to everything we do.</p>

      <h3>CALL Options</h3>

      <div style="background:var(--blue-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-size:24px;margin-bottom:8px">üìà CALL = Right to BUY</div>
        <p style="margin:0">A call option gives the holder the right to <strong>BUY</strong> 100 shares at the strike price before expiration.</p>
      </div>

      <p><strong>Buying a Call:</strong> You're bullish. You want the stock to go UP. If the stock rises above your strike price, you can buy shares at a discount or sell the option for profit.</p>

      <p><strong>Selling a Call:</strong> You're neutral to slightly bullish. You collect premium and hope the stock stays below the strike price so the option expires worthless and you keep the premium.</p>

      <div class="callout green">
        <strong>Covered Call Example:</strong> You own 100 shares of AAPL at $150. You sell a $160 Call for $2.00 premium. You collect $200. If AAPL stays below $160, you keep the premium AND your shares. If it goes above $160, your shares get "called away" (sold) at $160.
      </div>

      <h3>PUT Options</h3>

      <div style="background:var(--green-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-size:24px;margin-bottom:8px">üìâ PUT = Right to SELL</div>
        <p style="margin:0">A put option gives the holder the right to <strong>SELL</strong> 100 shares at the strike price before expiration.</p>
      </div>

      <p><strong>Buying a Put:</strong> You're bearish or want protection. You want the stock to go DOWN. If it drops below your strike, you can sell shares at a higher price than market value.</p>

      <p><strong>Selling a Put:</strong> You're bullish. You want to buy the stock at a lower price. You collect premium and if the stock drops below your strike, you buy 100 shares at that price (minus the premium collected).</p>

      <div class="callout green">
        <strong>Cash Secured Put Example:</strong> AAPL is at $150. You sell a $145 Put for $2.50 premium. You collect $250. If AAPL stays above $145, you keep the premium. If it drops below $145, you buy 100 shares at $145 (but your effective cost is $142.50 after premium).
      </div>

      <h3>Quick Reference Chart</h3>

      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;font-size:14px;margin:16px 0">
          <tr style="background:var(--input)">
            <th style="padding:12px;text-align:left;border-bottom:1px solid var(--border)">Action</th>
            <th style="padding:12px;text-align:left;border-bottom:1px solid var(--border)">Outlook</th>
            <th style="padding:12px;text-align:left;border-bottom:1px solid var(--border)">Max Profit</th>
            <th style="padding:12px;text-align:left;border-bottom:1px solid var(--border)">Max Loss</th>
          </tr>
          <tr>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Buy Call</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Bullish</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Unlimited</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Premium paid</td>
          </tr>
          <tr>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Sell Call</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Neutral/Bearish</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Premium received</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Unlimited (if naked)</td>
          </tr>
          <tr>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Buy Put</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Bearish</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Strike - Premium</td>
            <td style="padding:12px;border-bottom:1px solid var(--border)">Premium paid</td>
          </tr>
          <tr>
            <td style="padding:12px">Sell Put</td>
            <td style="padding:12px">Bullish</td>
            <td style="padding:12px">Premium received</td>
            <td style="padding:12px">Strike √ó 100 - Premium</td>
          </tr>
        </table>
      </div>

      <div class="callout orange">
        <strong>The Wheel Strategy Focus:</strong> We primarily SELL puts (cash secured) and SELL calls (covered). We're collecting premium and using time decay to our advantage. Buying options is speculation; selling options is income generation.
      </div>
    `,

    'key-terms': `
      <h2>Essential Options Terms</h2>

      <p>Before diving deeper, you need to master these key terms. Bookmark this lesson for reference!</p>

      <h3>The Core Terms</h3>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--blue);font-size:16px">Strike Price</div>
        <p style="margin:8px 0 0 0">The price at which the underlying stock can be bought (call) or sold (put). This is the "target" price of your contract.</p>
      </div>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--green);font-size:16px">Premium</div>
        <p style="margin:8px 0 0 0">The price of the options contract. Quoted per share, so multiply by 100 for total cost. A $2.50 premium = $250 per contract.</p>
      </div>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--purple);font-size:16px">Expiration Date (DTE)</div>
        <p style="margin:8px 0 0 0">The date when the option contract expires. DTE = Days To Expiration. After this date, the option is worthless.</p>
      </div>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--orange);font-size:16px">Assignment</div>
        <p style="margin:8px 0 0 0">When an option seller is required to fulfill their obligation. Put sellers buy shares; call sellers sell shares.</p>
      </div>

      <h3>Money-ness Terms</h3>

      <p>These terms describe where the stock price is relative to the strike:</p>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="background:var(--green-bg);padding:16px;border-radius:12px">
          <strong style="color:var(--green)">In The Money (ITM)</strong>
          <p style="margin:4px 0 0 0;font-size:14px">The option has intrinsic value. For calls: stock > strike. For puts: stock < strike. Higher chance of assignment.</p>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px">
          <strong>At The Money (ATM)</strong>
          <p style="margin:4px 0 0 0;font-size:14px">Stock price equals or is very close to the strike price. Maximum extrinsic value.</p>
        </div>
        <div style="background:var(--blue-bg);padding:16px;border-radius:12px">
          <strong style="color:var(--blue)">Out of The Money (OTM)</strong>
          <p style="margin:4px 0 0 0;font-size:14px">The option has no intrinsic value. For calls: stock < strike. For puts: stock > strike. Lower premium but higher probability of expiring worthless.</p>
        </div>
      </div>

      <div class="callout green">
        <strong>Wheel Strategy Note:</strong> We typically sell OTM options. This gives us a "cushion" - the stock can move against us somewhat and we still profit from time decay.
      </div>

      <h3>Value Terms</h3>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--blue)">Intrinsic Value</div>
        <p style="margin:8px 0 0 0">The real, tangible value if exercised right now. ITM amount. A $100 call when stock is $105 has $5 intrinsic value.</p>
      </div>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--purple)">Extrinsic Value (Time Value)</div>
        <p style="margin:8px 0 0 0">The "hope" value - premium above intrinsic value based on time remaining and volatility. This decays as expiration approaches.</p>
      </div>

      <h3>Action Terms</h3>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--green)">Open / Close</div>
        <p style="margin:8px 0 0 0">"Open" = entering a new position. "Close" = exiting an existing position. You can open by buying OR selling.</p>
      </div>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--orange)">Rolling</div>
        <p style="margin:8px 0 0 0">Closing your current option and opening a new one, usually at a different strike or expiration. Used to manage positions and collect more premium.</p>
      </div>

      <div class="term-card" style="background:var(--input);padding:16px;border-radius:12px;margin:12px 0">
        <div style="font-weight:700;color:var(--blue)">Exercise</div>
        <p style="margin:8px 0 0 0">The option buyer uses their right to buy (call) or sell (put) shares at the strike price. Happens automatically at expiration if ITM.</p>
      </div>
    `,

    'options-pricing': `
      <h2>How Options Are Priced</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/kCJcEOYuuII" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@projectfinance" target="_blank">projectfinance</a></div>

      <p>Understanding what drives option prices is crucial for consistent profitability. Option premiums aren't random‚Äîthey're based on mathematical models influenced by several factors.</p>

      <h3>The Premium Formula</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;text-align:center;margin:16px 0">
        <div style="font-size:18px;font-weight:600">Option Premium = Intrinsic Value + Extrinsic Value</div>
      </div>

      <p><strong>Intrinsic Value:</strong> The amount the option is ITM. If stock is $105 and you have a $100 call, intrinsic value = $5. OTM options have $0 intrinsic value.</p>

      <p><strong>Extrinsic Value:</strong> Everything else‚Äîtime value + volatility premium. This is what decays over time and what we profit from as sellers.</p>

      <h3>The 5 Factors That Affect Price</h3>

      <div style="margin:20px 0">
        <div style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--input);border-radius:12px;margin-bottom:10px">
          <div style="width:40px;height:40px;background:var(--blue-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">üìä</div>
          <div style="flex:1">
            <div style="font-weight:600">Stock Price vs Strike</div>
            <div style="font-size:13px;color:var(--text2)">How far ITM or OTM the option is</div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--input);border-radius:12px;margin-bottom:10px">
          <div style="width:40px;height:40px;background:var(--purple-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">‚è±Ô∏è</div>
          <div style="flex:1">
            <div style="font-weight:600">Time to Expiration</div>
            <div style="font-size:13px;color:var(--text2)">More time = more premium (and more decay to capture)</div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--input);border-radius:12px;margin-bottom:10px">
          <div style="width:40px;height:40px;background:var(--orange-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">üìà</div>
          <div style="flex:1">
            <div style="font-weight:600">Implied Volatility (IV)</div>
            <div style="font-size:13px;color:var(--text2)">Higher IV = higher premiums (good for sellers!)</div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--input);border-radius:12px;margin-bottom:10px">
          <div style="width:40px;height:40px;background:var(--green-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">üíµ</div>
          <div style="flex:1">
            <div style="font-weight:600">Interest Rates</div>
            <div style="font-size:13px;color:var(--text2)">Minor impact, affects cost of carry</div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--input);border-radius:12px">
          <div style="width:40px;height:40px;background:var(--red-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">üí∞</div>
          <div style="flex:1">
            <div style="font-weight:600">Dividends</div>
            <div style="font-size:13px;color:var(--text2)">Expected dividends reduce call prices, increase put prices</div>
          </div>
        </div>
      </div>

      <h3>Time Decay: The Seller's Edge</h3>

      <p>This is the most important concept for wheel traders. Options lose value every day simply due to the passage of time. This is called <strong>theta decay</strong>.</p>

      <div class="callout green">
        <strong>Key Insight:</strong> Time decay accelerates as expiration approaches. An option loses more value in its final week than in its first month. This is why we often sell weekly options‚Äîmaximum decay, minimum time for things to go wrong.
      </div>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Time Decay Curve</div>
        <div style="display:flex;align-items:flex-end;height:100px;gap:4px">
          <div style="flex:1;background:var(--green);border-radius:4px 4px 0 0;height:95%"></div>
          <div style="flex:1;background:var(--green);border-radius:4px 4px 0 0;height:90%"></div>
          <div style="flex:1;background:var(--green);border-radius:4px 4px 0 0;height:82%"></div>
          <div style="flex:1;background:var(--green);border-radius:4px 4px 0 0;height:72%"></div>
          <div style="flex:1;background:var(--green);border-radius:4px 4px 0 0;height:60%"></div>
          <div style="flex:1;background:var(--orange);border-radius:4px 4px 0 0;height:45%"></div>
          <div style="flex:1;background:var(--orange);border-radius:4px 4px 0 0;height:28%"></div>
          <div style="flex:1;background:var(--red);border-radius:4px 4px 0 0;height:10%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:12px;color:var(--text2)">
          <span>45 DTE</span>
          <span>30 DTE</span>
          <span>14 DTE</span>
          <span>7 DTE</span>
          <span>Exp</span>
        </div>
      </div>

      <h3>Implied Volatility Explained</h3>

      <p>Implied Volatility (IV) is the market's expectation of how much a stock will move. High IV = expensive options. Low IV = cheap options.</p>

      <ul>
        <li><strong>High IV events:</strong> Earnings, FDA announcements, major news</li>
        <li><strong>We prefer:</strong> Elevated IV (good premiums) but not during binary events</li>
        <li><strong>IV Crush:</strong> After events, IV drops rapidly. Great for sellers who entered before.</li>
      </ul>

      <div class="callout orange">
        <strong>Beau's Approach:</strong> Look for stocks with higher IV that are in an uptrend. This gives you better premium while the trend provides a tailwind. Avoid selling options right before earnings‚Äîthe IV crush isn't worth the binary risk.
      </div>
    `,

    // MODULE 2: UNDERSTANDING THE GREEKS
    'delta-explained': `
      <h2>Delta: Direction & Probability</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/GxmIvvROge4" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@InTheMoney" target="_blank">InTheMoney</a></div>

      <p>Delta is arguably the most important Greek for wheel traders. It tells you two critical things: how much your option price will change when the stock moves, and your approximate probability of profit.</p>

      <h3>What Delta Measures</h3>

      <div style="background:var(--blue-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">Delta = Price Change per $1 Stock Move</div>
        <p style="margin:0">A delta of 0.30 means your option gains/loses $0.30 for every $1 the stock moves (or $30 per contract).</p>
      </div>

      <h3>Delta Values</h3>

      <ul>
        <li><strong>CALLS:</strong> Delta ranges from 0 to +1.00</li>
        <li><strong>PUTS:</strong> Delta ranges from 0 to -1.00</li>
        <li><strong>At The Money:</strong> Delta is approximately ¬±0.50</li>
        <li><strong>Deep ITM:</strong> Delta approaches ¬±1.00</li>
        <li><strong>Far OTM:</strong> Delta approaches 0</li>
      </ul>

      <h3>Delta as Probability</h3>

      <p>Here's the powerful part: <strong>Delta approximates the probability of expiring ITM</strong>.</p>

      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:20px 0">
        <div style="background:var(--green-bg);padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:28px;font-weight:700;color:var(--green)">0.20</div>
          <div style="font-size:13px;color:var(--text2)">~20% chance ITM</div>
          <div style="font-size:12px;margin-top:4px">80% win rate</div>
        </div>
        <div style="background:var(--orange-bg);padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:28px;font-weight:700;color:var(--orange)">0.30</div>
          <div style="font-size:13px;color:var(--text2)">~30% chance ITM</div>
          <div style="font-size:12px;margin-top:4px">70% win rate</div>
        </div>
        <div style="background:var(--blue-bg);padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:28px;font-weight:700;color:var(--blue)">0.50</div>
          <div style="font-size:13px;color:var(--text2)">~50% chance ITM</div>
          <div style="font-size:12px;margin-top:4px">50% win rate</div>
        </div>
      </div>

      <div class="callout green">
        <strong>For Put Sellers:</strong> If you sell a put with a delta of -0.25, there's approximately a 75% chance it expires worthless (you keep full premium) and only 25% chance you'll be assigned.
      </div>

      <h3>Delta for The Wheel</h3>

      <p>As wheel traders, we use delta to select our strike prices:</p>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)">
          <span>Conservative</span>
          <span style="font-weight:600">0.15 - 0.20 delta</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)">
          <span>Standard</span>
          <span style="font-weight:600">0.20 - 0.30 delta</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0">
          <span>Aggressive</span>
          <span style="font-weight:600">0.30 - 0.40 delta</span>
        </div>
      </div>

      <div class="callout orange">
        <strong>Beau's Delta Range:</strong> 0.40 - 0.90 delta. This is more aggressive than many traders recommend, but when you combine it with proper stock selection (uptrending stocks with higher IV) and short DTE (same week), the higher premium collected compensates for the increased risk.
      </div>

      <h3>Important Delta Concepts</h3>

      <ul>
        <li><strong>Delta Changes:</strong> As the stock moves, delta changes. This is measured by Gamma (next lesson's topic).</li>
        <li><strong>100 Shares = Delta 1.00:</strong> Owning 100 shares is like having +100 delta. This is why covered calls reduce your effective delta.</li>
        <li><strong>Delta Neutral:</strong> Advanced traders balance deltas to reduce directional exposure.</li>
      </ul>
    `,

    'theta-decay': `
      <h2>Theta: Time Decay</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/kCJcEOYuuII" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@projectfinance" target="_blank">projectfinance</a></div>

      <p>Theta is the option seller's best friend. It represents how much value an option loses each day simply due to time passing. As a wheel trader, <strong>theta works FOR you</strong>.</p>

      <h3>What Theta Measures</h3>

      <div style="background:var(--green-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">Theta = Daily Time Decay in Dollars</div>
        <p style="margin:0">A theta of -0.05 means the option loses $0.05 per day ($5 per contract). As a seller, you're collecting this decay!</p>
      </div>

      <h3>The Theta Decay Curve</h3>

      <p>Time decay is NOT linear‚Äîit accelerates as expiration approaches. This is crucial for strategy:</p>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px;text-align:center">Option Value Over Time</div>
        <div style="display:flex;align-items:flex-end;height:120px;gap:2px;padding:0 10px">
          <div style="flex:1;background:linear-gradient(to top, var(--green), var(--green-bg));border-radius:4px 4px 0 0;height:98%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--green), var(--green-bg));border-radius:4px 4px 0 0;height:96%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--green), var(--green-bg));border-radius:4px 4px 0 0;height:93%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--green), var(--green-bg));border-radius:4px 4px 0 0;height:89%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--green), var(--green-bg));border-radius:4px 4px 0 0;height:84%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--green), var(--green-bg));border-radius:4px 4px 0 0;height:78%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--orange), var(--orange-bg));border-radius:4px 4px 0 0;height:70%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--orange), var(--orange-bg));border-radius:4px 4px 0 0;height:60%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--orange), var(--orange-bg));border-radius:4px 4px 0 0;height:48%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--red), var(--red-bg));border-radius:4px 4px 0 0;height:32%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--red), var(--red-bg));border-radius:4px 4px 0 0;height:15%"></div>
          <div style="flex:1;background:linear-gradient(to top, var(--red), var(--red-bg));border-radius:4px 4px 0 0;height:3%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:11px;color:var(--text2)">
          <span>60 DTE</span>
          <span>45 DTE</span>
          <span>30 DTE</span>
          <span>14 DTE</span>
          <span>7 DTE</span>
          <span>Exp</span>
        </div>
      </div>

      <div class="callout blue">
        <strong>Key Insight:</strong> About 1/3 of an option's time value decays in the final week before expiration. This is why selling weekly options is so attractive‚Äîmaximum decay in minimum time.
      </div>

      <h3>Theta by Strike Price</h3>

      <p>Not all options decay at the same rate:</p>

      <ul>
        <li><strong>ATM options</strong> have the highest theta (most time value to decay)</li>
        <li><strong>ITM options</strong> have less theta (more intrinsic value, less time value)</li>
        <li><strong>OTM options</strong> have moderate theta but decay to zero faster</li>
      </ul>

      <h3>Using Theta in The Wheel</h3>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Daily Theta Example</div>
        <p style="font-size:14px;margin:0">You sell a put with theta of -$8/day. If the stock stays flat for 5 days, the option loses $40 in value‚Äîthat's $40 profit for you without the stock moving at all!</p>
      </div>

      <h3>Theta Strategies</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="background:var(--green-bg);padding:16px;border-radius:12px">
          <strong style="color:var(--green)">Sell Weeklies</strong>
          <p style="margin:4px 0 0 0;font-size:14px">Maximum theta decay per day. Less time for things to go wrong. This is Beau's preferred approach.</p>
        </div>
        <div style="background:var(--blue-bg);padding:16px;border-radius:12px">
          <strong style="color:var(--blue)">30-45 DTE Entry</strong>
          <p style="margin:4px 0 0 0;font-size:14px">Traditional approach. Enter at 30-45 DTE, exit at 21 DTE or 50% profit. Captures the sweet spot of decay.</p>
        </div>
        <div style="background:var(--orange-bg);padding:16px;border-radius:12px">
          <strong style="color:var(--orange)">Let It Expire</strong>
          <p style="margin:4px 0 0 0;font-size:14px">Hold until expiration to capture 100% of premium and avoid closing fees. Requires more monitoring near expiration.</p>
        </div>
      </div>

      <div class="callout green">
        <strong>Beau's Approach:</strong> Sell same-week options and let them expire worthless. This maximizes theta decay per day, minimizes time in the trade, and avoids paying closing commissions. The key is proper strike selection to avoid assignment.
      </div>
    `,

    'iv-vega': `
      <h2>Implied Volatility & Vega</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/OtRsMJfxqKE" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@tastylive" target="_blank">tastylive</a></div>

      <p>Implied Volatility (IV) and its Greek, Vega, are crucial for maximizing premium collection. Understanding IV is what separates profitable wheel traders from the rest.</p>

      <h3>What is Implied Volatility?</h3>

      <div style="background:var(--orange-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">IV = Market's Expected Future Movement</div>
        <p style="margin:0">IV represents how much the market expects a stock to move over the next year, expressed as a percentage. Higher IV = more expensive options.</p>
      </div>

      <h3>IV Ranges</h3>

      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:16px 0">
        <div style="background:var(--input);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--blue)">Low IV (10-25%)</div>
          <p style="font-size:13px;margin:8px 0 0 0">Blue chip stocks, utilities, stable companies. Lower premiums but more predictable.</p>
          <div style="font-size:12px;color:var(--text3);margin-top:4px">Examples: JNJ, PG, KO</div>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--green)">Moderate IV (25-45%)</div>
          <p style="font-size:13px;margin:8px 0 0 0">Growth stocks, tech companies. Good balance of premium and risk.</p>
          <div style="font-size:12px;color:var(--text3);margin-top:4px">Examples: AAPL, MSFT, GOOGL</div>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--orange)">High IV (45-80%)</div>
          <p style="font-size:13px;margin:8px 0 0 0">Volatile stocks, meme stocks, pre-earnings. Excellent premium but higher risk.</p>
          <div style="font-size:12px;color:var(--text3);margin-top:4px">Examples: TSLA, AMD, NVDA</div>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--red)">Extreme IV (80%+)</div>
          <p style="font-size:13px;margin:8px 0 0 0">Meme stocks, biotech, extreme events. Very high premium but dangerous.</p>
          <div style="font-size:12px;color:var(--text3);margin-top:4px">Examples: GME, AMC, SPCE</div>
        </div>
      </div>

      <h3>IV Rank & IV Percentile</h3>

      <p>Raw IV numbers don't tell the whole story. You need context:</p>

      <ul>
        <li><strong>IV Rank:</strong> Where current IV sits relative to its 52-week range. IV Rank of 50 means IV is halfway between its yearly low and high.</li>
        <li><strong>IV Percentile:</strong> What percentage of days in the past year had lower IV. 80th percentile means IV is higher than 80% of the past year.</li>
      </ul>

      <div class="callout green">
        <strong>Best Time to Sell:</strong> When IV Rank is above 50 (preferably above 70). Options are "expensive" relative to their normal levels, so you collect more premium for the same risk.
      </div>

      <h3>What is Vega?</h3>

      <div style="background:var(--purple-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">Vega = Price Change per 1% IV Move</div>
        <p style="margin:0">A vega of 0.10 means the option gains/loses $0.10 for every 1% change in IV ($10 per contract).</p>
      </div>

      <h3>IV Crush</h3>

      <p>One of the most important concepts for option sellers:</p>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <strong>IV Crush</strong> happens when IV drops rapidly, typically after an anticipated event (earnings, FDA decisions, etc.). Options lose value regardless of stock direction.
      </div>

      <p>As a seller, IV crush works in your favor IF you sold before the event. However, selling right before earnings is risky because the stock might move more than expected.</p>

      <h3>Using IV in The Wheel</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">‚úÖ</div>
          <div>
            <div style="font-weight:600">Sell when IV is elevated</div>
            <div style="font-size:13px;color:var(--text2)">Higher premium for the same strike/expiration</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">‚úÖ</div>
          <div>
            <div style="font-weight:600">Look for uptrending stocks with higher IV</div>
            <div style="font-size:13px;color:var(--text2)">Trend gives you a tailwind while IV boosts premium</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">‚ö†Ô∏è</div>
          <div>
            <div style="font-weight:600">Avoid selling right before earnings</div>
            <div style="font-size:13px;color:var(--text2)">Binary event risk outweighs IV crush benefit</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">‚ö†Ô∏è</div>
          <div>
            <div style="font-weight:600">Be cautious with extreme IV</div>
            <div style="font-size:13px;color:var(--text2)">IV is high for a reason‚Äîbig moves expected</div>
          </div>
        </div>
      </div>

      <div class="callout orange">
        <strong>Beau's Approach:</strong> Target stocks with elevated IV (above average for that stock) that are in a clear uptrend. The combination of higher IV (better premium) and bullish trend (lower assignment risk) is the sweet spot for consistent weekly income.
      </div>
    `,

    // MODULE 3: THE WHEEL STRATEGY OVERVIEW
    'wheel-intro': `
      <h2>What Is The Wheel Strategy?</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/dRYBh6dtxjY" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@InTheMoney" target="_blank">InTheMoney</a></div>

      <p>The Wheel Strategy is a systematic approach to generating consistent income from options while building positions in stocks you want to own. It's called "The Wheel" because it cycles between two phases repeatedly.</p>

      <div style="background:var(--green-bg);padding:24px;border-radius:16px;margin:20px 0;text-align:center">
        <div style="font-size:48px;margin-bottom:12px">üé°</div>
        <div style="font-size:20px;font-weight:700;margin-bottom:8px">The Wheel = CSP ‚Üí Shares ‚Üí CC ‚Üí Repeat</div>
        <p style="margin:0;color:var(--text2)">A continuous cycle of selling puts, owning shares, and selling calls</p>
      </div>

      <h3>The Two Phases</h3>

      <div style="display:grid;gap:16px;margin:20px 0">
        <div style="background:var(--input);padding:20px;border-radius:12px;border-left:4px solid var(--green)">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
            <div style="width:40px;height:40px;background:var(--green-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">1Ô∏è‚É£</div>
            <div style="font-size:18px;font-weight:600">Cash Secured Put Phase</div>
          </div>
          <p style="margin:0;font-size:14px">Sell put options on stocks you want to own at prices you're happy to pay. Collect premium while waiting. If assigned, you buy shares at your chosen price minus the premium collected.</p>
        </div>

        <div style="text-align:center;font-size:24px">‚¨áÔ∏è</div>

        <div style="background:var(--input);padding:20px;border-radius:12px;border-left:4px solid var(--blue)">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
            <div style="width:40px;height:40px;background:var(--blue-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">2Ô∏è‚É£</div>
            <div style="font-size:18px;font-weight:600">Covered Call Phase</div>
          </div>
          <p style="margin:0;font-size:14px">Once you own shares (from assignment), sell call options against them. Collect more premium while waiting. If called away, you sell your shares at your target price plus keep the premium.</p>
        </div>
      </div>

      <h3>Why It's Called "The Wheel"</h3>

      <p>The strategy naturally cycles:</p>

      <ol>
        <li><strong>Sell CSP</strong> ‚Üí Collect premium, wait</li>
        <li><strong>Get Assigned</strong> ‚Üí Now own 100 shares</li>
        <li><strong>Sell CC</strong> ‚Üí Collect more premium</li>
        <li><strong>Get Called Away</strong> ‚Üí Back to cash</li>
        <li><strong>Repeat from Step 1</strong></li>
      </ol>

      <div class="callout blue">
        <strong>Key Insight:</strong> You're collecting premium at EVERY stage. Whether you're waiting to buy (CSP) or waiting to sell (CC), time decay is working for you and money is flowing into your account.
      </div>

      <h3>Who Is The Wheel For?</h3>

      <ul>
        <li>Traders seeking <strong>consistent income</strong> over speculation</li>
        <li>Investors who want to <strong>lower cost basis</strong> on stocks they like</li>
        <li>Those with enough capital to buy 100 shares (for CSPs)</li>
        <li>Patient traders who understand options basics</li>
        <li>Anyone tired of trying to time the market perfectly</li>
      </ul>

      <div class="callout orange">
        <strong>Critical Requirement:</strong> You MUST have the cash to buy 100 shares if assigned. This is why it's called "Cash SECURED" puts. Never sell puts without the capital to back them up.
      </div>
    `,

    'wheel-cycle': `
      <h2>The Full Wheel Cycle</h2>

      <p>Let's walk through a complete wheel cycle with a real example to see exactly how this strategy generates income at every step.</p>

      <h3>Example Setup</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;text-align:center">
          <div>
            <div style="font-size:24px;font-weight:700">AAPL</div>
            <div style="color:var(--text2)">Stock</div>
          </div>
          <div>
            <div style="font-size:24px;font-weight:700">$150</div>
            <div style="color:var(--text2)">Current Price</div>
          </div>
          <div>
            <div style="font-size:24px;font-weight:700">$15,000</div>
            <div style="color:var(--text2)">Cash Available</div>
          </div>
          <div>
            <div style="font-size:24px;font-weight:700">Target: 1%</div>
            <div style="color:var(--text2)">Weekly Return</div>
          </div>
        </div>
      </div>

      <h3>Step 1: Sell Cash Secured Put</h3>

      <div style="background:var(--green-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Action: Sell 1 AAPL $145 Put, 7 DTE</div>
        <div style="display:grid;gap:8px;font-size:14px">
          <div>Premium Collected: <strong style="color:var(--green)">$1.50 ($150 total)</strong></div>
          <div>Cash Reserved: <strong>$14,500</strong> (strike √ó 100)</div>
          <div>Max Profit: <strong>$150</strong> if AAPL stays above $145</div>
          <div>Break-even: <strong>$143.50</strong> ($145 - $1.50 premium)</div>
        </div>
      </div>

      <p><strong>Scenario A:</strong> AAPL stays above $145 at expiration ‚Üí Put expires worthless ‚Üí You keep $150 ‚Üí Return to Step 1</p>

      <p><strong>Scenario B:</strong> AAPL drops to $142 ‚Üí You get assigned ‚Üí Move to Step 2</p>

      <h3>Step 2: Assignment (You Now Own Shares)</h3>

      <div style="background:var(--blue-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">You Now Own 100 Shares of AAPL</div>
        <div style="display:grid;gap:8px;font-size:14px">
          <div>Strike Price Paid: <strong>$145.00</strong></div>
          <div>Less Premium Collected: <strong>-$1.50</strong></div>
          <div>Effective Cost Basis: <strong style="color:var(--green)">$143.50/share</strong></div>
          <div>Current Price: <strong>$142.00</strong></div>
          <div>Paper Loss: <strong style="color:var(--red)">-$150</strong> (but better than buying at $150!)</div>
        </div>
      </div>

      <h3>Step 3: Sell Covered Call</h3>

      <div style="background:var(--green-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Action: Sell 1 AAPL $147 Call, 7 DTE</div>
        <div style="display:grid;gap:8px;font-size:14px">
          <div>Premium Collected: <strong style="color:var(--green)">$1.00 ($100 total)</strong></div>
          <div>If Called Away: Sell at $147 + keep $100 premium</div>
          <div>New Break-even: <strong>$142.50</strong> ($143.50 - $1.00)</div>
        </div>
      </div>

      <p><strong>Scenario A:</strong> AAPL stays below $147 ‚Üí Call expires worthless ‚Üí You keep $100 + shares ‚Üí Sell another call</p>

      <p><strong>Scenario B:</strong> AAPL rises to $150 ‚Üí Shares called away at $147 ‚Üí Move to Step 4</p>

      <h3>Step 4: Called Away (Back to Cash)</h3>

      <div style="background:var(--orange-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Cycle Complete - Final Accounting</div>
        <div style="display:grid;gap:8px;font-size:14px">
          <div>Shares Sold At: <strong>$147.00</strong></div>
          <div>Original Cost Basis: <strong>$145.00</strong></div>
          <div>Capital Gain: <strong style="color:var(--green)">+$200</strong></div>
          <div>CSP Premium: <strong style="color:var(--green)">+$150</strong></div>
          <div>CC Premium: <strong style="color:var(--green)">+$100</strong></div>
          <div style="border-top:1px solid var(--border);padding-top:8px;margin-top:8px">
            <strong>Total Profit: <span style="color:var(--green)">$450</span></strong> (3% on $15,000)
          </div>
        </div>
      </div>

      <div class="callout green">
        <strong>The Power of The Wheel:</strong> Even though AAPL dropped initially and you got assigned, you still made $450 profit by collecting premium at every stage. The wheel turns losses into opportunities.
      </div>

      <h3>The Continuous Cycle</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0;text-align:center">
        <div style="display:flex;justify-content:center;align-items:center;gap:20px;flex-wrap:wrap">
          <div style="background:var(--green-bg);padding:12px 20px;border-radius:20px;font-weight:600">Sell CSP</div>
          <div>‚Üí</div>
          <div style="background:var(--blue-bg);padding:12px 20px;border-radius:20px;font-weight:600">Own Shares</div>
          <div>‚Üí</div>
          <div style="background:var(--orange-bg);padding:12px 20px;border-radius:20px;font-weight:600">Sell CC</div>
          <div>‚Üí</div>
          <div style="background:var(--purple-bg);padding:12px 20px;border-radius:20px;font-weight:600">Called Away</div>
          <div>‚Üí</div>
          <div style="font-size:20px">üîÑ</div>
        </div>
      </div>
    `,

    'wheel-benefits': `
      <h2>Why The Wheel Works</h2>

      <p>The Wheel Strategy has become one of the most popular income strategies for good reason. Here's why it consistently works for patient, disciplined traders.</p>

      <h3>1. Multiple Win Conditions</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <p style="margin:0 0 12px 0;font-weight:600">When Selling CSPs, You Win If:</p>
        <ul style="margin:0;font-size:14px">
          <li>Stock goes up ‚Üí Put expires worthless ‚úÖ</li>
          <li>Stock stays flat ‚Üí Put expires worthless ‚úÖ</li>
          <li>Stock goes down a little ‚Üí Put expires worthless ‚úÖ</li>
          <li>Stock goes down a lot ‚Üí You buy stock you wanted at a discount ‚úÖ</li>
        </ul>
      </div>

      <div class="callout green">
        <strong>Key Advantage:</strong> You don't need to predict direction. As long as you're selling puts on stocks you want to own, every outcome is acceptable.
      </div>

      <h3>2. Time Is On Your Side</h3>

      <p>Unlike buying options where time works against you, as a seller:</p>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0">
        <div style="background:var(--red-bg);padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:28px;margin-bottom:8px">üìâ</div>
          <div style="font-weight:600;color:var(--red)">Option Buyers</div>
          <div style="font-size:13px;margin-top:8px">Lose value every day</div>
          <div style="font-size:13px">Fighting the clock</div>
        </div>
        <div style="background:var(--green-bg);padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:28px;margin-bottom:8px">üìà</div>
          <div style="font-weight:600;color:var(--green)">Option Sellers (You)</div>
          <div style="font-size:13px;margin-top:8px">Gain value every day</div>
          <div style="font-size:13px">Time is your friend</div>
        </div>
      </div>

      <h3>3. Lower Cost Basis</h3>

      <p>Every premium you collect reduces your effective cost:</p>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-size:14px;margin-bottom:8px">Example: AAPL at $150</div>
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
          <span>Buying outright:</span>
          <span style="font-weight:600">$150.00 cost basis</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
          <span>After 1 CSP expires ($1.50):</span>
          <span style="font-weight:600;color:var(--green)">$148.50 effective</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
          <span>After 2 CSPs expire:</span>
          <span style="font-weight:600;color:var(--green)">$147.00 effective</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:8px 0">
          <span>After 1 month of CSPs:</span>
          <span style="font-weight:600;color:var(--green)">$144.00 effective</span>
        </div>
      </div>

      <h3>4. Defined Risk</h3>

      <p>Your maximum risk is always known:</p>

      <ul>
        <li><strong>CSP Max Risk:</strong> Strike price √ó 100 (minus premium) - same as buying the stock</li>
        <li><strong>CC Max Risk:</strong> Stock going to $0 - but you'd have this risk anyway owning shares</li>
        <li><strong>No Unlimited Risk:</strong> Unlike naked calls, covered positions have defined max loss</li>
      </ul>

      <h3>5. Works In Any Market</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;background:var(--green-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">üìà</div>
          <div>
            <div style="font-weight:600">Bull Market</div>
            <div style="font-size:13px;color:var(--text2)">CSPs expire worthless repeatedly. Collect premium without buying shares.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--blue-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">‚û°Ô∏è</div>
          <div>
            <div style="font-weight:600">Sideways Market</div>
            <div style="font-size:13px;color:var(--text2)">Perfect for the wheel. Collect premium on both CSPs and CCs.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--orange-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">üìâ</div>
          <div>
            <div style="font-weight:600">Bear Market</div>
            <div style="font-size:13px;color:var(--text2)">Get assigned at lower prices. Premium cushions the drop. CCs help recover.</div>
          </div>
        </div>
      </div>

      <h3>6. Psychological Benefits</h3>

      <ul>
        <li><strong>Less Stressful:</strong> No need to time entries perfectly</li>
        <li><strong>Clear Rules:</strong> Systematic approach removes emotion</li>
        <li><strong>Regular Income:</strong> Weekly/monthly premium feels like a paycheck</li>
        <li><strong>No FOMO:</strong> You're getting paid to wait</li>
      </ul>

      <div class="callout orange">
        <strong>The Catch:</strong> The wheel requires patience and discipline. It's not a get-rich-quick scheme. It's a slow, consistent approach to building wealth. Target 0.5-1% per week, and let compounding do the heavy lifting over time.
      </div>
    `,

    // MODULE 4: CASH SECURED PUTS DEEP DIVE
    'csp-basics': `
      <h2>CSP Fundamentals</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/J5mL1B5WKzQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@InTheMoney" target="_blank">InTheMoney</a></div>

      <p>The Cash Secured Put (CSP) is the entry point of the Wheel Strategy. It's one of the most powerful income-generating strategies available, and mastering it is essential for consistent profits.</p>

      <h3>What Is a Cash Secured Put?</h3>

      <div style="background:var(--green-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">CSP = Selling a put with cash reserved to buy shares if assigned</div>
        <p style="margin:0">You collect premium upfront and agree to buy 100 shares at the strike price if the stock drops below that level.</p>
      </div>

      <h3>The Mechanics</h3>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="display:grid;gap:12px">
          <div style="display:flex;justify-content:space-between;padding-bottom:12px;border-bottom:1px solid var(--border)">
            <span>You Sell:</span>
            <span style="font-weight:600">1 Put Option</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding-bottom:12px;border-bottom:1px solid var(--border)">
            <span>You Receive:</span>
            <span style="font-weight:600;color:var(--green)">Premium (immediately)</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding-bottom:12px;border-bottom:1px solid var(--border)">
            <span>Your Obligation:</span>
            <span style="font-weight:600">Buy 100 shares at strike if assigned</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span>Cash Required:</span>
            <span style="font-weight:600">Strike √ó 100</span>
          </div>
        </div>
      </div>

      <h3>Example Trade</h3>

      <div style="background:var(--blue-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Sell to Open: 1 NVDA $420 Put, 7 DTE @ $5.00</div>
        <ul style="margin:0;font-size:14px">
          <li>Premium Collected: <strong style="color:var(--green)">$500</strong></li>
          <li>Cash Required: <strong>$42,000</strong></li>
          <li>Return on Capital: <strong>1.19%</strong> for 7 days</li>
          <li>Annualized Return: <strong>62%</strong> (if repeated)</li>
        </ul>
      </div>

      <h3>Possible Outcomes</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="background:var(--green-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--green)">Stock Stays Above Strike</div>
          <p style="margin:8px 0 0 0;font-size:14px">Put expires worthless. You keep the $500 premium. No shares purchased. Repeat the process.</p>
        </div>
        <div style="background:var(--orange-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--orange)">Stock Falls Below Strike</div>
          <p style="margin:8px 0 0 0;font-size:14px">You buy 100 shares at $420. Your effective cost: $415/share (strike minus premium). Move to covered calls.</p>
        </div>
      </div>

      <div class="callout blue">
        <strong>Key Insight:</strong> You should ONLY sell CSPs on stocks you genuinely want to own. Think of it as getting paid to place a limit order. If assigned, you're happy to own the shares.
      </div>

      <h3>Margin vs Cash Secured</h3>

      <ul>
        <li><strong>Cash Secured:</strong> Full cash reserved. Safest approach. Required for the wheel.</li>
        <li><strong>Margin Secured:</strong> Only partial cash required. Increases risk significantly. Not recommended for beginners.</li>
      </ul>

      <div class="callout orange">
        <strong>Golden Rule:</strong> Never sell a put without having 100% of the cash to buy shares. Margin can amplify losses and lead to forced liquidations. Always be cash secured.
      </div>
    `,

    'csp-stock-selection': `
      <h2>Selecting The Right Stock</h2>

      <p>Stock selection is arguably the most important factor in wheel success. Choosing the wrong stock can turn a winning strategy into a losing one. Here's how to pick the right underlyings.</p>

      <h3>The Golden Rule</h3>

      <div style="background:var(--green-bg);padding:24px;border-radius:12px;margin:16px 0;text-align:center">
        <div style="font-size:24px;font-weight:700;margin-bottom:8px">Only Sell Puts on Stocks You Want to Own</div>
        <p style="margin:0;color:var(--text2)">If you wouldn't buy the stock outright, don't sell puts on it.</p>
      </div>

      <h3>Ideal Stock Characteristics</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:start;background:var(--input);padding:16px;border-radius:12px">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center">1</div>
          <div>
            <div style="font-weight:600">Strong Fundamentals</div>
            <div style="font-size:13px;color:var(--text2);margin-top:4px">Profitable companies, good balance sheets, competitive advantages. Think: Would this company still exist in 10 years?</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:start;background:var(--input);padding:16px;border-radius:12px">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center">2</div>
          <div>
            <div style="font-weight:600">Uptrend or Stable</div>
            <div style="font-size:13px;color:var(--text2);margin-top:4px">Stock in an uptrend reduces assignment risk. Avoid stocks in clear downtrends or freefall.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:start;background:var(--input);padding:16px;border-radius:12px">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center">3</div>
          <div>
            <div style="font-weight:600">Good Liquidity</div>
            <div style="font-size:13px;color:var(--text2);margin-top:4px">Tight bid-ask spreads, high volume. Allows easy entry/exit. Look for spreads under $0.10.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:start;background:var(--input);padding:16px;border-radius:12px">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center">4</div>
          <div>
            <div style="font-weight:600">Reasonable IV</div>
            <div style="font-size:13px;color:var(--text2);margin-top:4px">Higher IV means better premiums, but not so high that the stock is unpredictable. Sweet spot: 25-60% IV.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:start;background:var(--input);padding:16px;border-radius:12px">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center">5</div>
          <div>
            <div style="font-weight:600">Affordable</div>
            <div style="font-size:13px;color:var(--text2);margin-top:4px">Price you can afford 100 shares of. A $50 stock requires $5,000 cash secured. A $500 stock requires $50,000.</div>
          </div>
        </div>
      </div>

      <h3>Stocks to AVOID</h3>

      <div style="display:grid;gap:8px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--red-bg);border-radius:10px">
          <span style="font-size:18px">‚ùå</span>
          <span><strong>Meme stocks</strong> - GME, AMC, etc. Unpredictable moves destroy accounts.</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--red-bg);border-radius:10px">
          <span style="font-size:18px">‚ùå</span>
          <span><strong>Biotech/FDA plays</strong> - Binary events can gap 50%+ overnight.</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--red-bg);border-radius:10px">
          <span style="font-size:18px">‚ùå</span>
          <span><strong>Stocks in freefall</strong> - "Catching a falling knife" rarely works.</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--red-bg);border-radius:10px">
          <span style="font-size:18px">‚ùå</span>
          <span><strong>Low-volume stocks</strong> - Wide spreads eat your profits.</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--red-bg);border-radius:10px">
          <span style="font-size:18px">‚ùå</span>
          <span><strong>Stocks with earnings this week</strong> - Wait until after.</span>
        </div>
      </div>

      <h3>Great Wheel Candidates</h3>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-size:14px;color:var(--text2);margin-bottom:12px">Examples (do your own research):</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px">
          <span style="background:var(--card);padding:8px 12px;border-radius:8px;font-weight:600">AAPL</span>
          <span style="background:var(--card);padding:8px 12px;border-radius:8px;font-weight:600">MSFT</span>
          <span style="background:var(--card);padding:8px 12px;border-radius:8px;font-weight:600">AMD</span>
          <span style="background:var(--card);padding:8px 12px;border-radius:8px;font-weight:600">NVDA</span>
          <span style="background:var(--card);padding:8px 12px;border-radius:8px;font-weight:600">GOOGL</span>
          <span style="background:var(--card);padding:8px 12px;border-radius:8px;font-weight:600">AMZN</span>
          <span style="background:var(--card);padding:8px 12px;border-radius:8px;font-weight:600">SPY</span>
          <span style="background:var(--card);padding:8px 12px;border-radius:8px;font-weight:600">QQQ</span>
        </div>
      </div>

      <div class="callout orange">
        <strong>Beau's Approach:</strong> Focus on higher IV stocks that are in a clear uptrend. The uptrend gives you a tailwind (less likely to get assigned), while higher IV gives you better premium. Check the daily and weekly charts before entering any position.
      </div>
    `,

    'csp-strike-exp': `
      <h2>Strike & Expiration Selection</h2>

      <p>Choosing the right strike price and expiration date is where art meets science. These decisions directly impact your risk, reward, and probability of success.</p>

      <h3>Strike Selection</h3>

      <p>Your strike choice determines your risk-reward tradeoff:</p>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="background:var(--green-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--green)">Far OTM (0.10-0.20 delta)</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;font-size:13px">
            <div>‚úÖ High probability (80-90%)</div>
            <div>‚ùå Lower premium</div>
            <div>‚úÖ Large cushion from current price</div>
            <div>‚ùå Less weekly income</div>
          </div>
        </div>
        <div style="background:var(--blue-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--blue)">Standard OTM (0.20-0.30 delta)</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;font-size:13px">
            <div>‚úÖ Good probability (70-80%)</div>
            <div>‚úÖ Solid premium</div>
            <div>‚úÖ Balanced approach</div>
            <div>‚ö†Ô∏è Moderate cushion</div>
          </div>
        </div>
        <div style="background:var(--orange-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--orange)">Aggressive OTM (0.30-0.50 delta)</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;font-size:13px">
            <div>‚ö†Ô∏è Moderate probability (50-70%)</div>
            <div>‚úÖ Higher premium</div>
            <div>‚ö†Ô∏è Smaller cushion</div>
            <div>‚úÖ More income if successful</div>
          </div>
        </div>
      </div>

      <div class="callout orange">
        <strong>Beau's Delta Range:</strong> 0.40-0.90. This is aggressive, but when combined with proper stock selection (uptrending stocks with higher IV) and short DTE, the higher premium compensates. The key is having conviction in the stocks you select.
      </div>

      <h3>Expiration Selection</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="background:var(--input);padding:16px;border-radius:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Weekly (0-7 DTE)</strong>
            <span style="background:var(--green-bg);color:var(--green);padding:4px 10px;border-radius:12px;font-size:12px">BEAU'S PICK</span>
          </div>
          <ul style="margin:8px 0 0 0;font-size:14px;padding-left:20px">
            <li>Maximum theta decay per day</li>
            <li>Less time for things to go wrong</li>
            <li>Can let expire to avoid fees</li>
            <li>Requires more active management</li>
          </ul>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px">
          <strong>2-3 Weeks (7-21 DTE)</strong>
          <ul style="margin:8px 0 0 0;font-size:14px;padding-left:20px">
            <li>Good balance of premium and decay</li>
            <li>Still captures accelerating theta</li>
            <li>More cushion than weeklies</li>
          </ul>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px">
          <strong>Monthly (30-45 DTE)</strong>
          <ul style="margin:8px 0 0 0;font-size:14px;padding-left:20px">
            <li>Traditional approach</li>
            <li>More time value to capture</li>
            <li>Often closed at 50% profit</li>
            <li>Less management required</li>
          </ul>
        </div>
      </div>

      <h3>The Premium Rule</h3>

      <p>A simple rule for strike selection based on desired return:</p>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="text-align:center;margin-bottom:16px">
          <div style="font-size:18px;font-weight:600">Target Weekly Return = Premium √∑ Cash Required</div>
        </div>
        <div style="font-size:14px">
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
            <span>Want 0.5% weekly?</span>
            <span>$50 per $10,000 cash</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
            <span>Want 1.0% weekly?</span>
            <span>$100 per $10,000 cash</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0">
            <span>Want 1.5% weekly?</span>
            <span>$150 per $10,000 cash</span>
          </div>
        </div>
      </div>

      <h3>Putting It Together</h3>

      <div style="background:var(--green-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Example: AAPL at $175</div>
        <div style="font-size:14px">
          <p>Target: 1% weekly return on ~$17,000 = $170 premium</p>
          <p style="margin:12px 0">Check the options chain for strikes that offer ~$1.70 premium with 7 DTE</p>
          <p style="margin:0"><strong>Result:</strong> $170 strike put at $1.75 = $175 premium (1.03% return, 0.45 delta)</p>
        </div>
      </div>

      <div class="callout blue">
        <strong>Pro Tip:</strong> Look at the delta AND the premium. Sometimes stepping down one strike gives you much better risk/reward. Always check multiple strikes before placing your trade.
      </div>
    `,

    'csp-management': `
      <h2>Managing Your CSP</h2>

      <p>Opening the position is just the beginning. Proper management determines whether you consistently profit or suffer unnecessary losses. Here's how to manage your CSPs like a pro.</p>

      <h3>After Opening: Monitor These</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">üìä</div>
          <div>
            <div style="font-weight:600">Stock Price vs Strike</div>
            <div style="font-size:13px;color:var(--text2)">Are you still safely OTM? How much cushion remains?</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">üí∞</div>
          <div>
            <div style="font-weight:600">Current Premium Value</div>
            <div style="font-size:13px;color:var(--text2)">Has time decay worked in your favor? At 50%+ profit, consider closing.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">üìÖ</div>
          <div>
            <div style="font-weight:600">Days to Expiration</div>
            <div style="font-size:13px;color:var(--text2)">Risk increases in final days if near the strike.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">üì∞</div>
          <div>
            <div style="font-weight:600">News & Events</div>
            <div style="font-size:13px;color:var(--text2)">Any upcoming earnings, announcements, or catalysts?</div>
          </div>
        </div>
      </div>

      <h3>Exit Strategies</h3>

      <div style="background:var(--green-bg);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;color:var(--green);margin-bottom:8px">Option 1: Let It Expire (Beau's Approach)</div>
        <p style="margin:0;font-size:14px">If stock stays above strike, the option expires worthless and you keep 100% of premium. No closing fees. Requires holding through expiration.</p>
      </div>

      <div style="background:var(--blue-bg);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;color:var(--blue);margin-bottom:8px">Option 2: Close at 50% Profit</div>
        <p style="margin:0;font-size:14px">Buy back the put when it's lost half its value. Locks in profit early, frees capital for new trades. Small fee but reduces risk.</p>
      </div>

      <div style="background:var(--orange-bg);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;color:var(--orange);margin-bottom:8px">Option 3: Roll the Position</div>
        <p style="margin:0;font-size:14px">If threatened, "roll" to a later expiration and/or lower strike. Collect additional premium. Discussed in detail below.</p>
      </div>

      <h3>When to Roll</h3>

      <p>Rolling = closing current position and opening a new one. Do this when:</p>

      <ul>
        <li>Stock is approaching your strike near expiration</li>
        <li>You want to avoid assignment but stay in the trade</li>
        <li>You can roll for a NET CREDIT (collect more premium)</li>
      </ul>

      <div class="callout green">
        <strong>Golden Rule of Rolling:</strong> Only roll for a credit. If you can't collect additional premium by rolling, either take the assignment or close the trade. Never pay to roll.
      </div>

      <h3>Roll Types</h3>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="margin-bottom:16px">
          <strong>Roll Out (Same Strike, Later Date)</strong>
          <p style="font-size:14px;margin:4px 0 0 0">Gives you more time. Good when you're still bullish on the stock.</p>
        </div>
        <div style="margin-bottom:16px">
          <strong>Roll Down (Lower Strike, Same Date)</strong>
          <p style="font-size:14px;margin:4px 0 0 0">Gives you more cushion. Harder to get a credit.</p>
        </div>
        <div>
          <strong>Roll Down and Out (Lower Strike + Later Date)</strong>
          <p style="font-size:14px;margin:4px 0 0 0">Best of both. More cushion AND more time. Easiest to get credit.</p>
        </div>
      </div>

      <h3>Assignment: Not the End of the World</h3>

      <p>If assigned, remember:</p>

      <ul>
        <li>You chose a stock you wanted to own</li>
        <li>Your cost basis is strike - premium (better than market price at the time)</li>
        <li>You now move to Phase 2: Covered Calls</li>
        <li>You'll continue collecting premium on the shares</li>
      </ul>

      <div class="callout orange">
        <strong>Beau's Management:</strong> Sell same-week options. If getting too close to strike, roll to avoid overnight assignment risk. If it looks like it will close below strike on expiration day, roll out. Always roll for a credit. If the stock tanks badly, sometimes it's better to take assignment and sell covered calls to recover.
      </div>
    `,

    // MODULE 5: COVERED CALLS DEEP DIVE
    'cc-basics': `
      <h2>Covered Call Fundamentals</h2>

      <div class="lesson-video">
        <iframe src="https://www.youtube.com/embed/jnTsQBJHMSk" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
      </div>
      <div class="video-credit">Video: <a href="https://youtube.com/@InTheMoney" target="_blank">InTheMoney</a></div>

      <p>The Covered Call is Phase 2 of the Wheel Strategy. Once you own shares (either from a CSP assignment or outright purchase), you can generate income by selling calls against them.</p>

      <h3>What Is a Covered Call?</h3>

      <div style="background:var(--blue-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">Covered Call = Selling a call while owning 100 shares</div>
        <p style="margin:0">You collect premium upfront and agree to sell your shares at the strike price if the stock rises above that level.</p>
      </div>

      <h3>The Mechanics</h3>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="display:grid;gap:12px">
          <div style="display:flex;justify-content:space-between;padding-bottom:12px;border-bottom:1px solid var(--border)">
            <span>You Own:</span>
            <span style="font-weight:600">100 Shares of Stock</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding-bottom:12px;border-bottom:1px solid var(--border)">
            <span>You Sell:</span>
            <span style="font-weight:600">1 Call Option</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding-bottom:12px;border-bottom:1px solid var(--border)">
            <span>You Receive:</span>
            <span style="font-weight:600;color:var(--green)">Premium (immediately)</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span>Your Obligation:</span>
            <span style="font-weight:600">Sell 100 shares at strike if called</span>
          </div>
        </div>
      </div>

      <h3>Why "Covered"?</h3>

      <p>The call is "covered" because you own the underlying shares. If the option is exercised, you simply deliver your shares. This is different from a "naked" call where you don't own shares and would have unlimited risk.</p>

      <h3>Example Trade</h3>

      <div style="background:var(--green-bg);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Position: Own 100 AAPL at $170 cost basis</div>
        <div style="margin-bottom:12px">Current Price: $175</div>
        <div style="font-weight:600;margin-bottom:8px">Sell to Open: 1 AAPL $180 Call, 7 DTE @ $1.50</div>
        <ul style="margin:0;font-size:14px">
          <li>Premium Collected: <strong style="color:var(--green)">$150</strong></li>
          <li>If Called Away: Sell at $180 + keep $150 = $3,150 total gain</li>
          <li>If Expires Worthless: Keep $150 + keep shares</li>
        </ul>
      </div>

      <h3>Possible Outcomes</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="background:var(--green-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--green)">Stock Stays Below Strike</div>
          <p style="margin:8px 0 0 0;font-size:14px">Call expires worthless. You keep the $150 premium AND your shares. Sell another call next week.</p>
        </div>
        <div style="background:var(--blue-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--blue)">Stock Rises Above Strike</div>
          <p style="margin:8px 0 0 0;font-size:14px">Shares "called away" at $180. You keep the $150 premium + $10/share gain. Return to selling CSPs.</p>
        </div>
        <div style="background:var(--orange-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--orange)">Stock Drops Significantly</div>
          <p style="margin:8px 0 0 0;font-size:14px">Call expires worthless. You keep premium but shares lose value. Continue selling calls to lower cost basis.</p>
        </div>
      </div>

      <div class="callout blue">
        <strong>Key Insight:</strong> Covered calls generate income while you wait for your shares to recover or reach your target price. Even if the stock drops, you're collecting premium that reduces your effective cost basis.
      </div>
    `,

    'cc-when-to-sell': `
      <h2>When To Sell Covered Calls</h2>

      <p>Timing your covered calls correctly can significantly impact your returns. Here's when to sell and when to wait.</p>

      <h3>Ideal Conditions for Selling CCs</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;background:var(--green-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">‚úÖ</div>
          <div>
            <div style="font-weight:600">Stock is flat or slightly bullish</div>
            <div style="font-size:13px;color:var(--text2)">Ideal for premium collection without getting called away</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--green-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">‚úÖ</div>
          <div>
            <div style="font-weight:600">IV is elevated</div>
            <div style="font-size:13px;color:var(--text2)">Higher premiums for the same strikes</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--green-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">‚úÖ</div>
          <div>
            <div style="font-weight:600">Stock is at or above your cost basis</div>
            <div style="font-size:13px;color:var(--text2)">Getting called away locks in profit</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--green-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">‚úÖ</div>
          <div>
            <div style="font-weight:600">No major catalyst expected</div>
            <div style="font-size:13px;color:var(--text2)">Avoid earnings, FDA decisions, etc.</div>
          </div>
        </div>
      </div>

      <h3>When to WAIT Before Selling CCs</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;background:var(--orange-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">‚ö†Ô∏è</div>
          <div>
            <div style="font-weight:600">Stock just dropped significantly</div>
            <div style="font-size:13px;color:var(--text2)">Premiums at current strikes may be too low. Wait for a bounce.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--orange-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">‚ö†Ô∏è</div>
          <div>
            <div style="font-weight:600">Strong bullish catalyst coming</div>
            <div style="font-size:13px;color:var(--text2)">You might miss significant upside if called away early</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--orange-bg);padding:14px;border-radius:12px">
          <div style="font-size:24px">‚ö†Ô∏è</div>
          <div>
            <div style="font-weight:600">Stock is deep underwater</div>
            <div style="font-size:13px;color:var(--text2)">Selling a CC at your cost basis may have almost no premium</div>
          </div>
        </div>
      </div>

      <h3>The Underwater Dilemma</h3>

      <p>If you got assigned at $100 and the stock is now at $80, you have choices:</p>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="margin-bottom:16px">
          <strong>Option A: Sell CC at Cost Basis ($100 strike)</strong>
          <ul style="margin:8px 0 0 0;font-size:14px">
            <li>Very low premium (stock needs to rally 25%)</li>
            <li>Preserves breakeven if called</li>
            <li>May take many weeks to get premium</li>
          </ul>
        </div>
        <div style="margin-bottom:16px">
          <strong>Option B: Sell CC Below Cost Basis ($90 strike)</strong>
          <ul style="margin:8px 0 0 0;font-size:14px">
            <li>Better premium</li>
            <li>If called, you lock in a loss</li>
            <li>Premium collected reduces that loss</li>
          </ul>
        </div>
        <div>
          <strong>Option C: Wait for Recovery</strong>
          <ul style="margin:8px 0 0 0;font-size:14px">
            <li>No premium while waiting</li>
            <li>Stock may continue to drop</li>
            <li>Sometimes the right choice</li>
          </ul>
        </div>
      </div>

      <div class="callout green">
        <strong>Best Practice:</strong> When underwater, sell calls at strikes where the premium collected plus the strike equals at least your cost basis. This ensures you don't lock in a loss when considering total premium collected.
      </div>

      <h3>The Best Day to Sell</h3>

      <ul>
        <li><strong>Monday:</strong> Full week of theta decay ahead. Good for weeklies.</li>
        <li><strong>After a Green Day:</strong> Strikes are higher, premiums are better.</li>
        <li><strong>When IV Spikes:</strong> Market fear = higher premiums.</li>
      </ul>
    `,

    'cc-strike-selection': `
      <h2>Strike Price Strategy</h2>

      <p>Your covered call strike selection depends on your goals and outlook. Different strikes serve different purposes.</p>

      <h3>Strike Selection Philosophy</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0;text-align:center">
        <div style="font-size:18px;font-weight:600">Where would you be HAPPY to sell your shares?</div>
        <p style="margin:8px 0 0 0;color:var(--text2)">That's your strike price.</p>
      </div>

      <h3>Strike Price Strategies</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="background:var(--green-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--green)">Above Cost Basis (Aggressive Growth)</div>
          <div style="font-size:14px;margin-top:8px">
            <p style="margin:0 0 8px 0">Strike > Your cost basis. If called away, you profit from both stock gain AND premium.</p>
            <p style="margin:0"><strong>Use when:</strong> Bullish on the stock, okay with letting shares go for a profit.</p>
          </div>
        </div>
        <div style="background:var(--blue-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--blue)">At Cost Basis (Breakeven Focus)</div>
          <div style="font-size:14px;margin-top:8px">
            <p style="margin:0 0 8px 0">Strike = Your cost basis. If called away, you break even on shares but keep premium as profit.</p>
            <p style="margin:0"><strong>Use when:</strong> Want out of the position without taking a loss.</p>
          </div>
        </div>
        <div style="background:var(--orange-bg);padding:16px;border-radius:12px">
          <div style="font-weight:600;color:var(--orange)">Below Cost Basis (Income Focus)</div>
          <div style="font-size:14px;margin-top:8px">
            <p style="margin:0 0 8px 0">Strike < Your cost basis. Higher premium, but if called away you have a capital loss (offset by premium).</p>
            <p style="margin:0"><strong>Use when:</strong> Stock is underwater, need income, or planning to harvest tax loss.</p>
          </div>
        </div>
      </div>

      <h3>Delta-Based Selection</h3>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)">
          <span>Conservative: 0.15-0.20 delta</span>
          <span style="font-size:13px;color:var(--text2)">~80-85% chance of keeping shares</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)">
          <span>Standard: 0.25-0.30 delta</span>
          <span style="font-size:13px;color:var(--text2)">~70-75% chance of keeping shares</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:10px 0">
          <span>Aggressive: 0.35-0.45 delta</span>
          <span style="font-size:13px;color:var(--text2)">~55-65% chance of keeping shares</span>
        </div>
      </div>

      <h3>The Premium vs Upside Tradeoff</h3>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:16px 0">
        <div style="background:var(--input);padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:28px;margin-bottom:8px">üìà</div>
          <div style="font-weight:600">Higher Strike</div>
          <div style="font-size:13px;color:var(--text2);margin-top:8px">Less premium<br>More upside potential<br>Less likely to be called</div>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:28px;margin-bottom:8px">üí∞</div>
          <div style="font-weight:600">Lower Strike</div>
          <div style="font-size:13px;color:var(--text2);margin-top:8px">More premium<br>Less upside potential<br>More likely to be called</div>
        </div>
      </div>

      <div class="callout orange">
        <strong>Beau's Strike Selection:</strong> Same approach as CSPs - 0.40-0.90 delta range, same week expiration. The goal is to collect meaningful premium while still having a reasonable chance of keeping shares. If you're happy to let shares go at the strike price, it's a good strike.
      </div>

      <h3>Example Strike Comparison</h3>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-size:14px;margin-bottom:12px"><strong>AAPL at $175, your cost basis $170</strong></div>
        <table style="width:100%;font-size:13px">
          <tr style="border-bottom:1px solid var(--border)">
            <th style="text-align:left;padding:8px 0">Strike</th>
            <th style="text-align:center;padding:8px 0">Premium</th>
            <th style="text-align:center;padding:8px 0">Delta</th>
            <th style="text-align:right;padding:8px 0">If Called</th>
          </tr>
          <tr style="border-bottom:1px solid var(--border)">
            <td style="padding:8px 0">$180</td>
            <td style="text-align:center">$0.80</td>
            <td style="text-align:center">0.25</td>
            <td style="text-align:right;color:var(--green)">+$1,080 profit</td>
          </tr>
          <tr style="border-bottom:1px solid var(--border)">
            <td style="padding:8px 0">$177.50</td>
            <td style="text-align:center">$1.40</td>
            <td style="text-align:center">0.35</td>
            <td style="text-align:right;color:var(--green)">+$890 profit</td>
          </tr>
          <tr>
            <td style="padding:8px 0">$175</td>
            <td style="text-align:center">$2.20</td>
            <td style="text-align:center">0.50</td>
            <td style="text-align:right;color:var(--green)">+$720 profit</td>
          </tr>
        </table>
      </div>
    `,

    'cc-management': `
      <h2>Managing Your Covered Calls</h2>

      <p>Like CSPs, covered calls require active management to maximize returns and avoid unnecessary losses. Here's how to manage them effectively.</p>

      <h3>Monitoring Your Position</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">üìä</div>
          <div>
            <div style="font-weight:600">Stock Price vs Strike</div>
            <div style="font-size:13px;color:var(--text2)">Is it approaching your strike? Prepare for assignment or roll.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">‚è±Ô∏è</div>
          <div>
            <div style="font-weight:600">Time Remaining</div>
            <div style="font-size:13px;color:var(--text2)">More time = more can go wrong. Less time = theta accelerates.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:24px">üì∞</div>
          <div>
            <div style="font-weight:600">Upcoming Events</div>
            <div style="font-size:13px;color:var(--text2)">Ex-dividend dates, earnings, major announcements.</div>
          </div>
        </div>
      </div>

      <h3>Exit Strategies</h3>

      <div style="background:var(--green-bg);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;color:var(--green);margin-bottom:8px">Option 1: Let It Expire</div>
        <p style="margin:0;font-size:14px">If OTM at expiration, option expires worthless. Keep 100% of premium, keep shares. No fees. Beau's preferred method.</p>
      </div>

      <div style="background:var(--blue-bg);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;color:var(--blue);margin-bottom:8px">Option 2: Let Shares Get Called Away</div>
        <p style="margin:0;font-size:14px">If ITM at expiration, shares sold at strike. You keep premium + any stock gains. Returns you to cash for CSPs.</p>
      </div>

      <div style="background:var(--orange-bg);padding:16px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;color:var(--orange);margin-bottom:8px">Option 3: Roll the Call</div>
        <p style="margin:0;font-size:14px">Buy back current call, sell new one at later date and/or higher strike. Do this to keep shares or collect more premium.</p>
      </div>

      <h3>When to Roll Your Covered Call</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:start;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:20px">1.</div>
          <div>
            <div style="font-weight:600">Stock rallied through your strike</div>
            <div style="font-size:13px;color:var(--text2);margin-top:4px">Roll up and out to a higher strike + later expiration. Keeps shares, captures more upside.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:start;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:20px">2.</div>
          <div>
            <div style="font-weight:600">Want to keep shares for dividend</div>
            <div style="font-size:13px;color:var(--text2);margin-top:4px">Roll to avoid assignment before ex-dividend date.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:start;background:var(--input);padding:14px;border-radius:12px">
          <div style="font-size:20px">3.</div>
          <div>
            <div style="font-weight:600">Expect continued upside</div>
            <div style="font-size:13px;color:var(--text2);margin-top:4px">If bullish outlook changed, roll to higher strike to participate in gains.</div>
          </div>
        </div>
      </div>

      <h3>Rolling Mechanics</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">Example Roll</div>
        <div style="font-size:14px">
          <p><strong>Current position:</strong> Short AAPL $180 Call expiring Friday, stock at $182</p>
          <p><strong>Action:</strong> Buy to close $180 Call at $3.00 (debit)</p>
          <p><strong>Action:</strong> Sell to open $185 Call next week at $2.00 (credit)</p>
          <p><strong>Net:</strong> $1.00 debit, but now have $5 more upside potential and another week of premium opportunity.</p>
        </div>
      </div>

      <div class="callout green">
        <strong>Roll Rule:</strong> Try to roll for a NET CREDIT when possible. If you must pay a small debit to roll up and out, make sure the extra upside potential justifies it.
      </div>

      <h3>Early Assignment</h3>

      <p>American-style options can be exercised any time. Early assignment usually happens:</p>

      <ul>
        <li><strong>Before ex-dividend date</strong> (if dividend > remaining time value)</li>
        <li><strong>Deep ITM near expiration</strong> (almost no time value left)</li>
      </ul>

      <p>Early assignment isn't bad‚Äîyou just sell shares sooner than expected. You keep all the premium and any stock gains up to the strike.</p>

      <div class="callout orange">
        <strong>Beau's CC Management:</strong> Same as CSPs‚Äîweekly expiration, let expire when possible. If stock approaches strike and you want to keep shares, roll up and/or out. Getting called away isn't bad; it means you made money and return to selling CSPs.
      </div>
    `,

    // MODULE 6: BEAU'S ELITE STRATEGY
    'beau-philosophy': `
      <h2>Trading Philosophy</h2>

      <p>After 12+ years of full-time trading, the most important lessons aren't about techniques‚Äîthey're about mindset. This philosophy has been refined through bull markets, bear markets, and everything in between.</p>

      <h3>The Core Philosophy</h3>

      <div style="background:linear-gradient(135deg, var(--orange-bg), var(--card));padding:24px;border-radius:16px;margin:20px 0;text-align:center;border:2px solid var(--orange)">
        <div style="font-size:32px;margin-bottom:12px">üéØ</div>
        <div style="font-size:24px;font-weight:700;margin-bottom:8px">Slow and Consistent Wins</div>
        <p style="margin:0;font-size:16px">Target 0.5% - 1% per week. That's 26-52% per year. Compounded, this builds wealth.</p>
      </div>

      <h3>The Fundamental Truths</h3>

      <div style="display:grid;gap:16px;margin:20px 0">
        <div style="display:flex;gap:16px;align-items:start;background:var(--input);padding:20px;border-radius:12px">
          <div style="min-width:40px;height:40px;background:var(--green-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--green)">1</div>
          <div>
            <div style="font-weight:600;font-size:16px">Understand Before You Act</div>
            <p style="margin:8px 0 0 0;color:var(--text2)">You must understand the FULL wheel strategy before opening your first CSP. Know what happens if assigned. Know how covered calls work. Know when to roll. Half-knowledge leads to panic decisions.</p>
          </div>
        </div>

        <div style="display:flex;gap:16px;align-items:start;background:var(--input);padding:20px;border-radius:12px">
          <div style="min-width:40px;height:40px;background:var(--green-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--green)">2</div>
          <div>
            <div style="font-weight:600;font-size:16px">Cash Secured Means CASH SECURED</div>
            <p style="margin:8px 0 0 0;color:var(--text2)">Never sell a put without 100% of the cash to buy shares. Margin amplifies losses and leads to forced liquidations. If you can't afford assignment, you can't afford the trade.</p>
          </div>
        </div>

        <div style="display:flex;gap:16px;align-items:start;background:var(--input);padding:20px;border-radius:12px">
          <div style="min-width:40px;height:40px;background:var(--green-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--green)">3</div>
          <div>
            <div style="font-weight:600;font-size:16px">Consistency Over Home Runs</div>
            <p style="margin:8px 0 0 0;color:var(--text2)">You don't need 50% returns in a month. You need reliable, repeatable income. Small wins compound into life-changing money over time.</p>
          </div>
        </div>

        <div style="display:flex;gap:16px;align-items:start;background:var(--input);padding:20px;border-radius:12px">
          <div style="min-width:40px;height:40px;background:var(--green-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--green)">4</div>
          <div>
            <div style="font-weight:600;font-size:16px">Risk Management Is Everything</div>
            <p style="margin:8px 0 0 0;color:var(--text2)">The best strategy in the world fails without proper risk management. Position sizing, avoiding earnings, and knowing when NOT to trade matter more than finding the "perfect" setup.</p>
          </div>
        </div>
      </div>

      <h3>The Math of Consistency</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px;text-align:center">$50,000 Account at 0.75%/Week</div>
        <div style="display:grid;gap:8px;font-size:14px">
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
            <span>Weekly Income:</span>
            <span style="font-weight:600;color:var(--green)">$375</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
            <span>Monthly Income:</span>
            <span style="font-weight:600;color:var(--green)">$1,500</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
            <span>Year 1 (39% compounded):</span>
            <span style="font-weight:600;color:var(--green)">$69,500</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
            <span>Year 3:</span>
            <span style="font-weight:600;color:var(--green)">$134,300</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0">
            <span>Year 5:</span>
            <span style="font-weight:600;color:var(--green)">$259,400</span>
          </div>
        </div>
      </div>

      <div class="callout orange">
        <strong>Reality Check:</strong> These numbers assume no losing weeks, which isn't realistic. But even at 60% of this rate accounting for losses, you're still dramatically outperforming most investment strategies. Consistency compounds.
      </div>
    `,

    'beau-entry': `
      <h2>Entry Criteria & Setup</h2>

      <p>This is the exact entry criteria used for every trade. No exceptions, no "gut feelings," no chasing. If a setup doesn't meet ALL criteria, skip it.</p>

      <h3>The Entry Checklist</h3>

      <div style="background:var(--card);border:2px solid var(--green);border-radius:16px;padding:20px;margin:16px 0">
        <div style="font-weight:700;font-size:18px;margin-bottom:16px;color:var(--green)">‚úì Pre-Trade Checklist</div>

        <div style="display:grid;gap:12px">
          <label style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:10px">
            <div style="min-width:24px;height:24px;border:2px solid var(--green);border-radius:6px"></div>
            <span><strong>Stock in uptrend</strong> - Check daily/weekly charts</span>
          </label>

          <label style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:10px">
            <div style="min-width:24px;height:24px;border:2px solid var(--green);border-radius:6px"></div>
            <span><strong>Higher IV</strong> - Above average for this stock</span>
          </label>

          <label style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:10px">
            <div style="min-width:24px;height:24px;border:2px solid var(--green);border-radius:6px"></div>
            <span><strong>No earnings this week</strong> - Check calendar</span>
          </label>

          <label style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:10px">
            <div style="min-width:24px;height:24px;border:2px solid var(--green);border-radius:6px"></div>
            <span><strong>Cash available</strong> - 100% secured for CSP</span>
          </label>

          <label style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:10px">
            <div style="min-width:24px;height:24px;border:2px solid var(--green);border-radius:6px"></div>
            <span><strong>Max 3 positions</strong> - Manageable, not overexposed</span>
          </label>
        </div>
      </div>

      <h3>Delta & DTE Selection</h3>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:16px 0">
        <div style="background:var(--green-bg);padding:20px;border-radius:12px;text-align:center">
          <div style="font-size:14px;color:var(--text2);margin-bottom:4px">Delta Range</div>
          <div style="font-size:32px;font-weight:700;color:var(--green)">0.40 - 0.90</div>
          <div style="font-size:13px;margin-top:8px">Higher delta = more premium<br>Requires conviction in stock</div>
        </div>
        <div style="background:var(--blue-bg);padding:20px;border-radius:12px;text-align:center">
          <div style="font-size:14px;color:var(--text2);margin-bottom:4px">Days to Expiration</div>
          <div style="font-size:32px;font-weight:700;color:var(--blue)">Same Week</div>
          <div style="font-size:13px;margin-top:8px">Maximum theta decay<br>Less time for problems</div>
        </div>
      </div>

      <div class="callout orange">
        <strong>Why Higher Delta?</strong> Traditional advice says 0.20-0.30 delta. We go higher because: (1) We carefully select uptrending stocks, (2) Short DTE means less time for breakdown, (3) Higher premium compensates for risk, (4) We're prepared to take assignment on stocks we like.
      </div>

      <h3>Stock Selection Criteria</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px">Ideal Stock Profile</div>

        <div style="display:grid;gap:12px">
          <div style="display:flex;gap:12px;align-items:center">
            <span style="color:var(--green);font-size:18px">‚úì</span>
            <span><strong>Clear uptrend</strong> on daily and weekly timeframes</span>
          </div>
          <div style="display:flex;gap:12px;align-items:center">
            <span style="color:var(--green);font-size:18px">‚úì</span>
            <span><strong>Higher IV than usual</strong> for this specific stock</span>
          </div>
          <div style="display:flex;gap:12px;align-items:center">
            <span style="color:var(--green);font-size:18px">‚úì</span>
            <span><strong>Liquid options</strong> - tight bid/ask spreads</span>
          </div>
          <div style="display:flex;gap:12px;align-items:center">
            <span style="color:var(--green);font-size:18px">‚úì</span>
            <span><strong>No binary events</strong> - no earnings, FDA, etc.</span>
          </div>
          <div style="display:flex;gap:12px;align-items:center">
            <span style="color:var(--green);font-size:18px">‚úì</span>
            <span><strong>Stock you'd own</strong> - if assigned, you're happy</span>
          </div>
        </div>
      </div>

      <h3>Position Sizing</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="text-align:center;margin-bottom:16px">
          <div style="font-size:48px;font-weight:700;color:var(--orange)">3</div>
          <div style="font-size:14px;color:var(--text2)">Maximum Concurrent Positions</div>
        </div>

        <p style="font-size:14px;margin:0">Never have more than 3 positions open at once. This keeps the portfolio manageable, limits correlation risk, and ensures you have cash available for opportunities or rolling.</p>
      </div>

      <h3>Strike Selection</h3>

      <p>For both CSPs and CCs, use the same approach:</p>

      <ul>
        <li><strong>OTM</strong> - Always out of the money</li>
        <li><strong>0.40-0.90 delta</strong> - Yes, this is aggressive</li>
        <li><strong>Premium target:</strong> 0.5-1% of capital at risk</li>
        <li><strong>Price you'd be happy with</strong> - to buy (CSP) or sell (CC)</li>
      </ul>
    `,

    'beau-management': `
      <h2>Position Management</h2>

      <p>Opening a position is just the start. How you manage it determines your success. Here are the exact management rules.</p>

      <h3>The Default: Let It Expire</h3>

      <div style="background:var(--green-bg);padding:24px;border-radius:12px;margin:16px 0;text-align:center">
        <div style="font-size:48px;margin-bottom:12px">üéØ</div>
        <div style="font-size:20px;font-weight:700">Goal: Let Options Expire Worthless</div>
        <p style="margin:8px 0 0 0;color:var(--text2)">No closing fees. 100% of premium kept. Time does the work.</p>
      </div>

      <h3>When to Roll</h3>

      <p>Roll your position when:</p>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:start;background:var(--orange-bg);padding:16px;border-radius:12px">
          <div style="font-size:24px">‚ö†Ô∏è</div>
          <div>
            <div style="font-weight:600">Getting Too Close to Strike (CSP)</div>
            <p style="margin:4px 0 0 0;font-size:14px">If stock approaches your put strike near expiration, roll out to avoid assignment. Don't wait until expiration day.</p>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:start;background:var(--orange-bg);padding:16px;border-radius:12px">
          <div style="font-size:24px">‚ö†Ô∏è</div>
          <div>
            <div style="font-weight:600">Risk of Overnight Assignment</div>
            <p style="margin:4px 0 0 0;font-size:14px">If it looks like stock will close BELOW your put strike, you risk assignment overnight. Roll before close if you don't want shares.</p>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:start;background:var(--blue-bg);padding:16px;border-radius:12px">
          <div style="font-size:24px">üìà</div>
          <div>
            <div style="font-weight:600">Stock Rallied Through CC Strike</div>
            <p style="margin:4px 0 0 0;font-size:14px">If you want to keep shares and capture more upside, roll up and/or out to a higher strike.</p>
          </div>
        </div>
      </div>

      <h3>Rolling Rules</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px;color:var(--green)">The Cardinal Rule of Rolling</div>
        <div style="font-size:20px;text-align:center;padding:16px;background:var(--green-bg);border-radius:8px;margin-bottom:16px">
          <strong>Only Roll For a Credit</strong>
        </div>
        <p style="font-size:14px;margin:0">If you can't collect additional premium by rolling, either take assignment (for CSPs) or let shares be called away (for CCs). Never pay to extend a losing trade.</p>
      </div>

      <h3>Daily Monitoring Routine</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:10px">
          <div style="min-width:32px;text-align:center;font-size:14px;color:var(--text2)">AM</div>
          <span>Check pre-market. Any news on your positions? Gap up/down?</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:10px">
          <div style="min-width:32px;text-align:center;font-size:14px;color:var(--text2)">MID</div>
          <span>Quick check. How far from strikes? Any concerns?</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;background:var(--input);padding:14px;border-radius:10px">
          <div style="min-width:32px;text-align:center;font-size:14px;color:var(--text2)">PM</div>
          <span>Final check. If expiration day, decide: let expire or roll?</span>
        </div>
      </div>

      <h3>Expiration Day Protocol</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">For CSPs on Expiration Day:</div>
        <ul style="margin:0;font-size:14px">
          <li>If stock is comfortably above strike ‚Üí Let expire worthless ‚úÖ</li>
          <li>If stock is near strike (within 1-2%) ‚Üí Consider rolling</li>
          <li>If stock is below strike ‚Üí Roll out OR prepare for assignment</li>
        </ul>
      </div>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:12px">For CCs on Expiration Day:</div>
        <ul style="margin:0;font-size:14px">
          <li>If stock is below strike ‚Üí Let expire, keep shares ‚úÖ</li>
          <li>If stock is above strike ‚Üí Let get called away (profit!) OR roll up/out</li>
        </ul>
      </div>

      <div class="callout green">
        <strong>Pro Tip:</strong> Most brokers auto-exercise ITM options at expiration. If you're close to the strike on expiration Friday, make your decision BEFORE 3pm to avoid surprises from after-hours moves.
      </div>
    `,

    'beau-risk': `
      <h2>Risk Management Rules</h2>

      <p>These rules are non-negotiable. They exist because they've been learned through experience (often painful). Follow them without exception.</p>

      <h3>The Non-Negotiable Rules</h3>

      <div style="display:grid;gap:16px;margin:20px 0">
        <div style="background:var(--card);border-left:4px solid var(--red);padding:20px;border-radius:0 12px 12px 0">
          <div style="font-weight:700;font-size:16px;color:var(--red)">Rule #1: Always Be Cash Secured</div>
          <p style="margin:8px 0 0 0">Never sell a put without 100% cash to cover assignment. No margin. No "I'll figure it out." Have the money or don't trade.</p>
        </div>

        <div style="background:var(--card);border-left:4px solid var(--red);padding:20px;border-radius:0 12px 12px 0">
          <div style="font-weight:700;font-size:16px;color:var(--red)">Rule #2: Avoid Earnings</div>
          <p style="margin:8px 0 0 0">Never hold options through earnings announcements. The binary risk isn't worth it. Check the earnings calendar before every trade.</p>
        </div>

        <div style="background:var(--card);border-left:4px solid var(--red);padding:20px;border-radius:0 12px 12px 0">
          <div style="font-weight:700;font-size:16px;color:var(--red)">Rule #3: Maximum 3 Positions</div>
          <p style="margin:8px 0 0 0">More positions = more to manage = more things to go wrong. Three positions keeps you focused and limits correlation risk.</p>
        </div>

        <div style="background:var(--card);border-left:4px solid var(--red);padding:20px;border-radius:0 12px 12px 0">
          <div style="font-weight:700;font-size:16px;color:var(--red)">Rule #4: Only Trade Stocks You'd Own</div>
          <p style="margin:8px 0 0 0">If you wouldn't buy the stock outright, don't sell puts on it. Assignment should feel like an opportunity, not a punishment.</p>
        </div>

        <div style="background:var(--card);border-left:4px solid var(--red);padding:20px;border-radius:0 12px 12px 0">
          <div style="font-weight:700;font-size:16px;color:var(--red)">Rule #5: Only Roll For a Credit</div>
          <p style="margin:8px 0 0 0">Never pay to extend a losing position. If you can't roll for a credit, take the assignment or loss and move on.</p>
        </div>
      </div>

      <h3>Capital Allocation</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px">Set Aside Dedicated Capital</div>
        <p style="font-size:14px;margin:0 0 16px 0">Use a specific portion of your account for CSPs. This is your "wheel capital." Don't touch it for other trades.</p>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div style="background:var(--green-bg);padding:16px;border-radius:10px;text-align:center">
            <div style="font-weight:600;color:var(--green)">Conservative</div>
            <div style="font-size:24px;font-weight:700;margin:8px 0">50-70%</div>
            <div style="font-size:12px;color:var(--text2)">of account for wheel</div>
          </div>
          <div style="background:var(--orange-bg);padding:16px;border-radius:10px;text-align:center">
            <div style="font-weight:600;color:var(--orange)">Aggressive</div>
            <div style="font-size:24px;font-weight:700;margin:8px 0">80-90%</div>
            <div style="font-size:12px;color:var(--text2)">of account for wheel</div>
          </div>
        </div>
      </div>

      <h3>When NOT to Trade</h3>

      <div style="display:grid;gap:8px;margin:16px 0">
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-size:18px">üö´</span>
          <span>Major economic events (Fed meetings, jobs reports, CPI)</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-size:18px">üö´</span>
          <span>Extreme market volatility (VIX > 30)</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-size:18px">üö´</span>
          <span>When emotional (just had a loss, stressed, FOMO)</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-size:18px">üö´</span>
          <span>When you can't monitor positions properly</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-size:18px">üö´</span>
          <span>If you don't have enough cash secured</span>
        </div>
      </div>

      <div class="callout orange">
        <strong>Remember:</strong> Missing a trade is not losing money. Taking a bad trade IS losing money. There will always be another opportunity. Patience is profitable.
      </div>
    `,

    'beau-mistakes': `
      <h2>Common Mistakes To Avoid</h2>

      <p>These mistakes have cost traders thousands (or more). Learn from them without paying the price yourself.</p>

      <h3>The Deadly Mistakes</h3>

      <div style="display:grid;gap:16px;margin:20px 0">
        <div style="background:var(--red-bg);padding:20px;border-radius:12px">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span style="font-size:24px">üíÄ</span>
            <span style="font-weight:700;font-size:16px">Trading Without Full Understanding</span>
          </div>
          <p style="margin:0;font-size:14px">"I'll figure out covered calls when I get assigned." Wrong. If you don't understand the full cycle BEFORE starting, panic will drive your decisions. Complete this entire course first.</p>
        </div>

        <div style="background:var(--red-bg);padding:20px;border-radius:12px">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span style="font-size:24px">üíÄ</span>
            <span style="font-weight:700;font-size:16px">Using Margin for "Cash Secured" Puts</span>
          </div>
          <p style="margin:0;font-size:14px">If you're using margin, they're not cash secured. A market crash can wipe you out and trigger margin calls. Always use actual cash. Always.</p>
        </div>

        <div style="background:var(--red-bg);padding:20px;border-radius:12px">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span style="font-size:24px">üíÄ</span>
            <span style="font-weight:700;font-size:16px">Selling Puts on Stocks You Don't Want</span>
          </div>
          <p style="margin:0;font-size:14px">"The premium on this meme stock is crazy!" Until you're assigned, the stock drops another 40%, and you're stuck holding garbage. Only sell puts on stocks you'd buy anyway.</p>
        </div>

        <div style="background:var(--red-bg);padding:20px;border-radius:12px">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span style="font-size:24px">üíÄ</span>
            <span style="font-weight:700;font-size:16px">Holding Through Earnings</span>
          </div>
          <p style="margin:0;font-size:14px">That 70% probability of profit becomes a coin flip when earnings drop. One bad report can move a stock 20%+ overnight. Close or roll before earnings. Every time.</p>
        </div>
      </div>

      <h3>The Sneaky Mistakes</h3>

      <div style="display:grid;gap:16px;margin:20px 0">
        <div style="background:var(--orange-bg);padding:20px;border-radius:12px">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span style="font-size:24px">‚ö†Ô∏è</span>
            <span style="font-weight:700;font-size:16px">Chasing Premium</span>
          </div>
          <p style="margin:0;font-size:14px">"If 1% is good, 3% must be better!" High premium usually means high risk. There's a reason that premium is elevated. Stick to your target return range.</p>
        </div>

        <div style="background:var(--orange-bg);padding:20px;border-radius:12px">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span style="font-size:24px">‚ö†Ô∏è</span>
            <span style="font-weight:700;font-size:16px">Overtrading</span>
          </div>
          <p style="margin:0;font-size:14px">Opening 10 positions because "more premium = more money." More positions = more to manage = more mistakes. Stick to the maximum of 3.</p>
        </div>

        <div style="background:var(--orange-bg);padding:20px;border-radius:12px">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span style="font-size:24px">‚ö†Ô∏è</span>
            <span style="font-weight:700;font-size:16px">Panic Closing</span>
          </div>
          <p style="margin:0;font-size:14px">Stock drops 5% and you close for a loss. But if you'd held, it recovered and expired worthless. Have a plan BEFORE entering. Stick to it.</p>
        </div>

        <div style="background:var(--orange-bg);padding:20px;border-radius:12px">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span style="font-size:24px">‚ö†Ô∏è</span>
            <span style="font-weight:700;font-size:16px">Ignoring the Trend</span>
          </div>
          <p style="margin:0;font-size:14px">"This stock is cheap, it must bounce." Cheap can get cheaper. Don't fight the trend. Sell puts on uptrending stocks, not falling knives.</p>
        </div>
      </div>

      <h3>The Recovery Framework</h3>

      <p>When things go wrong (and they will sometimes), here's how to recover:</p>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <ol style="margin:0;padding-left:20px">
          <li style="margin-bottom:12px"><strong>Don't panic.</strong> One bad trade doesn't ruin you if you followed the rules.</li>
          <li style="margin-bottom:12px"><strong>Evaluate honestly.</strong> Did you break a rule? What went wrong?</li>
          <li style="margin-bottom:12px"><strong>If assigned:</strong> It's not a loss until you sell. Sell covered calls to recover.</li>
          <li style="margin-bottom:12px"><strong>If truly stuck:</strong> Consider selling for a loss, harvest the tax benefit, move on.</li>
          <li><strong>Learn and adjust.</strong> Every loss is tuition. Make sure you learn the lesson.</li>
        </ol>
      </div>

      <div class="callout green">
        <strong>Final Thought:</strong> The best traders aren't the ones who never lose. They're the ones who lose small and win consistently. Follow the rules, manage your risk, and let time and compounding work their magic.
      </div>
    `,

    // MODULE 7: USING MARKET ELITES APP
    'app-overview': `
      <h2>App Overview</h2>

      <p>Welcome to Market Elites! This app is designed to be your companion for executing the wheel strategy. Here's a quick tour of everything available to you.</p>

      <h3>Home Screen</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="display:grid;gap:16px">
          <div style="display:flex;gap:12px;align-items:start">
            <div style="min-width:40px;height:40px;background:var(--green-bg);border-radius:10px;display:flex;align-items:center;justify-content:center">üí∞</div>
            <div>
              <div style="font-weight:600">Account Balance</div>
              <p style="margin:4px 0 0 0;font-size:14px;color:var(--text2)">Shows your total account value and current premium collected</p>
            </div>
          </div>
          <div style="display:flex;gap:12px;align-items:start">
            <div style="min-width:40px;height:40px;background:var(--blue-bg);border-radius:10px;display:flex;align-items:center;justify-content:center">üìä</div>
            <div>
              <div style="font-weight:600">Active Positions</div>
              <p style="margin:4px 0 0 0;font-size:14px;color:var(--text2)">Your current CSPs and CCs with P&L, premium, and DTE</p>
            </div>
          </div>
          <div style="display:flex;gap:12px;align-items:start">
            <div style="min-width:40px;height:40px;background:var(--purple-bg);border-radius:10px;display:flex;align-items:center;justify-content:center">üìú</div>
            <div>
              <div style="font-weight:600">Trade History</div>
              <p style="margin:4px 0 0 0;font-size:14px;color:var(--text2)">Closed trades with profits/losses for tracking performance</p>
            </div>
          </div>
        </div>
      </div>

      <h3>Main Navigation</h3>

      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:16px 0">
        <div style="background:var(--input);padding:16px 8px;border-radius:12px;text-align:center">
          <div style="font-size:24px;margin-bottom:4px">üè†</div>
          <div style="font-size:12px;font-weight:600">Home</div>
        </div>
        <div style="background:var(--input);padding:16px 8px;border-radius:12px;text-align:center">
          <div style="font-size:24px;margin-bottom:4px">üßÆ</div>
          <div style="font-size:12px;font-weight:600">Calculator</div>
        </div>
        <div style="background:var(--input);padding:16px 8px;border-radius:12px;text-align:center">
          <div style="font-size:24px;margin-bottom:4px">üì°</div>
          <div style="font-size:12px;font-weight:600">Signals</div>
        </div>
        <div style="background:var(--input);padding:16px 8px;border-radius:12px;text-align:center">
          <div style="font-size:24px;margin-bottom:4px">‚öôÔ∏è</div>
          <div style="font-size:12px;font-weight:600">Settings</div>
        </div>
      </div>

      <h3>Quick Actions</h3>

      <div style="background:var(--input);padding:16px;border-radius:12px;margin:16px 0">
        <ul style="margin:0;padding-left:20px;font-size:14px">
          <li style="margin-bottom:8px"><strong>+ Add Position:</strong> Manually add a new CSP or CC to track</li>
          <li style="margin-bottom:8px"><strong>Sync:</strong> Connect to Alpaca to auto-import positions</li>
          <li style="margin-bottom:8px"><strong>Learn:</strong> Access this education center anytime</li>
          <li><strong>Wheely AI:</strong> Chat with our AI assistant for quick answers</li>
        </ul>
      </div>

      <h3>Premium Features</h3>

      <div style="background:linear-gradient(135deg, var(--orange-bg), var(--card));padding:20px;border-radius:12px;margin:16px 0;border:1px solid var(--orange)">
        <div style="font-weight:600;color:var(--orange);margin-bottom:12px">üî• Elite Premium</div>
        <ul style="margin:0;padding-left:20px;font-size:14px">
          <li style="margin-bottom:8px"><strong>Live Trade Signals:</strong> Real-time alerts when trades are placed</li>
          <li style="margin-bottom:8px"><strong>Roll Notifications:</strong> Know when positions are being rolled</li>
          <li><strong>Market Announcements:</strong> Important updates and market commentary</li>
        </ul>
      </div>

      <div class="callout blue">
        <strong>Tip:</strong> The status indicator in the top right shows your connection status. "Live" means you're connected to real-time market data.
      </div>
    `,

    'app-signals': `
      <h2>Following Signals</h2>

      <p>Premium members get access to real-time trading signals. Here's how to use them effectively.</p>

      <h3>What Are Signals?</h3>

      <div style="background:var(--green-bg);padding:20px;border-radius:12px;margin:16px 0">
        <p style="margin:0"><strong>Signals</strong> are real-time notifications when trades are placed. They include the ticker, strike, expiration, premium, and delta‚Äîeverything you need to evaluate and potentially follow the trade.</p>
      </div>

      <h3>Signal Types</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="background:var(--input);padding:16px;border-radius:12px;border-left:4px solid var(--green)">
          <div style="font-weight:600;color:var(--green);margin-bottom:8px">CSP Signal</div>
          <p style="margin:0;font-size:14px">A new cash secured put has been opened. Shows ticker, strike, premium, delta, and DTE.</p>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px;border-left:4px solid var(--blue)">
          <div style="font-weight:600;color:var(--blue);margin-bottom:8px">CC Signal</div>
          <p style="margin:0;font-size:14px">A new covered call has been opened. Shows ticker, strike, premium, delta, and DTE.</p>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px;border-left:4px solid var(--purple)">
          <div style="font-weight:600;color:var(--purple);margin-bottom:8px">Roll Alert</div>
          <p style="margin:0;font-size:14px">A position is being rolled. Shows the original position and new position with credit collected.</p>
        </div>
        <div style="background:var(--input);padding:16px;border-radius:12px;border-left:4px solid var(--orange)">
          <div style="font-weight:600;color:var(--orange);margin-bottom:8px">Announcement</div>
          <p style="margin:0;font-size:14px">Important market commentary, strategy updates, or general information.</p>
        </div>
      </div>

      <h3>How to Use Signals</h3>

      <div style="display:grid;gap:16px;margin:20px 0">
        <div style="display:flex;gap:16px;align-items:start">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700">1</div>
          <div>
            <div style="font-weight:600">Review the Signal</div>
            <p style="margin:4px 0 0 0;font-size:14px;color:var(--text2)">Check the ticker, strike, premium, and delta. Does it fit your criteria?</p>
          </div>
        </div>
        <div style="display:flex;gap:16px;align-items:start">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700">2</div>
          <div>
            <div style="font-weight:600">Do Your Own Analysis</div>
            <p style="margin:4px 0 0 0;font-size:14px;color:var(--text2)">Check the chart. Verify no earnings this week. Confirm you have the capital.</p>
          </div>
        </div>
        <div style="display:flex;gap:16px;align-items:start">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700">3</div>
          <div>
            <div style="font-weight:600">Decide to Follow or Pass</div>
            <p style="margin:4px 0 0 0;font-size:14px;color:var(--text2)">Not every signal is right for everyone. Your position size and risk tolerance matter.</p>
          </div>
        </div>
        <div style="display:flex;gap:16px;align-items:start">
          <div style="min-width:32px;height:32px;background:var(--green-bg);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700">4</div>
          <div>
            <div style="font-weight:600">Execute in Your Broker</div>
            <p style="margin:4px 0 0 0;font-size:14px;color:var(--text2)">Place the trade in your brokerage account. Prices may vary slightly.</p>
          </div>
        </div>
      </div>

      <div class="callout orange">
        <strong>Important:</strong> Signals are educational and informational. They are NOT financial advice. Always do your own due diligence and only trade what you can afford to lose. Past performance doesn't guarantee future results.
      </div>

      <h3>Signal Timing</h3>

      <p>Signals are typically posted:</p>
      <ul>
        <li>Near market open (9:30-10:30 AM ET) for new positions</li>
        <li>Near market close (3:00-4:00 PM ET) for rolls on expiration days</li>
        <li>Throughout the day for urgent rolls or announcements</li>
      </ul>

      <div class="callout blue">
        <strong>Tip:</strong> Enable notifications to get alerted when new signals are posted. Speed matters for getting similar fills.
      </div>
    `,

    'app-calculator': `
      <h2>Using The Calculator</h2>

      <p>The Options Calculator is your primary tool for finding and evaluating trades. It pulls real-time data and helps you find the best opportunities.</p>

      <h3>Finding Options</h3>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px">Step 1: Enter a Ticker</div>
        <p style="font-size:14px;margin:0">Type any stock symbol (AAPL, NVDA, SPY, etc.) in the search bar and hit enter or tap search. The app will fetch real-time price and options data.</p>
      </div>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px">Step 2: Select CSP or CC Mode</div>
        <p style="font-size:14px;margin:0">Toggle between Cash Secured Put and Covered Call modes. This filters the options chain to show the relevant options.</p>
      </div>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px">Step 3: Choose Expiration</div>
        <p style="font-size:14px;margin:0">Select an expiration date from the available options. Remember: same-week expirations align with Beau's strategy.</p>
      </div>

      <div style="background:var(--input);padding:20px;border-radius:12px;margin:16px 0">
        <div style="font-weight:600;margin-bottom:16px">Step 4: Review the Options Chain</div>
        <p style="font-size:14px;margin:0">See all available strikes with their premiums, deltas, and other data. Tap a strike to see more details.</p>
      </div>

      <h3>Understanding the Display</h3>

      <div style="display:grid;gap:12px;margin:16px 0">
        <div style="display:flex;justify-content:space-between;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-weight:600">Strike</span>
          <span style="color:var(--text2)">The price you'll buy (CSP) or sell (CC) at</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-weight:600">Premium</span>
          <span style="color:var(--text2)">Price per share you collect (√ó 100 for total)</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-weight:600">Delta</span>
          <span style="color:var(--text2)">Probability indicator (and price sensitivity)</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-weight:600">ROC</span>
          <span style="color:var(--text2)">Return on Capital (premium √∑ capital required)</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:12px;background:var(--input);border-radius:10px">
          <span style="font-weight:600">Bid/Ask</span>
          <span style="color:var(--text2)">Current market prices for the option</span>
        </div>
      </div>

      <h3>Filtering Options</h3>

      <p>Use the quick filter buttons to find options matching your criteria:</p>

      <ul>
        <li><strong>By Delta:</strong> Filter to show only options in your target delta range</li>
        <li><strong>By ROC:</strong> Filter to show options meeting minimum return targets</li>
        <li><strong>By DTE:</strong> Filter by days to expiration</li>
      </ul>

      <h3>Adding to Portfolio</h3>

      <p>Once you find an option you like:</p>

      <ol>
        <li>Tap the strike to select it</li>
        <li>Adjust contracts if needed</li>
        <li>Tap "Add to Portfolio" to track it in the app</li>
        <li>Execute the actual trade in your broker</li>
      </ol>

      <div class="callout green">
        <strong>Pro Tip:</strong> Use the quick search buttons (AAPL, NVDA, AMD, etc.) to quickly jump to popular tickers. The calculator remembers your last search too.
      </div>

      <h3>Quick Searches</h3>

      <p>Popular tickers are available as quick buttons for fast access:</p>

      <div style="display:flex;flex-wrap:wrap;gap:8px;margin:16px 0">
        <span style="background:var(--input);padding:8px 16px;border-radius:20px;font-weight:600">AAPL</span>
        <span style="background:var(--input);padding:8px 16px;border-radius:20px;font-weight:600">NVDA</span>
        <span style="background:var(--input);padding:8px 16px;border-radius:20px;font-weight:600">AMD</span>
        <span style="background:var(--input);padding:8px 16px;border-radius:20px;font-weight:600">TSLA</span>
        <span style="background:var(--input);padding:8px 16px;border-radius:20px;font-weight:600">SPY</span>
        <span style="background:var(--input);padding:8px 16px;border-radius:20px;font-weight:600">QQQ</span>
      </div>

      <div class="callout blue">
        <strong>Remember:</strong> The calculator shows real-time data, but prices can change quickly. Always verify the current price in your broker before executing.
      </div>
    `
  };

  return content[chapterId] || '<p>Lesson content coming soon...</p>';
}

function openAnalytics(){
  const positions = S.positions || [];
  const history = S.history || [];
  const allTrades = [...positions, ...history];

  // Calculate stats
  const openPrem = positions.reduce((s,p)=>s+(p.premium||0)*(p.contracts||1)*100,0);
  const closedPrem = history.reduce((s,t)=>s+(t.premium||0)*(t.contracts||1)*100,0);
  const totalPrem = openPrem + closedPrem;
  const totalPnl = history.reduce((s,t)=>s+(t.pnl||0),0);
  const wins = history.filter(t=>(t.pnl||0)>=0).length;
  const losses = history.filter(t=>(t.pnl||0)<0).length;
  const total = history.length;
  const winRate = total > 0 ? Math.round(wins/total*100) : 0;
  const avgWin = wins > 0 ? history.filter(t=>(t.pnl||0)>=0).reduce((s,t)=>s+(t.pnl||0),0)/wins : 0;
  const avgLoss = losses > 0 ? Math.abs(history.filter(t=>(t.pnl||0)<0).reduce((s,t)=>s+(t.pnl||0),0)/losses) : 0;

  // Group by ticker
  const byTicker = {};
  allTrades.forEach(t => {
    if (!byTicker[t.symbol]) byTicker[t.symbol] = { prem: 0, trades: 0, pnl: 0 };
    byTicker[t.symbol].prem += (t.premium||0)*(t.contracts||1)*100;
    byTicker[t.symbol].trades++;
    byTicker[t.symbol].pnl += (t.pnl||0);
  });

  // Group by type
  const cspTrades = allTrades.filter(t=>t.type==='csp');
  const ccTrades = allTrades.filter(t=>t.type==='cc');
  const cspPrem = cspTrades.reduce((s,t)=>s+(t.premium||0)*(t.contracts||1)*100,0);
  const ccPrem = ccTrades.reduce((s,t)=>s+(t.premium||0)*(t.contracts||1)*100,0);

  let html = `
    <div style="background:linear-gradient(135deg,var(--green),#059669);border-radius:16px;padding:24px;text-align:center;margin-bottom:16px;color:#fff">
      <div style="font-size:13px;opacity:0.9">Total Premium Collected</div>
      <div style="font-size:36px;font-weight:800;margin:4px 0">$${totalPrem.toFixed(0)}</div>
      <div style="font-size:13px;opacity:0.8">${positions.length} open ¬∑ ${history.length} closed</div>
    </div>

    <div class="stats-grid" style="margin-bottom:16px">
      <div class="stat-box"><div class="stat-val" style="color:var(--green)">${winRate}%</div><div class="stat-label">Win Rate</div></div>
      <div class="stat-box"><div class="stat-val">${total}</div><div class="stat-label">Closed Trades</div></div>
      <div class="stat-box"><div class="stat-val" style="color:${totalPnl>=0?'var(--green)':'var(--red)'}">${totalPnl>=0?'+':''}$${totalPnl.toFixed(0)}</div><div class="stat-label">Realized P&L</div></div>
      <div class="stat-box"><div class="stat-val">${positions.length}</div><div class="stat-label">Open Positions</div></div>
    </div>

    ${total > 0 ? `<div style="background:var(--input);border-radius:12px;padding:16px;margin-bottom:16px">
      <div style="font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px">Performance</div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text2)">Avg Win</span><span style="font-weight:600;color:var(--green)">+$${avgWin.toFixed(0)}</span></div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text2)">Avg Loss</span><span style="font-weight:600;color:var(--red)">-$${avgLoss.toFixed(0)}</span></div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text2)">Wins / Losses</span><span style="font-weight:600">${wins}W / ${losses}L</span></div>
      <div style="display:flex;justify-content:space-between;padding:8px 0"><span style="color:var(--text2)">Profit Factor</span><span style="font-weight:600">${avgLoss>0?(avgWin*wins/(avgLoss*losses)).toFixed(2):'‚Äî'}</span></div>
    </div>` : ''}

    <div style="background:var(--input);border-radius:12px;padding:16px;margin-bottom:16px">
      <div style="font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px">By Strategy</div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text2)">CSP Premium</span><span style="font-weight:600;color:var(--green)">$${cspPrem.toFixed(0)} (${cspTrades.length} trades)</span></div>
      <div style="display:flex;justify-content:space-between;padding:8px 0"><span style="color:var(--text2)">CC Premium</span><span style="font-weight:600;color:var(--blue)">$${ccPrem.toFixed(0)} (${ccTrades.length} trades)</span></div>
    </div>`;

  // Top tickers
  const sortedTickers = Object.entries(byTicker).sort((a,b) => b[1].prem - a[1].prem).slice(0,5);
  if (sortedTickers.length > 0) {
    html += `<div style="background:var(--input);border-radius:12px;padding:16px">
      <div style="font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px">By Ticker</div>`;
    sortedTickers.forEach(([sym, data], i) => {
      const border = i < sortedTickers.length - 1 ? 'border-bottom:1px solid var(--border);' : '';
      html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;${border}"><div><span style="font-weight:600">${sym}</span> <span style="font-size:12px;color:var(--text3)">${data.trades} trades</span></div><span style="font-weight:600;color:var(--green)">$${data.prem.toFixed(0)}</span></div>`;
    });
    html += '</div>';
  }

  $('analyticsContent').innerHTML = html;
  openModal('analyticsModal');
}
function openAI(){
  if(!$('aiMessages').innerHTML){
    $('aiMessages').innerHTML='<div class="ai-msg bot">Hey! I\'m <b>Wheely</b> ‚Äî your wheel strategy assistant. Ask me anything about options, CSPs, covered calls, the Greeks, position sizing, or managing trades!</div>';
  }
  openModal('aiModal');
}

const WHEELY_SYSTEM = `You are Wheely, an expert options trading assistant for Market Elites, a wheel strategy platform. You specialize in:
- The wheel strategy (selling cash secured puts and covered calls)
- Options Greeks (delta, theta, gamma, vega, IV)
- Strike selection, DTE selection, position sizing
- Rolling positions, managing assignments
- Risk management for options sellers

Keep responses concise (2-4 sentences max unless asked for detail). Use plain language. If the user asks something unrelated to trading/options, politely redirect them. Never give specific trade recommendations or financial advice ‚Äî always note this is educational.`;

let aiConversation = [];

async function sendAI(){
  const i=$('aiInput'),m=i.value.trim();
  if(!m)return;
  $('aiMessages').innerHTML+=`<div class="ai-msg user">${escapeHtml(m)}</div>`;
  i.value='';
  $('aiMessages').scrollTop=$('aiMessages').scrollHeight;

  // Show typing indicator
  $('aiMessages').innerHTML+='<div class="ai-msg bot" id="aiTyping" style="opacity:0.6">Thinking...</div>';
  $('aiMessages').scrollTop=$('aiMessages').scrollHeight;

  const groqKey = localStorage.getItem('groqApiKey');
  if(!groqKey){
    document.getElementById('aiTyping')?.remove();
    $('aiMessages').innerHTML+='<div class="ai-msg bot">To chat with me, add your free Groq API key in <b>Profile > Settings</b>. Get one free at <a href="https://console.groq.com" target="_blank" style="color:var(--blue)">console.groq.com</a></div>';
    $('aiMessages').scrollTop=$('aiMessages').scrollHeight;
    return;
  }

  aiConversation.push({role:'user',content:m});
  // Keep last 10 messages for context
  if(aiConversation.length>10) aiConversation=aiConversation.slice(-10);

  try{
    const r=await fetch('https://api.groq.com/openai/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+groqKey},
      body:JSON.stringify({
        model:'llama-3.3-70b-versatile',
        messages:[{role:'system',content:WHEELY_SYSTEM},...aiConversation],
        max_tokens:500,
        temperature:0.7
      })
    });
    const data=await r.json();
    document.getElementById('aiTyping')?.remove();

    if(data.error){
      $('aiMessages').innerHTML+='<div class="ai-msg bot">Sorry, I hit an error. '+escapeHtml(data.error.message||'Try again.')+'</div>';
    } else {
      const reply=data.choices?.[0]?.message?.content||'Sorry, I couldn\'t generate a response.';
      aiConversation.push({role:'assistant',content:reply});
      $('aiMessages').innerHTML+=`<div class="ai-msg bot">${formatAiResponse(reply)}</div>`;
    }
  }catch(e){
    document.getElementById('aiTyping')?.remove();
    $('aiMessages').innerHTML+='<div class="ai-msg bot">Connection error. Check your API key and try again.</div>';
  }
  $('aiMessages').scrollTop=$('aiMessages').scrollHeight;
}

function escapeHtml(str){return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function formatAiResponse(text){
  return text
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.*?)\*/g,'<em>$1</em>')
    .replace(/\n/g,'<br>');
}
function openPremium(){openModal('premiumModal')}
function toggleNotif(){S.notifOn=!S.notifOn;['notifSwitch','qNotifSwitch'].forEach(id=>$(id)?.classList.toggle('on',S.notifOn));save()}
function updateStatus(){
  const hasBroker=S.apiKey.length>10&&S.secretKey.length>10;
  // Always show live for market data (no API key needed)
  $('statusPill').className='status live';
  $('statusText').textContent=hasBroker?'Live + Broker':'Live Data';
}
function renderHome(){
  // Ensure critical DOM elements exist
  const balanceEl = $('balanceVal');
  const posContainer = $('positionsContainer');
  const histContainer = $('historyContainer');

  if (!balanceEl || !posContainer || !histContainer) {
    // DOM not ready, schedule retry
    setTimeout(renderHome, 100);
    return;
  }

  // Render balance
  balanceEl.textContent = S.accSize.toLocaleString();
  const prem = (S.positions || []).reduce((s,p) => s + (p.premium||0) * (p.contracts||1) * 100, 0);
  const pct = S.accSize > 0 ? (prem / S.accSize * 100).toFixed(1) : 0;
  const changeEl = $('balanceChange');
  if (changeEl) changeEl.textContent = '‚Üë +$' + prem.toFixed(0) + ' (' + pct + '%)';

  // Render user initials
  const init = S.user && S.user.name ? S.user.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0,2) : '?';
  const initEl = $('heroInitials');
  if (initEl) initEl.textContent = init;

  // Show guest banner if guest
  const guestBanner = $('guestBanner');
  if (guestBanner) {
    guestBanner.style.display = S.isGuest ? 'block' : 'none';
  }

  renderAlertsFeed();

  // Show new user banner if no trades and learn progress is empty
  const newBanner = $('newUserBanner');
  if (newBanner) {
    const progress = getLearnProgress();
    const hasProgress = Object.keys(progress).length > 0;
    const hasTrades = (S.positions || []).length > 0 || (S.history || []).length > 0;
    const dismissed = S.newUserDismissed;
    newBanner.style.display = (!hasProgress && !hasTrades && !dismissed) ? 'block' : 'none';
  }

  // Force render positions and history with explicit content
  renderPositions(posContainer);
  renderHistory(histContainer);
}

function renderAlertsFeed() {
  const section = $('alertsFeedSection');
  const container = $('alertsFeedContainer');
  if (!section || !container) return;

  // Only show for premium users
  if (!S.isPremium) {
    section.style.display = 'none';
    return;
  }

  const posts = S.adminPosts || [];
  if (!posts.length) {
    section.style.display = 'none';
    return;
  }

  section.style.display = 'block';
  const recent = posts.slice(0, 3);

  container.innerHTML = recent.map(p => {
    if (p.kind === 'signal') {
      return `<div class="pos-card" style="border-left:3px solid var(--${p.type==='csp'?'green':'blue'});padding:14px" onclick="nav('signals')">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><span class="pos-badge ${p.type}" style="margin-right:8px">${p.type.toUpperCase()}</span><b>${p.ticker}</b> $${p.strike}</div>
          <span style="font-size:11px;color:var(--text3)">${getTimeAgo(p.timestamp)}</span>
        </div>
        <div style="font-size:13px;color:var(--text2);margin-top:6px">Premium: <span style="color:var(--green)">${p.prem}</span> ¬∑ Delta: ${p.delta}</div>
      </div>`;
    } else if (p.kind === 'announcement') {
      return `<div class="pos-card" style="border-left:3px solid var(--orange);background:var(--orange-bg);padding:14px" onclick="nav('signals')">
        <div style="font-weight:600">${p.title}</div>
        <div style="font-size:13px;color:var(--text2);margin-top:4px">${p.message.slice(0, 80)}${p.message.length > 80 ? '...' : ''}</div>
        <span style="font-size:11px;color:var(--text3)">${getTimeAgo(p.timestamp)}</span>
      </div>`;
    } else if (p.kind === 'roll') {
      return `<div class="pos-card" style="border-left:3px solid var(--purple);padding:14px" onclick="nav('signals')">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span class="pos-badge" style="background:var(--purple-bg);color:var(--purple)">ROLL</span>
          <span style="font-size:11px;color:var(--text3)">${getTimeAgo(p.timestamp)}</span>
        </div>
        <div style="font-size:13px;margin-top:6px">${p.original} ‚Üí ${p.newPos}</div>
        <div style="font-size:14px;font-weight:600;color:var(--green);margin-top:4px">${p.credit}</div>
      </div>`;
    }
    return '';
  }).join('');
}
function renderPositions(container){
  const c = container || $('positionsContainer');
  if(!c) return; // Guard against null

  const positions = S.positions || [];
  if(!positions.length){
    c.innerHTML='<div class="empty"><div class="empty-icon"><svg viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div><div class="empty-title">No Positions</div><div class="empty-text">Add positions or sync from Alpaca</div><button class="empty-btn" onclick="openAdd()">+ Add Position</button></div>';
    return;
  }
  c.innerHTML=positions.map(p=>{const dte=p.expiration?Math.ceil((new Date(p.expiration)-new Date())/864e5):null;const premCollected=(p.premium||0)*(p.contracts||1)*100;const clr=getTickerColor(p.symbol);const isShares=p.type==='shares';return`<div class="pos-card" onclick="viewPos('${p.id}')"><div class="pos-top"><div class="pos-left"><div class="pos-logo"><img src="${logo(p.symbol)}" onerror="this.outerHTML='<span class=pos-logo-text style=background:${clr}>${p.symbol.slice(0,2)}</span>'"></div><div><div class="pos-symbol">${p.symbol}${p.strike?' $'+p.strike+(p.type==='csp'?'P':'C'):''}</div><div class="pos-name">${names[p.symbol]||p.symbol}</div></div></div><span class="pos-badge ${p.type}">${(p.type||'').toUpperCase()}</span></div><div class="pos-stats"><div><div class="pos-stat-val pos">+$${premCollected.toFixed(0)}</div><div class="pos-stat-label">Premium</div></div><div><div class="pos-stat-val">${p.contracts||1}</div><div class="pos-stat-label">${isShares?'Shares':'Contracts'}</div></div><div style="text-align:right"><div class="pos-stat-val">${dte!==null?dte:'‚Äî'}</div><div class="pos-stat-label">${dte!==null?'DTE':'Hold'}</div></div></div></div>`}).join('');
}
function renderHistory(container){
  const c = container || $('historyContainer');
  if(!c) return; // Guard against null

  const history = S.history || [];
  if(!history.length){
    c.innerHTML='<div style="text-align:center;padding:32px;color:var(--text2);font-size:14px;background:var(--card);border:1px solid var(--border);border-radius:16px">Closed trades appear here</div>';
    return;
  }
  c.innerHTML='<div class="tx-list">'+history.slice(0,5).map(t=>`<div class="tx-item"><div class="tx-icon ${t.type}"><svg viewBox="0 0 24 24">${t.type==='csp'?'<circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12l4 4 4-4"/>':'<circle cx="12" cy="12" r="10"/><path d="M12 16V8M8 12l4-4 4 4"/>'}</svg></div><div class="tx-info"><div class="tx-title">${t.symbol} $${t.strike||''}${t.type==='csp'?'P':'C'}</div><div class="tx-sub">${new Date(t.closeDate||Date.now()).toLocaleDateString()}</div></div><div class="tx-amount ${(t.pnl||0)>=0?'pos':'neg'}">${(t.pnl||0)>=0?'+':'-'}$${Math.abs(t.pnl||0).toFixed(0)}</div></div>`).join('')+'</div>';
}
function viewPos(id){const p=S.positions.find(x=>x.id===id);if(!p)return;S.selPosId=id;$('posTitle').textContent=p.symbol;$('posContent').innerHTML=`<div class="stats-grid"><div class="stat-box"><div class="stat-val">${p.type.toUpperCase()}</div><div class="stat-label">Type</div></div><div class="stat-box"><div class="stat-val">${p.contracts||1}</div><div class="stat-label">Contracts</div></div>${p.strike?`<div class="stat-box"><div class="stat-val">$${p.strike}</div><div class="stat-label">Strike</div></div>`:''}<div class="stat-box"><div class="stat-val green">$${((p.premium||0)*(p.contracts||1)*100).toFixed(0)}</div><div class="stat-label">Premium</div></div></div>`;openModal('posModal')}
function closePosition(){
  if(!S.selPosId)return;
  const p=S.positions.find(x=>x.id===S.selPosId);
  if(!p)return;

  if(p.type==='shares'){
    // Shares: just remove
    S.positions=S.positions.filter(x=>x.id!==S.selPosId);
    save();closeModal('posModal');renderHome();
    return;
  }

  // Options: ask if expired worthless (full profit) or closed early
  showConfirm('Close Position', 'Did this option expire worthless (full profit)?', () => {
    // Expired worthless = keep all premium
    const pnl=(p.premium||0)*(p.contracts||1)*100;
    S.history.unshift({...p,closeDate:new Date().toISOString(),pnl:pnl,outcome:'expired'});
    S.positions=S.positions.filter(x=>x.id!==S.selPosId);
    save();closeModal('posModal');renderHome();
    showToast('Position closed for +$'+pnl.toFixed(0),'success');
  });

  // Override cancel button to offer "Closed Early" option
  const cancelBtn=$('confirmModal').querySelector('.btn-outline');
  if(cancelBtn){
    cancelBtn.textContent='Closed Early';
    cancelBtn.onclick=()=>{
      closeModal('confirmModal');
      showPrompt('Close Price','What did you close for? (per share, e.g. 0.50)',(val)=>{
        const closePrice=parseFloat(val)||0;
        const openPrem=(p.premium||0);
        const pnl=(openPrem-closePrice)*(p.contracts||1)*100;
        S.history.unshift({...p,closeDate:new Date().toISOString(),pnl:pnl,closePrice:closePrice,outcome:'closed'});
        S.positions=S.positions.filter(x=>x.id!==S.selPosId);
        save();closeModal('posModal');renderHome();
        showToast(`Position closed for ${pnl>=0?'+':''}$${pnl.toFixed(0)}`,(pnl>=0?'success':'error'));
      });
    };
  }
}
async function syncPositions(){if(!S.apiKey)return showToast('Add API keys in settings first','error');try{$('statusPill').className='status live';$('statusText').textContent='Syncing...';const r=await fetch('https://paper-api.alpaca.markets/v2/positions',{headers:{'APCA-API-KEY-ID':S.apiKey,'APCA-API-SECRET-KEY':S.secretKey}});if(!r.ok)throw new Error('Failed');const pos=await r.json();pos.forEach(p=>{if(!S.positions.find(x=>x.symbol===p.symbol)){S.positions.push({id:Date.now().toString()+Math.random(),symbol:p.symbol,type:'shares',contracts:parseInt(p.qty),costBasis:parseFloat(p.avg_entry_price),synced:true,openDate:new Date().toISOString()})}});const ar=await fetch('https://paper-api.alpaca.markets/v2/account',{headers:{'APCA-API-KEY-ID':S.apiKey,'APCA-API-SECRET-KEY':S.secretKey}});if(ar.ok){const a=await ar.json();S.accSize=parseFloat(a.equity)||S.accSize}save();$('statusPill').className='status live';$('statusText').textContent='Live';renderHome()}catch(e){$('statusPill').className='status';$('statusText').textContent='Error';showToast('Sync failed','error')}}
function setAddMode(m){S.addMode=m;$('addCspBtn').classList.toggle('active',m==='csp');$('addCcBtn').classList.toggle('active',m==='cc');$('addSharesBtn').classList.toggle('active',m==='shares');if(m==='shares'){hide('optFields');show('shareFields')}else{show('optFields');hide('shareFields')}}
function savePosition(){const sym=$('addSymbol').value.trim().toUpperCase();if(!sym)return showToast('Enter symbol','error');const p={id:Date.now().toString(),symbol:sym,type:S.addMode,contracts:parseInt($('addContracts').value)||1,openDate:new Date().toISOString()};if(S.addMode==='shares')p.costBasis=parseFloat($('addCost').value)||0;else{p.strike=parseFloat($('addStrike').value)||0;p.expiration=$('addExp').value;p.premium=parseFloat($('addPremium').value)||0;if(!p.strike||!p.expiration)return showToast('Fill strike & expiration','error')}S.positions.push(p);save();closeModal('addModal');renderHome()}
function setMode(m){S.mode=m;$('cspBtn').classList.toggle('active',m==='csp');$('ccBtn').classList.toggle('active',m==='cc');
  // Reload options if we have a current ticker
  if(currentTicker && currentChain) loadOptionsChain(currentTicker);
}

function addFromCalc() {
  if (!currentTicker || !selectedOption) return showToast('Select an option first','error');

  const expDate = selectedExp ? new Date(selectedExp * 1000) : new Date(Date.now() + selectedOption.dte * 86400000);

  const p = {
    id: Date.now().toString(),
    symbol: currentTicker,
    type: S.mode,
    strike: selectedOption.strike,
    premium: selectedOption.premium,
    contracts: selectedOption.contracts,
    expiration: expDate.toISOString().split('T')[0],
    openDate: new Date().toISOString()
  };

  S.positions.push(p);
  save();
  nav('home');
  showToast(`Added ${currentTicker} $${selectedOption.strike}${S.mode==='csp'?'P':'C'} to portfolio!`,'success');
}

function qSearch(s){$('tickerInput').value=s;searchTicker()}
// Current ticker state for options chain
let currentTicker = null;
let currentChain = null;
let selectedExp = null;
let selectedOption = null;

async function searchTicker(){
  const t=$('tickerInput').value.trim().toUpperCase();
  if(!t)return;

  hide('emptyCalc');
  hide('stockCard');
  hide('optCard');
  hide('resultCard');
  show('loadingCard');

  try {
    // Fetch live quote (no API key needed!)
    const quote = await fetchLiveQuote(t);
    if (!quote) throw new Error('Symbol not found');

    currentTicker = t;
    $('stockSymbol').textContent = t;
    $('stockName').textContent = names[t] || t;
    $('stockPrice').textContent = quote.price.toFixed(2);

    // Add price change display
    const priceEl = $('stockPrice').parentElement;
    let changeEl = priceEl.querySelector('.price-change');
    if (!changeEl) {
      changeEl = document.createElement('div');
      changeEl.className = 'price-change';
      changeEl.style.cssText = 'font-size:14px;margin-top:4px;font-weight:600';
      priceEl.appendChild(changeEl);
    }
    changeEl.style.color = quote.change >= 0 ? 'var(--green)' : 'var(--red)';
    changeEl.textContent = `${quote.change >= 0 ? '+' : ''}${quote.change.toFixed(2)} (${quote.changePercent}%)`;

    hide('loadingCard');
    show('stockCard');

    // Fetch options chain
    await loadOptionsChain(t);

    $('statusPill').className='status live';
    $('statusText').textContent='Live Data';

  } catch(e) {
    hide('loadingCard');
    show('emptyCalc');
    showToast('Could not find: ' + t,'error');
  }
}

async function loadOptionsChain(symbol) {
  show('loadingCard');
  hide('resultCard');

  // Reset optCard to original structure
  $('optCard').innerHTML = `<div class="card-title">Select Contract</div>
    <div class="form-group"><label class="form-label">Expiration</label>
    <select class="form-select" id="expSelect" onchange="onExpChange()"><option>Loading...</option></select></div>
    <div class="form-group"><label class="form-label">Strike ¬∑ Premium ¬∑ Delta ¬∑ OTM%</label>
    <select class="form-select" id="strikeSelect" onchange="onStrikeChange()"><option>Select expiration first...</option></select></div>`;

  try {
    const chain = await fetchOptionsChain(symbol);
    if (!chain || !chain.expirations?.length) {
      hide('loadingCard');
      // Show manual entry if no options available
      showManualEntry();
      return;
    }

    currentChain = chain;

    // Populate expiration dropdown
    const expSelect = $('expSelect');
    expSelect.innerHTML = '<option value="">Select expiration...</option>' +
      chain.expirations.slice(0, 12).map(exp => {
        const dte = calcDTE(exp);
        const label = formatExpDate(exp);
        const dteLabel = dte === 1 ? '1 day' : `${dte} days`;
        return `<option value="${exp}">${label} (${dteLabel})</option>`;
      }).join('');

    hide('loadingCard');
    show('optCard');

    // Reset strike select
    $('strikeSelect').innerHTML = '<option value="">Select strike...</option>';

  } catch(e) {
    hide('loadingCard');
    showManualEntry();
  }
}

function showManualEntry() {
  // Show manual premium entry for tickers without options data
  $('optCard').innerHTML = `
    <div class="card-title">Enter Contract Details</div>
    <div class="form-group">
      <label class="form-label">Strike Price</label>
      <input type="number" class="form-input" id="manualStrike" placeholder="150.00" step="0.5">
    </div>
    <div class="form-group">
      <label class="form-label">Premium (per share)</label>
      <input type="number" class="form-input" id="manualPremium" placeholder="2.50" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Days to Expiration</label>
      <input type="number" class="form-input" id="manualDTE" placeholder="30" value="30">
    </div>
    <button class="btn btn-outline" onclick="calcManualOption()">Calculate</button>
  `;
  show('optCard');
}

function calcManualOption() {
  const strike = parseFloat($('manualStrike')?.value) || 0;
  const premium = parseFloat($('manualPremium')?.value) || 0;
  const dte = parseInt($('manualDTE')?.value) || 30;

  if (!strike || !premium) return showToast('Enter strike and premium','error');

  const contracts = Math.floor(S.accSize / (strike * 100)) || 1;
  const totalPrem = premium * contracts * 100;
  const annualized = ((premium / strike) * (365 / dte) * 100).toFixed(1);

  selectedOption = { strike, premium, dte, contracts };

  $('resPrem').textContent = totalPrem.toFixed(0);
  $('resAnn').textContent = annualized;
  $('resProb').textContent = '~75';
  $('resCon').textContent = contracts;
  show('resultCard');
}

async function onExpChange() {
  const expSelect = $('expSelect');
  const exp = parseInt(expSelect.value);
  if (!exp || !currentChain) return;

  selectedExp = exp;

  // Fetch options for this expiration
  show('loadingCard');
  const chain = await fetchOptionsChain(currentTicker, exp);
  hide('loadingCard');

  if (!chain) return;
  currentChain = chain;

  // Get relevant options based on mode
  const options = S.mode === 'csp' ? chain.puts : chain.calls;
  const price = chain.price || parseFloat($('stockPrice').textContent);

  // Find ATM and nearby strikes
  const strikes = options
    .filter(o => {
      const otm = S.mode === 'csp' ? o.strike < price : o.strike > price;
      return otm && o.bid > 0;
    })
    .sort((a, b) => S.mode === 'csp' ? b.strike - a.strike : a.strike - b.strike)
    .slice(0, 10);

  const strikeSelect = $('strikeSelect');
  strikeSelect.innerHTML = '<option value="">Select strike...</option>' +
    strikes.map(o => {
      const delta = o.delta ? Math.abs(o.delta).toFixed(2) : '‚Äî';
      const prem = ((o.bid + o.ask) / 2).toFixed(2);
      const otmPct = ((Math.abs(price - o.strike) / price) * 100).toFixed(1);
      const iv = o.impliedVolatility ? (o.impliedVolatility * 100).toFixed(0) + '%' : '';
      return `<option value="${o.strike}" data-premium="${prem}" data-delta="${delta}" data-dte="${calcDTE(selectedExp)}" data-iv="${o.impliedVolatility||0}">$${o.strike} ¬∑ $${prem} ¬∑ Œî${delta} ¬∑ ${otmPct}% OTM${iv?' ¬∑ IV '+iv:''}</option>`;
    }).join('');
}

function onStrikeChange() {
  const strikeSelect = $('strikeSelect');
  const opt = strikeSelect.options[strikeSelect.selectedIndex];
  if (!opt || !opt.value) return;

  const strike = parseFloat(opt.value);
  const premium = parseFloat(opt.dataset.premium) || 0;
  const delta = parseFloat(opt.dataset.delta) || 0.25;
  const dte = parseInt(opt.dataset.dte) || 30;
  const iv = parseFloat(opt.dataset.iv) || 0;

  // Calculate results
  const contracts = Math.floor(S.accSize / (strike * 100)) || 1;
  const totalPrem = premium * contracts * 100;
  const annualized = ((premium / strike) * (365 / dte) * 100).toFixed(1);
  const probProfit = delta ? Math.round((1 - Math.abs(delta)) * 100) : 75;

  selectedOption = { strike, premium, dte, contracts, delta };

  $('resPrem').textContent = totalPrem.toFixed(0);
  $('resAnn').textContent = annualized;
  $('resProb').textContent = probProfit;
  $('resCon').textContent = contracts;

  // Show IV if available
  let ivEl = document.getElementById('resIvRow');
  if (iv > 0) {
    if (!ivEl) {
      const grid = $('resultCard').querySelector('.stats-grid');
      const ivBox = document.createElement('div');
      ivBox.className = 'stat-box';
      ivBox.id = 'resIvRow';
      ivBox.innerHTML = `<div class="stat-val" style="color:var(--orange)"><span id="resIV">0</span>%</div><div class="stat-label">Implied Vol</div>`;
      grid.appendChild(ivBox);
    }
    const ivSpan = document.getElementById('resIV');
    if (ivSpan) ivSpan.textContent = (iv * 100).toFixed(0);
  }

  show('resultCard');
}
async function renderWatch(){
  const c=$('watchContainer');
  const watchlist = S.watchlist || ['AAPL','NVDA','TSLA','SPY','AMD','MSFT'];

  // Show loading state
  c.innerHTML='<div class="tx-list">'+watchlist.map(sym=>{const clr=getTickerColor(sym);return`<div class="tx-item" id="watch-${sym}"><div class="pos-logo"><img src="${logo(sym)}" onerror="this.outerHTML='<span class=pos-logo-text style=background:${clr}>${sym.slice(0,2)}</span>'"></div><div class="tx-info"><div class="tx-title">${sym}</div><div class="tx-sub">${names[sym]||sym}</div></div><div style="text-align:right"><div style="font-size:15px;font-weight:700;color:var(--text3)">Loading...</div><div style="font-size:12px;color:var(--text3)">‚Äî</div></div></div>`}).join('')+'</div><button class="btn btn-outline mt-4" onclick="openAddWatch()">+ Add to Watchlist</button>';

  // Fetch live prices in parallel
  const quotes = await Promise.all(watchlist.map(sym => fetchLiveQuote(sym)));

  // Update each item with live data
  quotes.forEach((q, i) => {
    const sym = watchlist[i];
    const el = $(`watch-${sym}`);
    if (!el) return;
    const chg = q ? (parseFloat(q.changePercent) || 0) : 0;
    const chgColor = chg >= 0 ? 'var(--green)' : 'var(--red)';
    const chgSign = chg >= 0 ? '+' : '';
    const clr = getTickerColor(sym);
    if (q) {
      el.innerHTML = `<div class="pos-logo" style="cursor:pointer" onclick="qSearch('${sym}');nav('calc')"><img src="${logo(sym)}" onerror="this.outerHTML='<span class=pos-logo-text style=background:${clr}>${sym.slice(0,2)}</span>'"></div><div class="tx-info" style="cursor:pointer" onclick="qSearch('${sym}');nav('calc')"><div class="tx-title">${sym} <span class="live-dot" style="width:6px;height:6px"></span></div><div class="tx-sub">${names[sym]||sym}</div></div><div style="text-align:right;cursor:pointer" onclick="qSearch('${sym}');nav('calc')"><div style="font-size:15px;font-weight:700">$${q.price.toFixed(2)}</div><div style="font-size:12px;color:${chgColor}">${chgSign}${chg.toFixed(2)}%</div></div><button style="background:none;border:none;padding:8px;cursor:pointer;color:var(--text3)" onclick="event.stopPropagation();removeFromWatch('${sym}')">√ó</button>`;
    } else {
      el.innerHTML = `<div class="pos-logo"><img src="${logo(sym)}" onerror="this.outerHTML='<span class=pos-logo-text style=background:${clr}>${sym.slice(0,2)}</span>'"></div><div class="tx-info"><div class="tx-title">${sym}</div><div class="tx-sub">${names[sym]||sym}</div></div><div style="text-align:right"><div style="font-size:13px;color:var(--text3)">Unavailable</div></div><button style="background:none;border:none;padding:8px;cursor:pointer;color:var(--text3)" onclick="removeFromWatch('${sym}')">√ó</button>`;
    }
  });

  // Update status to show live data is working
  $('statusPill').className='status live';
  $('statusText').textContent='Live Data';
}

function removeFromWatch(sym) {
  S.watchlist = (S.watchlist || []).filter(s => s !== sym);
  save();
  renderWatch();
}

function openAddWatch() {
  showPrompt('Add to Watchlist', 'AAPL', (sym) => {
    const ticker = sym.toUpperCase().trim();
    if (!S.watchlist) S.watchlist = ['AAPL','NVDA','TSLA','SPY'];
    if (!S.watchlist.includes(ticker)) {
      S.watchlist.push(ticker);
      save();
      renderWatch();
      showToast(`${ticker} added to watchlist`, 'success');
    } else {
      showToast(`${ticker} already in watchlist`, '');
    }
  });
}

async function refreshWatch(){
  // Clear cache for fresh data
  Object.keys(priceCache).forEach(k => delete priceCache[k]);
  renderWatch();
}
function renderAlerts(){const c=$('alertsContainer');const alerts=[];S.positions.forEach(p=>{if(!p.expiration)return;const dte=Math.ceil((new Date(p.expiration)-new Date())/864e5);if(dte<=7)alerts.push({...p,dte,urgent:dte<=3})});if(!alerts.length){c.innerHTML='<div class="empty"><div class="empty-icon"><svg viewBox="0 0 24 24"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/></svg></div><div class="empty-title">No Alerts</div><div class="empty-text">Alerts appear when positions expire soon</div></div>';return}c.innerHTML=alerts.map(a=>`<div class="pos-card" style="border-left:3px solid ${a.urgent?'var(--red)':'var(--orange)'}"><div style="font-weight:600">${a.symbol} $${a.strike}${a.type==='csp'?'P':'C'}</div><div style="font-size:13px;color:var(--text2);margin-top:4px">${a.dte} days remaining</div></div>`).join('')}
function renderSignals(){
  const c=$('signalsContainer');
  const posts = S.adminPosts || [];
  const disclaimer = $('exampleDisclaimer');

  // NON-PREMIUM: Show only examples
  if (!S.isPremium) {
    if (disclaimer) disclaimer.style.display = 'block';

    let html = '<div class="card-title" style="margin:16px 0 12px">Example Signals</div>';
    signals.forEach((s, i) => {
      const locked = i > 0;
      html += `<div class="signal-card ${locked?'locked':''}" style="border-left:3px solid var(--${s.type==='csp'?'green':'blue'})"><div class="signal-header"><span class="signal-type ${s.type}">${s.type.toUpperCase()}</span><span class="signal-time">${s.time}</span></div><div class="signal-ticker">${s.ticker}</div><div class="signal-details">$${s.strike} ${s.type==='csp'?'Put':'Call'} ¬∑ Exp ${s.exp}</div><div style="display:flex;gap:16px;font-size:13px"><span>Premium: <b style="color:var(--green)">${s.prem}</b></span><span>Delta: <b>${s.delta}</b></span></div>${locked?`<div class="signal-lock"><svg viewBox="0 0 24 24" fill="none" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg><span>Unlock with Premium</span></div>`:''}</div>`;
    });
    html += '<button class="btn mt-4" onclick="openPremium()">Unlock Live Signals</button>';
    c.innerHTML = html;
    return;
  }

  // PREMIUM: Show real signals
  if (disclaimer) disclaimer.style.display = 'none';

  // Separate by type
  const sigs = posts.filter(p => p.kind === 'signal');
  const anns = posts.filter(p => p.kind === 'announcement');
  const rolls = posts.filter(p => p.kind === 'roll');

  // Separate open vs closed positions
  const openSigs = sigs.filter(p => !p.status || p.status === 'open');
  const closedSigs = sigs.filter(p => p.status && p.status !== 'open');

  let html = '';

  // Announcements at top
  anns.slice(0, 3).forEach(a => {
    html += `<div class="signal-card" style="border-left:3px solid var(--orange);background:var(--orange-bg)"><div style="font-weight:600;margin-bottom:4px">${a.title}</div><div style="font-size:13px;color:var(--text2)">${a.message}</div><div style="font-size:11px;color:var(--text3);margin-top:8px">${getTimeAgo(a.timestamp)}</div></div>`;
  });

  // Roll updates
  rolls.slice(0, 5).forEach(r => {
    html += `<div class="signal-card" style="border-left:3px solid var(--purple)"><div class="signal-header"><span class="signal-type" style="background:var(--purple-bg);color:var(--purple)">ROLL</span><span class="signal-time">${getTimeAgo(r.timestamp)}</span></div><div style="font-size:13px;margin:8px 0"><span style="color:var(--red)">${r.original}</span> ‚Üí <span style="color:var(--green)">${r.newPos}</span></div><div style="font-size:14px;font-weight:600;color:var(--green)">${r.credit}</div>${r.notes?`<div style="font-size:12px;color:var(--text2);margin-top:4px">${r.notes}</div>`:''}</div>`;
  });

  // OPEN POSITIONS section
  if (openSigs.length > 0) {
    html += `<div class="card-title" style="margin:16px 0 12px;display:flex;align-items:center;gap:8px"><span style="display:inline-block;width:8px;height:8px;background:var(--green);border-radius:50%;animation:pulse 2s infinite"></span>Open Positions (${openSigs.length})</div>`;
    openSigs.forEach((s) => {
      const time = s.timestamp ? getTimeAgo(s.timestamp) : s.time;
      html += `<div class="signal-card" style="border-left:3px solid var(--${s.type==='csp'?'green':'blue'})"><div class="signal-header"><span class="signal-type ${s.type}">${s.type.toUpperCase()}</span><span class="signal-time">${time}</span></div><div class="signal-ticker">${s.ticker}</div><div class="signal-details">$${s.strike} ${s.type==='csp'?'Put':'Call'} ¬∑ Exp ${s.exp}</div><div style="display:flex;gap:16px;font-size:13px"><span>Premium: <b style="color:var(--green)">${s.prem}</b></span><span>Delta: <b>${s.delta}</b></span></div></div>`;
    });
  } else {
    html += `<div class="empty" style="padding:24px"><div class="empty-title">No Open Positions</div><div class="empty-text">New signals will appear here when posted</div></div>`;
  }

  // CLOSED POSITIONS section
  if (closedSigs.length > 0) {
    html += `<div class="card-title" style="margin:24px 0 12px">üìä Position History (${closedSigs.length})</div>`;
    closedSigs.slice(0, 15).forEach((s) => {
      let statusBadge = '';
      if (s.status === 'winner') statusBadge = '<span class="status-badge winner">WIN üéâ</span>';
      else if (s.status === 'rolled') statusBadge = '<span class="status-badge rolled">ROLLED</span>';
      else if (s.status === 'assigned') statusBadge = '<span class="status-badge assigned">ASSIGNED üì¶</span>';
      else if (s.status === 'called') statusBadge = '<span class="status-badge called">CALLED üì§</span>';
      else statusBadge = '<span class="status-badge closed">CLOSED</span>';

      const borderColor = s.status === 'winner' ? 'var(--green)' : s.status === 'assigned' ? 'var(--orange)' : s.status === 'called' ? 'var(--blue)' : 'var(--text3)';
      html += `<div class="signal-card" style="border-left:3px solid ${borderColor}${['winner','assigned','called'].includes(s.status)?'':';opacity:0.8'}"><div class="signal-header"><span class="signal-type ${s.type}">${s.type.toUpperCase()}</span>${statusBadge}<span class="signal-time" style="margin-left:auto">${getTimeAgo(s.closedAt || s.timestamp)}</span></div><div class="signal-ticker">${s.ticker}</div><div class="signal-details">$${s.strike} ${s.type==='csp'?'Put':'Call'} ¬∑ Exp ${s.exp}</div><div style="display:flex;gap:16px;font-size:13px"><span>Premium: <b style="color:var(--green)">${s.prem}</b></span></div></div>`;
    });
  }

  c.innerHTML = html || '<div class="empty"><div class="empty-title">No Signals Yet</div><div class="empty-text">Live trading signals will appear here</div></div>';
}
function renderProfile(){
  $('userName').value=S.user.name||'';
  $('userEmail').value=S.user.email||'';
  $('userPhone').value=S.user.phone||'';
  $('profileName').textContent=S.user.name||'Set up your profile';
  $('profileEmail').textContent=S.user.email||'Tap to edit';
  const init=S.user.name?S.user.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2):'?';
  $('profileInitials').textContent=init;

  // Show avatar image if exists
  const avatarImg = $('profileAvatarImg');
  const initials = $('profileInitials');
  if (S.user.avatar && avatarImg) {
    avatarImg.src = S.user.avatar;
    avatarImg.style.display = 'block';
    if (initials) initials.style.display = 'none';
  } else if (avatarImg) {
    avatarImg.style.display = 'none';
    if (initials) initials.style.display = 'block';
  }
  $('apiKeyInput').value=S.apiKey;
  $('secretKeyInput').value=S.secretKey;
  $('accSizeInput').value=S.accSize;
  const ok=S.apiKey.length>10;
  $('brokerStatus').innerHTML=ok?'<div style="padding:12px;background:var(--green-bg);border-radius:12px;margin-bottom:16px;font-weight:600;color:var(--green)"><span class="live-dot"></span>Connected</div>':'<div style="padding:12px;background:var(--orange-bg);border-radius:12px;margin-bottom:16px;font-size:13px;color:var(--orange)">Not connected</div>';
  const wins=S.history.filter(t=>(t.pnl||0)>=0).length;
  const total=S.history.length;
  const prem=S.positions.reduce((s,p)=>s+(p.premium||0)*(p.contracts||1)*100,0)+S.history.reduce((s,t)=>s+(t.premium||0)*(t.contracts||1)*100,0);
  $('pTrades').textContent=total;
  $('pWinRate').textContent=total?Math.round(wins/total*100)+'%':'0%';
  $('pPremium').textContent='$'+prem.toFixed(0);
  // Show alert prefs for premium users
  if(S.isPremium){show('proBadge');hide('proCard');$('alertPrefsCard').style.display='block';}
  else{$('alertPrefsCard').style.display='none';}
}
function saveProfile(){S.user.name=$('userName').value.trim();S.user.email=$('userEmail').value.trim();S.user.phone=$('userPhone')?.value.trim()||'';save();renderProfile();showToast('Saved!','success')}

function handleAvatarUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  // Check file size (max 500KB to avoid localStorage issues)
  if (file.size > 500000) {
    showToast('Image too large. Max 500KB', 'error');
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      // Resize image to max 200x200 to save space
      const canvas = document.createElement('canvas');
      const max = 200;
      let w = img.width, h = img.height;
      if (w > h) { if (w > max) { h = h * max / w; w = max; } }
      else { if (h > max) { w = w * max / h; h = max; } }
      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);

      const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
      S.user.avatar = dataUrl;
      save();
      renderProfile();
      showToast('Photo updated!', 'success');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function connectBroker(){S.apiKey=$('apiKeyInput').value.trim();S.secretKey=$('secretKeyInput').value.trim();S.accSize=parseInt($('accSizeInput').value)||25000;save();updateStatus();renderProfile();if(S.apiKey)showToast('Connected!','success')}
load();applyTheme();

// Initialize app when DOM is ready
function initApp() {
  // Check auth state on load
  if (!checkAuthState()) {
    // Not logged in, show auth screen and hide bottom nav
    showAuthScreen();
  } else {
    checkLegal();
  }
  updateStatus();
  initAdminAccess();
  listenToFirebasePosts();
  listenForWinners();

  // Use requestAnimationFrame to ensure DOM is fully painted before rendering
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      renderHome();
    });
  });
}

// Run init when DOM is fully ready
function safeInit() {
  // Double-check DOM is ready with multiple elements
  const homeTab = $('homeTab');
  const posContainer = $('positionsContainer');
  const histContainer = $('historyContainer');

  if (!homeTab || !posContainer || !histContainer) {
    // DOM not ready, wait and retry
    setTimeout(safeInit, 50);
    return;
  }

  initApp();
}

// Run init when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', safeInit);
} else if (document.readyState === 'interactive') {
  // DOM is parsed but resources may still be loading
  setTimeout(safeInit, 10);
} else {
  // DOM is fully loaded
  safeInit();
}

// Re-render when tab becomes visible again (fixes blank content issue)
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && (S.firebaseUid || S.isGuest)) {
    // Use RAF to ensure smooth re-render after tab switch
    requestAnimationFrame(() => {
      renderHome();
    });
  }
});

// Failsafe: Re-render after all resources are fully loaded
window.addEventListener('load', () => {
  // Give a small delay to ensure everything is settled
  setTimeout(() => {
    if (S.firebaseUid || S.isGuest) {
      renderHome();
    }
  }, 100);
});
</script>
</body>
</html>
