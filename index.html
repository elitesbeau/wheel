<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000">
  <title>Market Elites</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--bg:#f5f5f7;--card:#fff;--input:#f0f0f2;--text:#1d1d1f;--text2:#86868b;--text3:#aeaeb2;--border:#e5e5e7;--hero:#1d1d1f;--green:#34c759;--green-bg:rgba(52,199,89,.12);--red:#ff3b30;--red-bg:rgba(255,59,48,.12);--blue:#007aff;--blue-bg:rgba(0,122,255,.12);--orange:#ff9500;--orange-bg:rgba(255,149,0,.12);--purple:#af52de;--purple-bg:rgba(175,82,222,.12)}
    [data-theme=dark]{--bg:#000;--card:#1c1c1e;--input:#2c2c2e;--text:#fff;--text2:#98989f;--text3:#636366;--border:#38383a;--hero:#1c1c1e}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .app{max-width:430px;margin:0 auto;padding:12px 0 90px}
    .hero{margin:0 16px 20px;background:var(--hero);border-radius:24px;padding:20px;position:relative;overflow:hidden}
    .hero::before{content:'';position:absolute;top:-80%;right:-20%;width:300px;height:300px;background:radial-gradient(circle,rgba(255,255,255,.08) 0%,transparent 70%)}
    .hero-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;position:relative;z-index:1}
    .hero-left{display:flex;align-items:center;gap:10px}
    .icon-btn{width:40px;height:40px;background:rgba(255,255,255,.1);border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .icon-btn:active{background:rgba(255,255,255,.2)}
    .icon-btn svg{width:20px;height:20px;stroke:#fff;stroke-width:1.75;fill:none}
    .avatar-btn{width:40px;height:40px;border-radius:50%;border:2px solid rgba(255,255,255,.3);background:linear-gradient(135deg,#f97316,#dc2626);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .avatar-btn span{color:#fff;font-weight:700;font-size:14px}
    .status{display:flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(255,255,255,.1);border-radius:20px;font-size:11px;font-weight:600;color:#fff}
    .status-dot{width:6px;height:6px;border-radius:50%;background:var(--red)}
    .status.ready .status-dot{background:var(--orange)}
    .status.live .status-dot{background:var(--green);animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .hero-balance{text-align:center;margin-bottom:32px;position:relative;z-index:1}
    .balance-label{color:rgba(255,255,255,.6);font-size:13px;margin-bottom:6px}
    .balance-amount{font-size:44px;font-weight:800;color:#fff}
    .balance-change{display:inline-flex;margin-top:8px;padding:5px 12px;background:var(--green-bg);border-radius:12px;font-size:13px;font-weight:600;color:var(--green)}
    .hero-actions{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;position:relative;z-index:1}
    .hero-btn{display:flex;flex-direction:column;align-items:center;gap:10px;background:none;border:none;cursor:pointer;padding:8px}
    .hero-btn-icon{width:52px;height:52px;border-radius:50%;border:1.5px solid rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center}
    .hero-btn:active .hero-btn-icon{background:rgba(255,255,255,.1);transform:scale(.95)}
    .hero-btn-icon svg{width:22px;height:22px;stroke:#fff;stroke-width:2;fill:none}
    .hero-btn span{font-size:11px;font-weight:500;color:rgba(255,255,255,.85)}
    .quick-actions{display:flex;justify-content:space-around;padding:0 16px;margin-bottom:24px}
    .quick-btn{display:flex;flex-direction:column;align-items:center;gap:8px;background:none;border:none;cursor:pointer}
    .quick-btn:active{transform:scale(.95)}
    .quick-icon{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center}
    .quick-icon svg{width:24px;height:24px;stroke-width:2;fill:none}
    .quick-icon.blue{background:var(--blue-bg)}.quick-icon.blue svg{stroke:var(--blue)}
    .quick-icon.green{background:var(--green-bg)}.quick-icon.green svg{stroke:var(--green)}
    .quick-icon.purple{background:var(--purple-bg)}.quick-icon.purple svg{stroke:var(--purple)}
    .quick-icon.orange{background:var(--orange-bg)}.quick-icon.orange svg{stroke:var(--orange)}
    .quick-btn span{font-size:12px;font-weight:500;color:var(--text2)}
    .section{padding:0 16px;margin-bottom:24px}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .section-title{font-size:18px;font-weight:700}
    .section-link{font-size:13px;font-weight:600;color:var(--blue);background:none;border:none;cursor:pointer}
    .pos-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px;cursor:pointer}
    .pos-card:active{transform:scale(.98)}
    .pos-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
    .pos-left{display:flex;align-items:center;gap:12px}
    .pos-logo{width:44px;height:44px;border-radius:12px;background:var(--input);display:flex;align-items:center;justify-content:center;overflow:hidden}
    .pos-logo img{width:100%;height:100%;object-fit:cover}
    .pos-logo-text{font-size:14px;font-weight:700;color:#fff;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#6366f1,#8b5cf6);border-radius:12px}
    .pos-symbol{font-size:16px;font-weight:700}
    .pos-name{font-size:13px;color:var(--text2)}
    .pos-badge{padding:5px 10px;border-radius:8px;font-size:11px;font-weight:700}
    .pos-badge.csp{background:var(--green-bg);color:var(--green)}
    .pos-badge.cc{background:var(--blue-bg);color:var(--blue)}
    .pos-badge.shares{background:var(--purple-bg);color:var(--purple)}
    .pos-stats{display:flex;justify-content:space-between}
    .pos-stat-val{font-size:15px;font-weight:700}
    .pos-stat-val.pos{color:var(--green)}.pos-stat-val.neg{color:var(--red)}
    .pos-stat-label{font-size:11px;color:var(--text3);margin-top:2px}
    .tx-list{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .tx-item{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border)}
    .tx-item:last-child{border-bottom:none}
    .tx-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center}
    .tx-icon svg{width:18px;height:18px;stroke-width:2;fill:none}
    .tx-icon.csp{background:var(--green-bg)}.tx-icon.csp svg{stroke:var(--green)}
    .tx-icon.cc{background:var(--blue-bg)}.tx-icon.cc svg{stroke:var(--blue)}
    .tx-info{flex:1}.tx-title{font-size:15px;font-weight:600}.tx-sub{font-size:12px;color:var(--text3)}
    .tx-amount{font-size:15px;font-weight:700}
    .tx-amount.pos{color:var(--green)}.tx-amount.neg{color:var(--red)}
    .empty{text-align:center;padding:40px 20px;background:var(--card);border:1px solid var(--border);border-radius:16px}
    .empty-icon{width:56px;height:56px;margin:0 auto 12px;background:var(--input);border-radius:50%;display:flex;align-items:center;justify-content:center}
    .empty-icon svg{width:24px;height:24px;stroke:var(--text3);stroke-width:1.5;fill:none}
    .empty-title{font-size:16px;font-weight:600;margin-bottom:4px}
    .empty-text{font-size:13px;color:var(--text2);margin-bottom:16px}
    .empty-btn{padding:12px 24px;background:var(--hero);border:none;border-radius:12px;font-size:14px;font-weight:600;color:#fff;cursor:pointer}
    .nav{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);padding:4px 0 max(4px,env(safe-area-inset-bottom));z-index:100}
    .nav-inner{max-width:500px;margin:0 auto;display:flex;justify-content:stretch}
    .nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:12px 8px;background:none;border:none;cursor:pointer;min-height:56px}
    .nav-btn svg{width:24px;height:24px;stroke-width:1.75;fill:none}
    .nav-btn span{font-size:10px;font-weight:500}
    .nav-btn.active svg{stroke:var(--text)}.nav-btn.active span{color:var(--text);font-weight:600}
    .nav-btn:not(.active) svg{stroke:var(--text3)}.nav-btn:not(.active) span{color:var(--text3)}
    .tab{display:none}.tab.active{display:block}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin:0 16px 16px}
    .card-title{font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:16px}
    .form-group{margin-bottom:16px}
    .form-label{font-size:13px;font-weight:500;color:var(--text2);margin-bottom:8px;display:block}
    .form-input,.form-select{width:100%;background:var(--input);border:1px solid var(--border);border-radius:12px;padding:14px 16px;font-size:15px;color:var(--text);outline:none}
    .toggle{display:flex;background:var(--input);border-radius:10px;padding:4px;margin-bottom:16px}
    .toggle-btn{flex:1;padding:10px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;background:transparent;color:var(--text2)}
    .toggle-btn.active{background:var(--card);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .search-row{display:flex;gap:10px;margin-bottom:12px}
    .search-input{flex:1;background:var(--input);border:1px solid var(--border);border-radius:12px;padding:14px 16px;font-size:18px;font-weight:700;text-transform:uppercase;color:var(--text);outline:none}
    .search-btn{width:52px;height:52px;background:var(--hero);border:none;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .search-btn svg{width:22px;height:22px;stroke:#fff;stroke-width:2.5;fill:none}
    .help-btn{width:32px;height:32px;background:var(--blue-bg);border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .help-btn svg{width:16px;height:16px;stroke:var(--blue);stroke-width:2;fill:none}
    .tickers{display:flex;gap:8px;flex-wrap:wrap}
    .ticker-btn{padding:8px 14px;background:var(--input);border:1px solid var(--border);border-radius:20px;font-size:12px;font-weight:600;color:var(--text2);cursor:pointer}
    .ticker-btn:active{background:var(--hero);color:#fff}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .stat-box{background:var(--input);border-radius:12px;padding:16px;text-align:center}
    .stat-val{font-size:22px;font-weight:700}.stat-val.green{color:var(--green)}.stat-val.blue{color:var(--blue)}
    .stat-label{font-size:11px;color:var(--text2)}
    .btn{width:100%;padding:16px;background:var(--hero);border:none;border-radius:12px;font-size:15px;font-weight:600;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
    .btn svg{width:18px;height:18px;stroke:#fff;stroke-width:2;fill:none}
    .btn-outline{background:transparent;border:1.5px solid var(--border);color:var(--text)}.btn-outline svg{stroke:var(--text)}
    .btn-red{background:var(--red-bg);color:var(--red)}.btn-red svg{stroke:var(--red)}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:none;align-items:flex-end;justify-content:center}
    .modal-bg.show{display:flex}.modal-bg.center{align-items:center}
    .modal{background:var(--card);border-radius:20px 20px 0 0;padding:20px;padding-bottom:max(20px,env(safe-area-inset-bottom));width:100%;max-width:430px;max-height:85vh;overflow-y:auto;animation:slideUp .3s ease}
    .modal-bg.center .modal{border-radius:20px;margin:20px}
    @keyframes slideUp{from{transform:translateY(100%)}}
    .modal-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-title{font-size:18px;font-weight:700}
    .modal-close{width:32px;height:32px;background:var(--input);border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .modal-close svg{width:16px;height:16px;stroke:var(--text2);stroke-width:2;fill:none}
    .setting-row{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid var(--border)}
    .setting-row:last-child{border-bottom:none}
    .switch{width:50px;height:28px;background:var(--input);border-radius:14px;padding:2px;border:none;cursor:pointer}
    .switch.on{background:var(--green)}
    .switch-knob{width:24px;height:24px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
    .switch.on .switch-knob{transform:translateX(22px)}
    .profile-header{text-align:center;padding:20px 0}
    .profile-avatar{width:100px;height:100px;border-radius:50%;margin:0 auto 16px;background:linear-gradient(135deg,#f97316,#dc2626);display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer}
    .profile-avatar span{color:#fff;font-size:36px;font-weight:700}
    .profile-avatar-edit{position:absolute;bottom:0;right:0;width:32px;height:32px;background:var(--blue);border-radius:50%;display:flex;align-items:center;justify-content:center}
    .profile-avatar-edit svg{width:16px;height:16px;stroke:#fff;stroke-width:2;fill:none}
    .profile-name{font-size:24px;font-weight:700}
    .profile-email{font-size:14px;color:var(--text2);margin-bottom:16px}
    .profile-badge{display:inline-flex;padding:8px 16px;background:var(--text);border-radius:20px;font-size:13px;font-weight:600;color:var(--bg)}
    .profile-stats{display:flex;justify-content:space-around;padding:20px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border);margin:20px 0}
    .profile-stat{text-align:center}.profile-stat-val{font-size:20px;font-weight:700}.profile-stat-label{font-size:12px;color:var(--text2)}
    .signal-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px;position:relative}
    .signal-card.locked::after{content:'';position:absolute;inset:0;background:var(--bg);opacity:.85;border-radius:16px}
    .signal-header{display:flex;justify-content:space-between;margin-bottom:12px}
    .signal-type{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700}
    .signal-type.csp{background:var(--green-bg);color:var(--green)}
    .signal-type.cc{background:var(--blue-bg);color:var(--blue)}
    .signal-time{font-size:12px;color:var(--text3)}
    .signal-ticker{font-size:20px;font-weight:700}
    .signal-details{font-size:14px;color:var(--text2);margin:4px 0 12px}
    .signal-lock{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1}
    .signal-lock svg{width:24px;height:24px;stroke:var(--text3);stroke-width:1.5;margin-bottom:6px}
    .signal-lock span{font-weight:500;color:var(--text2);font-size:13px}
    .wheely-avatar{width:48px;height:48px;background:linear-gradient(145deg,#6366f1,#4f46e5);border-radius:14px;position:relative;display:flex;align-items:center;justify-content:center}
    .wheely-face{width:36px;height:20px;background:#fff;border-radius:6px;display:flex;align-items:center;justify-content:center;gap:10px}
    .wheely-eye{width:6px;height:8px;background:#4f46e5;border-radius:2px;animation:blink 3s infinite}
    @keyframes blink{0%,94%,100%{transform:scaleY(1)}96%{transform:scaleY(.1)}}
    .wheely-antenna{position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:3px;height:8px;background:#6366f1;border-radius:2px}
    .wheely-antenna::after{content:'';position:absolute;top:-5px;left:50%;transform:translateX(-50%);width:8px;height:8px;background:#a5b4fc;border-radius:50%}
    .ai-header{display:flex;align-items:center;gap:12px;margin-bottom:20px}
    .ai-info h3{font-size:16px;font-weight:700}.ai-info p{font-size:12px;color:var(--text2)}
    .ai-messages{min-height:200px;max-height:300px;overflow-y:auto;margin-bottom:16px}
    .ai-msg{padding:12px;border-radius:12px;margin-bottom:8px;font-size:14px;line-height:1.5;max-width:85%}
    .ai-msg.user{background:var(--blue);color:#fff;margin-left:auto}
    .ai-msg.bot{background:var(--input)}
    .legal-content{font-size:13px;line-height:1.7;color:var(--text2);max-height:50vh;overflow-y:auto;margin-bottom:20px;padding:16px;background:var(--input);border-radius:12px}
    .legal-content h3{color:var(--text);margin:16px 0 8px;font-size:14px}
    .legal-content h3:first-child{margin-top:0}
    .legal-checkbox{display:flex;align-items:flex-start;gap:12px;margin-bottom:20px}
    .legal-checkbox input{width:20px;height:20px;margin-top:2px;accent-color:var(--blue)}
    .legal-checkbox label{font-size:13px;color:var(--text2)}
    .footer{padding:20px 16px;text-align:center;font-size:11px;color:var(--text3)}
    .footer a{color:var(--text2);margin:0 8px}
    .loading{display:flex;justify-content:center;padding:40px}
    .spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none!important}
    .mt-4{margin-top:16px}
    .live-dot{display:inline-block;width:8px;height:8px;background:var(--green);border-radius:50%;margin-right:6px;animation:pulse 2s infinite}
    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 24px;font-size:14px;font-weight:500;box-shadow:0 4px 20px rgba(0,0,0,.3);z-index:300;opacity:0;transition:all .3s ease}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.success{border-color:var(--green);background:var(--green-bg);color:var(--green)}
    .toast.error{border-color:var(--red);background:var(--red-bg);color:var(--red)}
    .confetti{position:fixed;width:10px;height:10px;z-index:400;animation:fall linear forwards}
    @keyframes fall{to{transform:translateY(100vh) rotate(720deg);opacity:0}}
    .celebration-overlay{position:fixed;inset:0;z-index:350;pointer-events:none;display:flex;align-items:center;justify-content:center}
    .celebration-text{font-size:48px;font-weight:800;color:var(--green);text-shadow:0 4px 20px rgba(52,199,89,.5);animation:celebratePop .6s ease-out}
    @keyframes celebratePop{0%{transform:scale(0);opacity:0}50%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}
    .post-actions{display:flex;gap:6px;margin-top:8px}
    .post-action-btn{padding:4px 10px;border:none;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer}
    .post-action-btn.winner{background:var(--green-bg);color:var(--green)}
    .post-action-btn.roll{background:var(--purple-bg);color:var(--purple)}
    .post-action-btn.delete{background:var(--red-bg);color:var(--red)}
    .status-badge{padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700;margin-left:6px}
    .status-badge.open{background:var(--blue-bg);color:var(--blue)}
    .status-badge.winner{background:var(--green-bg);color:var(--green)}
    .status-badge.rolled{background:var(--purple-bg);color:var(--purple)}
    .status-badge.closed{background:var(--text3);color:var(--bg)}
    .position-select{width:100%;background:var(--input);border:1px solid var(--border);border-radius:12px;padding:14px 16px;font-size:15px;color:var(--text);outline:none;cursor:pointer}
    .auth-container{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:0;background:#faf9f7}
    .auth-container > div{width:100%;max-width:420px;min-height:100vh;display:flex;flex-direction:column;background:#faf9f7}
    @media(min-width:600px){
      .auth-container{background:linear-gradient(135deg,#f5f5f5 0%,#e8e8e8 100%)}
      .auth-container > div{min-height:auto;background:#fff;border-radius:24px;box-shadow:0 8px 32px rgba(0,0,0,0.08);margin:40px 20px;padding-bottom:0}
      .auth-content{padding:32px 40px 24px}
      .auth-terms{padding:20px 40px}
      .auth-switch{padding:16px 40px 32px}
    }
    .auth-header{padding:16px 20px;display:flex;align-items:center;gap:12px}
    @media(min-width:600px){.auth-header{padding:24px 40px 0}}
    .auth-logo-img{height:24px;width:auto}
    .auth-back{width:40px;height:40px;border:none;background:none;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .auth-back svg{width:24px;height:24px;stroke:#1a1a1a;stroke-width:2;fill:none}
    .auth-page-title{font-size:20px;font-weight:600;margin-left:8px;color:#1a1a1a}
    .auth-content{flex:1;padding:20px 24px}
    .auth-welcome{font-size:28px;font-weight:700;color:#1a1a1a;margin-bottom:8px}
    @media(min-width:600px){.auth-welcome{font-size:32px}}
    .auth-subtitle{font-size:15px;color:#666;margin-bottom:32px;line-height:1.5}
    @media(min-width:600px){.auth-subtitle{font-size:16px}}
    .float-input{position:relative;margin-bottom:20px}
    .float-input input{width:100%;padding:20px 16px 8px;font-size:16px;border:2px solid #e5e5e5;border-radius:12px;background:#fff;outline:none;transition:all .2s;box-sizing:border-box}
    .float-input input:focus{border-color:#1a1a1a;box-shadow:0 0 0 4px rgba(0,0,0,0.04)}
    .float-input input:hover:not(:focus){border-color:#ccc}
    .float-input label{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:16px;color:#999;pointer-events:none;transition:all .2s}
    .float-input input:focus+label,.float-input input:not(:placeholder-shown)+label{top:12px;transform:translateY(0);font-size:11px;color:#666;font-weight:500}
    .float-input .toggle-pass{position:absolute;right:16px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px}
    .float-input .toggle-pass svg{width:20px;height:20px;stroke:#999;stroke-width:1.5;fill:none}
    .pass-requirements{margin-bottom:24px}
    .pass-requirements p{font-size:13px;color:#666;margin-bottom:12px;font-weight:500}
    .pass-checks{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .pass-check{display:flex;align-items:center;gap:8px;font-size:13px;color:#999}
    .pass-check .check-circle{width:18px;height:18px;border:1.5px solid #ddd;border-radius:50%;display:flex;align-items:center;justify-content:center}
    .pass-check.valid{color:#1a1a1a}
    .pass-check.valid .check-circle{background:#1a1a1a;border-color:#1a1a1a}
    .pass-check.valid .check-circle::after{content:'‚úì';color:#fff;font-size:10px}
    .auth-btn{width:100%;padding:16px;font-size:16px;font-weight:600;border:none;border-radius:12px;cursor:pointer;transition:all .2s}
    .auth-btn.primary{background:#1a1a1a;color:#fff}
    .auth-btn.primary:hover{background:#333;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
    .auth-btn.primary:active{transform:translateY(0);box-shadow:none}
    .auth-btn.primary:disabled{background:#e5e5e5;color:#999;cursor:not-allowed;transform:none;box-shadow:none}
    .auth-btn.secondary{background:#fff;color:#1a1a1a;border:2px solid #e5e5e5}
    .auth-btn.secondary:hover{border-color:#1a1a1a;background:#fafafa}
    .auth-btn.google{background:#fff;color:#1a1a1a;border:2px solid #e5e5e5;display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:12px}
    .auth-btn.google:hover{border-color:#4285F4;background:#f8faff}
    .auth-btn.google svg{flex-shrink:0}
    .auth-terms{font-size:12px;color:#999;text-align:center;margin-top:auto;padding:24px;line-height:1.6}
    .auth-terms a{color:#1a1a1a;text-decoration:underline}
    .auth-switch{text-align:center;padding:20px;font-size:14px;color:#666;border-top:1px solid #f0f0f0}
    @media(min-width:600px){.auth-switch{background:#f9f9f9;border-radius:0 0 24px 24px}}
    .auth-switch a{color:#1a1a1a;font-weight:600;text-decoration:none}
    .auth-switch a:hover{text-decoration:underline}
    .auth-divider{display:flex;align-items:center;gap:12px;margin:24px 0;color:#999;font-size:13px}
    .auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:#e5e5e5}
    .confirm-modal{background:var(--card);border-radius:20px;padding:24px;max-width:320px;margin:20px;text-align:center}
    .confirm-title{font-size:18px;font-weight:700;color:var(--text);margin-bottom:8px}
    .confirm-message{font-size:14px;color:var(--text2);margin-bottom:24px;line-height:1.5}
    .confirm-buttons{display:flex;gap:12px}
    .premium-modal{background:#fff;border-radius:24px;padding:32px 24px;text-align:center;max-width:340px;margin:20px}
    .premium-modal-icon{font-size:80px;margin-bottom:16px}
    .premium-modal h2{font-size:24px;font-weight:700;margin-bottom:12px;color:#1a1a1a}
    .premium-modal p{font-size:15px;color:#666;line-height:1.5;margin-bottom:24px}
    .premium-modal .float-input{text-align:left}
    .premium-features{text-align:left;margin:20px 0}
    .premium-feature{display:flex;align-items:center;gap:12px;padding:10px 0;font-size:14px;color:#1a1a1a}
    .premium-feature svg{width:20px;height:20px;stroke:#22c55e;stroke-width:2.5;fill:none}
    .status-badge.assigned{background:var(--orange-bg);color:var(--orange)}
    .status-badge.called{background:var(--blue-bg);color:var(--blue)}
    .post-action-btn.assigned{background:var(--orange-bg);color:var(--orange)}
    .post-action-btn.called{background:var(--blue-bg);color:var(--blue)}
    .home-alerts{margin-top:16px}
    .home-alert-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:12px}
    .home-alert-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
    .home-alert-content{flex:1}
    .home-alert-title{font-size:13px;font-weight:600}
    .home-alert-sub{font-size:11px;color:var(--text2)}
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div class="auth-container" id="authScreen">
    <div id="authLogin">
      <div class="auth-header">
        <img src="https://raw.githubusercontent.com/elitesbeau/wheel/main/logo.png" alt="elite" class="auth-logo-img" onerror="this.style.display='none'">
        <span class="auth-page-title">Sign In</span>
      </div>
      <div class="auth-content">
        <div class="auth-welcome">Welcome back</div>
        <div class="auth-subtitle">Sign in to access your portfolio and live trading signals.</div>

        <div class="float-input">
          <input type="email" id="loginEmail" placeholder=" " autocomplete="email">
          <label>Email</label>
        </div>

        <div class="float-input">
          <input type="password" id="loginPassword" placeholder=" " autocomplete="current-password">
          <label>Password</label>
          <button class="toggle-pass" onclick="togglePasswordVisibility('loginPassword', this)">
            <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:#666;cursor:pointer">
            <input type="checkbox" id="rememberMe" style="width:18px;height:18px;accent-color:#1a1a1a;cursor:pointer">
            Remember me
          </label>
          <a href="#" onclick="showForgotPassword();return false" style="font-size:13px;color:#1a1a1a;font-weight:500;text-decoration:none">Forgot password?</a>
        </div>

        <button class="auth-btn primary" onclick="handleLogin()">Sign In</button>

        <div class="auth-divider">or</div>

        <button class="auth-btn google" onclick="handleGoogleSignIn()">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Continue with Google
        </button>

        <button class="auth-btn secondary" onclick="handleGuestLogin()">Continue as Guest</button>
      </div>
      <div class="auth-terms">
        By continuing, you agree to Market Elites'<br><a href="#">Terms of Use</a> and <a href="#">Privacy Policy</a>.
      </div>
      <div class="auth-switch">Don't have an account? <a href="#" onclick="showAuthTab('signup');return false">Sign up</a></div>
    </div>

    <div id="authSignup" class="hidden">
      <div class="auth-header">
        <button class="auth-back" onclick="showAuthTab('login')">
          <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </button>
        <span class="auth-page-title">Create Account</span>
      </div>
      <div class="auth-content">
        <div class="float-input">
          <input type="text" id="signupName" placeholder=" " autocomplete="name">
          <label>Full Name</label>
        </div>

        <div class="float-input">
          <input type="email" id="signupEmail" placeholder=" " autocomplete="email">
          <label>Email</label>
        </div>

        <div class="float-input">
          <input type="password" id="signupPassword" placeholder=" " autocomplete="new-password" oninput="checkPasswordStrength()">
          <label>Password</label>
          <button class="toggle-pass" onclick="togglePasswordVisibility('signupPassword', this)">
            <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>

        <div class="pass-requirements">
          <p>Password must contain:</p>
          <div class="pass-checks">
            <div class="pass-check" id="passLength"><span class="check-circle"></span>8+ characters</div>
            <div class="pass-check" id="passNumber"><span class="check-circle"></span>Number</div>
            <div class="pass-check" id="passLower"><span class="check-circle"></span>Lowercase letter</div>
            <div class="pass-check" id="passSpecial"><span class="check-circle"></span>Special character</div>
            <div class="pass-check" id="passUpper"><span class="check-circle"></span>Uppercase letter</div>
          </div>
        </div>

        <button class="auth-btn primary" id="signupBtn" onclick="handleSignup()" disabled>Create Account</button>

        <div class="auth-divider">or</div>

        <button class="auth-btn google" onclick="handleGoogleSignIn()">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Sign up with Google
        </button>
      </div>
      <div class="auth-terms">
        By creating an account, you agree to Market Elites'<br><a href="#">Terms of Use</a> and <a href="#">Privacy Policy</a>.
      </div>
      <div class="auth-switch">Already have an account? <a href="#" onclick="showAuthTab('login');return false">Sign in</a></div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-bg center" id="confirmModal" onclick="closeModal('confirmModal')">
    <div class="confirm-modal" onclick="event.stopPropagation()">
      <div class="confirm-title" id="confirmTitle">Are you sure?</div>
      <div class="confirm-message" id="confirmMessage">This action cannot be undone.</div>
      <div class="confirm-buttons">
        <button class="btn btn-outline" onclick="closeModal('confirmModal')" style="flex:1">Cancel</button>
        <button class="btn" id="confirmAction" onclick="closeModal('confirmModal')" style="flex:1">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Premium Popup Modal -->
  <div class="modal-bg center" id="premiumPopup" onclick="closeModal('premiumPopup')">
    <div class="premium-modal" onclick="event.stopPropagation()">
      <div class="premium-modal-icon">üîîüìà</div>
      <h2>Never miss a trade</h2>
      <p>Get instant alerts the second a new signal drops ‚Äì no noise, just actionable moves.</p>

      <div class="premium-features">
        <div class="premium-feature"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Real-time trading signals</div>
        <div class="premium-feature"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Email & Discord alerts</div>
        <div class="premium-feature"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Full position history</div>
        <div class="premium-feature"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Priority support</div>
      </div>

      <div class="float-input" style="margin-top:20px">
        <input type="email" id="premiumEmail" placeholder=" ">
        <label>Your email</label>
      </div>

      <button class="auth-btn primary" onclick="submitPremiumInterest()" style="margin-bottom:12px">Turn on alerts</button>
      <button class="auth-btn secondary" onclick="dismissAlertsPopup()">Not now</button>
    </div>
  </div>

  <div class="modal-bg center" id="legalModal">
    <div class="modal">
      <div class="modal-header"><span class="modal-title">Terms & Risk Disclosure</span></div>
      <div class="legal-content">
        <h3>‚ö†Ô∏è Risk Disclosure</h3>
        <p>Options trading involves substantial risk of loss. You could lose more than your initial investment.</p>
        <h3>üìã Not Financial Advice</h3>
        <p>Market Elites is for educational purposes only. Nothing herein constitutes investment advice.</p>
        <h3>üîê Data Privacy</h3>
        <p>Your data is stored locally. API keys are never transmitted to our servers.</p>
      </div>
      <div class="legal-checkbox">
        <input type="checkbox" id="legalAgree" onchange="document.getElementById('legalBtn').disabled=!this.checked">
        <label for="legalAgree">I understand the risks and agree to these terms.</label>
      </div>
      <button class="btn" id="legalBtn" onclick="acceptLegal()" disabled>Accept & Continue</button>
    </div>
  </div>

  <div class="app">
    <div class="tab active" id="homeTab">
      <div class="hero">
        <div class="hero-top">
          <div class="hero-left">
            <button class="icon-btn" onclick="openSettings()">
              <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </button>
            <button class="avatar-btn" onclick="goToProfile()"><span id="heroInitials">?</span></button>
          </div>
          <div class="status" id="statusPill"><span class="status-dot"></span><span id="statusText">Offline</span></div>
        </div>
        <div class="hero-balance">
          <div class="balance-label">Portfolio Value</div>
          <div class="balance-amount">$<span id="balanceVal">25,000</span></div>
          <div class="balance-change" id="balanceChange">‚Üë +$0 (0%)</div>
        </div>
        <div class="hero-actions">
          <button class="hero-btn" onclick="goCalc('csp')"><div class="hero-btn-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12l4 4 4-4"/></svg></div><span>Sell Put</span></button>
          <button class="hero-btn" onclick="openAdd()"><div class="hero-btn-icon"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg></div><span>Add</span></button>
          <button class="hero-btn" onclick="goCalc('cc')"><div class="hero-btn-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16V8M8 12l4-4 4 4"/></svg></div><span>Sell Call</span></button>
          <button class="hero-btn" onclick="syncPositions()"><div class="hero-btn-icon"><svg viewBox="0 0 24 24"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg></div><span>Sync</span></button>
        </div>
      </div>
      <div class="quick-actions">
        <button class="quick-btn" onclick="openLearn()"><div class="quick-icon blue"><svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg></div><span>Learn</span></button>
        <button class="quick-btn" onclick="openAnalytics()"><div class="quick-icon green"><svg viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg></div><span>Analytics</span></button>
        <button class="quick-btn" onclick="openAI()"><div class="quick-icon purple"><svg viewBox="0 0 24 24"><rect x="3" y="8" width="18" height="12" rx="2"/><path d="M7 8V6a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2"/><circle cx="9" cy="14" r="1.5"/><circle cx="15" cy="14" r="1.5"/></svg></div><span>Wheely</span></button>
        <button class="quick-btn" onclick="nav('signals')"><div class="quick-icon orange"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div><span>Signals</span></button>
      </div>
      <div class="section" id="alertsFeedSection" style="display:none"><div class="section-header"><span class="section-title">Latest Alerts</span><button class="section-link" onclick="nav('signals')">See All</button></div><div id="alertsFeedContainer"></div></div>
      <div class="section" id="guestBanner" style="display:none">
        <div style="background:linear-gradient(135deg,#1a1a1a,#333);border-radius:16px;padding:20px;text-align:center">
          <div style="font-size:24px;margin-bottom:8px">üëã</div>
          <div style="font-size:16px;font-weight:600;color:#fff;margin-bottom:4px">You're browsing as a guest</div>
          <div style="font-size:13px;color:#999;margin-bottom:16px">Create an account to save your portfolio and get alerts</div>
          <button class="btn" onclick="promptCreateAccount()" style="background:#fff;color:#1a1a1a">Create Free Account</button>
        </div>
      </div>
      <div class="section"><div class="section-header"><span class="section-title">Active Positions</span></div><div id="positionsContainer"></div></div>
      <div class="section"><div class="section-header"><span class="section-title">Recent Trades</span></div><div id="historyContainer"></div></div>
      <div class="footer"><a href="#" onclick="openModal('legalModal')">Terms</a>‚Ä¢<a href="#">Privacy</a>‚Ä¢<a href="#">Disclaimer</a><p style="margin-top:8px" onclick="secretAdminTap()">¬© 2025 Market Elites. Not financial advice.</p></div>
    </div>

    <div class="tab" id="calcTab">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span class="card-title" style="margin:0">Options Calculator</span><button class="help-btn" onclick="openLearn()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></button></div>
        <div class="toggle"><button class="toggle-btn active" id="cspBtn" onclick="setMode('csp')">Cash Secured Put</button><button class="toggle-btn" id="ccBtn" onclick="setMode('cc')">Covered Call</button></div>
        <div class="search-row"><input type="text" class="search-input" id="tickerInput" placeholder="AAPL" maxlength="5"><button class="search-btn" onclick="searchTicker()"><svg viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button></div>
        <div class="tickers"><button class="ticker-btn" onclick="qSearch('AAPL')">AAPL</button><button class="ticker-btn" onclick="qSearch('NVDA')">NVDA</button><button class="ticker-btn" onclick="qSearch('TSLA')">TSLA</button><button class="ticker-btn" onclick="qSearch('SPY')">SPY</button></div>
      </div>
      <div class="card hidden" id="loadingCard"><div class="loading"><div class="spinner"></div></div></div>
      <div class="card hidden" id="stockCard"><div style="font-size:24px;font-weight:700" id="stockSymbol">AAPL</div><div style="font-size:13px;color:var(--text2)" id="stockName">Apple Inc.</div><div style="font-size:36px;font-weight:700;margin:8px 0">$<span id="stockPrice">0.00</span></div></div>
      <div class="card hidden" id="optCard"><div class="card-title">Select Contract</div><div class="form-group"><label class="form-label">Expiration</label><select class="form-select" id="expSelect" onchange="onExpChange()"><option>Select...</option></select></div><div class="form-group"><label class="form-label">Strike</label><select class="form-select" id="strikeSelect" onchange="onStrikeChange()"><option>Select...</option></select></div></div>
      <div class="card hidden" id="resultCard"><div class="card-title">Analysis</div><div class="stats-grid"><div class="stat-box"><div class="stat-val green">$<span id="resPrem">0</span></div><div class="stat-label">Premium</div></div><div class="stat-box"><div class="stat-val blue"><span id="resAnn">0</span>%</div><div class="stat-label">Annualized</div></div><div class="stat-box"><div class="stat-val"><span id="resProb">0</span>%</div><div class="stat-label">Prob. Profit</div></div><div class="stat-box"><div class="stat-val"><span id="resCon">1</span></div><div class="stat-label">Contracts</div></div></div><button class="btn mt-4" onclick="addFromCalc()"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>Add to Portfolio</button></div>
      <div class="card" id="emptyCalc"><div class="empty" style="background:transparent;border:none"><div class="empty-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></div><div class="empty-title">Search a Symbol</div><div class="empty-text">Enter a ticker to see live options data</div><div style="display:flex;align-items:center;justify-content:center;gap:6px;margin:12px 0;padding:8px 16px;background:var(--green-bg);border-radius:20px;font-size:12px;color:var(--green);font-weight:600"><span class="live-dot"></span>Live pricing ‚Ä¢ No login required</div><button class="btn btn-outline" style="width:auto;margin:0 auto" onclick="openLearn()">New? Learn the basics ‚Üí</button></div></div>
    </div>

    <div class="tab" id="watchTab"><div class="section" style="padding-top:16px"><div class="section-header"><span class="section-title">Watchlist</span><button class="section-link" onclick="refreshWatch()">‚Üª Refresh</button></div><div id="watchContainer"></div></div></div>

    <div class="tab" id="signalsTab"><div class="section" style="padding-top:16px"><div class="section-header"><span class="section-title">Live Signals</span></div><p style="font-size:13px;color:var(--text2);margin-bottom:8px">Real-time wheel plays from our team</p><div id="exampleDisclaimer" style="padding:10px 14px;background:var(--input);border-radius:10px;margin-bottom:16px;font-size:12px;color:var(--text3)">Below are <b>example signals</b> showing what premium alerts look like. Subscribe to receive live plays.</div><div id="signalsContainer"></div></div></div>

    <div class="tab" id="alertsTab"><div class="section" style="padding-top:16px"><div class="section-header"><span class="section-title">Alerts</span></div><div id="alertsContainer"></div></div></div>

    <div class="tab" id="profileTab">
      <div class="card">
        <div class="profile-header">
          <div class="profile-avatar" onclick="$('avatarInput').click()">
            <img id="profileAvatarImg" src="" style="width:100%;height:100%;border-radius:50%;object-fit:cover;display:none">
            <span id="profileInitials">?</span>
            <div class="profile-avatar-edit"><svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg></div>
          </div>
          <input type="file" id="avatarInput" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)">
          <div class="profile-name" id="profileName">Set up your profile</div>
          <div class="profile-email" id="profileEmail">Tap to edit</div>
          <div class="profile-badge hidden" id="proBadge">Premium Member</div>
        </div>
        <div class="profile-stats">
          <div class="profile-stat"><div class="profile-stat-val" id="pTrades">0</div><div class="profile-stat-label">Trades</div></div>
          <div class="profile-stat"><div class="profile-stat-val" id="pWinRate">0%</div><div class="profile-stat-label">Win Rate</div></div>
          <div class="profile-stat"><div class="profile-stat-val" id="pPremium">$0</div><div class="profile-stat-label">Premium</div></div>
        </div>
      </div>
      <div class="card"><div class="card-title">Account</div><div class="form-group"><label class="form-label">Display Name</label><input type="text" class="form-input" id="userName" placeholder="Your name"></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="userEmail" placeholder="email@example.com"></div><div class="form-group"><label class="form-label">Phone (for SMS alerts)</label><input type="tel" class="form-input" id="userPhone" placeholder="+1 555 123 4567"></div><button class="btn btn-outline" onclick="saveProfile()">Save Profile</button></div>
      <div class="card" id="alertPrefsCard" style="display:none"><div class="card-title">Alert Notifications</div><p style="font-size:13px;color:var(--text2);margin-bottom:16px">Get notified instantly when new signals are posted</p><div class="setting-row"><span>Discord Alerts</span><button class="switch" id="discordSwitch" onclick="toggleDiscordAlerts()"><div class="switch-knob"></div></button></div><div class="setting-row"><span>SMS Alerts</span><button class="switch" id="smsSwitch" onclick="toggleSmsAlerts()"><div class="switch-knob"></div></button></div><p style="font-size:11px;color:var(--text3);margin-top:12px">SMS alerts require phone number above</p></div>
      <div class="card"><div class="card-title">Brokerage (Optional)</div><div style="padding:12px;background:var(--green-bg);border-radius:12px;margin-bottom:16px;font-size:13px;color:var(--green)"><span class="live-dot"></span><b>Live pricing works without login!</b><br><span style="opacity:0.8">Connect Alpaca only to sync your actual positions.</span></div><div id="brokerStatus"></div><div class="form-group"><label class="form-label">Alpaca API Key</label><input type="text" class="form-input" id="apiKeyInput" placeholder="PK..."></div><div class="form-group"><label class="form-label">Secret Key</label><input type="password" class="form-input" id="secretKeyInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div><div class="form-group"><label class="form-label">Account Size ($)</label><input type="number" class="form-input" id="accSizeInput" value="25000"></div><button class="btn" onclick="connectBroker()">Connect</button></div>
      <div class="card"><div class="card-title">Preferences</div><div class="setting-row"><span>Dark Mode</span><button class="switch" id="themeSwitch" onclick="toggleTheme()"><div class="switch-knob"></div></button></div><div class="setting-row"><span>Notifications</span><button class="switch" id="notifSwitch" onclick="toggleNotif()"><div class="switch-knob"></div></button></div></div>
      <div class="card" id="proCard"><div style="text-align:center"><div style="font-size:18px;font-weight:700;margin-bottom:8px">Upgrade to Premium</div><div style="font-size:13px;color:var(--text2);margin-bottom:20px">Unlock live signals & more</div><button class="btn" onclick="openPremium()">Get Premium ¬∑ $9.99/mo</button></div></div>
      <div style="padding:16px;margin-bottom:100px">
        <button class="btn" onclick="confirmSignOut()" style="width:100%;background:transparent;border:2px solid var(--red);color:var(--red)">Sign Out</button>
      </div>
    </div>
  </div>

  <nav class="nav"><div class="nav-inner">
    <button class="nav-btn active" data-tab="home" onclick="nav('home')"><svg viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span>Home</span></button>
    <button class="nav-btn" data-tab="calc" onclick="nav('calc')"><svg viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M8 6h8M8 10h8M8 14h4"/></svg><span>Calc</span></button>
    <button class="nav-btn" data-tab="watch" onclick="nav('watch')"><svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg><span>Watch</span></button>
    <button class="nav-btn" data-tab="signals" onclick="nav('signals')"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><span>Signals</span></button>
    <button class="nav-btn" data-tab="profile" onclick="goToProfile()"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><span>Profile</span></button>
  </div></nav>

  <div class="modal-bg" id="settingsModal" onclick="closeModal('settingsModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div><div class="modal-header"><span class="modal-title">Quick Settings</span><button class="modal-close" onclick="closeModal('settingsModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
    <div class="setting-row"><span>Dark Mode</span><button class="switch" id="qThemeSwitch" onclick="toggleTheme()"><div class="switch-knob"></div></button></div>
    <div class="setting-row"><span>Notifications</span><button class="switch" id="qNotifSwitch" onclick="toggleNotif()"><div class="switch-knob"></div></button></div>
    <div style="padding:12px 0;border-bottom:1px solid var(--border)">
      <div class="form-group" style="margin-bottom:8px"><label class="form-label">Email for Alerts</label><input type="email" class="form-input" id="userAlertEmail" placeholder="your@email.com"></div>
      <div class="setting-row" style="padding:8px 0"><span>Receive Email Alerts</span><button class="switch" id="emailAlertSwitch" onclick="toggleEmailAlerts()"><div class="switch-knob"></div></button></div>
      <button class="btn btn-outline" onclick="saveEmailSubscription()" style="width:100%">Save Email Preferences</button>
    </div>
    <div style="padding:16px 0;border-bottom:1px solid var(--border)"><div class="form-group" style="margin-bottom:12px"><label class="form-label">Alpaca API Key</label><input type="text" class="form-input" id="qApiKey" placeholder="PK..."></div><div class="form-group" style="margin-bottom:12px"><label class="form-label">Secret Key</label><input type="password" class="form-input" id="qSecretKey" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div><button class="btn btn-outline" onclick="quickSaveApi()">Save API Keys</button></div>
    <button class="btn btn-red mt-4" onclick="confirmSignOut()"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Sign Out</button>
  </div></div>

  <div class="modal-bg" id="addModal" onclick="closeModal('addModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div><div class="modal-header"><span class="modal-title">Add Position</span><button class="modal-close" onclick="closeModal('addModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div class="toggle"><button class="toggle-btn active" id="addCspBtn" onclick="setAddMode('csp')">CSP</button><button class="toggle-btn" id="addCcBtn" onclick="setAddMode('cc')">CC</button><button class="toggle-btn" id="addSharesBtn" onclick="setAddMode('shares')">Shares</button></div><div class="form-group"><label class="form-label">Symbol</label><input type="text" class="form-input" id="addSymbol" placeholder="AAPL" style="text-transform:uppercase" maxlength="5"></div><div id="optFields"><div class="form-group"><label class="form-label">Strike</label><input type="number" class="form-input" id="addStrike" placeholder="150" step="0.5"></div><div class="form-group"><label class="form-label">Expiration</label><input type="date" class="form-input" id="addExp"></div><div class="form-group"><label class="form-label">Premium</label><input type="number" class="form-input" id="addPremium" placeholder="2.50" step="0.01"></div></div><div id="shareFields" class="hidden"><div class="form-group"><label class="form-label">Cost Basis</label><input type="number" class="form-input" id="addCost" placeholder="150" step="0.01"></div></div><div class="form-group"><label class="form-label">Contracts</label><input type="number" class="form-input" id="addContracts" value="1" min="1"></div><button class="btn" onclick="savePosition()">Add Position</button></div></div>

  <div class="modal-bg" id="learnModal" onclick="closeModal('learnModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div><div class="modal-header"><span class="modal-title">Learn</span><button class="modal-close" onclick="closeModal('learnModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div id="learnContent"></div></div></div>

  <div class="modal-bg" id="analyticsModal" onclick="closeModal('analyticsModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div><div class="modal-header"><span class="modal-title">Analytics</span><button class="modal-close" onclick="closeModal('analyticsModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div style="background:var(--input);border-radius:16px;padding:20px;text-align:center;margin-bottom:16px"><div style="font-size:13px;color:var(--text2)">Total Premium</div><div style="font-size:32px;font-weight:700;color:var(--green)">$<span id="aPrem">0</span></div></div><div class="stats-grid"><div class="stat-box"><div class="stat-val" id="aWin">0%</div><div class="stat-label">Win Rate</div></div><div class="stat-box"><div class="stat-val" id="aTrades">0</div><div class="stat-label">Trades</div></div></div></div></div>

  <div class="modal-bg" id="aiModal" onclick="closeModal('aiModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div>
    <div class="ai-header">
      <div class="wheely-avatar"><div class="wheely-antenna"></div><div class="wheely-face"><div class="wheely-eye"></div><div class="wheely-eye"></div></div></div>
      <div class="ai-info"><h3>Wheely</h3><p>Your wheel strategy assistant</p></div>
    </div>
    <div class="ai-messages" id="aiMessages"></div>
    <div class="search-row"><input type="text" class="form-input" id="aiInput" placeholder="Ask Wheely..." style="flex:1" onkeydown="if(event.key==='Enter')sendAI()"><button class="search-btn" onclick="sendAI()" style="width:48px;height:48px"><svg viewBox="0 0 24 24"><path d="m22 2-7 20-4-9-9-4Z"/></svg></button></div>
  </div></div>

  <div class="modal-bg" id="posModal" onclick="closeModal('posModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div><div class="modal-header"><span class="modal-title" id="posTitle">Position</span><button class="modal-close" onclick="closeModal('posModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div id="posContent"></div><div style="display:flex;gap:12px;margin-top:20px"><button class="btn btn-red" style="flex:1" onclick="closePosition()">Close</button><button class="btn" style="flex:1" onclick="closeModal('posModal')">Done</button></div></div></div>

  <div class="modal-bg" id="premiumModal" onclick="closeModal('premiumModal')"><div class="modal" onclick="event.stopPropagation()"><div class="modal-handle"></div>
    <div style="text-align:center;padding:20px 0"><div style="font-size:28px;font-weight:700">Premium</div><div style="font-size:14px;color:var(--text2);margin-top:8px">Unlock the full experience</div></div>
    <div style="margin:24px 0">
      <div style="display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--border)"><span style="color:var(--green)">‚úì</span><span>Live trading signals</span></div>
      <div style="display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--border)"><span style="color:var(--green)">‚úì</span><span>Priority alerts</span></div>
      <div style="display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--border)"><span style="color:var(--green)">‚úì</span><span>Advanced analytics</span></div>
      <div style="display:flex;align-items:center;gap:12px;padding:14px 0"><span style="color:var(--green)">‚úì</span><span>Direct support</span></div>
    </div>
    <button class="btn" onclick="showToast('Coming soon!','')">Subscribe ¬∑ $9.99/month</button>
    <p style="font-size:12px;color:var(--text3);text-align:center;margin-top:16px">7-day free trial ¬∑ Cancel anytime</p>
  </div></div>

  <div class="modal-bg" id="adminModal" onclick="closeModal('adminModal')"><div class="modal" onclick="event.stopPropagation()" style="max-height:90vh">
    <div class="modal-handle"></div>
    <div class="modal-header"><span class="modal-title">Admin Panel</span><button class="modal-close" onclick="closeModal('adminModal')"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>

    <div class="toggle" style="margin-bottom:20px">
      <button class="toggle-btn active" id="adminSignalBtn" onclick="setAdminTab('signal')">Signal</button>
      <button class="toggle-btn" id="adminAnnBtn" onclick="setAdminTab('announcement')">Announce</button>
      <button class="toggle-btn" id="adminRollBtn" onclick="setAdminTab('roll')">Roll</button>
    </div>

    <div id="adminSignalForm">
      <div class="form-group"><label class="form-label">Type</label>
        <div class="toggle"><button class="toggle-btn active" id="sigCspBtn" onclick="S.adminSigType='csp';this.classList.add('active');$('sigCcBtn').classList.remove('active')">CSP</button><button class="toggle-btn" id="sigCcBtn" onclick="S.adminSigType='cc';this.classList.add('active');$('sigCspBtn').classList.remove('active')">CC</button></div>
      </div>
      <div class="form-group"><label class="form-label">Ticker</label><input type="text" class="form-input" id="adminTicker" placeholder="NVDA" style="text-transform:uppercase"></div>
      <div class="form-group"><label class="form-label">Strike</label><input type="number" class="form-input" id="adminStrike" placeholder="130"></div>
      <div class="form-group"><label class="form-label">Expiration</label><input type="text" class="form-input" id="adminExp" placeholder="Feb 7"></div>
      <div class="form-group"><label class="form-label">Premium</label><input type="text" class="form-input" id="adminPrem" placeholder="$3.20"></div>
      <div class="form-group"><label class="form-label">Delta</label><input type="text" class="form-input" id="adminDelta" placeholder="0.25"></div>
      <button class="btn" onclick="postSignal()">Post Signal</button>
    </div>

    <div id="adminAnnForm" class="hidden">
      <div class="form-group"><label class="form-label">Title</label><input type="text" class="form-input" id="annTitle" placeholder="Market Update"></div>
      <div class="form-group"><label class="form-label">Message</label><textarea class="form-input" id="annMsg" placeholder="Your announcement..." rows="4" style="resize:none"></textarea></div>
      <button class="btn" onclick="postAnnouncement()">Post Announcement</button>
    </div>

    <div id="adminRollForm" class="hidden">
      <div class="form-group"><label class="form-label">Select Open Position</label>
        <select class="position-select" id="rollPositionSelect" onchange="fillRollFromPosition()">
          <option value="">-- Select a position to roll --</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Original Position</label><input type="text" class="form-input" id="rollOrig" placeholder="NVDA $130P Feb 7"></div>
      <div class="form-group"><label class="form-label">New Position</label><input type="text" class="form-input" id="rollNew" placeholder="NVDA $125P Feb 14"></div>
      <div class="form-group"><label class="form-label">Credit/Debit</label><input type="text" class="form-input" id="rollCredit" placeholder="+$0.50 credit"></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="rollNotes" placeholder="Rolling for credit..." rows="2" style="resize:none"></textarea></div>
      <button class="btn" onclick="postRoll()">Post Roll Update</button>
    </div>

    <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
      <div class="card-title">Manage Positions</div>
      <p style="font-size:11px;color:var(--text3);margin-bottom:12px">Mark as winner üéâ or rolled to update status</p>
      <div id="adminPostsList" style="max-height:300px;overflow-y:auto"></div>
    </div>

    <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
      <div class="card-title">Notification Settings</div>
      <div class="form-group" style="margin-top:12px"><label class="form-label">Discord Webhook URL</label><input type="text" class="form-input" id="discordWebhook" placeholder="https://discord.com/api/webhooks/..."></div>
      <p style="font-size:11px;color:var(--text3);margin-top:4px">Posts sent to your Discord server</p>

      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
        <div class="form-label" style="font-weight:600;margin-bottom:8px">üìß EmailJS (Free Email Alerts)</div>
        <div class="form-group"><label class="form-label">Public Key</label><input type="text" class="form-input" id="emailjsPublicKey" placeholder="Your EmailJS public key"></div>
        <div class="form-group"><label class="form-label">Service ID</label><input type="text" class="form-input" id="emailjsServiceId" placeholder="service_xxxxxxx"></div>
        <div class="form-group"><label class="form-label">Template ID</label><input type="text" class="form-input" id="emailjsTemplateId" placeholder="template_xxxxxxx"></div>
        <p style="font-size:11px;color:var(--text3);margin-top:4px">Free at <a href="https://emailjs.com" target="_blank" style="color:var(--blue)">emailjs.com</a> - 200 emails/month</p>
      </div>

      <button class="btn btn-outline" onclick="saveAdminSettings()" style="margin-top:12px">Save Settings</button>
    </div>
  </div></div>

  <div class="modal-bg center" id="promptModal" onclick="closePrompt()"><div class="modal" onclick="event.stopPropagation()" style="max-width:360px">
    <div class="modal-header"><span class="modal-title" id="promptTitle">Enter Value</span><button class="modal-close" onclick="closePrompt()"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
    <div class="form-group"><input type="text" class="form-input" id="promptInput" placeholder="" style="font-size:18px;text-transform:uppercase"></div>
    <div style="display:flex;gap:12px"><button class="btn" onclick="submitPrompt()" style="flex:1">OK</button><button class="btn btn-outline" onclick="closePrompt()" style="flex:1">Cancel</button></div>
  </div></div>

  <div class="toast" id="toast"></div>

<script>
const S={theme:'light',mode:'csp',addMode:'csp',apiKey:'',secretKey:'',accSize:25000,positions:[],history:[],selPosId:null,user:{name:'',email:''},isPremium:false,legalOk:false,notifOn:false,watchlist:['AAPL','NVDA','TSLA','SPY','AMD','MSFT']};
const names={AAPL:'Apple Inc.',NVDA:'NVIDIA',TSLA:'Tesla',MSFT:'Microsoft',AMD:'AMD',SPY:'S&P 500 ETF',QQQ:'Nasdaq 100 ETF',AMZN:'Amazon',GOOGL:'Alphabet',META:'Meta Platforms',RKLB:'Rocket Lab',PLTR:'Palantir',SOFI:'SoFi',COIN:'Coinbase',HOOD:'Robinhood',NET:'Cloudflare',SNOW:'Snowflake',CRWD:'CrowdStrike',DDOG:'Datadog',ZS:'Zscaler'};
const domains={AAPL:'apple.com',NVDA:'nvidia.com',TSLA:'tesla.com',MSFT:'microsoft.com',AMD:'amd.com',SPY:'ssga.com',QQQ:'invesco.com',AMZN:'amazon.com',GOOGL:'google.com',META:'meta.com',RKLB:'rocketlabusa.com',PLTR:'palantir.com',SOFI:'sofi.com',COIN:'coinbase.com',HOOD:'robinhood.com',NET:'cloudflare.com',SNOW:'snowflake.com',CRWD:'crowdstrike.com',DDOG:'datadoghq.com',ZS:'zscaler.com'};
const signals=[{type:'csp',ticker:'NVDA',strike:130,exp:'Jan 24',prem:'$3.20',delta:'0.25',time:'2h ago'},{type:'cc',ticker:'AAPL',strike:260,exp:'Jan 31',prem:'$2.80',delta:'0.30',time:'5h ago'},{type:'csp',ticker:'AMD',strike:135,exp:'Feb 7',prem:'$4.50',delta:'0.28',time:'1d ago'}];

// ========== AUTHENTICATION ==========
function showAuthTab(tab) {
  $('authLogin').classList.toggle('hidden', tab !== 'login');
  $('authSignup').classList.toggle('hidden', tab !== 'signup');
}

function togglePasswordVisibility(inputId, btn) {
  const input = $(inputId);
  if (input.type === 'password') {
    input.type = 'text';
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';
  } else {
    input.type = 'password';
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
  }
}

function checkPasswordStrength() {
  const pass = $('signupPassword').value;
  const checks = {
    passLength: pass.length >= 8,
    passLower: /[a-z]/.test(pass),
    passUpper: /[A-Z]/.test(pass),
    passNumber: /[0-9]/.test(pass),
    passSpecial: /[!@#$%^&*(),.?":{}|<>]/.test(pass)
  };

  Object.entries(checks).forEach(([id, valid]) => {
    $(id).classList.toggle('valid', valid);
  });

  // Enable signup button if all checks pass
  const allValid = Object.values(checks).every(v => v);
  $('signupBtn').disabled = !allValid;
}

function submitPremiumInterest() {
  const email = $('premiumEmail').value.trim();
  if (!email || !email.includes('@')) {
    showToast('Please enter a valid email', 'error');
    return;
  }

  // Save to Firebase
  initFirebase().then(ok => {
    if (ok) {
      const emailKey = email.replace(/[.#$[\]]/g, '_');
      firebase.database().ref('premiumInterest/' + emailKey).set({
        email: email,
        timestamp: Date.now(),
        source: 'alerts_popup'
      });
    }
  });

  // Also save email to user's alert subscription
  S.alertEmail = email;
  S.alertsPopupDismissed = true;
  save();

  closeModal('premiumPopup');
  showToast('You\'re on the list! We\'ll notify you of new signals.', 'success');

  // Now go to profile
  nav('profile');
}

// Show alerts popup (only once, on first profile click)
function showAlertsPopupOnce() {
  // Check if already dismissed
  if (S.alertsPopupDismissed) return false;

  // Pre-fill email if user is logged in
  if (S.user.email) $('premiumEmail').value = S.user.email;
  openModal('premiumPopup');
  return true;
}

// Called when "Not now" is clicked on alerts popup
function dismissAlertsPopup() {
  S.alertsPopupDismissed = true;
  save();
  closeModal('premiumPopup');
  // Now go to profile
  nav('profile');
}

// Called when user clicks avatar/profile button
function goToProfile() {
  // If guest, prompt to create account
  if (S.isGuest) {
    promptCreateAccount();
    return;
  }

  // Show alerts popup once if not dismissed and not premium
  if (!S.isPremium && !S.alertsPopupDismissed) {
    showAlertsPopupOnce();
    return;
  }
  nav('profile');
}

// Prompt guest to create an account
function promptCreateAccount() {
  // Clear guest state and show signup
  S.isGuest = false;
  save();
  showAuthScreen();
  showAuthTab('signup');
  showToast('Create an account to save your progress!', '');
}

async function handleLogin() {
  const email = $('loginEmail').value.trim();
  const pass = $('loginPassword').value;
  const rememberMe = $('rememberMe')?.checked;

  if (!email || !pass) return showToast('Please fill all fields', 'error');

  try {
    if (!await initFirebase()) throw new Error('Firebase init failed');

    // Set persistence based on "Remember me" checkbox
    const persistence = rememberMe
      ? firebase.auth.Auth.Persistence.LOCAL      // Persists even after browser close
      : firebase.auth.Auth.Persistence.SESSION;   // Cleared when tab closes
    await firebase.auth().setPersistence(persistence);

    const cred = await firebase.auth().signInWithEmailAndPassword(email, pass);
    await loadUserData(cred.user.uid);
    completeAuth(cred.user);
  } catch (e) {
    console.error('Login error:', e);
    showToast(e.message || 'Login failed', 'error');
  }
}

async function handleSignup() {
  const name = $('signupName').value.trim();
  const email = $('signupEmail').value.trim();
  const pass = $('signupPassword').value;

  if (!name || !email || !pass) return showToast('Please fill all fields', 'error');

  // Validate password strength
  const hasLength = pass.length >= 8;
  const hasLower = /[a-z]/.test(pass);
  const hasUpper = /[A-Z]/.test(pass);
  const hasNumber = /[0-9]/.test(pass);
  const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(pass);

  if (!hasLength || !hasLower || !hasUpper || !hasNumber || !hasSpecial) {
    return showToast('Password doesn\'t meet requirements', 'error');
  }

  try {
    if (!await initFirebase()) throw new Error('Firebase init failed');
    const cred = await firebase.auth().createUserWithEmailAndPassword(email, pass);

    // Save user profile to Firebase
    await firebase.database().ref('users/' + cred.user.uid).set({
      name: name,
      email: email,
      isPremium: false,
      createdAt: Date.now()
    });

    S.user.name = name;
    S.user.email = email;
    S.isPremium = false;
    save();

    completeAuth(cred.user);
    showToast('Welcome to Market Elites!', 'success');
  } catch (e) {
    console.error('Signup error:', e);
    showToast(e.message || 'Signup failed', 'error');
  }
}

function handleGuestLogin() {
  S.isGuest = true;
  S.user.name = 'Guest';
  save();
  hideAuthScreen();
  checkLegal();
  renderHome(); // Fix: render home after guest login
  showToast('Browsing as guest - Sign up to save your data!', '');
}

async function handleGoogleSignIn() {
  try {
    if (!await initFirebase()) throw new Error('Firebase init failed');

    const provider = new firebase.auth.GoogleAuthProvider();
    const result = await firebase.auth().signInWithPopup(provider);
    const user = result.user;

    // Check if user exists in database, if not create profile
    const userRef = firebase.database().ref('users/' + user.uid);
    const snapshot = await userRef.once('value');

    if (!snapshot.exists()) {
      // New user - create profile
      await userRef.set({
        name: user.displayName || 'User',
        email: user.email,
        isPremium: false,
        createdAt: Date.now(),
        provider: 'google'
      });
    }

    // Load user data
    const userData = snapshot.val() || {};
    S.user.name = user.displayName || userData.name || 'User';
    S.user.email = user.email;
    S.isPremium = userData.isPremium || false;
    save();

    completeAuth(user);
    showToast('Welcome, ' + S.user.name + '!', 'success');
  } catch (e) {
    console.error('Google sign-in error:', e);
    if (e.code === 'auth/popup-closed-by-user') {
      // User closed popup, don't show error
      return;
    }
    showToast(e.message || 'Google sign-in failed', 'error');
  }
}

function completeAuth(user) {
  S.firebaseUid = user.uid;
  // Save remember me preference
  if ($('rememberMe')?.checked) {
    localStorage.setItem('meRemember', 'true');
  }
  save();
  hideAuthScreen();
  checkLegal();
  renderHome(); // Fix: render home after login
}

async function loadUserData(uid) {
  try {
    const snapshot = await firebase.database().ref('users/' + uid).once('value');
    const data = snapshot.val();
    if (data) {
      S.user.name = data.name || '';
      S.user.email = data.email || '';
      S.isPremium = data.isPremium || false;
      save();
    }
  } catch (e) {
    console.error('Load user data error:', e);
  }
}

function checkAuthState() {
  // Check if user is logged in locally (guest or has firebase uid)
  if (S.firebaseUid || S.isGuest) {
    hideAuthScreen();
    return true;
  }

  // Check if "Remember me" was selected - try to restore Firebase session
  const remembered = localStorage.getItem('meRemember');
  if (remembered) {
    // Firebase will auto-restore session, set up listener
    initFirebase().then(ok => {
      if (ok && firebase.auth) {
        firebase.auth().onAuthStateChanged(user => {
          if (user) {
            S.firebaseUid = user.uid;
            loadUserData(user.uid);
            save();
            hideAuthScreen();
            checkLegal();
            renderHome();
          }
        });
      }
    });
  }

  showAuthScreen();
  return false;
}

function showAuthScreen() {
  $('authScreen').style.display = 'flex';
  document.querySelector('.app').style.display = 'none';
  document.querySelector('.nav').style.display = 'none';
}

function hideAuthScreen() {
  $('authScreen').style.display = 'none';
  document.querySelector('.app').style.display = 'block';
  document.querySelector('.nav').style.display = '';  // Restore CSS default
}

function showForgotPassword() {
  showPrompt('Reset Password', 'Enter your email address', async (email) => {
    if (!email) return;
    try {
      if (!await initFirebase()) throw new Error('Firebase init failed');
      await firebase.auth().sendPasswordResetEmail(email);
      showToast('Password reset email sent!', 'success');
    } catch (e) {
      showToast(e.message || 'Reset failed', 'error');
    }
  });
}

// Live pricing cache
const priceCache = {};
const optionsCache = {};

// Fetch live stock quote from Yahoo Finance (no API key needed!)
async function fetchLiveQuote(symbol) {
  const cacheKey = symbol.toUpperCase();
  const cached = priceCache[cacheKey];
  if (cached && Date.now() - cached.time < 30000) return cached.data; // 30s cache

  try {
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`;
    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
    const r = await fetch(proxyUrl);
    if (!r.ok) throw new Error('Quote fetch failed');
    const data = await r.json();
    const result = data.chart?.result?.[0];
    if (!result) throw new Error('No data');
    const meta = result.meta;
    const price = meta.regularMarketPrice || 0;
    const prevClose = meta.previousClose || meta.chartPreviousClose || price;
    const change = price - prevClose;
    const changePercent = prevClose > 0 ? ((change / prevClose) * 100).toFixed(2) : '0.00';
    const quote = {
      symbol: meta.symbol,
      price: price,
      prevClose: prevClose,
      change: change,
      changePercent: changePercent,
      high: meta.regularMarketDayHigh,
      low: meta.regularMarketDayLow,
      volume: meta.regularMarketVolume
    };
    priceCache[cacheKey] = { data: quote, time: Date.now() };
    return quote;
  } catch (e) {
    console.error('Quote error:', e);
    return null;
  }
}

// Fetch options chain from Yahoo Finance
async function fetchOptionsChain(symbol, expDate = null) {
  const cacheKey = `${symbol.toUpperCase()}_${expDate || 'default'}`;
  const cached = optionsCache[cacheKey];
  if (cached && Date.now() - cached.time < 60000) return cached.data; // 1min cache

  try {
    let url = `https://query1.finance.yahoo.com/v7/finance/options/${symbol}`;
    if (expDate) url += `?date=${expDate}`;
    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
    const r = await fetch(proxyUrl);
    if (!r.ok) throw new Error('Options fetch failed');
    const data = await r.json();
    const result = data.optionChain?.result?.[0];
    if (!result) throw new Error('No options data');

    const chain = {
      symbol: result.quote?.symbol,
      price: result.quote?.regularMarketPrice,
      expirations: result.expirationDates || [],
      strikes: result.strikes || [],
      calls: result.options?.[0]?.calls || [],
      puts: result.options?.[0]?.puts || []
    };
    optionsCache[cacheKey] = { data: chain, time: Date.now() };
    return chain;
  } catch (e) {
    console.error('Options error:', e);
    return null;
  }
}

// Format expiration date from Unix timestamp
function formatExpDate(ts) {
  const d = new Date(ts * 1000);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
}

// Calculate days to expiration
function calcDTE(ts) {
  return Math.ceil((ts * 1000 - Date.now()) / 86400000);
}
const $=id=>document.getElementById(id);
const show=el=>$(el)?.classList.remove('hidden');
const hide=el=>$(el)?.classList.add('hidden');

// Generate consistent color from ticker symbol
const tickerColors = ['#6366f1','#8b5cf6','#ec4899','#f43f5e','#f97316','#eab308','#22c55e','#14b8a6','#06b6d4','#3b82f6'];
function getTickerColor(sym) {
  let hash = 0;
  for (let i = 0; i < sym.length; i++) hash = sym.charCodeAt(i) + ((hash << 5) - hash);
  return tickerColors[Math.abs(hash) % tickerColors.length];
}

// Custom toast notification
function showToast(msg, type='') {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast' + (type ? ' ' + type : '');
  setTimeout(() => t.classList.add('show'), 10);
  setTimeout(() => t.classList.remove('show'), 3000);
}

// Custom prompt modal
let promptCallback = null;
function showPrompt(title, placeholder, callback) {
  $('promptTitle').textContent = title;
  $('promptInput').placeholder = placeholder || '';
  $('promptInput').value = '';
  promptCallback = callback;
  openModal('promptModal');
  setTimeout(() => $('promptInput').focus(), 100);
}
function submitPrompt() {
  const val = $('promptInput').value.trim();
  closeModal('promptModal');
  if (promptCallback && val) promptCallback(val);
  promptCallback = null;
}
function closePrompt() {
  closeModal('promptModal');
  promptCallback = null;
}
$('promptInput')?.addEventListener('keydown', e => { if (e.key === 'Enter') submitPrompt(); });

// Admin Panel Functions
const ADMIN_PASS_HASH = '5e884898da28047d9169e1e3c5e5f4c3e8c3e8c3'; // Change this - hash of your password
const ADMIN_PASS = 'elitesbeau777'; // Admin password

// Secret admin access - tap copyright 5 times quickly
let adminTapCount = 0;
let adminTapTimer = null;
function secretAdminTap() {
  adminTapCount++;
  clearTimeout(adminTapTimer);
  if (adminTapCount >= 5) {
    adminTapCount = 0;
    promptAdminPassword();
  } else {
    adminTapTimer = setTimeout(() => { adminTapCount = 0; }, 2000);
  }
}

function initAdminAccess() {
  document.addEventListener('keydown', e => {
    if (e.ctrlKey && e.shiftKey && e.key === 'A') { e.preventDefault(); promptAdminPassword(); }
  });
}

function promptAdminPassword() {
  showPrompt('Admin Access', 'Enter password', (pass) => {
    if (pass === ADMIN_PASS) {
      S.adminAuthenticated = true;
      openAdmin();
    } else {
      showToast('Invalid password', 'error');
    }
  });
}

function openAdmin() {
  if (!S.adminAuthenticated) return promptAdminPassword();
  S.adminSigType = 'csp';
  renderAdminPosts();
  loadPostsFromFirebase();
  loadAdminSettings();
  openModal('adminModal');
}

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyANXf3yA7qRE-BuT-PrPW--4eKre-9YqiI",
  authDomain: "market-elites.firebaseapp.com",
  databaseURL: "https://market-elites-default-rtdb.firebaseio.com",
  projectId: "market-elites",
  storageBucket: "market-elites.firebasestorage.app",
  messagingSenderId: "347581977529",
  appId: "1:347581977529:web:7cb9c741577eec19ff1c68"
};

let firebaseReady = false;

// Initialize Firebase (lazy load)
async function initFirebase() {
  if (firebaseReady) return true;
  if (firebaseConfig.apiKey === "YOUR_API_KEY") {
    console.log('Firebase not configured - using localStorage only');
    return false;
  }
  try {
    if (!window.firebase) {
      // Load Firebase SDK - app, auth, and database
      await loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js');
    }
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    firebaseReady = true;
    return true;
  } catch (e) {
    console.error('Firebase init error:', e);
    return false;
  }
}

function loadScript(src) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = src;
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

// Save post to Firebase
async function savePostToFirebase(post) {
  if (!await initFirebase()) {
    // Fallback to localStorage only
    if (!S.adminPosts) S.adminPosts = [];
    S.adminPosts.unshift(post);
    save();
    return;
  }
  try {
    const db = firebase.database();
    await db.ref('posts').push(post);
    showToast('Posted to all users!', 'success');
  } catch (e) {
    console.error('Firebase save error:', e);
    showToast('Saved locally only', '');
  }
  // Send Discord notification
  await sendDiscordNotification(post);
  // Send email notifications
  await sendEmailNotifications(post);
}

// Send notification to Discord webhook
async function sendDiscordNotification(post) {
  const webhookUrl = localStorage.getItem('discordWebhook');
  if (!webhookUrl) return;

  let embed = { color: 0x00ff00, timestamp: new Date().toISOString() };

  if (post.kind === 'signal') {
    embed.title = `üö® New ${post.type.toUpperCase()} Signal`;
    embed.description = `**${post.ticker}** $${post.strike} ${post.type === 'csp' ? 'Put' : 'Call'}`;
    embed.fields = [
      { name: 'Expiration', value: post.exp, inline: true },
      { name: 'Premium', value: post.prem, inline: true },
      { name: 'Delta', value: post.delta, inline: true }
    ];
    embed.color = post.type === 'csp' ? 0x34c759 : 0x007aff;
  } else if (post.kind === 'announcement') {
    embed.title = `üì¢ ${post.title}`;
    embed.description = post.message;
    embed.color = 0xff9500;
  } else if (post.kind === 'roll') {
    embed.title = `üîÑ Position Roll`;
    embed.description = `${post.original} ‚Üí ${post.newPos}`;
    embed.fields = [{ name: 'Credit/Debit', value: post.credit, inline: true }];
    if (post.notes) embed.fields.push({ name: 'Notes', value: post.notes, inline: false });
    embed.color = 0xaf52de;
  }

  try {
    await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ embeds: [embed] })
    });
  } catch (e) {
    console.error('Discord webhook error:', e);
  }
}

// Save admin settings
function saveAdminSettings() {
  const webhook = $('discordWebhook')?.value.trim();
  if (webhook) localStorage.setItem('discordWebhook', webhook);

  // Save EmailJS settings
  const publicKey = $('emailjsPublicKey')?.value.trim();
  const serviceId = $('emailjsServiceId')?.value.trim();
  const templateId = $('emailjsTemplateId')?.value.trim();
  if (publicKey) localStorage.setItem('emailjsPublicKey', publicKey);
  if (serviceId) localStorage.setItem('emailjsServiceId', serviceId);
  if (templateId) localStorage.setItem('emailjsTemplateId', templateId);

  // Initialize EmailJS if configured
  if (publicKey && typeof emailjs !== 'undefined') {
    emailjs.init(publicKey);
  }

  showToast('Settings saved!', 'success');
}

// Load admin settings
function loadAdminSettings() {
  const webhook = localStorage.getItem('discordWebhook');
  if (webhook && $('discordWebhook')) $('discordWebhook').value = webhook;

  // Load EmailJS settings
  const publicKey = localStorage.getItem('emailjsPublicKey');
  const serviceId = localStorage.getItem('emailjsServiceId');
  const templateId = localStorage.getItem('emailjsTemplateId');
  if (publicKey && $('emailjsPublicKey')) $('emailjsPublicKey').value = publicKey;
  if (serviceId && $('emailjsServiceId')) $('emailjsServiceId').value = serviceId;
  if (templateId && $('emailjsTemplateId')) $('emailjsTemplateId').value = templateId;

  // Initialize EmailJS if configured
  if (publicKey && typeof emailjs !== 'undefined') {
    emailjs.init(publicKey);
  }
}

// Send email notifications to subscribed users
async function sendEmailNotifications(post) {
  const publicKey = localStorage.getItem('emailjsPublicKey');
  const serviceId = localStorage.getItem('emailjsServiceId');
  const templateId = localStorage.getItem('emailjsTemplateId');

  if (!publicKey || !serviceId || !templateId) return;

  // Get subscribed emails from Firebase
  if (!await initFirebase()) return;

  try {
    const db = firebase.database();
    const snapshot = await db.ref('emailSubscribers').once('value');
    const subscribers = snapshot.val() || {};

    // Build email content based on post type
    let subject = '', body = '';
    if (post.kind === 'winner') {
      subject = `üéâ WINNER! ${post.ticker} Closed for Profit!`;
      body = `Congratulations! Another winning trade!\n\n${post.type.toUpperCase()} ${post.ticker} $${post.strike} ${post.type === 'csp' ? 'Put' : 'Call'}\nExpiration: ${post.exp}\nPremium Collected: ${post.prem}\n\nThis position has been closed for profit! üéâ`;
    } else if (post.kind === 'signal') {
      subject = `üö® New ${post.type.toUpperCase()} Signal - ${post.ticker}`;
      body = `New ${post.type === 'csp' ? 'Cash Secured Put' : 'Covered Call'} Signal!\n\nTicker: ${post.ticker}\nStrike: $${post.strike}\nExpiration: ${post.exp}\nPremium: ${post.prem}\nDelta: ${post.delta}`;
    } else if (post.kind === 'announcement') {
      subject = `üì¢ ${post.title}`;
      body = post.message;
    } else if (post.kind === 'roll') {
      subject = `üîÑ Position Roll Alert`;
      body = `Rolling position:\n${post.original} ‚Üí ${post.newPos}\nCredit/Debit: ${post.credit}${post.notes ? '\nNotes: ' + post.notes : ''}`;
    } else if (post.kind === 'assigned') {
      subject = `üì¶ ${post.ticker} Assigned - Wheel Continues!`;
      body = `Your CSP on ${post.ticker} $${post.strike} was assigned!\n\nYou now own 100 shares at $${post.strike}.\nNext step: Sell covered calls to continue the wheel strategy.`;
    } else if (post.kind === 'called') {
      subject = `üì§ ${post.ticker} Called Away - Wheel Complete!`;
      body = `Your CC on ${post.ticker} $${post.strike} was exercised!\n\nShares sold at $${post.strike}.\nWheel cycle complete! Time to start selling CSPs again.`;
    }

    // Send to each subscriber
    for (const [key, sub] of Object.entries(subscribers)) {
      if (sub.active && sub.email) {
        try {
          await emailjs.send(serviceId, templateId, {
            to_email: sub.email,
            subject: subject,
            message: body,
            from_name: 'Market Elites'
          });
        } catch (e) {
          console.error('Email send error:', e);
        }
      }
    }
  } catch (e) {
    console.error('Email notification error:', e);
  }
}

// Toggle email alerts for user
function toggleEmailAlerts() {
  S.emailAlerts = !S.emailAlerts;
  const sw = $('emailAlertSwitch');
  if (sw) sw.classList.toggle('active', S.emailAlerts);
  save();
}

// Save email subscription to Firebase
async function saveEmailSubscription() {
  const email = $('userAlertEmail')?.value.trim();
  if (!email || !email.includes('@')) {
    showToast('Please enter a valid email', 'error');
    return;
  }

  if (!await initFirebase()) {
    // Save locally if Firebase not available
    S.alertEmail = email;
    save();
    showToast('Email saved locally', 'success');
    return;
  }

  try {
    const db = firebase.database();
    const emailKey = email.replace(/[.#$[\]]/g, '_'); // Firebase-safe key
    await db.ref('emailSubscribers/' + emailKey).set({
      email: email,
      active: S.emailAlerts !== false,
      subscribedAt: Date.now()
    });
    S.alertEmail = email;
    save();
    showToast('Email alerts enabled!', 'success');
  } catch (e) {
    console.error('Subscription error:', e);
    showToast('Failed to subscribe', 'error');
  }
}

// Load user email settings
function loadEmailSettings() {
  if (S.alertEmail && $('userAlertEmail')) $('userAlertEmail').value = S.alertEmail;
  const sw = $('emailAlertSwitch');
  if (sw) sw.classList.toggle('active', S.emailAlerts !== false);
}

// Load posts from Firebase
async function loadPostsFromFirebase() {
  if (!await initFirebase()) return;
  try {
    const db = firebase.database();
    const snapshot = await db.ref('posts').orderByChild('timestamp').limitToLast(50).once('value');
    const posts = [];
    snapshot.forEach(child => {
      posts.unshift({ id: child.key, ...child.val() });
    });
    S.adminPosts = posts;
    renderAdminPosts();
    renderSignals();
  } catch (e) {
    console.error('Firebase load error:', e);
  }
}

// Delete post from Firebase
async function deletePostFromFirebase(postId) {
  if (!await initFirebase()) return;
  try {
    const db = firebase.database();
    await db.ref('posts/' + postId).remove();
  } catch (e) {
    console.error('Firebase delete error:', e);
  }
}

// Listen for real-time updates (for all users)
// Track which winners we've celebrated to avoid duplicates
const celebratedWinners = new Set();

async function listenToFirebasePosts() {
  if (!await initFirebase()) return;
  try {
    const db = firebase.database();
    db.ref('posts').orderByChild('timestamp').limitToLast(50).on('value', snapshot => {
      const posts = [];
      snapshot.forEach(child => {
        posts.unshift({ id: child.key, ...child.val() });
      });

      // Check for new winners to celebrate
      posts.forEach(p => {
        if (p.status === 'winner' && p.id && !celebratedWinners.has(p.id)) {
          // Only celebrate if this is recent (within last 30 seconds)
          if (p.closedAt && Date.now() - p.closedAt < 30000) {
            celebratedWinners.add(p.id);
            if (!S.adminAuthenticated) { // Don't double-celebrate on admin side
              showCelebration(p);
            }
          } else {
            // Mark as already celebrated if it's old
            celebratedWinners.add(p.id);
          }
        }
      });

      S.adminPosts = posts;
      renderSignals();
      renderAlertsFeed(); // Update home alerts too
    });
  } catch (e) {
    console.error('Firebase listen error:', e);
  }
}

// Listen for winners (backup method)
async function listenForWinners() {
  if (!await initFirebase()) return;
  // Pre-populate celebrated winners to avoid showing old celebrations on load
  const posts = S.adminPosts || [];
  posts.forEach(p => {
    if (p.status === 'winner' && p.id) celebratedWinners.add(p.id);
  });
}

function setAdminTab(tab) {
  $('adminSignalBtn').classList.toggle('active', tab === 'signal');
  $('adminAnnBtn').classList.toggle('active', tab === 'announcement');
  $('adminRollBtn').classList.toggle('active', tab === 'roll');
  $('adminSignalForm').classList.toggle('hidden', tab !== 'signal');
  $('adminAnnForm').classList.toggle('hidden', tab !== 'announcement');
  $('adminRollForm').classList.toggle('hidden', tab !== 'roll');

  // Populate roll position selector when roll tab is opened
  if (tab === 'roll') populateRollSelector();
}

// Populate the roll position selector with open positions
function populateRollSelector() {
  const select = $('rollPositionSelect');
  if (!select) return;

  const posts = S.adminPosts || [];
  const openSignals = posts.filter(p => p.kind === 'signal' && (!p.status || p.status === 'open'));

  select.innerHTML = '<option value="">-- Select a position to roll --</option>' +
    openSignals.map((p, i) => {
      const posStr = `${p.ticker} $${p.strike}${p.type === 'csp' ? 'P' : 'C'} ${p.exp}`;
      return `<option value="${posts.indexOf(p)}">${p.type.toUpperCase()} - ${posStr}</option>`;
    }).join('');
}

// Fill roll form from selected position
function fillRollFromPosition() {
  const select = $('rollPositionSelect');
  if (!select || !select.value) return;

  const posts = S.adminPosts || [];
  const p = posts[parseInt(select.value)];
  if (!p) return;

  const posStr = `${p.ticker} $${p.strike}${p.type === 'csp' ? 'P' : 'C'} ${p.exp}`;
  $('rollOrig').value = posStr;
  $('rollNew').value = `${p.ticker} $`; // Pre-fill ticker for new position
  $('rollNew').focus();
}

async function postSignal() {
  const sig = {
    type: S.adminSigType || 'csp',
    ticker: $('adminTicker').value.toUpperCase().trim(),
    strike: parseFloat($('adminStrike').value) || 0,
    exp: $('adminExp').value.trim(),
    prem: $('adminPrem').value.trim(),
    delta: $('adminDelta').value.trim(),
    time: 'Just now',
    timestamp: Date.now(),
    kind: 'signal'
  };
  if (!sig.ticker || !sig.strike) return showToast('Fill ticker and strike', 'error');
  await savePostToFirebase(sig);
  $('adminTicker').value = '';
  $('adminStrike').value = '';
  $('adminExp').value = '';
  $('adminPrem').value = '';
  $('adminDelta').value = '';
  renderAdminPosts();
  renderSignals();
}

async function postAnnouncement() {
  const ann = {
    title: $('annTitle').value.trim(),
    message: $('annMsg').value.trim(),
    time: 'Just now',
    timestamp: Date.now(),
    kind: 'announcement'
  };
  if (!ann.title || !ann.message) return showToast('Fill title and message', 'error');
  await savePostToFirebase(ann);
  $('annTitle').value = '';
  $('annMsg').value = '';
  renderAdminPosts();
  renderSignals();
}

async function postRoll() {
  const selectedIdx = $('rollPositionSelect')?.value;
  const roll = {
    original: $('rollOrig').value.trim(),
    newPos: $('rollNew').value.trim(),
    credit: $('rollCredit').value.trim(),
    notes: $('rollNotes').value.trim(),
    time: 'Just now',
    timestamp: Date.now(),
    kind: 'roll'
  };
  if (!roll.original || !roll.newPos) return showToast('Fill original and new position', 'error');

  // Mark the original position as rolled if selected from dropdown
  if (selectedIdx && S.adminPosts[selectedIdx]) {
    await markPostRolled(parseInt(selectedIdx));
  }

  await savePostToFirebase(roll);
  $('rollOrig').value = '';
  $('rollNew').value = '';
  $('rollCredit').value = '';
  $('rollNotes').value = '';
  if ($('rollPositionSelect')) $('rollPositionSelect').value = '';
  renderAdminPosts();
  renderSignals();
}

async function deletePost(idx) {
  if (!S.adminPosts || !S.adminPosts[idx]) return;
  const post = S.adminPosts[idx];
  if (post.id) {
    await deletePostFromFirebase(post.id);
  }
  S.adminPosts.splice(idx, 1);
  save();
  renderAdminPosts();
  renderSignals();
  showToast('Post deleted', '');
}

function renderAdminPosts() {
  const c = $('adminPostsList');
  if (!c) return;
  const posts = S.adminPosts || [];
  if (!posts.length) {
    c.innerHTML = '<p style="color:var(--text3);font-size:13px;text-align:center;padding:16px">No posts yet</p>';
    return;
  }
  c.innerHTML = posts.slice(0, 15).map((p, i) => {
    let label = '', showActions = false, statusBadge = '';
    const status = p.status || 'open';

    if (p.kind === 'signal') {
      label = `<span style="color:var(--${p.type==='csp'?'green':'blue'})">${p.type.toUpperCase()}</span> ${p.ticker} $${p.strike}`;
      showActions = true;
      if (status === 'winner') statusBadge = '<span class="status-badge winner">WIN üéâ</span>';
      else if (status === 'rolled') statusBadge = '<span class="status-badge rolled">ROLLED</span>';
      else if (status === 'assigned') statusBadge = '<span class="status-badge assigned">ASSIGNED üì¶</span>';
      else if (status === 'called') statusBadge = '<span class="status-badge called">CALLED AWAY üì§</span>';
      else if (status === 'closed') statusBadge = '<span class="status-badge closed">CLOSED</span>';
      else statusBadge = '<span class="status-badge open">OPEN</span>';
    } else if (p.kind === 'announcement') {
      label = `<span style="color:var(--orange)">ANN</span> ${p.title}`;
    } else if (p.kind === 'roll') {
      label = `<span style="color:var(--purple)">ROLL</span> ${p.original?.split(' ')[0] || 'Position'}`;
    }

    // Different actions based on signal type and status
    let actions = '';
    if (showActions && status === 'open') {
      if (p.type === 'csp') {
        // CSP: can win, roll, or get assigned
        actions = `<div class="post-actions">
          <button class="post-action-btn winner" onclick="markPostWinner(${i})">üéâ Winner</button>
          <button class="post-action-btn assigned" onclick="markPostAssigned(${i})">üì¶ Assigned</button>
          <button class="post-action-btn roll" onclick="markPostRolled(${i})">üîÑ Roll</button>
          <button class="post-action-btn delete" onclick="deletePost(${i})">‚úï</button>
        </div>`;
      } else {
        // CC: can win, roll, or get called away
        actions = `<div class="post-actions">
          <button class="post-action-btn winner" onclick="markPostWinner(${i})">üéâ Winner</button>
          <button class="post-action-btn called" onclick="markPostCalled(${i})">üì§ Called</button>
          <button class="post-action-btn roll" onclick="markPostRolled(${i})">üîÑ Roll</button>
          <button class="post-action-btn delete" onclick="deletePost(${i})">‚úï</button>
        </div>`;
      }
    } else {
      actions = `<div class="post-actions"><button class="post-action-btn delete" onclick="deletePost(${i})">Delete</button></div>`;
    }

    return `<div style="padding:10px 0;border-bottom:1px solid var(--border)">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:13px">${label}${statusBadge}</span>
        <span style="font-size:11px;color:var(--text3)">${getTimeAgo(p.timestamp)}</span>
      </div>
      ${actions}
    </div>`;
  }).join('');
}

// Mark post as winner (with celebration!)
async function markPostWinner(index) {
  const posts = S.adminPosts || [];
  if (!posts[index]) return;

  posts[index].status = 'winner';
  posts[index].closedAt = Date.now();

  // Save to Firebase
  if (await initFirebase() && posts[index].id) {
    try {
      await firebase.database().ref('posts/' + posts[index].id).update({ status: 'winner', closedAt: Date.now() });
    } catch (e) { console.error('Firebase update error:', e); }
  }

  save();
  renderAdminPosts();
  renderSignals();

  // Trigger celebration!
  showCelebration(posts[index]);

  // Send winner notification
  await sendWinnerNotification(posts[index]);
}

// Mark post as rolled
async function markPostRolled(index) {
  const posts = S.adminPosts || [];
  if (!posts[index]) return;

  posts[index].status = 'rolled';
  posts[index].closedAt = Date.now();

  // Save to Firebase
  if (await initFirebase() && posts[index].id) {
    try {
      await firebase.database().ref('posts/' + posts[index].id).update({ status: 'rolled', closedAt: Date.now() });
    } catch (e) { console.error('Firebase update error:', e); }
  }

  save();
  renderAdminPosts();
  renderSignals();
  showToast('Position marked as rolled', 'success');
}

// Mark CSP as assigned (now holding shares, start selling CCs)
async function markPostAssigned(index) {
  const posts = S.adminPosts || [];
  if (!posts[index]) return;

  posts[index].status = 'assigned';
  posts[index].assignedAt = Date.now();

  // Save to Firebase
  if (await initFirebase() && posts[index].id) {
    try {
      await firebase.database().ref('posts/' + posts[index].id).update({ status: 'assigned', assignedAt: Date.now() });
    } catch (e) { console.error('Firebase update error:', e); }
  }

  save();
  renderAdminPosts();
  renderSignals();

  // Send notification about assignment
  await sendAssignmentNotification(posts[index], 'assigned');
  showToast(`${posts[index].ticker} assigned! Time to sell covered calls üì¶`, 'success');
}

// Mark CC as called away (shares sold, back to selling CSPs)
async function markPostCalled(index) {
  const posts = S.adminPosts || [];
  if (!posts[index]) return;

  posts[index].status = 'called';
  posts[index].calledAt = Date.now();

  // Save to Firebase
  if (await initFirebase() && posts[index].id) {
    try {
      await firebase.database().ref('posts/' + posts[index].id).update({ status: 'called', calledAt: Date.now() });
    } catch (e) { console.error('Firebase update error:', e); }
  }

  save();
  renderAdminPosts();
  renderSignals();

  // Send notification about call
  await sendAssignmentNotification(posts[index], 'called');
  showToast(`${posts[index].ticker} called away! Back to selling puts üì§`, 'success');
}

// Send notification for assigned/called
async function sendAssignmentNotification(post, type) {
  const webhookUrl = localStorage.getItem('discordWebhook');
  if (webhookUrl) {
    const isAssigned = type === 'assigned';
    try {
      await fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          embeds: [{
            title: isAssigned ? `üì¶ ${post.ticker} Assigned!` : `üì§ ${post.ticker} Called Away!`,
            description: isAssigned
              ? `CSP $${post.strike} was assigned. Now holding 100 shares - time to sell covered calls!`
              : `CC $${post.strike} was exercised. Shares sold at strike - back to selling puts!`,
            color: isAssigned ? 0xff9500 : 0x007aff,
            timestamp: new Date().toISOString()
          }]
        })
      });
    } catch (e) { console.error('Discord error:', e); }
  }

  // Email notification
  await sendEmailNotifications({
    ...post,
    kind: type,
    message: type === 'assigned'
      ? `CSP assigned - now holding shares, will sell covered calls`
      : `CC exercised - shares called away, back to selling puts`
  });
}

// Show celebration animation
function showCelebration(post) {
  // Create overlay with text
  const overlay = document.createElement('div');
  overlay.className = 'celebration-overlay';
  overlay.innerHTML = `<div class="celebration-text">üéâ WINNER! üéâ</div>`;
  document.body.appendChild(overlay);

  // Create confetti
  const colors = ['#34c759', '#007aff', '#ff9500', '#af52de', '#ff3b30', '#ffcc00'];
  for (let i = 0; i < 50; i++) {
    setTimeout(() => {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + 'vw';
      confetti.style.top = '-10px';
      confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
      confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 4000);
    }, i * 30);
  }

  // Remove overlay after animation
  setTimeout(() => overlay.remove(), 2500);

  showToast(`${post.ticker} closed for profit! üéâ`, 'success');
}

// Send winner notification
async function sendWinnerNotification(post) {
  // Discord notification
  const webhookUrl = localStorage.getItem('discordWebhook');
  if (webhookUrl) {
    try {
      await fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          embeds: [{
            title: `üéâ WINNER! ${post.ticker} Closed for Profit!`,
            description: `${post.type.toUpperCase()} $${post.strike} ${post.type === 'csp' ? 'Put' : 'Call'} expired worthless or closed for profit!`,
            color: 0x34c759,
            fields: [
              { name: 'Premium Collected', value: post.prem, inline: true },
              { name: 'Expiration', value: post.exp, inline: true }
            ],
            timestamp: new Date().toISOString()
          }]
        })
      });
    } catch (e) { console.error('Discord error:', e); }
  }

  // Email notification
  await sendEmailNotifications({ ...post, kind: 'winner' });
}

function getTimeAgo(ts) {
  const mins = Math.floor((Date.now() - ts) / 60000);
  if (mins < 1) return 'Just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  return days + 'd ago';
}

initAdminAccess();
const logo=s=>'https://financialmodelingprep.com/image-stock/'+s.toUpperCase()+'.png';
function load(){try{const d=localStorage.getItem('meV6');if(d)Object.assign(S,JSON.parse(d))}catch(e){}}
function save(){try{localStorage.setItem('meV6',JSON.stringify(S))}catch(e){}}
function checkLegal(){if(!S.legalOk)openModal('legalModal')}
function acceptLegal(){S.legalOk=true;save();closeModal('legalModal')}
function toggleTheme(){S.theme=S.theme==='light'?'dark':'light';applyTheme();save()}
function applyTheme(){document.documentElement.setAttribute('data-theme',S.theme);['themeSwitch','qThemeSwitch'].forEach(id=>$(id)?.classList.toggle('on',S.theme==='dark'))}
function nav(t){document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));$(`${t}Tab`)?.classList.add('active');document.querySelector(`.nav-btn[data-tab="${t}"]`)?.classList.add('active');if(t==='home')renderHome();if(t==='watch')renderWatch();if(t==='alerts')renderAlerts();if(t==='signals')renderSignals();if(t==='profile')renderProfile()}
function goCalc(m){nav('calc');setMode(m)}
function openModal(id){$(id)?.classList.add('show')}
function closeModal(id){$(id)?.classList.remove('show')}
function openSettings(){$('qApiKey').value=S.apiKey;$('qSecretKey').value=S.secretKey;loadEmailSettings();applyTheme();openModal('settingsModal')}
function quickSaveApi(){S.apiKey=$('qApiKey').value.trim();S.secretKey=$('qSecretKey').value.trim();save();updateStatus();closeModal('settingsModal');if(S.apiKey)showToast('API keys saved!','success')}
function confirmSignOut() {
  showConfirm('Sign Out', 'Are you sure you want to sign out?', signOut);
}

function showConfirm(title, message, onConfirm) {
  $('confirmTitle').textContent = title;
  $('confirmMessage').textContent = message;
  $('confirmAction').onclick = () => { closeModal('confirmModal'); onConfirm(); };
  openModal('confirmModal');
}

async function signOut(){
  try { if (firebase?.auth) await firebase.auth().signOut(); } catch(e) {}
  // Clear auth state but keep user data for when they log back in
  S.firebaseUid = null;
  S.isGuest = false;
  S.alertsPopupDismissed = false;
  localStorage.removeItem('meRemember');
  save();
  showAuthScreen();
  showToast('Signed out', '');
}
function openAdd(){setAddMode('csp');openModal('addModal')}
function openLearn(){$('learnContent').innerHTML=['basics','csp','cc','delta'].map(id=>{const t={basics:['Wheel Basics','Learn fundamentals','Beginner','blue'],csp:['Cash Secured Puts','Master selling puts','Intermediate','green'],cc:['Covered Calls','Income from shares','Intermediate','purple'],delta:['Delta Selection','Choose right strikes','Advanced','orange']}[id];return`<div onclick="showLesson('${id}')" style="background:var(--input);border-radius:16px;padding:16px;margin-bottom:12px;cursor:pointer"><div style="display:flex;align-items:center;gap:12px;margin-bottom:8px"><div style="width:40px;height:40px;border-radius:10px;background:var(--${t[3]}-bg);display:flex;align-items:center;justify-content:center"><span style="font-size:18px">${{basics:'üìö',csp:'üìâ',cc:'üìà',delta:'üéØ'}[id]}</span></div><span style="font-weight:600">${t[0]}</span></div><p style="font-size:13px;color:var(--text2)">${t[1]}</p><span style="display:inline-block;padding:4px 8px;background:var(--card);border-radius:6px;font-size:11px;color:var(--text2);margin-top:8px">${t[2]}</span></div>`}).join('');openModal('learnModal')}
function showLesson(id){const c={basics:'<h3>The Wheel Strategy</h3><p>1. Sell Cash-Secured Puts on stocks you want</p><p>2. If assigned, sell Covered Calls</p><p>3. If called away, restart</p><p><b>Key:</b> 0.20-0.30 delta, 30-45 DTE</p>',csp:'<h3>Cash Secured Puts</h3><p>Get paid to buy stocks at lower prices.</p><p><b>Delta guide:</b></p><ul><li>0.30 = 70% win rate</li><li>0.20 = 80% win rate</li></ul>',cc:'<h3>Covered Calls</h3><p>Generate income from shares.</p><ul><li>Sell above cost basis</li><li>Avoid earnings</li></ul>',delta:'<h3>Delta Selection</h3><p>Delta = probability of ITM</p><p><b>Sweet spot:</b> 0.20-0.30 delta with 30-45 DTE</p>'}[id];$('learnContent').innerHTML=`<div style="font-size:14px;line-height:1.7;color:var(--text2)">${c}</div><button class="btn btn-outline mt-4" onclick="openLearn()">‚Üê Back</button>`}
function openAnalytics(){const prem=S.positions.reduce((s,p)=>s+(p.premium||0)*(p.contracts||1)*100,0)+S.history.reduce((s,t)=>s+(t.premium||0)*(t.contracts||1)*100,0);const wins=S.history.filter(t=>(t.pnl||0)>=0).length;const total=S.history.length;$('aPrem').textContent=prem.toFixed(0);$('aWin').textContent=total>0?Math.round(wins/total*100)+'%':'0%';$('aTrades').textContent=total;openModal('analyticsModal')}
function openAI(){if(!$('aiMessages').innerHTML)$('aiMessages').innerHTML='<div class="ai-msg bot">Hey! I\'m <b>Wheely</b> ü§ñ Ask me about delta, DTE, rolling, or position sizing!</div>';openModal('aiModal')}
function sendAI(){const i=$('aiInput'),m=i.value.trim();if(!m)return;$('aiMessages').innerHTML+=`<div class="ai-msg user">${m}</div>`;i.value='';setTimeout(()=>{const l=m.toLowerCase();let r='The wheel: sell CSPs until assigned, then sell CCs. Target 0.20-0.30 delta, 30-45 DTE.';if(l.includes('delta'))r='<b>Delta:</b> Target 0.20-0.30 for CSPs. 70-80% win rate.';else if(l.includes('dte')||l.includes('expir'))r='<b>DTE:</b> 30-45 days optimal for theta decay.';else if(l.includes('roll'))r='<b>Rolling:</b> Always roll for a credit!';$('aiMessages').innerHTML+=`<div class="ai-msg bot">${r}</div>`;$('aiMessages').scrollTop=$('aiMessages').scrollHeight},500)}
function openPremium(){openModal('premiumModal')}
function toggleNotif(){S.notifOn=!S.notifOn;['notifSwitch','qNotifSwitch'].forEach(id=>$(id)?.classList.toggle('on',S.notifOn));save()}
function updateStatus(){
  const hasBroker=S.apiKey.length>10&&S.secretKey.length>10;
  // Always show live for market data (no API key needed)
  $('statusPill').className='status live';
  $('statusText').textContent=hasBroker?'Live + Broker':'Live Data';
}
function renderHome(){
  // Ensure critical DOM elements exist
  const balanceEl = $('balanceVal');
  const posContainer = $('positionsContainer');
  const histContainer = $('historyContainer');

  if (!balanceEl || !posContainer || !histContainer) {
    // DOM not ready, schedule retry
    setTimeout(renderHome, 100);
    return;
  }

  // Render balance
  balanceEl.textContent = S.accSize.toLocaleString();
  const prem = (S.positions || []).reduce((s,p) => s + (p.premium||0) * (p.contracts||1) * 100, 0);
  const pct = S.accSize > 0 ? (prem / S.accSize * 100).toFixed(1) : 0;
  const changeEl = $('balanceChange');
  if (changeEl) changeEl.textContent = '‚Üë +$' + prem.toFixed(0) + ' (' + pct + '%)';

  // Render user initials
  const init = S.user && S.user.name ? S.user.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0,2) : '?';
  const initEl = $('heroInitials');
  if (initEl) initEl.textContent = init;

  // Show guest banner if guest
  const guestBanner = $('guestBanner');
  if (guestBanner) {
    guestBanner.style.display = S.isGuest ? 'block' : 'none';
  }

  renderAlertsFeed();

  // Force render positions and history with explicit content
  renderPositions(posContainer);
  renderHistory(histContainer);
}

function renderAlertsFeed() {
  const section = $('alertsFeedSection');
  const container = $('alertsFeedContainer');
  if (!section || !container) return;

  // Only show for premium users
  if (!S.isPremium) {
    section.style.display = 'none';
    return;
  }

  const posts = S.adminPosts || [];
  if (!posts.length) {
    section.style.display = 'none';
    return;
  }

  section.style.display = 'block';
  const recent = posts.slice(0, 3);

  container.innerHTML = recent.map(p => {
    if (p.kind === 'signal') {
      return `<div class="pos-card" style="border-left:3px solid var(--${p.type==='csp'?'green':'blue'});padding:14px" onclick="nav('signals')">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><span class="pos-badge ${p.type}" style="margin-right:8px">${p.type.toUpperCase()}</span><b>${p.ticker}</b> $${p.strike}</div>
          <span style="font-size:11px;color:var(--text3)">${getTimeAgo(p.timestamp)}</span>
        </div>
        <div style="font-size:13px;color:var(--text2);margin-top:6px">Premium: <span style="color:var(--green)">${p.prem}</span> ¬∑ Delta: ${p.delta}</div>
      </div>`;
    } else if (p.kind === 'announcement') {
      return `<div class="pos-card" style="border-left:3px solid var(--orange);background:var(--orange-bg);padding:14px" onclick="nav('signals')">
        <div style="font-weight:600">${p.title}</div>
        <div style="font-size:13px;color:var(--text2);margin-top:4px">${p.message.slice(0, 80)}${p.message.length > 80 ? '...' : ''}</div>
        <span style="font-size:11px;color:var(--text3)">${getTimeAgo(p.timestamp)}</span>
      </div>`;
    } else if (p.kind === 'roll') {
      return `<div class="pos-card" style="border-left:3px solid var(--purple);padding:14px" onclick="nav('signals')">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span class="pos-badge" style="background:var(--purple-bg);color:var(--purple)">ROLL</span>
          <span style="font-size:11px;color:var(--text3)">${getTimeAgo(p.timestamp)}</span>
        </div>
        <div style="font-size:13px;margin-top:6px">${p.original} ‚Üí ${p.newPos}</div>
        <div style="font-size:14px;font-weight:600;color:var(--green);margin-top:4px">${p.credit}</div>
      </div>`;
    }
    return '';
  }).join('');
}
function renderPositions(container){
  const c = container || $('positionsContainer');
  if(!c) return; // Guard against null

  const positions = S.positions || [];
  if(!positions.length){
    c.innerHTML='<div class="empty"><div class="empty-icon"><svg viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div><div class="empty-title">No Positions</div><div class="empty-text">Add positions or sync from Alpaca</div><button class="empty-btn" onclick="openAdd()">+ Add Position</button></div>';
    return;
  }
  c.innerHTML=positions.map(p=>{const dte=p.expiration?Math.ceil((new Date(p.expiration)-new Date())/864e5):null;const pnl=(p.premium||0)*(p.contracts||1)*100*.4;const clr=getTickerColor(p.symbol);return`<div class="pos-card" onclick="viewPos('${p.id}')"><div class="pos-top"><div class="pos-left"><div class="pos-logo"><img src="${logo(p.symbol)}" onerror="this.outerHTML='<span class=pos-logo-text style=background:${clr}>${p.symbol.slice(0,2)}</span>'"></div><div><div class="pos-symbol">${p.symbol}${p.strike?' $'+p.strike+(p.type==='csp'?'P':'C'):''}</div><div class="pos-name">${names[p.symbol]||p.symbol}</div></div></div><span class="pos-badge ${p.type}">${p.type.toUpperCase()}</span></div><div class="pos-stats"><div><div class="pos-stat-val ${pnl>=0?'pos':'neg'}">${pnl>=0?'+':''}$${Math.abs(pnl).toFixed(0)}</div><div class="pos-stat-label">P&L</div></div><div><div class="pos-stat-val">$${((p.premium||0)*(p.contracts||1)*100).toFixed(0)}</div><div class="pos-stat-label">Premium</div></div><div style="text-align:right"><div class="pos-stat-val">${dte!==null?dte:'‚Äî'}</div><div class="pos-stat-label">${dte!==null?'DTE':'Hold'}</div></div></div></div>`}).join('');
}
function renderHistory(container){
  const c = container || $('historyContainer');
  if(!c) return; // Guard against null

  const history = S.history || [];
  if(!history.length){
    c.innerHTML='<div style="text-align:center;padding:32px;color:var(--text2);font-size:14px;background:var(--card);border:1px solid var(--border);border-radius:16px">Closed trades appear here</div>';
    return;
  }
  c.innerHTML='<div class="tx-list">'+history.slice(0,5).map(t=>`<div class="tx-item"><div class="tx-icon ${t.type}"><svg viewBox="0 0 24 24">${t.type==='csp'?'<circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12l4 4 4-4"/>':'<circle cx="12" cy="12" r="10"/><path d="M12 16V8M8 12l4-4 4 4"/>'}</svg></div><div class="tx-info"><div class="tx-title">${t.symbol} $${t.strike||''}${t.type==='csp'?'P':'C'}</div><div class="tx-sub">${new Date(t.closeDate||Date.now()).toLocaleDateString()}</div></div><div class="tx-amount ${(t.pnl||0)>=0?'pos':'neg'}">${(t.pnl||0)>=0?'+':'-'}$${Math.abs(t.pnl||0).toFixed(0)}</div></div>`).join('')+'</div>';
}
function viewPos(id){const p=S.positions.find(x=>x.id===id);if(!p)return;S.selPosId=id;$('posTitle').textContent=p.symbol;$('posContent').innerHTML=`<div class="stats-grid"><div class="stat-box"><div class="stat-val">${p.type.toUpperCase()}</div><div class="stat-label">Type</div></div><div class="stat-box"><div class="stat-val">${p.contracts||1}</div><div class="stat-label">Contracts</div></div>${p.strike?`<div class="stat-box"><div class="stat-val">$${p.strike}</div><div class="stat-label">Strike</div></div>`:''}<div class="stat-box"><div class="stat-val green">$${((p.premium||0)*(p.contracts||1)*100).toFixed(0)}</div><div class="stat-label">Premium</div></div></div>`;openModal('posModal')}
function closePosition(){if(!S.selPosId)return;const p=S.positions.find(x=>x.id===S.selPosId);if(p){S.history.unshift({...p,closeDate:new Date().toISOString(),pnl:(p.premium||0)*(p.contracts||1)*100*.6});S.positions=S.positions.filter(x=>x.id!==S.selPosId);save();closeModal('posModal');renderHome()}}
async function syncPositions(){if(!S.apiKey)return showToast('Add API keys in settings first','error');try{$('statusPill').className='status live';$('statusText').textContent='Syncing...';const r=await fetch('https://paper-api.alpaca.markets/v2/positions',{headers:{'APCA-API-KEY-ID':S.apiKey,'APCA-API-SECRET-KEY':S.secretKey}});if(!r.ok)throw new Error('Failed');const pos=await r.json();pos.forEach(p=>{if(!S.positions.find(x=>x.symbol===p.symbol)){S.positions.push({id:Date.now().toString()+Math.random(),symbol:p.symbol,type:'shares',contracts:parseInt(p.qty),costBasis:parseFloat(p.avg_entry_price),synced:true,openDate:new Date().toISOString()})}});const ar=await fetch('https://paper-api.alpaca.markets/v2/account',{headers:{'APCA-API-KEY-ID':S.apiKey,'APCA-API-SECRET-KEY':S.secretKey}});if(ar.ok){const a=await ar.json();S.accSize=parseFloat(a.equity)||S.accSize}save();$('statusPill').className='status live';$('statusText').textContent='Live';renderHome()}catch(e){$('statusPill').className='status';$('statusText').textContent='Error';showToast('Sync failed','error')}}
function setAddMode(m){S.addMode=m;$('addCspBtn').classList.toggle('active',m==='csp');$('addCcBtn').classList.toggle('active',m==='cc');$('addSharesBtn').classList.toggle('active',m==='shares');if(m==='shares'){hide('optFields');show('shareFields')}else{show('optFields');hide('shareFields')}}
function savePosition(){const sym=$('addSymbol').value.trim().toUpperCase();if(!sym)return showToast('Enter symbol','error');const p={id:Date.now().toString(),symbol:sym,type:S.addMode,contracts:parseInt($('addContracts').value)||1,openDate:new Date().toISOString()};if(S.addMode==='shares')p.costBasis=parseFloat($('addCost').value)||0;else{p.strike=parseFloat($('addStrike').value)||0;p.expiration=$('addExp').value;p.premium=parseFloat($('addPremium').value)||0;if(!p.strike||!p.expiration)return showToast('Fill strike & expiration','error')}S.positions.push(p);save();closeModal('addModal');renderHome()}
function setMode(m){S.mode=m;$('cspBtn').classList.toggle('active',m==='csp');$('ccBtn').classList.toggle('active',m==='cc');
  // Reload options if we have a current ticker
  if(currentTicker && currentChain) loadOptionsChain(currentTicker);
}

function addFromCalc() {
  if (!currentTicker || !selectedOption) return showToast('Select an option first','error');

  const expDate = selectedExp ? new Date(selectedExp * 1000) : new Date(Date.now() + selectedOption.dte * 86400000);

  const p = {
    id: Date.now().toString(),
    symbol: currentTicker,
    type: S.mode,
    strike: selectedOption.strike,
    premium: selectedOption.premium,
    contracts: selectedOption.contracts,
    expiration: expDate.toISOString().split('T')[0],
    openDate: new Date().toISOString()
  };

  S.positions.push(p);
  save();
  nav('home');
  showToast(`Added ${currentTicker} $${selectedOption.strike}${S.mode==='csp'?'P':'C'} to portfolio!`,'success');
}

function qSearch(s){$('tickerInput').value=s;searchTicker()}
// Current ticker state for options chain
let currentTicker = null;
let currentChain = null;
let selectedExp = null;
let selectedOption = null;

async function searchTicker(){
  const t=$('tickerInput').value.trim().toUpperCase();
  if(!t)return;

  hide('emptyCalc');
  hide('stockCard');
  hide('optCard');
  hide('resultCard');
  show('loadingCard');

  try {
    // Fetch live quote (no API key needed!)
    const quote = await fetchLiveQuote(t);
    if (!quote) throw new Error('Symbol not found');

    currentTicker = t;
    $('stockSymbol').textContent = t;
    $('stockName').textContent = names[t] || t;
    $('stockPrice').textContent = quote.price.toFixed(2);

    // Add price change display
    const priceEl = $('stockPrice').parentElement;
    let changeEl = priceEl.querySelector('.price-change');
    if (!changeEl) {
      changeEl = document.createElement('div');
      changeEl.className = 'price-change';
      changeEl.style.cssText = 'font-size:14px;margin-top:4px;font-weight:600';
      priceEl.appendChild(changeEl);
    }
    changeEl.style.color = quote.change >= 0 ? 'var(--green)' : 'var(--red)';
    changeEl.textContent = `${quote.change >= 0 ? '+' : ''}${quote.change.toFixed(2)} (${quote.changePercent}%)`;

    hide('loadingCard');
    show('stockCard');

    // Fetch options chain
    await loadOptionsChain(t);

    $('statusPill').className='status live';
    $('statusText').textContent='Live Data';

  } catch(e) {
    hide('loadingCard');
    show('emptyCalc');
    showToast('Could not find: ' + t,'error');
  }
}

async function loadOptionsChain(symbol) {
  show('loadingCard');
  hide('resultCard');

  // Reset optCard to original structure
  $('optCard').innerHTML = `<div class="card-title">Select Contract</div>
    <div class="form-group"><label class="form-label">Expiration</label>
    <select class="form-select" id="expSelect" onchange="onExpChange()"><option>Loading...</option></select></div>
    <div class="form-group"><label class="form-label">Strike ¬∑ Premium ¬∑ Delta ¬∑ OTM%</label>
    <select class="form-select" id="strikeSelect" onchange="onStrikeChange()"><option>Select expiration first...</option></select></div>`;

  try {
    const chain = await fetchOptionsChain(symbol);
    if (!chain || !chain.expirations?.length) {
      hide('loadingCard');
      // Show manual entry if no options available
      showManualEntry();
      return;
    }

    currentChain = chain;

    // Populate expiration dropdown
    const expSelect = $('expSelect');
    expSelect.innerHTML = '<option value="">Select expiration...</option>' +
      chain.expirations.slice(0, 12).map(exp => {
        const dte = calcDTE(exp);
        const label = formatExpDate(exp);
        const dteLabel = dte === 1 ? '1 day' : `${dte} days`;
        return `<option value="${exp}">${label} (${dteLabel})</option>`;
      }).join('');

    hide('loadingCard');
    show('optCard');

    // Reset strike select
    $('strikeSelect').innerHTML = '<option value="">Select strike...</option>';

  } catch(e) {
    hide('loadingCard');
    showManualEntry();
  }
}

function showManualEntry() {
  // Show manual premium entry for tickers without options data
  $('optCard').innerHTML = `
    <div class="card-title">Enter Contract Details</div>
    <div class="form-group">
      <label class="form-label">Strike Price</label>
      <input type="number" class="form-input" id="manualStrike" placeholder="150.00" step="0.5">
    </div>
    <div class="form-group">
      <label class="form-label">Premium (per share)</label>
      <input type="number" class="form-input" id="manualPremium" placeholder="2.50" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Days to Expiration</label>
      <input type="number" class="form-input" id="manualDTE" placeholder="30" value="30">
    </div>
    <button class="btn btn-outline" onclick="calcManualOption()">Calculate</button>
  `;
  show('optCard');
}

function calcManualOption() {
  const strike = parseFloat($('manualStrike')?.value) || 0;
  const premium = parseFloat($('manualPremium')?.value) || 0;
  const dte = parseInt($('manualDTE')?.value) || 30;

  if (!strike || !premium) return showToast('Enter strike and premium','error');

  const contracts = Math.floor(S.accSize / (strike * 100)) || 1;
  const totalPrem = premium * contracts * 100;
  const annualized = ((premium / strike) * (365 / dte) * 100).toFixed(1);

  selectedOption = { strike, premium, dte, contracts };

  $('resPrem').textContent = totalPrem.toFixed(0);
  $('resAnn').textContent = annualized;
  $('resProb').textContent = '~75';
  $('resCon').textContent = contracts;
  show('resultCard');
}

async function onExpChange() {
  const expSelect = $('expSelect');
  const exp = parseInt(expSelect.value);
  if (!exp || !currentChain) return;

  selectedExp = exp;

  // Fetch options for this expiration
  show('loadingCard');
  const chain = await fetchOptionsChain(currentTicker, exp);
  hide('loadingCard');

  if (!chain) return;
  currentChain = chain;

  // Get relevant options based on mode
  const options = S.mode === 'csp' ? chain.puts : chain.calls;
  const price = chain.price || parseFloat($('stockPrice').textContent);

  // Find ATM and nearby strikes
  const strikes = options
    .filter(o => {
      const otm = S.mode === 'csp' ? o.strike < price : o.strike > price;
      return otm && o.bid > 0;
    })
    .sort((a, b) => S.mode === 'csp' ? b.strike - a.strike : a.strike - b.strike)
    .slice(0, 10);

  const strikeSelect = $('strikeSelect');
  strikeSelect.innerHTML = '<option value="">Select strike...</option>' +
    strikes.map(o => {
      const delta = o.delta ? Math.abs(o.delta).toFixed(2) : '‚Äî';
      const prem = ((o.bid + o.ask) / 2).toFixed(2);
      const otmPct = ((Math.abs(price - o.strike) / price) * 100).toFixed(1);
      return `<option value="${o.strike}" data-premium="${prem}" data-delta="${delta}" data-dte="${calcDTE(selectedExp)}">$${o.strike} ¬∑ $${prem} ¬∑ Œî${delta} ¬∑ ${otmPct}% OTM</option>`;
    }).join('');
}

function onStrikeChange() {
  const strikeSelect = $('strikeSelect');
  const opt = strikeSelect.options[strikeSelect.selectedIndex];
  if (!opt || !opt.value) return;

  const strike = parseFloat(opt.value);
  const premium = parseFloat(opt.dataset.premium) || 0;
  const delta = parseFloat(opt.dataset.delta) || 0.25;
  const dte = parseInt(opt.dataset.dte) || 30;

  // Calculate results
  const contracts = Math.floor(S.accSize / (strike * 100)) || 1;
  const totalPrem = premium * contracts * 100;
  const annualized = ((premium / strike) * (365 / dte) * 100).toFixed(1);
  const probProfit = delta ? Math.round((1 - Math.abs(delta)) * 100) : 75;

  selectedOption = { strike, premium, dte, contracts, delta };

  $('resPrem').textContent = totalPrem.toFixed(0);
  $('resAnn').textContent = annualized;
  $('resProb').textContent = probProfit;
  $('resCon').textContent = contracts;
  show('resultCard');
}
async function renderWatch(){
  const c=$('watchContainer');
  const watchlist = S.watchlist || ['AAPL','NVDA','TSLA','SPY','AMD','MSFT'];

  // Show loading state
  c.innerHTML='<div class="tx-list">'+watchlist.map(sym=>{const clr=getTickerColor(sym);return`<div class="tx-item" id="watch-${sym}"><div class="pos-logo"><img src="${logo(sym)}" onerror="this.outerHTML='<span class=pos-logo-text style=background:${clr}>${sym.slice(0,2)}</span>'"></div><div class="tx-info"><div class="tx-title">${sym}</div><div class="tx-sub">${names[sym]||sym}</div></div><div style="text-align:right"><div style="font-size:15px;font-weight:700;color:var(--text3)">Loading...</div><div style="font-size:12px;color:var(--text3)">‚Äî</div></div></div>`}).join('')+'</div><button class="btn btn-outline mt-4" onclick="openAddWatch()">+ Add to Watchlist</button>';

  // Fetch live prices in parallel
  const quotes = await Promise.all(watchlist.map(sym => fetchLiveQuote(sym)));

  // Update each item with live data
  quotes.forEach((q, i) => {
    const sym = watchlist[i];
    const el = $(`watch-${sym}`);
    if (!el) return;
    const chg = q ? (parseFloat(q.changePercent) || 0) : 0;
    const chgColor = chg >= 0 ? 'var(--green)' : 'var(--red)';
    const chgSign = chg >= 0 ? '+' : '';
    const clr = getTickerColor(sym);
    if (q) {
      el.innerHTML = `<div class="pos-logo" style="cursor:pointer" onclick="qSearch('${sym}');nav('calc')"><img src="${logo(sym)}" onerror="this.outerHTML='<span class=pos-logo-text style=background:${clr}>${sym.slice(0,2)}</span>'"></div><div class="tx-info" style="cursor:pointer" onclick="qSearch('${sym}');nav('calc')"><div class="tx-title">${sym} <span class="live-dot" style="width:6px;height:6px"></span></div><div class="tx-sub">${names[sym]||sym}</div></div><div style="text-align:right;cursor:pointer" onclick="qSearch('${sym}');nav('calc')"><div style="font-size:15px;font-weight:700">$${q.price.toFixed(2)}</div><div style="font-size:12px;color:${chgColor}">${chgSign}${chg.toFixed(2)}%</div></div><button style="background:none;border:none;padding:8px;cursor:pointer;color:var(--text3)" onclick="event.stopPropagation();removeFromWatch('${sym}')">√ó</button>`;
    } else {
      el.innerHTML = `<div class="pos-logo"><img src="${logo(sym)}" onerror="this.outerHTML='<span class=pos-logo-text style=background:${clr}>${sym.slice(0,2)}</span>'"></div><div class="tx-info"><div class="tx-title">${sym}</div><div class="tx-sub">${names[sym]||sym}</div></div><div style="text-align:right"><div style="font-size:13px;color:var(--text3)">Unavailable</div></div><button style="background:none;border:none;padding:8px;cursor:pointer;color:var(--text3)" onclick="removeFromWatch('${sym}')">√ó</button>`;
    }
  });

  // Update status to show live data is working
  $('statusPill').className='status live';
  $('statusText').textContent='Live Data';
}

function removeFromWatch(sym) {
  S.watchlist = (S.watchlist || []).filter(s => s !== sym);
  save();
  renderWatch();
}

function openAddWatch() {
  showPrompt('Add to Watchlist', 'AAPL', (sym) => {
    const ticker = sym.toUpperCase().trim();
    if (!S.watchlist) S.watchlist = ['AAPL','NVDA','TSLA','SPY'];
    if (!S.watchlist.includes(ticker)) {
      S.watchlist.push(ticker);
      save();
      renderWatch();
      showToast(`${ticker} added to watchlist`, 'success');
    } else {
      showToast(`${ticker} already in watchlist`, '');
    }
  });
}

async function refreshWatch(){
  // Clear cache for fresh data
  Object.keys(priceCache).forEach(k => delete priceCache[k]);
  renderWatch();
}
function renderAlerts(){const c=$('alertsContainer');const alerts=[];S.positions.forEach(p=>{if(!p.expiration)return;const dte=Math.ceil((new Date(p.expiration)-new Date())/864e5);if(dte<=7)alerts.push({...p,dte,urgent:dte<=3})});if(!alerts.length){c.innerHTML='<div class="empty"><div class="empty-icon"><svg viewBox="0 0 24 24"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/></svg></div><div class="empty-title">No Alerts</div><div class="empty-text">Alerts appear when positions expire soon</div></div>';return}c.innerHTML=alerts.map(a=>`<div class="pos-card" style="border-left:3px solid ${a.urgent?'var(--red)':'var(--orange)'}"><div style="font-weight:600">${a.symbol} $${a.strike}${a.type==='csp'?'P':'C'}</div><div style="font-size:13px;color:var(--text2);margin-top:4px">${a.dte} days remaining</div></div>`).join('')}
function renderSignals(){
  const c=$('signalsContainer');
  const posts = S.adminPosts || [];
  const disclaimer = $('exampleDisclaimer');

  // NON-PREMIUM: Show only examples
  if (!S.isPremium) {
    if (disclaimer) disclaimer.style.display = 'block';

    let html = '<div class="card-title" style="margin:16px 0 12px">Example Signals</div>';
    signals.forEach((s, i) => {
      const locked = i > 0;
      html += `<div class="signal-card ${locked?'locked':''}" style="border-left:3px solid var(--${s.type==='csp'?'green':'blue'})"><div class="signal-header"><span class="signal-type ${s.type}">${s.type.toUpperCase()}</span><span class="signal-time">${s.time}</span></div><div class="signal-ticker">${s.ticker}</div><div class="signal-details">$${s.strike} ${s.type==='csp'?'Put':'Call'} ¬∑ Exp ${s.exp}</div><div style="display:flex;gap:16px;font-size:13px"><span>Premium: <b style="color:var(--green)">${s.prem}</b></span><span>Delta: <b>${s.delta}</b></span></div>${locked?`<div class="signal-lock"><svg viewBox="0 0 24 24" fill="none" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg><span>Unlock with Premium</span></div>`:''}</div>`;
    });
    html += '<button class="btn mt-4" onclick="openPremium()">Unlock Live Signals</button>';
    c.innerHTML = html;
    return;
  }

  // PREMIUM: Show real signals
  if (disclaimer) disclaimer.style.display = 'none';

  // Separate by type
  const sigs = posts.filter(p => p.kind === 'signal');
  const anns = posts.filter(p => p.kind === 'announcement');
  const rolls = posts.filter(p => p.kind === 'roll');

  // Separate open vs closed positions
  const openSigs = sigs.filter(p => !p.status || p.status === 'open');
  const closedSigs = sigs.filter(p => p.status && p.status !== 'open');

  let html = '';

  // Announcements at top
  anns.slice(0, 3).forEach(a => {
    html += `<div class="signal-card" style="border-left:3px solid var(--orange);background:var(--orange-bg)"><div style="font-weight:600;margin-bottom:4px">${a.title}</div><div style="font-size:13px;color:var(--text2)">${a.message}</div><div style="font-size:11px;color:var(--text3);margin-top:8px">${getTimeAgo(a.timestamp)}</div></div>`;
  });

  // Roll updates
  rolls.slice(0, 5).forEach(r => {
    html += `<div class="signal-card" style="border-left:3px solid var(--purple)"><div class="signal-header"><span class="signal-type" style="background:var(--purple-bg);color:var(--purple)">ROLL</span><span class="signal-time">${getTimeAgo(r.timestamp)}</span></div><div style="font-size:13px;margin:8px 0"><span style="color:var(--red)">${r.original}</span> ‚Üí <span style="color:var(--green)">${r.newPos}</span></div><div style="font-size:14px;font-weight:600;color:var(--green)">${r.credit}</div>${r.notes?`<div style="font-size:12px;color:var(--text2);margin-top:4px">${r.notes}</div>`:''}</div>`;
  });

  // OPEN POSITIONS section
  if (openSigs.length > 0) {
    html += `<div class="card-title" style="margin:16px 0 12px;display:flex;align-items:center;gap:8px"><span style="display:inline-block;width:8px;height:8px;background:var(--green);border-radius:50%;animation:pulse 2s infinite"></span>Open Positions (${openSigs.length})</div>`;
    openSigs.forEach((s) => {
      const time = s.timestamp ? getTimeAgo(s.timestamp) : s.time;
      html += `<div class="signal-card" style="border-left:3px solid var(--${s.type==='csp'?'green':'blue'})"><div class="signal-header"><span class="signal-type ${s.type}">${s.type.toUpperCase()}</span><span class="signal-time">${time}</span></div><div class="signal-ticker">${s.ticker}</div><div class="signal-details">$${s.strike} ${s.type==='csp'?'Put':'Call'} ¬∑ Exp ${s.exp}</div><div style="display:flex;gap:16px;font-size:13px"><span>Premium: <b style="color:var(--green)">${s.prem}</b></span><span>Delta: <b>${s.delta}</b></span></div></div>`;
    });
  } else {
    html += `<div class="empty" style="padding:24px"><div class="empty-title">No Open Positions</div><div class="empty-text">New signals will appear here when posted</div></div>`;
  }

  // CLOSED POSITIONS section
  if (closedSigs.length > 0) {
    html += `<div class="card-title" style="margin:24px 0 12px">üìä Position History (${closedSigs.length})</div>`;
    closedSigs.slice(0, 15).forEach((s) => {
      let statusBadge = '';
      if (s.status === 'winner') statusBadge = '<span class="status-badge winner">WIN üéâ</span>';
      else if (s.status === 'rolled') statusBadge = '<span class="status-badge rolled">ROLLED</span>';
      else if (s.status === 'assigned') statusBadge = '<span class="status-badge assigned">ASSIGNED üì¶</span>';
      else if (s.status === 'called') statusBadge = '<span class="status-badge called">CALLED üì§</span>';
      else statusBadge = '<span class="status-badge closed">CLOSED</span>';

      const borderColor = s.status === 'winner' ? 'var(--green)' : s.status === 'assigned' ? 'var(--orange)' : s.status === 'called' ? 'var(--blue)' : 'var(--text3)';
      html += `<div class="signal-card" style="border-left:3px solid ${borderColor}${['winner','assigned','called'].includes(s.status)?'':';opacity:0.8'}"><div class="signal-header"><span class="signal-type ${s.type}">${s.type.toUpperCase()}</span>${statusBadge}<span class="signal-time" style="margin-left:auto">${getTimeAgo(s.closedAt || s.timestamp)}</span></div><div class="signal-ticker">${s.ticker}</div><div class="signal-details">$${s.strike} ${s.type==='csp'?'Put':'Call'} ¬∑ Exp ${s.exp}</div><div style="display:flex;gap:16px;font-size:13px"><span>Premium: <b style="color:var(--green)">${s.prem}</b></span></div></div>`;
    });
  }

  c.innerHTML = html || '<div class="empty"><div class="empty-title">No Signals Yet</div><div class="empty-text">Live trading signals will appear here</div></div>';
}
function renderProfile(){
  $('userName').value=S.user.name||'';
  $('userEmail').value=S.user.email||'';
  $('userPhone').value=S.user.phone||'';
  $('profileName').textContent=S.user.name||'Set up your profile';
  $('profileEmail').textContent=S.user.email||'Tap to edit';
  const init=S.user.name?S.user.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2):'?';
  $('profileInitials').textContent=init;

  // Show avatar image if exists
  const avatarImg = $('profileAvatarImg');
  const initials = $('profileInitials');
  if (S.user.avatar && avatarImg) {
    avatarImg.src = S.user.avatar;
    avatarImg.style.display = 'block';
    if (initials) initials.style.display = 'none';
  } else if (avatarImg) {
    avatarImg.style.display = 'none';
    if (initials) initials.style.display = 'block';
  }
  $('apiKeyInput').value=S.apiKey;
  $('secretKeyInput').value=S.secretKey;
  $('accSizeInput').value=S.accSize;
  const ok=S.apiKey.length>10;
  $('brokerStatus').innerHTML=ok?'<div style="padding:12px;background:var(--green-bg);border-radius:12px;margin-bottom:16px;font-weight:600;color:var(--green)"><span class="live-dot"></span>Connected</div>':'<div style="padding:12px;background:var(--orange-bg);border-radius:12px;margin-bottom:16px;font-size:13px;color:var(--orange)">Not connected</div>';
  const wins=S.history.filter(t=>(t.pnl||0)>=0).length;
  const total=S.history.length;
  const prem=S.positions.reduce((s,p)=>s+(p.premium||0)*(p.contracts||1)*100,0)+S.history.reduce((s,t)=>s+(t.premium||0)*(t.contracts||1)*100,0);
  $('pTrades').textContent=total;
  $('pWinRate').textContent=total?Math.round(wins/total*100)+'%':'0%';
  $('pPremium').textContent='$'+prem.toFixed(0);
  // Show alert prefs for premium users
  if(S.isPremium){show('proBadge');hide('proCard');$('alertPrefsCard').style.display='block';}
  else{$('alertPrefsCard').style.display='none';}
}
function saveProfile(){S.user.name=$('userName').value.trim();S.user.email=$('userEmail').value.trim();S.user.phone=$('userPhone')?.value.trim()||'';save();renderProfile();showToast('Saved!','success')}

function handleAvatarUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  // Check file size (max 500KB to avoid localStorage issues)
  if (file.size > 500000) {
    showToast('Image too large. Max 500KB', 'error');
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      // Resize image to max 200x200 to save space
      const canvas = document.createElement('canvas');
      const max = 200;
      let w = img.width, h = img.height;
      if (w > h) { if (w > max) { h = h * max / w; w = max; } }
      else { if (h > max) { w = w * max / h; h = max; } }
      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);

      const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
      S.user.avatar = dataUrl;
      save();
      renderProfile();
      showToast('Photo updated!', 'success');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function connectBroker(){S.apiKey=$('apiKeyInput').value.trim();S.secretKey=$('secretKeyInput').value.trim();S.accSize=parseInt($('accSizeInput').value)||25000;save();updateStatus();renderProfile();if(S.apiKey)showToast('Connected!','success')}
load();applyTheme();

// Initialize app when DOM is ready
function initApp() {
  // Check auth state on load
  if (!checkAuthState()) {
    // Not logged in, show auth screen and hide bottom nav
    showAuthScreen();
  } else {
    checkLegal();
  }
  updateStatus();
  initAdminAccess();
  listenToFirebasePosts();
  listenForWinners();

  // Use requestAnimationFrame to ensure DOM is fully painted before rendering
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      renderHome();
    });
  });
}

// Run init when DOM is fully ready
function safeInit() {
  // Double-check DOM is ready with multiple elements
  const homeTab = $('homeTab');
  const posContainer = $('positionsContainer');
  const histContainer = $('historyContainer');

  if (!homeTab || !posContainer || !histContainer) {
    // DOM not ready, wait and retry
    setTimeout(safeInit, 50);
    return;
  }

  initApp();
}

// Run init when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', safeInit);
} else if (document.readyState === 'interactive') {
  // DOM is parsed but resources may still be loading
  setTimeout(safeInit, 10);
} else {
  // DOM is fully loaded
  safeInit();
}

// Re-render when tab becomes visible again (fixes blank content issue)
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && (S.firebaseUid || S.isGuest)) {
    // Use RAF to ensure smooth re-render after tab switch
    requestAnimationFrame(() => {
      renderHome();
    });
  }
});

// Failsafe: Re-render after all resources are fully loaded
window.addEventListener('load', () => {
  // Give a small delay to ensure everything is settled
  setTimeout(() => {
    if (S.firebaseUid || S.isGuest) {
      renderHome();
    }
  }, 100);
});
</script>
</body>
</html>
